## 阿里云 PostgreSQL 产品生态；案例、开发管理实践、原理、学习资料、视频；PG天天象上沙龙记录 - 珍藏级      
                                      
### 作者                                      
digoal                                      
                                      
### 日期                                      
2018-01-21                                     
                                      
### 标签                                      
PostgreSQL , 阿里云 , 产品介绍 , 生态 , 案例 , 开发实践 , 管理实践             
                                      
----                                      
                                      
## 背景           
包含两部分内容：      
      
### 1、PG天天象上沙龙回顾，视频。      
      
天天象上活动，每个月一场，全国巡回。旨在建立各地企业生态圈子，建立各地企业与PG数据库社区的联系，切实的帮助企业解决技术、商业、生态层面的问题。       
      
贸易摩擦、中兴事件、以及近期某银行收到Oracle6亿罚单等等的热点事件，引发了企业对核心技术安全合规、自主可控的深度思考。对于数据库来说，安全合规、自主可控，成本等也已经成为绝大多数企业迫在眉睫要解决的问题。      
      
什么数据库最适合替代Oracle，同时在技术架构上领先于传统数据库，并且可以支持企业的蓬勃发展？除了需要考虑Oracle兼容性、企业特性（可靠、可用、安全、可扩展、性能、稳定、功能）还需要考虑产品的开源许可，多模特性，混合场景能力等等。      
      
PostgreSQL作为最先进的企业级开源数据库(BSD like开源许可，自用和分发都不需要担心法律风险，不需要担心PG被收购，不用担心PG被一家独大的公司控制。)，覆盖OLTP,OLAP,NoSQL,搜索,时空,流,图,图像等应用场景。应用场景丰富，并且在稳定性、性能、可用性、可靠性、容灾、安全性、扩展性等方面不亚于商用数据库Oracle，被业界称为“开源界的Oracle”。在企业数据库自主可控、安全合规、成本几个方面，PG毫无疑问的成为了企业的最佳选择。      
      
为帮助企业掌握去O能力。阿里云数据库团队、PG社区、云栖社区、云栖技术日、阿里云技术创新中心共同推出《PG天天象上》活动，涵盖《PostgreSQL 应用案例、原理、最佳实践》、《PPAS + ADAM Oracle 迁移上云》、《企业数据库安全、自主可控》、《各行业的TOP软件开发商分享》、《数据库服务提供商、集成商的分享》、《企业圆桌深入研讨》等系列主题。      
      
2018年9月开始，《PG天天象上》活动陆续在杭州，北京，郑州、广州、深圳、上海、南京、合肥多地开展，活动在线上与线下覆盖人数已达数万人次，出席活动的参会者汇聚了银行，证券，互联网，人工智能，高校，医疗，新制造，电商，游戏，政府，电力等行业的开发者，DBA，架构师，CTO，CIO。      
      
欢迎就近选择参加。      
      
### 2、PG全栈数据库(阿里云 PostgreSQL 产品生态；案例、开发管理实践、原理、学习资料、视频)。      
          
[《PostgreSQL 2~3 天培训提纲》](../201901/20190105_01.md)           
            
![pic](20180121_01_pic_001.jpg)            
            
![pic](20180121_01_pic_002.jpg)           
            
![pic](20180121_01_pic_003.jpg)            
            
![pic](20180121_01_pic_004.jpg)            
        
![pic](20180121_01_pic_010.jpg)            
        
# 一、PG天天象上      
      
## 1 PG天天象上活动介绍      
1、PostgreSQL 社区工作汇报。        
      
2、阿里云ADAM+PPAS的去O实践        
      
3、PostgreSQL 数据库架构、原理(物理架构、进程结构、逻辑架构、流复制架构、HA架构、多副本架构；权限体系、存储引擎原理、索引结构等)。         
            
4、PostgreSQL 理论基础，管理、开发实践，优化方法，PG学习参考资料      
      
5、PostgreSQL在OLTP|OLAP、空间数据管理、图式搜索、全文检索、文本搜索、特征搜索、时序应用、流式数据处理、用户画像分析等场景的应用案例。        
        
案例横跨 物联网、电商、生物科技、游戏、传统企业、CRM、ERP、ZF、GA、物流、音视频、BI、社交、金融、证券、手机、天文等行业。        
        
6、PostgreSQL 大型行业TOP企业用户分享      
      
7、PostgreSQL 行业软件开发商、服务提供商、中间件厂商用户分享      
      
8、企业深入圆桌研讨会议      
         
涉及内容较多，案例涉及到详细的架构设计、代码、原理等内容，请参阅本视频提供的PDF内的URL链接。         
              
## 2 PG 天天象上 往期讲师介绍          
### digoal @ 阿里云          
中国开源软件推进联盟PostgreSQL分会，特聘资深领域专家。             
        
PostgreSQL 中国社区发起人之一、常委、兼任社区大学校长。         
        
[中国信息通信研究院主办、中国通信标准化协会支持的"OSCAR云计算开源产业大会"评选：2018届OSCAR开源尖峰人物之一](../201803/20180322_12.md)        
        
阿里云数据库首席专家团队[成员](../me/aliyun_shouxi_db_service.png)，提供[数据库首席专家服务](https://www.aliyun.com/service/chiefexpert/database)。        
          
30项数据库专利。（截至2018-01）            
         
致力于PostgreSQL数据库在中国的技术落地与推广、人才培养。        
      
[About digoal](../me/readme.md)       
      
### 唐修 @ 阿里云      
      
### 赵振平 @ PG社区主席    
      
### 唐成 @ PG社区副主席    
      
### 周飞 @ HELLOBIKE    
      
### 赵志强 @ 天数智芯    
    
### 陈河堆 @ 中兴    
      
### 陈华军 @ 苏宁    
      
### 董红禹 @ 乘数科技    
    
### 张勤建 @ 云贝    
    
### 梅白帆 @ 北京国网富达    
  
### 杨栋 @ 神州飞象    
       
## 3 PG天天象上活动往期回顾        
      
### 1 20180121期天天象上(杭州-娃哈哈赞助)        
报名人数：80       
      
重要议题：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。      
      
![pic](20180121_01_pic_006.jpg)            
        
### 2 20180901期天天象上(杭州-skymobi赞助)           
报名人数：80       
      
重要议题：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。      
        
参会企业：阿里巴巴、海康威视、亚信、乘数科技、天宇、浙江大学、斯凯网络、大树金科、点我达、中国电信、民生银行、网易、火树医疗、同花顺、等。         
      
![pic](20180121_01_pic_008.jpg)            
        
### 3 20180909期天天象上(北京-纳什空间赞助)         
报名人数：80       
        
重要议题：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。      
        
参会企业：阿里巴巴、北京联通、邮储银行、华胜天成、优炫软件、炫果壳、四维图新、海康威视、金风科技、中国人寿、国交信通、EnjoyIT、京东、海量数据、智联招聘、神州飞象、万达、南天软件、超图、去哪儿、汽车之家、英泰伟业、华为、九天气象、东方龙马、CETC、云能服、Ylink、等。      
      
![pic](20180121_01_pic_009.jpg)            
        
### 4 20181013期天天象上(郑州-大象圈社区赞助)          
报名人数：36       
       
重要议题：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。      
        
参会企业：阿里巴巴、上海新炬、中原银行、郑州大学、华三、博茂、北京国源、中盟股份、富士康、中移在线、北京许继、华中科技大学、众合景轩、税友、亚信、北京辰安、河南优蓓教育、新天科技股份、郑州商旅、等。         
      
![pic](20180121_01_pic_011.jpg)            
         
![pic](20180121_01_pic_012.jpg)            
        
### 5 20181027期天天象上(广州-阿里巴巴创新中心赞助)          
报名人数：69       
      
重要议题1：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。      
      
重要议题2：阿里ADAM+PPAS 去O方法论，Oracle迁移上云实践。      
      
重要议题3：企业深入圆桌研讨会议。      
        
参会企业：阿里巴巴、广州云图、网易、玄武、鼎信、广州彩讯科技股份、诺基亚、广东粤铁天福、广州人瑞、万科、广东三维家、北京中亦、等。         
      
![pic](20180121_01_pic_013.jpg)            
        
### 6 20181028期天天象上(深圳-清华大学深圳研究生院赞助)            
报名人数：103       
      
重要议题1：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。      
      
重要议题2：阿里ADAM+PPAS 去O方法论，实践。      
      
重要议题3：企业深入圆桌研讨会议。      
        
参会企业：阿里巴巴、人民银行、穆迪信息咨询、华润电力、Morningstar、白骑士、海量、库博商务、金智、亚信、万科、华海乐盈、平安科技、中兴、招商金融、富璟、深圳证券交易所、中国移动、华润银行、人寿保险、大疆、顺丰科技、华为、金蝶、TCL、IBM、恒大等。         
      
![pic](20180121_01_pic_014.jpg)            
        
### 7 20181124期天天象上(上海-阿里巴巴创新中心赞助)           
报名人数：88       
      
重要议题1：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。      
      
重要议题2：阿里ADAM+PPAS 去O方法论，Oracle迁移上云实践。      
      
重要议题3：HELLOBIKE，周飞，PG在HELLOBIKE的应用实践。      
      
重要议题4：上海云贝网络科技有限公司，张勤建，PG在电商平台运营决策系统中的应用实践。      
      
重要议题5：乘数科技，董红禹，医疗行业从MSSQL到PG的迁移实践。      
      
重要议题6：企业深入圆桌研讨会议。      
        
参会企业：阿里巴巴、迪卡侬、HELLOBIKE、上海云贝、乘数科技、同花顺、宝胜科技、爱用宝、人保、东方航空、聚水潭、爱树、华东师范、上交所、嘉银金融、银嘉金服、MBB、松鼠AI、易鲸捷、润和、新炬、航信、真旅、小红书、兴业银行、汇信、美味、FP等。         
        
线上线下2200余人次参加。        
      
直播回顾地址-上午：https://yq.aliyun.com/live/613      
      
直播回顾地址-下午：https://yunqivedio.alicdn.com/od/rZB8C1543470615706.mp4      
        
![pic](20180121_01_pic_015.jpg)            
        
### 8 20181222期天天象上(南京-阿里巴巴创新中心赞助)           
报名人数：330       
      
重要议题1：PostgreSQL 社区生态建设、工作汇报      
      
重要议题2：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。      
      
重要议题3：阿里ADAM+PPAS 去O方法论，Oracle迁移上云实践。      
      
重要议题4：天数智芯，赵志强，工业时序数据平台的设计与应用实践。      
      
重要议题5：PG中国社区主席，赵振平，双活数据中心实践分享和探讨。      
      
重要议题6：苏宁，陈华军，PG citus 分库分表架构在苏宁的大规模应用。      
      
重要议题7：中兴，陈河堆，PostgreSQL基于PaaS平台的高可用集群方案。      
      
重要议题8：北京国网富达科技，梅白帆，PostGIS在地理信息行业中的应用。      
      
重要议题9：企业深入圆桌研讨会议。      
        
参会企业：阿里巴巴、中兴、苏宁、亚信、华米科技、三只松鼠、中软、veritas、科大讯飞、新蛋、中石化、南京大学、中科大、南京邮电、南京信息学院、南京理工、南京师范、南京财经、南京工业大学、南京航空航天大学、汉得、神州数码、江苏电信、国家电网、南瑞、IBM、中国电科研究院、百度、云和恩墨、远景、天数智芯、中车、恒舜金融、润和、苏宁银行、等。         
      
线上线下700余人次参加。        
      
直播回顾地址1：https://yq.aliyun.com/live/776      
      
直播回顾地址2：https://yq.aliyun.com/live/777      
      
直播回顾地址3：https://yq.aliyun.com/live/778      
      
![pic](20180121_01_pic_016.jpg)            
        
### 9 20190112期天天象上(合肥-阿里巴巴创新中心赞助)      
报名人数：147       
      
重要议题1：PostgreSQL 社区生态建设、工作汇报      
      
重要议题2：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。      
      
重要议题3：阿里ADAM+PPAS 去O方法论，Oracle迁移上云实践。      
      
重要议题4：杭州乘数科技，唐成 《为什么PostgreSQL是最适合去O的数据库》      
      
重要议题5：广州云图，黄晓涛《数据库迁移案例分享》      
      
重要议题6：PG中国社区主席，赵振平 《数据泄露事件与PostgreSQL安全防护》      
      
重要议题7：企业深入圆桌研讨会议。      
      
参会企业：阿里巴巴、邮储银行、农业银行、科大讯飞、惠而浦、思科、国科量子通信、汉和智能物流、云易智能、鸿数科技、CXMT、中国科技大学、省交通运输厅、美林数据、海量、碧桂园、瀚高基础软件、阳光电源、上海大智慧、长鑫存储、上海博辕、神州数码、南瑞、财汇资讯、华米科技、华胜天成、新炬、广博量子、等。       
      
线上线下1000余人次参加。        
      
企业深入圆桌研讨会议小结：      
      
1、企业交流中关注到的几个方向：      
      
1\.1、数据库免维护（软件开发商关心这个问题，可以低成本大批量部署，维护成本低）、      
      
1\.2、业界标准的HA方案（企业通用问题，PG可选的HA方案太多，什么好？个人建议用patroni，成熟可靠），      
      
1\.3、RAC架构产品（大型企业，核心业务，同城rpo=0，同时减少rto、 PG核心场景部署建议：两地三中心，同IDC两节点，同城异机房1节点，异地1节点，quorum based replication，patroni作为HA软件，切换时间可以控制在30秒以内，全球RPO=0），        
      
1\.4、大数据量（30TB 级）场景是否可用PG，可以，PG本身就是HTAP企业级数据库（能同时满足oltp, olap），只要硬件满足即可能存，能跑得很好。（未来在xid，zheap两个方向改进后会更进一步）         
      
[《PostgreSQL 11 1万亿 tpcb 性能测试 on 阿里云ECS + ESSD + zfs/lvm2条带 + block_size=32K》](../201809/20180919_01.md)        
      
[《PostgreSQL 11 tpcc 测试(103万tpmC on ECS) - use sysbench-tpcc by Percona-Lab》](../201809/20180913_01.md)        
      
[《(TPC-H测试 SF=10,SF=200) PostgreSQL 11 vs 10 vs Deepgreen》](../201808/20180823_01.md)        
      
1\.5、已有很多中小企业拿PG用于分析业务，      
      
1\.6、企业越来越关注开源需求的差异，在选择传染性的开源许可软件时会更加慎重，但对于社区来说依旧需要多暴露这里问题。      
      
2、成立合肥PG分会，选拔来自邮储、长鑫存储（三星量级芯片生产商）的6位志愿者。由到京带领。      
        
直播回顾地址1：https://yq.aliyun.com/live/804      
      
直播回顾地址2：https://yunqivedio.alicdn.com/od/CEdEG1547357007712.mp4      
      
![pic](20180121_01_pic_017.jpg)        
  
### 10 20190323期天天象上(长沙-阿里巴巴创新中心赞助)      
报名人数：1xx       
      
重要议题1：PostgreSQL 社区生态建设、工作汇报      
      
重要议题2：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。      
      
重要议题3：阿里云ADAM+PPAS 去O方法论，Oracle迁移上云实践。      
      
重要议题4：神州飞象，杨栋 《PostgreSQL HA方案patroni》      
      
重要议题5：PG中国社区主席，太阳塔科技，赵振平 《Oracle与PostgreSQL对比学习》      
          
重要议题6：企业辩论赛。      
      
参会企业：阿里巴巴、三一重工、飞象科技、太阳塔、天闻数媒、隆平高科、创友数码、郑州大学、华中科技大学、高阳、上海屹恒、科创医疗、京柏医疗、果壳信息、。。。等。       
      
企业辩论赛回顾：      
      
现场将参会者分为两组，进行了激烈的辩论赛，两位来自郑州大学、华中科技大学的小伙伴担任队长，给对方提若干个PG相关的题目，对方作答。双方展开了激烈的辩论。     
      
1、PostgreSQL 的count如何加速？  
  
方法1：通过pg_stat_all_tables.n_live_tup可以直接得到当前表的记录数。适合高速全表count()    
  
```  
postgres=# show track_counts ;  
 track_counts   
--------------  
 on  
(1 row)  
  
select n_live_tup from pg_stat_all_tables where relname='a';  
```  
  
方法2：通过流计算，实时COUNT。例如pipelinedb插件，适合任意count，支持条件过滤、分组等预计算。    
  
[《PostgreSQL pipelinedb 流计算插件 - IoT应用 - 实时轨迹聚合》](../201811/20181101_02.md)    
  
方法3：通过并行计算，适合任意count，条件过滤、分组。并行后提速非常明显。    
  
[《PostgreSQL 并行计算解说 汇总》](../201903/20190319_01.md)    
  
讨论中也提到了MySQL，MySQL并没有并行计算，但是myisam引擎支持较快COUNT全表，不过要注意的是：myisam不支持并行计算，不支持流计算，不支持带FILTER、带GROUP、带DISTINCT的快速count。不支持hashagg, hashjoin等。已经基本上被MYSQL废弃，现在推荐使用innodb引擎。 (注意不能因为count快就选择对应的存储引擎，要全盘考虑，包括并发能力，事务能力等。)       
  
```  
摘自互联网：

1. myisam保存表的总行数, 因此count(*)并且无where子句,很快会返回表的总行数  
2. myisam保存表的总行数, 利用count(column)并且无where子句,并且此column不为null,很快会返回表的总行数  
3. myisam保存表的总行数, 利用count(column)并且无where子句,并且此column可以为null,mysql会对表进行全表或全索引扫描来确定行数  
4. innodb查询count(*),count(column(not null)),count(column(may be null))并且无where子句,mysql会对表进行全表或全索引扫描来确定行数  
5. myisam和innodb查询count(*),count(column(not null)),count(column(may be null))并且存在where子句,mysql会对表进行索引扫描(如果列上有索引)  
```  
  
2、大数据，实时计算。适合用什么产品解决？  
  
citus, gpdb都可以.  
  
3、undo , 多版本的优劣势。  
  
undo 问题：回滚慢，并发较多版本略差，老版本多时访问老版本链条较长，UNDO文件膨胀。  
  
MVCC 问题：数据文件可能会膨胀(当表的更新非常多时)，索引膨胀（通过HOT技术解决）。   
  
[《为PostgreSQL讨说法 - 浅析《UBER ENGINEERING SWITCHED FROM POSTGRES TO MYSQL》》](../201607/20160728_01.md)  
  
[《PostgreSQL Heap Only Tuple - HOT (降低UPDATE引入的索引写IO放大)》](../201809/20180925_02.md)  
  
[《PostgreSQL 10.0 preview 性能增强 - 间接索引(secondary index)、二级索引》](../201703/20170312_21.md)  
  
[《PostgreSQL 收缩膨胀表或索引 - pg_squeeze or pg_repack》](../201610/20161030_02.md)  
  
[《PostgreSQL snapshot too old补丁, 防止数据库膨胀》](../201511/20151109_01.md)  
  
[《PostgreSQL 垃圾回收原理以及如何预防膨胀 - How to prevent object bloat in PostgreSQL》](../201504/20150429_02.md)  
  
4、PG集群、分片、容灾技术  
  
HA，(patroni)  
  
分片，citus   
  
容灾，流复制   
  
读写分离，pgpool-II   
  
多副本，quorum based replication  
  
5、现场演示了杀掉oracle进程，ORACLE会崩溃。杀掉PG 非守护进程，PG数据库会自动启动。如果杀死PG守护进程，如何让PG自动恢复？    
  
```  
首先杀掉PG 非守护进程，PG数据库会自动启动。实际上是守护进程的自动恢复功能。  
postgres=# show restart_after_crash ;  
-[ RECORD 1 ]-------+---  
restart_after_crash | on  
```  
  
可以使用守护进程的守护进程，例如 CRON。解决守护进程被杀后不会自动恢复的问题。  
  
6、OOM的问题。当发生OOM时，如何防止由于资源紧张使用时，数据库恢复后，由于资源紧张，进程被不断反复OOM。   
  
cgroup, docker隔离。  
  
HUGE PAGE，解决hash table问题.  
  
oom adj ，设置为不被OOM ： PG进程。  
  
如何防止不发生OOM（或尽量避免OOM）：  
  
连接池，减少连接数  
  
分区表，减少分区数，访问分区表时，可以减少syscache  
  
内核，使用更多的共享对象（例如syscache, relcache）  
      
7、主从断开时间太长后，从库可能因为主库的WAL被擦写后，从库要的WAL已不存在，再连接主库时已经没有需要的WAL。需要重搭从库。如何解决：  
  
设置wal_keep_segments参数，  
  
使用replication slot  
  
使用归档，都可以。     
  
![pic](20180121_01_pic_018.jpg)        
  
![pic](20180121_01_pic_019.jpg)        
  
### 11 20190419期天天象上(成都-阿里巴巴创新中心赞助)  
报名人数：41  
  
重要议题1：PostgreSQL 社区生态建设、工作汇报  
  
重要议题2：阿里云POLARDB Oracle兼容版介绍  
  
重要议题3：阿里云PG产品线生态介绍，PG案例，PG的原理、应用场景、优化、管理等内容等。  
  
重要议题4：阿里云ADAM+PPAS 去O方法论，Oracle迁移上云实践。  
  
重要议题5：企业辩论赛。  
  
参会企业：阿里巴巴、平安科技、成都达测（EDB中国总代）、新华传媒、测绘院、达州广播电视大学、成都派沃特科技股份有限公司、人大金仓、四川融科智联科技、、。。。等。  
  
企业辩论赛回顾：  
  
1、用户的某个业务系统，开放了公网以及0.0.0.0的链路权限，在运行一段时间后，发现数据库的几个进程CPU 100%，如何排查这种问题？    
    
找到造成CPU 100%的进程号，以及对应的父进程，发现父进程为数据库postmaster进程，所以断定是PG发起的进程。    
    
排查pg_stat_activity没有发现对应会话，开启连接审计，排查pg_log的日志，找到了诡异的连接记录，同时发现数据库被创建了几个非业务用户，同时通过大对象植入了C代码到PG实例中，创建了一些异常函数（死循环，一直耗费CPU）。    
    
显然数据库可能被黑。    
    
[《Hacking PostgreSQL》](../201610/20161018_02.md)      
    
升级PG版本解决，同时建议pg_hba.conf（数据库ACL配置）不要开放0.0.0.0即使需要开放0.0.0.0也不要开放所有用户，建议限定普通用户通过远程连接。    
    
2、用户使用MYSQL时，发现跑group by，即使数据量只有百万级别，也要跑很久很久。而换到PG后，即使数据表有千万甚至亿级别，也可以秒出结果。为什么？    
    
PG支持更好的聚合方法，HASHAGG, GROUPAGG，同时支持更好的并行计算能力，使得PG在处理大量数据的时候，比MYSQL占优很多，与ORACLE并肩。    
    
3、PG的SQL执行过程？    
    
解析用户协议包    
    
parser sql    
    
判断是否为DML，DSL的请求，如果是则    
    
rewrite query    
    
generate path    
    
generate plan    
    
jit (可选)    
    
execute plan    
    
如果是绑定变量的请求：    
    
bind parameter    
    
execute prepared statement    
    
4、如何查看SQL的执行计划。    
    
对于历史SQL，使用auto_explain插件，记录超过指定执行时间的SQL的执行计划，通过查看LOG日志可以看到历史SQL的执行计划。    
    
使用explain，可以查看当前SQL的执行计划。    
    
5、如何在plpgsql存储过程或函数中创建函数。    
    
使用execute 'SQL string'动态调用的方法，可以在函数中创建函数。例如    
    
```    
postgres=# create or replace function f_test() returns void as $$    
declare    
begin    
  execute format($_$create or replace function f_test1() returns void as $__$ declare begin raise notice 'test'; end; $__$ language plpgsql strict;$_$);    
end;    
$$ language plpgsql strict;    
CREATE FUNCTION    
postgres=# \df f_test1    
                       List of functions    
 Schema | Name | Result data type | Argument data types | Type     
--------+------+------------------+---------------------+------    
(0 rows)    
    
postgres=# select f_test();    
 f_test     
--------    
     
(1 row)    
    
postgres=# \df f_test1    
                        List of functions    
 Schema |  Name   | Result data type | Argument data types | Type     
--------+---------+------------------+---------------------+------    
 public | f_test1 | void             |                     | func    
(1 row)    
    
postgres=# \sf+ f_test1    
        CREATE OR REPLACE FUNCTION public.f_test1()    
         RETURNS void    
         LANGUAGE plpgsql    
         STRICT    
1       AS $function$ declare begin raise notice 'test'; end; $function$    
postgres=# select f_test1();    
NOTICE:  test    
 f_test1     
---------    
     
(1 row)    
```    
    
6、如何修改数据库ACL    
    
通过数据库pg_hba.conf配置文件，配置数据库访问链路ACL。    
    
7、postgresql.auto.conf与postgresql.conf的区别？    
    
postgresql.auto.conf是数据库alter system动态修改数据库参数的配置文件，alter system配置的参数会写入postgresql.auto.conf，优先级高于postgresql.conf    
    
扩展问题    
    
为什么postgresql.auto.conf优先级高于?    
    
因为先加载postgresql.conf后加载postgresql.auto.conf，后加载的覆盖了先加载的参数。    
    
如何配置了多个重名的参数，哪个为准？    
    
后加载的覆盖先加载的参数。    
    
参数配置的地方，以及优先级：    
    
[《PostgreSQL 参数优先级讲解》](../201901/20190130_03.md)      
    
8、PostgreSQL如何防止绑定变量的执行计划倾斜。    
    
数据库前5次执行计划都是custom plan，即每一次都要generate path，generate plan，并记录下custom plan的平均成本，以及customplan发生的次数。第五次后会生成generic plan，当有新的bind时，先使用generic plan计算新的bind 的cost，如果cost比custom plan的平均成本相差较大（代码内写死相差的比例），则会发起新的custom plan，并且统计到custom plan的平均COST和计数中。    
    
如果成本相差不大，则继续使用generic plan.    
    
通过以上方法防止倾斜。    
    
[《PostgreSQL 11 preview - 增加强制custom plan GUC开关(plancache_mode)，对付倾斜》](../201803/20180325_06.md)      
    
[《PostgreSQL plan cache 源码浅析 - 如何确保不会计划倾斜》](../201606/20160617_01.md)      
  
![pic](20180121_01_pic_020.jpg)  
    
      
### PG天天象上活动影响力(截至201903)    
线下、云栖线上直播、官方微信、官方微博、个人微信、微博转发、PG社区官方网站等渠道。      
      
企业圆桌深入研讨，相比传统IT峰会，对企业来说可以摄取更多信息量。       
       
长远影响预计：1万+人次      
            
# 二、PG全栈数据库在线视频      
[《PostgreSQL 2~3 天培训提纲》](../201901/20190105_01.md)           
      
## 1 章节介绍          
### 1、阿里云PostgreSQL产品线生态介绍，时长：90分钟          
          
PostgreSQL, GPDB 技术发展与云生态。          
          
### 2、阿里云PostgreSQL案例分享，时长：180分钟          
          
PostgreSQL与GPDB在OLTP|OLAP、空间数据管理、图式搜索、全文检索、文本搜索、特征搜索、时序应用、流式数据处理、用户画像分析等场景的应用案例。          
          
案例横跨 物联网、电商、生物科技、游戏、传统企业、CRM、ERP、ZF、GA、物流、音视频、BI、社交、金融、证券、手机、天文等行业。          
          
“新零售、共享单车、生物科技、网站、企业CRM、新零售、医疗、GA”等行业应用案例，业务痛点以及数据库“多值类型、UDF、全文检索、模糊搜索、相似搜索、多字段任意搜索、sharding、异步并行”等技术的应用。          
          
“电商、导购、新零售、搜索、数据分析、数据运营、金融、物流、物联网、LBS、导航、智能配送、稽侦、旅游、舆情、风控、医疗”等行业应用案例，业务痛点以及数据库“数组、文本特征、图片特征搜索，多值标签搜索、BITMAP搜索、时序数据搜索、时序数据实时统计、空间数据管理、电子围栏、KNN搜索、实时位置更新、路径规划、点云，文本情感词挖掘，Python UDF，图式搜索、递归查询”等技术的应用。          
          
“共享充电宝实时经营分析、电商秒杀、实时用户画像、实时业务监测与聚合、流式预警、多机房业务部署”等行业应用案例，业务痛点以及数据库“容灾、逻辑订阅、物理订阅、单元化、sharding，外部表，DBLINK，批量流计算、实时流计算、HLL估值计算，秒杀，ltree，RTREE”等技术的应用。          
          
### 3、阿里云HybridDB for PostgreSQL案例分享，时长：30分钟          
          
“音视频智能广告与数据挖掘、游戏数据运营、时空数据运营、物流、CDN、电商双十一”等行业应用案例，业务痛点以及数据库“流计算、机器学习、JSON与ETL、空间数据分区与METASCAN、数据聚集与海量导出、数据清洗、海量数据实时分析”等技术的应用。          
          
### 4、阿里云PostgreSQL开发与管理实践，时长：240分钟          
          
阿里云PostgreSQL，PPAS产品开发、管理实践，包含“SQL防火墙、资源隔离、AWR、VPD、物化视图、分页、数据清洗与转换、数据采样、加密、约束、去重、模糊查询、并行计算、批量DML、索引接口的选择与原理、ADhoc查询优化、函数稳定性原理、并发索引”等内容。          
          
阿里云PostgreSQL，PPAS产品开发、管理实践，包含“SQL HINT，TOP SQL，慢SQL诊断，执行计划，plpgsql函数诊断与DEBUG，判断有无，事务可靠性与性能设置，RDS PG资源管理，防雪崩，DDL操作建议，锁等待，限制慢SQL并发，杀会话和SQL，防DDoS和暴力破解”等内容。          
          
阿里云PostgreSQL，PPAS产品开发、管理实践，包含“数据同步，数据订阅，跨库访问，外部表，分区表，定时任务，执行计划，CBO成本因子，优化器，JOIN优化，遗传算法，递归查询，图式搜索，空间查询优化，空间索引，空间数据库使用建议”等内容。          
          
阿里云PostgreSQL，PPAS产品开发、管理实践，包含“数据老化实践、多级存储、冷热分离、数据库逻辑架构、数据库权限体系、服务端编程、行级、列级权限、数据膨胀的原理、监测、预防、处理，FREEZE原理、FREEZE风暴、预防FREEZE风暴，分区建议，可定义SLA的备份与恢复设计，跨版本升级，数据库监控指标与监控手段，多实例管理，海量测试数据的构造，压测数据库，从其他产品迁移到PostgreSQL”等内容。          
          
### 5、阿里云HybridDB for PostgreSQL开发与管理实践，时长：60分钟          
          
阿里云HybridDB for PostgreSQL产品开发、管理实践，包含“实时、批量ETL，数据写入性能优化，分布键、分区键的原理和选择，行存与列存的原理和选择，数据重分布原理与多阶段计算介绍”等内容。          
          
阿里云HybridDB for PostgreSQL产品开发、管理实践，包含“分级存储，索引接口的原理和选择，统计信息调度，队列管理，执行计划阅读，METASCAN，大吞吐数据导入导出，滑窗分析，数据倾斜的查看和预防，锁等待，数据膨胀和清理，行存列存格式转换，数据类型的选择建议，连接池”等内容。          
          
### 6、学习路径与资料分享，时长：30分钟          
          
参考文档、视频、软件等，包含“开发规约、产品选择文档、产品文档，图形化管理软件，开发驱动，社区文档，开发者指南，开发者手册，GIS文档，可视化分析软件，认证与培训资料，最佳实践，机器学习，日志维护与性能诊断，Oracle兼容性，培训视频集合”等内容。          
          
总时长：约12小时          
          
## 2 面向对象：          
开发者、DBA、架构师。          
          
## 3 收益          
通过学习本课程：          
          
架构师，可以了解到“物联网、电商、生物科技、游戏、传统企业、CRM、ERP、ZF、GA、物流、音视频、BI、社交、金融、证券、手机、天文”等行业在“OLTP|OLAP、空间数据管理、图式搜索、全文检索、文本搜索、特征搜索、时序应用、流式数据处理、用户画像分析”等场景对数据库的需求和业务痛点，了解如何使用阿里云PostgreSQL与HDB PG解决业务的需求和痛点。          
          
开发者和DBA，可以了解数据库的“多值类型、搜索、ADHOC查询、横向扩展、异步并行、特征搜索、画像搜索、时序数据实时处理、空间数据管理、电子围栏、KNN搜索、实时位置更新、路径规划、点云，文本情感词挖掘，Python UDF，图式搜索、递归查询，容灾、逻辑订阅、物理订阅、单元化，外部表，dblink，流计算、HLL估值计算，秒杀，ltree”等特性，以及“开发、管理”等最佳实践。          
            
## 4 PG全栈数据库在线培训视频      
https://edu.aliyun.com/course/836/lesson/list          
        
https://yq.aliyun.com/live/582       
        
         
## 5 视频下载地址        
敬请期待        
    
# 三、PG 天天象上沙龙模板    
## 活动介绍         
贸易摩擦、中兴事件、以及近期某银行收到Oracle 6亿罚单等等的热点事件，引发了企业对核心技术安全合规、自主可控的深度思考。对于数据库来说，安全合规、自主可控，成本等也已经成为绝大多数企业迫在眉睫要解决的问题。    
    
什么数据库最适合替代Oracle，同时在技术架构上领先于传统数据库，并且可以支持企业的蓬勃发展？除了需要考虑Oracle兼容性、企业特性（可靠、可用、安全、可扩展、性能、稳定、功能）还需要考虑产品的开源许可，多模特性，混合场景能力等等。    
    
PostgreSQL作为最先进的企业级开源数据库(BSD like开源许可，自用和分发都不需要担心法律风险，不需要担心PG被收购，不用担心PG被一家独大的公司控制。)，覆盖OLTP,OLAP,NoSQL,搜索,时空,流,图,图像等应用场景。应用场景丰富，并且在稳定性、性能、可用性、可靠性、容灾、安全性、扩展性等方面不亚于商用数据库Oracle，被业界称为“开源界的Oracle”。在企业数据库自主可控、安全合规、成本几个方面，PG毫无疑问的成为了企业的最佳选择。    
    
为帮助企业掌握去O能力。阿里云数据库团队、PG社区、云栖社区、云栖技术日、阿里云技术创新中心共同推出《PG天天象上》活动，涵盖《PostgreSQL 应用案例、原理、最佳实践》、《PPAS + ADAM Oracle 迁移上云》、《企业数据库安全、自主可控》、《各行业的TOP软件开发商分享》、《数据库服务提供商、集成商的分享》、《企业圆桌深入研讨》等系列主题。    
    
2018年9月开始，《PG天天象上》活动陆续在杭州，北京，郑州、广州、深圳、上海、南京多地开展，活动在线上与线下覆盖人数已达数万人次，出席活动的参会者汇聚了银行，证券，互联网，人工智能，高校，医疗，新制造，电商，游戏，政府，电力等行业的开发者，DBA，架构师，CTO，CIO。      
          
欢迎就近选择参加。        
       
## 背景      
![image](https://yqfile.alicdn.com/2321405749dfa403b768993424ad4a1162b4eb5d.png)      
    
![image](https://yqfile.alicdn.com/5f1ae5f94f155eba45f8588c27f9b690ebfd57ab.png)      
       
### 活动特色        
1、主题分享：PostgreSQL，ADAM去O方法论与成功案例，客户案例，PG的管理、维护、优化、开发实践等主题分享          
      
2、企业圆桌深度研讨：帮助企业深度梳理企业IT架构，就企业数据库安全合规、自主可控、成本、架构演进等问题进行深度研讨。              
        
## 适合人群          
学生、开发者、数据库管理员、架构师，CTO，CIO，技术总监。          
        
## 免费参会      
          
## 活动地点           
地点：待定       
           
## 主要议程          
**上午**        
1、09:00 ~ 09:15 扫码签到      
提醒参会者，分享现场活动，集赞，领奖。    
2、09:15 ~ 09:30 开场 - 创新中心报告       
3、09:30 ~ 10:05 阿里云 - digoal 《PostgreSQL 生态与社区工作汇报》 35 min       
4、10:05 ~ 10:55 阿里云 - 唐修 《PPAS + ADAM Oracle 迁移上云》  50 min       
5、10:55 ~ 11:40 《PG用户案例分享》 45 min       
6、11:40 ~ 11:50 合影         
      
**下午**          
1、13:30 ~ 15:00 阿里云 - digoal 《PostgreSQL 架构、应用案例、开发实践、优化》 90 min       
2、15:00 ~ 16:30 任选2个议题     
   《PG数据库服务提供商，数据库使用、管理、架构、优化、迁移类实践》 45 min      
   《垂直行业软件开发商，行业应用实践》 45 min      
   《PG用户案例分享》 45 min     
4、16:30 ~ 17:30  《企业研讨 - 针锋相对》 60 min      
   现场组队红蓝军，每队3~5人。    
   每队出5道与PG相关的问题，一共10道，题目不重复。    
   双方对垒，给出回答。    
   最后由观众投票，选出获胜队伍。    
5、17:30 ~ 17:45  问卷调查与颁奖      
      
**颁奖**          
1、朋友圈分享活动精彩片段(分享照片需包含PostgreSQL 技术进阶钉钉群二维码)，集赞多者获大奖。          
          
### PostgreSQL 技术进阶钉钉群：          
![pic](https://github.com/digoal/blog/raw/master/pic/dingding_pg_chat.png)          
          
## 演讲嘉宾          
### 嘉宾1          
阿里云，digoal。          
中国开源软件推进联盟PostgreSQL分会，特聘资深领域专家。          
PostgreSQL 中国社区大学校长，负责PostgreSQL人才培养与技术推广。          
阿里云数据库首席专家服务成员之一。          
[嘉宾技术BLOG](https://github.com/digoal/blog/blob/master/README.md)           
          
分享议题，《PostgreSQL 应用案例、原理、最佳实践》          
          
![image](https://yqfile.alicdn.com/6b656b72a40dc4013cee095597fdd305a97941ca.png)          
          
### 嘉宾2          
阿里云，唐修。          
阿里云ADAM产品经理。          
          
分享议题，《阿里云ADAM+PPAS Oracle迁移实践》          
          
![image](https://yqfile.alicdn.com/6c9dbefe45a8bdbb6e1892e540e81f5528e195ee.png)          
          
### 嘉宾3        
太阳塔，赵振平        
太阳塔创始人        
PostgreSQL中国社区主席(第三届)        
电子工业出版社签约作家        
数据库专家、大数据专家        
计算机畅销书作家        
贵州省省管专家        
国家首批大数据高级职称        
出版了技术专著《Oracle数据库精讲与疑难解析》        
出版了技术专著《成功之路：Oracle 11g学习笔记》        
出版了技术专著《IT架构实录》        
        
电话：18911070380        
        
分享议题，《PostgreSQL与Oracle对比学习》        
简述：        
        
![image](https://yqfile.alicdn.com/e38801e70a8ff424cb22203edd897515a7f7b2e2.png)        
      
## 注意事项          
请保持安静、卫生，文明参会，谢谢。          
          
## 合作伙伴          
##### 1 PostgreSQL中国用户会        
##### 2 中国开源软件推进联盟PostgreSQL分会        
##### 3 云栖社区      
##### 4 云栖TechDay    
### 欢迎合作伙伴加盟（媒体、软件开发商、ToB类企业等）      
有意请联系digoal     
      
![image](https://yqfile.alicdn.com/f8bb1689743f98c4057de347cd2603704fcd0284.png)    
      
       
## 鸣谢          
[francs(赠书《PostgreSQL 实战》)  ](https://item.jd.com/12405774.html)        
          
## 招聘传输门          
[PostgreSQL相关岗位招聘传输门](https://github.com/digoal/blog/blob/master/201804/20180425_01.md)          
          
          
## [往期回顾](https://github.com/digoal/blog/blob/master/201801/20180121_01.md)          
          
# 四、课件下载链接          
[《PostgreSQL 案例、开发、管理实践、架构、原理、诊断、调优 PDF》](20180121_01_pdf_001.pdf)            
        
[《PG 生态与社区工作汇报》](20180121_01_pdf_002.pdf)      
      
# 五、阿里云数据库DBA、内核研发、服务端研发岗位传输门       
      
[《Oracle DBA 增值 PostgreSQL,Greenplum 学习计划 - 珍藏级》](../201804/20180425_01.md)        
      
# 寻《PG天天象上》合作伙伴（媒体、软件开发商、ToB类企业）      
有意请联系digoal    
            
![pic](../pic/digoal_weixin.jpg)      
        
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"  ><img src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"  alt="Flag Counter"  border="0"  ></a>        
          
## [digoal's 大量PostgreSQL文章入口](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")      
        
        
## [免费领取阿里云RDS PostgreSQL实例、ECS虚拟机](https://free.aliyun.com/ "57258f76c37864c6e6d23383d05714ea")      
        
