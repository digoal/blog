## PostgreSQL 13 preview - analyze progress report  
                                                                                                                 
### 作者                                                                        
digoal                                                                                                                 
                                                                                                                 
### 日期                                                                                                                 
2020-01-01                                                                                                              
                                                                                                                 
### 标签                                                                                                                 
PostgreSQL , 报告 , progress , analyze , vacuum , create index , cluster , logical replication  
                                                                                                                 
----                                                                                                                 
                                                                                                                 
## 背景       
了解数据库某些任务的执行过程，阶段。  
  
目前支持：  
  
- cluster  
- create index  
- vacuum  
- 逻辑复制进度  
  
  
```  
db1=# \dv *.*prog*  
                      List of relations  
   Schema   |             Name              | Type |  Owner     
------------+-------------------------------+------+----------  
 pg_catalog | pg_stat_progress_cluster      | view | postgres  
 pg_catalog | pg_stat_progress_create_index | view | postgres  
 pg_catalog | pg_stat_progress_vacuum       | view | postgres  
(3 rows)  
```  
  
```  
db1=# \df+ *.*prog*  
List of functions  
-[ RECORD 1 ]-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
------------------------------------------------------------------------------------  
Schema              | pg_catalog  
Name                | pg_indexam_progress_phasename  
Result data type    | text  
Argument data types | oid, bigint  
Type                | func  
Volatility          | immutable  
Parallel            | safe  
Owner               | postgres  
Security            | invoker  
Access privileges   |   
Language            | internal  
Source code         | pg_indexam_progress_phasename  
Description         | return name of given index build phase  
-[ RECORD 2 ]-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
------------------------------------------------------------------------------------  
Schema              | pg_catalog  
Name                | pg_replication_origin_progress  
Result data type    | pg_lsn  
Argument data types | text, boolean  
Type                | func  
Volatility          | volatile  
Parallel            | unsafe  
Owner               | postgres  
Security            | invoker  
Access privileges   |   
Language            | internal  
Source code         | pg_replication_origin_progress  
Description         | get an individual replication origin's replication progress  
-[ RECORD 3 ]-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
------------------------------------------------------------------------------------  
Schema              | pg_catalog  
Name                | pg_replication_origin_session_progress  
Result data type    | pg_lsn  
Argument data types | boolean  
Type                | func  
Volatility          | volatile  
Parallel            | unsafe  
Owner               | postgres  
Security            | invoker  
Access privileges   |   
Language            | internal  
Source code         | pg_replication_origin_session_progress  
Description         | get the replication progress of the current session  
-[ RECORD 4 ]-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
------------------------------------------------------------------------------------  
Schema              | pg_catalog  
Name                | pg_stat_get_progress_info  
Result data type    | SETOF record  
Argument data types | cmdtype text, OUT pid integer, OUT datid oid, OUT relid oid, OUT param1 bigint, OUT param2 bigint, OUT param3 bigint, OUT param4 bigint, OUT param5 bigint, OUT param6 bigin  
t, OUT param7 bigint, OUT param8 bigint, OUT param9 bigint, OUT param10 bigint, OUT param11 bigint, OUT param12 bigint, OUT param13 bigint, OUT param14 bigint, OUT param15 bigint, OUT param16 bi  
gint, OUT param17 bigint, OUT param18 bigint, OUT param19 bigint, OUT param20 bigint  
Type                | func  
Volatility          | stable  
Parallel            | restricted  
Owner               | postgres  
Security            | invoker  
Access privileges   |   
Language            | internal  
Source code         | pg_stat_get_progress_info  
Description         | statistics: information about progress of backends running maintenance command  
```  
  
PG 13将增加对analyze的支持  
  
https://commitfest.postgresql.org/26/2164/  
  
https://www.postgresql.org/message-id/flat/20190621185207.GA27929@alvherre.pgsql  
  
  
```  
Attached patch is the revised patch. :)  
    
I wonder two things below. What do you think?  
    
1)  
For now, I'm not sure it should be set current_child_table_relid to zero  
when the current phase is changed from "acquiring inherited sample rows" to  
"computing stats". See <Test result> bellow.  
    
2)  
There are many "finalizing analyze" phases based on relids in the case  
of partitioning tables. Would it better to fix the document? or it  
would be better to reduce it to one?  
    
<Document>  
---------------------------------------------------------  
      <entry><literal>finalizing analyze</literal></entry>  
      <entry>  
        The command is updating pg_class. When this phase is completed,  
        <command>ANALYZE</command> will end.  
---------------------------------------------------------  
    
<New columns of the view>  
---------------------------------------------------------  
# \d pg_stat_progress_analyze  
               View "pg_catalog.pg_stat_progress_analyze"  
           Column           |  Type   | Collation | Nullable | Default  
---------------------------+---------+-----------+----------+---------  
  pid                       | integer |           |          |  
  datid                     | oid     |           |          |  
  datname                   | name    |           |          |  
  relid                     | oid     |           |          |  
  phase                     | text    |           |          |  
  sample_blks_total         | bigint  |           |          |  
  sample_blks_scanned       | bigint  |           |          |  
  ext_stats_total           | bigint  |           |          |  
  ext_stats_computed        | bigint  |           |          |  
  child_tables_total        | bigint  |           |          |  
  child_tables_done         | bigint  |           |          |  
  current_child_table_relid | oid     |           |          |  
---------------------------------------------------------  
    
<Test result using partitioning tables>  
---------------------------------------------------------  
# select * from pg_stat_progress_analyze ; \watch 0.0001  
    
19309|13583|postgres|36081|acquiring inherited sample rows|0|0|0|0|0|0|0  
19309|13583|postgres|36081|acquiring inherited sample rows|45|17|0|0|4|0|36084  
19309|13583|postgres|36081|acquiring inherited sample rows|45|35|0|0|4|0|36084  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|0|36084  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|0|36084  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|0|36084  
19309|13583|postgres|36081|acquiring inherited sample rows|45|3|0|0|4|1|36087  
19309|13583|postgres|36081|acquiring inherited sample rows|45|22|0|0|4|1|36087  
19309|13583|postgres|36081|acquiring inherited sample rows|45|38|0|0|4|1|36087  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|1|36087  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|1|36087  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|1|36087  
19309|13583|postgres|36081|acquiring inherited sample rows|45|16|0|0|4|2|36090  
19309|13583|postgres|36081|acquiring inherited sample rows|45|34|0|0|4|2|36090  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|2|36090  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|2|36090  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|2|36090  
19309|13583|postgres|36081|acquiring inherited sample rows|45|10|0|0|4|3|36093  
19309|13583|postgres|36081|acquiring inherited sample rows|45|29|0|0|4|3|36093  
19309|13583|postgres|36081|acquiring inherited sample rows|45|43|0|0|4|3|36093  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|3|36093  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|3|36093  
19309|13583|postgres|36081|acquiring inherited sample rows|45|45|0|0|4|3|36093  
19309|13583|postgres|36081|computing stats|45|45|0|0|4|4|36093    <== current_*_reid should be zero?  
19309|13583|postgres|36081|computing stats|45|45|0|0|4|4|36093  
19309|13583|postgres|36081|finalizing analyze|45|45|0|0|4|4|36093 <== there are many finalizing phases  
19309|13583|postgres|36081|finalizing analyze|45|45|0|0|4|4|36093  
19309|13583|postgres|36084|acquiring sample rows|45|3|0|0|0|0|0  
19309|13583|postgres|36084|acquiring sample rows|45|33|0|0|0|0|0  
19309|13583|postgres|36084|computing stats|45|45|0|0|0|0|0  
19309|13583|postgres|36087|acquiring sample rows|45|15|0|0|0|0|0  
19309|13583|postgres|36087|computing stats|45|45|0|0|0|0|0  
19309|13583|postgres|36087|finalizing analyze|45|45|0|0|0|0|0     <== same as above  
19309|13583|postgres|36090|acquiring sample rows|45|11|0|0|0|0|0  
19309|13583|postgres|36090|acquiring sample rows|45|41|0|0|0|0|0  
19309|13583|postgres|36090|finalizing analyze|45|45|0|0|0|0|0     <== same as above  
19309|13583|postgres|36093|acquiring sample rows|45|7|0|0|0|0|0  
19309|13583|postgres|36093|acquiring sample rows|45|37|0|0|0|0|0  
19309|13583|postgres|36093|finalizing analyze|45|45|0|0|0|0|0     <== same as above  
---------------------------------------------------------  
    
Thanks,  
Tatsuro Yamada  
```  
  
    
## 参考    
https://www.postgresql.org/message-id/flat/20190621185207.GA27929@alvherre.pgsql  
  
https://commitfest.postgresql.org/26/2164/  
    
  
  
#### [免费领取阿里云RDS PostgreSQL实例、ECS虚拟机](https://www.aliyun.com/database/postgresqlactivity "57258f76c37864c6e6d23383d05714ea")
  
  
#### [digoal's PostgreSQL文章入口](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![digoal's weixin](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
