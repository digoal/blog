## 用PostgreSQL印证巴菲特向普通读者传授的投资理念: 长线定投    
                        
### 作者                        
digoal                        
                        
### 日期                        
2022-09-06                        
                        
### 标签                        
PostgreSQL , DuckDB          
            
----                        
                        
## 背景      
用PostgreSQL印证巴菲特向普通读者传授的投资理念: 长线定投.      
- 需要补充说明一下, 长期定投不是投机倒把, 长期定投是有社会价值的, 帮助上市公司筹集资金, 加大研发投入和生产. 你则在这中间获取企业业务发展带来的红利. 
    - [《德说-第96期, 代际转移与创新、集智(全球脑)》](../202205/20220514_03.md)  
- 长期定投应该成为一种年轻人的投资潮流, 拿出盈余的钱, 开始定投吧.      
    
在任何一天开始定投某一只股票|指数基金, 每天定投500元, 测算每个交易日的收益率.    
    
结果惊人. 《小狗钱钱》《不上班也有钱》书上说的都是对的.      
- [《德说-第56期, 微笑曲线 - 基金定投》](../202110/20211029_02.md)  
      
数据来源参考, 取2001年开始茅台的数据为例:     
- [《DuckDB 线性回归预测股价的例子》](../202209/20220902_01.md)      
    
```    
postgres=# drop table his;    
DROP TABLE    
postgres=# create table his (c1 date, c2 text, c3 text, c4 numeric, c5 numeric);      
CREATE TABLE    
postgres=#     
postgres=# copy his from '/Users/digoal/Downloads/2.csv' ( format csv, HEADER , quote '"');      
COPY 5101    
postgres=# delete from his where c4=0 or c5=0;    
DELETE 74    
postgres=# create index idx_his_1 on his(c1);    
CREATE INDEX    
```    
    
```    
select     
c1, -- 日期    
price, -- 当前价    
round(cost_avg,4), -- 成本价    
round(100 * ((price-cost_avg)/cost_avg) / ((c1-start_c1+1)/365.0), 2) as revenue_year_ratio, -- 年化收益率    
rn * 500 as invest,  -- 截止当前总投入. (假设每个交易日投入500)      
round(rn * 500 * (1+ (price-cost_avg)/cost_avg ), 2) as v_value,  -- 当前持有股票的价值     
round(rn * 500 * (1+ (price-cost_avg)/cost_avg ), 2) - rn * 500 as v_make_money,  -- 赚了多少钱     
c1-start_c1 as keep_days  -- 持有天数    
from     
(    
  select     
    c1,     
    c5 as price,     
    avg(c5) over w as cost_avg,     
    min(c1) over w as start_c1,    
    row_number() over w as rn    
  from his     
  where c1 >= '2014-10-01'   -- 从2014-10-01开始投入, 你可以随意选择投入开始日期     
  -- 经济越低迷的时候股价越低, 从那时开始投入是比较好的.     
  -- 如果你的投入周期足够长, 可以从任意时间开始投入, 总会遇到可以收割的时候.      
  window w as (order by c1 range between UNBOUNDED PRECEDING and CURRENT ROW)    
) t     
order by c1;     
```    
    
从2014-10-01开始投入, 每天投入500元.     
    
你可以随意选择投入开始日期, 经济越低迷的时候股价越低, 从那时开始投入是比较好的. 走低不用怕, 周期过去后总会上来的. (不经历风雨, 怎么见彩虹?)    
    
如果你的投入周期足够长, 可以从任意时间开始投入, 总会遇到可以收割的时候.      
    
    
结果如下:      
    
日期, 当前价格, 成本价, 年化收益率, 总投入, 股票价值, 赚了多少, 持有天数      
    
```    
     c1     |  price  |  round   | revenue_year_ratio | invest |  v_value   | v_make_money | keep_days     
------------+---------+----------+--------------------+--------+------------+--------------+-----------    
 2014-10-08 |  160.73 | 160.7300 |               0.00 |    500 |     500.00 |         0.00 |         0    
 2014-10-09 |  160.01 | 160.3700 |             -40.97 |   1000 |     997.76 |        -2.24 |         1    
 2014-10-10 |  159.02 | 159.9200 |             -68.47 |   1500 |    1491.56 |        -8.44 |         2    
 2014-10-13 |   156.1 | 158.9650 |            -109.64 |   2000 |    1963.95 |       -36.05 |         5    
 2014-10-14 |  154.91 | 158.1540 |            -106.95 |   2500 |    2448.72 |       -51.28 |         6    
 2014-10-15 |  157.32 | 158.0150 |             -20.07 |   3000 |    2986.81 |       -13.19 |         7    
 2014-10-16 |  157.32 | 157.9157 |             -15.30 |   3500 |    3486.80 |       -13.20 |         8    
 2014-10-17 |  158.38 | 157.9738 |               9.39 |   4000 |    4010.29 |        10.29 |         9    
 2014-10-20 |  156.92 | 157.8567 |             -16.66 |   4500 |    4473.30 |       -26.70 |        12    
....    
 2022-08-17 |  1918.0 | 921.1272 |              13.76 | 958500 | 1995818.89 |   1037318.89 |      2870    
 2022-08-18 |  1895.5 | 921.6352 |              13.43 | 959000 | 1972347.12 |   1013347.12 |      2871    
 2022-08-19 | 1895.01 | 922.1424 |              13.40 | 959500 | 1971780.14 |   1012280.14 |      2872    
 2022-08-22 | 1893.98 | 922.6486 |              13.36 | 960000 | 1970653.66 |   1010653.66 |      2875    
 2022-08-23 | 1870.01 | 923.1417 |              13.01 | 960500 | 1945686.70 |    985186.70 |      2876    
 2022-08-24 |  1854.2 | 923.6262 |              12.78 | 961000 | 1929228.81 |    968228.81 |      2877    
 2022-08-25 |  1885.0 | 924.1261 |              13.18 | 961500 | 1961233.98 |    999733.98 |      2878    
 2022-08-26 |  1898.0 | 924.6323 |              13.34 | 962000 | 1974705.04 |   1012705.04 |      2879    
 2022-08-29 | 1878.82 | 925.1279 |              13.05 | 962500 | 1954718.00 |    992218.00 |      2882    
 2022-08-30 |  1870.0 | 925.6185 |              12.91 | 963000 | 1945520.68 |    982520.68 |      2883    
 2022-08-31 |  1924.0 | 926.1366 |              13.63 | 963500 | 2001620.41 |   1038120.41 |      2884    
 2022-09-01 | 1880.89 | 926.6318 |              13.02 | 964000 | 1956740.40 |    992740.40 |      2885    
(1928 rows)    
```    
    
    
最高收益时: 持有2317天, 年化收益率43.77%, 投入77.55万, 赚了215.5万.      
    
```    
select     
c1, -- 日期    
price, -- 当前价    
round(cost_avg,4), -- 成本价    
round(100 * ((price-cost_avg)/cost_avg) / ((c1-start_c1+1)/365.0), 2) as revenue_year_ratio, -- 年化收益率    
rn * 500 as invest,  -- 截止当前总投入. (假设每个交易日投入500)      
round(rn * 500 * (1+ (price-cost_avg)/cost_avg ), 2) as v_value,  -- 当前持有股票的价值     
round(rn * 500 * (1+ (price-cost_avg)/cost_avg ), 2) - rn * 500 as v_make_money,  -- 赚了多少钱     
c1-start_c1 as keep_days  -- 持有天数    
from     
(    
  select     
    c1,     
    c5 as price,     
    avg(c5) over w as cost_avg,     
    min(c1) over w as start_c1,    
    row_number() over w as rn    
  from his     
  where c1 >= '2014-10-01'   -- 从2014-10-01开始投入, 你可以随意选择投入开始日期     
  -- 经济越低迷的时候股价越低, 从那时开始投入是比较好的.     
  -- 如果你的投入周期足够长, 可以从任意时间开始投入, 总会遇到可以收割的时候.      
  window w as (order by c1 range between UNBOUNDED PRECEDING and CURRENT ROW)    
) t     
order by round(rn * 500 * (1+ (price-cost_avg)/cost_avg ), 2) - rn * 500 desc limit 1;     
    
    
     c1     | price  |  round   | revenue_year_ratio | invest |  v_value   | v_make_money | keep_days     
------------+--------+----------+--------------------+--------+------------+--------------+-----------    
 2021-02-10 | 2601.0 | 688.1936 |              43.77 | 775500 | 2930970.87 |   2155470.87 |      2317    
(1 row)    
```    
    
  
#### [期望 PostgreSQL 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB for PostgreSQL云原生分布式开源数据库](https://github.com/ApsaraDB/PolarDB-for-PostgreSQL "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PostgreSQL 解决方案集合](https://yq.aliyun.com/topic/118 "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
