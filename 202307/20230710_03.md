## amd64 , 使用Dockerfile+docker build制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习, 并推送到阿里云镜像服务  
  
### 作者  
digoal  
  
### 日期  
2023-07-10  
  
### 标签  
PostgreSQL , PolarDB , docker , 插件 , Dockerfile , docker build  
  
----  
  
## 背景  
如果你使用的是Apple chip, 可以参考这篇:  
- [《arm64 , 使用Dockerfile+docker build制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习, 并推送到阿里云镜像服务》](../202308/20230814_02.md)
  
如果你想直接基于PostgreSQL官方docker镜像增加新插件, 参考这篇
- [《大学生数据库实践课-PostgreSQL本地学习镜像的使用》](../202509/20250903_08.md)  
  
##### 202307/20230710_02.md   [《制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习, 并推送到阿里云镜像服务》](../202307/20230710_02.md)  
##### 202307/20230710_01.md   [《配置阿里云 Docker 镜像加速服务, 以及如何查找官方镜像tags 信息》](../202307/20230710_01.md)  
  
这个镜像集成了200+个扩展插件, 提升业务开发效率, 解决业务问题等, 涉及各个领域, 参考末尾介绍. 以及若干数据库管理工具(例如pg_rman, pgpool等).  
  
如果你发现镜像的问题, 或者想集成其他插件, 欢迎[发issue](https://github.com/digoal/blog/issues)给我, 我会尽快回复.  
  
希望这个镜像能够降低学习数据库的门槛, 帮助高校和培训机构以及学习者能够有统一的学习环境, 不再为环境问题而影响教学练, 让大家可以快速的接触到各个领域的知识, 为中国数据库人才培养添砖加瓦.  
  
## 如何使用这个镜像  
我已经配置为公开模式, 任何人都可以下载学习使用, 已经集成到[云起实验室]([https://developer.aliyun.com/adc](https://developer.aliyun.com/adc/scenario/exp/f55dbfac77c0467a9d3cd95ff6697a31)), [云起实验]([https://developer.aliyun.com/adc](https://developer.aliyun.com/adc/scenario/exp/f55dbfac77c0467a9d3cd95ff6697a31))永久免费提供给PostgreSQL数据库开源爱好者、PostgreSQL数据库教学.  
  
```  
# 拉取镜像, 第一次拉取一次即可. 或者需要的时候执行, 将更新到最新镜像版本.  
docker pull registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
  
# 启动容器  
docker run --platform linux/amd64 -d -it -P --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name pg --shm-size=1g registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts

##### 如果你想学习备份恢复、修改参数等需要重启数据库实例的case, 换个启动参数, 使用参数--entrypoint将容器根进程换成bash更好. 如下: 
docker run -d -it -P --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name pg --shm-size=1g --entrypoint /bin/bash registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts
##### 以上启动方式需要进入容器后手工启动数据库实例: su - postgres; pg_ctl start;  
  
##### 将 宿主机的存储位置 映射到 docker容器内 的例子
# 宿主机:
# mkdir -p ~/docker_volumn/pg  
# 创建容器时进行映射, 例如: -v ~/docker_volumn/pg:/data 将宿主机 ~/docker_volumn/pg 映射到 容器 /data
# 如: 
# docker run -v ~/docker_volumn/pg:/data --platform linux/amd64 -d -it -P --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name pg --shm-size=1g registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts
##### 
  
# 进入容器  
docker exec -ti pg bash  
  
# 连接数据库  
psql  
```  
  
插件列表:  
```  
postgres=# create extension    
Display all 224 possibilities? (y or n)
address_standardizer                            pg_analytics                                    pg_track_settings
"address_standardizer-3"                        pgaudit                                         pg_trgm
address_standardizer_data_us                    pgautofailover                                  pgtt
"address_standardizer_data_us-3"                pg_bigm                                         pg_utility_trigger_functions
adminpack                                       pg_bm25                                         pg_uuidv7
age                                             pg_buffercache                                  pg_variables
aggs_for_vecs                                   pg_bulkload                                     pg_visibility
amcheck                                         pg_cron                                         pg_wait_sampling
anon                                            pgcrypto                                        pipelinedb
autoinc                                         pg_curl                                         pldbgapi
aws_s3                                          pg_dbms_metadata                                pljava
bloom                                           pg_dbms_stats                                   pllua
btree_gin                                       pgdd                                            plluau
btree_gist                                      pg_dirtyread                                    plpgsql_check
citext                                          pgfaceting                                      plprofiler
citus                                           pgfincore                                       plproxy
citus_columnar                                  pg_freespacemap                                 plpython3u
columnar                                        pggraphblas                                     plr
credcheck                                       pg_hint_plan                                    plrust
cube                                            pg_idkit                                        pointcloud
datasketches                                    pg_ivm                                          pointcloud_postgis
dblink                                          pg_jieba                                        postgis
dblink_plus                                     pg_jobmon                                       "postgis-3"
ddlx                                            pgjwt                                           postgis_raster
decoderbufs                                     pg_later                                        "postgis_raster-3"
dict_int                                        pgl_ddl_deploy                                  postgis_sfcgal
dict_xsyn                                       pgmemcache                                      "postgis_sfcgal-3"
duckdb_fdw                                      pgmeminfo                                       postgis_tiger_geocoder
earthdistance                                   pg_migrate                                      "postgis_tiger_geocoder-3"
embedding                                       pgmp                                            postgis_topology
extra_window_functions                          pgmq                                            "postgis_topology-3"
file_fdw                                        pg_nanoid                                       postgres_fdw
first_last_agg                                  pg_net                                          powa
fuzzystrmatch                                   pg_onnx                                         prefix
gevel                                           pg_partman                                      pre_prepare
h3                                              pgpcre                                          prioritize
h3_postgis                                      pgpool_adm                                      q3c
hdfs_fdw                                        pgpool_recovery                                 quantile
hll                                             pgpool_regclass                                 rdkit
hnsw                                            pg_prewarm                                      refint
hstore                                          pg_proctab                                      roaringbitmap
hstore_pllua                                    pg_profile                                      rum
hstore_plluau                                   pg_qualstats                                    seg
hstore_plpython3u                               pg_query_rewrite                                sequential_uuids
http                                            pg_rational                                     smlar
hypopg                                          pg_repack                                       snowflake
icu_ext                                         pgroonga                                        sqlite_fdw
imgsmlr                                         pgroonga_database                               sslinfo
influxdb_fdw                                    pgrouting                                       supa_audit
insert_username                                 pgrowlocks                                      svector
intagg                                          pg_safer_settings                               system_stats
intarray                                        pg_safer_settings_table_dependent_extension     tablefunc
ip4r                                            pg_safer_settings_table_dependent_subextension  table_log
isn                                             pg_savior                                       tcn
jsonb_plpython3u                                pg_search                                       tdigest
jsquery                                         pgsentinel                                      tds_fdw
lantern                                         pg_show_plans                                   temporal_tables
lantern_extras                                  pg_similarity                                   timescaledb
lo                                              pgsodium                                        timescaledb_toolkit
ltree                                           pg_sparse                                       toastinfo
ltree_plpython3u                                pg_sphere                                       tsm_system_rows
mimeo                                           pg_squeeze                                      tsm_system_time
mobilitydb                                      pg_stat_kcache                                  uint
moddatetime                                     pg_stat_monitor                                 ulid
mongo_fdw                                       pg_stat_statements                              unaccent
mysql_fdw                                       pgstattuple                                     unit
ogr_fdw                                         pg_statviz                                      "uuid-ossp"
old_snapshot                                    pg_store_plans                                  vector
oracle_fdw                                      pg_subtrans_infos                               vectorize
orafce                                          pg_subxact_counters                             vops
pageinspect                                     pg_surgery                                      walminer
parquet_fdw                                     pgtap                                           xml2
parray_gin                                      pg_task                                         zhparser
pg4ml                                           pgtelemetry                                     zson
pgagent                                         pg_tiktoken                                     
```  
  
使用duckdb:  
```  
# 进入容器  
docker exec -ti pg bash  
  
# 切换用户  
su - postgres  
  
# 启动duckdb  
./duckdb  
```  
  
## 云起实验室实验简介  
免费云起实验室地址:  
- https://developer.aliyun.com/adc/scenario/exp/f55dbfac77c0467a9d3cd95ff6697a31  
  
  
内置PolarDB-X, PolarDB-PG, PostgreSQL容器镜像:  
```  
[root@iZuf6g6afqwaglx4kxuskxZ ~]# docker images  
REPOSITORY                                                     TAG              IMAGE ID       CREATED        SIZE  
registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database   pg14_with_exts   1b9d30ed2910   5 days ago     5.25GB  
polardbx/polardb-x                                             latest           f4da3f72d974   3 months ago   2.91GB  
polardb/polardb_pg_local_instance                              htap             62fcb916564e   3 months ago   5.65GB  
polardb/polardb_pg_devel                                       latest           bc8f10854b35   3 months ago   1.92GB  
```  
  
操作方法:  
  
1、PolarDB-PG  
  
创建并启动容器  
```  
docker run -d -it -P --cap-add=SYS_PTRACE --privileged=true --name polardb-pg polardb/polardb_pg_local_instance:htap  
```  
进入容器  
```  
docker exec -ti polardb-pg bash  
```  
连接数据库  
```  
psql -h 127.0.0.1 -c 'select version();'  
```  
停止容器  
```  
docker stop polardb-pg  
```  
删除容器  
```  
docker rm polardb-pg  
```  
  
2、PolarDB-X  
  
创建并启动容器  
```  
docker run -d --name polardb-x -p 8527:8527 polardbx/polardb-x  
```  
进入容器  
```  
docker exec -ti polardb-x bash  
```  
连接数据库  
```  
mysql -h127.0.0.1 -P8527 -upolardbx_root -p123456  
```  
停止容器  
```  
docker stop polardb-x  
```  
删除容器  
```  
docker rm polardb-x  
```  
  
3、PostgreSQL  
  
创建并启动容器  
```  
docker run --platform linux/amd64 -d -it -P --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name pg --shm-size=1g registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
```  
  
进入容器  
```  
docker exec -ti pg bash  
```  
  
连接数据库  
```  
psql  
```  
  
停止容器  
```  
docker stop pg  
```  
  
删除容器  
```  
docker rm pg  
```  
  
  
  
## 使用docker build + Dockerfile 制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习  
1、创建Dockerfile工作目录:  
  
```  
mkdir ~/pg14  
```  
  
  
2、下载Oracle OCI到Dockerfile工作目录. (oracle_fdw, dblink_plus插件依赖oracle library.)  
  
[《PostgreSQL 商用版本EPAS(阿里云ppas) - 测试环境部署(EPAS 安装、配置、管理、Oracle DBLINK、外表)》](../201801/20180119_01.md)  
  
http://www.oracle.com/technetwork/database/features/instant-client/index-097480.html  
  
```  
cd ~/Downloads  
unzip instantclient-basic-linux.x64-12.2.0.1.0.zip  
unzip instantclient-sdk-linux.x64-12.2.0.1.0.zip  
  
mv instantclient_12_2 ~/pg14/  
cd ~/pg14/instantclient_12_2  
ln -s libclntsh.so.12.1 libclntsh.so  
  
cd ~/pg14  
  
  
IT-C02YW2EFLVDL:pg14 digoal$ ll -R  
total 56  
-rw-r--r--    1 digoal  staff   3.3K Jul 12 09:58 1.sh  
-rw-r--r--    1 digoal  staff   2.0K Jul 12 09:58 2.sh  
-rw-r--r--    1 digoal  staff   575B Jul 12 09:59 4.sh  
-rw-r--r--    1 digoal  staff   2.3K Jul 12 09:59 5.sh  
-rw-r--r--    1 digoal  staff   6.2K Jul 12 11:30 3.sh  
-rw-r--r--    1 digoal  staff   3.3K Jul 12 12:43 Dockerfile  
drwxr-xr-x+ 110 digoal  staff   3.4K Jul 12 12:43 ..  
drwxr-xr-x    9 digoal  staff   288B Jul 12 12:43 .  
drwxr-xr-x@  20 digoal  staff   640B Jul 12 12:44 instantclient_12_2  
  
./instantclient_12_2:  
total 433376  
-rwxrwxr-x@  1 digoal  staff   119M Jan 26  2017 libociei.so  
-rwxrwxr-x@  1 digoal  staff    56K Jan 26  2017 genezi  
-rwxrwxr-x@  1 digoal  staff   235K Jan 26  2017 uidrvci  
-rwxrwxr-x@  1 digoal  staff   114K Jan 26  2017 liboramysql12.so  
-r-xr-xr-x@  1 digoal  staff   372K Jan 26  2017 libons.so  
-r-xr-xr-x@  1 digoal  staff   6.3M Jan 26  2017 libnnz12.so  
-rwxrwxr-x@  1 digoal  staff    43K Jan 26  2017 adrci  
-rw-rw-r--@  1 digoal  staff   363B Jan 26  2017 BASIC_README  
-rw-rw-r--@  1 digoal  staff    72K Jan 26  2017 xstreams.jar  
-r--r--r--@  1 digoal  staff   3.8M Jan 26  2017 ojdbc8.jar  
-r-xr-xr-x@  1 digoal  staff   155K Jan 26  2017 libocijdbc12.so  
-rwxrwxr-x@  1 digoal  staff   2.1M Jan 26  2017 libocci.so.12.1  
-r-xr-xr-x@  1 digoal  staff   526K Jan 26  2017 libmql1.so  
-r-xr-xr-x@  1 digoal  staff   2.8M Jan 26  2017 libipc1.so  
-rwxrwxr-x@  1 digoal  staff   7.7M Jan 26  2017 libclntshcore.so.12.1  
-rwxrwxr-x@  1 digoal  staff    68M Jan 26  2017 libclntsh.so.12.1  
drwxrwxr-x@  8 digoal  staff   256B Jan 26  2017 sdk  
drwxr-xr-x   9 digoal  staff   288B Jul 12 12:43 ..  
lrwxr-xr-x   1 digoal  staff    17B Jul 12 12:44 libclntsh.so -> libclntsh.so.12.1  
drwxr-xr-x@ 20 digoal  staff   640B Jul 12 12:44 .  
  
./instantclient_12_2/sdk:  
total 632  
-rw-rw-r--@  1 digoal  staff   359B Jan 26  2017 SDK_README  
drwxrwxr-x@ 31 digoal  staff   992B Jan 26  2017 include  
drwxrwxr-x@  3 digoal  staff    96B Jan 26  2017 admin  
-rw-rw-r--@  1 digoal  staff   306K Jan 26  2017 ottclasses.zip  
-r-xr-xr-x@  1 digoal  staff   874B Jan 26  2017 ott  
drwxrwxr-x@ 11 digoal  staff   352B Jan 26  2017 demo  
drwxrwxr-x@  8 digoal  staff   256B Jan 26  2017 .  
drwxr-xr-x@ 20 digoal  staff   640B Jul 12 12:44 ..  
  
./instantclient_12_2/sdk/include:  
total 3408  
-r-xr-xr-x@  1 digoal  staff    24K Jan 26  2017 occiObjects.h  
-r-xr-xr-x@  1 digoal  staff    39K Jan 26  2017 occiData.h  
-r-xr-xr-x@  1 digoal  staff    71K Jan 26  2017 occiControl.h  
-r-xr-xr-x@  1 digoal  staff    35K Jan 26  2017 occiCommon.h  
-r-xr-xr-x@  1 digoal  staff   2.1K Jan 26  2017 occi.h  
-r-xr-xr-x@  1 digoal  staff   8.7K Jan 26  2017 ociextp.h  
-r-xr-xr-x@  1 digoal  staff    12K Jan 26  2017 ocidfn.h  
-r-xr-xr-x@  1 digoal  staff   4.0K Jan 26  2017 ocidem.h  
-r-xr-xr-x@  1 digoal  staff    42K Jan 26  2017 ocidef.h  
-r-xr-xr-x@  1 digoal  staff   6.1K Jan 26  2017 ociapr.h  
-r-xr-xr-x@  1 digoal  staff   428K Jan 26  2017 ociap.h  
-r-xr-xr-x@  1 digoal  staff    10K Jan 26  2017 oci8dp.h  
-r-xr-xr-x@  1 digoal  staff   7.0K Jan 26  2017 oci1.h  
-r-xr-xr-x@  1 digoal  staff   190K Jan 26  2017 oci.h  
-r-xr-xr-x@  1 digoal  staff    11K Jan 26  2017 occiAQ.h  
-r-xr-xr-x@  1 digoal  staff   9.7K Jan 26  2017 xa.h  
-r-xr-xr-x@  1 digoal  staff   121K Jan 26  2017 ort.h  
-r-xr-xr-x@  1 digoal  staff    42K Jan 26  2017 oro.h  
-r-xr-xr-x@  1 digoal  staff   155K Jan 26  2017 orl.h  
-r-xr-xr-x@  1 digoal  staff    15K Jan 26  2017 orid.h  
-r-xr-xr-x@  1 digoal  staff   100K Jan 26  2017 ori.h  
-r-xr-xr-x@  1 digoal  staff   6.4K Jan 26  2017 oratypes.h  
-r-xr-xr-x@  1 digoal  staff    32K Jan 26  2017 odci.h  
-r-xr-xr-x@  1 digoal  staff   109K Jan 26  2017 ocixstream.h  
-r-xr-xr-x@  1 digoal  staff   7.9K Jan 26  2017 ocixmldb.h  
-r-xr-xr-x@  1 digoal  staff   6.3K Jan 26  2017 ocikpr.h  
-r-xr-xr-x@  1 digoal  staff    77K Jan 26  2017 nzt.h  
-r-xr-xr-x@  1 digoal  staff    37K Jan 26  2017 nzerror.h  
-r-xr-xr-x@  1 digoal  staff    44K Jan 26  2017 ldap.h  
drwxrwxr-x@ 31 digoal  staff   992B Jan 26  2017 .  
drwxrwxr-x@  8 digoal  staff   256B Jan 26  2017 ..  
  
./instantclient_12_2/sdk/admin:  
total 24  
-r-xr-xr-x@ 1 digoal  staff   9.8K Jan 26  2017 oraaccess.xsd  
drwxrwxr-x@ 3 digoal  staff    96B Jan 26  2017 .  
drwxrwxr-x@ 8 digoal  staff   256B Jan 26  2017 ..  
  
./instantclient_12_2/sdk/demo:  
total 152  
-rwxrwxr-x@  1 digoal  staff   4.2K Jan 26  2017 demo.mk  
-r-xr-xr-x@  1 digoal  staff   6.6K Jan 26  2017 setuporamysql.sh  
-r-xr-xr-x@  1 digoal  staff   1.1K Jan 26  2017 oraaccess.xml  
-r-xr-xr-x@  1 digoal  staff    60B Jan 26  2017 occiobj.typ  
-r-xr-xr-x@  1 digoal  staff   4.8K Jan 26  2017 occiobj.cpp  
-r-xr-xr-x@  1 digoal  staff   7.5K Jan 26  2017 occidml.cpp  
-r-xr-xr-x@  1 digoal  staff   1.9K Jan 26  2017 occidemod.sql  
-r-xr-xr-x@  1 digoal  staff   8.2K Jan 26  2017 occidemo.sql  
-r-xr-xr-x@  1 digoal  staff    17K Jan 26  2017 cdemo81.c  
drwxrwxr-x@  8 digoal  staff   256B Jan 26  2017 ..  
drwxrwxr-x@ 11 digoal  staff   352B Jan 26  2017 .  
```  
  
2\.1、下载几个较大的源码包, 降低在docker build时下载报错导致build失败的概率.  
  
```  
cd ~/pg14  
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L http://faculty.cse.tamu.edu/davis/GraphBLAS/GraphBLAS-3.1.1.tar.gz -o GraphBLAS-3.1.1.tar.gz

curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://api.pgxn.org/dist/datasketches/1.7.0/datasketches-1.7.0.zip -o datasketches-1.7.0.zip
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/duckdb/duckdb/releases/download/v0.9.2/libduckdb-linux-amd64.zip -o libduckdb-linux-amd64.zip

curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/duckdb/duckdb/releases/download/v0.9.2/libduckdb-src.zip -o libduckdb-src.zip
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/duckdb/duckdb/releases/download/v0.9.2/duckdb_cli-linux-amd64.zip -o duckdb_cli-linux-amd64.zip  
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/Kitware/CMake/releases/download/v3.27.4/cmake-3.27.4.tar.gz -o cmake-3.27.4.tar.gz

curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/Kitware/CMake/releases/download/v3.27.9/cmake-3.27.9-linux-x86_64.tar.gz -o cmake-3.27.9-linux-x86_64.tar.gz

curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/mongodb/mongo-c-driver/releases/download/1.17.3/mongo-c-driver-1.17.3.tar.gz -o mongo-c-driver-1.17.3.tar.gz

curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/json-c/json-c/archive/json-c-0.15-20200726.tar.gz -o json-c-0.15-20200726.tar.gz
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/microsoft/onnxruntime/releases/download/v1.15.1/onnxruntime-linux-x64-1.15.1.tgz -o onnxruntime-linux-x64-1.15.1.tgz

curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://nodejs.org/download/release/v14.21.3/node-v14.21.3.tar.gz -o node-v14.21.3.tar.gz
```
  
pg_task需要修改postgres.c, 很容易下载失败, 预编译好, 防止制作docker image失败.    
```
cd pg14
docker cp pg:/usr/lib/postgresql/14/lib/pg_task.so ./
docker cp pg:/usr/lib/postgresql/14/lib/bitcode/pg_task ./
docker cp pg:/usr/lib/postgresql/14/lib/bitcode/pg_task.index.bc ./
docker cp pg:/usr/share/postgresql/14/extension/pg_task.control ./
docker cp pg:/usr/share/postgresql/14/extension/pg_task--1.0.sql ./
```
  
pghero直接下载DEB安装包:
```
# pghero 目前仅支持x86版本  
# https://dl.packager.io/srv/pghero/pghero/key 需要开网络授权, 否则无法访问. build image将失败. 

/* 方法

cd /tmp
wget -T 36000 -t 0 --waitretry=5 -qO- https://dl.packager.io/srv/pghero/pghero/key | gpg --dearmour -o /etc/apt/trusted.gpg.d/pghero.gpg
# wget -T 36000 -t 0 --waitretry=5 -O /etc/apt/sources.list.d/pghero.list https://dl.packager.io/srv/pghero/pghero/master/installer/debian/$(. /etc/os-release && echo $VERSION_ID).repo
echo "deb https://dl.packager.io/srv/deb/pghero/pghero/master/debian 11 main" > /etc/apt/sources.list.d/pghero.list

for ((i=1;i>=0;i=1))
do
  apt-get update
  if [ $? -eq 0 ]; then
    break 
  fi
done
  
for ((i=1;i>=0;i=1))
do
  apt-get install -y --download-only pghero
  # OR,  apt-get download pghero  
  if [ $? -eq 0 ]; then
    break 
  fi
done

以上 apt-get install -y --download-only pghero  会把pghero安装包下载到  /var/cache/apt/archives 目录中

方法 */


如果apt-get install报错, 表示 pghero 网络问题导致无法apt安装, 直接下载.  pghero_3.4.0-1701207987.0382b812.bullseye_amd64.deb    
#11 4182.4 Need to get 75.6 MB of archives.
#11 4182.4 After this operation, 286 MB of additional disk space will be used.
#11 4182.4 Get:1 https://dl.packager.io/srv/deb/pghero/pghero/master/debian 11/main amd64 pghero amd64 3.4.0-1701207987.0382b812.bullseye [75.6 MB] 
#11 ...  
#11 6288.8 Err:1 https://dl.packager.io/srv/deb/pghero/pghero/master/debian 11/main amd64 pghero amd64 3.4.0-1701207987.0382b812.bullseye 
#11 6288.8   Connection timed out [IP: 178.63.71.248 443]
#11 6288.9 E: Failed to fetch https://dl.packager.io/srv/pghero/pghero/downloads/223434?token=eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJkbC5wYWNrYWdlci5pbyIsInN1YiI6InBhY2thZ2UjMjIzNDM0IiwiaWF0IjoxNzA0MTg0OTEzLCJleHAiOiIxNzA0MTg4NTEzIn0.gxdWl8Cr5R3AXVI36s2W2e_i5w27kcxQTMthl1MS72g  Connection timed out [IP: 178.63.71.248 443]

直接在chrome中下载, 参考 [《macOS 通过“oversea region ECS和ssh隧道转发代理请求” OR “openVPN” 提升github等访问体验 - chrome Proxy SwitchyOmega , cli ... 可用》](../202310/20231029_01.md)  
URL: 
https://dl.packager.io/srv/pghero/pghero/downloads/223434?token=eyJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJkbC5wYWNrYWdlci5pbyIsInN1YiI6InBhY2thZ2UjMjIzNDM0IiwiaWF0IjoxNzA0MTg0OTEzLCJleHAiOiIxNzA0MTg4NTEzIn0.gxdWl8Cr5R3AXVI36s2W2e_i5w27kcxQTMthl1MS72g

安装下载的deb包: 
dpkg -i pghero_3.4.0-1701207987.0382b812.bullseye_amd64.deb

参考: 
https://www.cnblogs.com/tomtellyou/p/15153935.html
https://blog.csdn.net/zgp210317/article/details/120586189
```
  
plrust deb包下载: https://github.com/tcdi/plrust/releases  
  
plrust arm版本编译: https://github.com/digoal/blog/blob/master/202402/20240201_04.md  
  
pgroll bin包下载: https://github.com/xataio/pgroll/releases   文件名全部更名为pgroll   
  
参考文档打包pg_tiktoken:  
- [《PostgreSQL 或PolarDB 使用插件pg_tiktoken - 使用 OpenAI tiktoken库文本向量化(tokenization) - 使用分词算法BPE - NLP 自然语言处理》](../202307/20230706_05.md)  
  
参考文档打包lantern_extras:  
- [《PolarDB|PG AI 功能练习插件: lantern_extras》](../202309/20230922_01.md)  
  
参考文档打包pg_bm25(pg_search), pg_sparse(svector), pg_analytics:  
- [《PostgreSQL pg_bm25(open source by paradedb)：Postgres 内部的弹性质量全文搜索 性能优于tsvector tsrank 20x》](../202310/20231016_03.md)
- https://blog.paradedb.com/pages/introducing_paradedb  
  
参考文档打包pg_idkit:  
- [《PostgreSQL pg_idkit: 集成大量uuid方法和函数插件》](../202312/20231224_01.md)  
  
参考文档打包 PgDD:      
- [《PostgreSQL PgDD: PostgreSQL Data Dictionary for 开发者, 快速了解数据库概貌》](../202312/20231224_03.md)
  
参考文档打包 pgmq, pg_later, pg_vectorize :  
- [《PGMQ》](../202401/20240108_01.md)      
- [《pg_later》](../202401/20240108_02.md)   
- [《pg_vectorize》](../202401/20240108_03.md)
  
3\.0、解决github慢或无法联通问题:    
```
# 如果有必要, 可以使用如下方法解决github clone性能问题.       
# [《macOS 通过“oversea region ECS和ssh隧道转发代理请求” OR “openVPN” 提升github等访问体验 - chrome Proxy SwitchyOmega , cli ... 可用》](../202310/20231029_01.md)  
# 在docker宿主机开启代理, proxy.sh 里面 -D 127.0.0.1:11111 改成 -D 0.0.0.0:11111  表示监听所有ipv4端口
# 获取宿主机bridgeIP: ifconfig   
# 在docker build的脚本中, 执行 github clone 开始前, 先执行export 如下. 执行一次即可.   
# export all_proxy=socks5://宿主机bridgeIP:11111  
```
  
  
3、准备脚本, 参考末尾`Max depth exceeded`报错, 目的是减少dockerfile步骤. 但是写成一堆脚本不太好调试, 建议先手工制作后再用Dockerfile来制作.  
  
```  
cd ~/pg14  
```  
  
```  
vi 1.sh  
```  
  
```  
#!/bin/bash  
set -vx  
  
cd /tmp  
sed -i "s@http://\(deb\|security\).debian.org@http://mirrors.aliyun.com@g" /etc/apt/sources.list  
apt-get update  
apt-get reinstall -y apt-transport-https ca-certificates  
sed -i "s@http://mirrors.aliyun.com@https://mirrors.aliyun.com@g" /etc/apt/sources.list  
apt-get update  
apt-get install -y lsb-release wget vim man  
  
# RUN echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list  
echo "deb https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/apt/ $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list  
apt-get install -y gnupg2  
  
# RUN wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmour -o /etc/apt/trusted.gpg.d/postgresql.gpg 
# wget --quiet -O - https://mirrors.tuna.tsinghua.edu.cn/postgresql/repos/apt/ACCC4CF8.asc | gpg --dearmour -o /etc/apt/trusted.gpg.d/postgresql.gpg
wget --quiet -O - http://apt.postgresql.org/pub/repos/apt/ACCC4CF8.asc | gpg --dearmour -o /etc/apt/trusted.gpg.d/postgresql.gpg  
apt-get update  
apt-get install -y locales  
localedef -i en_US -f UTF-8 en_US.UTF-8  
  
apt-get install -y curl libicu-dev icu-devtools libbison-dev libfl-dev git libreadline-dev libedit-dev g++ make cmake man-db dnsutils clang libssl-dev default-jdk strace gdb libsqlite3-dev lsof blktrace  
apt-get install -y unixodbc unixodbc-dev bash-completion m4 python3-distutils python glibc-source zlib1g-dev pkg-config default-jre openjdk-17-jdk openjdk-17-jdk-headless
apt-get install -y zip unzip dpkg-dev
# echo "A" | apt-get install -y -q oracle-libs
apt-get install -y -q oracle-libs
apt-get install -y postgresql-14 postgresql-client-14 postgresql-server-dev-14 postgresql-doc-14  
apt-get install -y postgresql-14-dirtyread postgresql-14-extra-window-functions postgresql-14-first-last-agg postgresql-14-hll postgresql-14-hypopg  
apt-get install -y postgresql-14-ip4r postgresql-14-mysql-fdw postgresql-14-jsquery postgresql-14-ogr-fdw postgresql-14-oracle-fdw postgresql-14-pgmemcache  
apt-get install -y postgresql-14-pljava postgresql-14-pllua postgresql-14-plpgsql-check postgresql-14-plproxy postgresql-14-prefix postgresql-14-rational  
apt-get install -y postgresql-14-rdkit postgresql-14-orafce postgresql-14-pg-qualstats postgresql-14-pg-stat-kcache  
apt-get install -y postgresql-14-pg-wait-sampling postgresql-14-pgfincore postgresql-14-pgaudit postgresql-14-pgpool2 postgresql-14-pgrouting postgresql-14-pgrouting-doc  
apt-get install -y postgresql-14-pgrouting-scripts postgresql-14-pgsphere postgresql-14-pgvector postgresql-14-pldebugger postgresql-14-pointcloud postgresql-14-plr  
apt-get install -y postgresql-14-postgis-3 postgresql-14-postgis-3-scripts postgresql-14-powa powa-collector postgresql-14-q3c postgresql-14-repack  
apt-get install -y postgresql-14-rum postgresql-14-show-plans postgresql-14-similarity postgresql-14-tablelog postgresql-14-tdigest postgresql-14-wal2json  
apt-get install -y postgresql-14-tds-fdw postgresql-14-plprofiler postgresql-14-cron  
apt-get install -y pgagroal pgpool2 pgbouncer pgxnclient pgagent postgresql-plpython3-14 postgresql-14-icu-ext libpq-dev pgreplay pgbackrest pgbackrest-doc elephant-shed-pgbackrest postgresql-14-partman patroni barman etcd vip-manager2 repmgr postgresql-14-repmgr postgresql-14-pgtap inetutils-ping telnet 

# pghero 目前仅支持x86版本
cd /tmp  
dpkg -i pghero_3.4.0-1701207987.0382b812.bullseye_amd64.deb
  
echo "deb https://packagecloud.io/timescale/timescaledb/debian/ $(lsb_release -c -s) main" | tee /etc/apt/sources.list.d/timescaledb.list  
for ((i=1;i>=0;i=1))
do
  wget --quiet -O - https://packagecloud.io/timescale/timescaledb/gpgkey | gpg --dearmor -o /etc/apt/trusted.gpg.d/timescaledb.gpg
  if [ $? -eq 0 ]; then
    break 
  fi
done

for ((i=1;i>=0;i=1))
do
  apt-get update
  if [ $? -eq 0 ]; then
    break 
  fi
done

for ((i=1;i>=0;i=1))
do
  apt-get install -y timescaledb-2-postgresql-14
  if [ $? -eq 0 ]; then
    break 
  fi
done
  
for ((i=1;i>=0;i=1))
do
  wget -T 36000 -t 0 --waitretry=5 https://packages.groonga.org/debian/groonga-apt-source-latest-bullseye.deb
  if [ $? -eq 0 ]; then
    break 
  fi
done

apt-get install -y -V ./groonga-apt-source-latest-bullseye.deb 

for ((i=1;i>=0;i=1))
do
  apt-get update
  if [ $? -eq 0 ]; then
    break 
  fi
done

for ((i=1;i>=0;i=1))
do
  apt-get install -y postgresql-14-pgdg-pgroonga
  if [ $? -eq 0 ]; then
    break 
  fi
done

apt-get install -y postgresql-14-credcheck postgresql-14-decoderbufs postgresql-14-mimeo postgresql-14-pgmp postgresql-14-preprepare postgresql-14-prioritize postgresql-14-squeeze postgresql-14-toastinfo postgresql-14-unit pgbadger pg-auto-failover-cli postgresql-14-auto-failover net-tools apt-utils ora2pg pgloader pg-activity 

# https://dev.mysql.com/downloads/repo/apt/ 
cd /tmp
wget -T 36000 -t 0 --waitretry=5 https://repo.mysql.com//mysql-apt-config_0.8.29-1_all.deb
dpkg -i mysql-apt-config_0.8.29-1_all.deb
# https://dev.mysql.com/doc/mysql-apt-repo-quick-guide/en/  add gpg key
# key value 可能经常变化, 需要关注 以上 URL进行更新. 
apt-key adv --keyserver pgp.mit.edu --recv-keys 3A79BD29
apt-get update
apt-get install -y mysql-server

# proxysql, High Performance Advanced Proxy for MySQL
# https://proxysql.com/documentation/installing-proxysql/
cd /tmp
dpkg -i proxysql_2.5.5-debian11_amd64.deb
```  
  
```  
vi 2.sh  
```  
  
```  
#!/bin/bash  
set -vx  
  
export ROOT_HOME=/root  
echo "#  add by digoal" >>$ROOT_HOME/.bashrc  
echo "alias rm='rm -i'" >>$ROOT_HOME/.bashrc  
echo "alias cp='cp -i'" >>$ROOT_HOME/.bashrc  
echo "alias ll='ls -larth'" >>$ROOT_HOME/.bashrc  
echo "alias mv='mv -i'" >>$ROOT_HOME/.bashrc  
echo "export PGHOME=/usr/lib/postgresql/14" >>$ROOT_HOME/.bashrc  
echo "export PATH=\$PGHOME/bin:\$PATH" >>$ROOT_HOME/.bashrc  
echo "export LD_LIBRARY_PATH=\$PGHOME/lib:/usr/local/lib:/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH" >>$ROOT_HOME/.bashrc  
echo "export PGDATA=/var/lib/postgresql/14/pgdata" >>$ROOT_HOME/.bashrc  
echo "export PGUSER=postgres" >>$ROOT_HOME/.bashrc  
echo "export PGHOST=\$PGDATA" >>$ROOT_HOME/.bashrc  
echo "export PGPORT=1921" >>$ROOT_HOME/.bashrc  
echo "export PGDATABASE=postgres" >>$ROOT_HOME/.bashrc  
echo "export LC_ALL=en_US.UTF-8" >>$ROOT_HOME/.bashrc
echo "export PATH=/tmp/cmake-3.27.9/bin:\$PATH" >>$ROOT_HOME/.bashrc
echo "export MANPATH=/tmp/cmake-3.27.9/man:\$MANPATH" >>$ROOT_HOME/.bashrc
. $ROOT_HOME/.bashrc  
  
export PG_HOME=/var/lib/postgresql  
echo "#  add by digoal" >>$PG_HOME/.bash_profile  
echo "alias rm='rm -i'" >>$PG_HOME/.bash_profile  
echo "alias cp='cp -i'" >>$PG_HOME/.bash_profile  
echo "alias ll='ls -larth'" >>$PG_HOME/.bash_profile  
echo "alias mv='mv -i'" >>$PG_HOME/.bash_profile  
echo "export PGHOME=/usr/lib/postgresql/14" >>$PG_HOME/.bash_profile  
echo "export PATH=\$PGHOME/bin:\$PATH" >>$PG_HOME/.bash_profile  
echo "export LD_LIBRARY_PATH=\$PGHOME/lib:/usr/local/lib:/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH" >>$PG_HOME/.bash_profile  
echo "export PGDATA=/var/lib/postgresql/14/pgdata" >>$PG_HOME/.bash_profile  
echo "export PGUSER=postgres" >>$PG_HOME/.bash_profile  
echo "export PGHOST=\$PGDATA" >>$PG_HOME/.bash_profile  
echo "export PGPORT=1921" >>$PG_HOME/.bash_profile  
echo "export PGDATABASE=postgres" >>$PG_HOME/.bash_profile  
echo "export LC_ALL=en_US.UTF-8" >>$PG_HOME/.bash_profile
echo "export PATH=/tmp/cmake-3.27.9/bin:\$PATH" >>$PG_HOME/.bash_profile
echo "export MANPATH=/tmp/cmake-3.27.9/man:\$MANPATH" >>$PG_HOME/.bash_profile
  
echo ". ~/.bash_profile" > $PG_HOME/.profile  
chown postgres:postgres $PG_HOME/.bash_profile  
chown postgres:postgres $PG_HOME/.profile  
```  
  
```  
vi 3.sh  
```  
  
```  
#!/bin/bash  
set -vx  
  
export ROOT_HOME=/root  
. $ROOT_HOME/.bashrc  
  
export TEMP_DIR=/tmp  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/jaiminpan/pg_jieba  
cd $TEMP_DIR/pg_jieba  
git submodule update --init --recursive --depth 1  
mkdir build  
cd $TEMP_DIR/pg_jieba/build  
cmake -DPostgreSQL_TYPE_INCLUDE_DIR=/usr/include/postgresql/14/server ..  
make && make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/ChenHuajun/pg_roaringbitmap  
cd $TEMP_DIR/pg_roaringbitmap  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/theirix/parray_gin  
cd $TEMP_DIR/parray_gin  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/jirutka/smlar  
cd $TEMP_DIR/smlar  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/alitrack/duckdb_fdw
# 14版本 bug fix 之前
# git clone  https://github.com/alitrack/duckdb_fdw
cd $TEMP_DIR/duckdb_fdw
# git checkout 87c66cf04243c7bc43e0e75d0b8ce5dd76d81cd5 
# wget -T 36000 -t 0 --waitretry=5 https://github.com/duckdb/duckdb/releases/download/v0.9.2/libduckdb-linux-amd64.zip  
# curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/duckdb/duckdb/releases/download/v0.9.2/libduckdb-linux-amd64.zip -o libduckdb-linux-amd64.zip  
# cp $TEMP_DIR/libduckdb-linux-amd64.zip $TEMP_DIR/duckdb_fdw/  
# unzip -n -d . libduckdb-linux-amd64.zip  
# cp libduckdb.so $(pg_config --libdir)  
# USE_PGXS=1 make  
# USE_PGXS=1 make install
mkdir /tmp/duckdb_fdw/libduckdb   
mv /tmp/libduckdb-src.zip /tmp/duckdb_fdw/libduckdb/   
cd /tmp/duckdb_fdw/libduckdb   
unzip libduckdb-src.zip  
unalias cp  
cp -f duckdb.h ../  
cp -f duckdb.hpp ../  
# 编译 libduckdb.so 可能比较费内存, 建设调大docker 内存限制到8GB以上   
# 编译参数需要 -std=c++11 -D_GLIBCXX_USE_CXX11_ABI=0 与 duckdb_fdw src Makefile 一致   
clang++ -c -fPIC -std=c++11 -D_GLIBCXX_USE_CXX11_ABI=0 duckdb.cpp -o duckdb.o   
clang++ -shared -o libduckdb.so *.o   
cp -f libduckdb.so $(pg_config --libdir)   
cp -f libduckdb.so /tmp/duckdb_fdw/   
cd /tmp/duckdb_fdw   
USE_PGXS=1 make uninstall  
USE_PGXS=1 make clean  
USE_PGXS=1 make distclean  
USE_PGXS=1 make    
USE_PGXS=1 make install    
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/EnterpriseDB/hdfs_fdw  
cd $TEMP_DIR/hdfs_fdw/libhive  
JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 JDK_INCLUDE=$JAVA_HOME/include INSTALL_DIR=/usr/lib/postgresql/14/lib PATH=/usr/lib/postgresql/14/bin:$PATH make  
JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 JDK_INCLUDE=$JAVA_HOME/include INSTALL_DIR=/usr/lib/postgresql/14/lib PATH=/usr/lib/postgresql/14/bin:$PATH make install  
  
cd $TEMP_DIR/hdfs_fdw/libhive/jdbc  
javac MsgBuf.java  
javac HiveJdbcClient.java  
jar cf HiveJdbcClient-1.0.jar *.class  
cp HiveJdbcClient-1.0.jar /usr/lib/postgresql/14/lib  
  
cd $TEMP_DIR/hdfs_fdw  
JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 JDK_INCLUDE=$JAVA_HOME/include INSTALL_DIR=/usr/lib/postgresql/14/lib PATH=/usr/lib/postgresql/14/bin:$PATH USE_PGXS=1 make  
JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64 JDK_INCLUDE=$JAVA_HOME/include INSTALL_DIR=/usr/lib/postgresql/14/lib PATH=/usr/lib/postgresql/14/bin:$PATH USE_PGXS=1 make install  
  
  
cd $TEMP_DIR  
git clone --depth 1 --branch stable https://github.com/jedisct1/libsodium  
cd $TEMP_DIR/libsodium  
./configure  
make  
make check  
make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/michelp/pgsodium  
cd $TEMP_DIR/pgsodium  
C_INCLUDE_PATH=/usr/include/postgresql/14/server PG_LDFLAGS=-L/usr/lib/postgresql/14/lib USE_PGXS=1 make  
C_INCLUDE_PATH=/usr/include/postgresql/14/server PG_LDFLAGS=-L/usr/lib/postgresql/14/lib USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://github.com/libgd/libgd/archive/refs/tags/gd-2.3.3.tar.gz  
tar -zxvf gd-2.3.3.tar.gz  
cd $TEMP_DIR/libgd-gd-2.3.3  
mkdir build  
cd $TEMP_DIR/libgd-gd-2.3.3/build  
cmake ..  
make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/digoal/imgsmlr  
# git clone --depth 1 https://github.com/postgrespro/imgsmlr  
cd $TEMP_DIR/imgsmlr  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/postgrespro/vops  
cd $TEMP_DIR/vops  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 -b PG14 https://github.com/ossc-db/pg_hint_plan  
cd $TEMP_DIR/pg_hint_plan  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
apt-get install -y libselinux1-dev libpam0g-dev libkrb5-dev liblz4-dev  
git clone --depth 1 https://github.com/ossc-db/pg_bulkload  
cd $TEMP_DIR/pg_bulkload  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 -b 1.6.1 https://github.com/ossc-db/pg_store_plans  
cd $TEMP_DIR/pg_store_plans  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
# cd $TEMP_DIR  
# git clone --depth 1 -b REL-5_5_0 https://github.com/EnterpriseDB/mongo_fdw  
# cd $TEMP_DIR/mongo_fdw  
# ./autogen.sh --with-master  
# apt-get install -y libmongoc-dev  
# # C_INCLUDE_PATH="/include/libmongoc-1.0/mongoc:/include/libbson-1.0" USE_PGXS=1 make  
# # C_INCLUDE_PATH="/include/libmongoc-1.0/mongoc:/include/libbson-1.0" USE_PGXS=1 make install  
# USE_PGXS=1 make  
# USE_PGXS=1 make install

cd $TEMP_DIR  
git clone --depth 1 -b REL-5_5_1 https://github.com/EnterpriseDB/mongo_fdw  
cd $TEMP_DIR/mongo_fdw  
cp $TEMP_DIR/mongo-c-driver-1.17.3.tar.gz ./
tar -xzvf mongo-c-driver-1.17.3.tar.gz
rm -rf mongo-c-driver
mv mongo-c-driver-1.17.3 mongo-c-driver
cd $TEMP_DIR/mongo_fdw/mongo-c-driver
cmake -DENABLE_AUTOMATIC_INIT_AND_CLEANUP=OFF -DENABLE_SSL=AUTO .
make install 

cd $TEMP_DIR/mongo_fdw  
cp $TEMP_DIR/json-c-0.15-20200726.tar.gz ./ 
tar -xzvf json-c-0.15-20200726.tar.gz
rm -rf json-c
mv json-c-json-c-0.15-20200726 json-c
cd $TEMP_DIR/mongo_fdw/json-c
cmake .
make -j 2
make install

apt-get install -y libmongoc-dev  

cd $TEMP_DIR/mongo_fdw
echo "#ifdef __CONFIG__" >> config.h 
echo "#define META_DRIVER" >> config.h 
echo "#endif" >> config.h 
export PKG_CONFIG_PATH=mongo-c-driver/src/libmongoc/src:mongo-c-driver/src/libbson/src
mv Makefile Makefile.origin 
cp Makefile.meta Makefile 
# C_INCLUDE_PATH="/include/libmongoc-1.0/mongoc:/include/libbson-1.0" USE_PGXS=1 make  
# C_INCLUDE_PATH="/include/libmongoc-1.0/mongoc:/include/libbson-1.0" USE_PGXS=1 make install  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/neondatabase/neon  
cd $TEMP_DIR/neon/pgxn/hnsw  
USE_PGXS=1 make  
USE_PGXS=1 make install  

apt-get install -y libzstd-dev libxslt1-dev libxml2-dev libcurl-ocaml-dev  
cd $TEMP_DIR  
curl https://install.citusdata.com/community/deb.sh > add-citus-repo.sh  
bash add-citus-repo.sh  
apt-get install -y postgresql-14-citus-11.3  
  
cd $TEMP_DIR  
apt-get install -y libboost-all-dev  
# wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/datasketches/1.7.0/datasketches-1.7.0.zip  
unzip datasketches-1.7.0.zip  
cd $TEMP_DIR/datasketches-1.7.0  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
# get GraphBLAS, compile with debug symbols  
# curl --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -s -L http://faculty.cse.tamu.edu/davis/GraphBLAS/GraphBLAS-3.1.1.tar.gz | tar zxvf - && cd GraphBLAS-3.1.1 && make library CMAKE_OPTIONS='-DCMAKE_BUILD_TYPE=Debug' && make install  
tar -zxvf GraphBLAS-3.1.1.tar.gz  
cd GraphBLAS-3.1.1  
make library CMAKE_OPTIONS='-DCMAKE_BUILD_TYPE=Debug'  
make install  
cd $TEMP_DIR  
git clone --depth 1 --branch 22July2019 https://github.com/GraphBLAS/LAGraph.git && cd LAGraph && make -j4 library && make install  
# cd $TEMP_DIR  
# curl --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -s -L https://github.com/theory/pgtap/archive/v0.99.0.tar.gz | tar zxvf - && cd pgtap-0.99.0 && make -j4 && make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/michelp/pggraphblas  
cd $TEMP_DIR/pggraphblas  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 -b REL1_2_STABLE https://github.com/pgbigm/pg_bigm  
cd $TEMP_DIR/pg_bigm  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/percona/pg_stat_monitor  
cd $TEMP_DIR/pg_stat_monitor  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/neondatabase/pg_embedding  
cd $TEMP_DIR/pg_embedding  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/cybertec-postgresql/pgfaceting  
cd $TEMP_DIR/pgfaceting  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/pgexperts/pg_plan_filter  
cd $TEMP_DIR/pg_plan_filter  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/postgrespro/pg_variables  
cd $TEMP_DIR/pg_variables  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
apt-get install -y libcurl-ocaml-dev  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_curl/2.2.2/pg_curl-2.2.2.zip  
unzip pg_curl-2.2.2.zip  
cd $TEMP_DIR/pg_curl-2.2.2  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
apt-get install -y systemtap-sdt-dev
mkdir -p /usr/lib/postgresql/14/lib
mkdir -p /usr/lib/postgresql/14/lib/bitcode
mkdir -p /usr/share/postgresql/14/extension
mv pg_task.so /usr/lib/postgresql/14/lib/
mv pg_task.index.bc /usr/lib/postgresql/14/lib/bitcode/
mv pg_task /usr/lib/postgresql/14/lib/bitcode/
mv pg_task.control /usr/share/postgresql/14/extension/
mv pg_task--1.0.sql /usr/share/postgresql/14/extension/
cd $TEMP_DIR  
git clone --depth 1 -b extension https://github.com/RekGRpth/pg_task
# OR
# git clone --depth 1 -b extension https://github.com/RekGRpth/pg_task  
# cd $TEMP_DIR/pg_task  
# USE_PGXS=1 make install
# OR
# pgxn install pg_task
# OR
# wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_task/2.0.41/pg_task-2.0.41.zip  
# unzip pg_task-2.0.41.zip  
# cd $TEMP_DIR/pg_task-2.0.41  
# USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/temporal_tables/1.2.2/temporal_tables-1.2.2.zip  
unzip temporal_tables-1.2.2.zip  
cd $TEMP_DIR/temporal_tables-1.2.2  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 -b v3.1 https://github.com/darold/pgtt  
cd $TEMP_DIR/pgtt  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_query_rewrite/0.0.5/pg_query_rewrite-0.0.5.zip  
unzip pg_query_rewrite-0.0.5.zip  
cd $TEMP_DIR/pg_query_rewrite-0.0.5  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_track_settings/2.1.2/pg_track_settings-2.1.2.zip  
unzip pg_track_settings-2.1.2.zip  
cd $TEMP_DIR/pg_track_settings-2.1.2  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/aggs_for_vecs/1.3.0/aggs_for_vecs-1.3.0.zip  
unzip aggs_for_vecs-1.3.0.zip  
cd $TEMP_DIR/aggs_for_vecs-1.3.0  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/quantile/1.1.7/quantile-1.1.7.zip  
unzip quantile-1.1.7.zip  
cd $TEMP_DIR/quantile-1.1.7  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_utility_trigger_functions/1.9.1/pg_utility_trigger_functions-1.9.1.zip  
unzip pg_utility_trigger_functions-1.9.1.zip  
cd $TEMP_DIR/pg_utility_trigger_functions-1.9.1  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pg_safer_settings/0.8.10/pg_safer_settings-0.8.10.zip  
unzip pg_safer_settings-0.8.10.zip  
cd $TEMP_DIR/pg_safer_settings-0.8.10  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/ddlx/0.27.0/ddlx-0.27.0.zip  
unzip ddlx-0.27.0.zip  
cd $TEMP_DIR/ddlx-0.27.0  
USE_PGXS=1 make install

cd $TEMP_DIR  
wget -T 36000 -t 0 --waitretry=5 https://api.pgxn.org/dist/pgtelemetry/1.6.0/pgtelemetry-1.6.0.zip
unzip pgtelemetry-1.6.0.zip  
cd $TEMP_DIR/pgtelemetry-1.6.0
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 -b REL14_0 https://github.com/ossc-db/pg_dbms_stats  
cd $TEMP_DIR/pg_dbms_stats  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
apt-get install -y libzlcore-dev  
git clone --depth 1 -b REL_14_STABLE https://github.com/ossc-db/pg_rman  
cd $TEMP_DIR/pg_rman  
make install  

# http://sigaev.ru/ 和 http://www.sigaev.ru/git/gitweb.cgi 需要开网络授权, 否则无法访问导致build image报错. 
cd $TEMP_DIR  
git clone --depth 1 git://sigaev.ru/online_analyze  
cd $TEMP_DIR/online_analyze/  
USE_PGXS=1 make  
USE_PGXS=1 make install  

# http://sigaev.ru/ 和 http://www.sigaev.ru/git/gitweb.cgi 需要开网络授权, 否则无法访问导致build image报错. 
cd $TEMP_DIR  
git clone --depth 1 git://sigaev.ru/plantuner  
cd $TEMP_DIR/plantuner/  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/digoal/gevel  
cd $TEMP_DIR/gevel  
. ./install.sh  
  
cd $TEMP_DIR  
git clone --depth 1 -b 4.6 https://github.com/zubkov-andrei/pg_profile  
cd $TEMP_DIR/pg_profile  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
cd $TEMP_DIR  
# git clone --depth 1 https://github.com/s-hironobu/pg_plan_inspector  
# cd $TEMP_DIR/pg_plan_inspector
# bug 修复之前 :  https://github.com/s-hironobu/pg_plan_inspector/issues/1 
git clone https://github.com/s-hironobu/pg_plan_inspector  
cd $TEMP_DIR/pg_plan_inspector  
git checkout fa845045ed5a776779f2d5308608ac18ed045aad
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
# apt-get install -y libhealpix-cxx-dev  
# cd $TEMP_DIR  
# git clone --depth 1 -b 1.2.3 https://github.com/postgrespro/pgsphere  
# cd $TEMP_DIR/pgsphere  
# USE_PGXS=1 make  
# USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/sraoss/pg_ivm  
cd $TEMP_DIR/pg_ivm  
USE_PGXS=1 make  
USE_PGXS=1 make install  
  
# cd $TEMP_DIR  
# git clone --depth 1 https://github.com/pgvector/pgvector  
# cd $TEMP_DIR/pgvector  
# USE_PGXS=1 make  
# USE_PGXS=1 make install  
  
cd $TEMP_DIR  
git clone --depth=1 https://github.com/vyruss/pg_statviz.git  
cd $TEMP_DIR/pg_statviz  
USE_PGXS=1 make install  
  
apt-get install -y python3-pip  
pip install pg_statviz  
  
cd $TEMP_DIR  
## curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/Kitware/CMake/releases/download/v3.27.4/cmake-3.27.4.tar.gz -o cmake-3.27.4.tar.gz  
# tar -zxvf cmake-3.27.4.tar.gz  
# cd $TEMP_DIR/cmake-3.27.4  
# env CC=clang CXX=clang++ ./bootstrap -- -DCMAKE_BUILD_TYPE:STRING=Release  
# make -j2  
# make install
tar -zxvf cmake-3.27.9-linux-x86_64.tar.gz 
mv cmake-3.27.9-linux-x86_64 cmake-3.27.9 
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/zachasme/h3-pg  
cd $TEMP_DIR/h3-pg  
USE_PGXS=1 make all  
USE_PGXS=1 make install  
  
  
export RUSTUP_DIST_SERVER=https://mirrors.ustc.edu.cn/rust-static  
export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup  
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -o ./rust.sh  
chmod 500 rust.sh  
./rust.sh -y  
source "$HOME/.cargo/env"

cd $TEMP_DIR  
git clone --depth 1 -b 1.3.2 https://gitlab.com/dalibo/postgresql_anonymizer.git  
cd $TEMP_DIR/postgresql_anonymizer  
make extension  
make install  
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/postgresml/pgcat  
cd $TEMP_DIR/pgcat  
cargo build --release  
  
cd $TEMP_DIR
git clone --depth 1 https://github.com/chimpler/postgres-aws-s3
cd $TEMP_DIR/postgres-aws-s3
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 -b PG14 https://github.com/apache/age
cd $TEMP_DIR/age
USE_PGXS=1 make
USE_PGXS=1 make install

apt-get install -y npm 
# cd $TEMP_DIR
# tar -zxvf node-v14.21.3.tar.gz
# cd node-v14.21.3
# ./configure
# CC=clang CXX=clang++ make -j 4
# CC=clang CXX=clang++ make install
npm config set registry https://registry.npmmirror.com
npm config set fetch-retries 100
npm config set fetch-retry-mintimeout 120000
npm config set fetch-retry-maxtimeout 60000000
npm config set cache-min 3600
npm i pm2
cd $TEMP_DIR
git clone --depth 1 https://github.com/apache/age-viewer
cd $TEMP_DIR/age-viewer
npm run setup

cd $TEMP_DIR 
git clone --depth 1 https://github.com/michelp/pgjwt
cd $TEMP_DIR/pgjwt 
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/supabase/pg_net
cd $TEMP_DIR/pg_net
USE_PGXS=1 make install
# bug : ERROR:  extension "pg_net" has no installation script nor update path for version "0.7.3" 
# cd $TEMP_DIR/pg_net/sql
# cp -f -n ./pg_net.sql ./pg_net--0.7.3.sql /usr/share/postgresql/14/extension/

cd $TEMP_DIR
wget -q -O - http://www.xunsearch.com/scws/down/scws-1.2.3.tar.bz2 | tar jxf -
cd $TEMP_DIR/scws-1.2.3 
./configure 
make install 

cd $TEMP_DIR
git clone --depth 1 https://github.com/amutu/zhparser.git
cd $TEMP_DIR/zhparser 
PG_CONFIG=/usr/lib/postgresql/14/bin/pg_config make && make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/pramsey/pgsql-http
cd $TEMP_DIR/pgsql-http
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/pgsentinel/pgsentinel
cd $TEMP_DIR/pgsentinel/src
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/postgrespro/zson
cd $TEMP_DIR/zson
USE_PGXS=1 make install

cd $TEMP_DIR
cp pg_tiktoken--0.0.1.sql /usr/share/postgresql/14/extension/
cp pg_tiktoken.control /usr/share/postgresql/14/extension/
cp pg_tiktoken.so /usr/lib/postgresql/14/lib/

cd $TEMP_DIR 
git clone --depth 1 --recursive https://github.com/lanterndata/lantern.git
cd $TEMP_DIR/lantern
mkdir build
cd $TEMP_DIR/lantern/build
cmake ..
make install

cd $TEMP_DIR
cp lantern_extras--0.1.5.sql /usr/share/postgresql/14/extension/
cp lantern_extras.control /usr/share/postgresql/14/extension/
cp lantern_extras.so /usr/lib/postgresql/14/lib/
cp lantern-cli /var/lib/postgresql/
chown postgres:postgres /var/lib/postgresql/lantern-cli
   
cd $TEMP_DIR
git clone --depth 1 -b v1.1.2 https://github.com/hydradatabase/hydra
cd $TEMP_DIR/hydra/columnar
./configure
USE_PGXS=1 make install
  
cd $TEMP_DIR
mkdir -p /usr/local/onnxruntime
tar vzxf onnxruntime-linux-x64-1.15.1.tgz -C /usr/local/onnxruntime --strip-components=1
echo "/usr/local/onnxruntime/lib" > /etc/ld.so.conf.d/onnxruntime.conf
ldconfig

cd $TEMP_DIR
git clone --depth 1 https://github.com/kibae/onnxruntime-server
cd $TEMP_DIR/onnxruntime-server
cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
cmake --build build --parallel 4
cmake --install build --prefix /usr/local/onnxruntime-server

cd $TEMP_DIR
git clone --depth 1 -b v1.15.1 https://github.com/microsoft/onnxruntime
cp /tmp/onnxruntime/include/onnxruntime/core/session/* /usr/local/onnxruntime/

cd $TEMP_DIR
git clone --depth 1 --recursive https://github.com/kibae/pg_onnx.git
cd $TEMP_DIR/pg_onnx
cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
cmake --build build --target pg_onnx --parallel 4 
cmake --install build/pg_onnx
  
cd $TEMP_DIR
# curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash
# apt-get install -y git-lfs
for ((i=1;i>=0;i=1))
do
  curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | bash
  if [ $? -eq 0 ]; then
    break 
  fi
done
  
for ((i=1;i>=0;i=1))
do
  apt-get install -y git-lfs
  if [ $? -eq 0 ]; then
    break 
  fi
done
  
cd $TEMP_DIR
GIT_LFS_SKIP_SMUDGE=1 git clone --depth 1 https://github.com/onnx/models
cd $TEMP_DIR/models
git lfs install

cd $TEMP_DIR
git clone --depth 1 https://github.com/fboulnois/pg_uuidv7
cd $TEMP_DIR/pg_uuidv7
USE_PGXS=1 make install

# apt-get install -y libcurl4-openssl-dev uuid-dev libpulse-dev 
#  cd $TEMP_DIR
# # git clone --depth 1 -b apache-arrow-12.0.1 https://github.com/apache/arrow.git
# git clone --depth 1 -b apache-arrow-14.0.2 https://github.com/apache/arrow.git 
# cd $TEMP_DIR/arrow/cpp  
# mkdir build-release  
# cd $TEMP_DIR/arrow/cpp/build-release  
# 
# # build选项: https://arrow.apache.org/docs/developers/cpp/building.html 
# for ((i=1;i>=0;i=1))
# do
#   # cmake -DARROW_DEPENDENCY_SOURCE=BUNDLED -DARROW_PARQUET=ON -DARROW_ORC=ON -DARROW_S3=ON -DARROW_WITH_LZ4=ON -DARROW_WITH_SNAPPY=ON -DARROW_WITH_ZLIB=ON -DARROW_WITH_ZSTD=ON -DPARQUET_REQUIRE_ENCRYPTION=ON  ..
#   cmake -DARROW_DEPENDENCY_SOURCE=BUNDLED -DARROW_PARQUET=ON .. 
#   if [ $? -eq 0 ]; then
#     break 
#   fi
# done
# 
# for ((i=1;i>=0;i=1))
# do
#   make -j4  
#   if [ $? -eq 0 ]; then
#     break 
#   fi
# done
# 
# make install  
# ldconfig 

# https://arrow.apache.org/install/
cd $TEMP_DIR
apt-get install -y libcurl4-openssl-dev uuid-dev libpulse-dev 
for ((i=1;i>=0;i=1))
do
  apt-get update
  if [ $? -eq 0 ]; then
    break 
  fi
done
apt-get install -y -V ca-certificates lsb-release 
for ((i=1;i>=0;i=1))
do
  wget -T 36000 -t 0 --waitretry=5 https://apache.jfrog.io/artifactory/arrow/$(lsb_release --id --short | tr 'A-Z' 'a-z')/apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
  if [ $? -eq 0 ]; then
    break 
  fi
done
apt-get install -y -V ./apache-arrow-apt-source-latest-$(lsb_release --codename --short).deb
for ((i=1;i>=0;i=1))
do
  apt-get update
  if [ $? -eq 0 ]; then
    break 
  fi
done
apt-get install -y -V libarrow-dev # For C++
apt-get install -y -V libarrow-glib-dev # For GLib (C)
apt-get install -y -V libarrow-dataset-dev # For Apache Arrow Dataset C++
apt-get install -y -V libarrow-dataset-glib-dev # For Apache Arrow Dataset GLib (C)
apt-get install -y -V libarrow-acero-dev # For Apache Arrow Acero
apt-get install -y -V libarrow-flight-dev # For Apache Arrow Flight C++
apt-get install -y -V libarrow-flight-glib-dev # For Apache Arrow Flight GLib (C)
apt-get install -y -V libarrow-flight-sql-dev # For Apache Arrow Flight SQL C++
apt-get install -y -V libarrow-flight-sql-glib-dev # For Apache Arrow Flight SQL GLib (C)
apt-get install -y -V libgandiva-dev # For Gandiva C++
apt-get install -y -V libgandiva-glib-dev # For Gandiva GLib (C)
apt-get install -y -V libparquet-dev # For Apache Parquet C++
apt-get install -y -V libparquet-glib-dev # For Apache Parquet GLib (C)

cd $TEMP_DIR
git clone --depth 1 https://github.com/adjust/parquet_fdw 
cd $TEMP_DIR/parquet_fdw
make install 
  
cd $TEMP_DIR  
git clone --depth 1 https://github.com/pgspider/sqlite_fdw
cd $TEMP_DIR/sqlite_fdw
USE_PGXS=1 make  
USE_PGXS=1 make install

cd $TEMP_DIR
cp pg_search--0.6.1.sql /usr/share/postgresql/14/extension/
cp pg_search.control /usr/share/postgresql/14/extension/
cp pg_search.so /usr/lib/postgresql/14/lib/

cd $TEMP_DIR
cp pg_analytics--0.6.1.sql /usr/share/postgresql/14/extension/
cp pg_analytics.control /usr/share/postgresql/14/extension/
cp pg_analytics.so /usr/lib/postgresql/14/lib/
  
cd $TEMP_DIR  
git clone --depth 1 -b 14.3 https://github.com/ossc-db/pg_statsinfo  
cd $TEMP_DIR/pg_statsinfo  
PG_LDFLAGS=-L/usr/lib/postgresql/14/lib make  
PG_LDFLAGS=-L/usr/lib/postgresql/14/lib make install  
  
cd /usr/lib/postgresql/14  
git clone --depth 1 -b 14.0 https://github.com/ossc-db/pg_stats_reporter

cd $TEMP_DIR/
git clone --depth 1 https://gitlab.com/pg_proctab/pg_proctab
cd $TEMP_DIR/pg_proctab
USE_PGXS=1 make install

apt-get install -y libelf-dev
cd $TEMP_DIR/
git clone --depth 1 https://gitlab.com/pg_top/pg_top
cd $TEMP_DIR/pg_top
cmake CMakeLists.txt
USE_PGXS=1 make install

cd $TEMP_DIR/
wget https://golang.org/dl/go1.17.linux-amd64.tar.gz
tar -zxvf go1.17.linux-amd64.tar.gz -C /usr/local/
export PATH=/usr/local/go/bin:${PATH}
echo "export PATH=/usr/local/go/bin:\$PATH" >>/root/.bashrc 
echo "export PATH=/usr/local/go/bin:\$PATH" >>/var/lib/postgresql/.bash_profile  
cd $TEMP_DIR/
git clone -b v0.9.2 --depth 1 https://github.com/lesovsky/pgcenter
cd $TEMP_DIR/pgcenter
make dep
make build
make install

# pgadmin4 apt 安装目前仅支持x86. arm需要源码安装
cd $TEMP_DIR/
curl -fsS https://www.pgadmin.org/static/packages_pgadmin_org.pub | gpg --dearmor -o /usr/share/keyrings/packages-pgadmin-org.gpg
sh -c 'echo "deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/$(lsb_release -cs) pgadmin4 main" > /etc/apt/sources.list.d/pgadmin4.list'
for ((i=1;i>=0;i=1))
do
  apt-get update
  if [ $? -eq 0 ]; then
    break 
  fi
done
  
for ((i=1;i>=0;i=1))
do
  apt-get install -y pgadmin4-web
  if [ $? -eq 0 ]; then
    break 
  fi
done

# apt-get install -y pgadmin4
# apt-get install -y pgadmin4-web
# docker内不支持systemctl, 需要修改 /usr/pgadmin4/bin/setup-web.sh systemctl 控制的apache2服务全部改成如下: 
#     /etc/init.d/apache2 start 
#     /etc/init.d/apache2 restart
# #COMMAND="systemctl restart ${APACHE}"
# /etc/init.d/apache2 restart
# #if ! systemctl enable ${APACHE}; then
# if ! /etc/init.d/apache2 start; then
# if ! systemctl start ${APACHE}; then
# if ! /etc/init.d/apache2 start; then
# 启动pgadmin4 web: 
#     /usr/pgadmin4/bin/setup-web.sh --yes 
# 在主机查看80端口映射, docker inspect pg 
# 在主机chrome中打开  127.0.0.1:port/pgadmin
# 注意pgadmin在docker容器中, 连接容器中的pg数据库地址是 127.0.0.1:1921 
# 拿泰森多边形练手: https://github.com/digoal/blog/blob/master/201904/20190421_01.md 

cd $TEMP_DIR
git clone --depth 1 https://github.com/petere/pguint
cd $TEMP_DIR/pguint
USE_PGXS=1 make install

cd $TEMP_DIR 
git clone --depth 1 -b v0.6.1 https://github.com/paradedb/paradedb
cd $TEMP_DIR/paradedb/pg_sparse
USE_PGXS=1 make install
chmod 644 ./sql/svector--0.6.1.sql
cp -n ./sql/svector--0.6.1.sql /usr/share/postgresql/14/extension/

cd $TEMP_DIR 
git clone --depth 1 https://github.com/bdrouvot/pg_subtrans_infos
cd $TEMP_DIR/pg_subtrans_infos
USE_PGXS=1 make install

cd $TEMP_DIR 
git clone --depth 1 https://github.com/bdrouvot/pg_subxact_counters
cd $TEMP_DIR/pg_subxact_counters/c
USE_PGXS=1 make install
  
cd $TEMP_DIR
cp pg_idkit--0.2.1.sql /usr/share/postgresql/14/extension/
cp pg_idkit.control /usr/share/postgresql/14/extension/
cp pg_idkit.so /usr/lib/postgresql/14/lib/
  
cd $TEMP_DIR    
apt-get install -y build-essential libproj-dev libjson-c-dev libgsl-dev libgeos-dev
git clone --depth 1 https://github.com/MobilityDB/MobilityDB    
cd $TEMP_DIR/MobilityDB    
mkdir build    
cd $TEMP_DIR/MobilityDB/build    
cmake ..    
make -j 4   
make install    
  
cd $TEMP_DIR    
cp pgdd--0.5.2.sql /usr/share/postgresql/14/extension/    
cp pgdd.control /usr/share/postgresql/14/extension/    
cp pgdd.so /usr/lib/postgresql/14/lib/

cd $TEMP_DIR
git clone --depth 1 https://github.com/PGer/pipelinedb_pg14.git
cd $TEMP_DIR/pipelinedb_pg14
apt-get install -y libczmq4 libczmq-dev
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/jaiminpan/pg_nanoid.git
cd $TEMP_DIR/pg_nanoid
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/andrielfn/pg-ulid.git
cd $TEMP_DIR/pg-ulid
USE_PGXS=1 make install
  
cd $TEMP_DIR 
git clone --depth 1 https://github.com/phillbaker/pg_migrate.git  
cd $TEMP_DIR/pg_migrate/  
USE_PGXS=1 make install  
  
cd $TEMP_DIR 
git clone --depth 1 https://github.com/df7cb/pg_filedump.git
cd $TEMP_DIR/pg_filedump/  
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/petere/pgpcre
cd $TEMP_DIR/pgpcre
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 https://github.com/omniti-labs/pg_jobmon
cd $TEMP_DIR/pg_jobmon
USE_PGXS=1 make install

# cd $TEMP_DIR
# git clone --depth 1 https://github.com/pgpartman/pg_partman
# cd $TEMP_DIR/pg_partman
# USE_PGXS=1 make install

# rustup版本必须和plrust需要的rust版本一致, 这里是1.72.0
su - postgres -c "export RUSTUP_DIST_SERVER=https://mirrors.ustc.edu.cn/rust-static ; export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup ; curl --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- --profile minimal --default-toolchain 1.72.0 --no-modify-path -y ; source /var/lib/postgresql/.cargo/env ; rustup component add rustc-dev"
echo "source /var/lib/postgresql/.cargo/env" >> /var/lib/postgresql/.bash_profile 
dpkg -i /tmp/plrust-trusted-1.2.7_1.72.0-debian-pg14-amd64.deb 

cd $TEMP_DIR
git clone --depth 1 https://gitee.com/seanguo_007/plpgsql_pg4ml.git
cd $TEMP_DIR/plpgsql_pg4ml
. $TEMP_DIR/plpgsql_pg4ml/gen_sql_files.sh
USE_PGXS=1 make install

cd $TEMP_DIR    
cp pgmq--1.1.1.sql /usr/share/postgresql/14/extension/    
cp pgmq.control /usr/share/postgresql/14/extension/    
cp pgmq.so /usr/lib/postgresql/14/lib/
    
cd $TEMP_DIR    
cp pg_later--0.0.14.sql /usr/share/postgresql/14/extension/    
cp pg_later.control /usr/share/postgresql/14/extension/    
cp pg_later.so /usr/lib/postgresql/14/lib/

cd $TEMP_DIR    
cp vectorize--0.15.0.sql /usr/share/postgresql/14/extension/    
cp vectorize.control /usr/share/postgresql/14/extension/    
cp vectorize.so /usr/lib/postgresql/14/lib/

cd $TEMP_DIR 
git clone --depth 1 -b v2.0 https://github.com/pgEdge/snowflake
cd $TEMP_DIR/snowflake
USE_PGXS=1 make install

cd $TEMP_DIR
git clone --depth 1 -b walminer_3.0_stable https://gitee.com/movead/XLogMiner
cd $TEMP_DIR/XLogMiner/walminer/
USE_PGXS=1 MAJORVERSION=14 make install

# https://github.com/pgspider/influxdb_fdw
# InfluxDB Foreign Data Wrapper for PostgreSQL.
cd /tmp
git clone --depth 1 https://github.com/pgspider/influxdb_fdw
cd /tmp/influxdb_fdw
go get github.com/influxdata/influxdb1-client/v2
git clone --depth 1 https://github.com/pgspider/influxdb-cxx
cd /tmp/influxdb_fdw/influxdb-cxx
cmake . -DINFLUXCXX_WITH_BOOST=OFF -DINFLUXCXX_TESTING=OFF
make install
cd /tmp/influxdb_fdw
make CC=gcc CXX=g++ USE_PGXS=1 with_llvm=no GO_CLIENT=1 CXX_CLIENT=1
make install CC=gcc CXX=g++ USE_PGXS=1 with_llvm=no GO_CLIENT=1 CXX_CLIENT=1

# https://github.com/HexaCluster/pg_dbms_metadata
# pg_dbms_metadata v1.0.0 - Oracle's DBMS_METADATA Compatibility for PostgreSQL DDL Extraction
cd /tmp
git clone --depth 1 https://github.com/HexaCluster/pg_dbms_metadata
cd /tmp/pg_dbms_metadata
make install USE_PGXS=1

# https://github.com/viggy28/pg_savior
# pg_savior is a PostgreSQL extension designed to prevent accidental data loss due to non-parameterized DELETE queries without a WHERE clause.
# before bugfix use digoal's fork
cd /tmp
git clone --depth 1 https://github.com/digoal/pg_savior
cd /tmp/pg_savior
make install USE_PGXS=1

# https://github.com/dimitri/pgcopydb
# https://pgcopydb.readthedocs.io/en/latest/
apt-get install -y libgc-dev  
cd /tmp
git clone --depth 1 https://github.com/dimitri/pgcopydb
cd /tmp/pgcopydb
make -s clean
make -s -j4 install

cd /tmp
git clone --depth 1 https://github.com/supabase/supa_audit  
cd /tmp/supa_audit
USE_PGXS=1 make install

## plv8/Makefile  
##        ifeq ($(UNAME_S),Linux)  
##                SHLIB_LINK += -lrt -std=c++17  
#cd /tmp  
## apt-get install -y libtinfo5 build-essential pkg-config  
#git clone --depth 1 -b v3.2.2 https://github.com/plv8/plv8  
#cd /tmp/plv8  
#export SHLIB_LINK = " -lrt -std=c++17 "  
#EXECUTION_TIMEOUT=1 USE_ICU=1 USE_PGXS=1 PG_CONFIG=$(which pg_config) make
#EXECUTION_TIMEOUT=1 USE_ICU=1 USE_PGXS=1 PG_CONFIG=$(which pg_config) make install 

# 安装HaloDB, 
groupadd -r -g 3000 halo  
useradd -r -u 3000 -g halo -m -d /home/halo -s /bin/bash halo  

cd /tmp
tar -zxvf halo_14.debian11.x86_64.tar.gz -C /home/halo/  
  
echo "#  add by digoal" >> /home/halo/.bashrc    
echo "alias rm='rm -i'" >> /home/halo/.bashrc    
echo "alias cp='cp -i'" >> /home/halo/.bashrc    
echo "alias ll='ls -larth'" >> /home/halo/.bashrc    
echo "alias mv='mv -i'" >> /home/halo/.bashrc    
echo "export HALO_HOME=/home/halo/product/dbms/14" >> /home/halo/.bashrc    
echo "export LD_LIBRARY_PATH=\$HALO_HOME/lib" >> /home/halo/.bashrc    
echo "export PGDATA=/home/halo/halodata" >> /home/halo/.bashrc    
echo "export PGHOST=\$PGDATA" >> /home/halo/.bashrc   
echo "export PGUSER=postgres" >> /home/halo/.bashrc   
echo "export PATH=\$HALO_HOME/bin:\$PATH" >> /home/halo/.bashrc    
echo "export PGPORT=1521" >> /home/halo/.bashrc    
  
# 初始化halodata 
su - halo -c "mkdir /home/halo/halodata" 
su - halo -c "chmod 700 /home/halo/halodata"  
su - halo -c "/home/halo/product/dbms/14/bin/initdb -D /home/halo/halodata -E UTF8 --lc-collate=C --lc-ctype=en_US.utf-8 -U postgres"
cd /home/halo/halodata
echo "host all all 0.0.0.0/0 scram-sha-256" >> ./pg_hba.conf
echo "host replication all 0.0.0.0/0 scram-sha-256" >> ./pg_hba.conf
echo "standard_parserengine_auxiliary = on" >> ./postgresql.auto.conf		
echo "database_compat_mode = 'oracle'" >> ./postgresql.auto.conf	
echo "oracle.use_datetime_as_date = true" >> ./postgresql.auto.conf	
echo "transform_null_equals = off" >> ./postgresql.auto.conf	
echo "listen_addresses = '0.0.0.0'" >> ./postgresql.auto.conf		  
echo "port = 1521" >> ./postgresql.auto.conf				  
echo "max_connections = 2000" >> ./postgresql.auto.conf			  
echo "unix_socket_directories = '.'" >> ./postgresql.auto.conf	  
echo "shared_buffers = 128MB" >> ./postgresql.auto.conf			  
echo "dynamic_shared_memory_type = posix" >> ./postgresql.auto.conf	  
echo "vacuum_cost_delay = 0" >> ./postgresql.auto.conf			  
echo "bgwriter_delay = 20ms" >> ./postgresql.auto.conf			  
echo "bgwriter_lru_maxpages = 500" >> ./postgresql.auto.conf		  
echo "bgwriter_lru_multiplier = 5.0" >> ./postgresql.auto.conf		  
echo "max_parallel_workers_per_gather = 0" >> ./postgresql.auto.conf	  
echo "synchronous_commit = off" >> ./postgresql.auto.conf		  
echo "wal_compression = on" >> ./postgresql.auto.conf		  
echo "wal_writer_delay = 10ms" >> ./postgresql.auto.conf		  
echo "max_wal_size = 1GB " >> ./postgresql.auto.conf  
echo "min_wal_size = 80MB " >> ./postgresql.auto.conf  
echo "random_page_cost = 1.1" >> ./postgresql.auto.conf			  
echo "log_destination = 'csvlog'" >> ./postgresql.auto.conf		  
echo "logging_collector = on" >> ./postgresql.auto.conf		  
echo "log_truncate_on_rotation = on" >> ./postgresql.auto.conf		  
echo "log_timezone = 'Etc/UTC' " >> ./postgresql.auto.conf  
echo "autovacuum = on" >> ./postgresql.auto.conf			  
echo "autovacuum_vacuum_cost_delay = 0ms" >> ./postgresql.auto.conf	  
echo "vacuum_freeze_table_age = 750000000 " >> ./postgresql.auto.conf  
echo "vacuum_multixact_freeze_table_age = 750000000 " >> ./postgresql.auto.conf  
echo "datestyle = 'iso, mdy' " >> ./postgresql.auto.conf  
echo "timezone = 'Etc/UTC' " >> ./postgresql.auto.conf  
echo "lc_messages = 'en_US.UTF-8'" >> ./postgresql.auto.conf			  
echo "lc_monetary = 'en_US.UTF-8'" >> ./postgresql.auto.conf			  
echo "lc_numeric = 'en_US.UTF-8'" >> ./postgresql.auto.conf			  
echo "lc_time = 'en_US.UTF-8'" >> ./postgresql.auto.conf				  
echo "default_text_search_config = 'pg_catalog.english'" >> ./postgresql.auto.conf 

# 启动halodb, 创建Oracle兼容性
# su - halo
# pg_ctl start
# psql -c "create extension aux_oracle cascade;"

# databend [在宇宙最强数据库镜像中部署databend](../202402/20240201_03.md)  
groupadd -r -g 3001 databend    
useradd -r -u 3001 -g databend -m -d /home/databend -s /bin/bash databend   
  
mkdir -p /var/log/databend  
mkdir -p /var/lib/databend/raft  
  
chown -R databend:databend /var/log/databend  
chown -R databend:databend /var/lib/databend  
  
# su - databend -c "curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 --proto '=https' --tlsv1.2 -sSf -L https://sh.rustup.rs | sh -s -- -y"    
# su - databend -c "source /home/databend/.cargo/env"   
  
# echo "[source.crates-io]" >> /home/databend/.cargo/config  
# echo "replace-with = 'ustc'" >> /home/databend/.cargo/config            
# echo "    "  >> /home/databend/.cargo/config  
# echo "[source.ustc]"  >> /home/databend/.cargo/config            
# echo "registry = \"sparse+https://mirrors.ustc.edu.cn/crates.io-index/\"" >> /home/databend/.cargo/config  
  
echo "#  add by digoal" >> /home/databend/.bashrc      
echo "alias rm='rm -i'" >> /home/databend/.bashrc      
echo "alias cp='cp -i'" >> /home/databend/.bashrc      
echo "alias ll='ls -larth'" >> /home/databend/.bashrc      
echo "alias mv='mv -i'" >> /home/databend/.bashrc      

# echo ". /home/databend/.cargo/env" >> /home/databend/.bashrc    
 
cd /tmp   
# tar -zxvf databend-v1.2.307-x86_64-unknown-linux-gnu.tar.gz -C /home/databend/    
mkdir -p /home/databend/databend_software    
tar -zxvf databend-x86_64.tar.gz -C /home/databend/databend_software
tar -zxvf bendsql-x86_64-unknown-linux-gnu.tar.gz -C /usr/local/bin/ 
  
cd /home/databend/databend_software   
echo "  " >> ./configs/databend-query.toml  
echo "[[query.users]]" >> ./configs/databend-query.toml  
echo "name = \"root\"" >> ./configs/databend-query.toml  
echo "auth_type = \"no_password\"" >> ./configs/databend-query.toml  
  
chown -R databend:databend /home/databend/databend_software  

cd /tmp

# su - databend -c "cargo install bendsql"  
  
# 启动databend
# su - databend
# cd /home/databend/databend_software
# ./scripts/start.sh
# 连接databend
# su - databend
# bendsql
# 停止databend
# su - databend
# cd /home/databend/databend_software
# ./scripts/stop.sh

cd /tmp
git clone --depth 1 https://github.com/okbob/pgmeminfo
cd /tmp/pgmeminfo
USE_PGXS=1 make install

cd /tmp
git clone --depth 1 https://github.com/lzlabs/pg_statement_rollback
cd /tmp/pg_statement_rollback
USE_PGXS=1 make install

cd /tmp  
git clone --depth 1 https://github.com/lzlabs/pg_dumpbinary  
cd /tmp/pg_dumpbinary  
perl Makefile.PL  
make  
make install

# PERL_MM_USE_DEFAULT=1 perl -MCPAN -e 'CPAN::HandleConfig->edit("pushy_https", 0); CPAN::HandleConfig->edit("urllist", "unshift", "https://developer.aliyun.com/mirror/CPAN/"); mkmyconfig'
# for ((i=1;i>=0;i=1)) 
# do
#   # cpan加速:  https://developer.aliyun.com/mirror/CPAN/
#   echo "yes"|cpan -i IPC::Run 
#   if [ $? -eq 0 ]; then
#     break 
#   fi
# done
useradd -r -b /home/polardb -m -d /home/polardb -s /bin/bash polardb
apt-get install -y libldap2-dev libxerces-c-dev gettext tcl tcl-dev libperl-dev 
rm -f /usr/bin/python 
ln -s /usr/bin/python3 /usr/bin/python 
cd /tmp
git clone -b POLARDB_11_STABLE --depth 1 https://github.com/ApsaraDB/PolarDB-for-PostgreSQL
cd PolarDB-for-PostgreSQL
# LLVM_CONFIG=/usr/bin/llvm-config-13 ./polardb_build.sh --withpx --noinit --basedir=/home/polardb/polardb_11_home
LLVM_CONFIG=/usr/bin/llvm-config-13 ./polardb_build.sh --withpx --noinit --basedir=/home/polardb/polardb_11_home --user=polardb --debug=off --with-tde 

echo "#  add by digoal " >> /home/polardb/.bashrc
echo "alias rm='rm -i' " >> /home/polardb/.bashrc
echo "alias cp='cp -i' " >> /home/polardb/.bashrc
echo "alias ll='ls -larth' " >> /home/polardb/.bashrc
echo "alias mv='mv -i' " >> /home/polardb/.bashrc
echo "export PGHOME=/home/polardb/polardb_11_home " >> /home/polardb/.bashrc
echo "export PATH=\$PGHOME/bin:\$PATH " >> /home/polardb/.bashrc
echo "export LD_LIBRARY_PATH=\$PGHOME/lib:/usr/local/lib:/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH " >> /home/polardb/.bashrc
echo "export PGDATA=/home/polardb/primary " >> /home/polardb/.bashrc
echo "export PGUSER=polardb " >> /home/polardb/.bashrc
echo "export PGHOST=127.0.0.1 " >> /home/polardb/.bashrc
echo "export PGPORT=5432 " >> /home/polardb/.bashrc
echo "export PGDATABASE=postgres " >> /home/polardb/.bashrc
echo "export LC_ALL=en_US.UTF-8 " >> /home/polardb/.bashrc

su - polardb -c " /home/polardb/polardb_11_home/bin/initdb -D /home/polardb/primary "
# /home/polardb/polardb_11_home/bin/pg_ctl -D /home/polardb/primary -l logfile start 
# /home/polardb/polardb_11_home/bin/psql -h 127.0.0.1 -p 5432 -U polardb postgres

echo "listen_addresses = '0.0.0.0' " >> /home/polardb/primary/postgresql.auto.conf
echo "unix_socket_directories = '., /tmp' " >> /home/polardb/primary/postgresql.auto.conf
echo "random_page_cost = 1.1 " >> /home/polardb/primary/postgresql.auto.conf
echo "log_destination = 'csvlog' " >> /home/polardb/primary/postgresql.auto.conf
echo "logging_collector = on " >> /home/polardb/primary/postgresql.auto.conf
echo "polar_enable_physical_repl_non_super_wal_snd = on " >> /home/polardb/primary/postgresql.auto.conf
echo "polar_wal_snd_reserved_for_superuser = 3 " >> /home/polardb/primary/postgresql.auto.conf
echo "polar_logindex_mem_size = 0 " >> /home/polardb/primary/postgresql.auto.conf
echo "hot_standby = on " >> /home/polardb/primary/postgresql.auto.conf
echo "wal_receiver_timeout = 15s " >> /home/polardb/primary/postgresql.auto.conf
echo "wal_retrieve_retry_interval = 5s " >> /home/polardb/primary/postgresql.auto.conf
echo "port = 5432 " >> /home/polardb/primary/postgresql.auto.conf
echo "polar_hostid = 1 " >> /home/polardb/primary/postgresql.auto.conf

echo "primary_conninfo = 'host=localhost port=5432 user=polardb dbname=postgres application_name=standby1' " >> /home/polardb/primary/recovery.done
echo "# primary_slot_name = 'standby1' " >> /home/polardb/primary/recovery.done
echo "standby_mode = on " >> /home/polardb/primary/recovery.done
echo "recovery_target_timeline = 'latest' " >> /home/polardb/primary/recovery.done

echo "host all all 0.0.0.0/0 md5 " >> /home/polardb/primary/pg_hba.conf
echo "host    replication     all 0.0.0.0/0 md5 " >> /home/polardb/primary/pg_hba.conf

cd /tmp
git clone --depth 1 https://github.com/tvondra/sequential-uuids
cd /tmp/sequential-uuids
USE_PGXS=1 make install

cd /tmp
git clone --depth 1 https://github.com/enova/pgl_ddl_deploy
cd /tmp/pgl_ddl_deploy
USE_PGXS=1 make install

cd /tmp
git clone --depth 1 https://github.com/enterprisedb/system_stats
cd /tmp/system_stats
USE_PGXS=1 make install

# install ivorysql 
apt-get install -y libxml2-utils libossp-uuid-dev
# PERL_MM_USE_DEFAULT=1 perl -MCPAN -e 'CPAN::HandleConfig->edit("pushy_https", 0); CPAN::HandleConfig->edit("urllist", "unshift", "https://developer.aliyun.com/mirror/CPAN/"); mkmyconfig'
# for ((i=1;i>=0;i=1)) 
# do
#   # cpan加速:  https://developer.aliyun.com/mirror/CPAN/
#   echo "yes"|cpan -i IPC::Run 
#   if [ $? -eq 0 ]; then
#     break 
#   fi
# done
useradd -r -b /home/ivorysql -m -d /home/ivorysql -s /bin/bash ivorysql
cd /tmp
git clone --depth 1 -b IvorySQL_3.2 https://github.com/IvorySQL/IvorySQL
cd IvorySQL
# LLVM_CONFIG=/usr/bin/llvm-config-13 CC=clang-13 CXX=clang++-13 CPP=clang-cpp-13 ./configure --prefix=/home/ivorysql/ivorysql --with-llvm --with-openssl --with-lz4 --with-zstd --with-ossp-uuid --with-libxml --with-libxslt --with-libedit-preferred --with-ldap --with-python --enable-tap-tests --with-pgport=5281 --with-oraport=1621
# LLVM_CONFIG=/usr/bin/llvm-config-13 CC=clang-13 CXX=clang++-13 CPP=clang-cpp-13 ./configure --prefix=/home/ivorysql/ivorysql --with-llvm --with-openssl --with-lz4 --with-zstd --with-ossp-uuid --with-libxml --with-libxslt --with-libedit-preferred --with-ldap --with-python --with-pgport=5281 --with-oraport=1621
make -j4 
make install
cd contrib
make install

echo "#  add by digoal " >> /home/ivorysql/.bashrc
echo "alias rm='rm -i' " >> /home/ivorysql/.bashrc
echo "alias cp='cp -i' " >> /home/ivorysql/.bashrc
echo "alias ll='ls -larth' " >> /home/ivorysql/.bashrc
echo "alias mv='mv -i' " >> /home/ivorysql/.bashrc
echo "export PGHOME=/home/ivorysql/ivorysql " >> /home/ivorysql/.bashrc
echo "export PATH=\$PGHOME/bin:\$PATH " >> /home/ivorysql/.bashrc
echo "export LD_LIBRARY_PATH=\$PGHOME/lib:/usr/local/lib:/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH " >> /home/ivorysql/.bashrc
echo "export PGDATA=/home/ivorysql/primary " >> /home/ivorysql/.bashrc
echo "export PGUSER=ivorysql " >> /home/ivorysql/.bashrc
echo "export PGHOST=127.0.0.1 " >> /home/ivorysql/.bashrc
echo "export PGPORT=5281 " >> /home/ivorysql/.bashrc
echo "export PGDATABASE=postgres " >> /home/ivorysql/.bashrc
echo "export LC_ALL=en_US.UTF-8 " >> /home/ivorysql/.bashrc

su - ivorysql -c " /home/ivorysql/ivorysql/bin/initdb -D /home/ivorysql/primary -U ivorysql -E UTF8 --locale-provider=icu --icu-locale=en_US --lc-collate=C --lc-ctype=en_US.UTF8 "
# /home/ivorysql/ivorysql/bin/pg_ctl -D /home/ivorysql/primary -l logfile start 
# /home/ivorysql/ivorysql/bin/psql -h 127.0.0.1 -p 5281 -U ivorysql postgres

echo "listen_addresses = '0.0.0.0' " >> /home/ivorysql/primary/postgresql.auto.conf
echo "unix_socket_directories = '., /tmp' " >> /home/ivorysql/primary/postgresql.auto.conf
echo "random_page_cost = 1.1 " >> /home/ivorysql/primary/postgresql.auto.conf
echo "log_destination = 'csvlog' " >> /home/ivorysql/primary/postgresql.auto.conf
echo "logging_collector = on " >> /home/ivorysql/primary/postgresql.auto.conf
echo "hot_standby = on " >> /home/ivorysql/primary/postgresql.auto.conf
echo "wal_receiver_timeout = 15s " >> /home/ivorysql/primary/postgresql.auto.conf
echo "wal_retrieve_retry_interval = 5s " >> /home/ivorysql/primary/postgresql.auto.conf
echo "port = 5281 " >> /home/ivorysql/primary/postgresql.auto.conf
echo "primary_conninfo = 'host=localhost port=5281 user=ivorysql dbname=postgres application_name=standby1' " >> /home/ivorysql/primary/postgresql.auto.conf
echo "# primary_slot_name = 'standby1' " >> /home/ivorysql/primary/postgresql.auto.conf
echo "recovery_target_timeline = 'latest' " >> /home/ivorysql/primary/postgresql.auto.conf

echo "host all all 0.0.0.0/0 scram-sha-256 " >> /home/ivorysql/primary/pg_hba.conf
echo "host    replication     all 0.0.0.0/0 scram-sha-256 " >> /home/ivorysql/primary/pg_hba.conf

cd /tmp
git clone --depth 1 https://github.com/pjungwir/aggs_for_arrays
cd aggs_for_arrays
USE_PGXS=1 make install

pgxn install dsef

cd /tmp
git clone --depth 1 https://github.com/dverite/permuteseq
cd /tmp/permuteseq
USE_PGXS=1 make install

cd /tmp
git clone --depth 1 https://github.com/digoal/gp_tpch
git clone --depth 1 https://github.com/electrum/tpch-dbgen

cd /tmp
git clone --depth 1 https://github.com/bdrouvot/pg_orphaned
cd pg_orphaned
USE_PGXS=1 make install

cd /usr/lib/postgresql/14  
git clone --depth 1 https://github.com/swida/sqlbench  
cd /usr/lib/postgresql/14/sqlbench  
autoreconf -if  
./configure --with-postgresql="$PGHOME"  
C_INCLUDE_PATH=/usr/include/postgresql make  
C_INCLUDE_PATH=/usr/include/postgresql make install  
  
apt-get install -y libpcap-dev libnl-genl-3-dev  
cd /tmp  
git clone --depth 1 -b 8.4.0-stable https://github.com/ntop/PF_RING  
cd /tmp/PF_RING/userland/lib  
./configure && make  
make install  
cd /tmp  
git clone --depth 1 -b v5.0-4 https://github.com/heterodb/pg-strom  
cd /tmp/pg-strom/arrow-tools  
PG_CONFIG=/usr/lib/postgresql/14/bin/pg_config C_INCLUDE_PATH=/tmp/PF_RING/kernel make  
PG_CONFIG=/usr/lib/postgresql/14/bin/pg_config C_INCLUDE_PATH=/tmp/PF_RING/kernel make install  
  
cd /usr/lib/postgresql/14  
git clone --depth 1 -b rel/v2.1.0 https://github.com/apache/madlib  
cd /usr/lib/postgresql/14/madlib  
mkdir build  
cd /usr/lib/postgresql/14/madlib/build  
cmake ..  
make -j 4  
# $BUILD_ROOT/src/bin/madpack -s madlib -p postgres -c [user[/password]@][host][:port][/database] install

# cd /tmp
# git clone --depth 1 -b apache-arrow-12.0.0 https://github.com/apache/arrow.git  
# cd /tmp/arrow/cpp  
# mkdir build-release  
# cd /tmp/arrow/cpp/build-release  
# cmake -DARROW_DEPENDENCY_SOURCE=BUNDLED ..  
# make -j4  
# make install  
# 
# cd /tmp
# apt-get install -y libcurl4-openssl-dev uuid-dev libpulse-dev  
# git clone --depth 1 -b 1.11.91 https://github.com/aws/aws-sdk-cpp  
# cd /tmp/aws-sdk-cpp  
# git submodule update --init --recursive --depth 1  
# mkdir build  
# cd /tmp/aws-sdk-cpp/build  
# cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_ONLY="s3;core"  
# make -j4  
# make install  
# 
# cd /tmp
# git clone --depth 1 -b v1.1.0 https://github.com/pgspider/parquet_s3_fdw  
# cd /tmp/parquet_s3_fdw  
# PG_CPPFLAGS="-Wno-register -D_GLIBCXX_USE_CXX11_ABI=0" USE_PGXS=1 make  
# PG_CPPFLAGS="-std=c++17 -Wno-register -D_GLIBCXX_USE_CXX11_ABI=0" USE_PGXS=1 make  
# PG_CPPFLAGS="-std=c++17 -Wno-register -D_GLIBCXX_USE_CXX11_ABI=0" USE_PGXS=1 make install  
# echo "/usr/local/lib" >>/etc/ld.so.conf  
# ldconfig 
```  
  
```  
vi 4.sh  
```  
  
```  
#!/bin/bash  
set -vx  
  
echo "* soft    nofile  1024000" >> /etc/security/limits.conf  
echo "* hard    nofile  1024000" >> /etc/security/limits.conf  
echo "* soft    nproc   unlimited" >> /etc/security/limits.conf  
echo "* hard    nproc   unlimited" >> /etc/security/limits.conf  
echo "* soft    core    unlimited" >> /etc/security/limits.conf  
echo "* hard    core    unlimited" >> /etc/security/limits.conf  
echo "* soft    memlock unlimited" >> /etc/security/limits.conf  
echo "* hard    memlock unlimited" >> /etc/security/limits.conf  

echo "vm.swappiness = 0" >> /etc/sysctl.d/99-sysctl.conf   
```  
  
```  
vi 5.sh  
```  
  
```  
#!/bin/bash  
set -vx  
  
export PG_HOME=/var/lib/postgresql  
. $PG_HOME/.bash_profile  
initdb -D $PGDATA -U postgres -E UTF8 --lc-collate=C --lc-ctype=en_US.UTF8  
  
cd $PGDATA  
echo "host all all 0.0.0.0/0 scram-sha-256" >> ./pg_hba.conf
echo "host replication all 0.0.0.0/0 scram-sha-256" >> ./pg_hba.conf
  
echo "listen_addresses = '0.0.0.0'" >> ./postgresql.auto.conf		  
echo "port = 1921" >> ./postgresql.auto.conf				  
echo "max_connections = 2000" >> ./postgresql.auto.conf			  
echo "unix_socket_directories = '., /var/run/postgresql'" >> ./postgresql.auto.conf	  
echo "shared_buffers = 128MB" >> ./postgresql.auto.conf			  
echo "dynamic_shared_memory_type = posix" >> ./postgresql.auto.conf	  
echo "vacuum_cost_delay = 0" >> ./postgresql.auto.conf			  
echo "bgwriter_delay = 20ms" >> ./postgresql.auto.conf			  
echo "bgwriter_lru_maxpages = 500" >> ./postgresql.auto.conf		  
echo "bgwriter_lru_multiplier = 5.0" >> ./postgresql.auto.conf		  
echo "max_parallel_workers_per_gather = 0" >> ./postgresql.auto.conf	  
echo "synchronous_commit = off" >> ./postgresql.auto.conf		  
echo "wal_compression = on" >> ./postgresql.auto.conf		  
echo "wal_writer_delay = 10ms" >> ./postgresql.auto.conf		  
echo "max_wal_size = 1GB " >> ./postgresql.auto.conf  
echo "min_wal_size = 80MB " >> ./postgresql.auto.conf  
echo "random_page_cost = 1.1" >> ./postgresql.auto.conf			  
echo "log_destination = 'csvlog'" >> ./postgresql.auto.conf		  
echo "logging_collector = on" >> ./postgresql.auto.conf		  
echo "log_truncate_on_rotation = on" >> ./postgresql.auto.conf		  
echo "log_timezone = 'Etc/UTC' " >> ./postgresql.auto.conf  
echo "autovacuum = on" >> ./postgresql.auto.conf			  
echo "autovacuum_vacuum_cost_delay = 0ms" >> ./postgresql.auto.conf	  
echo "vacuum_freeze_table_age = 750000000 " >> ./postgresql.auto.conf  
echo "vacuum_multixact_freeze_table_age = 750000000 " >> ./postgresql.auto.conf  
echo "datestyle = 'iso, mdy' " >> ./postgresql.auto.conf  
echo "timezone = 'Etc/UTC' " >> ./postgresql.auto.conf  
echo "lc_messages = 'en_US.UTF-8'" >> ./postgresql.auto.conf			  
echo "lc_monetary = 'en_US.UTF-8'" >> ./postgresql.auto.conf			  
echo "lc_numeric = 'en_US.UTF-8'" >> ./postgresql.auto.conf			  
echo "lc_time = 'en_US.UTF-8'" >> ./postgresql.auto.conf				  
echo "default_text_search_config = 'pg_catalog.english'" >> ./postgresql.auto.conf  
```  
  
```
vi 6.sh
```
  
```
#!/bin/bash  
set -vx  
  
# neon ......  用法: 202403/20240319_01.md   
apt-get install -y build-essential libtool libreadline-dev zlib1g-dev flex bison libseccomp-dev libssl-dev clang pkg-config libpq-dev cmake postgresql-client protobuf-compiler libcurl4-openssl-dev openssl lsof libicu-dev libseccomp-dev   
  
cd /tmp  
mkdir protoc  
mv protoc-26.0-linux-x86_64.zip /tmp/protoc  
cd /tmp/protoc  
unzip protoc-26.0-linux-x86_64.zip  
unalias cp  
cp -f /tmp/protoc/bin/protoc /usr/local/bin/protoc  
cd /tmp/protoc/include  
cp -f -r google /usr/local/include/  
  
pip3 install poetry   
  
useradd -r -b /home/neon -m -d /home/neon -s /bin/bash neon   
 
echo "#  add by digoal " >>/home/neon/.bashrc  
echo "alias rm='rm -i' " >>/home/neon/.bashrc  
echo "alias cp='cp -i' " >>/home/neon/.bashrc  
echo "alias ll='ls -larth' " >>/home/neon/.bashrc  
echo "alias mv='mv -i' " >>/home/neon/.bashrc  
echo "export PGHOME=/usr/lib/postgresql/14 " >>/home/neon/.bashrc  
echo "export PATH=\$PGHOME/bin:\$PATH " >>/home/neon/.bashrc  
echo "export LD_LIBRARY_PATH=\$PGHOME/lib:/usr/local/lib:/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH " >>/home/neon/.bashrc  
echo "export PGUSER=neon " >>/home/neon/.bashrc  
echo "export PGHOST=127.0.0.1 " >>/home/neon/.bashrc  
echo "export PGPORT=55432 " >>/home/neon/.bashrc  
echo "export PGDATABASE=postgres " >>/home/neon/.bashrc  
echo "export LC_ALL=en_US.UTF-8 " >>/home/neon/.bashrc  
echo "export PATH=/tmp/cmake-3.27.9/bin:\$PATH " >>/home/neon/.bashrc  
echo "export MANPATH=/tmp/cmake-3.27.9/man:\$MANPATH " >>/home/neon/.bashrc  
echo "export PATH=/usr/local/go/bin:/home/neon/.cargo/bin:\$PATH " >>/home/neon/.bashrc  
echo "export LD_LIBRARY_PATH=\$PGHOME/lib/oracle:\$LD_LIBRARY_PATH " >>/home/neon/.bashrc  
echo ". /home/neon/.cargo/env  " >>/home/neon/.bashrc  
echo "export RUSTUP_DIST_SERVER=https://mirrors.ustc.edu.cn/rust-static   " >>/home/neon/.bashrc  
echo "export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup   " >>/home/neon/.bashrc  
echo "export PATH=/home/neon/neon/target/debug:\$PATH " >>/home/neon/.bashrc  
echo "# export PATH=/home/neon/neon/pg_install/v14/bin:\$PATH " >>/home/neon/.bashrc  
echo "# export PATH=/home/neon/neon/pg_install/v15/bin:\$PATH " >>/home/neon/.bashrc  
echo "export PATH=/home/neon/neon/pg_install/v16/bin:\$PATH " >>/home/neon/.bashrc  
```
  
```
vi 7.sh
```
  
```
#!/bin/bash  
set -vx  
  
curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 --proto '=https' --tlsv1.2 -sSf -L https://sh.rustup.rs -o rustup-init.sh  
chmod +x rustup-init.sh  
./rustup-init.sh -y  
  
source $HOME/.cargo/env  
. /home/neon/.bashrc  
  
cd /home/neon      
git clone --depth 1 -b release-5090 https://github.com/neondatabase/neon.git  
cd /home/neon/neon/vendor  
git clone --depth 1 -b REL_16_STABLE_neon https://github.com/neondatabase/postgres.git postgres-v16  
git clone --depth 1 -b REL_15_STABLE_neon https://github.com/neondatabase/postgres.git postgres-v15  
git clone --depth 1 -b REL_14_STABLE_neon https://github.com/neondatabase/postgres.git postgres-v14  
cd /home/neon/neon  
make -j`nproc` -s  
```
  
  
  
4、准备Dockerfile  
  
```  
cd ~/pg14  
  
vi Dockerfile  
```  
  
```  
FROM --platform=$TARGETPLATFORM debian:11.9  
MAINTAINER digoal zhou "dege.zzz@alibaba-inc.com"  
ARG TARGETPLATFORM  
ARG BUILDPLATFORM  
RUN echo "I am running on $BUILDPLATFORM, building for $TARGETPLATFORM"  
ENV DEBIAN_FRONTEND=noninteractive TEMP_DIR=/tmp ROOT_HOME=/root PG_HOME=/var/lib/postgresql PG_DATA=/var/lib/postgresql/14/pgdata PGHOME=/usr/lib/postgresql/14  
STOPSIGNAL SIGINT  
COPY --chmod=555 1.sh 2.sh 3.sh 4.sh 5.sh 6.sh 7.sh $TEMP_DIR/  
COPY GraphBLAS-3.1.1.tar.gz libduckdb-linux-amd64.zip duckdb_cli-linux-amd64.zip cmake-3.27.4.tar.gz mongo-c-driver-1.17.3.tar.gz json-c-0.15-20200726.tar.gz pg_tiktoken--0.0.1.sql pg_tiktoken.control pg_tiktoken.so lantern_extras--0.1.5.sql lantern_extras.control lantern_extras.so lantern-cli onnxruntime-linux-x64-1.15.1.tgz node-v14.21.3.tar.gz pg_search.control pg_search.so pg_search--0.6.1.sql pg_task.so pg_task.index.bc pg_task.control pg_task--1.0.sql pg_idkit--0.2.1.sql pg_idkit.control pg_idkit.so pgdd--0.5.2.sql pgdd.control pgdd.so pghero_3.4.0-1701207987.0382b812.bullseye_amd64.deb plrust-trusted-1.2.7_1.72.0-debian-pg14-amd64.deb pgroll pgmq.control pgmq--1.1.1.sql pgmq.so pg_later.control pg_later.so pg_later--0.0.14.sql vectorize.control vectorize.so vectorize--0.15.0.sql cmake-3.27.9-linux-x86_64.tar.gz libduckdb-src.zip datasketches-1.7.0.zip halo_14.debian11.x86_64.tar.gz proxysql_2.5.5-debian11_amd64.deb pg_analytics.so pg_analytics.control pg_analytics--0.6.1.sql databend-x86_64.tar.gz bendsql-x86_64-unknown-linux-gnu.tar.gz protoc-26.0-linux-x86_64.zip $TEMP_DIR/
RUN mkdir /tmp/pg_task 
COPY pg_task /tmp/pg_task 
  
RUN $TEMP_DIR/1.sh  
RUN $TEMP_DIR/2.sh  
RUN $TEMP_DIR/3.sh  
  
# WORKDIR $TEMP_DIR  
# RUN apt install -y libtinfo5 build-essential ninja-build python3  
# RUN git clone --depth 1 -b v3.1.7 https://github.com/plv8/plv8  
# WORKDIR $TEMP_DIR/plv8  
# RUN USE_ICU=1 USE_PGXS=1 make  
# RUN USE_ICU=1 USE_PGXS=1 make install  
#  
# WORKDIR $TEMP_DIR  
# RUN git clone --depth 1 -b apache-arrow-12.0.1 https://github.com/apache/arrow.git  
# WORKDIR $TEMP_DIR/arrow/cpp  
# RUN mkdir build-release  
# WORKDIR $TEMP_DIR/arrow/cpp/build-release  
# RUN cmake -DARROW_DEPENDENCY_SOURCE=BUNDLED ..  
# RUN make -j4  
# RUN make install  
#  
# WORKDIR $TEMP_DIR  
# RUN apt install -y libcurl4-openssl-dev uuid-dev libpulse-dev  
# RUN git clone --depth 1 -b 1.9.263 https://github.com/aws/aws-sdk-cpp  
# WORKDIR $TEMP_DIR/aws-sdk-cpp  
# RUN git submodule update --init --recursive --depth 1  
# RUN mkdir build  
# WORKDIR $TEMP_DIR/aws-sdk-cpp/build  
# RUN cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_ONLY="s3;core"  
# RUN make -j4  
# RUN make install  
#  
# WORKDIR $TEMP_DIR  
# RUN git clone --depth 1 -b v1.0.0 https://github.com/pgspider/parquet_s3_fdw  
# WORKDIR $TEMP_DIR/parquet_s3_fdw  
# RUN PG_CPPFLAGS="-Wno-register -D_GLIBCXX_USE_CXX11_ABI=0" USE_PGXS=1 make  
# RUN PG_CPPFLAGS="-std=c++17 -Wno-register -D_GLIBCXX_USE_CXX11_ABI=0" USE_PGXS=1 make  
# RUN PG_CPPFLAGS="-std=c++17 -Wno-register -D_GLIBCXX_USE_CXX11_ABI=0" USE_PGXS=1 make install  
# RUN echo "/usr/local/lib" >>/etc/ld.so.conf  
# RUN ldconfig  
  
  
ENV ORACLE_BASE /usr/lib/postgresql/14/lib  
WORKDIR $ORACLE_BASE  
COPY instantclient_12_2/libclntsh.so.12.1 .  
RUN ln -s libclntsh.so.12.1 libclntsh.so  
RUN mkdir -p oracle/network/admin  
COPY instantclient_12_2 ./oracle  
RUN echo "export LD_LIBRARY_PATH=\$PGHOME/lib/oracle:\$LD_LIBRARY_PATH" >>$PG_HOME/.bash_profile  
RUN echo "export ORACLE_HOME=\$PGHOME/lib/oracle" >>$PG_HOME/.bash_profile  
RUN echo "export TNS_ADMIN=\$ORACLE_HOME/network/admin/" >>$PG_HOME/.bash_profile  
RUN echo "export LD_LIBRARY_PATH=\$PGHOME/lib/oracle:\$LD_LIBRARY_PATH" >>$ROOT_HOME/.bashrc  
RUN echo "export ORACLE_HOME=\$PGHOME/lib/oracle" >>$ROOT_HOME/.bashrc  
RUN echo "export TNS_ADMIN=\$ORACLE_HOME/network/admin/" >>$ROOT_HOME/.bashrc  
RUN . $ROOT_HOME/.bashrc  
  
RUN echo "/usr/lib/postgresql/14/lib/oracle" >> /etc/ld.so.conf  
RUN echo "/usr/local/lib" >> /etc/ld.so.conf  
RUN echo "/usr/lib/postgresql/14/lib" >> /etc/ld.so.conf  
RUN ldconfig  
  
WORKDIR $TEMP_DIR  
# RUN apt install -y libsqlite3-dev  
RUN git clone --depth 1 https://github.com/ossc-db/dblink_plus  
WORKDIR $TEMP_DIR/dblink_plus  
RUN cp -r /usr/lib/postgresql/14/lib/oracle/sdk/include/* ./  
RUN PG_CFLAGS=-I/usr/lib/postgresql/14/lib/oracle/sdk/include PG_LDFLAGS=-L/usr/lib/postgresql/14/lib/oracle USE_PGXS=1 make  
RUN PG_CFLAGS=-I/usr/lib/postgresql/14/lib/oracle/sdk/include PG_LDFLAGS=-L/usr/lib/postgresql/14/lib/oracle USE_PGXS=1 make install  
  
# RUN rm -rf $TEMP_DIR/*  
  
RUN $TEMP_DIR/4.sh

# 安装neondatabase
# RUN $TEMP_DIR/6.sh
# RUN cp /tmp/7.sh /home/neon/ 
# 
# USER neon
# WORKDIR /home/neon
# RUN /home/neon/7.sh 

WORKDIR /tmp 
USER postgres  
RUN $TEMP_DIR/5.sh
  
WORKDIR $PG_HOME  
# RUN wget -T 36000 -t 0 --waitretry=5 https://github.com/duckdb/duckdb/releases/download/v0.9.2/duckdb_cli-linux-amd64.zip  
# RUN curl -Z --connect-timeout 120 -m 36000 --retry 12000 --retry-delay 5 --retry-max-time 1200 -L https://github.com/duckdb/duckdb/releases/download/v0.9.2/duckdb_cli-linux-amd64.zip -o duckdb_cli-linux-amd64.zip  
RUN cp $TEMP_DIR/duckdb_cli-linux-amd64.zip $PG_HOME/  
RUN unzip -d . duckdb_cli-linux-amd64.zip

RUN cp $TEMP_DIR/pgroll $PG_HOME/ 
  
USER root  
WORKDIR $ROOT_HOME  

# PostgreSQL 1921, su - postgres, psql
EXPOSE 1921  
# 
EXPOSE 3000 
# pghero 8080, 
EXPOSE 8080 
# pgadmin4 80, 查看 3.sh 内 pgadmin4 使用方法
EXPOSE 80
# MySQL 3306, 
EXPOSE 3306
# PolarDB 5432, su - polardb, pg_ctl start, psql
EXPOSE 5432
# halo 1521, su - halo, pg_ctl start, psql
EXPOSE 1521
# databend, query 3307, Clickhouse(http) 8124, HTTP 8000
# 启动databend, su - databend, cd /home/databend/databend_software, ./scripts/start.sh
# 连接databend, su - databend, bendsql
# 停止databend, su - databend, cd /home/databend/databend_software, ./scripts/stop.sh
EXPOSE 3307
EXPOSE 8124
EXPOSE 8000
# ivorysql pg
EXPOSE 5281
# ivorysql oracle
EXPOSE 1621
ENTRYPOINT ["su", "-", "postgres", "-c", "/usr/lib/postgresql/14/bin/postgres -D \"/var/lib/postgresql/14/pgdata\""]  
```  
  
5、配置ignore文件  
  
```  
cd ~/pg14  
mkdir logs  
  
vi .dockerignore  
logs/  
```  
  
6、制作镜像  
  
6\.1、确认已开启docker 实验属性: `"experimental": true` .  在docker desktop setting: docker engine中配置.  例如:  
```  
{  
  "builder": {  
    "gc": {  
      "defaultKeepStorage": "20GB",  
      "enabled": true  
    }  
  },  
  "dns": [  
    "8.8.8.8"  
  ],  
  "experimental": true,  
  "registry-mirrors": [  
    "https://xxxxxxx.mirror.aliyuncs.com"  
  ]  
}  
```  
  
下载debian amd64架构基础镜像  
  
```  
docker pull --platform=linux/amd64 debian:11.9  
```  
  
确认下载的debian 基础镜像 架构符合预期: amd64  
  
```  
当前打包镜像的是macbook m2芯片机器:  
  U-4G77XXWF-1921:pg14 digoal$ arch  
  arm64  
  
下载的debian 基础镜像 架构符合预期: amd64 , 因为我们目标是打包x86_64(amd64)的镜像  
  U-4G77XXWF-1921:pg14 digoal$ docker image inspect debian:11.9|grep Architecture  
          "Architecture": "amd64",  
```  
  
6\.2、制作postgresql 14镜像:  
  
```  
cd ~/pg14  
  
docker build --platform=linux/amd64 -t="digoal/pg14:with_exts_amd64" . 2>&1 | tee ./logs/build.log  
  
# docker build --platform=linux/amd64 -t="digoal/pg14:with_exts_amd64" --no-cache . 2>&1 | tee ./logs/build.log  
```  
  
仔细检查是否有错误并解决, 例如:  
  
```  
grep Error ./logs/build.log  
grep -i fail ./logs/build.log  
grep -i fatal ./logs/build.log  
grep ERROR ./logs/build.log
grep "ERR\!" ./logs/build.log
grep "E: " logs/build.log  
grep error ./logs/build.log | grep -v "\-Werror"  
```  
  
修复问题后, 可以使用build好的镜像启动容器测试.  
  
```  
docker run --platform=linux/amd64 -d -it -P --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name pg --shm-size=1g digoal/pg14:with_exts_amd64  
  
docker exec -ti pg bash  
  
psql  
```  
  
7、推送镜像到阿里云个人镜像服务, 参考:  
- [《制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习, 并推送到阿里云镜像服务》](../202307/20230710_02.md)  
  
7\.1、 将镜像推送到Registry  
  
```  
docker login --username=dig***@126.com registry.cn-hangzhou.aliyuncs.com  
docker images  
docker tag [ImageId] registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:[镜像版本号]  
docker push registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:[镜像版本号]  
```  
  
根据实际镜像信息替换示例中的`[ImageId]`和`[镜像版本号]`参数。 例如:  
  
```  
docker tag [ImageId] registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
docker push registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
```  
  
7\.2、 拉取image不需要login  
  
```  
docker pull registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
```  
  
加platform参数启动容器:  
```  
docker run --platform linux/amd64 -d -it -P --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --name pg --shm-size=1g registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg14_with_exts  
  
-- 也可以在打包镜像的时候指定多平台, 具体请参考docker 文档.  
-- docker buildx build --platform=linux/amd64,linux/arm64 -t="digoal/pg14:with_exts" . 2>&1 | tee ./logs/build.log  
```  
  
## 集成了哪些插件? 
插件的详细功能和用法请参考:  
- [《未来数据库方向 - 以及PostgreSQL 有价值的插件、可改进功能、开放接口 (202005)》](../202005/20200527_06.md)  
  
1、PG 14自带的所有插件.  
  
2、额外安装的插件或工具  
  
类型增强
- pgmp, PostgreSQL Multiple Precision Arithmetic extension, 支持GMP library, 高性能表达decimal类型.
- unit, 支持很多国际单位的类型
- pg_uuidv7, A tiny Postgres extension to create version 7 UUIDs
- zson, ZSON is a PostgreSQL extension for transparent JSONB compression
- uint, 无符号整型.
- nanoid, nanoid类型.
- ulid, 半高uuid类型.
- snowflake, snowflakeID 分布式数据库全局唯一ID生成器, 比UUID效率高.
- sequential-uuids, 产生有序的UUID.
- permuteseq, PostgreSQL extension for scalable pseudo-random permutations of sequences
  
函数增强  
- extra-window-functions, 扩展窗口函数  
- first-last-agg, 扩展聚合函数  
- tdigest, 扩展窗口、聚合函数  
- rational, 扩展插值算法和函数  
- aggs_for_vecs, 数组类型聚合函数扩展.
- aggs_for_arrays, A Postgres extension in C to compute statistics on arrays of numbers
- quantile, 统计分析相关聚合函数扩展.
- pgjwt, JSON 值转储格式: JSON Web Tokens
- pg_idkit, 集成了大量UUID方法和函数.
    
近似统计分析  
- hll, 近似分析, 例如滑动窗口UV, 短视频场景存储已读列表+快速过滤已读视频  
- datasketches, 近似统计算法库  
  
标签圈选  
- smlar, 标签相似搜索  
- roaringbitmap, 标签圈选  
- pgfaceting, 基于rb index的快速降维分析插件(例如任意条件的UV分析, 滑动窗口分析等)  
  
存储引擎、分析加强:  
- citus, 分布式和列存储  
- columnar, Hydra Columnar extension. 列存储引擎. 
- vops, 瓦片存储和向量化计算  
- orioledb, 基于UNDO机制的存储引擎.    (未集成.)  
- zedstore, 行列混合存储引擎.          (未集成.)  
- pg_cryogen, appendonly的压缩存储引擎.   (未集成.)  
- pg_ivm, 增量刷新物化视图  
  
多值列索引扩展加速  
- rum, 多值列+标量复合搜索加速  
- parray_gin, 多值列元素值模糊搜索  
  
多模型业务场景  
- rdkit, 化学类型+算法+索引  
- timescaledb, 时序  
- pggraphblas, 图式关系加速搜索  
- age, 图式关系搜索(兼容cypherQL语法).    
- madlib, 机器学习分析库  
- pg_variables, 会话或事务级内存变量, 例如用于计数器、需要在会话|事务中存储临时值的场景.  
- temporal_tables, 自动按字段时间归档历史数据.  
- pgtt, 全局临时表, 类似Oracle 全局临时表的风格.
- pipelinedb, 流计算.
- pg4ml, 使用 plpgsql 编写的机器学习框架.
- PGMQ, pg消息队列. 
  
空间业务场景  
- pgrouting, 路由算法  
- pgrouting-doc  
- pgrouting-scripts  
- pgsphere, 空间类型+索引  
- pointcloud, 点云  
- q3c, 空间类型+索引  
- postgis-3, 丰富的空间类型+算法+函数接口+索引  
- postgis-3-scripts  
- ip4r, IP转地理位置信息  
- h3, h3_postgis, uber开源的基于H3模型的地图相关插件.  
- MobilityDB, An open source geospatial trajectory data management & analysis platform. https://github.com/MobilityDB/MobilityDB
  
向量搜索  
- similarity, 近似算法, 类型+索引  
- imgsmlr, 图像搜索, 类型+索引  
- pgvector, 向量搜索, 类型+索引(ivfflat、hnsw)
- pg_sparse, paradedb开源. 稀疏向量搜索. 使用rust编写. 
- svector, paradedb开源. 稀疏向量搜索(就是pg_sparse, 更名为svector). 使用c编写.  https://docs.paradedb.com/blog/introducing_sparse   
- hnsw, 向量搜索, 类型+索引(hnsw)  
- pg_embedding, 向量搜索, 类型+索引(hnsw)  
- lantern, 向量搜索, 类型+索引(usearch implemented hnsw)
- lantern_extras, lantern辅助插件: 数据库内置大模型, 外接大模型, 文本|图像向量化, 加速向量索引build等.
- vectorize, 结合pgvector和OpenAI的应用解决方案型插件, 实现db4ai, ai4db的应用. 
  
文本场景增强  
- prefix, 前缀范围模型  
- groonga, 支持wchar的任意模糊搜索  
- pg_bigm, 增强pg_trgm模糊搜索  
- pg_jieba, 结巴中文分词
- zhparser, scws中文分词
- pg_bm25, paradedb开源. bm25(elastic search目前使用的相关算法)支持, 大数据量文本搜索比传统tsvector,tsrank提升20x性能.
- pg_search, paradedb开源. 通过 bm25+hnsw 支持bm25和向量相似文本搜索. (202401更新, 该插件与pg_bm25融合.)
- pgpcre, 正则. This is a module for PostgreSQL that exposes Perl-compatible regular expressions (PCRE) functionality as functions and operators. 
  
数据融合, 冷热分离  
- mongo_fdw, 读写mongo数据源  
- parquet_s3_fdw, 读写s3,oss对象存储和parquet文件.  (未集成, 通过duckdb_fdw可以读写s3, aliyun oss, 更加快捷)  
- mysql-fdw, 读写mysql数据源  
- ogr-fdw, 基于ogr的通用数据源读写插件  
- oracle-fdw, 读写oracle数据源  
- tds-fdw, 读写ms sql数据源  
- dblink_plus, mysql,sqlite3,oracle的dblink  
- duckdb_fdw, 读写duckdb数据源. 通过duckdb_fdw还可以读写存放在s3的csv, parquet文件. 
- sqlite_fdw, 读写sqlite3
- parquet_fdw, 读parquet文件. 
- hdfs_fdw, 读写hive, spark数据源  
- pgmemcache, 直接的memcache控制函数库  
- pg_curl, 通过curl支持http,ftp,https等网络协议. 将远程数据加载到数据库中.
- pg_net, 异步HTTP调用接口.
- pgsql-http, HTTP 调用接口.
- pg2arrow , 将pg sql结果转换为arrow格式的数据文件. 适合与其他arrow生态的数据分析产品、DB交换数据, 融入大数据生态, 加速数据分析.
- aws_s3, 读写aws s3对象存储.
- decoderbufs, 逻辑复制decoding, logical decoder output plugin to deliver data as Protocol Buffers
- influxdb_fdw, InfluxDB Foreign Data Wrapper for PostgreSQL.
- pg_analytics, paradedb开源的zero-ETL 数据超融合计算插件. [PostgreSQL zero-ETL 超融合计算 插件 pg_analytics](../202401/20240130_03.md)  
  
扩展协议, 兼容其他产品
- FerretDB, 支持mongodb协议, 可使用mongodb客户端连接. (未集成)
- babelfish, 支持sql server协议, 可使用sqlserver客户端连接. (未集成)
- Apache Arrow Flight SQL adapter, arrow 协议, 可使用arrow driver连接. (未集成, 需PG 15及以上版本.)
- orafce, 扩展Oracle兼容性
- pg_dbms_metadata, Oracle's DBMS_METADATA Compatibility for PostgreSQL DDL Extraction
  
存储过程和函数语言增强  
- jsquery, 增强json语法查询库  
- pldebugger, 调试plpgsql函数  
- plpgsql-check, 预检查plpgsql函数  
- pljava, java存储过程和函数语言  
- pllua, lua存储过程和函数语言  
- plproxy, 代理(通常用于sharding和并行数据聚合访问场景)  
- plv8, google v8存储过程和函数语言.      
- plpython3, python存储过程和函数语言  
- plr, R存储过程和函数语言  
- plprofiler, 存储过程和函数的性能分析功能
- plrust, rust存储过程语言支持
  
安全增强  
- postgresql_anonymizer, 敏感信息遮蔽  
- pgsodium, 敏感信息遮蔽以及sodium加密库函数
- credcheck, 强制约束用户密码复杂度
- pg_savior, prevent accidental data loss due to non-parameterized DELETE queries without a WHERE clause.
  
数据库管理、审计、性能优化、数据库迁移、同步等  
- powa, 索引推荐, 等待事件分析, 命中率, 配置变更跟踪等  
- hypopg, 虚拟索引, 索引推荐  
- pg-qualstats, 索引推荐  
- pg-stat-kcache, 跟踪cpu、文件系统真实读写行为  
- pg-wait-sampling, 等待事件采样分析  
- show-plans, 执行过程中的SQL执行计划查询  
- pg_hint_plan, 强制设定SQL执行计划  
- plantuner, 增加了一些参数用来控制SQL执行计划  
- pg_store_plans, 保存SQL执行计划  
- pg_plan_inspector, 复杂SQL执行计划优化修正插. 使用机器学习的方法对收集到的SQL和执行计划等信息进行分析, 从而提升性能.  通过sql安装, 没有extension control file
- pg_stat_monitor, 保存数据库运行时统计信息快照, 用于分析性能  
- pg_statviz, 保存统计信息快照, 使用matplotlib绘图.  
- pg_profile, 使用pg_stat_statements, pg_stat_kcache的统计信息打快照并对快照进行分析. 类似[awr](https://zubkov-andrei.github.io/pg_profile/report_examples/pg15.html). 不过我觉得perf insight和pg_stat_monitor更好用.  
- pg_statsinfo, PG数据库监控工具, 支持按快照选取分析系统运行状态, 类似Oracle statspark.  
- pg_stats_reporter, pg_statsinfo报告的网页呈现, 更加美观, 类似awr效果.
- pgtelemetry, 一些DBA常用的监控数据库和操作系统运行状态的视图. 
- pgfincore, 修改数据文件的page cache行为  
- pg_repack, 几乎不影响业务的收缩膨胀的表和索引浪费的存储空间
- pg_migrate, online DDL, fork自pg_repack, 实现最短时间持有排他锁的DDL, DDL过程中支持DML.  
- squeeze, 几乎不影响业务的收缩膨胀的表和索引浪费的存储空间, 支持设置阈值, 自动调度.
- pgagent, 定时任务  
- pg_cron, 定时任务  
- pg_task, 数据库后台任务管理. 类似oracle dbms_jobs  
- pgaudit, 审计用户行为  
- tablelog, 审计表的修改过程
- supa_audit, PostgreSQL 记录审计、版本跟踪插件 supa_audit (Generic Table Auditing) 
- dirtyread, 脏读  
- wal2json, WAL日志转换为json  
- pg_bulkload, 高速导入数据  
- sqlbench, 压测tpc-c  
- pgxnclient, pgxn插件管理  
- icu-ext, 扩展的icu字符集  
- pg_plan_filter, 基于cbo的限制插件, 例如限制某些用户执行cost大于指定值的SQL. 防止用户"捣乱".  
- pg_query_rewrite, 自定义查询重写规则的插件.  
- pg_track_settings, 跟踪审计GUC参数设置.  
- pg_utility_trigger_functions, 常用功能场景的触发器函数.  
- pg_safer_settings, 记录guc参数设置, 并增加一些基于角色的guc 参数setting权限控制和审计.  
- ddlx, 生成数据库对象的create语句的插件  
- pg_dbms_stats, 统计信息快照, 使用统计信息快照生成执行计划. 类似基线, 确保执行计划的普遍最优性.  
- pg_rman, 块级别数据库增量备份, 根据数据块的LSN判断自上次备份后是否被修改. 类似Oracle incremental backup.
- barman, 支持块级别数据库增量备份, 根据数据块的LSN判断自上次备份后是否被修改. 类似Oracle incremental backup. 
- online_analyze, 事务中分析DML后的统计信息, 适合OLAP跑复杂任务场景的及时统计信息刷新, 用于确保复杂SQL的执行计划正确性.  
- gevel, 观察gin,gist,sp-gist索引内部结构的插件.
- toastinfo, 观察toast存储结构
- pg_later, PG 异步SQL执行插件.
- mimeo, 表级别复制(逻辑复制前的方法, 现在不建议使用)
- pre_prepare, 数据库端prepared statement自动保存, 便于pool调用.
- prioritize, 结合OS PID task优先级功能, 设置pg backend pid cpu调度优先级
- pgsentinel, postgresql extension providing Active session history
- pgwatch2, PostgreSQL metrics monitor/dashboard. 暂未集成
- pg_top, postgresql的top命令, 类似linux top. 
- pgcenter, 类似pg_top, 可一屏显示多个实例的top情况.  pgCenter is a command line admin tool for PostgreSQL.
- pg_activity, pg_activity is a top like application for PostgreSQL server activity monitoring.
- pg_proctab, 配合pg_top使用, 观察远程postgresql的top资源.
- pgbadger, A fast PostgreSQL Log Analyzer. http://pgbadger.darold.net/ 
- pg_auto_failover, Postgres extension and service for automated failover and high-availability. https://github.com/hapostgres/pg_auto_failover
- pghero, A performance dashboard for Postgres. https://github.com/ankane/pghero
- ora2pg, oracle,mysql迁移到postgresql的工具
- pgloader, 使用fdw读取其他数据库的数据, 并快速迁移到PostgreSQL的迁移工具
- pgreplay, 回放postgresql log的工具. 需要开启log_statements.
- pg_subtrans_infos, 查看子事务信息
- pg_subxact_counters, 统计子事务
- pgbackrest, 备份管理工具.
- elephant-shed-pgbackrest, PG备份管理工具pgbackrest web控制台, 同时集成了一些有趣的工具
- PgDD, PostgreSQL Data Dictionary for 开发者, 快速了解数据库概貌. https://github.com/rustprooflabs/pgdd
- pg_partman, Partition management extension for PostgreSQL   
- pg_filedump, pg_filedump is a utility to format PostgreSQL heap/index/control files into a human-readable form.
- pg_jobmon, PostgreSQL extension which provides persistent logging within transactions and functions. 事务即使回滚也能留下数据, 使用的是dblink外部事务实现.
- pgroll, PostgreSQL zero-downtime migrations made easy
- walminer 3.0, XLogMiner, 李传成老师贡献的开源插件, 可以从wal日志中提取尽可能多的逻辑数据, 用于灾难恢复. 4.0版本功能更强大, 支持multi-master复制, 有兴趣的朋友可以联系李老师. https://gitee.com/movead/XLogMiner/
- pgcopydb, Copy a Postgres database to a target Postgres server (pg_dump | pg_restore on steroids)  带迁移校验功能
- pgmeminfo, allow to access to memory usage diagnostics.
- pg_statement_rollback, 服务端auto savepoint和rollback statement支持, 类似oracle,db2. 事务内遇到错误可以继续正常请求
- pg_dumpbinary / pg_restorebinary, binary格式的逻辑备份/恢复工具.
- patroni, PostgreSQL HA 软件.
- repmgr, PostgreSQL HA 软件.
- pgl_ddl_deploy, DDL透明逻辑复制插件. 通过事件触发器在发布端捕获DDL SQL并写入表中, 通过DML触发器在订阅端回放DDL.
- system_stats, A Postgres extension for exposing system metrics such as CPU, memory and disk information.
- dsef, DiffStats and ExplainFull: detailed SQL reports for third party help & support
  
  
  
连接池和读写分离  
- pgpool2, 连接池和读写分离  
- pgagroal, 高性能连接池  
- pgbouncer, 高性能连接池  
- pgcat, 连接池和读写分离,sharding等特性, 未来发展前景比较可观  
  
  
未来可能还会新增的插件或产品(你有什么想要的插件可以在issue中留言):  
```  
https://neon.tech/docs/extensions/pg-extensions  

PostgreSQL协议兼容分布式数据库: 
https://yugabyte.com/
https://github.com/cockroachdb/cockroach

类似aws aurora架构的云原生开源数据库, 修改了pg的page server, fd, wal等接口. 
https://neon.tech/

OrioleDB is an attempt to improve PostgreSQL by using lock-free page reading, undo logging, row-level WAL and more.  
https://www.orioledata.com/
  
https://github.com/supabase/postgres
  
Postgres extension for ulid  
https://github.com/pksunkara/pgx_ulid  
  
PostgreSQL implementation of JWT (JSON Web Tokens)  
https://github.com/michelp/pgjwt  
  
Short unique id generator for PostgreSQL, using hashids  
https://github.com/iCyberon/pg_hashids  
  
GraphQL support for PostgreSQL  
https://github.com/supabase/pg_graphql  
  
PostgreSQL extension providing JSON Schema validation  
https://github.com/supabase/pg_jsonschema  
  
A tiny Postgres extension to create version 7 UUIDs  
https://github.com/fboulnois/pg_uuidv7  
  
Build Postgres Extensions with Rust!  
https://github.com/pgcentralfoundation/pgrx  
  
Parquet S3 Foreign Data Wrapper for PostgresSQL  
https://github.com/pgspider/parquet_s3_fdw  
  
PostgresML  
https://github.com/postgresml/postgresml  
  
supavisor, A cloud-native, multi-tenant Postgres connection pooler.  
https://github.com/supabase/supavisor  
  
FerretDB, 前端使用mongo 协议, 后端使用PostgreSQL或SQLite3的数据库  
https://github.com/FerretDB/FerretDB  
  
Apache Arrow Flight SQL adapter for PostgreSQL   
https://arrow.apache.org/blog/2023/09/13/flight-sql-postgresql-0.1.0-release/  
https://github.com/apache/arrow-flight-sql-postgresql  
  
babelfish, sql server wire protocol  
https://babelfishpg.org/  
https://github.com/babelfish-for-postgresql/babelfish_compass/releases    
  
Ora2Pg, 迁移Oracle, MySQL到PostgreSQL的工具  
https://github.com/darold/ora2pg  
  
pg_later, PG 异步SQL执行插件.
已集成到docker image
https://github.com/tembo-io/pg_later

PGMQ, pg消息队列
已集成到docker image
https://github.com/tembo-io/pgmq
https://tembo.io/blog/introducing-pgmq/#using-pgmq

hydra, PG列存储. 
已集成到docker image
https://hydra-so.notion.site/Hydra-1-0-beta-318504444825401e8ce21796dcadd589
https://github.com/hydradatabase/hydra

俄罗斯航空数据集, Demonstration Database 
https://postgrespro.com/community/demodb

在PostgreSQL中运行wasm binary.  
https://github.com/wasmerio/wasmer-postgres
  
使用wasm技术, 将PostgreSQL运行在浏览器虚拟机中. (About A PostgresQL server running in your browser)
https://github.com/snaplet/postgres-wasm
https://supabase.com/blog/postgres-wasm

lsm3, LSM tree implementation based on standard B-Tree
https://github.com/postgrespro/lsm3

sr_plan, Save and restore query plans in PostgreSQL
https://github.com/postgrespro/sr_plan

pg_onnx, 开放的神经网络集市(onnx)在PG中的调用接口.  类似postgresml, 阿里云灵积这样的大模型集市, 在PG内部通过封装好的函数调用AI能力.
已集成到docker image
https://github.com/kibae/pg_onnx
  
onnx model, 已有大模型
已集成到docker image
https://github.com/onnx/models
https://onnxruntime.ai/

pg4ml, 开放的神经网络算法库. 郭铁成老师主导, 内容非常丰富. 
已集成到docker image
https://gitee.com/seanguo_007/plpgsql_pg4ml

orc_fdw, 访问ORC格式列存储文件
https://github.com/HighgoSoftware/orc_fdw

zombodb, 使用elastic search作为外部索引. 
https://github.com/zombodb/zombodb

pgwatch2, PostgreSQL metrics monitor/dashboard 
https://github.com/cybertec-postgresql/pgwatch2

pg_timetable, Advanced scheduling for PostgreSQL
https://www.cybertec-postgresql.com/en/products/pg_timetable/
https://github.com/cybertec-postgresql/pg_timetable/releases
https://github.com/cybertec-postgresql/pg_timetable
https://www.cybertec-postgresql.com/en/introducing-pg_timetable-v5-6-delayed-chains-and-error-handling/

partoni, A template for PostgreSQL High Availability with Etcd, Consul, ZooKeeper, or Kubernetes
https://github.com/zalando/patroni  
  
walminer, 解析wal的工具 已集成
https://gitee.com/movead/XLogMiner

pgroll, PostgreSQL zero-downtime migrations made easy
已集成到docker image
https://xata.io/blog/pgroll-schema-migrations-postgres
https://github.com/xataio/pgroll
https://github.com/xataio/pgroll/releases

pgmonitor, crunchydata提供的监控解决方案
https://access.crunchydata.com/documentation/pgmonitor/latest/
https://github.com/CrunchyData/pgmonitor

pg-osc, online DDL. Easy CLI tool for making zero downtime schema changes and backfills in PostgreSQL
https://github.com/shayonj/pg-osc

reshape, An easy-to-use, zero-downtime schema migration tool for Postgres
https://github.com/fabianlindfors/reshape

pgmoneta, Backup / restore solution for PostgreSQL
https://github.com/pgmoneta/pgmoneta

WAL-G, WAL-G is an archival restoration tool for PostgreSQL, MySQL/MariaDB, and MS SQL Server (beta for MongoDB and Redis).
https://github.com/wal-g/wal-g

A eBPF based lock tracer for the PostgreSQL database
https://github.com/jnidzwetzki/pg-lock-tracer

Tracing tools for PostgreSQL, using eBPF
https://github.com/Aiven-Open/pgtracer

Postgres Extension written in Rust, to enable data tiering to AWS S3
https://github.com/tembo-io/pg_tier

Copy to/from Parquet in S3 from within PostgreSQL
https://github.com/CrunchyData/pg_parquet
```
  
## 集成了哪些发行版?  
本docker镜像除了集成开源PostgreSQL及大量经典开源插件与工具, 还集成了目前流行度较高、或理念前卫、发展迅猛的其他数据库发行版.  
  
嵌入式OLAP数据库:  
- DuckDB, 嵌入式的OLAP库, 功能非常强大性能非常好. 兼容SQLite3语法和PostgreSQL语法.
  
PostgreSQL发行版:  
- HaloDB, [杭州易景科技发布的羲和数据库](http://www.halodbtech.com/). 兼容PostgreSQL(协议级兼容), MySQL(协议级兼容), Oracle的数据库. 感谢章老哥提供二进制包和试用许可. `su - halo` 进入halo用户即可使用. 更多请参考halo的官方文档.
- [PolarDB for PostgreSQL](https://github.com/ApsaraDB/PolarDB-for-PostgreSQL)   https://apsaradb.github.io/PolarDB-for-PostgreSQL/zh/  阿里云开源的云原生数据库, 完全兼容PostgreSQL, 采用存算分离架构, 类似Oracle既能单机部署, 也可以RAC形式(依赖共享存储)部署. HA建议采用[中启乘数开源的clup软件](https://gitee.com/csudata/clup-community)或[patroni](https://patroni.readthedocs.io/en/latest/README.html).
- NeonDatabase (已经从镜像里拿掉了, 占用空间太大, 而且体验过后发现性能不行, 如果需要你可以把dockerfile里安装neondatabase的注释去掉基于当前镜像加入.), 开源替代AWS Aurora. [《neondatabase部署与使用实践》](../202403/20240319_01.md)
- IvorySQL. https://github.com/IvorySQL/IvorySQL  瀚高兼容Oracle的开源发行版.  
  
MySQL系列: 
- MySQL 8 (only in x86_64 image now.)  
- proxysql, High Performance Advanced Proxy for MySQL, https://proxysql.com/documentation/installing-proxysql/
  
云原生数仓:  
- databend (datalake/数据湖产品. 理念: data warehouse as code, 由各种rust开源组件SQL解析、优化器、存储格式、存储引擎拼装起来.)  https://docs.databend.com/guides/deploy/deploying-local
  
  
## docker build failed: Max depth exceeded  问题处理  
最多128层, 早期全部写到了一个Dockerfile里面, 导致有300多层, 所以搞不起来.  
  
把内容写到脚本里面, COPY到容器后执行, 从而减少层数解决`Max depth exceeded`报错.  
  
https://github.com/cri-o/cri-o/issues/6261  
  
先清理报错后产生的cache:  
  
```  
IT-C02YW2EFLVDL:blog digoal$ docker system df  
TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE  
Images          1         0         124.2MB   124.2MB (100%)  
Containers      0         0         0B        0B  
Local Volumes   49        0         333.3MB   333.3MB (100%)  
Build Cache     17        0         367.8MB   367.8MB  
  
IT-C02YW2EFLVDL:blog digoal$ docker system prune  
WARNING! This will remove:  
  - all stopped containers  
  - all networks not used by at least one container  
  - all dangling images  
  - all dangling build cache  
  
Are you sure you want to continue? [y/N] y  
Deleted build cache objects:  
igwa1ryjji9blru2ha7mhvmeg  
.....  
  
Total reclaimed space: 367.8MB  
```  
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")  
  
  
#### [PolarDB 云原生分布式开源数据库](https://github.com/ApsaraDB "57258f76c37864c6e6d23383d05714ea")  
  
  
#### [PolarDB 学习图谱: 训练营、培训认证、在线互动实验、解决方案、内核开发公开课、生态合作、写心得拿奖品](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")  
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")  
  
  
#### [德哥 / digoal's github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")  
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")  
  
  
  
  
  
#### [购买PolarDB云服务折扣活动进行中, 55元起](https://www.aliyun.com/activity/new/polardb-yunparter?userCode=bsb3t4al "e0495c413bedacabb75ff1e880be465a")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
