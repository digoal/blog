## PostgreSQL 18 preview - æ”¯æŒOAuth 2.0è®¤è¯åè®®, å¯â€œåˆ·å¡â€è®¤è¯äº†  
                                                                                  
### ä½œè€…                                                      
digoal                                                      
                                                             
### æ—¥æœŸ                                                           
2025-02-21                                                     
                                                          
### æ ‡ç­¾                                                        
PostgreSQL , PolarDB , DuckDB , OAuth 2.0 , è®¤è¯åè®®                     
                                                                                 
----                                                          
                                                                        
## èƒŒæ™¯        
PostgreSQL 18å¢åŠ äº†å¯¹OAuth 2.0è®¤è¯åè®®çš„æ”¯æŒï¼Œä»¥ä¸‹æ˜¯æ ¸å¿ƒå†…å®¹çš„è§£è¯»ï¼š  
  
### **ä¸€ã€åŠŸèƒ½æ¦‚è§ˆ**  
#### 1. **æ–°å¢è®¤è¯æœºåˆ¶**  
- **OAUTHBEARER SASL**ï¼šåŸºäºRFC 7628ï¼Œæ”¯æŒé€šè¿‡OAuth Bearer Tokenè¿›è¡Œèº«ä»½éªŒè¯ï¼Œæ›¿ä»£ä¼ ç»Ÿå¯†ç ã€‚  
- **è®¾å¤‡æˆæƒæµç¨‹**ï¼šéµå¾ªRFC 8628ï¼Œå…è®¸æ— æµè§ˆå™¨è®¾å¤‡ï¼ˆå¦‚CLIå·¥å…·ï¼‰é€šè¿‡ç”¨æˆ·äºŒæ¬¡æˆæƒå®Œæˆè®¤è¯ã€‚  
  
#### 2. **ç”¨æˆ·åœºæ™¯ç¤ºä¾‹**  
```bash  
# å®¢æˆ·ç«¯è¿æ¥å‘½ä»¤  
psql "host=db.example.com oauth_issuer=https://auth.example.com oauth_client_id=myapp"  
# è¾“å‡ºæç¤ºç”¨æˆ·è®¿é—®URLè¾“å…¥è®¾å¤‡ç   
Visit https://auth.example.com/device and enter code: XKCD-42  
```  
  
### **äºŒã€æ¶æ„è®¾è®¡**  
#### 1. **å®¢æˆ·ç«¯æµç¨‹**  
```mermaid  
sequenceDiagram  
    participant Client as å®¢æˆ·ç«¯(psql)  
    participant AuthServer as OAuthæœåŠ¡å•†  
    participant DB as PostgreSQLæœåŠ¡ç«¯  
  
    Client->>AuthServer: 1. è¯·æ±‚è®¾å¤‡æˆæƒç   
    AuthServer-->>Client: è¿”å›device_codeå’ŒéªŒè¯URL  
    Client->>User: æ˜¾ç¤º"è®¿é—®URLè¾“å…¥ä»£ç : XKCD-42"  
    loop è½®è¯¢  
        Client->>AuthServer: 2. ä½¿ç”¨device_codeæŸ¥è¯¢ä»¤ç‰Œ  
        AuthServer-->>Client: è¿”å›access_tokenï¼ˆå¾…ç”¨æˆ·æˆæƒåï¼‰  
    end  
    Client->>DB: 3. SASL OAUTHBEARERå‘é€access_token  
    DB->>Validator: 4. è°ƒç”¨éªŒè¯æ¨¡å—æ ¡éªŒä»¤ç‰Œ  
    Validator-->>DB: è¿”å›ç”¨æˆ·èº«ä»½  
    DB-->>Client: 5. è®¤è¯æˆåŠŸ/å¤±è´¥  
```  
  
#### 2. **æœåŠ¡ç«¯éªŒè¯æ¡†æ¶**  
- **æ’ä»¶åŒ–éªŒè¯æ¨¡å—**ï¼šå…è®¸é€šè¿‡åŠ¨æ€åº“å®ç°è‡ªå®šä¹‰ä»¤ç‰ŒéªŒè¯é€»è¾‘ã€‚  
- **é…ç½®ç¤ºä¾‹ï¼ˆpg_hba.confï¼‰**ï¼š  
  ```ini  
  # TYPE  DATABASE USER  ADDRESS   METHOD  VALIDATOR  
  hostssl all      all   0.0.0.0/0 oauth   my_custom_validator  
  ```  
  
æ‰‹å†Œè¯¦è§:   
- https://www.postgresql.org/docs/devel/libpq-oauth.html  
- https://www.postgresql.org/docs/devel/auth-oauth.html  
- https://www.postgresql.org/docs/devel/oauth-validators.html  
  
https://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=b3f0be788afc17d2206e1ae1c731d8aeda1f2f59  
```  
Add support for OAUTHBEARER SASL mechanism  
  
author	Daniel Gustafsson <dgustafsson@postgresql.org>	  
Thu, 20 Feb 2025 15:25:17 +0000 (16:25 +0100)  
committer	Daniel Gustafsson <dgustafsson@postgresql.org>	  
Thu, 20 Feb 2025 15:25:17 +0000 (16:25 +0100)  
commit	b3f0be788afc17d2206e1ae1c731d8aeda1f2f59  
tree	4935e9d745787830d57941771dd2e63b49236ae5	tree  
parent	1fd1bd871012732e3c6c482667d2f2c56f1a9395	commit | diff  
Add support for OAUTHBEARER SASL mechanism  
  
This commit implements OAUTHBEARER, RFC 7628, and OAuth 2.0 Device  
Authorization Grants, RFC 8628.  In order to use this there is a  
new pg_hba auth method called oauth.  When speaking to a OAuth-  
enabled server, it looks a bit like this:  
  
  $ psql 'host=example.org oauth_issuer=... oauth_client_id=...'  
  Visit https://oauth.example.org/login and enter the code: FPQ2-M4BG  
  
Device authorization is currently the only supported flow so the  
OAuth issuer must support that in order for users to authenticate.  
Third-party clients may however extend this and provide their own  
flows.  The built-in device authorization flow is currently not  
supported on Windows.  
  
In order for validation to happen server side a new framework for  
plugging in OAuth validation modules is added.  As validation is  
implementation specific, with no default specified in the standard,  
PostgreSQL does not ship with one built-in.  Each pg_hba entry can  
specify a specific validator or be left blank for the validator  
installed as default.  
  
This adds a requirement on libcurl for the client side support,  
which is optional to build, but the server side has no additional  
build requirements.  In order to run the tests, Python is required  
as this adds a https server written in Python.  Tests are gated  
behind PG_TEST_EXTRA as they open ports.  
  
This patch has been a multi-year project with many contributors  
involved with reviews and in-depth discussions:  Michael Paquier,  
Heikki Linnakangas, Zhihong Yu, Mahendrakar Srinivasarao, Andrey  
Chudnovsky and Stephen Frost to name a few.  While Jacob Champion  
is the main author there have been some levels of hacking by others.  
Daniel Gustafsson contributed the validation module and various bits  
and pieces; Thomas Munro wrote the client side support for kqueue.  
  
Author: Jacob Champion <jacob.champion@enterprisedb.com>  
Co-authored-by: Daniel Gustafsson <daniel@yesql.se>  
Co-authored-by: Thomas Munro <thomas.munro@gmail.com>  
Reviewed-by: Daniel Gustafsson <daniel@yesql.se>  
Reviewed-by: Peter Eisentraut <peter@eisentraut.org>  
Reviewed-by: Antonin Houska <ah@cybertec.at>  
Reviewed-by: Kashif Zeeshan <kashi.zeeshan@gmail.com>  
Discussion: https://postgr.es/m/d1b467a78e0e36ed85a09adf979d04cf124a9d4b.camel@vmware.com  
```  
  
## ä»€ä¹ˆæ˜¯OAUTH?   
æˆ‘ç”¨æ—¥å¸¸ç”Ÿæ´»ä¸­çš„åœºæ™¯æ¥æ¯”å–»è¿™äº›åè®®ï¼Œå¸®åŠ©å¤§å®¶è½»æ¾ç†è§£ï¼š  
  
---  
  
### **ä¸€ã€OAUTHBEARERï¼ˆRFC 7628ï¼‰â€”â€” å·¥ä½œè¯åˆ·å¡æœº**  
**åœºæ™¯æƒ³è±¡**ï¼š    
ä½ æ¯å¤©ä¸Šç­è¿›å…¬å¸å¤§é—¨ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½è¾“å…¥å¯†ç ï¼Œè€Œæ˜¯åˆ·å·¥ç‰Œå°±èƒ½é€šè¿‡é—¸æœºã€‚è¿™ä¸ªå·¥ç‰Œå°±æ˜¯ä½ çš„"Bearer Token"ï¼ˆæŒæœ‰è€…ä»¤ç‰Œï¼‰ã€‚  
  
**æŠ€æœ¯æœ¬è´¨**ï¼š  
1. **Bearer Token** å°±åƒå·¥ç‰Œï¼Œè°æ‹¿ç€å®ƒå°±èƒ½è·å¾—æƒé™ï¼ˆå› æ­¤å¿…é¡»åŠ å¯†ä¼ è¾“ï¼‰  
2. **SASLæœºåˆ¶** å°±åƒåˆ·å¡æœºï¼Œä¸“é—¨å¤„ç†è¿™ç§åˆ·å¡éªŒè¯çš„æµç¨‹  
3. **RFC 7628** è§„å®šäº†åˆ·å¡æœºçš„æ ‡å‡†æ¥å£ï¼Œè®©æ‰€æœ‰å…¬å¸çš„åˆ·å¡æœºéƒ½å…¼å®¹åŒæ ·çš„å·¥ç‰Œæ ¼å¼  
  
**PostgreSQLåº”ç”¨**ï¼š    
å½“ä½ åœ¨ç»ˆç«¯è¾“å…¥ `psql` è¿æ¥æ•°æ®åº“æ—¶ï¼ŒèƒŒåçš„æµç¨‹ç±»ä¼¼ï¼š  
```bash  
ç»ˆç«¯ -> æ•°æ®åº“é—¸æœºï¼šæˆ‘è¦ç”¨OAUTHBEARERæœºåˆ¶åˆ·å¡  
æ•°æ®åº“é—¸æœº -> ç»ˆç«¯ï¼šè¯·å‡ºç¤ºå·¥ç‰Œ  
ç»ˆç«¯ -> æ•°æ®åº“é—¸æœºï¼šè¿™æ˜¯æˆ‘çš„å·¥ç‰Œï¼ˆå‘é€åŠ å¯†åçš„Tokenï¼‰  
æ•°æ®åº“é—¸æœº -> äººäº‹ç³»ç»Ÿï¼šéªŒè¯å·¥ç‰Œæœ‰æ•ˆæ€§ âœ…  
```  
  
---  
  
### **äºŒã€è®¾å¤‡æˆæƒè®¸å¯ï¼ˆRFC 8628ï¼‰â€”â€” è®¿å®¢ä¸´æ—¶é€šè¡Œè¯**  
**åœºæ™¯æƒ³è±¡**ï¼š    
ä½ æ˜¯å¿«é€’å‘˜éœ€è¦è¿›å…¥å†™å­—æ¥¼é€è´§ï¼Œä½†æ²¡å‘˜å·¥å¡ã€‚å‰å°ç»™ä½ ä¸€ä¸ª **6ä½æ•°éªŒè¯ç **ï¼Œè®©ä½ å»ç‰©ä¸šç½‘ç«™ç”³è¯·ä¸´æ—¶é€šè¡Œè¯ã€‚  
  
**åˆ†æ­¥æµç¨‹**ï¼š  
1. **è·å–è®¾å¤‡ç **ï¼ˆç±»ä¼¼å¿«é€’å‘˜æ‹¿åˆ°6ä½æ•°ï¼‰    
   ```bash  
   $ psql "host=db.example.com oauth_issuer=... oauth_client_id=..."  
   æç¤ºï¼šè®¿é—® https://auth.example.com å¹¶è¾“å…¥ä»£ç ï¼šXKCD-42  
   ```  
     
2. **ç”¨æˆ·æˆæƒ**ï¼ˆç‰©ä¸šç½‘ç«™å®¡æ ¸å¿«é€’å‘˜èº«ä»½ï¼‰    
   ğŸ‘©ğŸ’» ä½ åœ¨æ‰‹æœºä¸Šæ‰“å¼€ç½‘é¡µï¼Œè¾“å…¥XKCD-42ï¼Œç‚¹å‡»"å…è®¸è®¿é—®"  
  
3. **è½®è¯¢è·å–ä»¤ç‰Œ**ï¼ˆå‰å°æŒç»­æ£€æŸ¥æ˜¯å¦å®¡æ ¸é€šè¿‡ï¼‰    
   ```python  
   while True:  
       å¿«é€’å‘˜é—®å‰å°ï¼š"æˆ‘çš„ç”³è¯·é€šè¿‡äº†å—ï¼Ÿ"  
       if é€šè¿‡:  
           æ‹¿åˆ°ä¸´æ—¶é€šè¡Œè¯ï¼ˆAccess Tokenï¼‰  
           break  
   ```  
  
4. **ä½¿ç”¨ä»¤ç‰Œ**ï¼ˆå¿«é€’å‘˜åˆ·å¡è¿›å…¥ï¼‰    
   ```bash  
   ç»ˆç«¯è‡ªåŠ¨ç”¨æ‹¿åˆ°çš„é€šè¡Œè¯é€šè¿‡OAUTHBEARERæœºåˆ¶è¿æ¥æ•°æ®åº“  
   ```  
  
---  
  
### **ä¸‰ã€åè®®é…åˆæµç¨‹å›¾è§£**  
```mermaid  
sequenceDiagram  
    participant User as ç”¨æˆ·ï¼ˆä½ ï¼‰  
    participant Device as è®¾å¤‡ï¼ˆpsqlï¼‰  
    participant AuthServer as æˆæƒæœåŠ¡å™¨ï¼ˆç‰©ä¸šç½‘ç«™ï¼‰  
    participant DB as æ•°æ®åº“ï¼ˆå†™å­—æ¥¼é—¸æœºï¼‰  
  
    Device->>AuthServer: 1. ç”³è¯·è®¾å¤‡ç ï¼ˆå¿«é€’å‘˜åˆ°å‰å°ï¼‰  
    AuthServer-->>Device: è¿”å›è®¾å¤‡ç XKCD-42  
    User->>AuthServer: 2. æ‰‹æœºè®¿é—®ç½‘ç«™ï¼Œè¾“å…¥XKCD-42å¹¶æˆæƒï¼ˆå¿«é€’å‘˜æ‰¾ç‰©ä¸šå®¡æ ¸ï¼‰  
    loop æ¯5ç§’æ£€æŸ¥  
        Device->>AuthServer: 3. è½®è¯¢æ˜¯å¦é€šè¿‡ï¼Ÿ   
        AuthServer-->>Device: æœªé€šè¿‡...ï¼ˆç­‰å¾…ç”¨æˆ·æ“ä½œï¼‰  
    end  
    AuthServer-->>Device: 4. å®¡æ ¸é€šè¿‡ï¼Œå‘æ”¾é€šè¡Œè¯  
    Device->>DB: 5. ä½¿ç”¨OAUTHBEARERåˆ·å¡è¿›åº“  
```  
  
---  
  
### **å››ã€ä¸ºä»€ä¹ˆæ¯”å¯†ç æ›´å®‰å…¨ï¼Ÿ**  
|          | ä¼ ç»Ÿå¯†ç                      | OAuthä»¤ç‰Œ                  |  
|----------|----------------------------|---------------------------|  
| **å½¢å¼** | å›ºå®šå­—ç¬¦ä¸²ï¼ˆå®¹æ˜“è¢«ç›—ï¼‰         | çŸ­æ—¶æ•ˆä»¤ç‰Œï¼ˆå¤±æ´»å¿«ï¼‰         |  
| **æ³„éœ²** | çŸ¥é“å¯†ç å°±èƒ½ç™»å½•              | éœ€åŒæ—¶çªƒå–ä»¤ç‰Œ+ç½‘ç»œæ‹¦æˆª      |  
| **æƒé™** | å®Œå…¨è®¿é—®æƒé™                 | å¯é™åˆ¶ç‰¹å®šæƒé™ï¼ˆå¦‚åªè¯»ï¼‰      |  
| **æ¡ˆä¾‹** | å¯†ç æ³„éœ²å¯¼è‡´æ•°æ®è¢«ç›—           | ä»¤ç‰Œæ³„éœ²å1å°æ—¶è‡ªåŠ¨å¤±æ•ˆ       |  
  
---  
  
### **äº”ã€å¼€å‘è€…éœ€æ³¨æ„çš„ç»†èŠ‚**  
1. **ä»¤ç‰Œæœ‰æ•ˆæœŸ**ï¼šå°±åƒä¸´æ—¶é€šè¡Œè¯é€šå¸¸åªæœ‰1å¤©æœ‰æ•ˆæœŸï¼Œéœ€åŠæ—¶åˆ·æ–°  
2. **HTTPSå¼ºåˆ¶**ï¼šæ‰€æœ‰é€šä¿¡å¿…é¡»åŠ å¯†ï¼Œå°±åƒå¿«é€’å‘˜å¿…é¡»èµ°å®‰æ£€é€šé“  
3. **è®¾å¤‡ç è®¾è®¡**ï¼š  
   - çŸ­ç ï¼ˆæ–¹ä¾¿è¾“å…¥ï¼‰ï¼š`XKCD-42` æ¯” `0x3e7a1b` æ›´å‹å¥½  
   - è¿‡æœŸæ—¶é—´ï¼šé€šå¸¸5åˆ†é’Ÿæœªè¾“å…¥åˆ™å¤±æ•ˆï¼Œé˜²æ­¢è¢«å†’ç”¨  
  
é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œå³ä½¿ä½ åœ¨æ²¡æœ‰æµè§ˆå™¨çš„å‘½ä»¤è¡Œç¯å¢ƒä¸­ï¼Œä¹Ÿèƒ½å®‰å…¨åœ°å®Œæˆç°ä»£èº«ä»½è®¤è¯ï¼  
       
       
  
#### [æœŸæœ› PostgreSQL|å¼€æºPolarDB å¢åŠ ä»€ä¹ˆåŠŸèƒ½?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB å¼€æºæ•°æ®åº“](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB å­¦ä¹ å›¾è°±](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL è§£å†³æ–¹æ¡ˆé›†åˆ](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [å¾·å“¥ / digoal's Github - å…¬ç›Šæ˜¯ä¸€è¾ˆå­çš„äº‹.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About å¾·å“¥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
