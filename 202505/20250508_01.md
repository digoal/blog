## å¾·è¯´-ç¬¬334æœŸ, Redis 8 æ•²é”£æ‰“é¼“çš„å›å½’, ä¸ºä»€ä¹ˆ?   
                            
### ä½œè€…                            
digoal                            
                            
### æ—¥æœŸ                            
2025-05-08                          
                            
### æ ‡ç­¾                            
PostgreSQL , PolarDB , DuckDB , AI agent , å¤§è„‘ , è®°å¿† , å·¥å…· , è¿æ¥ , æ¨ç† , ç†æ€§è„‘ , transformer , kv cache , æ¨ç†åŠ é€Ÿ   
                            
----                            
                            
## èƒŒæ™¯    
Redis 8æ•²é”£æ‰“é¼“çš„, åˆæ˜¯é‡æ–°å¼€æº, åˆæ˜¯æ”¯æŒå¤šé‡å¼€æºåè®®, é‡æ–°æ”¯æŒäº‘å‚å•†å‹å¥½çš„AGPLv3å¼€æºåè®®. è¿™æ˜¯æ€ä¹ˆäº†?  
```  
Starting with Redis 8, Redis Open Source is moving to a tri-licensing model with all new Redis code  
contributions governed by the updated Redis Software Grant and Contributor License Agreement.  
After this release, contributions are subject to your choice of:    
(a) the Redis Source Available License v2 (RSALv2);  
or (b) the Server Side Public License v1 (SSPLv1);   
or (c) the GNU Affero General Public License v3 (AGPLv3).   
  
Redis Open Source 7.2 and prior releases remain subject.   
```  
  
å’Œå‰é¢å‡ æœŸç»“åˆèµ·æ¥çœ‹, è¯´ç™½äº†å¤§å®¶çš„åˆ¤æ–­éƒ½ä¸€æ ·.    
- [ã€Šå¾·è¯´-ç¬¬333æœŸ, DatabricksèŠ±10äº¿ç¾å…ƒä¹°å¼€æºNeonæ•°æ®åº“, å€¼å¾—å—?ã€‹](../202505/20250506_01.md)    
- [ã€Šå¾·è¯´-ç¬¬331æœŸ, tongyiçš„ç«äº‰å¯¹æ‰‹æ˜¯è°?ã€‹](../202504/20250429_01.md)    
  
  
1ã€ä¸€åˆ‡éƒ½å°†è¢«AIåŒ–, AI æ™ºèƒ½ä½“ä¼šéåœ°å¼€èŠ±çš„çˆ†å‘, æ•°é‡å·¨å¤š, æœ‰å“ªäº›?     
    
Cç«¯, å¹³å‡æ¯ä¸ªäººæ‹¥æœ‰è¶…è¿‡1ä¸ªæ™ºèƒ½ä½“, è¿™å°±æ˜¯å‡ åäº¿.     
    
Bç«¯, æ”¿åºœã€åˆ¶é€ ä¸šã€é‡‘èã€æ¸¸æˆã€æ•™è‚²ç­‰å„ä¸ªé¢†åŸŸ, æ¯ä¸ªé¢†åŸŸçš„ä¼ä¸š/æœºæ„éƒ½éœ€è¦å¤§é‡æ™ºèƒ½ä½“.     
    
2ã€AI æ™ºèƒ½ä½“çš„æœ¬è´¨æ˜¯ä»€ä¹ˆ? å¤§è„‘ + è®°å¿†(åŒ…æ‹¬ä¼šè¯è®°å½•ã€ç§æœ‰çŸ¥è¯†åº“ã€é…ç½®ç­‰) + å·¥å…·åŠè¿æ¥(é€šè¿‡å·¥å…·è°ƒç”¨è¿æ¥ã€ä½¿ç”¨ç‰©ç†ä¸–ç•Œçš„å…¶ä»–äº§å“å’Œå…¶ä»–AI agent)       
    
æˆ‘åœ¨è¿™ä¸€æœŸè°ˆè¿‡, è¯¦è§: [ã€Šå¾·è¯´-ç¬¬325æœŸ, AI Agentçš„æœ¬è´¨æ˜¯ä»€ä¹ˆ? å¦‚ä½•å¿«é€Ÿæ­å»ºå±äºè‡ªå·±çš„agentã€‹](../202504/20250422_01.md)      
    
æˆ‘ä»¬é‡ç‚¹å…³æ³¨â€œè®°å¿†(åŒ…æ‹¬ä¼šè¯è®°å½•ã€ç§æœ‰çŸ¥è¯†åº“ã€é…ç½®ç­‰)â€, è¿™ä¸ªå®é™…ä¸Šå°±æ˜¯æ•°æ®åº“.  è€Œä¸”è®°å¿†ä¸ä»…ä»…æœ‰å‘é‡ã€è¿˜æœ‰æ ‡å‡†çš„ç»“æ„åŒ–æ•°æ®ã€éç»“æ„åŒ–æ•°æ®ç­‰ç­‰.       
     
ä»¥ä¸‹å‡ ç¯‡æ–‡ç« è¯´æ˜äº†å³ä½¿æ˜¯å¬å›, ä¸ºäº†è·å¾—æ›´å¥½çš„å¬å›ç‡, ä¹Ÿä¸ä»…ä»…éœ€è¦å‘é‡ç±»å‹å’Œå‘é‡ç´¢å¼•. æ›´ä½•å†µæ˜¯æœ‰å…¶ä»–ç±»åˆ«å­—æ®µçš„è¿‡æ»¤æ¡ä»¶æ—¶.   
- [ã€Šä¸ºä»€ä¹ˆç”¨äº†RAG, æˆ‘çš„AIè¿˜æ˜¯ç¬¨å¾—è·ŸçŒªä¸€æ ·! RAGæ•ˆæœè¯„æµ‹ä¸ä¼˜åŒ–ã€‹](../202504/20250414_04.md)    
- [ã€Šç»´åŸºç™¾ç§‘(wikipedia) RAG ä¼˜åŒ– | PolarDB + AIã€‹](../202504/20250417_01.md)    
- [ã€Šå¬å›ç²¾åº¦æå‡æ’ä»¶: pg_tokenizer + VectorChord-BM25 rerankingã€‹](../202504/20250427_04.md)    
    
3ã€äº‘å’Œæ•°æ®åº“éƒ½æ˜¯åŸºç¡€è®¾æ–½, å¤§å¤šæ•°åº”ç”¨éƒ½ä¼šéƒ¨ç½²åœ¨äº‘ä¸Š, å¤§å¤šæ•°äººä¼šä½¿ç”¨äº‘æ•°æ®åº“ (å¹¿ä¹‰çš„, åŒ…æ‹¬ä»»ä½•ç”¨ç®¡æ§æ­å»ºçš„æ•°æ®åº“æœåŠ¡)      
    
4ã€å¤§è„‘åˆ†ä¸ºç†æ€§è„‘(æ¨ç†) + æ„Ÿæ€§è„‘(ä½å¤æ‚åº¦ä»»åŠ¡), LLMä¹Ÿä¸€æ ·. ä½†æ˜¯æ¨ç†ç”¨åˆ°çš„transformeræ¶æ„éœ€è¦ä»å‰Nä¸ªtokenå»è®¡ç®—ä¸‹é¢tokençš„æ¦‚ç‡, æ‰€ä»¥è¿ç®—é‡è¾ƒå¤§, è¿™é‡Œå°±è¯ç”Ÿäº†kvcacheåŠ é€Ÿæ¨ç†çš„åº”ç”¨æ¶æ„.  
  
æ˜¾ç„¶, redis çœ‹é‡çš„æ˜¯kvcacheè¿™å—.    
  
å†ä¸å›æ¥å°±æ²¡å®ƒå•¥äº‹äº†, å„å¤§äº‘å‚å•†è‡ªå·±åœ¨ækvcacheäº§å“.     
  
  
  
## KV Cacheåœ¨LLMä¸­çš„ä½œç”¨  
ä»¥ä¸‹æ¥è‡ªQwen3.   
  
åœ¨å¤§è¯­è¨€æ¨¡å‹ï¼ˆ**LLM, Large Language Models**ï¼‰ä¸­ï¼Œ**KV Cacheï¼ˆKey-Value Cacheï¼‰** æ˜¯ä¸€ç§ç”¨äº **åŠ é€Ÿæ¨ç†è¿‡ç¨‹** çš„å…³é”®æŠ€æœ¯ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†**è‡ªå›å½’ç”Ÿæˆä»»åŠ¡**ï¼ˆå¦‚æ–‡æœ¬ç”Ÿæˆã€å¯¹è¯ç­‰ï¼‰æ—¶éå¸¸å…³é”®ã€‚  
  
  
## ğŸ§  ä»€ä¹ˆæ˜¯ KV Cacheï¼Ÿ  
  
> **KV Cache æ˜¯ Transformer æ¨¡å‹åœ¨è§£ç è¿‡ç¨‹ä¸­ç¼“å­˜ Key å’Œ Value å‘é‡çš„æœºåˆ¶**ï¼Œç›®çš„æ˜¯é¿å…åœ¨æ¯ä¸€æ­¥é‡å¤è®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼Œä»è€Œæ˜¾è‘—æé«˜æ¨ç†é€Ÿåº¦ã€‚  
  
  
## ğŸ” èƒŒæ™¯ï¼šTransformer çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶  
  
åœ¨ Transformer æ¶æ„ä¸­ï¼Œæ¯ä¸ª token çš„è¾“å‡ºä¾èµ–äºæ‰€æœ‰ä¹‹å‰ token çš„ Key å’Œ Value å‘é‡ã€‚è¿™æ„å‘³ç€ï¼š  
  
- åœ¨ç”Ÿæˆç¬¬ $ t $ ä¸ª token æ—¶ï¼Œéœ€è¦é‡æ–°è®¡ç®—å‰ $ t-1 $ ä¸ª token çš„ Key å’Œ Valueã€‚  
- å¦‚æœæ¯æ¬¡éƒ½ä»å¤´å¼€å§‹è®¡ç®—ï¼Œæ—¶é—´å¤æ‚åº¦ä¼šæ˜¯ $ O(t^2) $ï¼Œæ•ˆç‡æä½ã€‚  
  
  
## ğŸš€ KV Cache çš„ä½œç”¨  
  
### âœ… æ ¸å¿ƒåŠŸèƒ½ï¼š  
- **ç¼“å­˜å·²ç”Ÿæˆ token çš„ Key å’Œ Value å‘é‡**  
- **é¿å…é‡å¤è®¡ç®—æ³¨æ„åŠ›çŸ©é˜µä¸­çš„å†å²ä¿¡æ¯**  
  
### ğŸ’¡ åŸç†å›¾ç¤ºï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š  
  
```plaintext  
[Input] â†’ Embedding â†’ Q, K, V â†’ Attention(Q, K, V) â†’ Output  
```  
  
- ç¬¬ä¸€æ¬¡è¾“å…¥ä¸€ä¸ª prompt æˆ–åˆå§‹ tokenï¼Œè®¡ç®—å‡º Qã€Kã€Vã€‚  
- åœ¨åç»­ç”Ÿæˆ token æ—¶ï¼Œåªè®¡ç®—å½“å‰ token çš„ Qï¼Œè€Œå¤ç”¨ä¹‹å‰çš„ K å’Œ Vï¼ˆæ¥è‡ª KV Cacheï¼‰ã€‚  
- è¿™æ ·å¯ä»¥å°†æ¯æ¬¡æ³¨æ„åŠ›è®¡ç®—çš„æ—¶é—´å¤æ‚åº¦ä» $ O(n^2) $ é™ä½åˆ° $ O(n) $ã€‚  
  
  
## ğŸ“Š KV Cache çš„æ€§èƒ½ä¼˜åŠ¿  
  
| åœºæ™¯ | ä¸ä½¿ç”¨ KV Cache | ä½¿ç”¨ KV Cache |  
|------|------------------|----------------|  
| ç”Ÿæˆç¬¬ 100 ä¸ª token | éœ€è¦è®¡ç®— 100 Ã— 100 = 10,000 é¡¹ | åªéœ€è®¡ç®— 100 + 1 = 101 é¡¹ |  
| æ€»ä½“å¤æ‚åº¦ | $ O(n^2) $ | $ O(n) $ |  
  
> âš ï¸ æ³¨æ„ï¼šKV Cache æœ¬èº«ä¹Ÿéœ€è¦å ç”¨å†…å­˜ï¼Œå°¤å…¶æ˜¯é•¿æ–‡æœ¬æˆ–é«˜ç»´å‘é‡æ—¶ï¼Œä½†å…¶å¸¦æ¥çš„æ¨ç†åŠ é€Ÿæ•ˆæœé€šå¸¸è¿œå¤§äºå†…å­˜å¼€é”€ã€‚  
  
  
## ğŸ§© å®ç°æ–¹å¼ï¼ˆä»¥ HuggingFace Transformers ä¸ºä¾‹ï¼‰  
  
ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ä¼ªä»£ç ç‰‡æ®µï¼Œå±•ç¤º KV Cache å¦‚ä½•è¢«ä½¿ç”¨ï¼š  
  
```python  
# åˆå§‹è°ƒç”¨ï¼Œä¸å¸¦ cache  
outputs = model(input_ids)  
past_key_values = outputs.past_key_values  
  
# åç»­ç”Ÿæˆæ­¥éª¤ï¼Œä½¿ç”¨ cache  
for i in range(num_steps):  
    outputs = model(  
        input_ids=next_token_id,  
        past_key_values=past_key_values  
    )  
    past_key_values = outputs.past_key_values  # æ›´æ–° cache  
```  
  
- `past_key_values` å°±æ˜¯ KV Cacheã€‚  
- æ¯æ¬¡è°ƒç”¨æ¨¡å‹æ—¶ä¼ å…¥è¿™ä¸ªå‚æ•°ï¼Œæ¨¡å‹å°±çŸ¥é“å“ªäº› Key/Value å·²ç»ç®—è¿‡ï¼Œå¯ä»¥ç›´æ¥å¤ç”¨ã€‚  
  
  
## ğŸ§° æ”¯æŒ KV Cache çš„ä¸»æµæ¡†æ¶å’Œæ¨¡å‹  
  
| æ¡†æ¶ / æ¨¡å‹ | æ˜¯å¦æ”¯æŒ KV Cache | å¤‡æ³¨ |  
|-------------|-------------------|------|  
| **HuggingFace Transformers** | âœ… | è‡ªåŠ¨ç®¡ç† past_key_values |  
| **PyTorch / TensorFlow** | âœ… | éœ€æ‰‹åŠ¨å®ç°ç¼“å­˜é€»è¾‘ |  
| **vLLM / TensorRT-LLM** | âœ… | ä¼˜åŒ–äº† KV Cache çš„å­˜å‚¨ä¸è®¿é—® |  
| **Llama.cpp** | âœ… | æ”¯æŒé«˜æ•ˆçš„æœ¬åœ°ç¼“å­˜æœºåˆ¶ |  
| **DeepSpeed** | âœ… | æ”¯æŒåŠ¨æ€ç¼“å­˜ä¼˜åŒ– |  
  
  
## ğŸš¨ æ³¨æ„äº‹é¡¹  
  
| é¡¹ç›® | è¯´æ˜ |  
|------|------|  
| **å†…å­˜å ç”¨** | KV Cache ä¼šå ç”¨å¤§é‡ GPU æ˜¾å­˜ï¼Œå°¤å…¶å¯¹é•¿æ–‡æœ¬æ¥è¯´ |  
| **ä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶** | å¾ˆå¤šæ¨¡å‹é»˜è®¤ KV Cache æœ€å¤§é•¿åº¦ä¸º 2048 æˆ– 4096 |  
| **å¹¶è¡Œç”Ÿæˆ** | å¦‚æœè¿›è¡Œ batched generationï¼ŒKV Cache ç®¡ç†ä¼šæ›´å¤æ‚ |  
| **æµå¼ç”Ÿæˆï¼ˆStreamingï¼‰** | ä¸€äº›æ¨¡å‹æ”¯æŒé€ token è¿”å›ç»“æœï¼Œå¹¶ç»´æŠ¤ KV Cache |  
  
  
## ğŸ§  åº”ç”¨åœºæ™¯  
  
| åº”ç”¨ | æè¿° |  
|------|------|  
| **å¯¹è¯ç³»ç»Ÿ** | å¿«é€Ÿå“åº”ç”¨æˆ·é—®é¢˜ï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§ |  
| **AI å†™ä½œåŠ©æ‰‹** | å®æ—¶ç”Ÿæˆé«˜è´¨é‡æ–‡ç« ï¼Œæå‡ç”¨æˆ·ä½“éªŒ |  
| **è¯­éŸ³è½¬æ–‡å­—åç«¯** | å¿«é€Ÿè¯†åˆ«å’Œç”Ÿæˆå›å¤ |  
| **API æ¥å£æœåŠ¡** | æä¾›ä½å»¶è¿Ÿã€é«˜å¹¶å‘çš„è¯­è¨€æ¨¡å‹æ¨ç†æœåŠ¡ |  
  
  
## âœ… æ€»ç»“ä¸€å¥è¯  
  
> **KV Cache æ˜¯ LLM æ¨ç†åŠ é€Ÿçš„å…³é”®æŠ€æœ¯ä¹‹ä¸€ï¼Œé€šè¿‡ç¼“å­˜å†å²çš„ Key å’Œ Value å‘é‡ï¼Œå¤§å¹…å‡å°‘é‡å¤è®¡ç®—ï¼Œä½¿ç”Ÿæˆè¿‡ç¨‹æ›´é«˜æ•ˆã€æ›´æµç•…ã€‚**  
  
  
å¦‚æœä½ å¸Œæœ›æˆ‘æä¾›å…·ä½“çš„ KV Cache å®ç°ä»£ç ï¼ˆå¦‚ PyTorch æˆ– HuggingFaceï¼‰ï¼Œæˆ–è€…æƒ³äº†è§£å¦‚ä½•åœ¨ vLLM ä¸­ä½¿ç”¨å®ƒï¼Œæ¬¢è¿ç»§ç»­æé—® ğŸ˜Š  
  
  
#### [æœŸæœ› PostgreSQL|å¼€æºPolarDB å¢åŠ ä»€ä¹ˆåŠŸèƒ½?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB å¼€æºæ•°æ®åº“](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB å­¦ä¹ å›¾è°±](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL è§£å†³æ–¹æ¡ˆé›†åˆ](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [å¾·å“¥ / digoal's Github - å…¬ç›Šæ˜¯ä¸€è¾ˆå­çš„äº‹.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About å¾·å“¥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
