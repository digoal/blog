## Ceph Cache Tiering 功能替代方案: LVM Cache 实践
                                      
### 作者                                      
digoal                                      
                                      
### 日期                                      
2025-08-12                                      
                                      
### 标签                                      
PostgreSQL , PolarDB , DuckDB , 共享存储 , 块设备 , pfs , direct io , ceph , 2层存储架构 , ssd , 机械盘 , 缓存层 , 存储层 , bcache , flashcache , zfs l2arc , lvm cache      
                                      
----                                      
                                      
## 背景  
接上2篇:  
- [《PolarDB存算分离共享存储 : Ceph SSD+机械盘 2层存储 典型配置实践》](../202508/20250812_03.md)
- [《Ceph Cache Tiering 功能替代方案》](../202508/20250812_07.md)
  
本篇分享: 作为Ceph存储层的机械盘故障, 如何更换?  
   
使用 LVM Cache 为多块机械硬盘配置 SSD 缓存，需要遵循几个关键步骤。这个过程主要包括创建物理卷（PV）、卷组（VG），然后为每块机械硬盘（作为**数据卷**）创建一个逻辑卷（LV），并为每个数据卷分配一个来自 SSD 的缓存逻辑卷（**缓存池**）。  
  
假设我的环境如下：    
   
有1块名为`nvme1n1`的ssd, 分了4个区, 分别给4块机械盘`/dev/sd[b-e]`使用.   
  
下面是详细的配置步骤，假设你的 NVMe SSD 是 `/dev/nvme1n1`，已经划分了四个分区 `/dev/nvme1n1p1` 到 `/dev/nvme1n1p4`，四块机械硬盘是 `/dev/sdb` 到 `/dev/sde`。  
  
### 1\. 准备物理卷（PV）

首先，你需要将所有的设备都标记为 LVM 物理卷。

```bash
sudo pvcreate /dev/sdb /dev/sdc /dev/sdd /dev/sde
sudo pvcreate /dev/nvme1n1p1 /dev/nvme1n1p2 /dev/nvme1n1p3 /dev/nvme1n1p4
```

### 2\. 创建卷组（VG）

为了管理这些设备，你需要创建卷组。一个好的做法是为每个机械硬盘创建一个单独的卷组，这样可以更好地隔离和管理。

```bash
sudo vgcreate vg_sdb /dev/sdb
sudo vgcreate vg_sdc /dev/sdc
sudo vgcreate vg_sdd /dev/sdd
sudo vgcreate vg_sde /dev/sde

# 将SSD分区也加入到对应的卷组
sudo vgextend vg_sdb /dev/nvme1n1p1
sudo vgextend vg_sdc /dev/nvme1n1p2
sudo vgextend vg_sdd /dev/nvme1n1p3
sudo vgextend vg_sde /dev/nvme1n1p4
```

### 3\. 创建数据逻辑卷（LV）和缓存池（Cache Pool）

现在，为每个卷组创建一个数据逻辑卷，并使用对应的 SSD 分区创建缓存池。

-----

**为 `sdb` 和 `nvme1n1p1` 配置：**

1.  **创建数据逻辑卷**：
    这个命令创建了一个名为 `lv_sdb` 的逻辑卷，使用了 `/dev/sdb` 的全部空间。

    ```bash
    sudo lvcreate -l 100%FREE -n lv_sdb vg_sdb
    ```

2.  **创建缓存池**：
    这个命令在 `vg_sdb` 卷组上，使用 `/dev/nvme1n1p1` 创建了一个名为 `cache_sdb` 的缓存池。`-n` 后面是缓存池的名字，`-y` 后面是缓存池的大小，`-c` 后面是块大小，`-t` 表示创建 `thin-pool`，这里我们用 `cache-pool`。

    ```bash
    sudo lvcreate -y cache_sdb -L 100%FREE vg_sdb
    ```

3.  **将数据卷与缓存池关联**：
    将 `lv_sdb` 数据卷与 `cache_sdb` 缓存池关联起来。

    ```bash
    sudo lvconvert --type cache-mode --cache-pool cache_sdb vg_sdb/lv_sdb
    ```

-----

**为 `sdc` 和 `nvme1n1p2` 配置：**

1.  **创建数据逻辑卷**：

    ```bash
    sudo lvcreate -l 100%FREE -n lv_sdc vg_sdc
    ```

2.  **创建缓存池**：

    ```bash
    sudo lvcreate -y cache_sdc -L 100%FREE vg_sdc
    ```

3.  **将数据卷与缓存池关联**：

    ```bash
    sudo lvconvert --type cache-mode --cache-pool cache_sdc vg_sdc/lv_sdc
    ```

-----

**为 `sdd` 和 `nvme1n1p3` 配置：**

1.  **创建数据逻辑卷**：

    ```bash
    sudo lvcreate -l 100%FREE -n lv_sdd vg_sdd
    ```

2.  **创建缓存池**：

    ```bash
    sudo lvcreate -y cache_sdd -L 100%FREE vg_sdd
    ```

3.  **将数据卷与缓存池关联**：

    ```bash
    sudo lvconvert --type cache-mode --cache-pool cache_sdd vg_sdd/lv_sdd
    ```

-----

**为 `sde` 和 `nvme1n1p4` 配置：**

1.  **创建数据逻辑卷**：

    ```bash
    sudo lvcreate -l 100%FREE -n lv_sde vg_sde
    ```

2.  **创建缓存池**：

    ```bash
    sudo lvcreate -y cache_sde -L 100%FREE vg_sde
    ```

3.  **将数据卷与缓存池关联**：

    ```bash
    sudo lvconvert --type cache-mode --cache-pool cache_sde vg_sde/lv_sde
    ```

完成以上步骤后，你就成功地为每块机械硬盘配置了独立的 SSD 缓存。现在，LVM 会自动使用 SSD 分区来缓存对机械硬盘的读写操作。这些新的逻辑卷 `/dev/mapper/vg_sdb-lv_sdb`、`/dev/mapper/vg_sdc-lv_sdc` 等就是你需要在 Ceph OSD 配置中使用的设备。

**一些关键点：**

  * **缓存模式（Cache Mode）**：LVM Cache 默认使用 `writethrough` 模式，即数据同时写入缓存和后端存储。你也可以使用 `writeback` 模式，它会将数据先写入缓存，再异步写入后端存储，通常能提供更高的性能。你可以通过 `lvconvert` 命令的 `--cache-mode writeback` 选项来设置。
  * **缓存块大小（Chunk Size）**：默认块大小通常为 64KB，可以通过 `lvcreate` 命令的 `-c` 参数来调整。
  * **Ceph 集成**：在配置 Ceph OSD 时，你需要将 `ceph-volume` 指向这些新的逻辑卷，例如：
    ```bash
    ceph-volume lvm create --osd-id 0 --data /dev/vg_sdb/lv_sdb
    ```
    这样，Ceph OSD 就会使用带有 LVM Cache 的逻辑卷。
   
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
