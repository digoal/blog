## PolarDB PFS mkfs 大机械盘慢的原因和优化思路  
                                            
### 作者                                            
digoal                                            
                                            
### 日期                                            
2025-08-13                                            
                                            
### 标签                                            
PostgreSQL , PolarDB , DuckDB , 地理信息 , GIS , 空间 JOIN , PostGIS , spatial , SPATIAL_JOIN    
                                            
----                                            
                                            
## 背景     
  
# 一、pfs mkfs一个50TB的盘(30块机械硬盘组建的Ceph RBD)花费5000多秒, 有没有办法优化?  
  
## Answer  
  
您询问的是PFS (PolarDB File System) 的 `mkfs` 命令在50TB磁盘上执行时间过长的优化问题。根据代码分析，`pfs mkfs` 命令在大容量存储设备上的性能瓶颈主要来自以下几个方面：  
  
### 当前mkfs实现的性能瓶颈  
  
`pfs mkfs` 命令的核心实现在 `cmd_mkfs` 函数中，主要包含两个阶段  ：  
  
1. **文件系统结构初始化**：通过 `pfs_make()` 函数逐个初始化所有chunks    
2. **Paxos和Journal文件创建**：创建系统必需的内部文件    
  
### 主要性能问题  
  
**Chunk初始化的串行处理**：`pfs_make()` 函数对每个chunk进行串行初始化  。对于50TB存储，按照默认的10GB chunk大小计算，需要初始化约5000个chunks，每个chunk的初始化都涉及多次磁盘写入操作。  
  
**元数据写入密集**：每个chunk的初始化包括三种元数据集的创建（blktag、direntry、inode），每种都需要多次磁盘写入  。  
  
### 可能的优化方案  
  
1. **并行化chunk初始化**：修改 `pfs_make()` 函数，使用多线程并行初始化chunks，可以显著减少总体时间。  
  
2. **批量写入优化**：在 `metaset_init()` 函数中，当前是逐页写入元数据  ，可以改为批量写入多个页面。  
  
3. **预分配优化**：考虑使用更大的写入缓冲区，减少系统调用次数。  
  
4. **跳过非必要初始化**：对于大容量存储，可以考虑延迟初始化某些元数据结构，只在实际使用时再创建。  
  
## Notes  
  
当前的mkfs实现是为了保证数据一致性而采用的保守方法，任何优化都需要确保不影响文件系统的可靠性。建议在测试环境中验证优化效果，特别是在机械硬盘组成的Ceph RBD这种相对较慢的存储介质上。  
  
---  
  
# 二、通过pfs mkfs配置参数能起到优化效果吗? 优化后是否对空间使用带来浪费问题?  
  
  
## Answer  
  
您询问的是通过 `pfs mkfs` 配置参数来优化50TB磁盘格式化性能的问题。根据代码分析，`pfs mkfs` 命令确实提供了一些可配置参数，但对于您遇到的性能问题，这些参数的优化效果有限。  
  
### 可用的mkfs配置参数  
  
`pfs mkfs` 命令支持以下配置参数  ：  
  
1. **`-l` (log-size)**：设置journal文件大小，默认为1GB    
2. **`-s` (sector-size)**：设置扇区大小，默认为4096字节    
3. **`-u` (num-users)**：设置最大用户数，默认为30    
4. **`-f` (force)**：强制格式化选项  
  
### 参数优化效果分析  
  
**对性能影响有限的原因**：  
  
1. **核心瓶颈在chunk初始化**：主要性能瓶颈在 `pfs_make()` 函数的串行chunk初始化过程  ，这个过程不受上述参数影响。  
  
2. **Journal文件大小调整效果微小**：虽然可以通过 `-l` 参数调整journal文件大小，但journal文件创建只是mkfs过程的最后阶段  ，对总体时间影响很小。  
  
### 空间使用考虑  
  
**参数调整对空间的影响**：  
  
1. **减小journal文件大小**：可以通过 `-l` 参数减小journal文件大小来节省空间，但需要在性能和空间之间权衡  。  
  
2. **扇区大小影响**：调整 `-s` 参数可能影响空间利用率，但通常不建议修改默认值。  
  
3. **用户数设置**：`-u` 参数主要影响并发访问能力，对空间使用影响很小。  
  
### 建议  
  
对于您的50TB磁盘格式化性能问题，**仅通过配置参数优化效果非常有限** 。真正的优化需要在代码层面进行，比如并行化chunk初始化过程。当前的参数主要用于功能配置而非性能优化。  
  
## Notes  
  
当前的mkfs实现采用保守的串行初始化策略以确保数据一致性。如果需要显著的性能提升，建议考虑修改 `pfs_make()` 函数实现并行化chunk初始化，但这需要在代码层面进行修改，而不是通过配置参数。  
  
---
  
# 三、Ceph的存储后端优化思路

关于30块16TB机械硬盘组成的Ceph RBD设备（类似RAID6冗余度，50TB容量）在执行`mkfs`时非常慢的优化问题。

根据代码库上下文，这个问题涉及Ceph的存储后端优化，特别是针对机械硬盘（HDD）的配置优化。

## 主要优化配置

### OSD分片和线程配置优化

从发布说明中可以看到，Ceph已经针对HDD集群的性能问题进行了重要的默认配置调整：  

这些配置变更的核心是：
- `osd_op_num_shards_hdd = 1`（原来是5）
- `osd_op_num_threads_per_shard_hdd = 5`（原来是1）

这个调整是基于大规模HDD集群测试发现，多个OSD分片在mClock调度下性能不佳，改为单分片多线程模式能显著提升一致性和吞吐量。

### BlueStore后端优化

对于您的场景，BlueStore是默认的存储后端。  

BlueStore的`mkfs`操作涉及初始化文件系统结构，包括分配器、元数据存储等组件的初始化。

### mClock调度器优化

最新版本中mClock调度器进行了重大改进：  

关键优化包括：
- 使用`balanced`配置文件作为默认值
- QoS参数现在基于OSD IOPS容量的分数（0.0-1.0）指定
- 移除了成本参数，改为基于设备能力自动计算

## 具体优化建议

1. **调整OSD分片配置**：
   ```
   ceph config set osd osd_op_num_shards_hdd 1
   ceph config set osd osd_op_num_threads_per_shard_hdd 5
   ```

2. **优化mClock调度器**：
   - 确保使用`balanced`配置文件
   - 根据工作负载选择`high_client_ops`或`high_recovery_ops`配置文件

3. **BlueStore RocksDB优化**：
   根据发布说明，新版本默认启用了LZ4压缩来改善性能：  

## Notes

这些优化主要针对运行时性能，对于`mkfs`初始化过程的加速效果可能有限。`mkfs`慢主要是因为需要初始化大量的元数据结构和分配器状态。考虑到您的50TB容量和RAID6类似的冗余配置，初始化时间较长是正常的。如果问题持续，建议检查网络延迟、磁盘I/O性能和集群拓扑配置。
  
  
  
## 参考  
https://deepwiki.com/ApsaraDB/PolarDB-FileSystem/  
    
https://deepwiki.com/ceph/ceph  
  
  
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
