## PolarDB PFS mkfs 大机械盘慢的原因和优化思路  
                                            
### 作者                                            
digoal                                            
                                            
### 日期                                            
2025-08-13                                            
                                            
### 标签                                            
PostgreSQL , PolarDB , DuckDB , 地理信息 , GIS , 空间 JOIN , PostGIS , spatial , SPATIAL_JOIN    
                                            
----                                            
                                            
## 背景     
  
# pfs mkfs一个50TB的盘(30块机械硬盘组建的Ceph RBD)花费5000多秒, 有没有办法优化?  
  
## Answer  
  
您询问的是PFS (PolarDB File System) 的 `mkfs` 命令在50TB磁盘上执行时间过长的优化问题。根据代码分析，`pfs mkfs` 命令在大容量存储设备上的性能瓶颈主要来自以下几个方面：  
  
### 当前mkfs实现的性能瓶颈  
  
`pfs mkfs` 命令的核心实现在 `cmd_mkfs` 函数中，主要包含两个阶段  ：  
  
1. **文件系统结构初始化**：通过 `pfs_make()` 函数逐个初始化所有chunks    
2. **Paxos和Journal文件创建**：创建系统必需的内部文件    
  
### 主要性能问题  
  
**Chunk初始化的串行处理**：`pfs_make()` 函数对每个chunk进行串行初始化  。对于50TB存储，按照默认的10GB chunk大小计算，需要初始化约5000个chunks，每个chunk的初始化都涉及多次磁盘写入操作。  
  
**元数据写入密集**：每个chunk的初始化包括三种元数据集的创建（blktag、direntry、inode），每种都需要多次磁盘写入  。  
  
### 可能的优化方案  
  
1. **并行化chunk初始化**：修改 `pfs_make()` 函数，使用多线程并行初始化chunks，可以显著减少总体时间。  
  
2. **批量写入优化**：在 `metaset_init()` 函数中，当前是逐页写入元数据  ，可以改为批量写入多个页面。  
  
3. **预分配优化**：考虑使用更大的写入缓冲区，减少系统调用次数。  
  
4. **跳过非必要初始化**：对于大容量存储，可以考虑延迟初始化某些元数据结构，只在实际使用时再创建。  
  
## Notes  
  
当前的mkfs实现是为了保证数据一致性而采用的保守方法，任何优化都需要确保不影响文件系统的可靠性。建议在测试环境中验证优化效果，特别是在机械硬盘组成的Ceph RBD这种相对较慢的存储介质上。  
  
---  
  
# 通过pfs mkfs配置参数能起到优化效果吗? 优化后是否对空间使用带来浪费问题?  
  
  
## Answer  
  
您询问的是通过 `pfs mkfs` 配置参数来优化50TB磁盘格式化性能的问题。根据代码分析，`pfs mkfs` 命令确实提供了一些可配置参数，但对于您遇到的性能问题，这些参数的优化效果有限。  
  
### 可用的mkfs配置参数  
  
`pfs mkfs` 命令支持以下配置参数  ：  
  
1. **`-l` (log-size)**：设置journal文件大小，默认为1GB    
2. **`-s` (sector-size)**：设置扇区大小，默认为4096字节    
3. **`-u` (num-users)**：设置最大用户数，默认为30    
4. **`-f` (force)**：强制格式化选项  
  
### 参数优化效果分析  
  
**对性能影响有限的原因**：  
  
1. **核心瓶颈在chunk初始化**：主要性能瓶颈在 `pfs_make()` 函数的串行chunk初始化过程  ，这个过程不受上述参数影响。  
  
2. **Journal文件大小调整效果微小**：虽然可以通过 `-l` 参数调整journal文件大小，但journal文件创建只是mkfs过程的最后阶段  ，对总体时间影响很小。  
  
### 空间使用考虑  
  
**参数调整对空间的影响**：  
  
1. **减小journal文件大小**：可以通过 `-l` 参数减小journal文件大小来节省空间，但需要在性能和空间之间权衡  。  
  
2. **扇区大小影响**：调整 `-s` 参数可能影响空间利用率，但通常不建议修改默认值。  
  
3. **用户数设置**：`-u` 参数主要影响并发访问能力，对空间使用影响很小。  
  
### 建议  
  
对于您的50TB磁盘格式化性能问题，**仅通过配置参数优化效果非常有限** 。真正的优化需要在代码层面进行，比如并行化chunk初始化过程。当前的参数主要用于功能配置而非性能优化。  
  
## Notes  
  
当前的mkfs实现采用保守的串行初始化策略以确保数据一致性。如果需要显著的性能提升，建议考虑修改 `pfs_make()` 函数实现并行化chunk初始化，但这需要在代码层面进行修改，而不是通过配置参数。  
  
## 参考  
https://deepwiki.com/ApsaraDB/PolarDB-FileSystem/1-overview  
  
