## PostgreSQL 19 preview - PL/Python支持事件触发器了  
                                              
### 作者                                              
digoal                                              
                                              
### 日期                                              
2025-08-25                                              
                                              
### 标签                                              
PostgreSQL , PolarDB , DuckDB , event trigger , 事件触发器
                                              
----                                              
                                              
## 背景     
Event Trigger 是 PostgreSQL 用于拦截/响应 DDL 事件（如 CREATE TABLE、DROP FUNCTION 等）的机制。通过 PostgreSQL 19 这个 patch，现在你可以用 Python 脚本（PL/Python）来处理这些事件，比如做自动审核、DDL 日志、权限校验等。

本次 patch（53eff471c69dc8b0c01f046d3fdcc460eb90d0e5）为 PostgreSQL 的 PL/Python 增加了 event trigger（事件触发器）支持。其主要内容如下：

- 允许用 PL/Python 编写 event trigger（事件触发器）。
- 事件触发器函数会收到一个 TD（trigger data）字典，里面包含了触发事件相关的信息。
  
  
---

**PL/Python Event Trigger 示例**

比如，你希望监控所有的 CREATE TABLE 语句，并打印相关信息，可以这样做：

```sql
-- 1. 确保已安装 plpython3u
CREATE EXTENSION IF NOT EXISTS plpython3u;

-- 2. 创建 event trigger 函数
CREATE OR REPLACE FUNCTION py_event_trigger()
RETURNS event_trigger
LANGUAGE plpython3u
AS $$
    # TD 是触发器数据字典
    event = TD['event']
    tag = TD['tag']
    print("Event Triggered: %s, Tag: %s" % (event, tag))
$$;

-- 3. 创建 event trigger，打印所有 CREATE 相关事件的日志
CREATE EVENT TRIGGER trg_py_ddl
    ON ddl_command_start
    WHEN TAG IN ('CREATE TABLE')
    EXECUTE FUNCTION py_event_trigger();
```

**实际场景举例：**
- 审计所有 CREATE TABLE 操作，把信息写入日志表或外部系统。
- 拦截 DROP FUNCTION，阻止删除某些敏感函数。
- 对 DDL 操作做自定义安全检查，或自动同步元数据等。

如需更复杂的处理，可在 Python 代码内访问 TD 字典的其他字段（如 object_type、schema_name、command_tag 等），并结合 SQL 查询、外部 API 等。

    
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
