## PostgreSQL 代码追踪分析: pg_uprobe    
                                                    
### 作者                                                    
digoal                                                    
                                                    
### 日期                                                    
2025-09-02                                                    
                                                    
### 标签                                                    
PostgreSQL , PolarDB , DuckDB , 动态代码注入 , pg_uprobe , 分析性能   
                                                    
----                                                    
                                                    
## 背景       
`pg_uprobe` 是一个 PostgreSQL 扩展，用于在会话中进行查询追踪和分析。它利用 Frida 和 Frida Gum 库进行动态代码注入，因此不需要修改 PostgreSQL 的源代码。  
  
该项目提供了两个主要功能：  
  
1.  **会话追踪 (Session Tracing)**：  
    * **目的**：追踪会话中执行的所有查询，记录查询文本、解析、规划和执行所花费的时间，以及查询计划和等待事件（如文件读取或锁等待）所花费的时间。  
    * **用途**：帮助识别耗时或资源消耗大的操作。  
    * **使用示例**：  
        * 追踪当前会话：在 SQL 客户端中执行 `SELECT pg_uprobe.uprobe_trace_session(0);`  
        * 追踪其他会话：如果知道其他会话的进程 ID (PID)，执行 `SELECT pg_uprobe.uprobe_trace_session(<pid>);`  
        * **注意**：追踪功能会带来约 5% 的性能下降，不建议长时间启用。  
  
2.  **剖析 PostgreSQL 函数 (Profiling PostgreSQL Functions)**：  
    * **目的**：对于熟悉 PostgreSQL 源代码的高级用户，可以在 C 函数上设置动态探针来分析其性能。  
    * **探针类型**：  
        * `TIME`：测量函数执行时间。  
        * `HIST`：测量函数执行时间并构建直方图。  
        * `MEM`：测量函数执行前后内存变化。  
    * **使用示例**：  
        * **设置探针**：使用 SQL 函数 `pg_uprobe.uprobe_trace_function`。例如，要追踪 `insert` 函数的执行时间，可以执行 `SELECT pg_uprobe.uprobe_trace_function('insert', 'TIME');`  
        * **结果查询**：探针结果会写入 PostgreSQL 的日志文件，可以通过查看日志来获取分析数据。  
  
**注意**：由于 `pg_uprobe` 的动态代码注入特性，建议在测试或开发环境中谨慎使用，并确保您了解其潜在的性能影响。  
  
更多例子参考:  
- https://github.com/postgrespro/pg_uprobe  
    
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
