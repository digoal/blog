## 大学生数据库实践课-PostgreSQL本地学习镜像的使用  
  
### 作者  
digoal  
  
### 日期  
2025-09-03  
  
### 标签  
PostgreSQL , PolarDB , DuckDB , 大学生 , 数据库 , 应用 , 使用 , 实践课 , AI , 教学  
  
----  
  
## 背景  
配合 [《大学生数据库实践课设计》](../202509/20250903_06.md) , [《大学生数据库实践课开课了 : 1 大纲》](../202512/20251202_10.md)  使用.  
  
该数据库镜像包括PostgreSQL 18及插件(pgvector, pgvectorscale, vectorchord, vectorchord-bm25, pg_tokenizer, pg_search, postgresml, pg_jieba, pg_bigm , pgroonga, postgis, 以及PG内置插件), DuckDB及插件(duckdbpgq) ;  
  
x86_64 镜像:  
  
ARM64 镜像:  
  
Dockerfile, 见附录.  
  
## PostgreSQL 本地学习镜像的使用  
  
1、安装Docker Desktop(用来运行数据库 Docker 容器). 略  
  
2、配置docker mirror (`Settings - Docker Engine`)  
```  
{  
  "builder": {  
    "gc": {  
      "defaultKeepStorage": "20GB",  
      "enabled": true  
    }  
  },  
  "experimental": true,  
  "max-concurrent-downloads": 1,  
  "max-concurrent-uploads": 1,  
  "registry-mirrors": [  
    "https://docker.mirrors.ustc.edu.cn",  
    "https://registry.cn-hangzhou.aliyuncs.com",  
    "https://mirror.ccs.tencentyun.com",  
    "https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com",  
    "https://registry.docker-cn.com",  
    "http://hub-mirror.c.163.com",  
    "http://f1361db2.m.daocloud.io",  
    "https://mul8ko9f.mirror.aliyuncs.com"  
  ]  
}  
```  
  
如果mirror还是不行, 可使用隧道和代理(需海外有服务器), 参考:  
- [《ssh隧道》](../202310/20231029_01.md)  
- [《squid代理》](../202407/20240704_01.md)  
- [《容器中github clone无法联网问题解决》](../202403/20240327_01.md)  
  
3、拉取postgres 最新版本 docker镜像  
  
镜像官网: https://hub.docker.com/_/postgres/  
  
镜像Dockerfile(更多使用说明可参考该Dockerfile): https://github.com/docker-library/postgres   ( 例如: https://github.com/docker-library/postgres/blob/master/18/bookworm/Dockerfile  
 )  
  
基础镜像包括debian最新稳定版trixie和上一个稳定版bookworm, 默认为debian最新稳定版trixie, 不过我个人较为喜欢使用上一个稳定版bookworm.  
  
```  
docker pull postgres:18-bookworm  
```  
  
4、使用镜像创建容器  
  
在宿主机创建volume目录, 用于存放PostgreSQL实例数据文件等, 注意PG 18的Docker镜像开始对volumn做了个修改, 数据在卷的子目录中, 而不是直接放到卷中. 因此我们不需要映射两个volumn来区分数据和备份.  
```  
mkdir -p ~/pgdocker_data  
```  
  
配置几个变量, 创建容器  
```  
cd ~/pgdocker_data  
PG_DATA=`pwd`  
PG_USER="postgres"  
PG_PASSWORD="123456"  
PG_MAJOR="18"  
  
docker run -d -it -p 0.0.0.0:1921:5432 --add-host=host.docker.internal:host-gateway \
  -u root -w /var/lib/postgresql -e LANG=en_US.utf8 \
  -e POSTGRES_INITDB_ARGS="-E UTF8 --locale=C --lc-ctype=en_US.utf8" \
  -v $PG_DATA:/var/lib/postgresql \
  -e PGDATA=/var/lib/postgresql/$PG_MAJOR/docker \
  --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --shm-size=1g \
  -e POSTGRES_USER=$PG_USER -e POSTGRES_PASSWORD=$PG_PASSWORD \
  --name pg1 postgres:18-bookworm  
```  
  
说明:  
- `5432` 是postgres容器默认监听端口, 通过容器`-e PGPORT=...`环境变量可进行配置.  
- `-p 1921:5432` 表示将容器内的5432端口映射到宿主机的1921端口, 在宿主机上可通过本机回环地址访问容器中的数据库.  
- `--add-host=host.docker.internal:host-gateway` 让B容器可通过`host.docker.internal`域名访问A容器映射到宿主机的端口, 解决B容器有访问A容器内数据库的需求!  
- 从容器内访问宿主机, 采用域名: `host.docker.internal`  
- 卷映射到容器内的目录为: `/var/lib/postgresql`  
- 数据目录在这里: `/var/lib/postgresql/$PG_MAJOR/docker`  
  
5、进入容器, 变更常用配置  
```  
docker exec -ti pg1 bash  
```  
  
配置root用户bash环境变量  
```  
echo "alias ll='ls -larth'  
alias rm='rm -i'  
alias cp='cp -i'  
alias mv='mv -i'  
export PGUSER=postgres" >> /root/.bashrc  
  
# 使环境变量生效  
. /root/.bashrc  
```  
  
配置postgres用户bash环境变量  
```  
echo "alias ll='ls -larth'  
alias rm='rm -i'  
alias cp='cp -i'  
alias mv='mv -i'" >> /var/lib/postgresql/.bash_profile  
  
chown postgres:postgres /var/lib/postgresql/.bash_profile  
```  
  
  
使用阿里云debian bookworm apt镜像源  
```  
echo "# Debian 12 Bookworm 阿里云镜像源  
deb http://mirrors.aliyun.com/debian/ bookworm main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian/ bookworm main contrib non-free non-free-firmware  
  
deb http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free non-free-firmware  
  
deb http://mirrors.aliyun.com/debian/ bookworm-backports main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian/ bookworm-backports main contrib non-free non-free-firmware  
  
deb http://mirrors.aliyun.com/debian-security/ bookworm-security main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian-security/ bookworm-security main contrib non-free non-free-firmware" > /etc/apt/sources.list  
  
  
mv /etc/apt/sources.list.d/debian.sources /etc/apt/sources.list.d/debian.sources.bak  
```  
  
6、使用apt安装插件举例  
  
参考postgis Dockerfile相应操作系统版本的内容安装postgis : https://github.com/postgis/docker-postgis   ( 例如: https://github.com/postgis/docker-postgis/blob/master/18-3.6/Dockerfile )  
  
容器root用户操作, 安装PostGIS插件  
```  
PG_MAJOR=18  
POSTGIS_MAJOR=3  
  
apt-get update \
  && apt-cache showpkg postgresql-$PG_MAJOR-postgis-$POSTGIS_MAJOR \
  && apt-get install -y --no-install-recommends \
       ca-certificates \
       postgresql-$PG_MAJOR-postgis-$POSTGIS_MAJOR \
       postgresql-$PG_MAJOR-postgis-$POSTGIS_MAJOR-scripts  
  
# 无需执行如下命令, 除非你要用来制作docker image  
# rm -rf /var/lib/apt/lists/*  
```  
  
注: 每次清空`/var/lib/apt/lists`后, 要先执行`apt-get update`生成`lists`, 否则无法使用`apt-get install` .  
  
搜索当前可安装插件:  
```  
apt search postgresql-18-  
  
  
# 截取部分如下  
apt search postgresql-18-|grep "postgresql-18-"|grep -v dbgsym|grep -v "debug symbols"  
  
postgresql-18-asn1oid/bookworm-pgdg 1.6-3.pgdg12+1 arm64  
postgresql-18-auto-failover/bookworm-pgdg 2.2-3.pgdg12+1 arm64  
postgresql-18-bgw-replstatus/bookworm-pgdg 1.0.8-2.pgdg12+1 arm64  
postgresql-18-credcheck/bookworm-pgdg 4.2-1.pgdg12+1 arm64  
postgresql-18-cron/bookworm-pgdg 1.6.7-2.pgdg12+1 arm64  
postgresql-18-debversion/bookworm-pgdg 1.2.0-3.pgdg12+1 arm64  
postgresql-18-decoderbufs/bookworm-pgdg 3.3.1-1.pgdg12+1 arm64  
postgresql-18-dirtyread/bookworm-pgdg 2.7-3.pgdg12+1 arm64  
postgresql-18-extra-window-functions/bookworm-pgdg 1.0-7.pgdg12+1 arm64  
postgresql-18-first-last-agg/bookworm-pgdg 0.1.4-4-gd63ea3b-9.pgdg12+1 arm64  
postgresql-18-h3/bookworm-pgdg 4.2.3-2.pgdg12+1 arm64  
postgresql-18-hll/bookworm-pgdg 2.19-1.pgdg12+1 arm64  
postgresql-18-http/bookworm-pgdg 1.7.0-3.pgdg12+1 arm64  
postgresql-18-hypopg/bookworm-pgdg 1.4.2-2.pgdg12+1 arm64  
postgresql-18-icu-ext/bookworm-pgdg 1.10.0-2.pgdg12+1 arm64  
postgresql-18-ip4r/bookworm-pgdg 2.4.2-4.pgdg12+1 arm64  
postgresql-18-jit/bookworm-pgdg,now 18.1-1.pgdg12+2 arm64 [installed]  
postgresql-18-jsquery/bookworm-pgdg 1.2-3.pgdg12+1 arm64  
postgresql-18-londiste-sql/bookworm-pgdg 3.8-7.pgdg12+1 all  
postgresql-18-mimeo/bookworm-pgdg 1.5.1-20.pgdg12+1 all  
postgresql-18-mobilitydb/bookworm-pgdg 1.3.0~alpha-3.pgdg12+1 arm64  
postgresql-18-mysql-fdw/bookworm-pgdg 2.9.3-2.pgdg12+1 arm64  
postgresql-18-numeral/bookworm-pgdg 1.3-8.pgdg12+1 arm64  
postgresql-18-ogr-fdw/bookworm-pgdg 1.1.7-2.pgdg12+1 arm64  
postgresql-18-oracle-fdw/bookworm-pgdg 2.8.0-2.pgdg12+1 arm64  
postgresql-18-orafce/bookworm-pgdg 4.16.3-1.pgdg12+1 arm64  
postgresql-18-partman/bookworm-pgdg 5.3.1-2.pgdg12+1 arm64  
postgresql-18-periods/bookworm-pgdg 1.2.3-2.pgdg12+1 arm64  
postgresql-18-pg-catcheck/bookworm-pgdg 1.6.0-2.pgdg12+1 arm64  
postgresql-18-pg-checksums/bookworm-pgdg 1.3-2.pgdg12+1 arm64  
postgresql-18-pg-crash/bookworm-pgdg 0.3-2.pgdg12+1 arm64  
postgresql-18-pg-failover-slots/bookworm-pgdg 1.2.0-1.pgdg12+1 arm64  
postgresql-18-pg-hint-plan/bookworm-pgdg 1.8.0-2.pgdg12+1 arm64  
postgresql-18-pg-permissions/bookworm-pgdg 1.4-2.pgdg12+1 all  
postgresql-18-pg-qualstats/bookworm-pgdg 2.1.3-1.pgdg12+1 arm64  
postgresql-18-pg-rewrite/bookworm-pgdg 2.0.0-2.pgdg12+1 arm64  
postgresql-18-pg-rrule/bookworm-pgdg 0.2.0+git20211101.d7d10f2-4.pgdg12+1 arm64  
postgresql-18-pg-stat-kcache/bookworm-pgdg 2.3.1-1.pgdg12+1 arm64  
postgresql-18-pg-stat-plans/bookworm-pgdg 2.0.0-1.pgdg12+1 arm64  
postgresql-18-pg-track-settings/bookworm-pgdg 2.1.2-5.pgdg12+1 all  
postgresql-18-pg-wait-sampling/bookworm-pgdg 1.1.9-2.pgdg12+1 arm64  
postgresql-18-pgaudit/bookworm-pgdg 18.0-2.pgdg12+1 arm64  
postgresql-18-pgauditlogtofile/bookworm-pgdg 1.7.6-1.pgdg12+1 arm64  
postgresql-18-pgextwlist/bookworm-pgdg 1.19-2.pgdg12+1 arm64  
postgresql-18-pgfaceting/bookworm-pgdg 0.2.0-5.pgdg12+1 all  
postgresql-18-pglogical/bookworm-pgdg 2.4.6-1.pgdg12+1 arm64  
postgresql-18-pgmemcache/bookworm-pgdg 2.3.0-15.pgdg12+1 arm64  
postgresql-18-pgmp/bookworm-pgdg 1.0.5-4.pgdg12+1 arm64  
postgresql-18-pgnodemx/bookworm-pgdg 1.7-2.pgdg12+1 arm64  
postgresql-18-pgpcre/bookworm-pgdg 0.20190509-9.pgdg12+1 arm64  
postgresql-18-pgpool2/bookworm-pgdg 4.6.4-1.pgdg12+1 arm64  
postgresql-18-pgq-node/bookworm-pgdg 3.5-8.pgdg12+1 all  
postgresql-18-pgq3/bookworm-pgdg 3.5.1-2.pgdg12+1 arm64  
postgresql-18-pgrouting/bookworm-pgdg 4.0.0-1.pgdg12+1 arm64  
postgresql-18-pgrouting-scripts/bookworm-pgdg 4.0.0-1.pgdg12+1 all  
postgresql-18-pgsentinel/bookworm-pgdg 1.3.0-1.pgdg12+1 arm64  
postgresql-18-pgsphere/bookworm-pgdg 1.5.2-1.pgdg12+1 arm64  
postgresql-18-pgtap/bookworm-pgdg 1.3.4-1.pgdg12+1 all  
postgresql-18-pgtt/bookworm-pgdg 4.4-2.pgdg12+1 arm64  
postgresql-18-pgvector/bookworm-pgdg 0.8.1-2.pgdg12+1 arm64  
postgresql-18-pldebugger/bookworm-pgdg 1:1.9-1.pgdg12+1 arm64  
postgresql-18-pljs/bookworm-pgdg 1.0.3-2.pgdg12+1 arm64  
postgresql-18-pllua/bookworm-pgdg 1:2.0.12-6.pgdg12+1 arm64  
postgresql-18-plpgsql-check/bookworm-pgdg 2.8.4-1.pgdg12+1 arm64  
postgresql-18-plprofiler/bookworm-pgdg 4.2.5-4.pgdg12+1 arm64  
postgresql-18-plproxy/bookworm-pgdg 2.11.0-13.pgdg12+1 arm64  
postgresql-18-plr/bookworm-pgdg 1:8.4.8.2-1.pgdg12+1 arm64  
postgresql-18-plsh/bookworm-pgdg 1.20220917-4.pgdg12+1 arm64  
postgresql-18-pointcloud/bookworm-pgdg 1.2.5-3.pgdg12+1 arm64  
postgresql-18-postgis-3/bookworm-pgdg,now 3.6.1+dfsg-1.pgdg12+1 arm64 [installed]  
postgresql-18-postgis-3-scripts/bookworm-pgdg,now 3.6.1+dfsg-1.pgdg12+1 all [installed]  
postgresql-18-powa/bookworm-pgdg 5.1.0-2.pgdg12+1 arm64  
postgresql-18-prefix/bookworm-pgdg 1.2.10-4.pgdg12+1 arm64  
postgresql-18-preprepare/bookworm-pgdg 0.9-9.pgdg120+1 arm64  
postgresql-18-prioritize/bookworm-pgdg 1.0.4-13.pgdg12+1 arm64  
postgresql-18-q3c/bookworm-pgdg 2.0.1-6.pgdg12+1 arm64  
postgresql-18-rational/bookworm-pgdg 0.0.2-8.pgdg12+1 arm64  
postgresql-18-repack/bookworm-pgdg 1.5.3-1.pgdg12+1 arm64  
postgresql-18-repmgr/bookworm-pgdg 5.5.0+debpgdg-3.pgdg12+1 arm64  
postgresql-18-roaringbitmap/bookworm-pgdg 1.1.0-1.pgdg12+1 arm64  
postgresql-18-rum/bookworm-pgdg 1.3.15-1.pgdg12+1 arm64  
postgresql-18-semver/bookworm-pgdg 0.40.0-3.pgdg12+1 arm64  
postgresql-18-set-user/bookworm-pgdg 4.2.0-1.pgdg12+1 arm64  
postgresql-18-show-plans/bookworm-pgdg 2.1.7-1.pgdg12+1 arm64  
postgresql-18-similarity/bookworm-pgdg 1.0-9.pgdg12+1 arm64  
postgresql-18-snakeoil/bookworm-pgdg 1.4-3.pgdg12+1 arm64  
postgresql-18-squeeze/bookworm-pgdg 1.9.1-3.pgdg12+1 arm64  
postgresql-18-statviz/bookworm-pgdg 0.8-1.pgdg12+1 all  
postgresql-18-tablelog/bookworm-pgdg 0.6.4-4.pgdg12+1 arm64  
postgresql-18-tdigest/bookworm-pgdg 1.4.3-2.pgdg12+1 arm64  
postgresql-18-tds-fdw/bookworm-pgdg 2.0.5-1.pgdg12+1 arm64  
postgresql-18-timescaledb/bookworm-pgdg 2.23.1+dfsg-1.pgdg12+1 arm64  
postgresql-18-toastinfo/bookworm-pgdg 1.5-3.pgdg12+1 arm64  
postgresql-18-unit/bookworm-pgdg 7.10-2.pgdg12+1 arm64  
postgresql-18-wal2json/bookworm-pgdg 2.6-3.pgdg12+1 arm64  
```  
  
例如, 安装 vector 插件  
```  
apt-get install -y postgresql-18-pgvector  
  
psql  
postgres=# create extension vector;  
CREATE EXTENSION  
postgres=# \dx  
                              List of installed extensions  
   Name   | Version |   Schema   |                     Description  
----------+---------+------------+------------------------------------------------------  
 plpgsql  | 1.0     | pg_catalog | PL/pgSQL procedural language  
 vector   | 0.8.1   | public     | vector data type and ivfflat and hnsw access methods  
(2 rows)  
```  
  
继续安装 pgroonga 插件: https://github.com/pgroonga/pgroonga , 参考 https://pgroonga.github.io/install/debian.html  
  
```  
cd /var/lib/postgresql/bak  
apt install -y -V ca-certificates lsb-release wget  
wget https://packages.groonga.org/debian/groonga-apt-source-latest-$(lsb_release --codename --short).deb  
apt-get install -y -V ./groonga-apt-source-latest-$(lsb_release --codename --short).deb  
apt update  
apt-get install -y -V postgresql-18-pgdg-pgroonga  
apt-get install -y -V groonga-tokenizer-mecab  
```  
  
7、使用源码安装插件举例  
  
安装必要的工具包  
```  
apt-get update \
  && apt-get install -y git build-essential gcc g++ cmake postgresql-server-dev-18  
```  
  
pg_jieba插件 : https://github.com/jaiminpan/pg_jieba/blob/master/README.md  
  
容器postgres用户操作, 编译pg_jieba插件  
```  
su - postgres  
  
  
mkdir /var/lib/postgresql/bak  
cd /var/lib/postgresql/bak  
git clone --depth 1 https://github.com/jaiminpan/pg_jieba  
cd pg_jieba  
  
  
# 下载依赖  
git submodule update --init --recursive  
  
mkdir build  
cd build  
  
# 得到include dir  
pg_config |grep "INCLUDEDIR-SERVER"  
  
# 编译pg_jieba  
cmake -DPostgreSQL_TYPE_INCLUDE_DIR="/usr/include/postgresql/18/server" ..  
  
make -j 4  
```  
  
容器root用户操作, 安装pg_jieba插件到postgresql相应目录中  
```  
# 退到root用户中  
cd /var/lib/postgresql/bak/pg_jieba/build  
make install  
```  
  
日志如下  
```  
root@99125c5e3122:/var/lib/postgresql/bak/pg_jieba/build# make install  
[100%] Built target pg_jieba  
Install the project...  
-- Install configuration: ""  
-- Installing: /usr/lib/postgresql/18/lib/pg_jieba.so  
-- Installing: /usr/share/postgresql/18/extension/pg_jieba.control  
-- Installing: /usr/share/postgresql/18/extension/pg_jieba--1.1.1.sql  
-- Installing: /usr/share/postgresql/18/tsearch_data/jieba_base.dict  
-- Installing: /usr/share/postgresql/18/tsearch_data/jieba_hmm.model  
-- Installing: /usr/share/postgresql/18/tsearch_data/jieba_user.dict  
-- Installing: /usr/share/postgresql/18/tsearch_data/jieba.stop  
-- Installing: /usr/share/postgresql/18/tsearch_data/jieba.idf  
```  
  
现已可使用pg_jieba插件  
```  
root@438e88670555:/var/lib/postgresql/bak/pg_jieba/build# su - postgres  
postgres@438e88670555:~$ psql  
psql (18.1 (Debian 18.1-1.pgdg12+2))  
Type "help" for help.  
  
postgres=# create extension pg_jieba ;  
CREATE EXTENSION  
postgres=# select * from to_tsquery('jiebacfg', '是拖拉机学院手扶拖拉机专业的。不用多久，我就会升职加薪，当上CEO，走上人生巅峰。');  
                                                                                       to_tsquery  
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
 '拖拉机' <-> '学院' <-> '手扶拖拉机' <-> '专业' <3> '不用' <-> '多久' <4> '会' <-> '升职' <-> '加薪' <2> '当上' <-> 'ceo' <2> '走上' <-> '人生' <-> '巅峰'  
(1 row)  
  
postgres=# select * from to_tsvector('jiebacfg', '是拖拉机学院手扶拖拉机专业的。不用多久，我就会升职加薪，当上CEO，走上人生巅峰。');  
                                                                               to_tsvector  
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
 'ceo':18 '不用':8 '专业':5 '人生':21 '会':13 '加薪':15 '升职':14 '多久':9 '学院':3 '巅峰':22 '当上':17 '手扶拖拉机':4 '拖拉机':2 '走上':20  
(1 row)  
```  
  
继续安装 pg_bigm 插件: https://github.com/pgbigm/pg_bigm  
  
```  
cd /var/lib/postgresql/bak  
git clone --depth 1 https://github.com/pgbigm/pg_bigm  
cd pg_bigm  
USE_PGXS=1 make install  
```  
  
### 编译安装rust写的PG插件  
以 VectorChord 插件为例.  
  
使用容器 root 用户安装.  
  
1、安装依赖包  
```  
apt-get install -y curl pkg-config build-essential libgmp-dev libmpfr-dev libmpc-dev vim  
```  
  
2、安装rust编译环境  
```  
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh  
  
# 使rustc , cargo路径生效  
. "$HOME/.cargo/env"  
  
  
which rustc  
/root/.cargo/bin/rustc  
  
which cargo  
/root/.cargo/bin/cargo  
```  
  
3、安装gcc-14 (vectorchord 依赖simd, 需要gcc-14以上版本支持)  
```  
cd /var/lib/postgresql/bak  
curl https://mirrors.aliyun.com/gnu/gcc/gcc-14.3.0/gcc-14.3.0.tar.xz -o ./gcc-14.3.0.tar.xz  
tar -xvf gcc-14.3.0.tar.xz  
  
cd gcc-14.3.0  
```  
  
<b>注意这样编译非常耗时!  可以跳过, 用后面的方法来加速.  </b>  
```  
./configure --prefix=/usr/local/gcc-14  
  
make -j$(nproc)  
make install  
```  
  
<b>加速gcc编译: 如果你只需要 gcc 和 g++，不要编译 Ada, Java, Fortran 等语言支持。</b>  
- `--enable-languages=c,c++` 只编译 C/C++，跳过其他语言（节省 50%+ 时间）  
- `--disable-multilib` 不生成 32 位兼容库（x86_64 上可选）  
- `--disable-bootstrap` 跳过三阶段自举（用于开发调试，生产可关）  
- `--enable-checking=release` 减少断言检查  
  
```  
./configure --prefix=/usr/local/gcc-14  \
  --enable-languages=c,c++ \
  --disable-multilib \
  --disable-bootstrap \
  --enable-checking=release  
  
make -j$(nproc) CFLAGS="-O2" CXXFLAGS="-O2" \
  BOOT_CFLAGS="-O2" \
  BUILD_CONFIG=bootstrap-debug  
  
make install  
```  
  
5、下载并编译安装vectorchord  
```  
cd /var/lib/postgresql/bak  
  
git clone --depth 1 -b 1.0.0 https://github.com/tensorchord/VectorChord  
  
cd VectorChord  
  
# 安装依赖的 pgrx 对应版本  
grep pgrx Cargo.toml | grep version  
# 得到 0.16.1  
  
cargo install --locked cargo-pgrx --version 0.16.1  
  
cargo pgrx init    # create PGRX_HOME 后, 立即ctrl^c 退出    或者可以直接使用 mkdir /root/.pgrx ; export PGRX_HOME="/root/.pgrx"  替代这个步骤?  
  
cargo pgrx init --pg18=`which pg_config`  
  
# 指定 gcc 二进制特定版本  
CC=/usr/local/gcc-14/bin/gcc CXX=/usr/local/gcc-14/bin/g++ cargo pgrx install --release --pg-config `which pg_config`  
```  
  
6、配置vchord插件  
```  
# 修改数据库配置参数shared_preload_libraries  
vi /var/lib/postgresql/18/docker/postgresql.conf  
  
shared_preload_libraries = 'vchord'  
```  
  
在宿主机上重启容器  
```  
docker stop pg1  
docker start pg1  
```  
  
回到容器postgres用户, 进入postgresql shell继续执行  
```  
docker exec -ti pg1 bash  
su - postgres  
psql  
  
# 进入数据库后即可创建vchord插件  
postgres=# create extension vchord ;  
CREATE EXTENSION  
```  
  
你可以参照以上方法, 尝试编译下面几个插件:  
- https://github.com/tensorchord/pg_tokenizer.rs  
- https://github.com/tensorchord/VectorChord-bm25  
- https://github.com/timescale/pgvectorscale  
- https://github.com/paradedb/paradedb  
- https://github.com/postgresml/postgresml  
  
pg_tokenizer.rs  
```  
cd /var/lib/postgresql/bak  
git clone --depth 1 https://github.com/tensorchord/pg_tokenizer.rs  
cd pg_tokenizer.rs  
CC=/usr/local/gcc-14/bin/gcc CXX=/usr/local/gcc-14/bin/g++ cargo pgrx install --release --pg-config `which pg_config`  
```  
  
VectorChord-bm25  
```  
cd /var/lib/postgresql/bak  
git clone --depth 1 https://github.com/tensorchord/VectorChord-bm25  
cd VectorChord-bm25  
CC=/usr/local/gcc-14/bin/gcc CXX=/usr/local/gcc-14/bin/g++ cargo pgrx install --release --pg-config `which pg_config`  
```  
  
pgvectorscale  
```  
cd /var/lib/postgresql/bak  
git clone --depth 1 --branch 0.9.0 https://github.com/timescale/pgvectorscale  
cd pgvectorscale/pgvectorscale  
CC=/usr/local/gcc-14/bin/gcc CXX=/usr/local/gcc-14/bin/g++ cargo pgrx install --release --pg-config `which pg_config`  
```  
  
pg_search (截止 2025.12.04 尚未支持pg18, 否则可安装如下)  
```  
cd /var/lib/postgresql/bak  
git clone --depth 1 --branch 支持18的branch https://github.com/paradedb/paradedb  
cd paradedb/pg_search  
CC=/usr/local/gcc-14/bin/gcc CXX=/usr/local/gcc-14/bin/g++ cargo pgrx install --release --pg-config `which pg_config`  
```  
  
  
postgresml (截止 2025.12.04 尚未支持pg18, 否则可安装如下)  
```  
cd /var/lib/postgresql/bak  
git clone --depth 1 --branch 支持18的branch https://github.com/postgresml/postgresml  
cd postgresml/pgml-extension  
CC=/usr/local/gcc-14/bin/gcc CXX=/usr/local/gcc-14/bin/g++ cargo pgrx install --release --pg-config `which pg_config`  
```  
  
  
-----  
  
## 部署duckdb  
截止2025.12.04 , duckdbpgq插件暂未支持duckdb v1.4.2, 所以使用 v1.4.1 版本duckdb 二进制.  
  
1、部署 duckdb v1.4.2 (忽略)  
```  
curl https://install.duckdb.org | sh  
echo "export PATH='/root/.duckdb/cli/latest':\$PATH" >> /root/.bashrc  
  
# 使环境变量生效  
. /root/.bashrc  
```  
  
2、部署 duckdb v1.4.1 (根据CPU架构选择)  
```  
mkdir -p /root/.duckdb/cli/1.4.1  
cd /var/lib/postgresql/bak  
wget https://github.com/duckdb/duckdb/releases/download/v1.4.1/duckdb_cli-linux-arm64.gz  
gunzip duckdb_cli-linux-arm64.gz  
chmod +x duckdb_cli-linux-arm64  
mv duckdb_cli-linux-arm64 /root/.duckdb/cli/1.4.1/duckdb  
rm -f /root/.duckdb/cli/latest
ln -s /root/.duckdb/cli/1.4.1 /root/.duckdb/cli/latest  
  
echo "export PATH='/root/.duckdb/cli/latest':\$PATH" >> /root/.bashrc  
  
# 使环境变量生效  
. /root/.bashrc  
```  
  
3、加载duckdbpgq插件  
```  
duckdb  
DuckDB v1.4.1 (Andium) b390a7c376  
Enter ".help" for usage hints.  
Connected to a transient in-memory database.  
Use ".open FILENAME" to reopen on a persistent database.  
D install duckpgq from community;  
100% ▕██████████████████████████████████████▏ (00:00:03.74 elapsed)  
D load duckpgq;  
```  
  
  
-----  
  
到目前为止, postgresql 容器可方便的用于学习使用了.  
  
查询当前支持的所有插件  
```  
postgres=# select * from pg_available_extensions;  
```  
  
## 使用 pgadmin4 容器  
pgadmin4 是PostgreSQL图形化工具, 可使用容器进行部署.  
  
**注: Navicat 也可管理 PostgreSQL, 而且安装更简单! ( https://www.navicat.com.cn/ )**  
  
由于PostgreSQL也运行在本机的容器内, 在 pgadmin4 的容器中, 可使用前面提到的`host.docker.internal`域名+PG容器映射到本机的`port`来访问PG容器中的数据库.  
  
https://hub.docker.com/r/dpage/pgadmin4  
  
https://www.pgadmin.org/docs/pgadmin4/latest/container_deployment.html  
  
拉取 pgadmin4 容器镜像  
```  
docker pull dpage/pgadmin4  
```  
  
启动 pgadmin4 容器  
```  
# 配置变量  
PGADMIN_USER="user@domain.com"  
PGADMIN_PWD="123456"  
PGADMIN_IP="0.0.0.0"  
PGADMIN_PORT="80"  
MAP_PORT="8888"  
  
# 启动容器  
docker run -p 0.0.0.0:$MAP_PORT:$PGADMIN_PORT \
    -e PGADMIN_DEFAULT_EMAIL=$PGADMIN_USER \
    -e PGADMIN_DEFAULT_PASSWORD=$PGADMIN_PWD \
    -e PGADMIN_LISTEN_ADDRESS=$PGADMIN_IP \
    -e PGADMIN_LISTEN_PORT=$PGADMIN_PORT \
    --name pgadmin \
    -d dpage/pgadmin4  
```  
  
在宿主机上, 用浏览器通过`127.0.0.1:8888`访问pgadmin4.  配置方法举例:  
```  
右击server图标, 注册...服务器...常规, 给个名字 例如 pg1  
连接... 主机名/地址... host.docker.internal  
       端口...1921  
       用户名...postgres  (容器中已创建的数据库用户, 例如postgres)  
       密码...123456  (容器中数据库用户postgres用户密码)  
```  
  
## 附: 删除容器、清理目录  
1、如果容器不要了, 并且数据也不要了, 可在宿主机停止容器, 并清理宿主机数据目录.  
  
```  
docker stop pg1  
docker rm pg1  
rm -rf ~/pgdocker_data  
```  
  
2、如果不删除容器, 停止后, 下次可start后进入容器使用  
```  
docker stop pg1  
docker start pg1  
docker exec -ti pg1 bash  
```  
  
3、如果删除容器 但是 不删除数据目录. 下次创建容器可再使用该目录作为`PG_DATA`, 则会复用该目录的数据文件, 相当于使用其作为数据文件目录启动数据库实例(数据被保留).  
  
## 附: 上传docker image到阿里云个人公共镜像仓库, 便于本土下载使用  
为了解决容器本土下载问题, 除了使用mirror, 我将其推送到了阿里云的个人公共镜像库ACR中.  
- https://cr.console.aliyun.com/cn-hangzhou/instance/dashboard  
  
注意镜像有2种常用架构`arm64`和`amd64`, 需分别推送.  
  
1、arm64  
  
由于我的本地环境是macOS M2芯片(属于arm64), 所以之前下载好的postgres和pgadmin4镜像都是arm64架构的, 先将其打标上传.  
  
postgres 17镜像  
```  
# 查询image id  
docker images postgres:17-bookworm  
  
REPOSITORY   TAG           IMAGE ID       CREATED       SIZE  
postgres     17-bookworm   f77910dd2614   2 weeks ago   460MB  
  
# 打标  
docker tag f77910dd2614 registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:postgres-17-bookworm-arm64  
  
# 上传  
docker push registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:postgres-17-bookworm-arm64  
```  
  
pgadmin4 镜像  
```  
# 查询image id  
docker images dpage/pgadmin4  
  
REPOSITORY       TAG       IMAGE ID       CREATED       SIZE  
dpage/pgadmin4   latest    ec7e7003fdcd   2 weeks ago   547MB  
  
# 打标  
docker tag ec7e7003fdcd registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pgadmin4-arm64  
  
# 上传  
docker push registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pgadmin4-arm64  
```  
  
2、amd64  
  
postgres 17镜像  
```  
# 指定 linux/amd64 架构拉取镜像(arm64为 linux/arm64)  
docker pull --platform linux/amd64 postgres:17-bookworm  
  
# 查询image id  
docker images postgres:17-bookworm  
  
REPOSITORY   TAG           IMAGE ID       CREATED       SIZE  
postgres     17-bookworm   8deb3f4444be   2 weeks ago   438MB  
  
# 打标  
docker tag 8deb3f4444be registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:postgres-17-bookworm-amd64  
  
# 上传  
docker push registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:postgres-17-bookworm-amd64  
```  
  
pgadmin4 镜像  
```  
# 指定 linux/amd64 架构拉取镜像(arm64为 linux/arm64)  
docker pull --platform linux/amd64 dpage/pgadmin4  
  
# 查询image id  
docker images dpage/pgadmin4  
  
REPOSITORY       TAG       IMAGE ID       CREATED       SIZE  
dpage/pgadmin4   latest    67b145ae2a39   2 weeks ago   534MB  
  
# 打标  
docker tag 67b145ae2a39 registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pgadmin4-amd64  
  
# 上传  
docker push registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pgadmin4-amd64  
```  
  
3、现在你可直接从以上仓库直接拉取这几个docker镜像了.  
```  
registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:postgres-17-bookworm-arm64  
registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pgadmin4-arm64  
  
registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:postgres-17-bookworm-amd64  
registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pgadmin4-amd64  
```  
  
例如  
```  
docker pull registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:postgres-17-bookworm-arm64  
  
mkdir -p ~/pgdocker_data/data1  
mkdir -p ~/pgdocker_data/bak

cd ~/pgdocker_data/data1  
PG_DATA=`pwd`
cd ~/pgdocker_data/bak 
BAK_DIR=`pwd`
PG_USER="postgres"  
PG_PASSWORD="123456"  
PG_MAJOR="17"  
  
docker run -d -it -p 0.0.0.0:1922:5432 --add-host=host.docker.internal:host-gateway \
  -u root -w /var/lib/postgresql -e LANG=en_US.utf8 \
  -e POSTGRES_INITDB_ARGS="-E UTF8 --locale=C --lc-ctype=en_US.utf8" \
  -v $BAK_DIR:/var/lib/postgresql/bak \
  -e PGDATA=/var/lib/postgresql/$PG_MAJOR/docker \
  --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --shm-size=1g \
  -e POSTGRES_USER=$PG_USER -e POSTGRES_PASSWORD=$PG_PASSWORD \
  --name pg2 registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:postgres-17-bookworm-arm64  
```  
  
  
  
## 参考  
- [《2023-PostgreSQL Docker镜像学习环境 AMD64版, 已集成热门插件和工具》](../202307/20230710_03.md)  
- [《2023-PostgreSQL Docker镜像学习环境 ARM64版, 已集成热门插件和工具》](../202308/20230814_02.md)  
- https://github.com/docker-library/docs/blob/master/postgres/README.md  
- https://hub.docker.com/_/postgres/  
- https://github.com/docker-library/postgres  
- https://hub.docker.com/r/postgis/postgis/  
- https://github.com/postgis/docker-postgis  
- https://hub.docker.com/r/dpage/pgadmin4  
- https://www.pgadmin.org/download/pgadmin-4-container/  
- [《ssh隧道》](../202310/20231029_01.md)  
- [《squid代理》](../202407/20240704_01.md)  
- [《容器中github clone无法联网问题解决》](../202403/20240327_01.md)  
  
  
  
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")  
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")  
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")  
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")  
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")  
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")  
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")  
  
