## 大学生数据库实践课-PostgreSQL本地学习镜像的使用    
                                                                                
### 作者                                                    
digoal                                                    
                                                           
### 日期                                                         
2025-09-03                                                    
                                                        
### 标签                                                      
PostgreSQL , PolarDB , DuckDB , 大学生 , 数据库 , 应用 , 使用 , 实践课 , AI , 教学      
                                                                               
----                                                        
                                                                      
## 背景    
配合 [《大学生数据库实践课设计》](../202509/20250903_06.md) 使用.  
  
## PostgreSQL 本地学习镜像的使用  
  
1、安装Docker Desktop. 略    
  
2、配置docker mirror (`Settings - Docker Engine`)  
```  
{
  "builder": {
    "gc": {
      "defaultKeepStorage": "20GB",
      "enabled": true
    }
  },
  "experimental": true,
  "max-concurrent-downloads": 1,
  "max-concurrent-uploads": 1,
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://registry.cn-hangzhou.aliyuncs.com",
    "https://mirror.ccs.tencentyun.com",
    "https://05f073ad3c0010ea0f4bc00b7105ec20.mirror.swr.myhuaweicloud.com",
    "https://registry.docker-cn.com",
    "http://hub-mirror.c.163.com",
    "http://f1361db2.m.daocloud.io",
    "https://mul8ko9f.mirror.aliyuncs.com"
  ]
}
```  
  
如果mirror还是不行, 可使用隧道和代理(需海外有服务器), 参考:   
- [《ssh隧道》](../202310/20231029_01.md)    
- [《squid代理》](../202407/20240704_01.md)    
- [《容器中github clone无法联网问题解决》](../202403/20240327_01.md)  
  
3、拉取postgres docker镜像  
  
镜像官网: https://hub.docker.com/_/postgres/    
  
镜像Dockerfile(更多使用说明可参考该Dockerfile): https://github.com/docker-library/postgres    
  
基础镜像包括debian最新稳定版trixie和上一个稳定版bookworm, 默认为debian最新稳定版trixie, 不过我个人较为喜欢使用上一个稳定版bookworm.    
  
```  
docker pull postgres:17-bookworm  
```  
  
4、使用镜像创建容器  
  
在宿主机创建2个volume目录, 用于存放PostgreSQL实例数据文件、另一个bak目录为空, 临时文件、下载的源代码等可以存放于此, 区别于PG实例的数据目录.  
```  
# 注意: data必须是空目录, 否则启动容器时initdb会报错
mkdir -p ~/pgdocker_data/data  
mkdir -p ~/pgdocker_data/bak  
```  
  
配置几个变量, 创建容器  
```  
cd ~/pgdocker_data/data  
PG_DATA=`pwd`  
cd ~/pgdocker_data/bak  
BAK_DIR=`pwd`  
PG_USER="postgres"  
PG_PASSWORD="123456"  
  
docker run -d -it -P -u root -w /var/lib/postgresql -e LANG=en_US.utf8 \
  -e POSTGRES_INITDB_ARGS="-E UTF8 --locale=C --lc-ctype=en_US.utf8" \
  -v $BAK_DIR:/var/lib/postgresql/bak \
  -v $PG_DATA:/var/lib/postgresql/data \
  --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --shm-size=1g \
  -e POSTGRES_USER=$PG_USER -e POSTGRES_PASSWORD=$PG_PASSWORD \
  --name pg1 postgres:17-bookworm
```  
  
5、进入容器, 变更常用配置  
```  
docker exec -ti pg1 bash  
```  
  
配置root用户bash环境变量  
```  
echo "alias ll='ls -larth'  
alias rm='rm -i'  
alias cp='cp -i'  
alias mv='mv -i'  
export PGUSER=postgres" >> /root/.bashrc  

# 使环境变量生效
. /root/.bashrc  
```  
  
配置postgres用户bash环境变量  
```  
echo "alias ll='ls -larth'  
alias rm='rm -i'  
alias cp='cp -i'  
alias mv='mv -i'" >> /var/lib/postgresql/.bash_profile  
  
chown postgres:postgres /var/lib/postgresql/.bash_profile  
```  

  
使用阿里云debian bookworm apt镜像源  
```  
echo "# Debian 12 Bookworm 阿里云镜像源  
deb http://mirrors.aliyun.com/debian/ bookworm main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian/ bookworm main contrib non-free non-free-firmware  
  
deb http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free non-free-firmware  
  
deb http://mirrors.aliyun.com/debian/ bookworm-backports main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian/ bookworm-backports main contrib non-free non-free-firmware  
  
deb http://mirrors.aliyun.com/debian-security/ bookworm-security main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian-security/ bookworm-security main contrib non-free non-free-firmware" > /etc/apt/sources.list  
  
  
mv /etc/apt/sources.list.d/debian.sources /etc/apt/sources.list.d/debian.sources.bak  
```  
  
6、使用apt安装插件举例  
  
参考postgis Dockerfile相应操作系统版本的内容安装postgis : https://github.com/postgis/docker-postgis    
  
容器root用户操作, 安装PostGIS插件  
```  
PG_MAJOR="17"  
POSTGIS_MAJOR="3"  
  
apt-get update \
  && apt-cache showpkg postgresql-$PG_MAJOR-postgis-$POSTGIS_MAJOR \
  && apt-get install -y \
       ca-certificates \
       postgresql-$PG_MAJOR-postgis-$POSTGIS_MAJOR \
       postgresql-$PG_MAJOR-postgis-$POSTGIS_MAJOR-scripts \
  && rm -rf /var/lib/apt/lists/*
```  
   
注意, 每次清空`/var/lib/apt/lists`后, 要先执行`apt-get update`生成`lists`, 否则无法使用`apt-get install` .  
  
搜索当前可安装插件:
```
apt search postgresql-17-


# 截取部分如下
apt search postgresql-17-|grep "postgresql-17-"|grep -v dbgsym|grep -v "debug symbols"

postgresql-17-age/bookworm-pgdg 1.5.0~rc0-3.pgdg120+2 arm64
postgresql-17-asn1oid/bookworm-pgdg 1.6-2.pgdg120+1 arm64
postgresql-17-auto-failover/bookworm-pgdg 2.2-2.pgdg120+1 arm64
postgresql-17-bgw-replstatus/bookworm-pgdg 1.0.8-1.pgdg120+1 arm64
postgresql-17-credcheck/bookworm-pgdg 3.0-2.pgdg120+1 arm64
postgresql-17-cron/bookworm-pgdg 1.6.5-1.pgdg120+1 arm64
postgresql-17-debversion/bookworm-pgdg 1.2.0-2.pgdg120+4 arm64
postgresql-17-decoderbufs/bookworm-pgdg 3.2.0-1.pgdg120+1 arm64
postgresql-17-dirtyread/bookworm-pgdg 2.7-2.pgdg120+1 arm64
postgresql-17-extra-window-functions/bookworm-pgdg 1.0-6.pgdg120+1 arm64
postgresql-17-first-last-agg/bookworm-pgdg 0.1.4-4-gd63ea3b-8.pgdg120+1 arm64
postgresql-17-h3/bookworm-pgdg 4.2.3-1.pgdg120+1 arm64
postgresql-17-hll/bookworm-pgdg 2.18-2.pgdg120+1 arm64
postgresql-17-http/bookworm-pgdg 1.7.0-2.pgdg120+1 arm64
postgresql-17-hypopg/bookworm-pgdg 1.4.2-1.pgdg120+1 arm64
postgresql-17-icu-ext/bookworm-pgdg 1.10.0-1.pgdg120+1 arm64
postgresql-17-ip4r/bookworm-pgdg 2.4.2-3.pgdg120+1 arm64
postgresql-17-jsquery/bookworm-pgdg 1.2-2.pgdg120+1 arm64
postgresql-17-londiste-sql/bookworm-pgdg 3.8-6.pgdg120+1 all
postgresql-17-mimeo/bookworm-pgdg 1.5.1-19.pgdg120+1 all
postgresql-17-mobilitydb/bookworm-pgdg 1.2.0-2.pgdg120+1 arm64
postgresql-17-mysql-fdw/bookworm-pgdg 2.9.2-2.pgdg120+1 arm64
postgresql-17-numeral/bookworm-pgdg 1.3-7.pgdg120+1 arm64
postgresql-17-ogr-fdw/bookworm-pgdg 1.1.7-1.pgdg12+1 arm64
postgresql-17-omnidb/bookworm-pgdg 3.0.0.20201026-6.pgdg120+1 arm64
postgresql-17-oracle-fdw/bookworm-pgdg 2.8.0-1.pgdg120+1 arm64
postgresql-17-orafce/bookworm-pgdg 4.14.4-1.pgdg120+1 arm64
postgresql-17-partman/bookworm-pgdg 5.2.4-1.pgdg120+1 arm64
postgresql-17-periods/bookworm-pgdg 1.2.3-1.pgdg120+1 arm64
postgresql-17-pg-catcheck/bookworm-pgdg 1.6.0-1.pgdg120+1 arm64
postgresql-17-pg-checksums/bookworm-pgdg 1.2-2.pgdg120+1 arm64
postgresql-17-pg-crash/bookworm-pgdg 0.3-1.pgdg120+1 arm64
postgresql-17-pg-fact-loader/bookworm-pgdg 2.0.1-5.pgdg120+1 arm64
postgresql-17-pg-failover-slots/bookworm-pgdg 1.1.0-2.pgdg120+1 arm64
postgresql-17-pg-hint-plan/bookworm-pgdg 1.7.0-1.pgdg120+1 arm64
postgresql-17-pg-permissions/bookworm-pgdg 1.4-1.pgdg120+1 all
postgresql-17-pg-qualstats/bookworm-pgdg 2.1.2-1.pgdg120+1 arm64
postgresql-17-pg-rewrite/bookworm-pgdg 2.0.0-1.pgdg120+1 arm64
postgresql-17-pg-rrule/bookworm-pgdg 0.2.0+git20211101.d7d10f2-3.pgdg120+1 arm64
postgresql-17-pg-stat-kcache/bookworm-pgdg 2.3.0-1.pgdg120+1 arm64
postgresql-17-pg-track-settings/bookworm-pgdg 2.1.2-4.pgdg120+1 all
postgresql-17-pg-wait-sampling/bookworm-pgdg 1.1.9-1.pgdg120+1 arm64
postgresql-17-pgaudit/bookworm-pgdg 17.1-1.pgdg120+1 arm64
postgresql-17-pgauditlogtofile/bookworm-pgdg 1.7.2-1.pgdg12+1 arm64
postgresql-17-pgextwlist/bookworm-pgdg 1.19-1.pgdg120+1 arm64
postgresql-17-pgfaceting/bookworm-pgdg 0.2.0-4.pgdg120+1 all
postgresql-17-pgfincore/bookworm-pgdg 1.3.1-2.pgdg120+1 arm64
postgresql-17-pgl-ddl-deploy/bookworm-pgdg 2.2.1-2.pgdg120+1 arm64
postgresql-17-pglogical/bookworm-pgdg 2.4.5-1.pgdg120+1 arm64
postgresql-17-pglogical-ticker/bookworm-pgdg 1.4.1-8.pgdg120+1 arm64
postgresql-17-pgmemcache/bookworm-pgdg 2.3.0-14.pgdg120+1 arm64
postgresql-17-pgmp/bookworm-pgdg 1.0.5-3.pgdg120+1 arm64
postgresql-17-pgnodemx/bookworm-pgdg 1.7-1.pgdg120+1 arm64
postgresql-17-pgpcre/bookworm-pgdg 0.20190509-8.pgdg120+1 arm64
postgresql-17-pgpool2/bookworm-pgdg 4.6.3-1.pgdg12+1 arm64
postgresql-17-pgq-node/bookworm-pgdg 3.5-7.pgdg120+1 all
postgresql-17-pgq3/bookworm-pgdg 3.5.1-1.pgdg120+1 arm64
postgresql-17-pgrouting/bookworm-pgdg 3.8.0-1.pgdg120+1 arm64
postgresql-17-pgrouting-doc/bookworm-pgdg 3.7.0-1.pgdg120+1 all
postgresql-17-pgrouting-scripts/bookworm-pgdg 3.8.0-1.pgdg120+1 all
postgresql-17-pgsentinel/bookworm-pgdg 1.2.0-1.pgdg120+1 arm64
postgresql-17-pgsphere/bookworm-pgdg 1.5.1-2.pgdg120+1 arm64
postgresql-17-pgtap/bookworm-pgdg 1.3.3-3.pgdg120+1 all
postgresql-17-pgtt/bookworm-pgdg 4.4-1.pgdg120+1 arm64
postgresql-17-pgvector/bookworm-pgdg 0.8.0-1.pgdg120+1 arm64
postgresql-17-pldebugger/bookworm-pgdg 1:1.8-2.pgdg120+1 arm64
postgresql-17-pljava/bookworm-pgdg 1.6.9-1.pgdg120+1 arm64
postgresql-17-pljs/bookworm-pgdg 1.0.1-1.pgdg120+2 arm64
postgresql-17-pllua/bookworm-pgdg 1:2.0.12-5.pgdg120+1 arm64
postgresql-17-plpgsql-check/bookworm-pgdg 2.8.2-1.pgdg120+1 arm64
postgresql-17-plprofiler/bookworm-pgdg 4.2.5-3.pgdg120+1 arm64
postgresql-17-plproxy/bookworm-pgdg 2.11.0-12.pgdg120+1 arm64
postgresql-17-plr/bookworm-pgdg 1:8.4.8-1.pgdg120+1 arm64
postgresql-17-plsh/bookworm-pgdg 1.20220917-3.pgdg120+1 arm64
postgresql-17-pointcloud/bookworm-pgdg 1.2.5-2.pgdg120+1 arm64
postgresql-17-postgis-3/bookworm-pgdg,now 3.6.0+dfsg-1.pgdg12+1 arm64 [installed]
postgresql-17-postgis-3-scripts/bookworm-pgdg,now 3.6.0+dfsg-1.pgdg12+1 all [installed]
postgresql-17-powa/bookworm-pgdg 5.0.3-1.pgdg120+1 arm64
postgresql-17-prefix/bookworm-pgdg 1.2.10-3.pgdg120+1 arm64
postgresql-17-preprepare/bookworm-pgdg 0.9-9.pgdg120+1 arm64
postgresql-17-prioritize/bookworm-pgdg 1.0.4-12.pgdg120+1 arm64
postgresql-17-q3c/bookworm-pgdg 2.0.1-4.pgdg120+1 arm64
postgresql-17-rational/bookworm-pgdg 0.0.2-7.pgdg120+1 arm64
postgresql-17-repack/bookworm-pgdg 1.5.2-1.pgdg120+1 arm64
postgresql-17-repmgr/bookworm-pgdg 5.5.0+debpgdg-1.pgdg120+1 arm64
postgresql-17-roaringbitmap/bookworm-pgdg 0.5.4-3.pgdg120+1 arm64
postgresql-17-rum/bookworm-pgdg 1.3.14-2.pgdg120+1 arm64
postgresql-17-semver/bookworm-pgdg 0.40.0-2.pgdg120+1 arm64
postgresql-17-set-user/bookworm-pgdg 4.1.0-1.pgdg120+2 arm64
postgresql-17-show-plans/bookworm-pgdg 2.1.6-1.pgdg120+1 arm64
postgresql-17-similarity/bookworm-pgdg 1.0-8.pgdg120+1 arm64
postgresql-17-slony1-2/bookworm-pgdg 2.2.11-6.pgdg120+1 arm64
postgresql-17-snakeoil/bookworm-pgdg 1.4-2.pgdg120+1 arm64
postgresql-17-squeeze/bookworm-pgdg 1.9.0-1.pgdg120+1 arm64
postgresql-17-statviz/bookworm-pgdg 0.7-3.pgdg120+1 all
postgresql-17-tablelog/bookworm-pgdg 0.6.4-3.pgdg120+1 arm64
postgresql-17-tdigest/bookworm-pgdg 1.4.3-1.pgdg120+1 arm64
postgresql-17-tds-fdw/bookworm-pgdg 2.0.4-1.pgdg120+1 arm64
postgresql-17-timescaledb/bookworm-pgdg 2.21.3+dfsg-1.pgdg12+1 arm64
postgresql-17-toastinfo/bookworm-pgdg 1.5-2.pgdg120+1 arm64
postgresql-17-unit/bookworm-pgdg 7.10-1.pgdg120+1 arm64
postgresql-17-wal2json/bookworm-pgdg 2.6-2.pgdg120+1 arm64
```
  
例如, 安装vector, age插件
```
apt-get install -y postgresql-17-pgvector postgresql-17-age

psql 
postgres=# create extension age ;
postgres=# create extension vector ;
CREATE EXTENSION
postgres=# \dx
                              List of installed extensions
   Name   | Version |   Schema   |                     Description                      
----------+---------+------------+------------------------------------------------------
 age      | 1.5.0   | ag_catalog | AGE database extension
 plpgsql  | 1.0     | pg_catalog | PL/pgSQL procedural language
 vector   | 0.8.0   | public     | vector data type and ivfflat and hnsw access methods
(3 rows)
```
  
7、使用源码安装插件举例  
  
安装必要的工具包  
```  
apt-get update \
  && apt-get install -y git build-essential gcc g++ cmake postgresql-server-dev-17 
```  
  
pg_jieba插件 : https://github.com/jaiminpan/pg_jieba/blob/master/README.md  
  
容器postgres用户操作, 编译pg_jieba插件  
```  
su - postgres  


cd /var/lib/postgresql/bak  
git clone --depth 1 https://github.com/jaiminpan/pg_jieba  
cd pg_jieba  
  
  
# 下载依赖  
git submodule update --init --recursive  
  
mkdir build  
cd build  
  
# 得到include dir  
pg_config |grep "INCLUDEDIR-SERVER"  
  
# 编译pg_jieba  
cmake -DPostgreSQL_TYPE_INCLUDE_DIR="/usr/include/postgresql/17/server" ..  
  
make -j 4  
```  
  
容器root用户操作, 安装pg_jieba插件到postgresql相应目录中  
```  
# 退到root用户中  
cd /var/lib/postgresql/bak/pg_jieba/build  
make install   
```  
  
日志如下  
```  
root@99125c5e3122:/var/lib/postgresql/bak/pg_jieba/build# make install  
[100%] Built target pg_jieba  
Install the project...  
-- Install configuration: ""  
-- Installing: /usr/lib/postgresql/17/lib/pg_jieba.so  
-- Installing: /usr/share/postgresql/17/extension/pg_jieba.control  
-- Installing: /usr/share/postgresql/17/extension/pg_jieba--1.1.1.sql  
-- Installing: /usr/share/postgresql/17/tsearch_data/jieba_base.dict  
-- Installing: /usr/share/postgresql/17/tsearch_data/jieba_hmm.model  
-- Installing: /usr/share/postgresql/17/tsearch_data/jieba_user.dict  
-- Installing: /usr/share/postgresql/17/tsearch_data/jieba.stop  
-- Installing: /usr/share/postgresql/17/tsearch_data/jieba.idf  
```  
  
现已可使用pg_jieba插件  
```  
root@99125c5e3122:/var/lib/postgresql/bak/pg_jieba/build# su - postgres  
postgres@99125c5e3122:~$ psql  
psql (17.6 (Debian 17.6-1.pgdg12+1))  
Type "help" for help.  
  
postgres=# create extension pg_jieba ;  
CREATE EXTENSION  
postgres=# select * from to_tsquery('jiebacfg', '是拖拉机学院手扶拖拉机专业的。不用多久，我就会升职加薪，当上CEO，走上人生巅峰。');
                                                                         to_tsquery                                                                         
------------------------------------------------------------------------------------------------------------------------------------------------------------
 '拖拉机' <-> '学院' <-> '手扶拖拉机' <-> '专业' <3> '不用' <-> '多久' <4> '会' <-> '升职' <-> '加薪' <2> '当上' <-> 'ceo' <2> '走上' <-> '人生' <-> '巅峰'
(1 row)
postgres=# select * from to_tsvector('jiebacfg', '是拖拉机学院手扶拖拉机专业的。不用多久，我就会升职加薪，当上CEO，走上人生巅峰。');
                                                                to_tsvector                                                                 
--------------------------------------------------------------------------------------------------------------------------------------------
 'ceo':18 '不用':8 '专业':5 '人生':21 '会':13 '加薪':15 '升职':14 '多久':9 '学院':3 '巅峰':22 '当上':17 '手扶拖拉机':4 '拖拉机':2 '走上':20
(1 row)
```  
  
到目前为止, postgresql 容器可方便的用于学习使用了.    
  
查询当前支持的所有插件
```
postgres=# select * from pg_available_extensions;
```
  
## 附: 删除容器、清理目录
如果容器不要了, 并且数据也不要了, 可在宿主机停止容器, 并清理data和bak目录.   
  
```
docker stop pg1
docker rm pg1

cd ~
rm -rf rm -rf pgdocker_data
```
  
如果不删除容器, 停止后, 下次可start后进入容器使用
```
docker stop pg1
docker start pg1
docker exec -ti pg1 bash
```
  
  
## 参考  
- [《2023-PostgreSQL Docker镜像学习环境 AMD64版, 已集成热门插件和工具》](../202307/20230710_03.md)        
- [《2023-PostgreSQL Docker镜像学习环境 ARM64版, 已集成热门插件和工具》](../202308/20230814_02.md)       
- https://github.com/docker-library/docs/blob/master/postgres/README.md  
- https://hub.docker.com/_/postgres/    
- https://github.com/docker-library/postgres    
- https://hub.docker.com/r/postgis/postgis/    
- https://github.com/postgis/docker-postgis    
- https://hub.docker.com/r/dpage/pgadmin4    
- https://www.pgadmin.org/download/pgadmin-4-container/    
- [《ssh隧道》](../202310/20231029_01.md)    
- [《squid代理》](../202407/20240704_01.md)    
- [《容器中github clone无法联网问题解决》](../202403/20240327_01.md)  
     
  
    
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
