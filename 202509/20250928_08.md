## å¦‚ä½•é€šè¿‡KV CacheåŠ é€Ÿå¤§æ¨¡å‹çš„æ¨ç†ååç‡
        
### ä½œè€…        
digoal        
        
### æ—¥æœŸ        
2025-09-28        
        
### æ ‡ç­¾        
PostgreSQL , PolarDB , DuckDB , KV Cache , æ³¨æ„åŠ› , å¤§æ¨¡å‹ , æ¨ç†        
        
----        
        
## èƒŒæ™¯  
  
å¦‚ä½•é€šè¿‡KV CacheåŠ é€Ÿæ¨¡å‹çš„æ¨ç†ååç‡?  
  
å¯¹LLMæ¥è¯´kv cacheæ˜¯å•ç‹¬çš„æœåŠ¡ è¿˜æ˜¯ å†…ç½®çš„èƒ½åŠ›?   

# ä¸€ã€å¦‚ä½•é€šè¿‡KV CacheåŠ é€Ÿæ¨¡å‹çš„æ¨ç†ååç‡
KV Cacheï¼ˆKey-Value Cacheï¼‰æ˜¯**å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ¨ç†åŠ é€Ÿ**ä¸­æœ€æ ¸å¿ƒçš„æŠ€æœ¯ä¹‹ä¸€ï¼Œå°¤å…¶åœ¨ **è‡ªå›å½’ç”Ÿæˆï¼ˆauto-regressive generationï¼‰** åœºæ™¯ä¸‹ï¼ˆå¦‚é—®ç­”ã€å¯¹è¯ã€ä»£ç ç”Ÿæˆï¼‰èƒ½æ˜¾è‘—æå‡ååç‡ï¼ˆthroughputï¼‰å’Œé™ä½å»¶è¿Ÿï¼ˆlatencyï¼‰ã€‚

ä¸‹é¢ä»**åŸç†ã€å®ç°ã€ä¼˜åŒ–ç­–ç•¥**ä¸‰ä¸ªå±‚é¢ï¼Œé€šä¿—æ˜“æ‡‚åœ°è§£é‡Š **å¦‚ä½•é€šè¿‡ KV Cache åŠ é€Ÿæ¨ç†ååç‡**ã€‚

---

## ä¸€ã€KV Cache æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

### ğŸ§  èƒŒæ™¯ï¼šTransformer çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶
åœ¨ Transformer è§£ç å™¨ä¸­ï¼Œæ¯ç”Ÿæˆä¸€ä¸ª tokenï¼Œéƒ½è¦è®¡ç®—å®ƒä¸**æ‰€æœ‰å·²ç”Ÿæˆ token**çš„æ³¨æ„åŠ›ï¼ˆAttentionï¼‰ï¼š

$$
\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d}}\right)V
$$

- **Q**ï¼ˆQueryï¼‰ï¼šå½“å‰ token çš„æŸ¥è¯¢å‘é‡
- **K, V**ï¼ˆKey, Valueï¼‰ï¼šæ‰€æœ‰å†å² token çš„é”®å’Œå€¼

### âŒ é—®é¢˜ï¼šé‡å¤è®¡ç®—
å¦‚æœä¸ç¼“å­˜ï¼Œæ¯æ¬¡ç”Ÿæˆæ–° token æ—¶ï¼Œéƒ½è¦**é‡æ–°è®¡ç®—æ‰€æœ‰å†å² token çš„ K å’Œ V**ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºï¼š

- ç¬¬ 1 æ­¥ï¼šè®¡ç®— 1 ä¸ª K/V
- ç¬¬ 2 æ­¥ï¼šè®¡ç®— 2 ä¸ª K/V
- ...
- ç¬¬ n æ­¥ï¼šè®¡ç®— n ä¸ª K/V

æ€»è®¡ç®—é‡ï¼š**O(nÂ²)**

### âœ… è§£å†³æ–¹æ¡ˆï¼šKV Cache
- **é¦–æ¬¡è®¡ç®—æ¯ä¸ª token çš„ K å’Œ V åï¼Œå°†å…¶ç¼“å­˜èµ·æ¥**
- åç»­ç”Ÿæˆæ–° token æ—¶ï¼Œ**ç›´æ¥å¤ç”¨ç¼“å­˜çš„ K/V**ï¼Œåªè®¡ç®—å½“å‰ token çš„ Q

> ğŸ’¡ **æ•ˆæœ**ï¼šæ¯æ­¥è®¡ç®—é‡ä» O(n) â†’ O(1)ï¼Œæ€»è®¡ç®—é‡ä» O(nÂ²) â†’ O(n)

---

## äºŒã€KV Cache å¦‚ä½•æå‡ååç‡ï¼ˆThroughputï¼‰ï¼Ÿ

ååç‡ = æ¯ç§’ç”Ÿæˆçš„ token æ•°ï¼ˆtokens/sï¼‰

KV Cache é€šè¿‡ä»¥ä¸‹æ–¹å¼æå‡ååï¼š

| ä¼˜åŒ–ç‚¹ | è¯´æ˜ |
|--------|------|
| **å‡å°‘é‡å¤è®¡ç®—** | é¿å…é‡å¤è®¡ç®—å†å² K/Vï¼ŒèŠ‚çœ 50%~80% çš„ Attention è®¡ç®— |
| **é™ä½æ˜¾å­˜å¸¦å®½å‹åŠ›** | è™½ç„¶ KV Cache å ç”¨æ˜¾å­˜ï¼Œä½†é¿å…äº†é¢‘ç¹ä»æ˜¾å­˜è¯»å–åŸå§‹ token embeddings |
| **æ”¯æŒæ‰¹å¤„ç†ï¼ˆBatchingï¼‰** | å¤šä¸ªè¯·æ±‚å¯å…±äº«è®¡ç®—èµ„æºï¼ŒKV Cache ä½¿æ¯ä¸ªè¯·æ±‚çš„å¢é‡è®¡ç®—æ›´è½»é‡ |

> ğŸ“Š å®æµ‹ï¼šåœ¨ Llama-3-8B ä¸Šï¼Œå¯ç”¨ KV Cache å¯ä½¿ååç‡æå‡ **3~5 å€**

---

## ä¸‰ã€KV Cache çš„å®ç°ç»†èŠ‚ï¼ˆä»¥ Hugging Face / vLLM ä¸ºä¾‹ï¼‰

### 1. **ç¼“å­˜ç»“æ„**
æ¯ä¸ª layer éƒ½æœ‰è‡ªå·±çš„ KV Cacheï¼Œå½¢çŠ¶ä¸ºï¼š

```
[batch_size, num_heads, seq_len, head_dim]
```

- `seq_len` åŠ¨æ€å¢é•¿ï¼ˆä» 1 åˆ° max_lengthï¼‰
- é€šå¸¸ç”¨ **PagedAttentionï¼ˆvLLMï¼‰** æˆ– **åŠ¨æ€å¼ é‡æ‹¼æ¥** å®ç°

### 2. **ä»£ç ç¤ºæ„ï¼ˆä¼ªä»£ç ï¼‰**
```python
# é¦–æ¬¡è¾“å…¥ prompt
prompt = "Hello, how are you?"
input_ids = tokenizer(prompt).input_ids  # [1, 5]

# ç¬¬ä¸€æ¬¡ forwardï¼šè®¡ç®—æ‰€æœ‰ token çš„ K/Vï¼Œå¹¶ç¼“å­˜
logits, kv_cache = model(input_ids, use_cache=True)

# ç”Ÿæˆç¬¬ä¸€ä¸ª token
next_token = sample(logits)
output_ids = [next_token]

# åç»­ stepï¼šåªè¾“å…¥æ–° tokenï¼Œå¤ç”¨ kv_cache
for i in range(max_new_tokens):
    logits, kv_cache = model(
        input_ids=next_token.unsqueeze(0),  # [1, 1]
        past_key_values=kv_cache,           # å¤ç”¨å†å² K/V
        use_cache=True
    )
    next_token = sample(logits)
    output_ids.append(next_token)
```

---

## å››ã€é«˜çº§ä¼˜åŒ–ï¼šè®© KV Cache æ›´é«˜æ•ˆ

### âœ… 1. **PagedAttentionï¼ˆvLLMï¼‰**
- å°† KV Cache åˆ†é¡µå­˜å‚¨ï¼ˆç±»ä¼¼æ“ä½œç³»ç»Ÿè™šæ‹Ÿå†…å­˜ï¼‰
- é¿å…å†…å­˜ç¢ç‰‡ï¼Œæ”¯æŒ**åŠ¨æ€æ‰¹å¤„ç†ï¼ˆcontinuous batchingï¼‰**
- ååç‡æå‡ **2~4 å€**ï¼ˆç›¸æ¯” Hugging Face Transformersï¼‰

### âœ… 2. **é‡åŒ– KV Cache**
- å°† K/V ä» FP16 é‡åŒ–ä¸º INT8 æˆ– FP8
- æ˜¾å­˜å ç”¨å‡å°‘ **50%**ï¼Œé€‚åˆé•¿ä¸Šä¸‹æ–‡ï¼ˆ32K+ tokensï¼‰
- å·¥å…·ï¼š[SGLang](https://github.com/sgl-project/sglang)ã€[TensorRT-LLM](https://github.com/NVIDIA/TensorRT-LLM)

### âœ… 3. **å…±äº« KV Cacheï¼ˆå¤šè½®å¯¹è¯ï¼‰**
- åœ¨å¯¹è¯ç³»ç»Ÿä¸­ï¼Œ**å†å²å¯¹è¯çš„ KV Cache å¯å¤ç”¨**
- æ–° query åªéœ€è®¡ç®—å¢é‡éƒ¨åˆ†ï¼Œé¿å…é‡å¤ encode å†å²

### âœ… 4. **çª—å£æ³¨æ„åŠ›ï¼ˆSliding Windowï¼‰**
- åªç¼“å­˜æœ€è¿‘ N ä¸ª token çš„ K/Vï¼ˆå¦‚ Mistral çš„ 4K windowï¼‰
- æ˜¾å­˜å ç”¨æ’å®šï¼Œé€‚åˆè¶…é•¿æ–‡æœ¬

---

## äº”ã€KV Cache çš„ä»£ä»·ä¸æƒè¡¡

| ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|
| âš¡ æ¨ç†é€Ÿåº¦å¤§å¹…æå‡ | ğŸ’¾ æ˜¾å­˜å ç”¨å¢åŠ ï¼ˆä¸ seq_len æˆæ­£æ¯”ï¼‰ |
| ğŸ“ˆ æ”¯æŒé«˜ååæ‰¹å¤„ç† | ğŸš« ä¸é€‚ç”¨äºéè‡ªå›å½’ä»»åŠ¡ï¼ˆå¦‚åˆ†ç±»ï¼‰ |
| ğŸ” æ”¯æŒæµå¼è¾“å‡º | ğŸ§© é•¿ä¸Šä¸‹æ–‡ï¼ˆ>32Kï¼‰å¯èƒ½çˆ†æ˜¾å­˜ |

> ğŸ’¡ **ç»éªŒæ³•åˆ™**ï¼š  
> - 8B æ¨¡å‹ + 4K ä¸Šä¸‹æ–‡ â‰ˆ é¢å¤–å ç”¨ 2~4GB æ˜¾å­˜ï¼ˆFP16ï¼‰  
> - 70B æ¨¡å‹ + 32K ä¸Šä¸‹æ–‡ â‰ˆ é¢å¤–å ç”¨ 40GB+ æ˜¾å­˜

---

## å…­ã€æ€»ç»“ï¼šå¦‚ä½•æœ€å¤§åŒ–åˆ©ç”¨ KV Cache æå‡ååï¼Ÿ

1. **åŠ¡å¿…å¯ç”¨ `use_cache=True`**ï¼ˆHugging Face é»˜è®¤å¼€å¯ï¼‰
2. **ä½¿ç”¨ vLLM / SGLang / TensorRT-LLM** ç­‰é«˜æ€§èƒ½æ¨ç†å¼•æ“ï¼ˆå†…ç½® PagedAttentionï¼‰
3. **å¯¹é•¿ä¸Šä¸‹æ–‡åœºæ™¯ï¼Œè€ƒè™‘é‡åŒ– KV Cache æˆ–æ»‘åŠ¨çª—å£**
4. **åœ¨æœåŠ¡ç«¯å¯ç”¨åŠ¨æ€æ‰¹å¤„ç†ï¼ˆcontinuous batchingï¼‰**ï¼Œè®©å¤šä¸ªè¯·æ±‚å…±äº« GPU è®¡ç®—

> ğŸŒŸ **æœ€ç»ˆæ•ˆæœ**ï¼šåœ¨ A100 ä¸Šï¼ŒLlama-3-8B çš„ååç‡å¯ä» **50 tokens/s** æå‡è‡³ **300+ tokens/s**

---

å¦‚æœä½ æœ‰å…·ä½“æ¨¡å‹ï¼ˆå¦‚ Qwenã€Llamaï¼‰ã€ç¡¬ä»¶ï¼ˆå¦‚ Mac M3ã€A100ï¼‰æˆ–æ¡†æ¶ï¼ˆOllamaã€vLLMï¼‰çš„éœ€æ±‚ï¼Œæˆ‘å¯ä»¥ç»™å‡ºé’ˆå¯¹æ€§ä¼˜åŒ–å»ºè®®ï¼
  
# äºŒã€å¯¹LLMæ¥è¯´kv cacheæ˜¯å•ç‹¬çš„æœåŠ¡ è¿˜æ˜¯ å†…ç½®çš„èƒ½åŠ›?
å¯¹å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æ¥è¯´ï¼Œ**KV Cacheï¼ˆKey-Value Cacheï¼‰ä¸æ˜¯å•ç‹¬çš„æœåŠ¡ï¼Œè€Œæ˜¯æ¨ç†å¼•æ“ï¼ˆinference engineï¼‰å†…ç½®çš„æ ¸å¿ƒèƒ½åŠ›**ï¼Œå±äº**æ¨ç†è¿‡ç¨‹ä¸­çš„å†…å­˜ç®¡ç†ä¼˜åŒ–æŠ€æœ¯**ã€‚

---

### âœ… è¯¦ç»†è§£é‡Šï¼š

#### 1. **KV Cache æ˜¯ä»€ä¹ˆï¼Ÿ**
- åœ¨ Transformer è§£ç å™¨ä¸­ï¼Œæ¯ç”Ÿæˆä¸€ä¸ª tokenï¼Œéƒ½éœ€è¦è®¡ç®—å®ƒä¸**æ‰€æœ‰å·²ç”Ÿæˆ token**çš„æ³¨æ„åŠ›ï¼ˆAttentionï¼‰ã€‚
- KV Cache å°±æ˜¯æŠŠæ¯ä¸ªå·²ç”Ÿæˆ token å¯¹åº”çš„ **Keyï¼ˆKï¼‰å’Œ Valueï¼ˆVï¼‰å‘é‡ç¼“å­˜èµ·æ¥**ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚
- åç»­ç”Ÿæˆæ–° token æ—¶ï¼Œåªéœ€è®¡ç®—å½“å‰ token çš„ Queryï¼ˆQï¼‰ï¼Œç„¶åä¸ç¼“å­˜çš„ K/V åš Attentionã€‚

> ğŸ“Œ **æœ¬è´¨**ï¼šç”¨**å†…å­˜æ¢è®¡ç®—**ï¼Œå¤§å¹…å‡å°‘é‡å¤è®¡ç®—ï¼Œæå‡æ¨ç†é€Ÿåº¦ã€‚

---

#### 2. **å®ƒæ˜¯â€œå†…ç½®èƒ½åŠ›â€è€Œéâ€œç‹¬ç«‹æœåŠ¡â€**

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **é›†æˆåœ¨æ¨ç†å¼•æ“ä¸­** | å¦‚ Hugging Face Transformersã€vLLMã€llama.cppã€TensorRT-LLMã€Ollama ç­‰éƒ½**å†…ç½®äº† KV Cache ç®¡ç†é€»è¾‘** |
| **è‡ªåŠ¨å¯ç”¨** | å¤§å¤šæ•°æ¡†æ¶é»˜è®¤å¼€å¯ï¼ˆå¦‚ `use_cache=True`ï¼‰ï¼Œç”¨æˆ·æ— éœ€æ‰‹åŠ¨å®ç° |
| **ç”Ÿå‘½å‘¨æœŸç»‘å®šæ¨ç†è¿‡ç¨‹** | KV Cache éšå¯¹è¯/ç”Ÿæˆä»»åŠ¡åˆ›å»ºï¼Œä»»åŠ¡ç»“æŸå³é‡Šæ”¾ï¼Œ**ä¸è·¨è¯·æ±‚æŒä¹…åŒ–**ï¼ˆé™¤éæ˜¾å¼å®ç°å¯¹è¯è®°å¿†ï¼‰ |
| **ä¸å¯¹å¤–æš´éœ² API** | å®ƒæ˜¯åº•å±‚ä¼˜åŒ–æœºåˆ¶ï¼Œç”¨æˆ·é€šå¸¸åªæ„ŸçŸ¥åˆ°â€œæ›´å¿«çš„ç”Ÿæˆé€Ÿåº¦â€ï¼Œçœ‹ä¸åˆ° KV Cache æœ¬èº« |

> ğŸ”§ ä¸¾ä¾‹ï¼š
> ```python
> # Hugging Face é»˜è®¤å¯ç”¨ KV Cache
> outputs = model.generate(input_ids, use_cache=True)  # â† å†…ç½®æ”¯æŒ
> ```

---

#### 3. **ä»€ä¹ˆæ—¶å€™ä¼šâ€œåƒæœåŠ¡â€ä¸€æ ·ç®¡ç† KV Cacheï¼Ÿ**

è™½ç„¶ KV Cache æœ¬èº«ä¸æ˜¯æœåŠ¡ï¼Œä½†åœ¨**é«˜å¹¶å‘æ¨ç†ç³»ç»Ÿ**ä¸­ï¼Œå®ƒçš„ç®¡ç†ä¼šå˜å¾—å¤æ‚ï¼Œå¯èƒ½éœ€è¦**ç±»ä¼¼æœåŠ¡çš„è°ƒåº¦é€»è¾‘**ï¼š

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| **å¤šç”¨æˆ·å¯¹è¯ç³»ç»Ÿ** | æ¯ä¸ªç”¨æˆ·çš„å¯¹è¯å†å²éœ€è¦ç‹¬ç«‹çš„ KV Cacheï¼Œç³»ç»Ÿéœ€ç®¡ç†æˆåƒä¸Šä¸‡ä¸ªç¼“å­˜å®ä¾‹ |
| **PagedAttentionï¼ˆvLLMï¼‰** | å°† KV Cache åˆ†é¡µå­˜å‚¨ï¼ˆç±»ä¼¼è™šæ‹Ÿå†…å­˜ï¼‰ï¼Œç”±è°ƒåº¦å™¨åŠ¨æ€åˆ†é…/å›æ”¶å†…å­˜é¡µ |
| **é•¿ä¸Šä¸‹æ–‡æ¨ç†** | KV Cache å¯èƒ½å ç”¨å‡ å GB å†…å­˜ï¼Œéœ€å†…å­˜æ± ã€æ¢å…¥æ¢å‡ºï¼ˆswapï¼‰ç­‰æœºåˆ¶ |

> âœ… ä½†å³ä¾¿å¦‚æ­¤ï¼Œ**KV Cache ä»æ˜¯æ¨ç†å¼•æ“çš„ä¸€éƒ¨åˆ†**ï¼Œä¸æ˜¯ç‹¬ç«‹éƒ¨ç½²çš„å¾®æœåŠ¡ã€‚

---

#### 4. **å¯¹æ¯”ï¼šKV Cache vs ç‹¬ç«‹ç¼“å­˜æœåŠ¡ï¼ˆå¦‚ Redisï¼‰**

| é¡¹ç›® | KV Cache | Redis / Memcached |
|------|--------|------------------|
| ç›®çš„ | åŠ é€Ÿå•æ¬¡ LLM æ¨ç† | è·¨è¯·æ±‚å…±äº«æ•°æ® |
| æ•°æ®å†…å®¹ | æ¨¡å‹ä¸­é—´æ¿€æ´»ï¼ˆK/V å‘é‡ï¼‰ | ç”¨æˆ·å®šä¹‰çš„é”®å€¼å¯¹ï¼ˆå¦‚å¯¹è¯å†å²ã€tokenï¼‰ |
| ç”Ÿå‘½å‘¨æœŸ | å•æ¬¡ç”Ÿæˆä»»åŠ¡å†… | å¯æŒä¹…åŒ–ã€è·¨ä¼šè¯ |
| æ˜¯å¦å¯å…³é—­ | å¯ï¼ˆä½†æ€§èƒ½æš´è·Œï¼‰ | å¯é€‰ç»„ä»¶ |

> ğŸ’¡ æœ‰äº›ç³»ç»Ÿä¼šç”¨ Redis ç¼“å­˜**å®Œæ•´å¯¹è¯å†å²**ï¼Œä½†**ä¸ä¼šç¼“å­˜ KV Cache**ï¼Œå› ä¸ºåè€…æ˜¯æ¨¡å‹ç§æœ‰ã€æ ¼å¼å›ºå®šã€ç”Ÿå‘½å‘¨æœŸçŸ­çš„ä¸­é—´çŠ¶æ€ã€‚

---

### âœ… æ€»ç»“

> **KV Cache æ˜¯ LLM æ¨ç†å¼•æ“çš„å†…ç½®ä¼˜åŒ–èƒ½åŠ›ï¼Œä¸æ˜¯ç‹¬ç«‹æœåŠ¡**ã€‚  
> å®ƒç”±æ¨ç†æ¡†æ¶è‡ªåŠ¨ç®¡ç†ï¼Œç”¨äºåŠ é€Ÿè‡ªå›å½’ç”Ÿæˆï¼Œå±äºâ€œçœ‹ä¸è§ä½†ç¦»ä¸å¼€â€çš„åº•å±‚æŠ€æœ¯ã€‚

åªæœ‰åœ¨æ„å»º**é«˜æ€§èƒ½æ¨ç†æœåŠ¡å™¨**ï¼ˆå¦‚ vLLMã€TGIï¼‰æ—¶ï¼Œæ‰ä¼šå¯¹ KV Cache åšç²¾ç»†åŒ–è°ƒåº¦ï¼ˆåˆ†é¡µã€å…±äº«ã€å‹ç¼©ç­‰ï¼‰ï¼Œä½†ä¾ç„¶å±äº**æ¨ç†æœåŠ¡å†…éƒ¨æ¨¡å—**ï¼Œè€Œéå¤–éƒ¨ä¾èµ–æœåŠ¡ã€‚
    
#### [æœŸæœ› PostgreSQL|å¼€æºPolarDB å¢åŠ ä»€ä¹ˆåŠŸèƒ½?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB å¼€æºæ•°æ®åº“](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB å­¦ä¹ å›¾è°±](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL è§£å†³æ–¹æ¡ˆé›†åˆ](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [å¾·å“¥ / digoal's Github - å…¬ç›Šæ˜¯ä¸€è¾ˆå­çš„äº‹.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About å¾·å“¥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
