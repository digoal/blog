## PG Data Block中LSN的作用是什么?   
                                    
### 作者                                    
digoal                                    
                                    
### 日期                                    
2025-10-11                                   
                                    
### 标签                                    
PostgreSQL , PolarDB , DuckDB , page header , LSN , WAL record , WAL address , 增量备份 , 恢复               
                                    
----                                    
                                    
## 背景     
在PostgreSQL的Data Block头中, 包含LSN信息, 这个LSN是啥? 有什么用?  
  
LSN 可以简单理解为WAL record的寻址地址.  
  
当Data Block发生修改时, PG会生成该修改对应的WAL record, 并分配LSN. 同时在Block header写入对应的LSN.  
  
WAL 大家都懂的, 用于实现数据库的持久化、奔溃恢复、增量备份恢复、流复制、逻辑复制信息的存储解析和同步等.   
  
如何理解WAL的寻址? LSN地址是自增的. 简单理解就是每个wal文件多大, 根据epoch和每个wal文件的大小, 以及当前的LSN就可计算出对应的WAL文件名, 根据WAL文件名就可计算出这个文件包含什么LSN区间的数据.  
  
理解了LSN后, LSN有什么用呢?  
  
恢复时: 从data block的头中读取到对应的LSN, 然后判断其地址是否大于最近一次已完成的checkpoint记录的开始LSN, 大于它则从相应wal文件中寻址并找到对应的wal record, 合成最新的data block.  
  
增量备份时: 例如上一次全量备份结束时记录的当时备份的WAL的最后一笔wal的最大LSN. 下次进行增量备份时, 检查data block header里的LSN是否大于这个LSN? 大于的话, 说明在上次全量备份后, 又对这个data block进行了修改, 所以这个数据块需要备份. 如果小于等于, 则不需要备份这个data block.  
  
    
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
