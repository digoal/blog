## ä½•ä¸ºMySQL è°ƒè¯•åŒæ­¥åŸºç¡€è®¾æ–½(Debug Synchronization Infrastructure)?  
                              
### ä½œè€…                      
digoal                      
                              
### æ—¥æœŸ                        
2025-10-14                            
                       
### æ ‡ç­¾                            
PostgreSQL , PolarDB , DuckDB , MySQL , OceanBase                       
                             
----                         
                         
## èƒŒæ™¯    
åœ¨é˜…è¯»OBä»£ç è§£è¯»æ–‡ä»¶æ—¶, é‡Œé¢å¤šæ¬¡æåˆ°debug synch point, æ²¡æƒ³åŸæ¥æ˜¯ç»§æ‰¿è‡ªMySQLè°ƒè¯•æ€æƒ³.     
    
Qwen è§£è¯»å¦‚ä¸‹.    
    
**Debug Synchronization Infrastructureï¼ˆè°ƒè¯•åŒæ­¥åŸºç¡€è®¾æ–½ï¼‰** æ˜¯ **MySQL æ•°æ®åº“å†…éƒ¨** ä¸ºå¼€å‘å’Œæµ‹è¯•ç›®çš„è€Œè®¾è®¡çš„ä¸€å¥—**ç”¨äºæ§åˆ¶å’Œè§‚å¯Ÿçº¿ç¨‹æ‰§è¡Œé¡ºåºçš„è°ƒè¯•æœºåˆ¶**ã€‚å®ƒçš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š**åœ¨å¤šçº¿ç¨‹å¹¶å‘ç¯å¢ƒä¸­ï¼Œç²¾ç¡®æ§åˆ¶æŸäº›å…³é”®ä»£ç ç‚¹çš„æ‰§è¡Œæ—¶æœºï¼Œä»¥ä¾¿å¤ç°å’Œè°ƒè¯•ç«æ€æ¡ä»¶ï¼ˆrace conditionsï¼‰ã€æ­»é”ã€æ—¶åºç›¸å…³ bug ç­‰éš¾ä»¥å¤ç°çš„é—®é¢˜**ã€‚  
  
> âš ï¸ æ³¨æ„ï¼šè¿™æ˜¯ **MySQL å†…éƒ¨çš„è°ƒè¯•åŠŸèƒ½**ï¼Œ**ä¸æ˜¯ PostgreSQL æˆ–å…¶ä»–æ•°æ®åº“çš„åŠŸèƒ½**ã€‚å®ƒä»…åœ¨ **MySQL æºç ç¼–è¯‘æ—¶å¯ç”¨è°ƒè¯•é€‰é¡¹ï¼ˆå¦‚ `WITH_DEBUG`ï¼‰** åæ‰å¯ç”¨ï¼Œ**ç”Ÿäº§ç¯å¢ƒé»˜è®¤å…³é—­**ã€‚  
  
### ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ  
  
MySQL æ˜¯é«˜åº¦å¹¶å‘çš„å¤šçº¿ç¨‹ç³»ç»Ÿï¼ˆè¿æ¥çº¿ç¨‹ã€InnoDB åå°çº¿ç¨‹ã€å¤åˆ¶çº¿ç¨‹ç­‰ï¼‰ã€‚å¾ˆå¤š bugï¼ˆå¦‚æ­»é”ã€æ•°æ®ä¸ä¸€è‡´ï¼‰åªåœ¨ç‰¹å®šçº¿ç¨‹è°ƒåº¦é¡ºåºä¸‹æ‰ä¼šè§¦å‘ï¼Œæéš¾å¤ç°ã€‚  
  
ä¾‹å¦‚ï¼š  
- çº¿ç¨‹ A æ‰§è¡Œåˆ°æŸå¤„æ—¶ï¼Œçº¿ç¨‹ B å¿…é¡»å°šæœªæ‰§è¡ŒæŸæ“ä½œï¼›  
- æˆ–è€…éœ€è¦è®©çº¿ç¨‹ A åœ¨æŸä¸ªä¸´ç•Œç‚¹â€œæš‚åœâ€ï¼Œç­‰æµ‹è¯•è„šæœ¬å®ŒæˆæŸäº›æ£€æŸ¥åå†ç»§ç»­ã€‚  
  
ä¼ ç»Ÿè°ƒè¯•å™¨ï¼ˆå¦‚ GDBï¼‰éš¾ä»¥ç²¾ç¡®æ§åˆ¶å¤šä¸ªçº¿ç¨‹çš„æ‰§è¡ŒèŠ‚å¥ã€‚**Debug Sync** å°±æ˜¯ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜è€Œç”Ÿçš„ã€‚  
  
### äºŒã€æ ¸å¿ƒåŸç†  
  
Debug Sync é€šè¿‡åœ¨ MySQL æºç ä¸­é¢„åŸ‹ **â€œåŒæ­¥ç‚¹ï¼ˆsynchronization pointsï¼‰â€**ï¼Œå…è®¸å¤–éƒ¨ï¼ˆé€šå¸¸æ˜¯æµ‹è¯•è„šæœ¬ï¼‰é€šè¿‡ SQL å‘½ä»¤æ§åˆ¶è¿™äº›ç‚¹çš„è¡Œä¸ºã€‚  
  
#### 1. **åŒæ­¥ç‚¹ï¼ˆSync Pointï¼‰**  
åœ¨æºç ä¸­æ’å…¥ç±»ä¼¼è¿™æ ·çš„å®ï¼š  
```cpp  
DEBUG_SYNC(thd, "before_acquiring_lock");  
```  
è¿™è¡¨ç¤ºï¼šå½“çº¿ç¨‹æ‰§è¡Œåˆ°è¿™é‡Œæ—¶ï¼Œä¼šæ£€æŸ¥æ˜¯å¦å¯¹è¯¥åŒæ­¥ç‚¹è®¾ç½®äº†â€œåŠ¨ä½œâ€ã€‚  
  
#### 2. **åŠ¨ä½œï¼ˆActionï¼‰**  
é€šè¿‡ SQL åŠ¨æ€è®¾ç½®æŸä¸ªåŒæ­¥ç‚¹çš„è¡Œä¸ºï¼Œä¾‹å¦‚ï¼š  
```sql  
SET DEBUG_SYNC = 'before_acquiring_lock WAIT_FOR go_signal';  
```  
å«ä¹‰ï¼šå½“ä»»ä½•çº¿ç¨‹æ‰§è¡Œåˆ° `before_acquiring_lock` æ—¶ï¼Œ**æš‚åœå¹¶ç­‰å¾…**åä¸º `go_signal` çš„ä¿¡å·ã€‚  
  
ç„¶ååœ¨æµ‹è¯•è„šæœ¬ä¸­ï¼š  
```sql  
-- å…¶ä»–æ“ä½œï¼ˆå¦‚æ£€æŸ¥çŠ¶æ€ï¼‰  
-- ...  
-- å‘é€ä¿¡å·ï¼Œè®©ç­‰å¾…çš„çº¿ç¨‹ç»§ç»­  
SET DEBUG_SYNC = 'now SIGNAL go_signal';  
```  
  
### ä¸‰ã€å¸¸ç”¨åŠ¨ä½œç±»å‹  
  
| åŠ¨ä½œè¯­æ³• | è¯´æ˜ |  
|--------|------|  
| `'point' WAIT_FOR signal_name` | åœ¨ `point` å¤„æš‚åœï¼Œç­‰å¾… `signal_name` ä¿¡å· |  
| `'now' SIGNAL signal_name` | ç«‹å³å‘é€ `signal_name` ä¿¡å·ï¼ˆå”¤é†’ç­‰å¾…è€…ï¼‰ |  
| `'point' SIGNAL signal_name` | æ‰§è¡Œåˆ° `point` æ—¶è‡ªåŠ¨å‘é€ä¿¡å· |  
| `'point' EXECUTE 1` | æ¯æ¬¡æ‰§è¡Œåˆ° `point` æ—¶è§¦å‘ä¸€æ¬¡ï¼ˆå¯ç”¨äºè®¡æ•°ï¼‰ |  
| `'point' TIMEOUT 10` | ç­‰å¾…æœ€å¤š 10 ç§’ï¼Œè¶…æ—¶åˆ™ç»§ç»­ |  
  
### å››ã€å…¸å‹ä½¿ç”¨åœºæ™¯ï¼ˆMySQL æµ‹è¯•ï¼‰  
  
åœ¨ MySQL çš„å®˜æ–¹æµ‹è¯•å¥—ä»¶ï¼ˆå¦‚ `mysql-test-run.pl`ï¼‰ä¸­å¹¿æ³›ä½¿ç”¨ï¼š  
  
```sql  
-- æµ‹è¯•ï¼šæ¨¡æ‹Ÿåœ¨è·å–é”å‰è¢«ä¸­æ–­  
connection con1;  
SET DEBUG_SYNC = 'before_acquiring_lock WAIT_FOR go';  
-- æ‰§è¡Œä¼šè§¦å‘è¯¥åŒæ­¥ç‚¹çš„è¯­å¥ï¼ˆå¦‚ UPDATEï¼‰  
send UPDATE t1 SET a = 1;  
  
connection con2;  
-- æ­¤æ—¶ con1 å·²æš‚åœåœ¨ before_acquiring_lock  
-- å¯ä»¥æ£€æŸ¥ InnoDB çŠ¶æ€ã€é”ä¿¡æ¯ç­‰  
-- ...  
-- å‘é€ä¿¡å·è®© con1 ç»§ç»­  
SET DEBUG_SYNC = 'now SIGNAL go';  
  
connection con1;  
-- ç­‰å¾… UPDATE å®Œæˆ  
reap;  
```  
  
è¿™æ ·å°±èƒ½**ç²¾ç¡®æ§åˆ¶å¹¶å‘æ—¶åº**ï¼ŒéªŒè¯ç‰¹å®šåœºæ™¯ä¸‹çš„è¡Œä¸ºã€‚  
  
### äº”ã€å¦‚ä½•å¯ç”¨ï¼Ÿ  
  
1. **ç¼–è¯‘ MySQL æ—¶å¯ç”¨è°ƒè¯•**ï¼š  
   ```bash  
   cmake . -DWITH_DEBUG=1  
   ```  
2. **å¯åŠ¨ MySQL åï¼Œé€šè¿‡ `SET DEBUG_SYNC` æ§åˆ¶**ï¼ˆä»…å¯¹å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰ã€‚  
  
> ğŸ“Œ æ™®é€šç”¨æˆ·æˆ–ç”Ÿäº§ç¯å¢ƒ**æ— æ³•ä½¿ç”¨**æ­¤åŠŸèƒ½ï¼Œå› ä¸ºå®ƒä¼šæ˜¾è‘—é™ä½æ€§èƒ½ï¼Œä¸”éœ€è¦è°ƒè¯•ç‰ˆäºŒè¿›åˆ¶æ–‡ä»¶ã€‚  
  
### å…­ã€ä¸ PostgreSQL çš„åŒºåˆ«  
  
- **PostgreSQL æ²¡æœ‰å®Œå…¨ç›¸åŒçš„æœºåˆ¶**ã€‚  
- PostgreSQL è°ƒè¯•å¹¶å‘é—®é¢˜é€šå¸¸ä¾èµ–ï¼š  
  - `pg_locks` ç³»ç»Ÿè§†å›¾  
  - æ‰‹åŠ¨æ’å…¥ `pg_sleep()`ï¼ˆä½†æ— æ³•ç²¾ç¡®æ§åˆ¶çº¿ç¨‹è°ƒåº¦ï¼‰  
  - ä½¿ç”¨ GDB + å¤šè¿›ç¨‹ attach  
  - å†…éƒ¨ä¹Ÿæœ‰ç±»ä¼¼ `PROBE` çš„ DTrace/SystemTap æ¢é’ˆï¼Œä½†ä¸å¦‚ MySQL çš„ Debug Sync çµæ´»  
  
### ä¸ƒã€æ€»ç»“  
  
| é¡¹ç›® | è¯´æ˜ |  
|------|------|  
| **æ˜¯ä»€ä¹ˆ** | MySQL å†…ç½®çš„çº¿ç¨‹åŒæ­¥è°ƒè¯•æ¡†æ¶ |  
| **ç›®çš„** | ç²¾ç¡®æ§åˆ¶å¤šçº¿ç¨‹æ‰§è¡Œé¡ºåºï¼Œå¤ç°å¹¶å‘ bug |  
| **ä½¿ç”¨æ–¹å¼** | é€šè¿‡ `SET DEBUG_SYNC = '...'` SQL å‘½ä»¤ |  
| **é€‚ç”¨ç¯å¢ƒ** | ä»…é™è°ƒè¯•ç‰ˆ MySQLï¼Œç”¨äºå¼€å‘/æµ‹è¯• |  
| **æ˜¯å¦ç”Ÿäº§å¯ç”¨** | âŒ å¦ï¼ˆæ€§èƒ½å¼€é”€å¤§ï¼Œä¸”é»˜è®¤ä¸ç¼–è¯‘ï¼‰ |  
| **ç±»ä¼¼æŠ€æœ¯** | ç±»ä¼¼äº Java ä¸­çš„ `CountDownLatch` + æ³¨å…¥ç‚¹ï¼Œä½†é›†æˆåœ¨æ•°æ®åº“å†…æ ¸ä¸­ |  
  
### å‚è€ƒèµ„æ–™  
- MySQL å®˜æ–¹æ–‡æ¡£ï¼š[Debug Sync Facility](https://dev.mysql.com/doc/refman/8.0/en/debug-sync.html)  
- MySQL æºç ï¼š`sql/debug_sync.cc`  
- MySQL æµ‹è¯•ç”¨ä¾‹ï¼š`mysql-test/t/` ç›®å½•ä¸‹å¤§é‡ `.test` æ–‡ä»¶ä½¿ç”¨äº† `debug_sync`  
  
> ğŸ’¡ å¦‚æœä½ åœ¨é˜…è¯» MySQL æºç æˆ–æµ‹è¯•ç”¨ä¾‹æ—¶çœ‹åˆ° `DEBUG_SYNC`ï¼Œç°åœ¨ä½ å°±çŸ¥é“å®ƒæ˜¯ç”¨æ¥â€œè®©çº¿ç¨‹åœ¨æŸå¤„æš‚åœï¼Œç­‰æµ‹è¯•è„šæœ¬å‘å·æ–½ä»¤â€çš„è°ƒè¯•ç¥å™¨äº†ã€‚  
    
#### [æœŸæœ› PostgreSQL|å¼€æºPolarDB å¢åŠ ä»€ä¹ˆåŠŸèƒ½?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB å¼€æºæ•°æ®åº“](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB å­¦ä¹ å›¾è°±](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL è§£å†³æ–¹æ¡ˆé›†åˆ](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [å¾·å“¥ / digoal's Github - å…¬ç›Šæ˜¯ä¸€è¾ˆå­çš„äº‹.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About å¾·å“¥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
