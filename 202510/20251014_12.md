## 何为MySQL 调试同步基础设施(Debug Synchronization Infrastructure)?  
                              
### 作者                      
digoal                      
                              
### 日期                        
2025-10-14                            
                       
### 标签                            
PostgreSQL , PolarDB , DuckDB , MySQL , OceanBase                       
                             
----                         
                         
## 背景    
在阅读OB代码解读文件时, 里面多次提到debug synch point, 没想原来是继承自MySQL调试思想.     
    
Qwen 解读如下.    
    
**Debug Synchronization Infrastructure（调试同步基础设施）** 是 **MySQL 数据库内部** 为开发和测试目的而设计的一套**用于控制和观察线程执行顺序的调试机制**。它的核心目标是：**在多线程并发环境中，精确控制某些关键代码点的执行时机，以便复现和调试竞态条件（race conditions）、死锁、时序相关 bug 等难以复现的问题**。  
  
> ⚠️ 注意：这是 **MySQL 内部的调试功能**，**不是 PostgreSQL 或其他数据库的功能**。它仅在 **MySQL 源码编译时启用调试选项（如 `WITH_DEBUG`）** 后才可用，**生产环境默认关闭**。  
  
### 一、为什么需要它？  
  
MySQL 是高度并发的多线程系统（连接线程、InnoDB 后台线程、复制线程等）。很多 bug（如死锁、数据不一致）只在特定线程调度顺序下才会触发，极难复现。  
  
例如：  
- 线程 A 执行到某处时，线程 B 必须尚未执行某操作；  
- 或者需要让线程 A 在某个临界点“暂停”，等测试脚本完成某些检查后再继续。  
  
传统调试器（如 GDB）难以精确控制多个线程的执行节奏。**Debug Sync** 就是为解决这个问题而生的。  
  
### 二、核心原理  
  
Debug Sync 通过在 MySQL 源码中预埋 **“同步点（synchronization points）”**，允许外部（通常是测试脚本）通过 SQL 命令控制这些点的行为。  
  
#### 1. **同步点（Sync Point）**  
在源码中插入类似这样的宏：  
```cpp  
DEBUG_SYNC(thd, "before_acquiring_lock");  
```  
这表示：当线程执行到这里时，会检查是否对该同步点设置了“动作”。  
  
#### 2. **动作（Action）**  
通过 SQL 动态设置某个同步点的行为，例如：  
```sql  
SET DEBUG_SYNC = 'before_acquiring_lock WAIT_FOR go_signal';  
```  
含义：当任何线程执行到 `before_acquiring_lock` 时，**暂停并等待**名为 `go_signal` 的信号。  
  
然后在测试脚本中：  
```sql  
-- 其他操作（如检查状态）  
-- ...  
-- 发送信号，让等待的线程继续  
SET DEBUG_SYNC = 'now SIGNAL go_signal';  
```  
  
### 三、常用动作类型  
  
| 动作语法 | 说明 |  
|--------|------|  
| `'point' WAIT_FOR signal_name` | 在 `point` 处暂停，等待 `signal_name` 信号 |  
| `'now' SIGNAL signal_name` | 立即发送 `signal_name` 信号（唤醒等待者） |  
| `'point' SIGNAL signal_name` | 执行到 `point` 时自动发送信号 |  
| `'point' EXECUTE 1` | 每次执行到 `point` 时触发一次（可用于计数） |  
| `'point' TIMEOUT 10` | 等待最多 10 秒，超时则继续 |  
  
### 四、典型使用场景（MySQL 测试）  
  
在 MySQL 的官方测试套件（如 `mysql-test-run.pl`）中广泛使用：  
  
```sql  
-- 测试：模拟在获取锁前被中断  
connection con1;  
SET DEBUG_SYNC = 'before_acquiring_lock WAIT_FOR go';  
-- 执行会触发该同步点的语句（如 UPDATE）  
send UPDATE t1 SET a = 1;  
  
connection con2;  
-- 此时 con1 已暂停在 before_acquiring_lock  
-- 可以检查 InnoDB 状态、锁信息等  
-- ...  
-- 发送信号让 con1 继续  
SET DEBUG_SYNC = 'now SIGNAL go';  
  
connection con1;  
-- 等待 UPDATE 完成  
reap;  
```  
  
这样就能**精确控制并发时序**，验证特定场景下的行为。  
  
### 五、如何启用？  
  
1. **编译 MySQL 时启用调试**：  
   ```bash  
   cmake . -DWITH_DEBUG=1  
   ```  
2. **启动 MySQL 后，通过 `SET DEBUG_SYNC` 控制**（仅对当前会话有效）。  
  
> 📌 普通用户或生产环境**无法使用**此功能，因为它会显著降低性能，且需要调试版二进制文件。  
  
### 六、与 PostgreSQL 的区别  
  
- **PostgreSQL 没有完全相同的机制**。  
- PostgreSQL 调试并发问题通常依赖：  
  - `pg_locks` 系统视图  
  - 手动插入 `pg_sleep()`（但无法精确控制线程调度）  
  - 使用 GDB + 多进程 attach  
  - 内部也有类似 `PROBE` 的 DTrace/SystemTap 探针，但不如 MySQL 的 Debug Sync 灵活  
  
### 七、总结  
  
| 项目 | 说明 |  
|------|------|  
| **是什么** | MySQL 内置的线程同步调试框架 |  
| **目的** | 精确控制多线程执行顺序，复现并发 bug |  
| **使用方式** | 通过 `SET DEBUG_SYNC = '...'` SQL 命令 |  
| **适用环境** | 仅限调试版 MySQL，用于开发/测试 |  
| **是否生产可用** | ❌ 否（性能开销大，且默认不编译） |  
| **类似技术** | 类似于 Java 中的 `CountDownLatch` + 注入点，但集成在数据库内核中 |  
  
### 参考资料  
- MySQL 官方文档：[Debug Sync Facility](https://dev.mysql.com/doc/refman/8.0/en/debug-sync.html)  
- MySQL 源码：`sql/debug_sync.cc`  
- MySQL 测试用例：`mysql-test/t/` 目录下大量 `.test` 文件使用了 `debug_sync`  
  
> 💡 如果你在阅读 MySQL 源码或测试用例时看到 `DEBUG_SYNC`，现在你就知道它是用来“让线程在某处暂停，等测试脚本发号施令”的调试神器了。  
    
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
