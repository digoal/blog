## VectorChord 源码学习: 5.5 Docker 部署 (Deployment)     
                                  
### 作者                                  
digoal                                  
                                  
### 日期                                  
2025-11-03                                  
                                  
### 标签                                  
VectorChord , 源码学习                                  
                                  
----                                  
                                  
## 背景                                  
本文介绍如何使用预构建的容器镜像 (container images) 和 Docker 配置进行基于 Docker 的 VectorChord 部署 (deployment)。  
  
## Docker 镜像架构 (Image Architecture)  
  
VectorChord 提供了多个 Docker 镜像变体 (image variants)，以支持不同的部署场景 (deployment scenarios) 和 PostgreSQL 版本。  
  
![pic](20251103_07_pic_001.jpg)  
  
来源: [`README.md` 66-73](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L66-L73)  
  
## 快速开始部署 (Quick Start Deployment)  
  
部署 VectorChord 最简单的方法是使用带有默认配置的预构建 Docker 镜像 (image)。  
  
### 基础容器设置 (Basic Container Setup)  
  
```  
docker run \
  --name vectorchord-demo \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -p 5432:5432 \
  -d ghcr.io/tensorchord/vchord-postgres:pg18-v0.5.3  
```    
  
### 连接和扩展设置 (Connection and Extension Setup)  
  
```  
# Connect to the database  
psql -h localhost -p 5432 -U postgres  
  
# Enable the extension  
CREATE EXTENSION IF NOT EXISTS vchord CASCADE;  
```  
  
![pic](20251103_07_pic_002.jpg)  
  
来源: [`README.md` 66-87](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L66-L87)  
  
## Docker 镜像变体 (Image Variants)  
  
### 基础 VectorChord 镜像 (Base Image)  
  
标准镜像 (image) 包含带有 pgvector 依赖项 (dependency) 的 VectorChord 扩展 (extension):  
  
* 镜像 (Image): `ghcr.io/tensorchord/vchord-postgres:pg18-v0.5.3`  
* 注册表 (Registry): GitHub 容器注册表 (Container Registry) 和 Docker Hub  
* 组件 (Components): `PostgreSQL`, `pgvector`, `VectorChord` 扩展 (extension)  
  
### 一体化套件镜像 (All-in-One Suite Image)  
  
包含多个 TensorChord 扩展 (extensions) 的综合镜像 (image):  
  
* 镜像 (Image): `tensorchord/vchord-suite:pg17-latest`  
* 附加扩展 (Additional extensions): `VectorChord-bm25`, `pg_tokenizer.rs`  
* 用例 (Use case): 完整的文本和向量搜索解决方案  
  
![pic](20251103_07_pic_003.jpg)  
  
来源: [`README.md` 73](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L73-L73)  
  
## 环境变量配置 (Environment Configuration)  
  
### 必要的环境变量 (Essential Environment Variables)  
  
| Variable | 用途 (Purpose) | 默认值 (Default) | 示例 (Example) |  
| :--- | :--- | :--- | :--- |  
| `POSTGRES_PASSWORD` | 数据库密码 (Database password) | Required (必需) | `mysecretpassword` |  
| `POSTGRES_USER` | 数据库用户 (Database user) | `postgres` | `vectoruser` |  
| `POSTGRES_DB` | 数据库名称 (Database name) | `postgres` | `vectordb` |  
  
### 卷挂载 (Volume Mounting) 以实现持久性 (Persistence)  
  
```  
docker run \
  --name vectorchord-persistent \
  -e POSTGRES_PASSWORD=mysecretpassword \
  -p 5432:5432 \
  -v vectorchord_data:/var/lib/postgresql/data \
  -d ghcr.io/tensorchord/vchord-postgres:pg18-v0.5.3  
```    
  
### PostgreSQL 配置调优 (Configuration Tuning)  
  
可通过环境变量 (environment variables) 或挂载的配置文件 (config files) 进行配置的关键参数 (parameters):  
  
* `max_parallel_maintenance_workers`: 用于索引构建性能  
* `max_parallel_workers`: 用于查询执行  
* `effective_io_concurrency`: 用于存储 I/O 优化  
  
来源: [`README.md` 66-71](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L66-L71) [`scripts/bench.py` 77-81](https://github.com/tensorchord/VectorChord/blob/ac12e257/scripts/bench.py#L77-L81)  
  
## 与外部 Python 工具的集成 (Integration)  
  
Docker 部署 (deployment) 与外部 Python 脚本集成 (integrates)，用于数据处理 (data processing) 和基准测试 (benchmarking)。  
  
![pic](20251103_07_pic_004.jpg)  
  
### 外部工具的连接配置 (Connection Configuration)  
  
Python 脚本使用标准 PostgreSQL 连接字符串 (connection strings) 连接到 Docker 容器 (container):  
  
```  
# Example connection from scripts  
url = "postgresql://postgres:123@localhost:5432/postgres"  
```  
  
脚本会自动处理扩展设置 (extension setup):  
  
* `CREATE EXTENSION IF NOT EXISTS vector`  
* `CREATE EXTENSION IF NOT EXISTS vchord`  
  
来源: [`scripts/dump.py` 44](https://github.com/tensorchord/VectorChord/blob/ac12e257/scripts/dump.py#L44-L44) [`scripts/bench.py` 72-73](https://github.com/tensorchord/VectorChord/blob/ac12e257/scripts/bench.py#L72-L73) [`scripts/index.py` 126-127](https://github.com/tensorchord/VectorChord/blob/ac12e257/scripts/index.py#L126-L127)  
  
## Docker Compose 部署 (Deployment)  
  
对于带有附加服务 (additional services) 的类生产环境 (production-like) 部署 (deployments):  
  
```  
version: '3.8'  
services:  
  vectorchord:  
    image: ghcr.io/tensorchord/vchord-postgres:pg18-v0.5.3  
    environment:  
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}  
      POSTGRES_DB: vectordb  
    ports:  
      - "5432:5432"  
    volumes:  
      - vectorchord_data:/var/lib/postgresql/data  
      - ./postgresql.conf:/etc/postgresql/postgresql.conf  
    command: postgres -c config_file=/etc/postgresql/postgresql.conf  
      
volumes:  
  vectorchord_data:  
```    
  
### 多容器架构 (Multi-container Architecture)  
  
![pic](20251103_07_pic_005.jpg)  
  
来源: [`README.md` 66-71](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L66-L71)  
  
## 镜像标签 (Image Tags) 和版本控制 (Versioning)  
  
### 标签结构 (Tag Structure)  
  
* 模式 (Pattern): `pg{version}-v{vectorchord_version}`  
* 示例 (Example): `pg18-v0.5.3`  
* 最新 (Latest): `pg17-latest` (适用于套件镜像)  
  
### 版本兼容性矩阵 (Version Compatibility Matrix)  
  
| VectorChord 版本 (Version) | PostgreSQL 17 | PostgreSQL 18 | 镜像标签 (Image Tag) |  
| :--- | :--- | :--- | :--- |  
| `v0.5.3` | ✓ | ✓ | `pg18-v0.5.3` |  
| `latest` | ✓ | ✓ | `pg17-latest` |  
  
### 注册表位置 (Registry Locations)  
  
* 主要 (Primary): `ghcr.io/tensorchord/vchord-postgres`  
* 镜像 (Mirror): `tensorchord/vchord-postgres` (Docker Hub)  
* 套件 (Suite): `tensorchord/vchord-suite`  
  
来源: [`README.md` 70](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L70-L70) [`README.md` 73](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L73-L73)  
  
## 性能考量 (Performance Considerations)  
  
### 容器资源分配 (Container Resource Allocation)  
  
针对不同工作负载 (workloads) 推荐的 Docker 资源限制 (resource limits):  
  
| 工作负载规模 (Workload Size) | 内存 (Memory) | CPU | 存储 (Storage) |  
| :--- | :--- | :--- | :--- |  
| Development (开发) | 2GB | 2 cores (核) | 10GB |  
| Small Production (小型生产环境) | 8GB | 4 cores (核) | 100GB |  
| Large Production (大型生产环境) | 32GB+ | 8+ cores (核) | 1TB+ |  
  
### 容器中的索引构建 (Index Building)  
  
对于大型数据集 (datasets)，请考虑:  
  
* 挂载临时存储 (temporary storage) 以进行索引构建 (index building)  
* 增加 `max_parallel_maintenance_workers`  
* 使用 Python 工具进行外部质心计算 (centroid computation)  
  
来源: [`README.md` 43](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L43-L43) [`scripts/index.py` 52-60](https://github.com/tensorchord/VectorChord/blob/ac12e257/scripts/index.py#L52-L60)  
  
## 故障排除 (Troubleshooting)  
  
### 常见问题 (Common Issues)  
  
1.  **扩展未找到 (Extension Not Found)**: 确保执行了 `CREATE EXTENSION vchord CASCADE`  
2.  **连接被拒绝 (Connection Refused)**: 验证端口映射 (port mapping) 和容器状态 (container status)  
3.  **性能问题 (Performance Issues)**: 检查资源分配 (resource allocation) 和 PostgreSQL 配置 (configuration)  
  
### 调试命令 (Debugging Commands)  
  
```  
# Check container logs  
docker logs vectorchord-demo  
  
# Access container shell  
docker exec -it vectorchord-demo bash  
  
# Verify extension installation  
docker exec -it vectorchord-demo psql -U postgres -c "\dx"  
```  
  
来源: [`README.md` 75-87](https://github.com/tensorchord/VectorChord/blob/ac12e257/README.md#L75-L87)  
    
#### [期望 PostgreSQL|开源PolarDB 增加什么功能?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB 开源数据库](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
