## pgvector æºç å­¦ä¹ : 2 å‘é‡æ•°æ®ç±»å‹ï¼ˆ`Vector Data Types`ï¼‰  
                                            
### ä½œè€…                                            
digoal                                            
                                            
### æ—¥æœŸ                                            
2025-11-03                                            
                                            
### æ ‡ç­¾                                            
pgvector , æºç å­¦ä¹                                             
                                            
----                                            
                                            
## èƒŒæ™¯                                            
æœ¬æ–‡è¯¦ç»†ä»‹ç» `pgvector` æ”¯æŒçš„4ç§**å‘é‡æ•°æ®ç±»å‹**ï¼ˆ`vector data types`ï¼‰åŠå…¶**å†…éƒ¨ç»“æ„**ï¼ˆ`internal structures`ï¼‰ã€**å†…å­˜å¸ƒå±€**ï¼ˆ`memory layouts`ï¼‰å’Œ**ç±»å‹ç³»ç»Ÿé›†æˆ**ï¼ˆ`type system integration`ï¼‰ã€‚è¿™äº›æ•°æ®ç±»å‹æ„æˆäº† PostgreSQL ä¸­**å‘é‡ç›¸ä¼¼æ€§æœç´¢**ï¼ˆ`vector similarity search`ï¼‰æ“ä½œå’Œ**ç´¢å¼•**ï¼ˆ`indexing`ï¼‰çš„åŸºç¡€ã€‚  
  
### æ•°æ®ç±»å‹æ¦‚è¿°ï¼ˆ`Data Type Overview`ï¼‰  
  
`pgvector` æä¾›äº†å››ç§ä¸åŒçš„**å‘é‡æ•°æ®ç±»å‹**ï¼ˆ`vector data types`ï¼‰ï¼Œæ¯ç§éƒ½é’ˆå¯¹ä¸åŒçš„ç”¨ä¾‹å’Œå†…å­˜è¦æ±‚è¿›è¡Œäº†ä¼˜åŒ–ï¼š  
  
| ç±»å‹ï¼ˆ`Type`ï¼‰ | å…ƒç´ å¤§å°ï¼ˆ`Element Size`ï¼‰ | æœ€å¤§ç»´åº¦ï¼ˆ`Max Dimensions`ï¼‰ | ä¸»è¦ç”¨ä¾‹ï¼ˆ`Primary Use Case`ï¼‰ |  
| :--- | :--- | :--- | :--- |  
| `vector` | 32 ä½æµ®ç‚¹æ•°ï¼ˆ`32-bit float`ï¼‰ | 16,000 | é€šç”¨**å¯†é›†å‘é‡**ï¼ˆ`General-purpose dense vectors`ï¼‰ |  
| `halfvec` | 16 ä½åŠç²¾åº¦æµ®ç‚¹æ•°ï¼ˆ`16-bit half-float`ï¼‰ | 16,000 | **å†…å­˜é«˜æ•ˆçš„å¯†é›†å‘é‡**ï¼ˆ`Memory-efficient dense vectors`ï¼‰ |  
| `sparsevec` | 32 ä½æµ®ç‚¹æ•°ï¼ˆ`32-bit float`ï¼‰ | 1,000,000,000 (æ³¨æ„ä¸æ˜¯æŒ‡éé›¶å…ƒç´ ä¸ªæ•°) | **é«˜ç»´ç¨€ç–å‘é‡**ï¼ˆ`High-dimensional sparse vectors`ï¼‰ |  
| `bit` | 1 ä½äºŒè¿›åˆ¶ï¼ˆ`1-bit binary`ï¼‰ | å¯å˜ï¼ˆ`Variable`ï¼‰ | **äºŒè¿›åˆ¶é‡åŒ–å‘é‡**ï¼ˆ`Binary quantized vectors`ï¼‰ |  
  
#### ç±»å‹å±‚æ¬¡ç»“æ„å’Œå…³ç³»ï¼ˆ`Type Hierarchy and Relationships`ï¼‰  
  
![pic](20251103_12_pic_001.jpg)    
  
æ¥æº:  
[`src/vector.h` 11-17](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.h#L11-L17)  
[`src/halfvec.h` 60-66](https://github.com/pgvector/pgvector/blob/d823c445/src/halfvec.h#L60-L66)  
[`src/sparsevec.h` 15-22](https://github.com/pgvector/pgvector/blob/d823c445/src/sparsevec.h#L15-L22)  
[`sql/vector.sql` 6-30](https://github.com/pgvector/pgvector/blob/d823c445/sql/vector.sql#L6-L30)  
  
### å†…éƒ¨å†…å­˜å¸ƒå±€ï¼ˆ`Internal Memory Layouts`ï¼‰  
  
æ¯ç§å‘é‡ç±»å‹éƒ½ä½¿ç”¨ PostgreSQL çš„ `varlena` **ç»“æ„**ï¼ˆ`structure`ï¼‰æ¥å­˜å‚¨**å¯å˜é•¿åº¦æ•°æ®**ï¼ˆ`variable-length data`ï¼‰ï¼Œå¹¶é‡‡ç”¨ç‰¹å®šäºç±»å‹çš„å¸ƒå±€è¿›è¡Œ**å…ƒç´ å­˜å‚¨**ï¼ˆ`element storage`ï¼‰ï¼š  
  
#### å¯†é›†&ç¨€ç–å‘é‡å†…å­˜å¸ƒå±€æ¯”è¾ƒï¼ˆ`Dense & Sparse Vector Memory Layout Comparison`ï¼‰  
  
![pic](20251103_12_pic_002.jpg)    
  
æ¥æº:  
[`src/vector.h` 11-17](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.h#L11-L17)  
[`src/halfvec.h` 60-66](https://github.com/pgvector/pgvector/blob/d823c445/src/halfvec.h#L60-L66)  
[`src/sparsevec.h` 15-36](https://github.com/pgvector/pgvector/blob/d823c445/src/sparsevec.h#L15-L36)  
  
#### å†…å­˜å¤§å°è®¡ç®—ï¼ˆ`Memory Size Calculations`ï¼‰  
  
æ¯ç§ç±»å‹çš„**å†…å­˜å ç”¨**ï¼ˆ`memory footprint`ï¼‰ç”±ç‰¹å®šçš„**å¤§å°è®¡ç®—å®**ï¼ˆ`size calculation macros`ï¼‰ç¡®å®šï¼š  
  
* **vector**: `VECTOR_SIZE(dim) = offsetof(Vector, x) + sizeof(float) * dim`  
* **halfvec**: `HALFVEC_SIZE(dim) = offsetof(HalfVector, x) + sizeof(half) * dim`  
* **sparsevec**: `SPARSEVEC_SIZE(nnz) = offsetof(SparseVector, indices) + (nnz * sizeof(int32)) + (nnz * sizeof(float))`  
  
æ¥æº:  
[`src/vector.h` 6](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.h#L6-L6)  
[`src/halfvec.h` 55](https://github.com/pgvector/pgvector/blob/d823c445/src/halfvec.h#L55-L55)  
[`src/sparsevec.h` 26-30](https://github.com/pgvector/pgvector/blob/d823c445/src/sparsevec.h#L26-L30)  
  
### PostgreSQL ç±»å‹ç³»ç»Ÿé›†æˆï¼ˆ`PostgreSQL Type System Integration`ï¼‰  
  
`pgvector` é€šè¿‡æ ‡å‡†çš„**ç±»å‹å®šä¹‰å‡½æ•°**ï¼ˆ`type definition functions`ï¼‰å’Œ**è¿ç®—ç¬¦ç±»**ï¼ˆ`operator classes`ï¼‰ä¸ PostgreSQL çš„ç±»å‹ç³»ç»Ÿé›†æˆï¼š  
  
#### ç±»å‹å®šä¹‰ç»“æ„ï¼ˆ`Type Definition Structure`ï¼‰  
  
![pic](20251103_12_pic_003.jpg)    
  
æ¥æº:  
[`sql/vector.sql` 6-30](https://github.com/pgvector/pgvector/blob/d823c445/sql/vector.sql#L6-L30)  
[`src/vector.c` 165-270](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.c#L165-L270)  
[`src/vector.c` 331-357](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.c#L331-L357)  
  
### ç±»å‹è½¬æ¢å’Œç±»å‹è½¬æ¢ï¼ˆ`Type Conversions and Casting`ï¼‰  
  
`pgvector` æä¾›äº†**å‘é‡ç±»å‹**ï¼ˆ`vector types`ï¼‰å’Œ PostgreSQL **å†…ç½®ç±»å‹**ï¼ˆ`built-in types`ï¼‰ä¹‹é—´çš„å…¨é¢ç±»å‹è½¬æ¢èƒ½åŠ›ï¼š  
  
#### è½¬æ¢è·¯å¾„ï¼ˆ`Conversion Pathways`ï¼‰  
  
![pic](20251103_12_pic_004.jpg)    
  
æ¥æº:  
[`sql/vector.sql` 132-171](https://github.com/pgvector/pgvector/blob/d823c445/sql/vector.sql#L132-L171)  
[`src/vector.c` 432-501](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.c#L432-L501)  
[`src/halfvec.c` 425-494](https://github.com/pgvector/pgvector/blob/d823c445/src/halfvec.c#L425-L494)  
  
#### ç±»å‹è½¬æ¢ï¼ˆ`Cast Types`ï¼‰åŠå…¶è¡Œä¸ºï¼ˆ`Behavior`ï¼‰  
  
`pgvector` ä¸ºå„ç§è½¬æ¢åœºæ™¯å®šä¹‰äº†ä¸åŒçš„**ç±»å‹è½¬æ¢**ï¼ˆ`cast types`ï¼‰ï¼š  
  
| ä»ç±»å‹ï¼ˆ`From Type`ï¼‰ | åˆ°ç±»å‹ï¼ˆ`To Type`ï¼‰ | è½¬æ¢ç±»å‹ï¼ˆ`Cast Type`ï¼‰ | å‡½æ•°ï¼ˆ`Function`ï¼‰ |  
| :--- | :--- | :--- | :--- |  
| `integer[]` | `vector` | **èµ‹å€¼**ï¼ˆ`ASSIGNMENT`ï¼‰ | `array_to_vector` |  
| `vector` | `halfvec` | **éšå¼**ï¼ˆ`IMPLICIT`ï¼‰ | `vector_to_halfvec` |  
| `halfvec` | `vector` | **èµ‹å€¼**ï¼ˆ`ASSIGNMENT`ï¼‰ | `halfvec_to_vector` |  
| `vector` | `sparsevec` | **éšå¼**ï¼ˆ`IMPLICIT`ï¼‰ | `vector_to_sparsevec` |  
| `vector` | `bit` | **æ˜¾å¼**ï¼ˆ`EXPLICIT`ï¼‰ | `binary_quantize` |  
  
æ¥æº:  
[`sql/vector.sql` 154-171](https://github.com/pgvector/pgvector/blob/d823c445/sql/vector.sql#L154-L171)  
[`sql/vector.sql` 490-512](https://github.com/pgvector/pgvector/blob/d823c445/sql/vector.sql#L490-L512)  
[`sql/vector.sql` 799-824](https://github.com/pgvector/pgvector/blob/d823c445/sql/vector.sql#L799-L824)  
  
### ç»´åº¦çº¦æŸï¼ˆ`Dimensional Constraints`ï¼‰  
  
æ¯ç§å‘é‡ç±»å‹éƒ½é€šè¿‡**éªŒè¯å‡½æ•°**ï¼ˆ`validation functions`ï¼‰æ¥æ‰§è¡Œ**ç»´åº¦çº¦æŸ**ï¼ˆ`dimensional constraints`ï¼‰ï¼š  
  
#### çº¦æŸå®šä¹‰ï¼ˆ`Constraint Definitions`ï¼‰  
  
![pic](20251103_12_pic_005.jpg)    
  
æ¥æº:  
[`src/vector.h` 4](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.h#L4-L4)  
[`src/halfvec.h` 53](https://github.com/pgvector/pgvector/blob/d823c445/src/halfvec.h#L53-L53)  
[`src/sparsevec.h` 4-5](https://github.com/pgvector/pgvector/blob/d823c445/src/sparsevec.h#L4-L5)  
[`src/vector.c` 84-96](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.c#L84-L96)  
[`src/halfvec.c` 84-96](https://github.com/pgvector/pgvector/blob/d823c445/src/halfvec.c#L84-L96)  
  
#### ç±»å‹ä¿®é¥°ç¬¦éªŒè¯ï¼ˆ`Type Modifier Validation`ï¼‰  
  
å‘é‡ç±»å‹æ”¯æŒ PostgreSQL çš„**ç±»å‹ä¿®é¥°ç¬¦**ï¼ˆ`type modifiers`ï¼‰ç”¨äºæŒ‡å®šç»´åº¦ï¼š  
  
* `vector(1536)` - å°† `vector` çº¦æŸä¸ºæ°å¥½ 1536 ä¸ªç»´åº¦  
* `halfvec(512)` - å°† `halfvec` çº¦æŸä¸º 512 ä¸ªç»´åº¦  
* `sparsevec(10000)` - çº¦æŸ `sparsevec` çš„æ€»ç»´åº¦  
  
`typmod_in` å‡½æ•°åœ¨ç±»å‹åˆ›å»ºå’Œ**ç±»å‹è½¬æ¢**ï¼ˆ`casting`ï¼‰æ“ä½œæœŸé—´éªŒè¯è¿™äº›çº¦æŸã€‚  
  
æ¥æº:  
[`src/vector.c` 331-357](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.c#L331-L357)  
[`src/halfvec.c` 325-351](https://github.com/pgvector/pgvector/blob/d823c445/src/halfvec.c#L325-L351)  
[`sql/vector.sql` 14-16](https://github.com/pgvector/pgvector/blob/d823c445/sql/vector.sql#L14-L16)  
  
### å…ƒç´ éªŒè¯å’Œçº¦æŸï¼ˆ`Element Validation and Constraints`ï¼‰  
  
æ‰€æœ‰å‘é‡ç±»å‹éƒ½æ‰§è¡Œ**å…ƒç´ çº§çº¦æŸ**ï¼ˆ`element-level constraints`ï¼‰ä»¥ç¡®ä¿**æ•°å­¦æœ‰æ•ˆæ€§**ï¼ˆ`mathematical validity`ï¼‰ï¼š  
  
#### å€¼çº¦æŸï¼ˆ`Value Constraints`ï¼‰  
  
* **ä»…é™æœ‰é™å€¼**ï¼ˆ`Finite Values Only`ï¼‰ï¼šæ‹’ç» **NaN**ï¼ˆéæ•°å­—ï¼‰å’Œ**æ— é™å€¼**ï¼ˆ`infinite values`ï¼‰  
* **ç±»å‹ç‰¹å®šèŒƒå›´**ï¼ˆ`Type-Specific Ranges`ï¼‰ï¼šæ¯ç§ç±»å‹éƒ½å¼ºåˆ¶æ‰§è¡Œå…¶**æ•°å€¼èŒƒå›´é™åˆ¶**ï¼ˆ`numeric range limits`ï¼‰  
* **æº¢å‡ºæ£€æµ‹**ï¼ˆ`Overflow Detection`ï¼‰ï¼šç®—æœ¯è¿ç®—ä¼šæ£€æŸ¥**æº¢å‡ºæ¡ä»¶**ï¼ˆ`overflow conditions`ï¼‰  
  
æ¯ä¸ªå®ç°ä¸­çš„ `CheckElement` å‡½æ•°åœ¨**è¾“å…¥å¤„ç†**ï¼ˆ`input processing`ï¼‰å’Œ**æ•°å­¦è¿ç®—**ï¼ˆ`mathematical operations`ï¼‰æœŸé—´éªŒè¯è¿™äº›çº¦æŸã€‚  
  
æ¥æº:  
[`src/vector.c` 101-113](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.c#L101-L113)  
[`src/halfvec.c` 101-113](https://github.com/pgvector/pgvector/blob/d823c445/src/halfvec.c#L101-L113)  
[`src/vector.c` 231](https://github.com/pgvector/pgvector/blob/d823c445/src/vector.c#L231-L231)  
[`src/halfvec.c` 232](https://github.com/pgvector/pgvector/blob/d823c445/src/halfvec.c#L232-L232)  
  
# é™„å½•1: `sparsevec` ç±»å‹çš„æœ€å¤§ç»´åº¦é™åˆ¶  
`sparsevec` ç±»å‹æœ€å¤§æ”¯æŒ **1,000,000,000 (10äº¿) ç»´åº¦**ã€‚   
  
è¿™ä¸ªé™åˆ¶åœ¨ä»£ç ä¸­å®šä¹‰ä¸ºå¸¸é‡ `SPARSEVEC_MAX_DIM`ã€‚   
  
å½“æ‚¨å°è¯•åˆ›å»ºè¶…è¿‡æ­¤é™åˆ¶çš„ç¨€ç–å‘é‡æ—¶,ç³»ç»Ÿä¼šæŠ›å‡ºé”™è¯¯ã€‚ éªŒè¯é€»è¾‘åœ¨ `CheckDim()` å‡½æ•°ä¸­å®ç°,è¯¥å‡½æ•°åœ¨è¾“å…¥è§£ææ—¶è¢«è°ƒç”¨ã€‚   
  
æµ‹è¯•ç”¨ä¾‹ä¹ŸéªŒè¯äº†è¿™ä¸ªé™åˆ¶.   
  
## å…¶ä»–ç›¸å…³é™åˆ¶  
  
é™¤äº†ç»´åº¦é™åˆ¶,`sparsevec` è¿˜æœ‰ä»¥ä¸‹çº¦æŸ:  
- **æœ€å¤§éé›¶å…ƒç´ æ•°**: 16,000 ä¸ª   
- **æœ€å°ç»´åº¦**: 1    
  
å¯¹äº HNSW ç´¢å¼•, éé›¶å…ƒç´ æ•°çš„é™åˆ¶å¯èƒ½æ›´ä¸¥æ ¼ã€‚   
  
## Notes  
  
ç›¸æ¯”ä¹‹ä¸‹,å¯†é›†å‘é‡ç±»å‹ `vector` å’Œ `halfvec` çš„æœ€å¤§ç»´åº¦é™åˆ¶è¦å°å¾—å¤š(åˆ†åˆ«ä¸º 2,000 å’Œ 4,000 ç»´)ã€‚ `sparsevec` çš„é«˜ç»´åº¦é™åˆ¶æ˜¯å› ä¸ºå®ƒåªå­˜å‚¨éé›¶å…ƒç´ ,æ‰€ä»¥å³ä½¿ç»´åº¦å¾ˆå¤§,åªè¦éé›¶å…ƒç´ ä¸è¶…è¿‡ 16,000 ä¸ª,å­˜å‚¨ç©ºé—´ä»ç„¶å¯æ§ã€‚   
  
# é™„å½•2: å¯¹æ¯”pgvectorä¸­çš„ç¨€ç–å‘é‡å’Œpg_roaringbitmapä¸­çš„roaringbitmapæ•°æ®ç±»å‹å’Œä½¿ç”¨åœºæ™¯  
  
## ç¨€ç–å‘é‡ï¼ˆ`sparsevec`ï¼‰ vs. Roaring Bitmapsï¼ˆ`roaringbitmap`ï¼‰  
  
### ğŸ“Š æ•°æ®ç±»å‹å’Œæ ¸å¿ƒåŠŸèƒ½å¯¹æ¯”  
  
| ç‰¹æ€§ï¼ˆ`Feature`ï¼‰ | `pgvector` ä¸­çš„ `sparsevec` | `pg_roaringbitmap` ä¸­çš„ `roaringbitmap` |  
| :--- | :--- | :--- |  
| **æ•°æ®ç±»å‹** | **ç¨€ç–å‘é‡**ï¼ˆ`Sparse Vector`ï¼‰ | **å‹ç¼©ä½å›¾**ï¼ˆ`Compressed Bitmap`ï¼‰ |  
| **å­˜å‚¨å†…å®¹** | å­˜å‚¨**ç¨€ç–çš„æµ®ç‚¹æ•°å€¼**ï¼ˆ`sparse float values`ï¼‰ï¼Œå³ç»´åº¦ç´¢å¼•ï¼ˆ`index`ï¼‰å’Œå¯¹åº”çš„éé›¶å€¼ï¼ˆ`value`ï¼‰ã€‚ | å­˜å‚¨**ä¸€ç»„æœ‰åºçš„éè´Ÿæ•´æ•°**ï¼ˆ`set of non-negative integers`ï¼‰ã€‚ |  
| **æ ¸å¿ƒç›®çš„** | **å‘é‡ç›¸ä¼¼æ€§æœç´¢**ï¼ˆ`Vector Similarity Search`ï¼‰ï¼Œè®¡ç®—é«˜ç»´ç¨€ç–æ•°æ®ä¹‹é—´çš„è·ç¦»ã€‚ | **é›†åˆè¿ç®—**ï¼ˆ`Set Operations`ï¼‰å’Œ**å¿«é€Ÿè®¡æ•°/èšåˆ**ï¼ˆ`Fast Counting/Aggregation`ï¼‰ã€‚ |  
| **ä¸»è¦æ“ä½œ** | **è·ç¦»è®¡ç®—**ï¼ˆ`Distance`ï¼‰ï¼šå†…ç§¯ï¼ˆ`Inner Product`ï¼‰ã€ä½™å¼¦è·ç¦»ï¼ˆ`Cosine Distance`ï¼‰ã€L2 è·ç¦»ç­‰ã€‚ | **é›†åˆé€»è¾‘è¿ç®—**ï¼š`OR` (å¹¶é›†)ã€`AND` (äº¤é›†)ã€`XOR` (å¼‚æˆ–)ã€`ANDNOT` (å·®é›†)ï¼›**åŸºæ•°è®¡ç®—**ï¼ˆ`Cardinality`ï¼‰ã€‚ |  
| **ç´¢å¼•æ”¯æŒ** | æ”¯æŒ **HNSW**ã€**IVFFlat**ï¼ˆç”¨äºè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ï¼‰ã€‚ | é€šå¸¸ç”¨äº**å¿«é€Ÿèšåˆ**æˆ–ä½œä¸º**å€’æ’ç´¢å¼•**ï¼ˆ`Inverted Index`ï¼‰çš„æ„å»ºå—ã€‚ |  
| **å…ƒç´ ç±»å‹** | 32 ä½æµ®ç‚¹æ•°ï¼ˆ`32-bit float`ï¼‰ã€‚ | éè´Ÿæ•´æ•°ï¼ˆé€šå¸¸æ˜¯ 32 ä½ï¼‰ã€‚ |  
| **æœ€å¤§ç»´åº¦/å…ƒç´ ** | ç»´åº¦ä¸Šé™éå¸¸é«˜ï¼ˆ$\sim 10^9$ï¼‰ï¼Œä½†é™åˆ¶éé›¶å…ƒç´ æ•°é‡ï¼ˆä¾‹å¦‚ï¼Œ`pgvector` é™åˆ¶ä¸º 1,000 ä¸ªéé›¶å…ƒç´ ï¼‰ã€‚ | å¯å­˜å‚¨ä»»æ„æ•°é‡çš„éè´Ÿæ•´æ•°ï¼ˆé›†åˆå¤§å°ç†è®ºä¸Šä¸å—é™ï¼‰ã€‚ |  
  
### ğŸ’¡ å…¸å‹ä½¿ç”¨åœºæ™¯å¯¹æ¯”  
  
| åœºæ™¯ï¼ˆ`Use Case`ï¼‰ | `pgvector` ä¸­çš„ `sparsevec` | `pg_roaringbitmap` ä¸­çš„ `roaringbitmap` |  
| :--- | :--- | :--- |  
| **ä¿¡æ¯æ£€ç´¢ (IR)** | **ä¼ ç»Ÿ IR æ¨¡å‹**ï¼ˆå¦‚ TF-IDF æˆ– BM25ï¼‰ç”Ÿæˆçš„**è¯è¢‹æ¨¡å‹**ï¼ˆ`Bag-of-Words`ï¼‰ç‰¹å¾å‘é‡ã€‚ | **å€’æ’ç´¢å¼•**ï¼ˆ`Inverted Index`ï¼‰ä¸­å­˜å‚¨åŒ…å«ç‰¹å®šè¯æ±‡çš„**æ–‡æ¡£ ID é›†åˆ**ã€‚ |  
| **æ¨èç³»ç»Ÿ** | **ç”¨æˆ·-ç‰©å“äº¤äº’çŸ©é˜µ**ï¼ˆ`User-Item Interaction Matrix`ï¼‰ä¸­çš„ç¨€ç–ç‰¹å¾ï¼Œç”¨äº**åŸºäºå†…å®¹çš„æ¨è**ã€‚ | **ç”¨æˆ·ç”»åƒ**ï¼ˆ`User Profiling`ï¼‰ä¸­çš„**æ ‡ç­¾é›†åˆ**æˆ–**æƒé™é›†åˆ**ï¼Œå¿«é€Ÿè¿›è¡Œç”¨æˆ·åˆ†ç»„å’Œç­›é€‰ã€‚ |  
| **ç›¸ä¼¼æ€§æœç´¢** | åœ¨ç¨€ç–ç‰¹å¾ç©ºé—´ä¸­æŸ¥æ‰¾**è¿‘ä¼¼æœ€è¿‘é‚»**ï¼ˆ`Approximate Nearest Neighbors`ï¼‰ã€‚ | **æ— æ³•ç›´æ¥ç”¨äºå‘é‡ç›¸ä¼¼æ€§æœç´¢**ã€‚ä¸»è¦ç”¨äº**é›†åˆç›¸ä¼¼æ€§**ï¼ˆå¦‚ Jaccard ç›¸ä¼¼åº¦ï¼‰çš„å¿«é€Ÿé›†åˆæ“ä½œã€‚ |  
| **æ•°æ®èšåˆ/åˆ†æ** | **ä¸é€‚ç”¨äºèšåˆ**ï¼Œå…¶æ ¸å¿ƒç”¨é€”æ˜¯ç›¸ä¼¼æ€§æœç´¢ã€‚ | **å¿«é€Ÿäº¤å‰æŸ¥è¯¢**ï¼ˆ`Faceted Search`ï¼‰ä¸­çš„**ç­›é€‰å’Œè®¡æ•°**ã€‚ä¾‹å¦‚ï¼Œè®¡ç®—åŒæ—¶è´­ä¹°äº† A å’Œ B å•†å“çš„ç”¨æˆ·æ•°é‡ã€‚ |  
| **ç‰¹å¾è¡¨ç¤º** | **æœºå™¨å­¦ä¹ ç‰¹å¾**ï¼Œè¡¨ç¤ºå…·æœ‰è®¸å¤šé›¶å€¼çš„é«˜ç»´æ•°æ®ç‚¹ã€‚ | **æ•°æ®åº“ç´¢å¼•**æˆ–**æƒé™/çŠ¶æ€æ ‡å¿—**ï¼Œè¡¨ç¤ºä¸€ä¸ªå®ä½“ï¼ˆå¦‚ç”¨æˆ·ï¼‰æ‹¥æœ‰çš„ç¦»æ•£ ID é›†åˆã€‚ |  
  
### æ€»ç»“  
  
è¿™ä¸¤è€…è™½ç„¶éƒ½å¤„ç†**ç¨€ç–æ€§**ï¼ˆ`Sparsity`ï¼‰ï¼Œä½†æœåŠ¡äºå®Œå…¨ä¸åŒçš„ç›®çš„ï¼š  
  
1.  **`sparsevec` (pgvector)**ï¼šå…³æ³¨**ç›¸ä¼¼æ€§**å’Œ**æ•°å€¼è·ç¦»**ã€‚å®ƒçš„ç›®çš„æ˜¯å°†ç¨€ç–ç‰¹å¾ç”¨äº **AI/ML é©±åŠ¨çš„æœç´¢å’Œæ¨è**ï¼Œå¹¶åˆ©ç”¨ HNSW/IVFFlat ç­‰ç´¢å¼•æŠ€æœ¯å®ç°é«˜æ•ˆçš„**è¿‘ä¼¼æœ€è¿‘é‚»æœç´¢**ã€‚  
2.  **`roaringbitmap` (pg\_roaringbitmap)**ï¼šå…³æ³¨**é›†åˆ**å’Œ**å¸ƒå°”é€»è¾‘**ã€‚å®ƒçš„ç›®çš„æ˜¯åˆ©ç”¨å…¶æè‡´çš„**å‹ç¼©ç‡**å’Œ**é«˜é€Ÿé›†åˆè¿ç®—**ï¼Œè§£å†³**å¤šç»´åº¦ç­›é€‰**ã€**æ ‡ç­¾èšåˆ**å’Œ**å¿«é€Ÿè®¡æ•°**ç­‰ä¼ ç»Ÿæ•°æ®åˆ†æå’Œç´¢å¼•é—®é¢˜ã€‚  
  
å¦‚æœæ‚¨éœ€è¦è¿›è¡Œè¯­ä¹‰æœç´¢æˆ–åŸºäºç‰¹å¾å‘é‡çš„åŒ¹é…ï¼Œè¯·ä½¿ç”¨ **`sparsevec`**ï¼›å¦‚æœæ‚¨éœ€è¦å¯¹å¤§é‡ç¦»æ•£ ID é›†åˆè¿›è¡Œå¿«é€Ÿçš„**äº¤é›†/å¹¶é›†/è®¡æ•°**æ“ä½œï¼Œè¯·ä½¿ç”¨ **`roaringbitmap`**ã€‚  
  
# é™„å½•3: roaringbitmapå¯ä»¥é«˜é€Ÿè®¡ç®—æ±‰æ˜è·ç¦»å—  
`roaringbitmap` å¯ä»¥ç”¨æ¥ **è®¡ç®—** æ±‰æ˜è·ç¦»ï¼ˆ`Hamming Distance`ï¼‰ï¼Œå¹¶ä¸”ç”±äºå…¶é«˜æ•ˆçš„å®ç°ï¼Œ**è®¡ç®—é€Ÿåº¦ä¼šéå¸¸å¿«**ã€‚  
  
## ğŸš€ Roaring Bitmap ä¸æ±‰æ˜è·ç¦»  
  
æ±‰æ˜è·ç¦»ï¼ˆ`Hamming Distance`ï¼‰çš„æ•°å­¦å®šä¹‰æ˜¯ï¼šåœ¨ä¸¤ä¸ªç­‰é•¿äºŒè¿›åˆ¶ä¸²ï¼ˆæˆ–å‘é‡ï¼‰ä¸­ï¼Œå¯¹åº”ä½ç½®ä¸åŒçš„ä½æ•°ã€‚  
  
$$\text{Hamming Distance}(A, B) = \text{Population Count}(A \oplus B)$$  
  
å…¶ä¸­ï¼š  
* $A$ å’Œ $B$ æ˜¯ä¸¤ä¸ªäºŒè¿›åˆ¶ä¸²ã€‚  
* $\oplus$ æ˜¯**ä½å¼‚æˆ–è¿ç®—**ï¼ˆ`Bitwise XOR`ï¼‰ã€‚  
* $\text{Population Count}$ï¼ˆ æˆ– $\text{Popcount}$ / **ä½é›†è®¡æ•°** ï¼‰æ˜¯è®¡ç®—ç»“æœä¸­â€œ1â€çš„ä¸ªæ•°ã€‚  
  
### `pg_roaringbitmap` çš„å®ç°æ–¹å¼  
  
`pg_roaringbitmap` çš„æ•°æ®ç±»å‹æœ¬è´¨ä¸Šå°±æ˜¯**é«˜æ•ˆå‹ç¼©çš„æ•´æ•°é›†åˆ**ï¼Œå¯ä»¥å°†å…¶è§†ä¸ºä¸€ä¸ª**è¶…å¤§çš„ç¨€ç–äºŒè¿›åˆ¶å‘é‡**ï¼Œå…¶ä¸­é›†åˆä¸­çš„æ•°å­—ä»£è¡¨äºŒè¿›åˆ¶å‘é‡ä¸­â€œ1â€çš„ç´¢å¼•ä½ç½®ã€‚  
  
è¦ä½¿ç”¨ `pg_roaringbitmap` è®¡ç®—æ±‰æ˜è·ç¦»ï¼Œéœ€è¦ä½¿ç”¨å®ƒæä¾›çš„**é›†åˆé€»è¾‘è¿ç®—**å’Œ**åŸºæ•°è®¡ç®—**åŠŸèƒ½ï¼š  
  
1.  **ä½å¼‚æˆ–ï¼ˆXORï¼‰**ï¼š  
    `roaringbitmap` æ‰©å±•æä¾›äº† `rb_xor(bitmap1, bitmap2)` æˆ– `roaringbitmap1 # roaringbitmap2` è¿ç®—ç¬¦ï¼Œç”¨äºè®¡ç®—ä¸¤ä¸ªä½å›¾çš„**å¯¹ç§°å·®é›†**ï¼ˆ`Symmetric Difference`ï¼‰ï¼Œè¿™åœ¨é€»è¾‘ä¸Šç­‰åŒäºä¸¤ä¸ªäºŒè¿›åˆ¶ä¸²çš„**ä½å¼‚æˆ–ï¼ˆXORï¼‰**æ“ä½œã€‚  
    $$A \oplus B = (A \cup B) \setminus (A \cap B)$$  
  
2.  **ä½é›†è®¡æ•°ï¼ˆPopulation Count / Cardinalityï¼‰**ï¼š  
    `roaringbitmap` æ‰©å±•æä¾›äº† `rb_cardinality(bitmap)` å‡½æ•°ï¼Œç”¨äºå¿«é€Ÿè®¡ç®—ä½å›¾ä¸­å…ƒç´ çš„æ•°é‡ï¼Œè¿™ç­‰åŒäºè®¡ç®—å¼‚æˆ–ç»“æœä¸­â€œ1â€çš„ä¸ªæ•°ã€‚  
  
#### è®¡ç®—æ­¥éª¤å’Œå‡½æ•°ï¼š  
  
åœ¨ PostgreSQL ä¸­ï¼Œè®¡ç®—ä¸¤ä¸ª `roaringbitmap` çš„æ±‰æ˜è·ç¦»çš„ SQL è¡¨è¾¾å¼å¦‚ä¸‹ï¼š  
  
$$\text{Hamming Distance}(A, B) = \text{rb\_xor\_cardinality}(A, B)$$  
  
æˆ–è€…ï¼Œé€šè¿‡ä¸¤ä¸ªæ­¥éª¤ï¼š  
  
```sql  
SELECT rb_cardinality(roaringbitmap_A # roaringbitmap_B);  
```  
  
### é«˜é€Ÿçš„åŸå›   
  
`roaringbitmap` ä¹‹æ‰€ä»¥èƒ½**é«˜é€Ÿ**è®¡ç®—ï¼Œæ˜¯å› ä¸ºå®ƒå°†åº•å±‚çš„é€»è¾‘è¿ç®—ï¼ˆå¦‚ XORï¼‰å’ŒåŸºæ•°è®¡ç®—ï¼ˆCardinalityï¼‰å§”æ‰˜ç»™é«˜åº¦ä¼˜åŒ–çš„ **CRoaring åº“**ï¼Œè¯¥åº“åˆ©ç”¨äº†ï¼š  
  
1.  **åˆ†å—å‹ç¼©å­˜å‚¨**ï¼šåªå­˜å‚¨éé›¶çš„ä½ï¼ˆå³é›†åˆä¸­çš„æ•´æ•°ï¼‰ï¼Œè€Œä¸æ˜¯å®Œæ•´çš„ã€å·¨å¤§çš„äºŒè¿›åˆ¶ä¸²ã€‚  
2.  **SIMD æŒ‡ä»¤é›†**ï¼šåœ¨è¿›è¡Œä½å›¾çš„é€»è¾‘è¿ç®—ï¼ˆXORï¼‰å’Œ $\text{Popcount}$ æ—¶ï¼Œ`CRoaring` åº“ä¼šä½¿ç”¨ CPU çš„ **SIMD**ï¼ˆ`Single Instruction, Multiple Data`ï¼Œå•æŒ‡ä»¤å¤šæ•°æ®ï¼‰æŒ‡ä»¤é›†è¿›è¡Œ**å¹¶è¡Œè®¡ç®—**ï¼Œä»è€Œåœ¨åº•å±‚æå¤§åœ°åŠ é€Ÿäº†è®¡ç®—è¿‡ç¨‹ã€‚  
  
### ä¸ `pgvector` çš„å¯¹æ¯”  
  
è™½ç„¶ `pgvector` çš„ `bit` ç±»å‹ä¹Ÿæ”¯æŒæ±‰æ˜è·ç¦»ï¼ˆ`<~>` è¿ç®—ç¬¦ï¼‰ï¼Œä½† `pgvector` çš„ `bit` ç±»å‹é€šå¸¸ç”¨äºå¤„ç†**ç­‰é•¿ä¸”ä¸å¤ªç¨€ç–**çš„äºŒè¿›åˆ¶å‘é‡ï¼ˆä¾‹å¦‚ï¼Œæœ€å¤§ç»´åº¦ 64,000ï¼‰ã€‚  
  
ç›¸æ¯”ä¹‹ä¸‹ï¼Œ`pg_roaringbitmap` æ›´é€‚åˆå¤„ç†ï¼š  
* **æåº¦ç¨€ç–**ï¼ˆå¤§éƒ¨åˆ†ä½ç½®ä¸º 0ï¼‰ã€‚  
* **ç†è®ºä¸Šç»´åº¦å¯ä»¥éå¸¸å¤§**ï¼ˆå› ä¸ºå®ƒåªå­˜å‚¨éé›¶ä½çš„ç´¢å¼•ï¼‰ã€‚  
  
å› æ­¤ï¼Œå¯¹äºç”±**å¤§é‡ã€ç¨€ç–çš„äºŒå€¼åŒ–ç‰¹å¾**æ„æˆçš„â€œå‘é‡â€ï¼Œ`pg_roaringbitmap` æ˜¯ä¸€ä¸ªè®¡ç®—æ±‰æ˜è·ç¦»çš„æä½³é€‰æ‹©ã€‚  
  
# é™„å½•3: sparsevec VS RoaringBitmap  
æ‚¨è¯¢é—®çš„æ˜¯ pgvector ä¸­çš„**ç¨€ç–å‘é‡ç±»å‹ (`sparsevec`)** ä¸ **RoaringBitmap** çš„å¯¹æ¯”ã€‚   
  
éœ€è¦æ˜ç¡®çš„æ˜¯:pgvector ä»£ç åº“ä¸­**æ²¡æœ‰å®ç° RoaringBitmap**ã€‚ pgvector åªå®ç°äº†ä»¥ä¸‹æ•°æ®ç±»å‹:    
  
- `vector` (å¯†é›†å‘é‡,float32)  
- `halfvec` (åŠç²¾åº¦å‘é‡,float16)    
- `bit` (äºŒå€¼å‘é‡)  
- `sparsevec` (ç¨€ç–å‘é‡,float32)  
  
## ç¨€ç–å‘é‡ (sparsevec) çš„å®ç°  
  
`sparsevec` ä½¿ç”¨**å‹ç¼©ç¨€ç–è¡Œ (CSR) æ ¼å¼**å­˜å‚¨:    
  
**å­˜å‚¨ç»“æ„:**  
- ç´¢å¼•æ•°ç»„ (int32[],0-based,å‡åºæ’åˆ—)  
- å€¼æ•°ç»„ (float[])  
- åªå­˜å‚¨éé›¶å…ƒç´   
  
**å­˜å‚¨å¼€é”€:** `16 + 8Ã—nnz` å­—èŠ‚,å…¶ä¸­ nnz æ˜¯éé›¶å…ƒç´ æ•°é‡    
  
**é™åˆ¶æ¡ä»¶:** [4](#0-3)   
- æœ€å¤§ç»´åº¦: 10äº¿  
- æœ€å¤§éé›¶å…ƒç´ : 16,000  
  
**æ”¯æŒçš„æ“ä½œ:** [5](#0-4)   
- L2 è·ç¦» (`<->`)  
- å†…ç§¯ (`<#>`)  
- ä½™å¼¦è·ç¦» (`<=>`)  
- L1 è·ç¦» (`<+>`)  
  
## ä¸ RoaringBitmap çš„æ¦‚å¿µå¯¹æ¯”  
  
è™½ç„¶ pgvector æ²¡æœ‰å®ç° RoaringBitmap,ä½†å¯ä»¥ä»æ¦‚å¿µä¸Šå¯¹æ¯”:  
  
| ç‰¹æ€§ | sparsevec | RoaringBitmap (æ¦‚å¿µ) |  
|------|-----------|---------------------|  
| **æ•°æ®ç±»å‹** | æµ®ç‚¹æ•° (float32) | å¸ƒå°”å€¼ (bit) |  
| **å­˜å‚¨æ ¼å¼** | CSR (ç´¢å¼•+å€¼) | å‹ç¼©ä½å›¾ |  
| **ç”¨é€”** | ç¨€ç–å‘é‡ç›¸ä¼¼åº¦æœç´¢ | é›†åˆè¿ç®—ã€ä½å›¾ç´¢å¼• |  
| **å‹ç¼©ç­–ç•¥** | åªå­˜éé›¶å€¼ | è‡ªé€‚åº”å‹ç¼©(æ•°ç»„/ä½å›¾/æ¸¸ç¨‹) |  
| **æ”¯æŒæ“ä½œ** | å‘é‡è·ç¦»è®¡ç®— | é›†åˆäº¤å¹¶å·®ã€ä½è¿ç®— |  
  
pgvector ä¸­æœ€æ¥è¿‘ä½å›¾çš„ç±»å‹æ˜¯ `bit`, ä½†å®ƒæ˜¯ **å›ºå®šé•¿åº¦çš„ä½ä¸²** , ä¸æ˜¯å‹ç¼©ä½å›¾.   
  
## Notes  
  
å¦‚æœæ‚¨éœ€è¦åœ¨ PostgreSQL ä¸­ä½¿ç”¨ RoaringBitmap, åº”è¯¥æŸ¥çœ‹ä¸“é—¨çš„ RoaringBitmap æ‰©å±•(å¦‚ `pg_roaringbitmap`), è€Œä¸æ˜¯ pgvectorã€‚pgvector çš„ `sparsevec` ä¸“æ³¨äº **ç¨€ç–æµ®ç‚¹å‘é‡çš„ç›¸ä¼¼åº¦æœç´¢** , è€Œ RoaringBitmap ä¸“æ³¨äº **é«˜æ•ˆçš„é›†åˆè¿ç®—å’Œä½å›¾ç´¢å¼•** , ä¸¤è€…è§£å†³çš„æ˜¯ä¸åŒçš„é—®é¢˜é¢†åŸŸã€‚   
           
#### [æœŸæœ› PostgreSQL|å¼€æºPolarDB å¢åŠ ä»€ä¹ˆåŠŸèƒ½?](https://github.com/digoal/blog/issues/76 "269ac3d1c492e938c0191101c7238216")
  
  
#### [PolarDB å¼€æºæ•°æ®åº“](https://openpolardb.com/home "57258f76c37864c6e6d23383d05714ea")
  
  
#### [PolarDB å­¦ä¹ å›¾è°±](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL è§£å†³æ–¹æ¡ˆé›†åˆ](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [å¾·å“¥ / digoal's Github - å…¬ç›Šæ˜¯ä¸€è¾ˆå­çš„äº‹.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About å¾·å“¥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
