## pgvectorscale 源码学习: 1.1 安装和设置 (Installation and Setup)  
  
### 作者  
digoal  
  
### 日期  
2025-11-09  
  
### 标签  
pgvectorscale , 向量数据库 , DiskANN , StreamingDiskANN , 源码学习  
  
----  
  
## 背景  
本文介绍在 `PostgreSQL` 环境中安装和配置 `pgvectorscale` 的详细说明。`pgvectorscale` 扩展了 `pgvector` 插件，为人工智能（AI）应用提供了更高性能的**嵌入向量搜索** (`embedding search`) 能力和更高效的**存储** (`storage`)。  
  
## 安装选项概述 (Overview of Installation Options)  
  
`pgvectorscale` 可以通过多种方式安装，具体取决于您的环境和要求：  
  
![pic](20251109_02_pic_001.jpg)  
  
来源: [`README.md` 42-147](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L42-L147)  
  
## 先决条件 (Prerequisites)  
  
在安装 `pgvectorscale` 之前，请确保您具备以下条件：  
  
| 要求 (Requirement) | 详情 (Details) |  
| :--- | :--- |  
| PostgreSQL | 版本 13、14、15、16、17 或 18 |  
| pgvector 扩展 (`pgvector extension`) | 推荐版本 0.8.1+ |  
| Rust (用于源码安装) (`Rust (for source installation)`) | 最新稳定版（通过 `rustup` 安装） |  
| cargo-pgrx | 0.16.1 版（须匹配 `pgrx` 框架版本） |  
| 平台支持 (`Platform support`) | Linux (所有架构)，macOS (仅 ARM) |  
| 构建依赖 (Linux) (`Build dependencies (Linux)`) | `clang-18`, `llvm-18`, `libopenblas-dev`, `flex`, `bison` |  
  
**注意** (`Note`): 目前不支持在 `macOS X86 (Intel)` 机器上构建 `pgvectorscale`，原因是存在一个[未解决的问题 (open issue)](https://github.com/timescale/pgvectorscale/blob/36271fa5/open%20issue)。请改用基于 `ARM` 的 Mac、使用 `Linux` 进行构建，或使用预构建的 `Docker` 容器。  
  
来源: [`README.md` 71-80](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L71-L80) [`.github/workflows/python_tests.yml` 14-27](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/workflows/python_tests.yml#L14-L27) [`.github/actions/install-packages/action.yml` 6-11](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-packages/action.yml#L6-L11) [`.github/actions/install-pgrx/action.yml` 47-51](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-pgrx/action.yml#L47-L51)  
  
## 安装方法 (Installation Methods)  
  
### 使用预构建的 Docker 容器 (Using a Pre-built Docker Container)  
  
这是开始使用 `pgvectorscale` 最快的方式：  
  
1.  运行 `TimescaleDB Docker` 镜像：  
    ```bash  
    docker run -d --name timescaledb -p 5432:5432 -e POSTGRES_PASSWORD=password timescale/timescaledb:latest-pg14  
    ```  
2.  连接到您的数据库：  
    ```bash  
    psql -d "postgres://postgres:password@localhost:5432/postgres"  
    ```  
3.  创建 `pgvectorscale` 扩展：  
    ```sql  
    CREATE EXTENSION IF NOT EXISTS vectorscale CASCADE;  
    ```  
  
`CASCADE` 选项会自动安装所需的 `pgvector` 扩展作为依赖项。  
  
来源: [`README.md` 50-66](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L50-L66)  
  
### 从源码安装 (Installing from Source)  
  
对于定制化安装或贡献开发，请使用 `PGRX` 框架构建 `pgvectorscale`：  
  
**构建流程 (Build Process Flow)**  
  
![pic](20251109_02_pic_002.jpg)  
  
**安装步骤 (Installation Steps)**  
  
1.  安装 `Rust` **工具链** (`Rust toolchain`)：  
    ```bash  
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh  
    ```  
2.  克隆并进入仓库：  
    ```bash  
    cd /tmp  
    git clone --branch <version> --depth 1 https://github.com/timescale/pgvectorscale  
    cd pgvectorscale/pgvectorscale  
    ```  
3.  安装 `cargo-pgrx`（版本必须匹配 `pgrx` 依赖）：  
    ```bash  
    # Install version 0.16.1 to match pgrx framework  
    cargo install --locked cargo-pgrx --version $(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "pgrx") | .version')  
    ```  
4.  使用您的 `PostgreSQL` 安装初始化 `PGRX`：  
    ```bash  
    # Replace pg18 with your PostgreSQL version (pg13-pg18)  
    cargo pgrx init --pg18 pg_config  
    ```  
    这将创建包含 `PostgreSQL` 路径的 `~/.pgrx/config.toml` 文件。`pg_config` 命令必须在您的 `PATH` 环境变量中。  
5.  构建并安装扩展：  
    ```bash  
    cargo pgrx install --release  
    ```  
    这将编译扩展并将文件复制到：  
      * `libpgvectorscale.so` → `PostgreSQL` 的 `pkglibdir` 目录  
      * `vectorscale.control` → `PostgreSQL` 的扩展控制目录  
      * `vectorscale--*.sql` → `PostgreSQL` 的扩展 `SQL` 目录  
6.  连接到您的数据库：  
    ```bash  
    psql -d "postgres://<username>:<password>@<host>:<port>/<database-name>"  
    ```  
7.  验证 `pgvector` 是否可用：  
    ```sql  
    SELECT * FROM pg_available_extensions WHERE name = 'vector';  
    ```  
    如果 `pgvector` 不可用，请从 [pgvector installation instructions](https://github.com/timescale/pgvectorscale/blob/36271fa5/pgvector%20installation%20instructions) 安装。  
8.  创建 `pgvectorscale` 扩展：  
    ```sql  
    CREATE EXTENSION IF NOT EXISTS vectorscale CASCADE;  
    ```  
    `CASCADE` 选项会自动安装 `pgvector` 作为依赖项。这将触发 [`pgvectorscale/src/lib.rs` 11-15](https://github.com/timescale/pgvectorscale/blob/36271fa5/pgvectorscale/src/lib.rs#L11-L15) 中定义的 `_PG_init()` 函数。  
  
来源: [`README.md` 67-122](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L67-L122) [`.github/actions/install-pgrx/action.yml` 47-59](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-pgrx/action.yml#L47-L59) [`.github/workflows/python_tests.yml` 75-85](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/workflows/python_tests.yml#L75-L85) [`pgvectorscale/src/lib.rs` 11-15](https://github.com/timescale/pgvectorscale/blob/36271fa5/pgvectorscale/src/lib.rs#L11-L15)  
  
## 扩展初始化架构 (Extension Initialization Architecture)  
  
**PostgreSQL 扩展加载流程 (PostgreSQL Extension Loading Flow)**  
  
![pic](20251109_02_pic_003.jpg)  
  
当执行 `CREATE EXTENSION vectorscale` 时，`PostgreSQL` 会加载**共享库** (`shared library`) 并调用 [`pgvectorscale/src/lib.rs` 11-15](https://github.com/timescale/pgvectorscale/blob/36271fa5/pgvectorscale/src/lib.rs#L11-L15) 中定义的 `_PG_init()` 函数。此函数执行三个关键的初始化步骤：  
  
1.  **距离函数注册** (`Distance Function Registration`) - 通过 `access_method::distance::init()` 注册距离度量（`L2`、**余弦** (`cosine`)、**内积** (`inner product`)）。  
2.  **访问方法选项** (`Access Method Options`) - 通过 `access_method::options::init()` 注册 `diskann` **访问方法处理程序** (`access method handler`)。  
3.  **GUC 参数** (`GUC Parameters`) - 通过 `access_method::guc::init()` 注册**查询时参数** (`query-time parameters`)。  
  
来源: [`pgvectorscale/src/lib.rs` 1-21](https://github.com/timescale/pgvectorscale/blob/36271fa5/pgvectorscale/src/lib.rs#L1-L21) [`README.md` 11-16](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L11-L16)  
  
**扩展依赖链 (Extension Dependency Chain)**  
  
![pic](20251109_02_pic_004.jpg)  
  
`pgvectorscale` 依赖于 `pgvector` 提供的 `vector` **数据类型** (`data type`)。使用 `CASCADE` 选项安装时，`PostgreSQL` 会自动首先安装 `pgvector`。  
  
来源: [`README.md` 11-16](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L11-L16) [`README.md` 59-65](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L59-L65)  
  
## CI/CD 和包分发 (CI/CD and Package Distribution)  
  
**GitHub Actions 构建流程 (GitHub Actions Build Pipeline)**  
  
![pic](20251109_02_pic_005.jpg)  
  
该构建流程使用了三个主要的 `GitHub Actions` **工作流程** (`workflows`)：  
  
1.  **pgrx\_test** - 在 `amd64` 和 `arm64` 架构上，针对 `PostgreSQL` 13-18 版本编译和测试 `pgvectorscale`。  
2.  **python\_tests** - 针对活动的 `PostgreSQL` 实例运行 `Python` **集成测试** (`integration tests`)。  
3.  **deb-packager** - 创建用于分发的 `Debian` **软件包** (`packages`)。  
  
每个工作流程都使用可复用的 `GitHub Actions` 来安装依赖项：  
  
  * [`.github/actions/install-postgres/action.yml` 1-45](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-postgres/action.yml#L1-L45) - 从源码构建 `PostgreSQL`  
  * [`.github/actions/install-pgvector/action.yml` 1-37](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-pgvector/action.yml#L1-L37) - 安装 `pgvector` 扩展  
  * [`.github/actions/install-pgrx/action.yml` 1-73](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-pgrx/action.yml#L1-L73) - 安装带有缓存的 `cargo-pgrx`  
  
来源: [`.github/workflows/pgrx_test.yaml` 1-138](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/workflows/pgrx_test.yaml#L1-L138) [`.github/workflows/python_tests.yml` 1-126](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/workflows/python_tests.yml#L1-L126) [`.github/workflows/deb-packager.yaml` 1-107](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/workflows/deb-packager.yaml#L1-L107) [`.github/actions/install-postgres/action.yml` 1-45](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-postgres/action.yml#L1-L45) [`.github/actions/install-pgvector/action.yml` 1-37](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-pgvector/action.yml#L1-L37) [`.github/actions/install-pgrx/action.yml` 1-73](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-pgrx/action.yml#L1-L73)  
  
## 验证安装 (Verifying Installation)  
  
安装后，请验证 `pgvectorscale` 是否正常工作：  
  
1.  检查扩展是否可用：  
    ```sql  
    SELECT * FROM pg_available_extensions WHERE name = 'vectorscale';  
    ```  
2.  验证扩展版本：  
    ```sql  
    SELECT default_version, installed_version FROM pg_available_extensions WHERE name = 'vectorscale';  
    ```  
3.  创建测试表和**索引** (`index`) 以确认功能：  
    ```sql  
    -- Create a test table  
    CREATE TABLE test_vectors (  
      id SERIAL PRIMARY KEY,  
      embedding VECTOR(3)  
    );  
      
    -- Insert some test vectors  
    INSERT INTO test_vectors (embedding) VALUES ('[1,2,3]'), ('[4,5,6]'), ('[7,8,9]');  
      
    -- Create a StreamingDiskANN index  
    CREATE INDEX ON test_vectors USING diskann (embedding vector_cosine_ops);  
      
    -- Test a query  
    SELECT * FROM test_vectors ORDER BY embedding <=> '[1,1,1]' LIMIT 1;  
    ```  
  
如果上述步骤没有错误地完成，则 `pgvectorscale` 已正确安装并运行。  
  
来源: [`README.md` 149-182](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L149-L182)  
  
## 平台兼容性 (Platform Compatibility)  
  
| 平台 (Platform) | 架构 (Architecture) | 状态 (Status) |  
| :--- | :--- | :--- |  
| Linux | x86\_64 (amd64) | ✓ 支持 (`Supported`) |  
| Linux | arm64 | ✓ 支持 (`Supported`) |  
| macOS | arm64 | ✓ 支持 (`Supported`) |  
| macOS | x86\_64 (Intel) | ⚠ 不支持 (`Not supported`) |  
| Windows | x86\_64 | ⚠ 未测试 (`Not tested`) |  
  
来源: [`README.md` 71-80](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L71-L80) [`.github/workflows/pgrx_test.yaml` 9-30](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/workflows/pgrx_test.yaml#L9-L30)  
  
## 版本兼容性 (Version Compatibility)  
  
| 组件 (Component) | 版本 (Versions) | 备注 (Notes) |  
| :--- | :--- | :--- |  
| PostgreSQL | 13.16, 14.13, 15.7, 16.3, 17.0, 18.0 | 在 **CI 流程** (`CI pipeline`) 中测试 |  
| pgvector | 0.8.1+ | 必需依赖 (`Required dependency`) |  
| pgrx | 0.16.1 | PGRX 框架版本 (`PGRX framework version`) |  
| cargo-pgrx | 0.16.1 | 必须匹配 pgrx 版本 (`Must match pgrx version`) |  
| Rust | stable | 通过 `rustup` |  
  
**PostgreSQL 版本功能支持 (PostgreSQL Version Feature Support)**  
  
该扩展使用**条件编译** (`conditional compilation`) 来处理特定于 `PostgreSQL` 版本的功能：  
  
```rust  
// Example from pgvectorscale/src/util/ports.rs  
#[cfg(any(feature = "pg15", feature = "pg16", feature = "pg17", feature = "pg18"))]  
use pg_sys::pgstat_assoc_relation;  
  
#[cfg(any(feature = "pg13", feature = "pg14", feature = "pg15"))]  
{  
    (*tmp).t_counts.t_numscans += 1;  
}  
#[cfg(any(feature = "pg16", feature = "pg17", feature = "pg18"))]  
{  
    (*tmp).counts.numscans += 1;  
}  
```  
  
该扩展使用 `Rust` **功能标志** (`feature flags`)（如 `pg13`、`pg14` 等）来处理不同版本 `PostgreSQL API` 的差异。  
  
来源: [`.github/workflows/python_tests.yml` 16-27](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/workflows/python_tests.yml#L16-L27) [`.github/actions/install-pgrx/action.yml` 12-15](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-pgrx/action.yml#L12-L15) [`pgvectorscale/src/util/ports.rs` 9-154](https://github.com/timescale/pgvectorscale/blob/36271fa5/pgvectorscale/src/util/ports.rs#L9-L154)  
  
## 故障排除 (Troubleshooting)  
  
### 常见安装问题 (Common Installation Issues)  
  
| 问题 (Issue) | 现象 (Symptom) | 解决方案 (Solution) |  
| :--- | :--- | :--- |  
| 缺少 `pgvector` 扩展 (`Missing pgvector extension`) | `ERROR: could not open extension control file` | 先安装 `pgvector`，或使用 `CASCADE` 选项 |  
| `macOS Intel` 构建失败 (`macOS Intel build fails`) | 在 `cargo pgrx install` 期间出现编译错误 | 使用 ARM Mac、`Linux` 或 `Docker` (见 issue \#155) |  
| `cargo-pgrx` 版本不匹配 (`cargo-pgrx version mismatch`) | `error: pgrx version mismatch` | 安装 `cargo-pgrx 0.16.1`: `cargo install --locked cargo-pgrx --version 0.16.1` |  
| `pg_config` 未找到 (`pg_config not found`) | `error: pg_config not found` | 将 `PostgreSQL` bin 目录添加到 `PATH`: `export PATH=/path/to/postgresql/bin:$PATH` |  
| 安装时权限被拒绝 (`Permission denied during install`) | 复制文件时**权限被拒绝** (`Permission denied`) | 使用适当的权限运行或安装到用户可写的目录 |  
| `UNLOGGED` 表索引创建 (`UNLOGGED table index creation`) | `ERROR: ambuildempty: not yet implemented` | 使用**已记录日志的表** (`logged tables`)；不支持 `UNLOGGED` 表 |  
  
**诊断命令 (Diagnostic Commands)**  
  
要验证您的安装环境：  
  
```bash  
# Check PostgreSQL version and paths  
pg_config --version  
pg_config --pkglibdir  
pg_config --sharedir  
  
# Check cargo-pgrx installation  
cargo pgrx --version  
  
# Check PGRX configuration  
cat ~/.pgrx/config.toml  
  
# Verify extension files after installation  
ls $(pg_config --pkglibdir)/libpgvectorscale.so  
ls $(pg_config --sharedir)/extension/vectorscale.control  
```  
  
**构建依赖问题 (Linux) (Build Dependency Issues (Linux))**  
  
如果编译因缺少**头文件** (`headers`) 或**库** (`libraries`) 而失败：  
  
```bash  
# Install required packages (Ubuntu/Debian)  
sudo apt-get update  
sudo apt-get install -y \
    flex bison \
    clang-18 llvm-18 llvm-18-dev \
    libopenblas-dev libblas-dev \
    build-essential  
```  
  
来源: [`README.md` 71-80](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L71-L80) [`README.md` 399-406](https://github.com/timescale/pgvectorscale/blob/36271fa5/README.md#L399-L406) [`.github/actions/install-packages/action.yml` 6-11](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-packages/action.yml#L6-L11) [`.github/actions/install-pgrx/action.yml` 53-59](https://github.com/timescale/pgvectorscale/blob/36271fa5/.github/actions/install-pgrx/action.yml#L53-L59)  
  
    
    
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
