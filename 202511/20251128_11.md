## Supabase æºç å­¦ä¹ : 2.1.2 æ„å»ºé…ç½®ï¼ˆBuild Configurationï¼‰  
      
### ä½œè€…      
digoal      
      
### æ—¥æœŸ      
2025-11-28      
      
### æ ‡ç­¾      
Supabase , Firebase , æºç å­¦ä¹  , åç«¯å³æœåŠ¡ , BaaS , backend platform , åç«¯å¹³å° , å¼€æºé¡¹ç›®ç¼åˆ , å‰ç«¯ , åç«¯ , è‡ªåŠ¨ç”ŸæˆAPI , æ•°æ®åº“ , åŒ…ç®¡ç† , æ—¥å¿—      
      
----      
      
## èƒŒæ™¯      
æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº† **Studio Dashboard** åº”ç”¨ç¨‹åºï¼ˆä½äº [`apps/studio`]ï¼‰çš„**æ„å»ºé…ç½®**ï¼ˆBuild Configurationï¼‰ï¼Œæ¶µç›–äº† **Next.js é…ç½®**ï¼ˆNext.js configurationï¼‰ã€**webpack å®šåˆ¶**ï¼ˆwebpack customizationï¼‰ã€**Sentry é›†æˆ**ï¼ˆSentry integrationï¼‰ã€**ç¯å¢ƒå˜é‡ç®¡ç†**ï¼ˆenvironment variable managementï¼‰ã€**CDN èµ„æºäº¤ä»˜**ï¼ˆCDN asset deliveryï¼‰ä»¥åŠ **Turbo æ„å»ºç¼–æ’**ï¼ˆTurbo build orchestrationï¼‰ã€‚  
  
## æ„å»ºé…ç½®æ¦‚è¿°ï¼ˆBuild Configuration Overviewï¼‰  
  
Studio åº”ç”¨ç¨‹åºä½¿ç”¨ **Next.js** 15.5.2ï¼Œå¹¶å¸¦æœ‰ç”¨äº **Vercel** **ç”Ÿäº§éƒ¨ç½²**ï¼ˆproduction deploymentï¼‰ã€**Docker å®¹å™¨**ï¼ˆDocker containersï¼‰çš„**ç‹¬ç«‹è¾“å‡º**ï¼ˆstandalone outputï¼‰ä»¥åŠåŸºäº**ç¯å¢ƒçš„ç‰¹æ€§æ ‡å¿—**ï¼ˆenvironment-based feature flagsï¼‰çš„å¹¿æ³›å®šåˆ¶é…ç½®ã€‚  
  
![pic](20251128_11_pic_001.jpg)    
  
**æ¥æº:**  
[`apps/studio/next.config.js` 1-601](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L1-L601)  
[`apps/studio/package.json` 1-205](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/package.json#L1-L205)  
[`turbo.json` 46-129](https://github.com/supabase/supabase/blob/7490ca9e/turbo.json#L46-L129)  
  
## æ„å»ºè„šæœ¬ï¼ˆBuild Scriptsï¼‰  
  
Studio åº”ç”¨ç¨‹åºå®šä¹‰äº†å‡ ä¸ªç”¨äºç¼–æ’æ„å»ºæµç¨‹çš„**æ„å»ºè„šæœ¬**ï¼š  
  
| Script | Command | Purpose |  
| :--- | :--- | :--- |  
| `build` | `next build && ./../../scripts/upload-static-assets.sh` | ç”Ÿäº§æ„å»ºå¹¶ä¸Šä¼  CDN èµ„æº |  
| `dev` | `next dev --turbopack -p 8082` | ä½¿ç”¨ **Turbopack** çš„å¼€å‘æœåŠ¡å™¨ |  
| `build:graphql-types` | `tsx scripts/download-graphql-schema.mts && pnpm graphql-codegen --config scripts/codegen.ts` | ç”Ÿæˆ **GraphQL** ç±»å‹å®šä¹‰ |  
| `build:deno-types` | `tsx scripts/deno-types.ts` | ç”Ÿæˆ **Deno TypeScript å£°æ˜** |  
| `pretypecheck` | `next typegen` | åœ¨ç±»å‹æ£€æŸ¥å‰ç”Ÿæˆ **Next.js è·¯ç”±ç±»å‹** |  
  
**æ¥æº:**  
[`apps/studio/package.json` 5-26](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/package.json#L5-L26)  
  
### æ„å»ºæµç¨‹ï¼ˆBuild Process Flowï¼‰  
  
![pic](20251128_11_pic_002.jpg)    
  
**æ¥æº:**  
[`apps/studio/package.json` 8](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/package.json#L8-L8)  
[`turbo.json` 46-129](https://github.com/supabase/supabase/blob/7490ca9e/turbo.json#L46-L129)  
  
## Next.js é…ç½®ç»“æ„ï¼ˆNext.js Configuration Structureï¼‰  
  
ä¸»é…ç½®ä» `next.config.js` å¯¼å‡ºï¼Œå¸¦æœ‰æ¡ä»¶ **Sentry å°è£…**ï¼ˆSentry wrappingï¼‰ï¼š  
  
![pic](20251128_11_pic_003.jpg)    
  
**æ¥æº:**  
[`apps/studio/next.config.js` 29-601](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L29-L601)  
  
### æ ¸å¿ƒé…ç½®å±æ€§ï¼ˆCore Configuration Propertiesï¼‰  
  
`nextConfig` å¯¹è±¡å®šä¹‰äº†ä»¥ä¸‹å…³é”®å±æ€§ï¼š  
  
**è¾“å‡ºé…ç½®ï¼ˆOutput Configurationï¼‰:**  
  
  * `output: 'standalone'` - å¯ç”¨ç”¨äº**å®¹å™¨åŒ–**ï¼ˆcontainerizationï¼‰çš„**ç‹¬ç«‹è¾“å‡º**ï¼ˆstandalone buildï¼‰ [`apps/studio/next.config.js` 35](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L35-L35)  
  * `basePath: process.env.NEXT_PUBLIC_BASE_PATH` - å¯é…ç½®çš„**åŸºç¡€è·¯å¾„**ï¼ˆbase pathï¼‰ç”¨äºéƒ¨ç½² [`apps/studio/next.config.js` 33](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L33-L33)  
  * `assetPrefix: getAssetPrefix()` - **é™æ€èµ„æº**ï¼ˆstatic assetsï¼‰çš„ **CDN URL** [`apps/studio/next.config.js` 34](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L34-L34)  
  
**å®éªŒæ€§ç‰¹æ€§ï¼ˆExperimental Featuresï¼‰:**  
  
  * `webpackBuildWorker: true` - å¯ç”¨**å¹¶è¡Œ webpack æ„å»º**ï¼ˆparallel webpack buildsï¼‰ [`apps/studio/next.config.js` 36-38](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L36-L38)  
  
**è½¬è¯‘åŒ…ï¼ˆTranspiled Packagesï¼‰:**  
  
```  
transpilePackages: [  
  'ui',  
  'ui-patterns',  
  'common',  
  'shared-data',  
  'api-types',  
  'icons',  
  'libpg-query',  
]  
```  
  
[`apps/studio/next.config.js` 517-525](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L517-L525)  
  
**æ¥æº:**  
[`apps/studio/next.config.js` 32-567](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L32-L567)  
  
## Webpack å®šåˆ¶ï¼ˆWebpack Customizationï¼‰  
  
Studio åº”ç”¨ç¨‹åº**å®šåˆ¶**ï¼ˆcustomizesï¼‰äº† **webpack** ä»¥å¤„ç†ç‰¹å®šæ–‡ä»¶ç±»å‹å’Œ **Monaco Editor å…¼å®¹æ€§**ï¼ˆMonaco Editor compatibilityï¼‰ï¼š  
  
### Monaco Editor è§„åˆ™ä¿®æ”¹ï¼ˆMonaco Editor Rule Modificationï¼‰  
  
é…ç½®ä¿®æ”¹äº† **webpack çš„æ¨¡å—è§„åˆ™**ï¼ˆwebpack's module rulesï¼‰ä»¥æ­£ç¡®å¤„ç† **Monaco Editor å¯¼å…¥**ï¼ˆMonaco Editor importsï¼‰ï¼š  
  
![pic](20251128_11_pic_004.jpg)    
  
ä½äº `apps/studio/next.config.js` æ–‡ä»¶ä¸­çš„ Webpack å‡½æ•°æ‰§è¡Œäº†ä¸¤ä¸ªå…³é”®ä¿®æ”¹ï¼š  
  
1.  **Monaco Editor ä¾èµ–ä¿®å¤ (Monaco Editor Issuer Fix):**  
    * ä¿®æ”¹äº†ç”¨äºæ£€æŸ¥ `_app` æ–‡ä»¶çš„è§„åˆ™çš„å‘å¸ƒè€…ï¼ˆissuerï¼‰æ¨¡å¼ï¼Œä»¥åŒ…å« Monaco Editor çš„è·¯å¾„ã€‚  
    * *æ¥æº:* `apps/studio/next.config.js` ç¬¬ 536-544 è¡Œ  
2.  **Markdown æ–‡ä»¶å¤„ç† (Markdown File Handling):**  
    * æ·»åŠ äº†ä¸€æ¡è§„åˆ™ï¼Œä½¿ç”¨ `asset/source` ç±»å‹å°† **`.md`**ï¼ˆMarkdownï¼‰æ–‡ä»¶ä½œä¸ºåŸå§‹æ–‡æœ¬åŠ è½½ã€‚  
    * *æ¥æº:* `apps/studio/next.config.js` ç¬¬ 547-550 è¡Œ  
  
## Sentry é›†æˆ (Sentry Integration)  
  
Sentry ä»…åœ¨ **`NEXT_PUBLIC_IS_PLATFORM === 'true'`** æ—¶æœ‰æ¡ä»¶åœ°é›†æˆã€‚  
  
| Sentry é…ç½®é€‰é¡¹ (Option) | å€¼ (Value) | ç›®çš„ (Purpose) |  
| :--- | :--- | :--- |  
| **`silent`** | `true` | æŠ‘åˆ¶æ„å»ºæœŸé—´çš„æ—¥å¿—ä¿¡æ¯ã€‚ |  
| **`widenClientFileUpload`** | `true` | ä¸Šä¼ æ›´å¤šçš„ Source Map ä»¥è·å–æ›´å®Œæ•´çš„å †æ ˆè·Ÿè¸ªï¼ˆStack Tracesï¼‰ã€‚ |  
| **`reactComponentAnnotation.enabled`** | `true` | ä¸º React ç»„ä»¶æ·»åŠ æ³¨é‡Šï¼Œä»¥æ–¹ä¾¿è°ƒè¯•ã€‚ |  
| **`hideSourceMaps`** | `true` | é˜²æ­¢ Source Map æ–‡ä»¶è¢«å®¢æˆ·ç«¯è®¿é—®ã€‚ |  
| **`disableLogger`** | `true` | åœ¨ Tree-shaking è¿‡ç¨‹ä¸­ç§»é™¤ Sentry logger è¯­å¥ã€‚ |  
| **`automaticVercelMonitors`** | `true` | å¯ç”¨ Vercel Cron ä»»åŠ¡ç›‘æ§ã€‚ |  
  
![pic](20251128_11_pic_005.jpg)    
  
**ä½¿ç”¨çš„ç¯å¢ƒå˜é‡**  
  
| å˜é‡åç§° | ç›®çš„ |  
| :--- | :--- |  
| **`SENTRY_ORG`** | Sentry ç»„ç»‡çš„æ ‡è¯†ç¬¦ã€‚ |  
| **`SENTRY_PROJECT`** | Sentry ä¸­çš„é¡¹ç›®æ ‡è¯†ç¬¦ã€‚ |  
| **`SENTRY_AUTH_TOKEN`** | ç”¨äºä¸Šä¼  Source Map çš„èº«ä»½éªŒè¯ä»¤ç‰Œã€‚ |  
| **`NEXT_PUBLIC_SENTRY_DSN`** | å®¢æˆ·ç«¯ä½¿ç”¨çš„ Sentry DSNï¼ˆData Source Nameï¼‰ã€‚ |  
  
*æ¥æº:* `apps/studio/next.config.js` ç¬¬ 572-600 è¡Œ; `turbo.json` ç¬¬ 109-112 è¡Œ  
  
  
## ç¯å¢ƒå˜é‡ (Environment Variables)  
  
Studio çš„æ„å»ºä¾èµ–äºé€šè¿‡ Turbo é…ç½®çš„å¤§é‡ç¯å¢ƒå˜é‡ï¼š  
  
### 1. æ„å»ºæ—¶å˜é‡ (Build-Time Variables)  
  
è¿™äº›å˜é‡åœ¨æ„å»ºæœŸé—´è¢«åµŒå…¥åˆ°æœ€ç»ˆçš„è¾“å‡ºä¸­ï¼Œä¼šå½±å“æ„å»ºç»“æœï¼š  
  
| å˜é‡ (Variable) | ç›®çš„ (Purpose) | é»˜è®¤å€¼/ç¤ºä¾‹ (Default/Example) |  
| :--- | :--- | :--- |  
| **`NEXT_PUBLIC_BASE_PATH`** | URL åŸºç¡€è·¯å¾„ | `/studio` æˆ–ç©ºå€¼ |  
| **`NEXT_PUBLIC_IS_PLATFORM`** | å¹³å°æ¨¡å¼ vs. è‡ªæ‰˜ç®¡æ¨¡å¼ | `'true'` æˆ– `'false'` |  
| **`NEXT_PUBLIC_ENVIRONMENT`** | ç¯å¢ƒæ ‡è¯†ç¬¦ | `'staging'` æˆ– `'production'` |  
| **`NEXT_PUBLIC_SITE_URL`** | Studio çš„ URL | `https://supabase.com` |  
| **`NEXT_PUBLIC_API_URL`** | å¹³å° API URL | å¹³å°åç«¯çš„ç«¯ç‚¹ |  
| **`NEXT_PUBLIC_DOCS_URL`** | æ–‡æ¡£ URL | `https://supabase.com/docs` |  
| **`VERCEL_GIT_COMMIT_SHA`** | Git æäº¤å“ˆå¸Œå€¼ï¼ˆç”¨äº CDN ç¼“å­˜ï¼‰ | SHA å­—ç¬¦ä¸² |  
| **`SITE_NAME`** | ç«™ç‚¹æ ‡è¯†ç¬¦ï¼ˆç”¨äº CDNï¼‰ | `'studio'` |  
| **`FORCE_ASSET_CDN`** | å¼ºåˆ¶æ‰§è¡Œ CDN è¡Œä¸º | `'1'`ã€ `'-1'` æˆ–æœªè®¾ç½® |  
  
*æ¥æº:* `turbo.json` ç¬¬ 46-129 è¡Œ  
  
### 2. è¿è¡Œæ—¶å˜é‡ï¼ˆé€ä¼ ï¼‰ (Runtime Variables - Pass-Through)  
  
è¿™äº›å˜é‡ä¸ä¼šåµŒå…¥åˆ°æ„å»ºè¾“å‡ºä¸­ï¼Œè€Œæ˜¯åœ¨**åº”ç”¨è¿è¡Œæ—¶**æ‰å¯ç”¨ï¼ˆé€šå¸¸ç”¨äºåç«¯è¿æ¥æˆ–æ•æ„Ÿé…ç½®ï¼‰ã€‚  
  
![pic](20251128_11_pic_006.jpg)    
  
* **æ•°æ®åº“è¿æ¥ (Database Connection):**  
    * `POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_DB`  
    * `POSTGRES_USER_READ_WRITE`, `POSTGRES_USER_READ_ONLY`  
    * `POSTGRES_PASSWORD`  
* **æœåŠ¡å¯†é’¥ (Service Keys):**  
    * `SUPABASE_SERVICE_KEY` (ç®¡ç†å‘˜è®¿é—® Supabase æœåŠ¡)  
    * `SUPABASE_ANON_KEY` (å…¬å¼€åŒ¿åå¯†é’¥)  
    * `READ_ONLY_API_KEY` (åªè¯»è®¿é—®å¯†é’¥)  
* **AI æœåŠ¡ (AI Services):**  
    * `OPENAI_API_KEY` (OpenAI API è®¿é—®)  
    * `AWS_BEDROCK_PROFILE`, `AWS_BEDROCK_ROLE_ARN` (AWS Bedrock é…ç½®)  
  
*æ¥æº:* `turbo.json` ç¬¬ 86-126 è¡Œ  
  
### Environment Variable Flow  
  
![pic](20251128_11_pic_007.jpg)    
  
## èµ„äº§ CDN é…ç½® (Asset CDN Configuration)  
  
Studio åº”ç”¨ç¨‹åºåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¼šä½¿ç”¨ CDN æ¥å¤„ç†é™æ€èµ„äº§ã€‚  
  
### `getAssetPrefix()` å‡½æ•°  
  
**èµ„æºå‰ç¼€**ï¼ˆasset prefixï¼‰ç”± [`apps/studio/next.config.js` 10-27](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L10-L27) ä¸­çš„ `getAssetPrefix()` å‡½æ•°ç¡®å®šï¼š  
  
```mermaid  
graph TD  
    Start["getAssetPrefix()"]  
      
    ForceCheck{{"FORCE_ASSET_CDN<br/>!== '1' &&<br/>VERCEL_ENV !== 'production'?"}}  
      
    ForceDisableCheck{{"FORCE_ASSET_CDN<br/>== '-1'?"}}  
      
    EnvCheck{{"NEXT_PUBLIC_ENVIRONMENT<br/>== 'staging'?"}}  
      
    StagingURL["https\://frontend-assets<br/>.supabase.green"]  
    ProdURL["https\://frontend-assets<br/>.supabase.com"]  
      
    BuildPrefix["${SUPABASE_ASSETS_URL}<br/>/${SITE_NAME}<br/>/${COMMIT_SHA.substring(0,12)}"]  
      
    ReturnUndef["return undefined"]  
    ReturnPrefix["return prefix"]  
      
    Start --> ForceCheck  
    ForceCheck -->|Yes| ReturnUndef  
    ForceCheck -->|No| ForceDisableCheck  
      
    ForceDisableCheck -->|Yes| ReturnUndef  
    ForceDisableCheck -->|No| EnvCheck  
      
    EnvCheck -->|Yes| StagingURL  
    EnvCheck -->|No| ProdURL  
      
    StagingURL --> BuildPrefix  
    ProdURL --> BuildPrefix  
      
    BuildPrefix --> ReturnPrefix  
```  
  
  
**CDN URL ç»“æ„ï¼ˆCDN URL Structureï¼‰:**  
  
```  
https://frontend-assets.supabase.com/studio/{12-char-commit-sha}/_next/static/...  
```  
  
**æ¥æº:**  
[`apps/studio/next.config.js` 10-27](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L10-L27)  
  
### èµ„æºä¸Šä¼ æµç¨‹ï¼ˆAsset Upload Processï¼‰  
  
åœ¨ **Next.js æ„å»º**å®Œæˆåï¼Œ`upload-static-assets.sh` è„šæœ¬ä¼šå°†**é™æ€èµ„æº**ï¼ˆstatic assetsï¼‰ä¸Šä¼ åˆ° **S3**ï¼š  
  
**å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼ˆRequired Environment Variablesï¼‰:**  
  
  * `VERCEL_GIT_COMMIT_SHA` - å¿…é¡»å­˜åœ¨æ‰èƒ½è§¦å‘ä¸Šä¼   
  * `AWS_ACCESS_KEY_ID` - **S3 è®¿é—®å‡­è¯**ï¼ˆS3 access credentialsï¼‰  
  * `AWS_SECRET_ACCESS_KEY` - **S3 å¯†é’¥**  
  * `ASSET_CDN_S3_ENDPOINT` - **S3 ç«¯ç‚¹ URL**ï¼ˆS3 endpoint URLï¼‰  
  * `SITE_NAME` - **S3 ä¸­çš„ç›®å½•å‰ç¼€**ï¼ˆDirectory prefix in S3ï¼‰  
  
**æ¥æº:**  
[`apps/studio/package.json` 8](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/package.json#L8-L8)  
[`turbo.json` 117-120](https://github.com/supabase/supabase/blob/7490ca9e/turbo.json#L117-L120)  
  
## è·¯ç”±é…ç½®ï¼ˆRouting Configurationï¼‰  
  
Studio åº”ç”¨ç¨‹åºä¸º**å¹³å°æ¨¡å¼**ï¼ˆplatformï¼‰å’Œ**è‡ªæ‰˜ç®¡æ¨¡å¼**ï¼ˆself-hosted modesï¼‰å®šä¹‰äº†å¹¿æ³›çš„**è·¯ç”±è§„åˆ™**ï¼ˆrouting rulesï¼‰ï¼š  
  
### é‡å†™ï¼ˆRewritesï¼‰  
  
```mermaid  
graph LR  
    Rewrite["async rewrites()"]  
      
    VercelFlags["/.well-known/vercel/flags"]  
    TargetURL["https\://supabase.com<br/>/.well-known/vercel/flags"]  
      
    Rewrite --> VercelFlags  
    VercelFlags --> TargetURL  
```  
  
å•ä¸ª**é‡å†™è§„åˆ™**ï¼ˆrewrite ruleï¼‰å°† **Vercel ç‰¹æ€§æ ‡å¿—**ï¼ˆVercel feature flagsï¼‰ä»ä¸» `supabase.com` åŸŸ**ä»£ç†**ï¼ˆproxiesï¼‰å‡ºæ¥ [`apps/studio/next.config.js` 39-47](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L39-L47)  
  
**æ¥æº:**  
[`apps/studio/next.config.js` 39-47](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L39-L47)  
  
### é‡å®šå‘ï¼ˆRedirectsï¼‰  
  
**é‡å®šå‘é…ç½®**ï¼ˆredirect configurationï¼‰æ ¹æ®**å¹³å°æ¨¡å¼**ï¼ˆplatform modeï¼‰çš„ä¸åŒè€Œå˜åŒ–ï¼š  
  
#### å¹³å°æ¨¡å¼é‡å®šå‘ï¼ˆPlatform Mode Redirectsï¼‰  
  
å½“ `NEXT_PUBLIC_IS_PLATFORM === 'true'` æ—¶ï¼š  
  
| Source | Destination | Purpose |  
| :--- | :--- | :--- |  
| `/` | `/org` | **æ ¹è·¯å¾„åˆ°ç»„ç»‡é¡µé¢**ï¼ˆRoot to organizations pageï¼‰ |  
| `/` with `?next=new-project` | `/new/new-project` | **æ–°é¡¹ç›®æµç¨‹**ï¼ˆNew project flowï¼‰ |  
| `/register`, `/signup` | `/sign-up` | **è®¤è¯ URL è§„èŒƒåŒ–**ï¼ˆAuth URL normalizationï¼‰ |  
| `/signin`, `/login`, `/log-in` | `/sign-in` | **è®¤è¯ URL è§„èŒƒåŒ–**ï¼ˆAuth URL normalizationï¼‰ |  
  
#### è‡ªæ‰˜ç®¡æ¨¡å¼é‡å®šå‘ï¼ˆSelf-Hosted Mode Redirectsï¼‰  
  
å½“ `NEXT_PUBLIC_IS_PLATFORM !== 'true'` æ—¶ï¼š  
  
| Source | Destination | Purpose |  
| :--- | :--- | :--- |  
| `/` | `/project/default` | **æ ¹è·¯å¾„åˆ°é»˜è®¤é¡¹ç›®**ï¼ˆRoot to default projectï¼‰ |  
| Auth URLs | `/project/default` | **æ‰€æœ‰è®¤è¯æµç¨‹é‡å®šå‘åˆ°é¡¹ç›®**ï¼ˆAll auth flows redirect to projectï¼‰ |  
  
#### å¸¸è§é‡å®šå‘ï¼ˆCommon Redirectsï¼‰  
  
ä¸¤ç§æ¨¡å¼å…±äº« 40 å¤šä¸ªç”¨äº URL ç»“æ„æ›´æ”¹çš„é‡å®šå‘ï¼ŒåŒ…æ‹¬ï¼š  
  
  * **æ•°æ®åº“è®¾ç½®æ•´åˆ**ï¼ˆDatabase settings consolidationï¼‰ï¼š`/project/:ref/settings/database` â†’ `/project/:ref/database/settings`  
  * **å­˜å‚¨è®¾ç½®è¿ç§»**ï¼ˆStorage settings movesï¼‰ï¼š`/project/:ref/settings/storage` â†’ `/project/:ref/storage/files/settings`  
  * **è®¡è´¹ URL æ›´æ–°**ï¼ˆBilling URL updatesï¼‰ï¼šå„ç§è®¡è´¹ URL é‡å®šå‘åˆ°ç»„ç»‡è®¡è´¹  
  * **åŠŸèƒ½é‡ç»„**ï¼ˆFeature reorganizationï¼‰ï¼š**API æ—¥å¿—**ï¼ˆAPI logsï¼‰ã€**å¯†ç åº“**ï¼ˆvaultï¼‰ã€**Webhook**ï¼ˆwebhooksï¼‰ç­‰  
  
**æ¥æº:**  
[`apps/studio/next.config.js` 48-432](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L48-L432)  
  
### å®‰å…¨å¤´ï¼ˆSecurity Headersï¼‰  
  
`headers()` å‡½æ•°ä¸ºæ‰€æœ‰è·¯ç”±å®šä¹‰äº†**å®‰å…¨å¤´**ï¼ˆsecurity headersï¼‰ï¼š  
  
![pic](20251128_11_pic_008.jpg)    
  
**å€¼å¾—æ³¨æ„çš„å¤´éƒ¨è§„åˆ™ï¼ˆNotable Header Rulesï¼‰:**  
  
1.  **ä»…é™å¹³å°æ¨¡å¼çš„ CSP**ï¼ˆPlatform-Only CSPï¼‰ï¼š**å†…å®¹å®‰å…¨ç­–ç•¥**ï¼ˆContent Security Policyï¼‰ä»…åœ¨ `NEXT_PUBLIC_IS_PLATFORM === 'true'` æ—¶åº”ç”¨ï¼Œä½¿ç”¨ `csp.js` ä¸­çš„ `getCSP()` å‡½æ•° [`apps/studio/next.config.js` 454-456](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L454-L456)  
2.  **HSTS**ï¼šä»…åœ¨ **Vercel ç”Ÿäº§éƒ¨ç½²**ï¼ˆVercel production deploymentsï¼‰ä¸Šå¯ç”¨ [`apps/studio/next.config.js` 447-452](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L447-L452)  
3.  **TypeScript å†…å®¹ç±»å‹**ï¼šé’ˆå¯¹ `.ts` æ–‡ä»¶è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œä»¥æ­£ç¡®çš„ **MIME ç±»å‹**ï¼ˆMIME typeï¼‰æä¾›æœåŠ¡ [`apps/studio/next.config.js` 482-484](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L482-L484)  
  
**æ¥æº:**  
[`apps/studio/next.config.js` 433-486](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L433-L486)  
  
## Turbo æ„å»ºæµæ°´çº¿ï¼ˆTurbo Build Pipelineï¼‰  
  
**Turbo** é€šè¿‡**ä¾èµ–ç®¡ç†**ï¼ˆdependency managementï¼‰åœ¨ **monorepo** ä¸­ç¼–æ’æ„å»ºæµç¨‹ï¼š  
  
![pic](20251128_11_pic_009.jpg)    
  
### Studio æ„å»ºé…ç½®ï¼ˆStudio Build Configurationï¼‰  
  
**å…³é”®é…ç½®å±æ€§ï¼ˆKey Configuration Propertiesï¼‰:**  
  
  * **ä¾èµ–é¡ºåºï¼ˆDependency Orderï¼‰** ï¼š`"dependsOn": ["^build"]` ç¡®ä¿æ‰€æœ‰**å·¥ä½œåŒºåŒ…**ï¼ˆworkspace packagesï¼‰éƒ½åœ¨ Studio æ„å»ºä¹‹å‰æ„å»º [`turbo.json` 47](https://github.com/supabase/supabase/blob/7490ca9e/turbo.json#L47-L47)  
  * **ç¯å¢ƒéš”ç¦»ï¼ˆEnvironment Isolationï¼‰** ï¼šæ˜¾å¼åˆ—å‡ºäº† 83 ä¸ªç¯å¢ƒå˜é‡ä»¥ç¡®ä¿**å¯å¤ç°æ€§**ï¼ˆreproducibilityï¼‰ [`turbo.json` 48-126](https://github.com/supabase/supabase/blob/7490ca9e/turbo.json#L48-L126)  
  * **é€ä¼ å˜é‡ï¼ˆPass-Through Variablesï¼‰** ï¼š`CURRENT_CLI_VERSION` å’Œ `VERCEL_GIT_COMMIT_SHA` è¢«**é€ä¼ **ï¼ˆpassed throughï¼‰è€Œä¸åµŒå…¥ [`turbo.json` 127](https://github.com/supabase/supabase/blob/7490ca9e/turbo.json#L127-L127)  
  * **ç¼“å­˜è¾“å‡ºï¼ˆCache Outputsï¼‰** ï¼š`.next/**` é™¤äº†ç¼“å­˜ç›®å½• [`turbo.json` 128](https://github.com/supabase/supabase/blob/7490ca9e/turbo.json#L128-L128)  
  
**æ¥æº:**  
[`turbo.json` 46-129](https://github.com/supabase/supabase/blob/7490ca9e/turbo.json#L46-L129)  
  
### æ„å»ºæ‰§è¡Œé¡ºåºï¼ˆBuild Execution Orderï¼‰  
  
![pic](20251128_11_pic_010.jpg)    
  
**æ¥æº:**  
[`turbo.json` 46-129](https://github.com/supabase/supabase/blob/7490ca9e/turbo.json#L46-L129)  
[`apps/studio/package.json` 8](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/package.json#L8-L8)  
[`package.json` 12](https://github.com/supabase/supabase/blob/7490ca9e/package.json#L12-L12)  
  
## æ„å»ºä¼˜åŒ–ï¼ˆBuild Optimizationï¼‰  
  
Studio æ„å»ºåŒ…å«äº†å‡ ç§**ä¼˜åŒ–ç­–ç•¥**ï¼š  
  
### Bundle åˆ†æï¼ˆBundle Analysisï¼‰  
  
å¯ä»¥é€šè¿‡ `ANALYZE` ç¯å¢ƒå˜é‡å¯ç”¨ **Bundle åˆ†æ**ï¼ˆBundle analysisï¼‰ï¼š  
  
```  
const withBundleAnalyzer = require('@next/bundle-analyzer')({  
  enabled: process.env.ANALYZE === 'true',  
})  
```  
  
[`apps/studio/next.config.js` 2-4](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L2-L4)  
  
**ç”¨æ³•ï¼ˆUsageï¼‰:**  
  
```  
ANALYZE=true pnpm build:studio  
```  
  
  
### TypeScript é…ç½®ï¼ˆTypeScript Configurationï¼‰  
  
**TypeScript ç±»å‹æ£€æŸ¥**ï¼ˆTypeScript type checkingï¼‰ä¸ºäº†æ•ˆç‡è€Œä¸æ„å»ºæµç¨‹åˆ†ç¦»ï¼š  
  
  * **æ„å»ºæ—¶ï¼ˆBuild Timeï¼‰** ï¼š`ignoreBuildErrors: true` [`apps/studio/next.config.js` 561](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L561-L561)  
  * **CI/CD é˜¶æ®µï¼ˆCI Timeï¼‰** ï¼šå•ç‹¬çš„ `pnpm typecheck` å‘½ä»¤åœ¨ `next typegen` ä¹‹åè¿è¡Œ `tsc --noEmit` [`apps/studio/package.json` 19-20](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/package.json#L19-L20)  
  
### æŒ‰éœ€æ¡ç›®ç¼“å­˜ï¼ˆOn-Demand Entry Cachingï¼‰  
  
é…ç½®å¢åŠ äº†**æŒ‰éœ€æ¡ç›®ç¼“å­˜**ï¼ˆon-demand entries cacheï¼‰ï¼š  
  
```  
onDemandEntries: {  
  maxInactiveAge: 24 * 60 * 60 * 1000, // 24 hours  
  pagesBufferLength: 100,              // Keep 100 pages in memory  
}  
```  
  
[`apps/studio/next.config.js` 554-557](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L554-L557)  
  
**æ¥æº:**  
[`apps/studio/next.config.js` 2-4](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L2-L4)  
[`apps/studio/next.config.js` 554-567](https://github.com/supabase/supabase/blob/7490ca9e/apps/studio/next.config.js#L554-L567)  
  
## æœ¬åœ°å¼€å‘é…ç½®ï¼ˆLocal Development Configurationï¼‰  
  
å¯¹äºé’ˆå¯¹**è‡ªæ‰˜ç®¡ Supabase å †æ ˆ**ï¼ˆself-hosted Supabase stackï¼‰çš„æœ¬åœ°å¼€å‘ï¼Œä»£ç åº“ä¸­åŒ…å«**è®¾ç½®è„šæœ¬**ï¼ˆsetup scriptsï¼‰ï¼š  
  
### æœ¬åœ°ç¯å¢ƒè®¾ç½®ï¼ˆLocal Environment Setupï¼‰  
  
![pic](20251128_11_pic_011.jpg)    
  
**è®¾ç½®å‘½ä»¤ï¼ˆSetup Commandï¼‰:**  
  
```  
pnpm setup:cli  
```  
  
è¯¥å‘½ä»¤ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š  
  
1.  å¯åŠ¨**æœ¬åœ° Supabase æœåŠ¡**ï¼ˆLocal Supabase servicesï¼‰ï¼Œ**æ’é™¤ Studio**ï¼ˆexcluding Studioï¼‰ [`package.json` 43](https://github.com/supabase/supabase/blob/7490ca9e/package.json#L43-L43)  
2.  å°†**æœåŠ¡å‡­è¯**ï¼ˆservice credentialsï¼‰æ•è·åˆ° `keys.json` ä¸­  
3.  è¿è¡Œ `generateLocalEnv.js` æ¥åˆ›å»º `.env.test` [`scripts/generateLocalEnv.js` 1-43](https://github.com/supabase/supabase/blob/7490ca9e/scripts/generateLocalEnv.js#L1-L43)  
  
**ç”Ÿæˆçš„ç¯å¢ƒå˜é‡ï¼ˆGenerated Environment Variablesï¼‰:**  
  
| Variable | Source | Purpose |  
| :--- | :--- | :--- |  
| `SUPABASE_URL` | `keys.json.$API_URL` | **æœ¬åœ° API ç«¯ç‚¹**ï¼ˆLocal API endpointï¼‰ |  
| `SUPABASE_ANON_KEY` | `keys.json.$ANON_KEY` | **æœ¬åœ°åŒ¿åå¯†é’¥**ï¼ˆLocal anon keyï¼‰ |  
| `SUPABASE_SERVICE_KEY` | `keys.json.$SERVICE_ROLE_KEY` | **æœ¬åœ°æœåŠ¡å¯†é’¥**ï¼ˆLocal service keyï¼‰ |  
| `STUDIO_PG_META_URL` | `${API_URL}/pg` | **æœ¬åœ° pg-meta ç«¯ç‚¹**ï¼ˆLocal pg-meta endpointï¼‰ |  
| `NEXT_PUBLIC_GOTRUE_URL` | `${API_URL}/auth/v1` | **æœ¬åœ° GoTrue ç«¯ç‚¹**ï¼ˆLocal GoTrue endpointï¼‰ |  
| `LOGFLARE_URL` | `http://127.0.0.1:54327` | **æœ¬åœ° Logflare**ï¼ˆLocal Logflareï¼‰ |  
  
**æ¥æº:**  
[`package.json` 43](https://github.com/supabase/supabase/blob/7490ca9e/package.json#L43-L43)  
[`scripts/generateLocalEnv.js` 1-43](https://github.com/supabase/supabase/blob/7490ca9e/scripts/generateLocalEnv.js#L1-L43)  
  
## è·¨åº”ç”¨ä¸€è‡´æ€§ï¼ˆCross-Application Consistencyï¼‰  
  
**Studio**ã€**Docs**ï¼ˆæ–‡æ¡£ï¼‰å’Œ **WWW**ï¼ˆè¥é”€ç½‘ç«™ï¼‰çš„**æ„å»ºé…ç½®**å…±äº«**å…±åŒæ¨¡å¼**ï¼ˆcommon patternsï¼‰ï¼Œä½†åœ¨å…·ä½“ç»†èŠ‚ä¸Šæœ‰æ‰€ä¸åŒï¼š  
  
### é…ç½®æ¯”è¾ƒï¼ˆConfiguration Comparisonï¼‰  
  
| Feature | Studio | Docs | WWW |  
| :--- | :--- | :--- | :--- |  
| **Next.js Version** | 15.5.2 | 15.5.2 | 15.5.2 |  
| **Output Mode**ï¼ˆè¾“å‡ºæ¨¡å¼ï¼‰ | `standalone` | æœªè®¾ç½® | æœªè®¾ç½® |  
| **Base Path**ï¼ˆåŸºç¡€è·¯å¾„ï¼‰ | å¯é…ç½® | `/docs` | ç©º |  
| **Sentry Integration**ï¼ˆSentry é›†æˆï¼‰ | ä»…é™å¹³å°æ¨¡å¼ | å§‹ç»ˆ | å§‹ç»ˆ |  
| **MDX Support**ï¼ˆMDX æ”¯æŒï¼‰ | å¦ | æ˜¯ | æ˜¯ |  
| **CDN Assets**ï¼ˆCDN èµ„æºï¼‰ | æ˜¯ | å¦ | å¦ |  
  
  
**å…³é”®å·®å¼‚**  
  
| åº”ç”¨ (Application) | å…³é”®é…ç½®å·®å¼‚ (Key Configuration Difference) | ç›®çš„ (Purpose) | æ¥æº (Source) |  
| :--- | :--- | :--- | :--- |  
| **Studio** | ä½¿ç”¨ **`standalone`** è¾“å‡ºæ¨¡å¼ã€‚ | ä¼˜åŒ– **å®¹å™¨åŒ–** (Containerization) å’Œ Docker éƒ¨ç½²çš„æ•ˆç‡ã€‚ | `apps/studio/next.config.js` ç¬¬ 35 è¡Œ |  
| **Docs** | éœ€è¦ **MDX æ’ä»¶**å’Œ **OpenAPI å¤„ç†**ã€‚ | ç”¨äºå¤„ç†æ–‡æ¡£å†…å®¹ï¼Œé›†æˆ MDX æ ¼å¼ï¼Œå¹¶å¯èƒ½ä» OpenAPI è§„èŒƒç”Ÿæˆæ–‡æ¡£ã€‚ | `apps/docs/next.config.mjs` ç¬¬ 15-22 è¡Œ |  
| **WWW** | ä½¿ç”¨ **Code Hike**ã€‚ | ç”¨äºç½‘ç«™ (WWW) åº”ç”¨ç¨‹åºä¸­çš„**ä»£ç è¯­æ³•é«˜äº®**å’Œäº¤äº’å¼ä»£ç å—å±•ç¤ºã€‚ | `apps/www/next.config.mjs` ç¬¬ 12-33 è¡Œ |  
  
-----  
  
# é™„å½•1: ã€æ¶æ„å¸ˆ/éƒ¨ç½²ã€‘CDN èµ„äº§äº¤ä»˜å’Œç‰ˆæœ¬å›æ»šçš„åŸå­æ€§ï¼ˆAtomicityï¼‰  
  
Studio ä½¿ç”¨æäº¤ **SHA** ä½œä¸º `assetPrefix` å¹¶é€šè¿‡ **`upload-static-assets.sh`** ä¸Šä¼ é™æ€èµ„æºåˆ° S3ï¼Œæ„å»ºäº†è‡ªå®šä¹‰çš„ **CDN èµ„äº§äº¤ä»˜æµç¨‹**ï¼ˆCDN Asset Delivery Pipelineï¼‰ã€‚  
  
**å…³é”®é—®é¢˜ï¼š**  
  
> è¯·é—®åœ¨è¿›è¡Œ**çƒ­ä¿®å¤**ï¼ˆHotfixï¼‰æˆ–**ç‰ˆæœ¬å›æ»š**ï¼ˆRollbackï¼‰æ—¶ï¼Œ**CDN çš„ç¼“å­˜å¤±æ•ˆ**ï¼ˆCache Invalidationï¼‰æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬å¦‚ä½•ç¡®ä¿æ–°ç‰ˆæœ¬çš„ `assetPrefix` ç”Ÿæ•ˆæ—¶ï¼Œæ‰€æœ‰å¿…è¦çš„é™æ€èµ„æºï¼ˆç‰¹åˆ«æ˜¯å…³é”®å­—ä½“å’Œå›¾ç‰‡ï¼‰å·²åœ¨ S3 ä¸Š**åŸå­æ€§**ï¼ˆAtomicallyï¼‰åœ°å°±ç»ªå¹¶å¯è®¿é—®ï¼Œä»¥é¿å…ç”¨æˆ·çœ‹åˆ°æ··åˆç‰ˆæœ¬æˆ–æŸåçš„ UIï¼Ÿ  
  
**(å±•å¼€çš„ç»†èŠ‚ï¼š è¿™æ¶‰åŠåˆ°ç”Ÿäº§ç¯å¢ƒçš„æ€§èƒ½å’Œç¨³å®šæ€§ï¼Œéœ€è¦äº†è§£ `upload-static-assets.sh` å¦‚ä½•ä¸ Vercel éƒ¨ç½²æµç¨‹åè°ƒï¼Œä»¥åŠæ˜¯å¦ä½¿ç”¨äº† S3 çš„ç‰ˆæœ¬æ§åˆ¶æˆ–ä¸“é—¨çš„ CDN é¢„çƒ­/åˆ·æ–°æœåŠ¡ã€‚)**   
  
## å›ç­”  
  
## CDN ç¼“å­˜å¤±æ•ˆæœºåˆ¶åˆ†æ  
  
åŸºäºå½“å‰ä»£ç åº“ä¸Šä¸‹æ–‡ï¼Œæˆ‘æ— æ³•å®Œå…¨å›ç­”å…³äºçƒ­ä¿®å¤å’Œç‰ˆæœ¬å›æ»šæ—¶ CDN ç¼“å­˜å¤±æ•ˆæœºåˆ¶çš„é—®é¢˜ï¼Œå› ä¸ºå…³é”®çš„å®ç°ç»†èŠ‚ä¸åœ¨æä¾›çš„ä»£ç ç‰‡æ®µä¸­ã€‚  
  
### å½“å‰å¯è§çš„å®ç°  
  
**assetPrefix ç”Ÿæˆæœºåˆ¶ï¼š**  
Studio åº”ç”¨é€šè¿‡ `getAssetPrefix()` å‡½æ•°ä½¿ç”¨æäº¤ SHA ä½œä¸ºç‰ˆæœ¬æ ‡è¯†  ï¼š  
  
```javascript  
function getAssetPrefix() {  
  // ç¯å¢ƒæ£€æŸ¥é€»è¾‘  
  const SUPABASE_ASSETS_URL =  
    process.env.NEXT_PUBLIC_ENVIRONMENT === 'staging'  
      ? 'https://frontend-assets.supabase.green'  
      : 'https://frontend-assets.supabase.com'  
    
  return `${SUPABASE_ASSETS_URL}/${process.env.SITE_NAME}/${process.env.VERCEL_GIT_COMMIT_SHA.substring(0, 12)}`  
}  
```  
  
**æ„å»ºæµç¨‹ï¼š**  
æ„å»ºè„šæœ¬åœ¨ `apps/studio/package.json` ä¸­å®šä¹‰  ï¼š  
```json  
"build": "next build && ./../../scripts/upload-static-assets.sh"  
```  
  
### ç¼ºå¤±çš„å…³é”®ä¿¡æ¯  
  
è¦å®Œæ•´å›ç­”æ‚¨çš„é—®é¢˜ï¼Œéœ€è¦æŸ¥çœ‹ä»¥ä¸‹æœªåœ¨å½“å‰ä¸Šä¸‹æ–‡ä¸­æä¾›çš„ä»£ç ï¼š  
  
1. **`upload-static-assets.sh` è„šæœ¬å®ç°** - äº†è§£ S3 ä¸Šä¼ çš„å…·ä½“æµç¨‹å’ŒåŸå­æ€§ä¿è¯  
2. **CDN ç¼“å­˜å¤±æ•ˆæœºåˆ¶** - æ²¡æœ‰æ‰¾åˆ°æ˜ç¡®çš„ç¼“å­˜åˆ·æ–°æˆ–å¤±æ•ˆä»£ç   
3. **Vercel éƒ¨ç½²é›†æˆ** - éœ€è¦äº†è§£éƒ¨ç½²æµç¨‹å¦‚ä½•ä¸ CDN ä¸Šä¼ åè°ƒ  
  
### ç›¸å…³çš„ Smart CDN æœºåˆ¶  
  
ä»åšå®¢æ–‡ç« ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒSupabase Storage æœ‰ Smart CDN æœºåˆ¶  ï¼Œä½†è¿™ä¸»è¦é’ˆå¯¹ Storage æœåŠ¡ï¼Œè€Œé Studio åº”ç”¨çš„é™æ€èµ„æº CDNã€‚  
  
## å»ºè®®  
  
è¦è·å¾—å®Œæ•´çš„ç­”æ¡ˆï¼Œå»ºè®®æŸ¥çœ‹ï¼š  
- `scripts/upload-static-assets.sh` è„šæœ¬  
- Vercel éƒ¨ç½²é…ç½®  
- CDN æä¾›å•†çš„ç¼“å­˜å¤±æ•ˆé…ç½®  
  
## Notes  
  
å½“å‰ä»£ç åº“ä¸Šä¸‹æ–‡ä¸»è¦å±•ç¤ºäº† `assetPrefix` çš„ç”Ÿæˆé€»è¾‘å’Œæ„å»ºè„šæœ¬è°ƒç”¨ï¼Œä½†ç¼ºå°‘å…³é”®çš„ S3 ä¸Šä¼ è„šæœ¬å’Œ CDN ç¼“å­˜å¤±æ•ˆæœºåˆ¶çš„å®ç°ç»†èŠ‚ã€‚å…¶ä»–åº”ç”¨ï¼ˆwwwã€docsï¼‰ä½¿ç”¨ç±»ä¼¼çš„ `getAssetPrefix()` æ¨¡å¼   ï¼Œä½†åŒæ ·ç¼ºå°‘ç¼“å­˜å¤±æ•ˆçš„å…·ä½“å®ç°ã€‚  
  
  
  
-----  
  
# é™„å½•2: ã€å¼€å‘è€…/æ—¥å¸¸ç»´æŠ¤ã€‘å¤æ‚è·¯ç”±è§„åˆ™çš„å›å½’æµ‹è¯•ï¼ˆRegression Testingï¼‰  
  
Studio çš„ **`next.config.js`** ä¸­å®šä¹‰äº†è¶…è¿‡ **40 æ¡å¸¸è§é‡å®šå‘**ï¼ˆCommon Redirectsï¼‰ä»¥åŠå¹³å°æ¨¡å¼ï¼ˆPlatform Modeï¼‰å’Œè‡ªæ‰˜ç®¡æ¨¡å¼ï¼ˆSelf-Hosted Modeï¼‰ä¸‹çš„å¤æ‚è·¯ç”±è§„åˆ™ã€‚  
  
**å…³é”®é—®é¢˜ï¼š**  
  
> æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¼€å‘è€…å¦‚ä½•**é«˜æ•ˆã€å…¨é¢**åœ°æµ‹è¯•æ‰€æœ‰è¿™äº›é‡å®šå‘å’Œé‡å†™ï¼ˆRewritesï¼‰ä»¥é˜²æ­¢**è·¯ç”±å›å½’**ï¼ˆRouting Regressionï¼‰ï¼Ÿæ˜¯å¦æœ‰ä¸“é—¨çš„**é›†æˆæµ‹è¯•**ï¼ˆIntegration Testsï¼‰æˆ–**è·¯ç”±æµ‹è¯•å·¥å…·**ï¼ˆRouting Test Harnessï¼‰æ¥ç¡®ä¿åœ¨ä¸¤ç§**å¹³å°æ¨¡å¼**ï¼ˆPlatform Modeï¼‰ä¸‹çš„è·¯ç”±ä¸€è‡´æ€§å’Œç¨³å®šæ€§ï¼Œä»è€Œé™ä½ç»´æŠ¤æˆæœ¬ï¼Ÿ  
  
**(å±•å¼€çš„ç»†èŠ‚ï¼š å¤§é‡ç¡¬ç¼–ç çš„è·¯ç”±è§„åˆ™æ˜¯æ½œåœ¨çš„ç»´æŠ¤ç—›ç‚¹ã€‚å¼€å‘è€…éœ€è¦äº†è§£ç”¨äºè‡ªåŠ¨åŒ–æµ‹è¯•è¿™äº›è·¯ç”±çš„å·¥å…·é“¾å’Œå®è·µï¼Œä»¥ç¡®ä¿æ¯æ¬¡éƒ¨ç½²éƒ½æ˜¯å®‰å…¨çš„ã€‚)**    
  
## å›ç­”  
  
æ ¹æ®æä¾›çš„ä»£ç åº“ä¸Šä¸‹æ–‡ï¼Œç›®å‰**æ²¡æœ‰æ˜ç¡®çš„è¯æ®æ˜¾ç¤ºå­˜åœ¨ä¸“é—¨çš„é›†æˆæµ‹è¯•æˆ–è·¯ç”±æµ‹è¯•å·¥å…·**æ¥éªŒè¯ Studio å¤æ‚çš„é‡å®šå‘å’Œé‡å†™è§„åˆ™ã€‚  
  
### è·¯ç”±é…ç½®ç°çŠ¶åˆ†æ  
  
Studio åº”ç”¨ç¨‹åºçš„è·¯ç”±è§„åˆ™è¢«**ç¡¬ç¼–ç **åœ¨ **`next.config.js`** æ–‡ä»¶ä¸­ï¼Œè¿™ä½¿å¾—ç»´æŠ¤å’ŒéªŒè¯å˜å¾—å›°éš¾ã€‚  
  
#### è·¯ç”±å¤æ‚åº¦  
  
Studio è·¯ç”±å­˜åœ¨ä»¥ä¸‹å¤æ‚æ€§ï¼š  
  
* **æ¡ä»¶é‡å®šå‘ï¼š** è·¯ç”±é€»è¾‘æ ¹æ®ç¯å¢ƒå˜é‡ **`NEXT_PUBLIC_IS_PLATFORM`** çš„å€¼è€Œå˜åŒ–ï¼š  
    * **å¹³å°æ¨¡å¼ (Platform Mode)ï¼š** æ ¹è·¯å¾„ `/` é‡å®šå‘åˆ° `/org`ã€‚  
    * **è‡ªæ‰˜ç®¡æ¨¡å¼ (Self-Hosted Mode)ï¼š** æ ¹è·¯å¾„ `/` é‡å®šå‘åˆ° `/project/default`ã€‚  
* **å¤§é‡é€šç”¨è§„åˆ™ï¼š** åŒ…å« **40+ æ¡**æ°¸ä¹…é‡å®šå‘è§„åˆ™ï¼ˆ`permanent: true`ï¼‰ï¼Œç”¨äºå¤„ç† URL ç»“æ„å˜æ›´ã€åŠŸèƒ½é‡ç»„å’Œæ—§ç‰ˆé“¾æ¥å…¼å®¹æ€§ï¼ˆä¾‹å¦‚ï¼Œå°† `/project/:ref/database/webhooks` æ°¸ä¹…é‡å®šå‘åˆ° `/project/:ref/integrations/webhooks/overview`ï¼‰ã€‚  
* **å¤šåº”ç”¨æ¨¡å¼ï¼š** å¦ä¸€ä¸ªåº”ç”¨ **`www`** åœ¨ **`apps/www/lib/redirects.js`** ä¸­åŒ…å«è¶…è¿‡ **1000 æ¡**é‡å®šå‘è§„åˆ™ï¼Œè¿›ä¸€æ­¥å‡¸æ˜¾äº†å¯¹è‡ªåŠ¨åŒ–æµ‹è¯•çš„å·¨å¤§éœ€æ±‚ã€‚  
  
  
### ğŸ›‘ å­˜åœ¨çš„æµ‹è¯•ç¼ºå¤±  
  
æ ¹æ®ä¸Šä¸‹æ–‡ï¼Œä»¥ä¸‹å…³é”®çš„æµ‹è¯•åŸºç¡€è®¾æ–½ç¼ºå¤±ï¼š  
  
* **é›†æˆæµ‹è¯• (Integration Tests)ï¼š** ç¼ºä¹ç«¯åˆ°ç«¯éªŒè¯ï¼Œæ— æ³•ç¡®è®¤è·¯ç”±åœ¨å®é™…çš„ Next.js ç¯å¢ƒä¸­æ˜¯å¦æ­£ç¡®å·¥ä½œï¼Œä»¥åŠæ˜¯å¦è¿”å›æ­£ç¡®çš„ **HTTP çŠ¶æ€ç **ï¼ˆä¾‹å¦‚ï¼Œ308/æ°¸ä¹…é‡å®šå‘ï¼‰ã€‚  
* **è‡ªåŠ¨åŒ–é‡å®šå‘éªŒè¯ï¼š** æ²¡æœ‰å·¥å…·æ¥è‡ªåŠ¨æ£€æŸ¥æ‰€æœ‰ 40+ æ¡é‡å®šå‘è§„åˆ™æ˜¯å¦æœ‰æ•ˆï¼Œæˆ–é˜²æ­¢æ—§é“¾æ¥å¤±æ•ˆï¼ˆå³**è·¯ç”±å›å½’**ï¼‰ã€‚  
* **æ¨¡å¼ç‰¹å®šæµ‹è¯•ï¼š** ç¼ºä¹é’ˆå¯¹ **Platform Mode** å’Œ **Self-Hosted Mode** ä¸¤ç§éƒ¨ç½²ç¯å¢ƒçš„ç‹¬ç«‹è·¯ç”±æµ‹è¯•ã€‚  
  
  
  
### âœ… æ¨èçš„æµ‹è¯•æ–¹æ³•  
  
ä¸ºé˜²æ­¢è·¯ç”±å›å½’ï¼Œåº”å®æ–½ä»¥ä¸‹è‡ªåŠ¨åŒ–æµ‹è¯•ç­–ç•¥ï¼š  
  
1.  **å•å…ƒæµ‹è¯• (Unit Tests) ğŸ§ª**  
    * **ç›®çš„ï¼š** éªŒè¯ `redirects()` å‡½æ•°åœ¨ä¸åŒç¯å¢ƒå˜é‡ï¼ˆå¦‚ `NEXT_PUBLIC_IS_PLATFORM`ï¼‰ä¸‹çš„**è¾“å‡ºæ•°ç»„ç»“æ„**æ˜¯å¦æ­£ç¡®ã€‚  
    * **ä¼˜åŠ¿ï¼š** å¿«é€ŸéªŒè¯é…ç½®é€»è¾‘ï¼Œç¡®ä¿é…ç½®æ–‡ä»¶çš„æœ‰æ•ˆæ€§ã€‚  
  
2.  **é™æ€åˆ†æ (Static Analysis)**  
    * **ç›®çš„ï¼š** è‡ªåŠ¨æ£€æŸ¥ç¡¬ç¼–ç çš„é‡å®šå‘æ•°ç»„ä¸­æ˜¯å¦å­˜åœ¨**è§„åˆ™å†²çª**ï¼ˆä¾‹å¦‚ï¼Œå¤šä¸ªè§„åˆ™å…·æœ‰ç›¸åŒçš„ `source`ï¼‰æˆ–**å¾ªç¯é‡å®šå‘**ï¼ˆA -> B -> Aï¼‰ã€‚  
  
3.  **é›†æˆæµ‹è¯• (Integration Tests) ğŸ”—**  
    * **å·¥å…·ï¼š** ä½¿ç”¨ **Playwright** æˆ– **Cypress** ç­‰ E2E æµ‹è¯•æ¡†æ¶ã€‚  
    * **ç›®çš„ï¼š** éƒ¨ç½²åº”ç”¨å¹¶æ¨¡æ‹Ÿç”¨æˆ·è®¿é—® **`source`** URLï¼Œç„¶åæ–­è¨€æµè§ˆå™¨æ˜¯å¦è¢«æ­£ç¡®å¯¼èˆªåˆ° **`destination`** URLï¼Œå¹¶æ£€æŸ¥æœåŠ¡å™¨è¿”å›çš„ **HTTP çŠ¶æ€ç **æ˜¯å¦ç¬¦åˆé¢„æœŸï¼ˆå¦‚ 308/æ°¸ä¹…é‡å®šå‘ï¼‰ã€‚  
    * **å…³é”®ï¼š** å¿…é¡»åœ¨ CI æµç¨‹ä¸­é…ç½®å’Œè¿è¡Œé’ˆå¯¹**ä¸¤ç§æ¨¡å¼ï¼ˆå¹³å°/è‡ªæ‰˜ç®¡ï¼‰** çš„æµ‹è¯•ï¼Œä»¥ç¡®ä¿è¦†ç›–å·®å¼‚åŒ–è·¯ç”±ã€‚  
  
4.  **CI ç®¡é“ (CI Pipeline) é›†æˆ**  
    * åœ¨æŒç»­é›†æˆæµç¨‹ä¸­ï¼Œå°†è·¯ç”±æµ‹è¯•è®¾ç½®ä¸º **`next.config.js`** æ–‡ä»¶æ›´æ”¹æ—¶çš„**å¼ºåˆ¶é—¨ç¦**ï¼Œä»¥é˜²æ­¢ä»»ä½•è·¯ç”±é—®é¢˜è¿›å…¥éƒ¨ç½²ã€‚  
  
-----  
  
# é™„å½•3: ã€ç”¨æˆ·/æœ¬åœ°ç¯å¢ƒã€‘æœ¬åœ°ä¸ç”Ÿäº§ç¯å¢ƒçš„åŠŸèƒ½å·®å¼‚ï¼ˆEnvironment Parityï¼‰  
  
å°½ç®¡æœ¬åœ°å¼€å‘é…ç½®å¯ä»¥ç”Ÿæˆ **`.env.test`** æ–‡ä»¶å¹¶è¿æ¥åˆ°æœ¬åœ° Supabase å †æ ˆï¼Œä½†ç”Ÿäº§ç¯å¢ƒé›†æˆäº† Sentryã€CDN èµ„äº§å’Œ **Vercel ç‰¹æ€§æ ‡å¿—**ï¼ˆVercel Feature Flagsï¼‰ç­‰ã€‚  
  
**å…³é”®é—®é¢˜ï¼š**  
  
> åœ¨**æœ¬åœ°è¿è¡Œ Studio** æ—¶ï¼Œä¸**ç”Ÿäº§ç¯å¢ƒ**ï¼ˆç‰¹åˆ«æ˜¯å¹³å°æ¨¡å¼ï¼‰ç›¸æ¯”ï¼Œ**å“ªäº›æ ¸å¿ƒåŠŸèƒ½ï¼ˆå¦‚è®¡è´¹ã€è®¤è¯æµã€æ—¥å¿—æ”¶é›†ï¼‰ä»æ— æ³•å®Œå…¨æ¨¡æ‹Ÿæˆ–æµ‹è¯•ï¼Ÿ** å¼€å‘è€…åœ¨æ—¥å¸¸ä½¿ç”¨ä¸­å¦‚ä½•å¤„ç†è¿™ç§**ç¯å¢ƒå·®å¼‚**ï¼ˆEnvironment Parityï¼‰å¯¼è‡´çš„è°ƒè¯•æŒ‘æˆ˜ï¼Œä»¥åŠæ˜¯å¦æœ‰é’ˆå¯¹æœ¬åœ°ç¯å¢ƒçš„åŠŸèƒ½é™åˆ¶æ–‡æ¡£ï¼Ÿ  
  
**(å±•å¼€çš„ç»†èŠ‚ï¼š å¼€å‘è€…è¿è¡Œ `pnpm start:local` æ—¶ï¼Œéœ€è¦çŸ¥é“å“ªäº›åŠŸèƒ½æ˜¯â€œå‡â€çš„æˆ–ä¸å¯ç”¨çš„ã€‚è¿™å½±å“åˆ°è°ƒè¯•æ•ˆç‡å’ŒåŠŸèƒ½å®ç°çš„å®Œæ•´æ€§ï¼Œç‰¹åˆ«æ˜¯å¯¹äºæ¶‰åŠå¤–éƒ¨æœåŠ¡çš„ç‰¹æ€§ã€‚)**    
  
## å›ç­”  
  
## æœ¬åœ° Studio ä¸ç”Ÿäº§ç¯å¢ƒçš„æ ¸å¿ƒåŠŸèƒ½å·®å¼‚  
  
æœ¬åœ°è¿è¡Œ Studio æ—¶ï¼ˆé€šè¿‡ `pnpm dev:studio-local` æˆ– `pnpm setup:cli`ï¼‰ï¼Œä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½æ— æ³•å®Œå…¨æ¨¡æ‹Ÿæˆ–æµ‹è¯•ï¼š  
  
### ğŸ”´ å®Œå…¨ä¸å¯ç”¨çš„åŠŸèƒ½  
  
| åŠŸèƒ½ç±»åˆ« | æœ¬åœ°çŠ¶æ€ | ç”Ÿäº§ç¯å¢ƒçŠ¶æ€ | å½±å“ |  
|---------|---------|-------------|------|  
| **Sentry é”™è¯¯ç›‘æ§** | å®Œå…¨ç¦ç”¨   | å¯ç”¨æºç æ˜ å°„ã€ç»„ä»¶æ³¨é‡Šã€è‡ªåŠ¨ç›‘æ§ | æ— æ³•æµ‹è¯•é”™è¯¯è¿½è¸ªå’Œæ€§èƒ½ç›‘æ§ |  
| **CDN é™æ€èµ„äº§** | ä½¿ç”¨æœ¬åœ°èµ„æº   | ä» `frontend-assets.supabase.com` åŠ è½½ | æ— æ³•æµ‹è¯• CDN ç¼“å­˜å’Œèµ„äº§åˆ†å‘ |  
| **Vercel ç‰¹æ€§æ ‡å¿—** | ä»£ç†åˆ°ä¸»åŸŸå   | å®Œæ•´é›†æˆ | æ— æ³•æµ‹è¯•ç‰¹æ€§å¼€å…³åŠŸèƒ½ |  
| **è®¡è´¹ç³»ç»Ÿ** | ä¸å¯ç”¨ | å®Œæ•´é›†æˆ | æ— æ³•æµ‹è¯•è®¢é˜…ã€ç”¨é‡è®¡è´¹ |  
| **é¡¹ç›®è®¾ç½®ç®¡ç†** | éœ€é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†   | Dashboard å¯ç¼–è¾‘ | æ— æ³•æµ‹è¯•è®¾ç½®æ›´æ–°æµç¨‹ |  
  
### ğŸŸ¡ éƒ¨åˆ†å¯ç”¨çš„åŠŸèƒ½  
  
| åŠŸèƒ½ | æœ¬åœ°é™åˆ¶ | è¯´æ˜ |  
|------|---------|------|  
| **è®¤è¯æµ** | æœ¬åœ° GoTrue å®ä¾‹   | éœ€æ‰‹åŠ¨é…ç½® OAuth æä¾›å•†   |  
| **æ—¥å¿—æ”¶é›†** | æœ¬åœ° Logflare   | åŠŸèƒ½å—é™ï¼ŒæŸ¥è¯¢èƒ½åŠ›æœ‰é™   |  
| **å­˜å‚¨æ¡¶** | éœ€é…ç½®æ–‡ä»¶å®šä¹‰   | æ— æ³•æµ‹è¯•åŠ¨æ€åˆ›å»º |  
  
### ğŸ”§ å¤„ç†ç¯å¢ƒå·®å¼‚çš„ç­–ç•¥  
  
#### 1. ç¯å¢ƒå˜é‡éš”ç¦»  
æœ¬åœ°ç¯å¢ƒé€šè¿‡ `generateLocalEnv.js` ç”Ÿæˆä¸“ç”¨é…ç½®  ï¼š  
```javascript  
// å…³é”®å·®å¼‚æ ‡è¯†  
NEXT_PUBLIC_IS_PLATFORM: 'false',  // æ³¨é‡Šæ‰ä½†é»˜è®¤ä¸º false  
NEXT_PUBLIC_NODE_ENV: 'test',  
SENTRY_IGNORE_API_RESOLUTION_ERROR: '1'  
```  
  
#### 2. åŠŸèƒ½å¼€å…³æ£€æµ‹  
åœ¨ä»£ç ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡æ£€æµ‹åŠŸèƒ½å¯ç”¨æ€§ï¼š  
```javascript  
const isPlatform = process.env.NEXT_PUBLIC_IS_PLATFORM === 'true'  
if (isPlatform) {  
  // å¹³å°ç‰¹æœ‰åŠŸèƒ½ï¼ˆSentryã€è®¡è´¹ç­‰ï¼‰  
}  
```  
  
#### 3. è°ƒè¯•å»ºè®®  
- **é”™è¯¯ç›‘æ§**ï¼šæœ¬åœ°ä½¿ç”¨ `console.error`ï¼Œç”Ÿäº§ä¾èµ– Sentry  
- **è®¤è¯æµ‹è¯•**ï¼šä½¿ç”¨æœ¬åœ° SMTP æœåŠ¡å™¨æµ‹è¯•é‚®ä»¶æµ    
- **æ—¥å¿—éªŒè¯**ï¼šæ£€æŸ¥æœ¬åœ° Logflare å®ä¾‹è€Œéç”Ÿäº§æŸ¥è¯¢  
  
### ğŸ“š ç›¸å…³æ–‡æ¡£  
  
åŠŸèƒ½é™åˆ¶çš„å®˜æ–¹æ–‡æ¡£ä½äºï¼š  
- æœ¬åœ°å¼€å‘æ¦‚è¿°ï¼šæ˜ç¡®è¯´æ˜äº†ç¯å¢ƒå·®å¼‚    
- Studio READMEï¼šè¯´æ˜äº†åŠŸèƒ½èŒƒå›´    
  
## Notes  
  
- æœ¬åœ°ç¯å¢ƒé»˜è®¤ä¸ºéå¹³å°æ¨¡å¼ï¼ˆ`NEXT_PUBLIC_IS_PLATFORM !== 'true'`ï¼‰ï¼Œè¿™æ˜¯å¤§å¤šæ•°åŠŸèƒ½å·®å¼‚çš„æ ¹æœ¬åŸå›   
- `pnpm setup:cli` å‘½ä»¤ä¼šç”Ÿæˆ `.env.test` æ–‡ä»¶ï¼Œä½†ä¸ä¼šå¯ç”¨å¹³å°ç‰¹æœ‰åŠŸèƒ½    
- å¯¹äºéœ€è¦æµ‹è¯•å¹³å°åŠŸèƒ½çš„åœºæ™¯ï¼Œå»ºè®®ä½¿ç”¨ Supabase çš„é¢„è§ˆåˆ†æ”¯åŠŸèƒ½è€Œéæœ¬åœ°ç¯å¢ƒ  
    
#### [PolarDB å­¦ä¹ å›¾è°±](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL è§£å†³æ–¹æ¡ˆé›†åˆ](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [å¾·å“¥ / digoal's Github - å…¬ç›Šæ˜¯ä¸€è¾ˆå­çš„äº‹.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About å¾·å“¥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
