## 大学生数据库实践课, docker 镜像  
  
### 作者  
digoal  
  
### 日期  
2025-12-05  
  
### 标签  
PostgreSQL , PolarDB , DuckDB , 大学生 , 数据库 , 应用 , 使用 , 实践课 , AI , 教学  
  
----  
  
## 背景  
参考以下文章制作的实践课镜像:  
- [《大学生数据库实践课-PostgreSQL本地学习镜像的使用》](../202509/20250903_08.md)  
- [《2023-PostgreSQL Docker镜像学习环境 ARM64版, 已集成热门插件和工具》](../202308/20230814_02.md)  
- [《2023-PostgreSQL Docker镜像学习环境 AMD64版, 已集成热门插件和工具》](../202307/20230710_03.md)  
  
该数据库镜像包括PostgreSQL 18及插件(pgvector, pgvectorscale, vectorchord, vectorchord-bm25, pg_tokenizer, pg_search, postgresml(不支持pg18, 暂未列入), pg_jieba, pg_bigm , pgroonga, postgis, 以及PG内置插件), DuckDB及插件(duckpgq, 目前仅DuckDB v1.4.1支持duckpgq插件) ;  
  
vector的测试集请自行下载, 参考: https://gitee.com/polardb-tianchi/polardb_competition_2025/tree/master/test  
  
用于该课程:  
- [《大学生数据库实践课开课了 : 1 大纲》](../202512/20251202_10.md)  
  
## 制作过程  
在 macOS M2 笔记本上进行制作.  
  
1、下载需要安装的软件和依赖, 并打包.  
```  
mkdir ~/pg18  
cd ~/pg18  
git clone --depth 1 -c core.symlinks=true https://github.com/jaiminpan/pg_jieba  
cd pg_jieba  
git submodule update --init --recursive  
cd ~/pg18  
git clone --depth 1 -c core.symlinks=true https://github.com/pgbigm/pg_bigm  
git clone --depth 1 -b 1.0.0 -c core.symlinks=true https://github.com/tensorchord/VectorChord  
git clone --depth 1 -c core.symlinks=true https://github.com/tensorchord/pg_tokenizer.rs  
git clone --depth 1 -c core.symlinks=true https://github.com/tensorchord/VectorChord-bm25  
git clone --depth 1 -c core.symlinks=true https://github.com/paradedb/paradedb  
git clone --depth 1 --branch 0.9.0 -c core.symlinks=true https://github.com/timescale/pgvectorscale  
  
curl -L https://github.com/duckdb/duckdb/releases/download/v1.4.1/duckdb_cli-linux-arm64.gz -o ./duckdb_cli-linux-arm64.gz  
curl -L https://github.com/duckdb/duckdb/releases/download/v1.4.1/duckdb_cli-linux-amd64.gz -o ./duckdb_cli-linux-amd64.gz  
  
# 打包  
tar -Jcf 18.tar.xz *  
  
$ ll  
total 238528  
drwxr-x---+ 78 digoal  staff   2.4K Dec 17 09:37 ..  
drwxr-xr-x  17 digoal  staff   544B Dec 17 09:52 pg_jieba  
drwxr-xr-x  19 digoal  staff   608B Dec 17 09:53 pg_bigm  
drwxr-xr-x  23 digoal  staff   736B Dec 17 09:53 VectorChord  
drwxr-xr-x  18 digoal  staff   576B Dec 17 09:53 pg_tokenizer.rs  
drwxr-xr-x  17 digoal  staff   544B Dec 17 09:53 VectorChord-bm25  
drwxr-xr-x  35 digoal  staff   1.1K Dec 17 09:53 paradedb  
drwxr-xr-x  19 digoal  staff   608B Dec 17 09:53 pgvectorscale  
-rw-r--r--@  1 digoal  staff    17M Dec 17 09:53 duckdb_cli-linux-arm64.gz  
-rw-r--r--@  1 digoal  staff    18M Dec 17 09:53 duckdb_cli-linux-amd64.gz  
drwxr-xr-x  12 digoal  staff   384B Dec 17 09:54 .  
-rw-r--r--@  1 digoal  staff    72M Dec 17 09:55 18.tar.xz  
```  
  
拉取基础镜像:  
```  
# 制作 ARM64 镜像拉取如下:  
docker pull --platform=linux/arm64 postgres:18-bookworm  
  
# 制作 x86_64 镜像拉取如下:  
docker pull --platform=linux/amd64 postgres:18-bookworm  
```  
  
2、编写脚本, 基于PG 18官方镜像, 安装以上插件以及其他必要软件.  
```  
vi ~/pg18/1.sh  
```  
  
脚本内容  
```  
#!/bin/bash  
set -vx  
  
echo "# Debian 12 Bookworm 阿里云镜像源  
deb http://mirrors.aliyun.com/debian/ bookworm main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian/ bookworm main contrib non-free non-free-firmware  
  
deb http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian/ bookworm-updates main contrib non-free non-free-firmware  
  
deb http://mirrors.aliyun.com/debian/ bookworm-backports main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian/ bookworm-backports main contrib non-free non-free-firmware  
  
deb http://mirrors.aliyun.com/debian-security/ bookworm-security main contrib non-free non-free-firmware  
deb-src http://mirrors.aliyun.com/debian-security/ bookworm-security main contrib non-free non-free-firmware" > /etc/apt/sources.list  
  
mv /etc/apt/sources.list.d/debian.sources /etc/apt/sources.list.d/debian.sources.bak  
  
# install clang-19  
apt-get update  
apt-get install -y wget  
wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc  
echo "deb https://mirrors.tuna.tsinghua.edu.cn/llvm-apt/bookworm/ llvm-toolchain-bookworm-19 main" | tee /etc/apt/sources.list.d/llvm.list  
apt-get update  
apt-get install -y clang-19 lldb-19 lld-19 clangd-19  
update-alternatives --install /usr/bin/clang clang /usr/bin/clang-19 100  
update-alternatives --install /usr/bin/clang++ clang++ /usr/bin/clang++-19 100  
update-alternatives --install /usr/bin/clangd clangd /usr/bin/clangd-19 100  
  
PG_MAJOR=18  
POSTGIS_MAJOR=3  
  
apt-get update \
  && apt-cache showpkg postgresql-$PG_MAJOR-postgis-$POSTGIS_MAJOR \
  && apt-get install -y --no-install-recommends \
       ca-certificates \
       postgresql-$PG_MAJOR-postgis-$POSTGIS_MAJOR \
       postgresql-$PG_MAJOR-postgis-$POSTGIS_MAJOR-scripts  
  
apt-get install -y postgresql-18-pgvector  
  
cd /tmp  
apt install -y -V ca-certificates lsb-release wget  
wget https://packages.groonga.org/debian/groonga-apt-source-latest-$(lsb_release --codename --short).deb  
apt-get install -y -V ./groonga-apt-source-latest-$(lsb_release --codename --short).deb  
apt update  
apt-get install -y -V postgresql-18-pgdg-pgroonga  
apt-get install -y -V groonga-tokenizer-mecab  
  
apt-get update \
  && apt-get install -y git build-essential gcc g++ cmake postgresql-server-dev-18  
  
apt-get install -y curl pkg-config build-essential libgmp-dev libmpfr-dev libmpc-dev vim tar zip gzip  
  
  
cd /tmp  
  
tar -Jxf 18.tar.xz  
  
cd /tmp/pg_jieba  
mkdir build  
cd build  
cmake -DPostgreSQL_TYPE_INCLUDE_DIR="/usr/include/postgresql/18/server" ..  
make -j 4  
make install  
  
cd /tmp/pg_bigm  
USE_PGXS=1 make install  
  
cd /tmp  
export RUSTUP_DIST_SERVER=https://mirrors.ustc.edu.cn/rust-static  
export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup  
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -o ./rust.sh  
chmod 500 rust.sh  
./rust.sh -y  
source "$HOME/.cargo/env"  
rustup default stable  
  
cd /tmp/paradedb/pg_search  
mkdir /root/.pgrx  
export PGRX_HOME="/root/.pgrx"  
cargo install --locked cargo-pgrx --version 0.16.1  
cargo pgrx init --pg18=`which pg_config`  
CC=clang CXX=clang++ cargo pgrx install --release --pg-config `which pg_config`  
  
cd /tmp/VectorChord  
CC=clang CXX=clang++ cargo pgrx install --release --pg-config `which pg_config`  
  
cd /tmp/pg_tokenizer.rs  
CC=clang CXX=clang++ cargo pgrx install --release --pg-config `which pg_config`  
  
cd /tmp/VectorChord-bm25  
CC=clang CXX=clang++ cargo pgrx install --release --pg-config `which pg_config`  
  
cd /tmp/pgvectorscale/pgvectorscale  
CC=clang CXX=clang++ cargo pgrx install --release --pg-config `which pg_config`  
  
# 对于 x86_64 镜像仅需修改以下 arm -> amd  
mkdir -p /root/.duckdb/cli/1.4.1  
cd /tmp  
gunzip duckdb_cli-linux-arm64.gz  
chmod +x duckdb_cli-linux-arm64  
mv duckdb_cli-linux-arm64 /root/.duckdb/cli/1.4.1/duckdb  
rm -f /root/.duckdb/cli/latest  
ln -s /root/.duckdb/cli/1.4.1 /root/.duckdb/cli/latest  
echo "export PATH='/root/.duckdb/cli/latest':\$PATH" >> /root/.bashrc  
/root/.duckdb/cli/latest/duckdb -c "install duckpgq from community;"  
  
rm -rf /var/lib/apt/lists/*  
rm -rf /tmp/*  
```  
  
3、编写设置环境变量脚本  
  
root用户  
```  
vi ~/pg18/env_root.sh  
```  
  
脚本内容  
```  
#!/bin/bash  
# 配置root用户bash环境变量  
  
echo "alias ll='ls -larth'  
alias rm='rm -i'  
alias cp='cp -i'  
alias mv='mv -i'  
export PGUSER=postgres" >> /root/.bashrc  
  
rm -rf /root/env_root.sh  
```  
  
postgres用户(进入容器后, 以root用户手工运行一次即可)  
```  
vi ~/pg18/env_pg.sh  
```  
  
脚本内容  
```  
#!/bin/bash  
# 配置postgres用户bash环境变量  
echo "alias ll='ls -larth'  
alias rm='rm -i'  
alias cp='cp -i'  
alias mv='mv -i'" >> /var/lib/postgresql/.bash_profile  
  
chown postgres:postgres /var/lib/postgresql/.bash_profile  
rm -rf /root/env_pg.sh  
```  
  
  
4、编写Dockerfile  
  
```  
vi ~/pg18/Dockerfile  
```  
  
文件内容  
```  
FROM postgres:18-bookworm  
LABEL maintainer="Digoal Zhou <dege.zzz@alibaba-inc.com>"  
ARG TARGETPLATFORM  
ARG BUILDPLATFORM  
RUN echo "I am running on $BUILDPLATFORM, building for $TARGETPLATFORM"  
ENV DEBIAN_FRONTEND=noninteractive  
STOPSIGNAL SIGINT  
COPY --chmod=555 1.sh /tmp/  
COPY --chmod=500 env_root.sh env_pg.sh /root/  
COPY 18.tar.xz /tmp/  
  
RUN /tmp/1.sh  
RUN /root/env_root.sh  
```  
  
  
5、制作 docker 镜像  
  
```  
cd ~/pg18  
mkdir logs  
  
docker build --platform=linux/arm64 -t="digoal/pg18:arm64" --no-cache . 2>&1 | tee ./logs/build.log  
  
# build x86 Docker image 需修改如下, 以及 1.sh 里面 duckdb 的部分.  
# docker build --platform=linux/amd64 -t="digoal/pg18:amd64" --no-cache . 2>&1 | tee ./logs/build.log  
```  
  
仔细检查是否有错误并解决, 例如:  
```  
grep Error ./logs/build.log  
grep -i fail ./logs/build.log  
grep -i fatal ./logs/build.log  
grep ERROR ./logs/build.log  
grep "ERR\!" ./logs/build.log  
grep "E: " logs/build.log  
grep error ./logs/build.log | grep -v "\-Werror"  
```  
  
修复问题后, 可以使用 build 好的镜像启动容器测试.  
```  
rm -rf ~/pgdocker_data_test  
mkdir ~/pgdocker_data_test  
cd ~/pgdocker_data_test  
PG_DATA=`pwd`  
PG_USER="postgres"  
PG_PASSWORD="123456"  
PG_MAJOR="18"  
  
docker run -d -it -p 0.0.0.0:1922:5432 --add-host=host.docker.internal:host-gateway \
  -u root -w /var/lib/postgresql -e LANG=en_US.utf8 \
  -e POSTGRES_INITDB_ARGS="-E UTF8 --locale=C --lc-ctype=en_US.utf8" \
  -v $PG_DATA:/var/lib/postgresql \
  -e PGDATA=/var/lib/postgresql/$PG_MAJOR/docker \
  --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --shm-size=4g \
  -e POSTGRES_USER=$PG_USER -e POSTGRES_PASSWORD=$PG_PASSWORD \
  --name pg digoal/pg18:arm64  
  
docker exec -ti pg bash  
```  
  
6、推送镜像到阿里云个人镜像服务  
  
参考:  
- [《制作PolarDB | PostgreSQL 开源docker镜像, 集成大量插件方便学习, 并推送到阿里云镜像服务》](../202307/20230710_02.md)  
  
将镜像推送到 Registry 模版  
  
```  
docker login --username=dig***@126.com registry.cn-hangzhou.aliyuncs.com  
docker tag [ImageId] registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:[镜像版本号]  
docker push registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:[镜像版本号]  
```  
  
举例:  
```  
docker tag d9ed34ee3c95 registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg18_arm64  
docker push registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg18_arm64  
```  
  
7、拉取并使用上面的阿里云Docker image  
  
**ARM CPU使用如下镜像**  
  
拉取镜像不需要login  
```  
docker pull registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg18_arm64  
```  
  
使用该镜像举例  
```  
rm -rf ~/pgdocker_data_test  
mkdir ~/pgdocker_data_test  
cd ~/pgdocker_data_test  
PG_DATA=`pwd`  
PG_USER="postgres"  
PG_PASSWORD="123456"  
PG_MAJOR="18"  
  
docker run -d -it -p 0.0.0.0:1922:5432 --add-host=host.docker.internal:host-gateway \
  -u root -w /var/lib/postgresql -e LANG=en_US.utf8 \
  -e POSTGRES_INITDB_ARGS="-E UTF8 --locale=C --lc-ctype=en_US.utf8" \
  -v $PG_DATA:/var/lib/postgresql \
  -e PGDATA=/var/lib/postgresql/$PG_MAJOR/docker \
  --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --shm-size=4g \
  -e POSTGRES_USER=$PG_USER -e POSTGRES_PASSWORD=$PG_PASSWORD \
  --name pg registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg18_arm64  
  
docker exec -ti pg bash  
```  
  
------  
  
**X86_64 CPU使用如下镜像**  
  
拉取镜像不需要login  
```  
docker pull registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg18_amd64  
```  
  
使用该镜像举例  
```  
rm -rf ~/pgdocker_data_test  
mkdir ~/pgdocker_data_test  
cd ~/pgdocker_data_test  
PG_DATA=`pwd`  
PG_USER="postgres"  
PG_PASSWORD="123456"  
PG_MAJOR="18"  
  
docker run -d -it -p 0.0.0.0:1922:5432 --add-host=host.docker.internal:host-gateway \
  -u root -w /var/lib/postgresql -e LANG=en_US.utf8 \
  -e POSTGRES_INITDB_ARGS="-E UTF8 --locale=C --lc-ctype=en_US.utf8" \
  -v $PG_DATA:/var/lib/postgresql \
  -e PGDATA=/var/lib/postgresql/$PG_MAJOR/docker \
  --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --shm-size=4g \
  -e POSTGRES_USER=$PG_USER -e POSTGRES_PASSWORD=$PG_PASSWORD \
  --name pg registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg18_amd64  
  
docker exec -ti pg bash  
```

## 注意事项
1、一定要选择和使用和CPU架构相关的镜像. Intel/AMD都选择x86_64镜像. 苹果笔记本如果是M芯片, 选择ARM镜像.  
  
2、注意磁盘的剩余空间是否足够, 建议选择较大的盘来存储和运行容器. 根据需要更改命令中的目录路径.   
  
3、以上命令行都是macOS/Linux中可以直接运行的, 对于Windows PowerShell或cmd 命令行, 请使用AI转换一下再执行. 例如
````
请将以下命令转换为 Windows 终端可执行的命令

```  
rm -rf ~/pgdocker_data_test  
mkdir ~/pgdocker_data_test  
cd ~/pgdocker_data_test
# 根据需要修改以上目录和路径  

PG_DATA=`pwd`  
PG_USER="postgres"  
PG_PASSWORD="123456"  
PG_MAJOR="18"  
  
docker run -d -it -p 0.0.0.0:1922:5432 --add-host=host.docker.internal:host-gateway \
  -u root -w /var/lib/postgresql -e LANG=en_US.utf8 \
  -e POSTGRES_INITDB_ARGS="-E UTF8 --locale=C --lc-ctype=en_US.utf8" \
  -v $PG_DATA:/var/lib/postgresql \
  -e PGDATA=/var/lib/postgresql/$PG_MAJOR/docker \
  --cap-add=SYS_PTRACE --cap-add SYS_ADMIN --privileged=true --shm-size=4g \
  -e POSTGRES_USER=$PG_USER -e POSTGRES_PASSWORD=$PG_PASSWORD \
  --name pg registry.cn-hangzhou.aliyuncs.com/digoal/opensource_database:pg18_amd64  
  
docker exec -ti pg bash  
```
````
  
  
  
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")  
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")  
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")  
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")  
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")  
  
  
