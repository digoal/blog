## 跟着 ParadeDB 学 AI 搜索: 8 什么是分面搜索 (Faceted Search)?  
    
### 作者    
digoal    
    
### 日期    
2025-12-08    
    
### 标签    
PostgreSQL , 搜索 , paradedb , tantivy , 语义搜索 , 关键词搜索 , ranking , 混合搜索 , RAG , RRF    
    
----    
    
## 背景    
看完 paradedb 的文档 , 我知道它也在朝着 AI 搜索数据库的方向发展.    
    
AI 搜索, 目前的共识需求是: 语义搜索 , 关键词搜索 , 标量搜索 , 混合搜索! ( 个人认为应该还要加上 图、GIS等多模态功能 )    
    
目前围绕AI 搜索需求在做的产品, 我大概总结一下:    
- PG 的插件: vectorchord + vectorchord-bm25 + pg_tokenizer    
- PG 商业发行版: 海量 vastbase 向量版、vexdb    
- PG 的插件(本文主角): paradedb    
- OceanBase SeekDB.    
- DuckDB: vss + fts    
    
好的, 话不多说, 下面就跟着 ParadeDB 文档来体系化学习一下AI 搜索    
    
https://www.paradedb.com/learn    
    
## 什么是分面搜索 (Faceted Search)?  
  
| 英文术语 (Original Term) | 中文翻译 (Translation) |  
| :--- | :--- |  
| **Faceted Search / Faceting** | 分面搜索 / 分面 |  
| **Full-Text Search** | 全文搜索 |  
| **Facet / Facet Value** | 分面 / 分面值 |  
| **Interactive Filtering** | 交互式过滤 |  
| **Aggregation** | 聚合 |  
| **Index Pass / Index Scan** | 索引遍历 / 索引扫描 |  
| **Columnar / Bitmap-based** | 列式 / 基于位图 |  
| **Ordinal** | 序号 |  
| **Top-N Search** | Top-N 搜索 |  
  
**分面搜索（Faceted search）** ，也称为**分面（faceting）** ，是一种[搜索技术](https://en.wikipedia.org/wiki/Faceted_search)，它将**全文搜索（full-text search）** 结果组织成可过滤的类别，即**分面（facets）** 。每个分面代表数据的一个属性（例如颜色、品牌或价格范围），并允许用户通过同时选择多个值来缩小大型结果集。它是**电子商务（e-commerce）** 、文档搜索和分析平台中 **交互式过滤（interactive filtering）** 的基础。  
  
PS: 看到这里我的第一反应是, 这能不能通过大模型或机器学习的归类功能来实现? 或者说打标签? 然后将标签数字化(通过字典表), 最后将标签和向量进行混合构建索引. 这也是我们看到pgvectorscale/vectorchord插件提供的功能, 还有国产数据库vastbase/vexdb也支持.    
- [《pgvectorscale 源码学习: 7 Label-Based Filtering (基于标签的过滤)》](../202511/20251111_16.md)    
- [《VexDB HybridAnn 向量标量混合索引原理与实践》](../202510/20251011_06.md)    
  
但 paradedb 的分面概念似乎不是在索引中额外存储一个label, 而是记录本身就拥有其他字段, 在返回结果时(使用语义/全文检索搜索), 同时再对其他字段进行聚合(使用窗口函数)得到分面结果.   
  
分面是一个有趣的问题，因为它理论上可以在客户端或通过多个查询计算，但搜索响应通常需要快速。这意味着分面通常需要在产生搜索结果的同一查询中，通过单次 **索引遍历（index pass）** 高效计算。  
  
## 什么是分面 (Facet)?  
  
在数学上，分面（facet）是多面体的一个面。在计算机科学中，分面描述了有关对象的信息如何按属性或特征进行组织和分组。一个**分面**指的是数据的类别或维度（例如，颜色），而一个 **分面值（facet value）** 代表该类别中的一个特定选项（例如，棕色或蓝色）。  
  
每个**分面值**都附带一个整数，表示属于该值的已过滤项目的数量。例如，一个分面可能表示如下：  
  
```  
brown(10);  
blue(7);  
white(4);  
```  
  
分面是累加性的：用户可以勾选多个分面值（例如“棕色鞋子”和“便宜的鞋子”）来缩小搜索结果。分面可以对值集合进行分类（例如 `brown`、`blue`、`white` 等），也可以对范围桶进行分类（例如 `$0 到 $99`、`$100 到 $999`、`$1,000 以上` 等）。  
  
在实践中，分面与 **Top-N 搜索（Top-N searches）** 一同出现。在显示前 N 个结果的同时显示分面计数，使用户能够立即进行精炼、一目了然地了解分布情况，并避免额外的往返（round-trips）。在同一次遍历中执行排名和**聚合（aggregation）** 可以保持低延迟，并且延迟与匹配项成比例，而不是与文档总集相关。  
  
## 分面搜索的实现 (Faceted Search Implementations)  
  
在小规模情况下，分面搜索可以在客户端或通过简单的 SQL 查询计算。例如，一个 Web 应用程序可以获取所有匹配的记录并在 JavaScript 中计算分面计数，或在 SQL 中运行一些 `GROUP BY` 查询。但是，随着数据集的增长，这两种方法都会崩溃。  
  
**客户端实现（client-side implementation）** 要求将每个匹配的记录传输到客户端，以便在本地计算计数。即使是一个返回数万个结果的普通搜索，也会很快变得难以处理。  
  
**简单的 SQL 实现（naïve SQL implementation）** 需要在同一数据上进行多次遍历，首先运行搜索查询，然后在返回前 N 条记录之前对完整结果集运行分面计算。  
  
在生产系统中，分面通常与搜索查询本身同步执行。搜索引擎不会运行单独的聚合查询，而是在检索匹配文档的同一次 **索引扫描（index scan）** 中计算分面计数。像 Elasticsearch、Solr 和 ParadeDB 这样的搜索数据库和搜索引擎通过维护辅助数据结构（通常是**列式（columnar）** 或**基于位图（bitmap-based）** 的）来实现这一点，这些结构允许在不重新读取所有文档的情况下聚合类别计数。每个分面值被映射到一个紧凑的整数**序号（ordinal）** 或位集（bitset） ，因此计数可以在查询执行路径中作为内存计算的一部分。  
  
即使当前查询有限制，分面搜索也会对整个结果集进行操作。即使只显示了少数文档，分面计数也必须反映所有匹配的文档。因为无法预测用户将应用哪种过滤器组合，所以分面不能预先计算。相反，索引的组织方式使得这些聚合可以在单次 **索引遍历（index pass）** 中高效地（通常在对数时间内）计算。  
  
## 分面搜索示例 (Faceted Search Examples)  
  
在 Elasticsearch 中，用户可以使用[聚合 API（aggregations API）](https://www.elastic.co/docs/reference/aggregations)在搜索查询的同时执行分面计算：  
  
```json  
POST /products/_search  
{  
  "size": 10,  
  "query": {  
    "multi_match": {  
      "query": "wireless headphones",  
      "fields": ["title", "description"]  
    }  
  },  
  "aggs": {  
    "price_histogram": {  
      "histogram": {  
        "field": "price",  
        "interval": 50  
      }  
    }  
  }  
}  
```  
  
在 ParadeDB 中，可以使用 `pdb.agg` 函数作为窗口函数实现相同的功能。  
  
```sql  
SELECT  
  *,  
  pdb.score(id) AS bm25_score,  
  pdb.agg('{"histogram": { "field": price, "interval": 50 }}') OVER () AS facets  
FROM products  
WHERE  
  title       ||| 'wireless headphones' OR  
  description ||| 'wireless headphones'  
ORDER BY bm25_score  
LIMIT 10  
```  
  
## 分面查询的常见用例是什么？ (What are Common Use Cases for Faceting?)  
  
每当用户需要探索和过滤大型数据集同时保持搜索相关性时，分面就变得至关重要。关键场景可分为以下几类：  
  
### 电子商务和产品发现 (E-commerce and Product Discovery)  
  
像亚马逊和 Wayfair 这样的电子商务平台是最明显的例子，但这种模式超越了零售业。用户在搜索数千种产品时，需要通过品牌、价格范围、客户评分和可用性来快速缩小结果。分面允许**探索性浏览（exploratory browsing）** —— 用户可以从“笔记本电脑”这样的广义搜索开始，然后逐步通过处理器类型、屏幕尺寸和预算进行精炼，而不会失去其原始查询的相关性排名。  
  
### 内容和知识管理 (Content and Knowledge Management)  
  
拥有大型内容存储库的组织面临着类似的挑战。支持人员搜索 50,000 张帮助工单时，需要按产品领域、严重性级别和日期范围进行过滤，同时保持其关键字搜索的相关性。像 Confluence 这样的文档平台允许用户在按团队所有权、文档类型或上次修改日期过滤的同时找到相关文章。如果没有分面，用户要么得到压倒性的结果集，要么通过切换到纯粹的分类浏览而失去重要的上下文。  
  
### 分析和数据探索 (Analytics and Data Exploration)  
  
像 PostHog 或 Mixpanel 这样的分析平台使用户能够同时搜索和过滤跨多个维度的事件数据。产品经理在调查用户行为时，可以搜索特定操作，同时按设备类型、地理区域和会话长度进行分面。搜索相关性与维度过滤的结合，使得有针对性的调查和 **意外发现（serendipitous discovery）** 都成为可能。  
  
### 专业搜索应用 (Specialized Search Applications)  
  
像领英（LinkedIn）这样的招聘平台在人才搜索中展示了分面，招聘人员需要找到与职位描述匹配的候选人，同时按地点、经验水平和特定技能进行过滤。法律研究平台允许律师在按管辖区、日期范围和法律领域过滤的同时搜索判例法。房地产平台允许买家在按价格、位置和便利设施过滤的同时搜索房产。  
  
在所有这些情况下，分面解决了信息过载的根本问题：如何在保持全文搜索的强大功能的同时，为用户提供直观的方式来导航大型结果集。  
  
## 总结 (Summary)  
  
**分面搜索**将搜索结果组织成称为 **分面（facets）** 的可过滤类别，允许用户通过选择颜色、价格或其他特性等特定属性来缩小结果范围。  
  
分面搜索在像 ParadeDB 或 Elasticsearch 这样的搜索优先解决方案中是原生可用的。  
      
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
