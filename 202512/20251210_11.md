## 大学生数据库实践课: 3 pgbench 工具使用   
    
### 作者    
digoal    
    
### 日期    
2025-12-10    
    
### 标签    
PostgreSQL , DuckDB , 语义搜索 , 向量搜索 , 关键词检索 , 全文检索 , 标量检索 , 混合搜索 , 多模态搜索 , 重排序 , embedding , document split , ORC , 大模型 , 多模态大模型 , Dify , 压力测试 , 索引优化 , 倒排向量索引 , Ivfflat , 图向量索引 , HNSW , DiskANN , 量化 , rabitq , sbq , 二值量化 , bm25 , 相关性 , 相似性 , 召回率 , pgbench , 数据集 , ann-benchmarks , 图搜索 , PGQ , 递归 , 深度优先 , 广度优先 , 最短路径 , N度关系 , LLM , Ollama    
    
----    
    
## 背景    
  
https://deepwiki.com/search/pgbenchpostgresql_56581b69-614b-4061-83ef-8d7f50f01c5b?mode=fast  
  
给出使用pgbench压测postgresql数据库的范例;    
    
https://deepwiki.com/search/pgbenchpostgresql_56581b69-614b-4061-83ef-8d7f50f01c5b?mode=fast  
  
给出使用自定义sql对PostgreSQL进行压测的示例, 注意要包含详细步骤如: “设计压测用例, 创建表和索引, 创建压测函数(如有), 生成测试数据(如有), 编写测试脚本, 使用pgbench进行压测”;    
  
-----  
  
# pgbench 压测 PostgreSQL 数据库范例  
  
## 基本使用流程  
  
### 1. 初始化测试数据  
```bash  
pgbench -i [dbname]  
```  
使用 `-i` 选项初始化数据库，创建四个标准表：`pgbench_accounts`、`pgbench_branches`、`pgbench_history` 和 `pgbench_tellers` 。  
  
### 2. 运行基准测试  
```bash  
pgbench -c 10 -j 2 -t 1000 [dbname]  
```  
- `-c 10`: 10个并发客户端    
- `-j 2`: 2个工作线程    
- `-t 1000`: 每个客户端运行1000个事务    
  
## 常用测试场景  
  
### 简单性能测试  
```bash  
# 初始化（缩放因子为50）  
pgbench -i -s 50 testdb  
  
# 运行5分钟的测试  
pgbench -c 20 -j 4 -T 300 testdb  
```  
`-s` 选项设置缩放因子，影响数据量大小  。`-T` 选项指定测试持续时间（秒）  。  
  
### 只读测试  
```bash  
pgbench -c 10 -j 2 -t 1000 -S testdb  
```  
`-S` 选项执行只读事务（等同于 `-b select-only`）  。  
  
### 简单更新测试  
```bash  
pgbench -c 10 -j 2 -t 1000 -N testdb  
```  
`-N` 选项跳过对 `pgbench_tellers` 和 `pgbench_branches` 的更新（等同于 `-b simple-update`）  。  
  
### 限速测试  
```bash  
pgbench -c 10 -j 2 -T 60 --rate=1000 testdb  
```  
`--rate` 选项限制目标TPS为1000  。  
  
## 高级选项  
  
### 自定义脚本  
```bash  
pgbench -c 5 -j 1 -t 100 -f custom_script.sql testdb  
```  
`-f` 选项指定自定义脚本文件  。  
  
### 详细报告  
```bash  
pgbench -c 10 -j 2 -t 1000 -r -l testdb  
```  
- `-r`: 报告每个命令的延迟    
- `-l`: 将事务时间写入日志文件    
  
## 实际测试示例  
  
从测试文件中可以看到完整的使用流程  ：  
  
```bash  
# 初始化  
pgbench -i testdb  
  
# 运行测试  
pgbench -c10 -t300 testdb  
```  
  
## 注意事项  
  
1. 初始化会删除同名的现有表，请谨慎使用    
2. 为获得有意义的结果，测试应至少运行几分钟    
3. 缩放因子应至少等于客户端数，以避免更新争用    
  
## Notes  
  
- pgbench 是 PostgreSQL 自带的基准测试工具  
- 默认测试场景基于 TPC-B，包含 SELECT、UPDATE 和 INSERT 操作  
- 可以通过环境变量 PGOPTIONS 设置额外的 PostgreSQL 参数  
- 测试结果包含 TPS（每秒事务数）和延迟统计信息  
  
  
-----  
  
  
# 使用自定义SQL对PostgreSQL进行压测的完整示例  
  
## 1. 设计压测用例  
  
假设我们要测试一个电商系统的订单处理场景，包含以下操作：  
- 查询商品信息  
- 创建订单  
- 更新库存  
- 查询订单状态  
  
## 2. 创建表和索引  
  
```sql  
-- 商品表  
CREATE TABLE products (  
    id SERIAL PRIMARY KEY,  
    name VARCHAR(100) NOT NULL,  
    price DECIMAL(10,2) NOT NULL,  
    stock INTEGER NOT NULL DEFAULT 0,  
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP  
);  
  
-- 订单表  
CREATE TABLE orders (  
    id SERIAL PRIMARY KEY,  
    product_id INTEGER REFERENCES products(id),  
    quantity INTEGER NOT NULL,  
    total_price DECIMAL(10,2) NOT NULL,  
    status VARCHAR(20) NOT NULL DEFAULT 'pending',  
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP  
);  
  
-- 创建索引  
CREATE INDEX idx_orders_product_id ON orders(product_id);  
CREATE INDEX idx_orders_status ON orders(status);  
CREATE INDEX idx_products_stock ON products(stock);  
```  
  
## 3. 创建压测函数（可选）  
  
```sql  
-- 获取随机商品ID的函数  
CREATE OR REPLACE FUNCTION get_random_product()   
RETURNS INTEGER AS $$  
DECLARE  
    product_id INTEGER;  
BEGIN  
    SELECT id INTO product_id   
    FROM products   
    WHERE stock > 0   
    ORDER BY RANDOM()   -- 思考: 会不会有性能问题? 如何解决?   
    LIMIT 1;  
    RETURN product_id;  
END;  
$$ LANGUAGE plpgsql;  
```  
  
## 4. 生成测试数据  
  
```sql  
-- 生成10000个商品  
INSERT INTO products (name, price, stock)  
SELECT   
    'Product ' || i,  
    ROUND((RANDOM() * 1000 + 10)::NUMERIC, 2),  
    FLOOR(RANDOM() * 1000 + 10)::INTEGER  
FROM generate_series(1, 10000) i;  
  
-- 更新统计信息  
ANALYZE products;  
ANALYZE orders;  
```  
  
## 5. 编写测试脚本  
  
创建 `ecommerce_test.sql` 文件：  
  
```sql  
-- 设置变量  
\set pid random(1, 10000)  
\set qty random(1, 10)  
\set aid random(1, 100000)  
  
-- 开始事务  
BEGIN;  
  
-- 1. 查询商品信息  
SELECT id, name, price, stock   
FROM products   
WHERE id = :pid;  
  
-- 2. 检查库存并创建订单  
INSERT INTO orders (product_id, quantity, total_price, status)  
SELECT :pid, :qty, price * :qty, 'confirmed'  
FROM products   
WHERE id = :pid AND stock >= :qty;  
  
-- 3. 更新库存  
UPDATE products   
SET stock = stock - :qty   
WHERE id = :pid AND stock >= :qty;  
  
-- 4. 查询订单状态  
SELECT id, product_id, quantity, total_price, status   
FROM orders   
WHERE id = (  
    SELECT id FROM orders   
    ORDER BY created_at DESC   
    LIMIT 1  
);  
  
-- 提交事务  
COMMIT;  
```  
  
## 6. 使用pgbench进行压测  
  
### 基本压测命令  
  
```bash  
# 使用自定义脚本进行压测  
pgbench -c 20 -j 4 -t 1000 -f ecommerce_test.sql testdb  
```  
  
参数说明：  
- `-c 20`: 20个并发客户端    
- `-j 4`: 4个工作线程    
- `-t 1000`: 每个客户端运行1000个事务    
- `-f ecommerce_test.sql`: 使用自定义脚本文件    
  
### 高级压测选项  
  
```bash  
# 限速压测（目标TPS为500）  
pgbench -c 20 -j 4 -T 300 --rate=500 -f ecommerce_test.sql testdb  
  
# 包含详细报告的压测  
pgbench -c 20 -j 4 -t 1000 -r -l -f ecommerce_test.sql testdb  
  
# 使用prepared协议  
pgbench -c 20 -j 4 -t 1000 -M prepared -f ecommerce_test.sql testdb  
```  
  
## 实际测试示例参考  
  
从pgbench的测试文件中可以看到自定义脚本的实际使用方式：  
  
```sql  
-- select only  
\set aid random(1, :scale * 100000)  
SELECT abalance::INTEGER AS balance  
  FROM pgbench_accounts  
  WHERE aid=:aid;  
```  
  
## 脚本语法说明  
  
pgbench自定义脚本支持以下特性：  
- SQL命令以分号分隔  
- 支持变量替换（使用`:variablename`语法）  
- 支持元命令（以`\`开头）  
- 自动变量如`:scale`、`:client_id`等  
  
## 注意事项  
  
1. 使用自定义脚本时需要添加`-n`选项跳过vacuum  
2. 确保脚本中的SQL语法正确，否则会导致事务失败  
3. 使用`-r`选项可以查看每个命令的详细延迟统计  
4. 测试前建议先运行少量事务验证脚本正确性  
  
## Notes  
  
- pgbench自定义脚本提供了强大的灵活性，可以模拟各种业务场景  
- 脚本中的变量作用域为每个客户端会话独立  
- 可以使用多个脚本文件并设置权重来模拟不同业务比例  
- 测试结果会显示TPS、平均延迟等关键性能指标  
    
#### [PolarDB 学习图谱](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL 解决方案集合](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [德哥 / digoal's Github - 公益是一辈子的事.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About 德哥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
