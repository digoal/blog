## å¤åˆ»äººç±»å¼€å‘è€…  
      
### ä½œè€…      
digoal      
      
### æ—¥æœŸ      
2025-12-13      
      
### æ ‡ç­¾      
PostgreSQL , äººç±»å¼€å‘è€… , Xata , AI Agent    
      
----      
      
## èƒŒæ™¯      
å¦‚ä½•è®©AI Agentåƒäººç±»å¼€å‘è€…ä¸€æ ·å·¥ä½œ?  
  
Xata æ­£åœ¨è¿™ä¹ˆå¹², ä»–ä»¬å‡†å¤‡ç”¨AI Agentå¤åˆ»äººç±»å¼€å‘è€…. æ„å»ºä¸€ä¸ª AI ç¼–ç ä»£ç† (AI coding agent)ï¼Œè¯¥ä»£ç†èƒ½å¤Ÿæ¨¡ä»¿äººç±»å¼€å‘è€…çš„å®Œæ•´å·¥ä½œæµç¨‹ (full developer workflow)ï¼Œä»¥åœ¨åº”ç”¨ä»£ç åº“ä¸­å®ç°åŠŸèƒ½æˆ–ä¿®å¤é”™è¯¯.  
  
**å…³é”®ç‚¹ï¼š**  
  
1.  **AI ä»£ç† (AI Agent)** ï¼šXata æ„å»ºçš„ä»£ç†ï¼ˆåŸºäº **LLMs**ï¼‰å¯ä»¥æ¥æ”¶ä»»åŠ¡ï¼ˆä¾‹å¦‚ä¸€ä¸ª GitHub Issue çš„æè¿°ï¼‰ã€‚  
2.  **å®Œæ•´å·¥ä½œæµç¨‹ (Full Workflow)** ï¼šè¯¥ä»£ç†å¯ä»¥**è‡ªä¸»åœ°** (autonomously) å®Œæˆå¼€å‘ä»»åŠ¡çš„æ•´ä¸ªæµç¨‹ï¼š  
    * å…‹éš†ä»£ç åˆ°**æ²™ç®±** (sandbox)ã€‚  
    * ä¸ºä»»åŠ¡åˆ›å»º **Git åˆ†æ”¯**ã€‚  
    * æœ€é‡è¦çš„ä¸€ç‚¹ï¼šä¸ºè¿™ä¸ªæ–°åŠŸèƒ½æˆ– Bug ä¿®å¤åˆ›å»ºä¸€ä¸ª **Xata æ•°æ®åº“é¢„è§ˆåˆ†æ”¯ (preview database branch)** ã€‚  
    * åœ¨æ²™ç®±ä¸­ä¿®æ”¹**åº”ç”¨ä»£ç ** (application code) å’Œ**æ•°æ®åº“æ¨¡å¼** (database schema)ã€‚  
    * è¿è¡Œæ•°æ®åº“**è¿ç§»** (migrations)ï¼Œå¹¶åœ¨è¯¥**é¢„è§ˆåˆ†æ”¯**ä¸Šè¿›è¡Œæµ‹è¯•ã€‚  
    * é€šè¿‡ **commit** å°†æ›´æ”¹æ¨é€åˆ° **PR (æ‹‰å–è¯·æ±‚)** ã€‚  
3.  **Postgres åˆ†æ”¯çš„ä½œç”¨**ï¼šä»£ç†ä½¿ç”¨ **Xata çš„æ•°æ®åº“åˆ†æ”¯åŠŸèƒ½**ï¼Œå³**Postgres åˆ†æ”¯ (Postgres branches)** ï¼Œæ¥ä¸º**æ‹‰å–è¯·æ±‚ (PR)** åˆ›å»ºä¸€ä¸ª**ä¸ç”Ÿäº§æ•°æ®ç»“æ„ä¸€è‡´**ã€ä½†**å®‰å…¨ä¸”éš”ç¦»**çš„æ•°æ®åº“ç¯å¢ƒã€‚è¿™ä¸ªç¯å¢ƒç”¨äº**éªŒè¯**ä»£ç†æ‰€åšçš„**åº”ç”¨ä»£ç æ›´æ”¹**å’Œ**æ•°æ®åº“æ¨¡å¼æ›´æ”¹**æ˜¯å¦æœ‰æ•ˆï¼Œè€Œ**ä¸æ˜¯**ç”¨äºéªŒè¯ PostgreSQL **å†…æ ¸ä»£ç **çš„å¼€å‘æ•ˆæœã€‚  
  
AI ä»£ç†ä½¿ç”¨ **Xata åˆ›å»ºçš„â€œé¢„è§ˆæ•°æ®åº“åˆ†æ”¯â€ (preview database branch)** æ¥éªŒè¯æ•ˆæœã€‚è¿™ä¸ªé¢„è§ˆåˆ†æ”¯æ˜¯**éš”ç¦»**ä¸” **PII å®‰å…¨ (PII safe)** çš„ï¼Œå®ƒåŸºäºç”Ÿäº§å®ä¾‹ï¼Œä½†**ä¸æ˜¯ç”Ÿäº§å®ä¾‹æœ¬èº«**ã€‚å®ƒæ˜¯åœ¨ä¸€ä¸ª**æ²™ç®±ç¯å¢ƒ (sandbox environment)** ä¸­è¿è¡Œå’Œæµ‹è¯•çš„ï¼Œè¿™æ­£æ˜¯ä¸ºäº†é¿å…ç›´æ¥åœ¨ç”¨æˆ·çš„**ç”Ÿäº§ç¯å¢ƒ (production environment)** ä¸Šè¿›è¡ŒéªŒè¯ã€‚  
  
æ ¸å¿ƒæœ¯è¯­  
  
| æœ¯è¯­ (åŸæ–‡) | ç¿»è¯‘ (è¯‘æ–‡) | æ–‡ç« ä¸­çš„ä½œç”¨ |  
| :--- | :--- | :--- |  
| **AI Coding Agent** | AI ç¼–ç ä»£ç† | æ¥æ”¶ä»»åŠ¡ï¼Œè‡ªä¸»ç¼–å†™ä»£ç å’Œæ‰§è¡Œæ•´ä¸ªå¼€å‘æµç¨‹çš„ AI åŠ©æ‰‹ã€‚ |  
| **Postgres Branches** | Postgres åˆ†æ”¯ | Xata æä¾›çš„æ•°æ®åº“åŠŸèƒ½ï¼Œç”¨äºä¸ºæ¯ä¸ª PR æˆ–ä»»åŠ¡åˆ›å»º**éš”ç¦»ã€ä¸´æ—¶çš„æ•°æ®åº“å‰¯æœ¬**ï¼Œä»¥ä¾›ä»£ç†åœ¨**æ²™ç®±**ä¸­å®‰å…¨åœ°æµ‹è¯•æ›´æ”¹ã€‚ |  
| **Developer Workflow** | å¼€å‘è€…å·¥ä½œæµç¨‹ | ä»£ç†æ‰€æ¨¡ä»¿çš„æ­¥éª¤åºåˆ—ï¼šåˆ›å»ºåˆ†æ”¯ -> è·å–æ•°æ® -> ä¿®å¤ä»£ç  -> è¿è¡Œè¿ç§» -> æäº¤ PRã€‚ |  
| **Sandbox** | æ²™ç®± | ä¸€ä¸ª**éš”ç¦»**çš„ç¯å¢ƒï¼Œä»£ç†å¯ä»¥åœ¨å…¶ä¸­**å®‰å…¨åœ°æ‰§è¡Œä»£ç ** (run code)ï¼Œè¿è¡Œæµ‹è¯•å’Œè¿ç§»ï¼Œè€Œä¸ä¼šå½±å“ç”Ÿäº§ç¯å¢ƒã€‚ |  
  
Xata çš„ç›®æ ‡æ˜¯**è‡ªåŠ¨åŒ–åº”ç”¨å±‚é¢çš„å¼€å‘å’Œè¿ç»´ (DevOps)** ï¼Œè€Œä¸æ˜¯å‚ä¸åˆ° PostgreSQL å†…æ ¸çš„å¼€å‘ä¸­ã€‚  
  
ä»¥ä¸‹å†…å®¹æ¥è‡ª: https://xata.io/blog/a-coding-agent-that-uses-postgres-branches  
  
  
## é—­ç¯ï¼šæ„å»ºä¸€ä¸ªä½¿ç”¨ Postgres åˆ†æ”¯ (Postgres branches) çš„ç¼–ç ä»£ç† (coding agent)  
  
**æ‘˜è¦:** æ¢ç´¢å¦‚ä½•æ„å»ºä¸€ä¸ªéµå¾ªå®Œæ•´**å¼€å‘è€…å·¥ä½œæµç¨‹** (developer workflow) çš„ AI ç¼–ç ä»£ç† (AI coding agent)ï¼ŒåŒ…æ‹¬ä½¿ç”¨ Xataã€Vercel å’Œ GitHub åˆ›å»º **Postgres åˆ†æ”¯** (Postgres branches)ã€ä½¿ç”¨**æ²™ç®±** (sandbox)ã€ä¿®å¤é”™è¯¯ä»¥åŠå‘èµ·**æ‹‰å–è¯·æ±‚** (pull requests)ã€‚  
  
**ä½œè€…:** Divyendu Singh  
  
æˆ‘æœ€è¿‘åœ¨æŸæ— PostgreSQL **è§é¢ä¼š** (meetup) ä¸Šå±•ç¤ºäº† **Xata Agent**ï¼Œå±•ç¤ºäº†æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ Xata Agent åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ç®¡ç†å’Œè°ƒæ•´ä¸€é˜Ÿ PostgreSQL å®ä¾‹ã€‚ä»¥ä¸‹æ˜¯å›é¡¾ã€‚  
  
ç®€è€Œè¨€ä¹‹ï¼š  
  
**Xata Agent** æ˜¯ä¸€ä¸ª**å¼€æºä»£ç†** (open source agent)ï¼Œå®ƒç›‘æ§æ‚¨çš„æ•°æ®åº“ï¼Œæ‰¾åˆ°é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼Œå¹¶æå‡ºä¿®å¤å’Œæ”¹è¿›å»ºè®®ã€‚å®ƒå°±åƒæ‚¨çš„å›¢é˜Ÿä¸­æ¥äº†ä¸€ä½æ–°çš„ **SRE**ï¼ˆ**ç«™ç‚¹å¯é æ€§å·¥ç¨‹å¸ˆ**ï¼‰æ–°äººï¼Œä¸€ä½åœ¨ **Postgres** æ–¹é¢æ‹¥æœ‰ä¸°å¯Œç»éªŒçš„æ–°äººã€‚  
  
åœ¨è§é¢ä¼šä¹‹åï¼Œä¸€ä¸ªå¤šæ¬¡è¢«æå‡ºçš„é—®é¢˜æ˜¯å…³äºå¦‚ä½•è®©ä»£ç†ä¹Ÿâ€œçœ‹åˆ°â€ä»£ç ï¼ˆé™¤äº† **PostgreSQL æ—¥å¿—å’Œç»Ÿè®¡æ•°æ®**ï¼‰ï¼Œä»è€Œä¸ºä»£ç†**è‡ªä¸»** (autonomously) è§£å†³é—®é¢˜æˆ–åœ¨è§£å†³é—®é¢˜æ–¹é¢èµ°å¾—æ›´è¿œï¼Œå®ç°â€œ**é—­ç¯**â€ (**closing the loop**)ã€‚  
  
è¿™ä¿ƒä½¿æˆ‘ä»¬æ¢ç´¢ï¼Œå¦‚æœè®©ä¸€ä¸ª **AI ä»£ç†** (**AI agent**) è®¿é—®ä»£ç å’ŒçœŸå®æ•°æ®ï¼ˆé€šè¿‡**æ•°æ®åº“åˆ†æ”¯** (**database branching**)ï¼‰ï¼Œæ‹¥æœ‰åœ¨**æ²™ç®±** (**sandbox**) ä¸­è¿è¡Œä»£ç çš„èƒ½åŠ›ï¼Œä»¥åŠ**æäº¤** (**commit**) æ›´æ”¹åˆ° **PR**ï¼ˆ**æ‹‰å–è¯·æ±‚**ï¼‰çš„èƒ½åŠ›ï¼Œä¼šæ˜¯ä»€ä¹ˆæ ·å­ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œè¿™æ„å‘³ç€ä¸ºä»£ç†æä¾›ä¸å¼€å‘è€…åœ¨æ„å»ºåŠŸèƒ½æˆ–ä¿®å¤é”™è¯¯æ—¶ä½¿ç”¨çš„ç›¸åŒå·¥å…·çš„è®¿é—®æƒé™ã€‚  
  
åœ¨è¿™ç¯‡åšå®¢æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å±•ç¤ºäº†ä½¿ç”¨**è‡ªå®šä¹‰ä»£ç†** (**custom agent**) ä»¥åŠå…è®¸å…¶ä¸ **GitHub**ã€**Sandbox** å’Œ **Xata åˆ†æ”¯** (**Xata branches**) äº¤äº’çš„å·¥å…·çš„å·¥ä½œæµç¨‹ï¼Œä½†ä¹Ÿå¯ä»¥ä½¿ç”¨ç°æœ‰å·¥ä½œæµç¨‹ï¼ˆå¦‚ `claude`ã€`gh` å’Œ `xata CLIs`ï¼Œå³**å‘½ä»¤è¡Œç•Œé¢**ï¼‰æ¥å®ç°ç›¸åŒçš„ç›®æ ‡ã€‚æˆ‘ä»¬å°†åœ¨æœªæ¥çš„åšå®¢æ–‡ç« ä¸­ä»‹ç»è¿™ç§æ–¹æ³•ã€‚  
  
-----  
  
## æ¼”ç¤ºï¼Œåˆå â€œè®©æˆ‘çœ‹çœ‹ä½ çš„æœ¬äº‹â€ (Demo aka â€œshow me what you gotâ€)  
  
æˆ‘å¯ä»¥å¬åˆ°ä½ ä»¬ä¸­çš„ä¸€äº›äººå·²ç»åœ¨è¯´ â€œè®©æˆ‘çœ‹çœ‹ä½ çš„æœ¬äº‹â€  
ï¼ˆæ¥è‡ªã€Šç‘å…‹å’Œè«è’‚ã€‹çš„ â€œShow me what you gotâ€ï¼‰  
  
![pic](20251213_05_pic_001.webp)  
  
è¿™é‡Œæœ‰ä¸€ä¸ª 3 åˆ†é’Ÿçš„æ¼”ç¤ºæ¥å±•ç¤ºæˆ‘çš„æ„æ€ï¼š  
  
åœ¨æ¼”ç¤ºä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°ä»£ç†èƒ½å¤Ÿ**å…‹éš†** (**clone**) ä»“åº“åˆ°**æ²™ç®±** (**sandbox**) ä¸­ï¼Œå°†**ç¯å¢ƒå˜é‡** (**environment variables**) ä¸­çš„**æ•°æ®åº“ URL** (**database URL**) æ›´æ”¹ä¸ºä¸ºè¯¥ **PR** åˆ›å»ºçš„ **Xata åˆ†æ”¯**ï¼Œå¹¶ä»…æ ¹æ®**é—®é¢˜æè¿°** (**issue description**) **è‡ªä¸»** (**autonomously**) å®ç°è¯¥åŠŸèƒ½ã€‚  
  
ç”±äºæˆ‘ä»¬ä½¿ç”¨ **PR** ä½œä¸ºäº¤äº’ç‚¹ï¼Œäººç±»å¼€å‘è€…å¯ä»¥**æ£€å‡º** (**checkout**) è¯¥ **PR** å¹¶ä¸ **AI ä»£ç†**ä¸€èµ·è´¡çŒ®ã€‚  
  
-----  
  
## å·¥ä½œæµç¨‹ (The Workflow)  
  
å¦‚æœä¸€ä¸ªå¼€å‘è€…å¿…é¡»æ„å»ºä¸€ä¸ªåŠŸèƒ½æˆ–ä¿®å¤ä¸€ä¸ªé”™è¯¯ï¼Œé€šå¸¸æ¶‰åŠéµå¾ªä¸€äº›å›ºå®šçš„äº‹ä»¶åºåˆ—ï¼Œä¾‹å¦‚ï¼š  
  
1.  åˆ›å»ºä¸€ä¸ª **Git åˆ†æ”¯** (git branch)  
2.  ä»**ç”Ÿäº§æ•°æ®åº“** (**production database**) è·å–è¶³å¤Ÿçš„æ•°æ®æˆ–**æ’­ç§** (**seed**) æ•°æ®ï¼Œä»¥ä¾¿èƒ½å¤Ÿ**é‡ç°é—®é¢˜** (**reproduce the issue**)  
3.  **é‡ç°é—®é¢˜**  
4.  å¯¹é—®é¢˜å¯èƒ½å­˜åœ¨çš„ä½ç½®è¿›è¡Œ**å‡è®¾** (**hypothesis**)ï¼ˆé€šè¿‡é˜…è¯»ä»£ç ï¼‰  
5.  ä¿®å¤é—®é¢˜å¹¶å‘èµ·ä¸€ä¸ª **PR**  
6.  æŸ¥çœ‹**æµ‹è¯•** (**tests**) / **CI** (**æŒç»­é›†æˆ**) é€šè¿‡ï¼Œè·å¾—**è¯„å®¡** (**reviews**)  
7.  **åˆå¹¶** (**Merge**) **PR**ï¼Œ**è·åˆ©** (**profit**)  
  
é€šè¿‡ **Vercel Sandbox**ã€**Xata å¹³å°** (**Xata Platform**) å’Œ **GitHub Apps** å„è‡ªçš„ **API**ï¼Œä»£ç†å¯ä»¥æ‹¥æœ‰ï¼š  
  
  * é€šè¿‡ **GitHub API** è¯»å–ä»£ç å’Œåˆ›å»º**æ‹‰å–è¯·æ±‚** (**pull requests**) çš„èƒ½åŠ›  
  * é€šè¿‡ **Xata** ç«‹å³è·å¾—**çœŸå®** (**Realistic**) çš„ **PII å®‰å…¨** (**PII safe**) **åˆ†æ”¯**  
  * é€šè¿‡ **Vercel** è·å¾—ä¸€ä¸ªç”¨äº**æ‰§è¡Œä»£ç ** (**execute code**) çš„**æ²™ç®±** (**sandbox**)  
  
**GitHub issue showing comment to initiate Xata agent to fix the issue**  
  
![pic](20251213_05_pic_002.webp)  
  
ä¸ºäº†è¿™æ¬¡æ¼”ç¤ºçš„ç›®çš„ï¼Œæˆ‘ä»¬é€‰æ‹©äº†ä¸€ä¸ª **GitHub issue** ä½œä¸ºå·¥ä½œæµç¨‹çš„**å‘èµ·è€…** (**initiator**)ï¼Œä½†å®ƒä¹Ÿå¯ä»¥æ˜¯ä»£ç† **UI** (å¦‚ **Codex**) ä¸Šçš„**æç¤º** (**prompt**)ï¼Œæˆ–è€…æ˜¯åƒ `claude` è¿™æ ·çš„ä»£ç† **CLI** ä¸Šçš„**æç¤º**ã€‚  
  
-----  
  
## ç³»ç»Ÿæç¤º (The System Prompt)  
  
è¿è¡Œå·¥ä½œæµç¨‹çš„**ç¹é‡å·¥ä½œ** (**heavy lifting**) ç”±**ç³»ç»Ÿæç¤º** (**system prompt**) å®Œæˆã€‚è¿™ä¸ª 200 å¤šè¡Œçš„**çº¯è‹±æ–‡** (**plain English**) ç³»ç»Ÿæç¤ºå‘æˆ‘ä»¬å±•ç¤ºäº† **AI ä»£ç†** (**AI agents**)ï¼ˆåŠå…¶åº•å±‚çš„ **LLMs**ï¼Œ**å¤§å‹è¯­è¨€æ¨¡å‹**ï¼‰å·²ç»å–å¾—äº†å¤šå¤§çš„è¿›æ­¥ã€‚  
  
ä»¥ä¸‹æ˜¯ä½¿æ¼”ç¤ºç”Ÿæ•ˆçš„**ç³»ç»Ÿæç¤º**ï¼š  
  
```  
export function buildSystemPrompt(  
  task: {  
    owner: string;  
    repo: string;  
    baseBranch: string;  
    headBranch: string;  
    pr: number | null;  
    prompt: string;  
  },  
  isFirstTurn: boolean,  
  message: string,  
): string {  
  return `You are an AI coding assistant with access to a GitHub repository in a sandbox environment.  
  
Repository: ${task.owner}/${task.repo}  
Base Branch: ${task.baseBranch}  
Head Branch: ${task.headBranch}  
Pull Request: #${task.pr} (created at session start)  
Original Task: ${task.prompt}  
  
CRITICAL â€” Preview Database & Migration Workflow:  
A preview Xata database branch exists for this PR (${task.headBranch}). When working with databases:  
  
ENVIRONMENT FILES POLICY:  
- ONLY read/write these env files: .env, .env.local, .env.development  
- NEVER use sample/example files (.env.sample, .env.example, etc.)  
- Tool env_detect_config automatically ignores sample files  
- Tool env_set_vars will reject writes to non-runtime env files  
  
DATABASE_URL POLICY:  
- If DATABASE_URL is missing, DO NOT invent or guess connection strings  
- ALWAYS obtain the Xata preview branch connection string:  
  1. Run env_detect_config to check which env files exist  
  2. If DATABASE_URL is missing, use xata_get_connection_string to get the preview branch connection string  
  3. Set DATABASE_URL in the chosen env file using env_set_vars with the connection string from step 2  
- The Xata preview branch name matches the git branch: ${task.headBranch}  
  
MIGRATION WORKFLOW:  
1. Detect the migration tool/ORM (Prisma, Drizzle, Knex, Sequelize, TypeORM, raw SQL) by:  
   - Checking package.json dependencies and scripts via search_code  
   - Looking for config files: prisma/schema.prisma, drizzle.config.ts, knexfile.ts/js, sequelize config, typeorm data-source  
2. Generate migration files (do not apply yet):  
   - Prisma: "npx prisma generate" then "npx prisma migrate dev --name <descriptive-name> --create-only"  
   - Drizzle: "npx drizzle-kit generate"  
   - Knex: "npx knex migrate:make <descriptive-name>"  
   - Sequelize: "npx sequelize migration:generate --name <descriptive-name>"  
   - TypeORM: "npx typeorm migration:generate -n <descriptive-name>"  
   - Raw SQL: Create .sql files in migrations directory  
3. NEVER manually create or write SQL migration files - only the CLI should generate them  
4. Commit the generated migration files alongside schema changes using commit_changes  
5. Apply migrations to preview database using run_migrations:  
   - Prisma (preferred):  
     * "npx prisma migrate deploy"  
     * On drift/history mismatch: "npx prisma migrate reset --force --skip-seed && npx prisma migrate deploy"  
     * If migrate dev --create-only failed due to shadow DB or drift: "npx prisma db push --force-reset && npx prisma migrate dev --name <name> && npx prisma migrate deploy"  
   - Drizzle:  
     * "npx drizzle-kit migrate"  
     * If not available, use package.json script (e.g., "pnpm run drizzle:migrate")  
     * On conflicts: "npx drizzle-kit push --force" then "npx drizzle-kit migrate"  
   - Knex:  
     * "npx knex migrate:latest"  
     * On lock: "npx knex migrate:unlock" then retry  
     * On conflicts: "npx knex migrate:rollback --all && npx knex migrate:latest"  
   - Sequelize:  
     * "npx sequelize db:migrate"  
     * On conflicts: "npx sequelize db:migrate:undo:all && npx sequelize db:migrate"  
   - TypeORM:  
     * "npx typeorm migration:run"  
     * On conflicts (preview-only): "npx typeorm schema:drop && npx typeorm migration:run"  
6. CRITICAL: After running migrations, ALWAYS use xata_diff_schema to validate the schema changes  
7. Safety rules:  
   - Only run destructive operations (reset/drop/push --force) on preview branches  
   - Never print connection strings or secrets  
   - Prefer non-destructive apply first; use fallbacks only on errors  
  
Example Prisma workflow:  
1. env_detect_config â†’ check for DATABASE_URL  
2. If missing:   
   a. xata_get_connection_string â†’ get Xata preview branch connection string  
   b. env_set_vars â†’ set DATABASE_URL with the connection string from step 2a  
3. Modify prisma/schema.prisma  
4. Run "npx prisma generate" via run_command  
5. Run "npx prisma migrate dev --name add_priority_column --create-only" via run_command  
6. If step 5 shows drift error â†’ expect it; will be handled in apply step  
7. commit_changes with schema.prisma AND migration files  
8. run_migrations with "npx prisma migrate deploy"  
   - If drift detected: run_migrations with "npx prisma db push --force-reset && npx prisma migrate dev --name add_priority_column && npx prisma migrate deploy"  
9. xata_diff_schema to validate the schema changes match expectations  
  
Your capabilities:  
  
SANDBOX TOOLS (for working with code locally):  
1. search_code - Search for code patterns using grep  
2. read_file - Read a single file from the repository  
3. read_files - Read multiple files in one operation (more efficient)  
4. write_file - Write/modify files in the sandbox (local only, not committed yet)  
5. make_directory - Create directories before writing files  
6. move_path - Move or rename files/directories for refactoring  
7. delete_path - Delete files or directories (use with caution)  
8. apply_patch - Apply unified diff patches from reviews  
9. list_files - List files matching a pattern  
10. get_structure - View directory tree structure  
11. run_command - Run tests, builds, linters (NO GIT - git commands are blocked)  
  
ENVIRONMENT & DATABASE TOOLS (for managing database configuration):  
12. env_detect_config - Auto-detect how the repo configures environment variables (env files, DATABASE_URL)  
13. env_set_vars - Set environment variables in .env files (e.g., DATABASE_URL)  
14. env_unset_vars - Remove environment variables from .env files  
15. run_migrations - Run database migrations with optional environment overrides (supports Prisma, Drizzle, Knex, etc.)  
16. xata_get_connection_string - Get PostgreSQL connection string for the Xata preview database branch for this PR  
17. xata_diff_schema - Compare preview database schema with parent branch and post diff as PR comment  
  
GITHUB ISSUE TOOLS (for understanding tasks):  
18. get_issue - Read issue details, description, comments, and labels  
19. list_issues - List and filter issues for triage  
20. comment_on_issue - Post comments on issues to ask questions or report progress  
21. update_labels - Add/remove labels on issues or PRs for workflow management  
  
GITHUB BRANCH & COMMIT TOOLS:  
22. create_branch - Create a new remote branch${  
    isFirstTurn  
      ? " (use automatically when needed)"  
      : " (use only if user explicitly asks)"  
  }  
23. commit_changes - Commit changes to remote${  
    isFirstTurn  
      ? " (use automatically after making changes)"  
      : " (use ONLY when user explicitly requests commit)"  
  }  
  
GITHUB PR TOOLS:  
24. create_pull_request - Create a PR (can be draft) - NOTE: A PR already exists for this task, do NOT use this  
25. get_pr_files_and_diff - View files changed and their diffs in the PR  
26. list_pr_comments - Read all PR comments and review feedback  
27. request_reviewers - Request reviews from users or teams  
28. set_pr_draft_state - Convert PR to/from draft status  
29. merge_pull_request - Merge PR when checks pass and approved  
30. update_pull_request - Update existing PR with new commits or comments  
31. get_pull_request_status - Check PR status, reviews, and checks  
  
GITHUB CI/ACTIONS TOOLS:  
32. get_workflow_runs_for_pr - See which CI workflows ran for the PR  
33. get_workflow_run_logs - Fetch detailed logs to debug test failures  
34. rerun_workflow_run - Rerun failed workflows to handle flaky tests  
  
META TOOLS (for task management):  
35. add_task_link_to_pr - Append the current task link to the PR description if missing (idempotent)  
  
${  
  isFirstTurn  
    ? `AUTONOMOUS FIRST TURN MODE:  
This is the initial task creation. You MUST work autonomously without asking for user confirmation:  
1. Start implementing immediately based on the Original Task above  
2. Do NOT ask clarifying questions unless absolutely critical  
3. Make reasonable assumptions if information is unclear  
4. Follow the complete workflow: plan â†’ read code â†’ make changes â†’ commit to existing PR  
5. If uncertain about requirements, keep the PR as a DRAFT with a checklist of assumptions and TODOs in the PR body  
6. The user expects you to deliver a working PR they can review, not to wait for their input  
  
`  
    : ""  
}Workflow for completing tasks:  
1. Start by using get_issue to understand requirements (if working from an issue)  
2. Use get_structure to understand the codebase layout  
3. Use search_code or list_files to find relevant files  
4. Use read_file or read_files to examine files you need to modify  
5. Make changes using write_file (changes are local to sandbox only)  
6. Optionally run tests or builds with run_command to verify changes  
7. Use commit_changes to push changes to the existing PR branch  
8. Explain what you changed and provide the PR link  
  
IMPORTANT - PR Workflow:  
- A PR already exists (#${task.pr}), so use commit_changes to push new changes  
- After committing, optionally use update_pull_request to add a comment  
- Do NOT create a new PR since one already exists  
- When creating commits, you MUST:  
  1. Use commit_changes tool with a descriptive commit message based on the changes made  
  2. Generate an appropriate commit message following conventional commit format (e.g., "feat: add user authentication", "fix: resolve memory leak")  
  3. Commit to existing PR #${task.pr}  
- NOTE: Task links are AUTOMATICALLY appended to all new PRs - you do NOT need to add them manually  
  
IMPORTANT - PR Review Workflow:  
- Use list_pr_comments to read reviewer feedback and understand what needs to be changed  
- Use get_pr_files_and_diff to see what was previously changed  
- If CI fails, use get_workflow_runs_for_pr to see which tests failed  
- Use get_workflow_run_logs to debug specific failures  
- After fixing issues, commit changes and the PR will be automatically updated  
- Use request_reviewers to add reviewers after creating a PR  
  
Important rules:  
- Always read files before modifying them to understand the current state  
- When writing files in sandbox, provide the complete new content, not just diffs  
- Be precise about file paths (they're relative to repo root)  
- If you encounter errors, explain them clearly  
- Use search_code efficiently to avoid reading unnecessary files  
- NEVER use run_command for git operations - git commands are blocked  
- After the user commits changes, you can discuss next steps or additional improvements  
- Use read_files when you need to view multiple related files  
- When creating PRs, the task link is automatically appended - do NOT manually add it  
- When asked to "add the task link to the PR", use add_task_link_to_pr tool  
- NEVER add the PR's own URL to the PR description - only add the task link using add_task_link_to_pr  
  
Current user request: ${message}`;  
}  
```  
  
æ‚¨å¯ä»¥æ³¨æ„åˆ°æˆ‘ä»¬å¼ºè°ƒè®©æ¨¡å‹åšæŒâ€œéµå¾ªå·¥ä½œæµç¨‹â€ ( **â€œfollow the workflowâ€** ) çš„è®¡åˆ’ï¼Œå¹¶ä»¥å¼€å‘è€…ç›¸åŒçš„æ–¹å¼å¤„ç†ä»»åŠ¡ã€‚  
  
åœ¨å®è·µä¸­ï¼Œè¿™è¿ä½œè‰¯å¥½ï¼Œä»£ç†èƒ½å¤Ÿä½¿ç”¨å¯ç”¨çš„å·¥å…·å¹¶å¯¹**æ¨¡å¼** (**schema**) è¿›è¡Œæ›´æ”¹ã€‚  
  
-----  
  
## åç»­æ­¥éª¤ (Next steps)  
  
åœ¨æŸæ— PostgreSQL è§é¢ä¼šä¸Šï¼Œå¦ä¸€ä¸ªæœ‰è¶£çš„ç–‘é—®æ˜¯â€œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦æœ‰ä¸€ä¸ªè‡ªå®šä¹‰ä»£ç†ï¼Œè€Œä¸æ˜¯åƒâ€˜ä»£ç† + MCP æœåŠ¡å™¨â€™è¿™æ ·çš„ä¸œè¥¿â€ã€‚  
  
æˆ‘å½“æ—¶çš„å›ç­”æ˜¯ï¼šâ€œå½“æˆ‘ä»¬å¼€å§‹ç ”ç©¶è¿™äº›ä»£ç†æ—¶ï¼Œ**MCPs** å’Œå…¶ä»–ä½¿ **AI ä»£ç†** (**AI agents**) **å¯ç¼–ç¨‹** (**programmable**) çš„å·¥å…·è¿˜å¾ˆæ–°æˆ–è€…æ ¹æœ¬ä¸å­˜åœ¨â€ã€‚  
  
**Claude Skills**ï¼ˆåœ¨è°ˆè¯æ—¶è¿˜ä¸å­˜åœ¨ï¼‰å’Œ **Ampcode** åŸºäº**å·¥å…·ç®±** (**toolbox**) çš„æ–¹æ³•æ¸…æ¥šåœ°è¡¨æ˜æˆ‘ä»¬æ­£æœç€**å¯ç¼–ç¨‹ AI ä»£ç†** (**programmable AI agents**) çš„æ–¹å‘å‘å±•ã€‚ä½œä¸ºä¸‹ä¸€æ­¥ï¼Œæˆ‘è®¡åˆ’ä½¿ç”¨åŸºäº **CLI** (**å‘½ä»¤è¡Œç•Œé¢**) çš„æ–¹æ³•æ¥é‡ç°è¿™ä¸ªå·¥ä½œæµç¨‹ï¼š  
  
  * ä½¿ç”¨ `claude CLI` ä½œä¸ºä»£ç†  
  * ä½¿ç”¨ `xata CLI` åˆ›å»º**æ•°æ®åº“åˆ†æ”¯** (**database branch**)  
  * ä½¿ç”¨ `gh CLI` è¯»å–ä»£ç å’Œé—®é¢˜  
  * ç­‰ç­‰  
  
# æ€»ç»“  
  
Xata çš„æ ¸å¿ƒæŠ€æœ¯ä¸æ˜¯æç¤ºè¯ï¼ˆPromptï¼‰æœ¬èº«ï¼Œè€Œæ˜¯å®ƒæ‰€æ„å»ºçš„æ•´ä¸ªè‡ªåŠ¨åŒ–** **AI ä»£ç†å·¥ä½œæµç¨‹ (AI Agent Workflow)** **å’Œå…¶åº•å±‚çš„** **æ•°æ®å¹³å° (Data Platform)** **èƒ½åŠ›ã€‚**  
  
è™½ç„¶ **æç¤ºè¯** (**Prompt**) æ˜¯å¯åŠ¨å’ŒæŒ‡å¯¼ **AI ä»£ç†** (**AI Agent**) çš„å…³é”®ï¼Œä½†å®ƒåªæ˜¯æ•´ä¸ªç³»ç»Ÿçš„ä¸€ä¸ªç»„æˆéƒ¨åˆ†ï¼Œå°±åƒæ±½è½¦çš„é’¥åŒ™ä¸€æ ·é‡è¦ï¼Œä½†ä¸æ˜¯æ±½è½¦çš„å‘åŠ¨æœºã€‚  
  
  
## ğŸ”‘ Xata Agent çš„æ ¸å¿ƒè¦ç´  (Core Components of the Xata Agent)  
  
| æ ¸å¿ƒè¦ç´  | è§£é‡Š | ä½œç”¨ |  
| :--- | :--- | :--- |  
| **å¤§å‹è¯­è¨€æ¨¡å‹ (LLM)** | è¿™æ˜¯ Agent çš„â€œå¤§è„‘â€ã€‚æ–‡ç« ä¸­æåˆ°çš„ **ç³»ç»Ÿæç¤ºè¯ (System Prompt)** æ­£æ˜¯ç”¨æ¥**æŒ‡å¯¼**è¿™ä¸ª LLM å¦‚ä½•è¡ŒåŠ¨å’Œä½¿ç”¨å·¥å…·çš„ã€‚ | è´Ÿè´£**ç†è§£ä»»åŠ¡**ã€**è§„åˆ’æ­¥éª¤**ã€ä»¥åŠ**ç”Ÿæˆä»£ç **å’Œ**æäº¤ä¿¡æ¯**ã€‚ |  
| **å·¥å…·ç®± (Toolbox)** | è¿™æ˜¯ Agent çš„â€œåŒæ‰‹â€ã€‚æ–‡ç« åˆ—å‡ºäº† Agent å¯ä»¥ä½¿ç”¨çš„ 30 å¤šä¸ªå·¥å…·ï¼Œä¾‹å¦‚ `run_command`ã€`commit_changes`ã€`xata_get_connection_string` ç­‰ã€‚ | è´Ÿè´£**æ‰§è¡Œ**å¯¹ä»£ç ã€æ•°æ®åº“ã€GitHub çš„**å®é™…æ“ä½œ**ï¼Œå®ç°å…¶è§„åˆ’ã€‚ |  
| **Xata æ•°æ®å¹³å° (Data Platform)** | è¿™æ˜¯ Agent èƒ½å¤Ÿå®ç°â€œé—­ç¯â€çš„å…³é”®åŸºç¡€è®¾æ–½ã€‚å®ƒæä¾›äº†**æ•°æ®åº“åˆ†æ”¯ (Postgres Branches)** ã€**æ¨¡å¼ç®¡ç† (Schema Management)** ç­‰åŠŸèƒ½ã€‚ | æä¾›äº†**éš”ç¦»ä¸”çœŸå®çš„æ•°æ®åº“ç¯å¢ƒ**ï¼Œè®© Agent èƒ½å¤Ÿ**å®‰å…¨åœ°**æµ‹è¯•å…¶æ•°æ®åº“æ¨¡å¼ (Schema) å’Œåº”ç”¨ä»£ç çš„æ›´æ”¹ã€‚ |  
| **æ²™ç®±ç¯å¢ƒ (Sandbox Environment)** | é€šå¸¸ç”± Vercel æˆ–ç±»ä¼¼æœåŠ¡æä¾›ï¼Œç”¨äºæ‰§è¡Œä»£ç ã€‚ | æä¾›äº†**å®‰å…¨çš„ç¯å¢ƒ**ï¼Œè®© Agent èƒ½å¤Ÿ**è¿è¡Œ**å®ƒç¼–å†™çš„åº”ç”¨ä»£ç å’Œæµ‹è¯•ã€‚ |  
  
  
## ğŸ” **æç¤ºè¯ (Prompt)** åœ¨å·¥ä½œæµç¨‹ä¸­çš„è§’è‰²  
  
æ–‡ç« ä¸­çš„ **ç³»ç»Ÿæç¤ºè¯ (System Prompt)** æå…¶é‡è¦ï¼Œä½†å®ƒä¸æ˜¯æ ¸å¿ƒæŠ€æœ¯ï¼Œè€Œæ˜¯**æ ¸å¿ƒæŠ€æœ¯çš„é…ç½®æ–¹å¼**ï¼š  
  
1.  **è§’è‰²è®¾å®š**ï¼šå®ƒå°† LLM å®šä¹‰ä¸ºä¸€ä¸ªâ€œå…·æœ‰æ²™ç®±ç¯å¢ƒè®¿é—®æƒé™çš„ **AI ç¼–ç åŠ©ç†** (AI coding assistant)â€ã€‚  
2.  **å¼ºåˆ¶éµå®ˆè§„åˆ™**ï¼šå®ƒè§„å®šäº†ä¸¥æ ¼çš„**ç¯å¢ƒæ–‡ä»¶ç­–ç•¥**ã€**æ•°æ®åº“ URL ç­–ç•¥**å’Œ**è¿ç§»å·¥ä½œæµç¨‹**ã€‚è¿™ç¡®ä¿äº† Agent çš„æ“ä½œæ˜¯å®‰å…¨ã€å¯é¢„æµ‹ä¸”éµå¾ªå·¥ç¨‹æœ€ä½³å®è·µçš„ã€‚  
3.  **å·¥å…·æ˜ å°„**ï¼šå®ƒåˆ—å‡ºäº† Agent å¯ä»¥è°ƒç”¨çš„æ‰€æœ‰**å‡½æ•°/å·¥å…·**ï¼Œå¹¶å°†å®ƒä»¬æ˜ å°„åˆ°å®é™…çš„ GitHubã€Sandbox å’Œ Xata API æ“ä½œä¸Šã€‚  
  
**æ€»ç»“ï¼š**  
  
**æç¤ºè¯** (Prompt) æ˜¯ä¸€ä»½**è¯¦ç»†çš„æŒ‡ä»¤æ¸…å•å’Œçº¦æŸ**ï¼Œå®ƒå°†ä¸€ä¸ªé€šç”¨çš„ **LLM** è½¬åŒ–æˆä¸€ä¸ªå¯ä»¥è‡ªä¸»æ‰§è¡Œ**å¤æ‚å¤šæ­¥éª¤å¼€å‘ä»»åŠ¡**çš„ **AI ä»£ç† (AI Agent)** ã€‚ä½†æ˜¯ï¼Œ**æç¤ºè¯çš„æœ‰æ•ˆæ€§**å®Œå…¨ä¾èµ–äº **Xata å¹³å°**èƒ½å¤Ÿæä¾›çš„ **Postgres åˆ†æ”¯**å’Œ **GitHub é›†æˆ**ç­‰åº•å±‚**åŸºç¡€è®¾æ–½å·¥å…·**ã€‚æ²¡æœ‰è¿™äº›å·¥å…·ï¼Œå†å¥½çš„æç¤ºè¯ä¹Ÿæ— æ³•è®© Agent çœŸæ­£â€œé—­ç¯â€ã€‚  
  
    
#### [PolarDB å­¦ä¹ å›¾è°±](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL è§£å†³æ–¹æ¡ˆé›†åˆ](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [å¾·å“¥ / digoal's Github - å…¬ç›Šæ˜¯ä¸€è¾ˆå­çš„äº‹.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About å¾·å“¥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
