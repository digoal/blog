## clickhouse æ¥æŠ± PG å¤§è…¿äº†?      
                    
### ä½œè€…                    
digoal                    
                    
### æ—¥æœŸ                    
2025-12-13                    
                    
### æ ‡ç­¾                    
PostgreSQL , pg_clickhouse  
                    
----                    
                    
## èƒŒæ™¯      
ClickHouse ç»™PGå¼€å‘äº†ä¸€æ¬¾æ’ä»¶: pg\_clickhouse . PG ç”¨æˆ·å¯ä»¥æ— ç¼ä½¿ç”¨ ClickHouse çš„OLAPèƒ½åŠ›.   
  
åœ¨å¼€å§‹ä»‹ç»pg\_clickhouseä¹‹å‰, å…ˆæ€è€ƒä¸€ä¸‹:    
  
ä»å•†ä¸šè§’åº¦æ¥çœ‹, ä¸ºä»€ä¹ˆ ClickHouse è¦å…è´¹ä¸º PostgreSQL ç”¨æˆ·å¼€å‘ `pg_clickhouse` æ‰©å±•ï¼ˆæ’ä»¶ï¼‰å‘¢?   
  
---  
  
## ğŸš€ **å•†ä¸šé©±åŠ¨åŠ›åˆ†æï¼šClickHouse å¼€å‘ `pg_clickhouse` çš„åŸå› **  
  
ClickHouse é‡‡å–è¿™ä¸€è¡ŒåŠ¨çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š **é™ä½ç”¨æˆ·è¿ç§»çš„æ‘©æ“¦ï¼Œæ‰©å¤§ ClickHouse çš„å¸‚åœºå æœ‰ç‡ï¼Œå¹¶åŠ é€Ÿä» OLTP/æ··åˆæ•°æ®åº“åˆ°ä¸“ä¸š OLAP æ•°æ®åº“çš„è¿‡æ¸¡ã€‚**  
  
### 1. æ•æ‰æœ€å¤§çš„æ½œåœ¨ç”¨æˆ·ç¾¤å’Œé™ä½è¿ç§»æ‘©æ“¦  
  
è¿™æ˜¯æœ€ç›´æ¥ä¸”æœ€é‡è¦çš„åŸå› ã€‚  
  
* **è¯†åˆ«æ ¸å¿ƒç—›ç‚¹ï¼šPostgreSQL æ˜¯ä¸»è¦çš„è¿ç§»æ¥æº**  
    * æ ¹æ®æ–‡ç« å¼€å¤´æåˆ°çš„ï¼šâ€œä»…æ¬¡äºè‡ªæ‰˜ç®¡çš„ **ClickHouse**ï¼Œ**PostgreSQL** æ˜¯æœ€å¸¸è§çš„è¿ç§»æ¥æºã€‚â€ è¿™è¡¨æ˜ PostgreSQL ç”¨æˆ·åœ¨é‡åˆ°åˆ†ææ€§èƒ½ç“¶é¢ˆæ—¶ï¼Œæ˜¯è½¬å‘ ClickHouse çš„æœ€å¤§ç›®æ ‡å®¢æˆ·ç¾¤ã€‚  
* **è§£å†³â€œä»£ç é‡å†™â€çš„ç—›ç‚¹ï¼ˆæ‘©æ“¦ï¼‰**  
    * æ•°æ®è¿ç§»ï¼ˆData Migrationï¼‰å·²ç»æœ‰ **ClickPipes** è¿™æ ·çš„å·¥å…·æ¥ç®€åŒ–ã€‚  
    * çœŸæ­£çš„ç“¶é¢ˆåœ¨äºåº”ç”¨å±‚ï¼šç”¨æˆ·åœ¨ **PostgreSQL** ä¸Šç§¯ç´¯äº†å¤šå¹´çš„åˆ†æ **SQL**ã€**ORMs**ã€ä»ªè¡¨æ¿ï¼ˆdashboardsï¼‰å’Œä¸šåŠ¡é€»è¾‘ã€‚é‡å†™è¿™äº›ä»£ç æ˜¯è€—æ—¶ä¸”é«˜é£é™©çš„ã€‚  
    * `pg_clickhouse` å…è®¸ç”¨æˆ·â€œæ— éœ€ä¿®æ”¹â€æˆ–ä»…éœ€å°‘é‡ä¿®æ”¹ï¼ˆä¾‹å¦‚æ›´æ”¹ `search_path`ï¼‰å³å¯è¿è¡Œç°æœ‰çš„åˆ†ææŸ¥è¯¢ã€‚è¿™æå¤§åœ°**é™ä½äº†é‡‡ç”¨ ClickHouse çš„æŠ€æœ¯é—¨æ§›å’Œæ—¶é—´æˆæœ¬**ã€‚  
  
### 2. ä¿ƒè¿›å·¥ä½œè´Ÿè½½çš„åˆ†ç¦»å’Œä¸“ä¸šåŒ–  
  
ClickHouse æ˜¯ä¸€å®¶ä¸“æ³¨äº **OLAP**ï¼ˆè”æœºåˆ†æå¤„ç†ï¼‰çš„æ•°æ®åº“å…¬å¸ï¼Œå…¶å•†ä¸šåˆ©ç›Šåœ¨äºè¯´æœå®¢æˆ·å°†åˆ†æå·¥ä½œè´Ÿè½½è½¬ç§»åˆ°å…¶é«˜æ€§èƒ½å¼•æ“ä¸Šã€‚  
  
* **åŠ é€Ÿ OLAP é¢†åŸŸçš„ç»Ÿæ²»**  
    * é€šè¿‡å°†åˆ†ææŸ¥è¯¢é€æ˜åœ°ä» **PostgreSQL** è½¬ç§»åˆ° **ClickHouse** æ‰§è¡Œï¼ŒClickHouse æˆåŠŸåœ°å°†è‡ªå·±æ’å…¥åˆ°å®¢æˆ·çš„æ•°æ®æ¶æ„ä¸­ï¼Œæˆä¸ºå…¶æ ¸å¿ƒåˆ†æå±‚ã€‚  
    * ç”¨æˆ·å¯ä»¥ç»§ç»­ä½¿ç”¨ **PostgreSQL** å¤„ç† **OLTP**ï¼ˆè”æœºäº‹åŠ¡å¤„ç†ï¼‰å’Œå°‘é‡æ··åˆæŸ¥è¯¢ï¼ŒåŒæ—¶äº«å— **ClickHouse** åœ¨å¤§è§„æ¨¡åˆ†æä¸Šçš„æ€§èƒ½ä¼˜åŠ¿ã€‚  
* **å®šä½ä¸ºæœ€ä½³â€œåˆ†æåç«¯â€**  
    * è¯¥æ’ä»¶ä½¿ **PostgreSQL** æˆä¸ºäº†ä¸€ä¸ª**åˆ†æä»£ç†**ï¼ˆAnalytics Proxyï¼‰ã€‚ç”¨æˆ·ä¸ç†Ÿæ‚‰çš„ **Postgres** äº¤äº’ï¼Œä½†æŸ¥è¯¢çš„ç¹é‡å·¥ä½œï¼ˆ**æŸ¥è¯¢ä¸‹æ¨** - Query Pushdownï¼‰è¢«äº¤ç»™ **ClickHouse** å®Œæˆã€‚è¿™å¼ºåŒ–äº† ClickHouse ä½œä¸ºé«˜æ€§èƒ½ã€ä¸å¯æˆ–ç¼ºçš„åˆ†æåç«¯çš„å®šä½ã€‚  
  
### 3. å±•ç°æŠ€æœ¯å®åŠ›å’Œäº§å“æˆç†Ÿåº¦  
  
ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„ **FDW**ï¼ˆå¤–éƒ¨æ•°æ®å°è£…å™¨ï¼‰ä¸ä»…æ˜¯ä¸€ä¸ªé›†æˆå·¥å…·ï¼Œå®ƒè¿˜ä»£è¡¨äº† ClickHouse çš„æŠ€æœ¯èƒ½åŠ›ã€‚  
  
* **è§£å†³æ·±åº¦åˆ†æçš„æŒ‘æˆ˜**  
    * æ–‡ç« é‡ç‚¹æåˆ°äº†å¯¹**èšåˆå‡½æ•°ä¸‹æ¨**ï¼ˆAggregate Function Pushdownï¼‰å’Œ**åŠè¿æ¥ä¸‹æ¨**ï¼ˆSEMI JOIN Pushdownï¼‰çš„æ”¹è¿›ã€‚è¿™äº›åŠŸèƒ½æ˜¯å¤æ‚åˆ†ææŸ¥è¯¢ï¼ˆå¦‚ **TPC-H** åŸºå‡†æµ‹è¯•æ‰€ç¤ºï¼‰çš„å…³é”®ã€‚  
    * å¦‚æœæ’ä»¶åªèƒ½å¤„ç†ç®€å•çš„æŸ¥è¯¢ï¼Œé‚£ä¹ˆå®ƒçš„å•†ä¸šä»·å€¼æœ‰é™ã€‚é€šè¿‡è§£å†³è¿™äº›å¤æ‚çš„**æŸ¥è¯¢ä¸‹æ¨**æŒ‘æˆ˜ï¼ŒClickHouse å‘å¸‚åœºè¯æ˜ï¼šå®ƒä¸ä»…èƒ½å­˜å‚¨æ•°æ®ï¼Œè¿˜èƒ½åœ¨å¤æ‚çš„åº”ç”¨åœºæ™¯ä¸‹ï¼Œæ— ç¼ã€é«˜æ•ˆåœ°æ¥ç®¡ä½ çš„åˆ†æå·¥ä½œè´Ÿè½½ã€‚  
* **å»ºç«‹å’Œæ§åˆ¶ç”Ÿæ€ç³»ç»Ÿ**  
    * æ¥æ‰‹å¹¶æ”¹è¿› `clickhouse_fdw` çš„ç°æœ‰å·¥ä½œï¼Œå¹¶å°†å…¶ç°ä»£åŒ–ï¼Œä½¿ ClickHouse èƒ½å¤Ÿ**æ§åˆ¶**å’Œ**åŠ é€Ÿ**è¿™ä¸€å…³é”®çš„é›†æˆç‚¹ã€‚ç¡®ä¿å…¶ä¸æœ€æ–°çš„ **PostgreSQL** å’Œ **ClickHouse** ç‰ˆæœ¬å…¼å®¹ã€å¯é ï¼Œè¿™å¯¹äºå•†ä¸šæ¨å¹¿è‡³å…³é‡è¦ã€‚  
  
### 4. å•†ä¸šæ¨¡å¼å’Œæœªæ¥è¥æ”¶  
  
è™½ç„¶è¿™ä¸ªæ’ä»¶æœ¬èº«æ˜¯å¼€æºçš„ï¼Œä½†å…¶æœ€ç»ˆç›®çš„æ˜¯é©±åŠ¨ ClickHouse Cloud ç­‰å•†ä¸šæœåŠ¡çš„é‡‡ç”¨ã€‚  
  
* **é©±åŠ¨ ClickHouse Cloud é‡‡ç”¨**  
    * è¯¥æ’ä»¶ä½¿å®¢æˆ·èƒ½å¤Ÿæ›´è½»æ¾åœ°è¯•ç”¨å’Œé‡‡ç”¨ **ClickHouse Cloud** æœåŠ¡ã€‚ä¸€æ—¦æ•°æ®å’ŒæŸ¥è¯¢é€»è¾‘è½¬ç§»åˆ°äº† ClickHouse ç”Ÿæ€ä¸­ï¼Œå®¢æˆ·æ›´å€¾å‘äºé€‰æ‹©å®˜æ–¹æä¾›çš„ã€å…¨æ‰˜ç®¡ã€è¿ç»´ç®€å•çš„ **ClickHouse Cloud**ï¼Œä»è€Œè½¬åŒ–ä¸º ClickHouse çš„ä»˜è´¹ç”¨æˆ·ã€‚  
* **é”å®šå®¢æˆ·å’Œç”Ÿæ€æ•ˆåº”**  
    * ä¸€æ—¦å®¢æˆ·é€šè¿‡ `pg_clickhouse` å°†åˆ†æå·¥ä½œæµç¨‹æ·±åº¦é›†æˆåˆ° ClickHouse ä¸­ï¼Œè½¬æ¢åˆ°å…¶ä»–åˆ†ææ•°æ®åº“çš„æˆæœ¬å°†å†æ¬¡å˜é«˜ï¼Œä»è€Œæé«˜äº†å®¢æˆ·çš„**ç•™å­˜ç‡**ï¼ˆCustomer Retentionï¼‰å’Œ**è½¬æ¢æˆæœ¬**ï¼ˆSwitching Costsï¼‰ã€‚  
  
  
### **æ€»ç»“ï¼šä¸€ä¸ªåŒèµ¢çš„æˆ˜ç•¥**  
  
ClickHouse å¼€å‘ `pg_clickhouse` æ˜¯ä¸€ä¸ªç²¾æ˜çš„å•†ä¸šæˆ˜ç•¥ï¼š  
  
| è§†è§’ | ç›®æ ‡ | å•†ä¸šä»·å€¼ |  
| :--- | :--- | :--- |  
| **å¯¹ç”¨æˆ·** | é›¶ï¼ˆä½ï¼‰ä»£ç é‡å†™ã€æŸ¥è¯¢åŠ é€Ÿ | **é™ä½è¿ç§»é£é™©å’Œæˆæœ¬**ï¼Œå³æ—¶è·å¾—é«˜æ€§èƒ½åˆ†æã€‚ |  
| **å¯¹ ClickHouse** | æ‰©å¤§ç”¨æˆ·ç¾¤ã€æŠ¢å å¸‚åœºä»½é¢ | **åŠ é€Ÿå®¢æˆ·è·å–**ï¼Œå°†æœ€å¤§çš„æ½œåœ¨ç”¨æˆ·ç¾¤ï¼ˆPostgres ç”¨æˆ·ï¼‰è½¬åŒ–ä¸º ClickHouse ç”¨æˆ·ã€‚ |  
| **æŠ€æœ¯/æ¶æ„** | å·¥ä½œè´Ÿè½½åˆ†ç¦»å’Œä¸“ä¸šåŒ– | å·©å›º ClickHouse ä½œä¸º**ä¸“ä¸šé«˜æ€§èƒ½ OLAP å¼•æ“**çš„åœ°ä½ã€‚ |  
  
---  
  
ä»¥ä¸‹å†…å®¹ç¿»è¯‘è‡ª:  https://clickhouse.com/blog/introducing-pg_clickhouse  
  
## **pg\_clickhouse** ä»‹ç»  
  
åœ¨è¿‡å»ä¸€å¹´é‡Œï¼Œæˆ‘ä»¬æ³¨æ„åˆ°å·²å°†åˆ†æå·¥ä½œè´Ÿè½½è¿ç§»åˆ° **ClickHouse Cloud** çš„å®¢æˆ·ä¸­å­˜åœ¨ä¸€ä¸ªæ˜¾è‘—çš„æ¨¡å¼ï¼šä»…æ¬¡äºè‡ªæ‰˜ç®¡çš„ **ClickHouse**ï¼Œ**PostgreSQL** æ˜¯æœ€å¸¸è§çš„è¿ç§»æ¥æºã€‚**ClickPipes** ä½¿è¿™äº›ç”¨ä¾‹ä¸­çš„æ•°æ®å¤åˆ¶å’Œè¿ç§»å˜å¾—å®¹æ˜“ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å‘ç°ç”¨æˆ·åœ¨å°†æŸ¥è¯¢å’Œåº”ç”¨ç¨‹åºä»£ç ä» **PostgreSQL** è¿ç§»åˆ° **ClickHouse** æ—¶ï¼Œä»ç„¶é¢ä¸´ç€å·¨å¤§çš„æŒ‘æˆ˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå‡ ä¸ªæœˆå‰æˆ‘ä»¬å¼€å§‹ç ”ç©¶å¦‚ä½•ç®€åŒ–å’Œç¼©çŸ­å°†åˆ†ææŸ¥è¯¢ä» **PostgreSQL** è¿ç§»åˆ° **ClickHouse** æ‰€éœ€çš„æ—¶é—´ã€‚  
  
ä»Šå¤©ï¼Œæˆ‘ä»¬å¾ˆé«˜å…´å‘å¸ƒ **pg\_clickhouse** v0.1.0ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡‡ç”¨ Apache 2 è®¸å¯çš„ **PostgreSQL** æ‰©å±• (**extension**)ï¼Œå®ƒå…è®¸ç›´æ¥ä» **PostgreSQL** é€æ˜åœ°åœ¨ **ClickHouse** ä¸Šæ‰§è¡Œåˆ†ææŸ¥è¯¢ã€‚  
  
è¯·ä»ä»¥ä¸‹ä½ç½®ä¸‹è½½ **pg\_clickhouse**ï¼š  
PGXN GitHub  
  
æˆ–è€…é€šè¿‡å¯åŠ¨ Docker å®ä¾‹æ¥è¯•ç”¨ï¼š  
  
```  
docker run --name pg_clickhouse -e POSTGRES_PASSWORD=my_pass   
       -d ghcr.io/clickhouse/pg_clickhouse:18  
```  
  
å»ºè®®ä»[æ•™ç¨‹](https://github.com/ClickHouse/pg_clickhouse/blob/main/TUTORIAL.md)å¼€å§‹ã€‚    
  
### ç›®æ ‡  
  
è€ƒè™‘ä¸€ä¸ªå¸¸è§æƒ…å†µï¼šæŸä¸ªç»„ç»‡æ„å»ºäº†ä¸€ä¸ªç”± **Postgres** æ”¯æŒçš„åº”ç”¨ç¨‹åºï¼Œå…¶ä¸­ä¸ä»…åŒ…å«ä¸šåŠ¡æ•°æ®å’Œäº‹åŠ¡å¤„ç†ï¼Œè¿˜åŒ…æ‹¬æ—¥å¿—å’ŒæŒ‡æ ‡ã€‚éšç€äº§å“çš„å‘å±•ï¼Œç”¨æˆ·æµé‡å’Œæ•°æ®é‡å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚å› æ­¤ï¼Œä¸ºé¢å‘å®¢æˆ·çš„å®æ—¶åŠŸèƒ½å’Œå¯è§‚æµ‹æ€§ç³»ç»Ÿæä¾›æ”¯æŒçš„åˆ†ææŸ¥è¯¢å¼€å§‹å˜æ…¢ã€‚  
  
å¼€å‘äººå‘˜é€šå¸¸ä¼šé€šè¿‡ä½¿ç”¨ **PostgreSQL** åªè¯»å‰¯æœ¬ (**read replicas**) æ¥ç¼“è§£è¿™äº›é—®é¢˜ï¼Œä½†è¿™å……å…¶é‡åªæ˜¯ä¸€ä¸ªä¸´æ—¶è§£å†³æ–¹æ¡ˆã€‚æœ€ç»ˆï¼Œä»–ä»¬ä¼šè€ƒè™‘å°†å·¥ä½œè´Ÿè½½è½¬ç§»åˆ°åƒ **ClickHouse** è¿™æ ·çš„ä¸“ä¸šåˆ†ææ•°æ®åº“ã€‚**ClickPipes** ä¸ºå¿«é€Ÿæ•°æ®è¿ç§»æä¾›äº†åŠ¨åŠ›ï¼Œä½†å¯¹äºé’ˆå¯¹è¿™äº›æ•°æ®çš„ç°æœ‰ **PostgreSQL** æŸ¥è¯¢ï¼ˆé€šå¸¸ç”± **SQL** åº“æˆ– **ORMs** åˆ›å»ºï¼‰è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ  
  
> è€—æ—¶çš„éƒ¨åˆ†ä¸æ˜¯ç§»åŠ¨æ•°æ®ï¼›**ClickPipes** å·²ç»è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚è€—æ—¶çš„æ˜¯é‡å†™åµŒå…¥åœ¨ä»ªè¡¨æ¿ (**dashboards**)ã€**ORMs** å’Œ cron jobs ä¸­æ•°æœˆæˆ–æ•°å¹´çš„åˆ†æ **SQL**ã€‚  
  
æˆ‘ä»¬è®¾æƒ³äº†ä¸€ä¸ª **PostgreSQL** æ‰©å±• (**extension**)ï¼Œå®ƒå¯ä»¥å‡å°‘è¿ç§»è¿™äº›æŸ¥è¯¢çš„éœ€è¦ï¼Œç”¨æˆ·åªéœ€å°†è¿™äº›æŸ¥è¯¢æŒ‡å‘æ–°çš„ **Postgres** æ•°æ®åº“æˆ–æ¨¡å¼ (**schema**)ï¼Œå³å¯åœ¨æ•°æ®è¿ç§»åè¿›è¡Œå·¥ä½œè´Ÿè½½è¿ç§»ã€‚  
  
å› æ­¤ï¼Œæˆ‘ä»¬ç€æ‰‹æ„å»º **pg\_clickhouse**ï¼Œå¹¶ç‰¢è®°ä»¥ä¸‹ç›®æ ‡ï¼š  
  
  * æä¾›ä» **PostgreSQL** æ‰§è¡Œ **ClickHouse** æŸ¥è¯¢çš„èƒ½åŠ›  
  * å…è®¸ç°æœ‰çš„ **PostgreSQL** æŸ¥è¯¢æ— éœ€ä¿®æ”¹å³å¯è¿è¡Œ  
  * å°†æŸ¥è¯¢æ‰§è¡Œ**ä¸‹æ¨** (**Query Pushdown**) åˆ° **ClickHouse**  
  * ä¸ºæŸ¥è¯¢å’Œ**æŸ¥è¯¢ä¸‹æ¨** (**Query Pushdown**) çš„æŒç»­å‘å±•å¥ å®šåŸºç¡€  
  
å¦‚æœ **ClickHouse** è¡¨çœ‹èµ·æ¥å°±åƒå¸¸è§„çš„ **PostgreSQL** è¡¨ä¸€æ ·ä¼šæ€æ ·ï¼Ÿå‡è®¾å®ƒä»¬å­˜åœ¨äºä¸€ä¸ªä¸ç°æœ‰ **Postgres** åˆ†æè¡¨åˆ†ç¦»çš„æ¨¡å¼ (**schema**) ä¸­ï¼Œä½†æä¾›äº†ç›¸åŒçš„ç»“æ„ï¼Ÿè¿™ç§æ¨¡å¼å°†å…è®¸ç°æœ‰æŸ¥è¯¢åƒä»¥å‰ä¸€æ ·å·¥ä½œï¼Œåªéœ€æ›´æ”¹ `search_path` å³å¯ã€‚  
  
### å†å²  
  
**SQL/MED** æ­£æ˜¯é€šè¿‡æä¾›æ•°æ®åº“æ‰©å±•ï¼ˆç§°ä¸º**å¤–éƒ¨æ•°æ®å°è£…å™¨** (**Foreign Data Wrapper** æˆ– **FDW**)ï¼‰æ¥è§£å†³è¿™ç§ç”¨ä¾‹çš„ï¼Œå®ƒå…è®¸é€šè¿‡ **SQL** ç®¡ç†å¤–éƒ¨æ•°æ®ã€‚**PostgreSQL** è‡ª 2011 å¹´çš„ 9.3 ç‰ˆæœ¬å¼€å§‹å°±æ”¯æŒ**å¤–éƒ¨æ•°æ®å°è£…å™¨** (**FDW**)ï¼Œæ­¤åï¼Œä¸€ç³»åˆ—åŠŸèƒ½å¼ºå¤§çš„â€œ**FDW**â€æ‰©å±• (**extensions**)ï¼ˆå®ƒä»¬çš„å¸¸ç”¨å«æ³•ï¼‰ä¸æ–­å‘å±•å£®å¤§ã€‚  
  
æˆ‘ä»¬å››å¤„å¯»æ‰¾ç°æœ‰è§£å†³æ–¹æ¡ˆï¼Œå¹¶å¾ˆå¿«æ‰¾åˆ°äº† `clickhouse_fdw` å¹¶è¿›è¡Œäº†éªŒè¯ï¼Œå®ƒç”± Ildus Kurbangaliev ä¸º Adjust å¼€å‘ï¼ŒåŸºäº Ibrar Ahmed åœ¨ Percona çš„åˆæ­¥å·¥ä½œã€‚å®ƒä¸ä»…æ”¯æŒåŸå§‹æ•°æ®è®¿é—®ï¼Œè¿˜æ”¯æŒ**æŸ¥è¯¢ä¸‹æ¨** (**Query Pushdown**)ï¼ŒåŒ…æ‹¬å¯¹æŸäº› **JOIN** å’Œ**èšåˆå‡½æ•°** (**Aggregate Function**) çš„æ”¯æŒã€‚  
  
è¯¥é¡¹ç›®èµ·æºäº 2019 å¹´ï¼Œæ˜¯ä» **PostgreSQL FDW** çš„è§„èŒƒå‚è€ƒå®ç° `postgres_fdw` çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œä»¥åŠ **ClickHouse C++ åº“**çš„ä¸€ä¸ªåˆ†æ”¯æ´¾ç”Ÿè€Œæ¥ã€‚é—æ†¾çš„æ˜¯ï¼Œè‡ª 2020 å¹´åº•ä»¥æ¥ï¼Œå®ƒåªè¿›è¡Œäº†åŸºç¡€ç»´æŠ¤å·¥ä½œï¼Œå¤§å¤šæ˜¯ç¡®ä¿å…¶èƒ½ä¸æ–°ç‰ˆæœ¬ **PostgreSQL** é…åˆä½¿ç”¨çš„è¡¥ä¸ã€‚`clickhouse_fdw` æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å¼€ç«¯ï¼Œä½†å®ƒæ²¡æœ‰å—ç›Šäº **PostgreSQL FDW API** ä¸­æœ€æ–°çš„**æŸ¥è¯¢ä¸‹æ¨** (**Pushdown**) æ”¹è¿›ï¼ŒåŒ…æ‹¬å¯¹é«˜çº§èšåˆã€**åŠè¿æ¥** (**SEMI JOIN**)ã€å­æŸ¥è¯¢ (**subqueries**) ç­‰çš„æ”¯æŒã€‚å®ƒä¹Ÿç¼ºä¹å¯¹ Linux ä»¥å¤–å¹³å°çš„æµ‹è¯•å’Œæ”¯æŒï¼Œå¹¶ä¸”åœ¨æ–°ç‰ˆ **PostgreSQL** å‘å¸ƒæ—¶æ›´æ–°æ»åã€‚åœ¨ä¸ Ildus äº¤æµåï¼Œæˆ‘ä»¬å°†å¤§éƒ¨åˆ†åŠŸèƒ½å¯¼å…¥äº†ä¸€ä¸ªæ–°é¡¹ç›® **pg\_clickhouse**ï¼Œå¹¶ä¿ç•™äº† Apache 2 è®¸å¯ï¼Œä»¥ä¿æŒåˆ†å‘çš„ä¸€è‡´æ€§ã€‚  
  
### æ”¹è¿›  
  
å°½ç®¡ `clickhouse_fdw` åŠå…¶å‰èº« `postgres_fdw` ä¸ºæˆ‘ä»¬çš„ **FDW** å¥ å®šäº†åŸºç¡€ï¼Œä½†æˆ‘ä»¬ç€æ‰‹å¯¹ä»£ç å’Œæ„å»ºè¿‡ç¨‹è¿›è¡Œç°ä»£åŒ–ï¼Œä¿®å¤é”™è¯¯å¹¶è§£å†³ä¸è¶³ï¼Œå¹¶å°†å…¶æ‰“é€ æˆä¸ºä¸€ä¸ªå®Œæ•´çš„äº§å“ï¼Œå…¶ç‰¹ç‚¹æ˜¯åˆ†ææŸ¥è¯¢å’Œèšåˆå‡ ä¹å¯ä»¥å®ç°é€šç”¨**ä¸‹æ¨** (**Pushdown**)ã€‚  
  
è¿™äº›è¿›æ­¥åŒ…æ‹¬ï¼š  
  
  * ä¸º **PostgreSQL** æ‰©å±•é‡‡ç”¨æ ‡å‡†çš„ **PGXS** æ„å»ºæµç¨‹  
  * æ·»åŠ é¢„å¤„ç† **INSERT** æ”¯æŒï¼Œå¹¶é‡‡ç”¨æœ€æ–°çš„ **ClickHouse C++ åº“**ç‰ˆæœ¬  
  * åˆ›å»ºæµ‹è¯•ç”¨ä¾‹å’Œ **CI å·¥ä½œæµ** (**CI workflows**)ï¼Œä»¥ç¡®ä¿å®ƒèƒ½åœ¨ **PostgreSQL** 13-18 ç‰ˆæœ¬å’Œ **ClickHouse** 22-25 ç‰ˆæœ¬ä¸Šè¿è¡Œ  
  * æ”¯æŒ **TLS** è¿æ¥ (**TLS-based connections**)ï¼Œé€‚ç”¨äºäºŒè¿›åˆ¶åè®®å’Œ **HTTP API**ï¼Œè¿™æ˜¯ **ClickHouse Cloud** æ‰€å¿…éœ€çš„  
  * æ”¯æŒ **Bool**ã€**Decimal** å’Œ **JSON** ç±»å‹  
  * é€æ˜çš„**èšåˆå‡½æ•°ä¸‹æ¨** (**Aggregate Function Pushdown**)ï¼ŒåŒ…æ‹¬å¯¹**æœ‰åºé›†èšåˆ** (**ordered-set aggregates**) çš„æ”¯æŒï¼Œä¾‹å¦‚ `percentile_cont()`  
  * **åŠè¿æ¥ä¸‹æ¨** (**SEMI JOIN Pushdown**)  
  
æœ€åè¿™ä¸¤é¡¹åŠŸèƒ½æ˜¾è‘—æå‡äº†**å¤–éƒ¨æ•°æ®å°è£…å™¨** (**Foreign Data Wrapper**) å¯¹åˆ†ææ•°æ®åº“çš„é€‚ç”¨æ€§ã€‚æ¯•ç«Ÿï¼Œå…¨éƒ¨æ„ä¹‰åœ¨äºå—ç›Šäºåœ¨ä¸“ä¸šä¸”é«˜æ•ˆçš„å¼•æ“ä¸Šè¿è¡Œåˆ†æå·¥ä½œè´Ÿè½½çš„æ‰§è¡Œé€Ÿåº¦ã€‚å¦‚æœå®ƒåªæ˜¯è¿”å›æ•°ç™¾ä¸‡è¡Œæ•°æ®è®© **PostgreSQL** æ¥èšåˆï¼Œé‚£å°†æ²¡æœ‰å¤ªå¤§ç”¨å¤„ã€‚  
  
### èšåˆå‡½æ•°ä¸‹æ¨ (**Aggregate Function Pushdown**)  
  
æœ‰åºé›†èšåˆ (**Ordered-set aggregates**) æ˜¯æœ€éš¾åœ¨ä¸åŒå¼•æ“ä¹‹é—´æ˜ å°„çš„å‡½æ•°ä¹‹ä¸€ï¼Œå› ä¸ºå®ƒä»¬çš„è¯­æ³•ä¸èƒ½ç›´æ¥è½¬æ¢ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œä¸€ä¸ª**èšåˆå‡½æ•°** (**Aggregate Function**) ä¼šå®Œå…¨**ä¸‹æ¨** (**Pushdown**) åˆ° **ClickHouse** ä»¥å®ç°é«˜æ•ˆæ‰§è¡Œã€‚è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªæ”¹ç¼–è‡ªæˆ‘ä»¬ HouseClick é¡¹ç›®çš„æŸ¥è¯¢ï¼š  
  
```sql  
SELECT  
    type,  
    round(min(price)) + 100 AS min,  
    round(max(price)) AS max,  
    round(percentile_cont(0.5) WITHIN GROUP (ORDER BY price)) AS median,  
    round(percentile_cont(0.25) WITHIN GROUP (ORDER BY price)) AS "25th",  
    round(percentile_cont(0.75) WITHIN GROUP (ORDER BY price)) AS "75th"  
FROM  
    uk.uk_price_paid  
GROUP BY  
    type  
```  
  
è¯¥æŸ¥è¯¢ä½¿ç”¨äº† 3 ä¸ª**èšåˆå‡½æ•°** (**Aggregate Function**)ã€‚`min()` å’Œ `max()` ä¼šè‡ªåŠ¨**ä¸‹æ¨** (**Pushdown**)ï¼Œå› ä¸ºå®ƒä»¬åœ¨ **ClickHouse** å’Œ **PostgreSQL** ä¸­å…·æœ‰ç›¸åŒçš„åç§°ã€‚ä½† `percentile_cont()` åˆ™ä¸ä¼šï¼Œå®ƒè®¡ç®—æˆ–å¹³å‡äº†æ‰€æœ‰å€¼ä¸­æŸä¸ªç™¾åˆ†æ¯”å†…çš„æœ€é«˜å€¼ã€‚**ClickHouse** ä¸­æ²¡æœ‰è¿™æ ·çš„å‡½æ•°ï¼›**ClickHouse** ä¹Ÿä¸æ”¯æŒ `WITHIN GROUP (ORDER BY x)` è¿™ç§æœ‰åºé›†èšåˆ (**ordered set aggregate**) è¯­æ³•ã€‚  
  
ç„¶è€Œï¼Œå®ƒç¡®å®æä¾›äº†**å‚æ•°åŒ–èšåˆå‡½æ•°** (**parametric aggregate functions**)ï¼ŒåŒ…æ‹¬ `quantile`ï¼Œå®ƒå®ç°äº†ä¸€éƒ¨åˆ†æœ‰åºé›†èšåˆ (**ordered set aggregate**) è¯­æ³•ã€‚å› æ­¤ï¼Œ**pg\_clickhouse** å°†æ­¤æŸ¥è¯¢é‡å†™ä¸º **ClickHouse** æ ¼å¼ï¼š  
  
```sql  
SELECT  
    type,  
    (round(min(price)) + 100),  
    round(max(price)),  
    round(quantile(0.5)(price)),  
    round(quantile(0.25)(price)),  
    round(quantile(0.75)(price))  
FROM  
    uk.uk_price_paid  
GROUP BY  
    type  
```  
  
è¯·æ³¨æ„ `percentile_cont()` çš„ç›´æ¥å‚æ•° (`0.5`ã€`0.25`ã€`0.75`) åˆ° `quantile()` çš„**å‚æ•°åŒ–å¸¸é‡**çš„é€æ˜è½¬æ¢ï¼Œä»¥åŠ **ORDER BY** å‚æ•°åˆ°å‡½æ•°å‚æ•°çš„è½¬æ¢ï¼š  
  
`percentile_cont(0.5) WITHIN GROUP (ORDER BY price)` =\> `quantile(0.5)(price)`  
  
æ›´é‡è¦çš„æ˜¯ï¼Œ**pg\_clickhouse**ï¼Œå°±åƒå®ƒä¹‹å‰çš„ `clickhouse_fdw` ä¸€æ ·ï¼Œå°† **PostgreSQL** èšåˆ `FILTER (WHERE)` è¡¨è¾¾å¼è½¬æ¢ä¸º **ClickHouse** çš„ `-If` ç»„åˆå™¨ (**combinators**)ã€‚è¿™æ˜¯æ¥è‡ª HouseClick çš„å®Œæ•´ **PostgreSQL** æŸ¥è¯¢ï¼š  
  
```sql  
SELECT  
    type,  
    round(min(price)) + 100 AS min,  
    round(min(price) FILTER (WHERE town='ILMINSTER' AND district='SOUTH SOMERSET' AND postcode1='TA19')) AS min_filtered,  
    round(max(price)) AS max,  
    round(max(price) FILTER (WHERE town='ILMINSTER' AND district='SOUTH SOMERSET' AND postcode1='TA19')) AS max_filtered,  
    round(percentile_cont(0.5) WITHIN GROUP (ORDER BY price)) AS median,  
    round(percentile_cont(0.5) WITHIN GROUP (ORDER BY price) FILTER (WHERE town='ILMINSTER' AND district='SOUTH SOMERSET' AND postcode1='TA19')) AS median_filtered,  
    round(percentile_cont(0.25) WITHIN GROUP (ORDER BY price)) AS "25th",  
    round(percentile_cont(0.25) WITHIN GROUP (ORDER BY price) FILTER (WHERE town='ILMINSTER' AND district='SOUTH SOMERSET' AND postcode1='TA19')) AS "25th_filtered",  
    round(percentile_cont(0.75) WITHIN GROUP (ORDER BY price)) AS "75th",  
    round(percentile_cont(0.75) WITHIN GROUP (ORDER BY price) FILTER (WHERE town='ILMINSTER' AND district='SOUTH SOMERSET' AND postcode1='TA19')) AS "75th_filtered"  
FROM  
    uk.uk_price_paid  
GROUP BY  
    type  
```  
  
ä½¿ç”¨ `EXPLAIN` è¿è¡Œå®ƒï¼ŒæŸ¥çœ‹æŸ¥è¯¢è®¡åˆ’ï¼š  
  
```  
                    QUERY PLAN                       
---------------------------------------------------  
 Foreign Scan  (cost=1.00..-0.90 rows=1 width=112)  
   Relations: Aggregate on (uk_price_paid)  
```  
  
`Fully pushed down!`ï¼ˆå®Œå…¨ä¸‹æ¨ï¼ï¼‰è¿™ç§é‡å†™é¿å…äº†å°†æ•°ç™¾ä¸‡è¡Œæ•°æ®ä¼ å› **PostgreSQL**ï¼Œå¹¶å°†ç¹é‡çš„å·¥ä½œä¿ç•™åœ¨ **ClickHouse** å†…éƒ¨ã€‚ä½¿ç”¨ `EXPLAIN (VERBOSE)` ä¹Ÿä¼šè¾“å‡ºå‘é€åˆ° **ClickHouse** çš„æŸ¥è¯¢ï¼ˆæ­¤å¤„å·²é‡æ–°æ ¼å¼åŒ–ï¼‰ï¼š  
  
```sql  
SELECT  
    type,  
    (round(min(price)) + 100),  
    round(minIf(price,((((town = 'ILMINSTER') AND (district = 'SOUTH SOMERSET') AND (postcode1 = 'TA19'))) > 0))),  
    round(max(price)),  
    round(maxIf(price,((((town = 'ILMINSTER') AND (district = 'SOUTH SOMERSET') AND (postcode1 = 'TA19'))) > 0))),  
    round(quantile(0.5)(price)),  
    round(quantileIf(0.5)(price,((((town = 'ILMINSTER') AND (district = 'SOUTH SOMERSET') AND (postcode1 = 'TA19'))) > 0))),  
    round(quantile(0.25)(price)),  
    round(quantileIf(0.25)(price,((((town = 'ILMINSTER') AND (district = 'SOUTH SOMERSET') AND (postcode1 = 'TA19'))) > 0))),  
    round(quantile(0.75)(price)),  
    round(quantileIf(0.75)(price,((((town = 'ILMINSTER') AND (district = 'SOUTH SOMERSET') AND (postcode1 = 'TA19'))) > 0)))   
FROM  
    uk.uk_price_paid  
GROUP BY  
    type  
;  
```  
  
è¯·æ³¨æ„ï¼Œæ¯ä¸ª `FILTER (WHERE)` è¡¨è¾¾å¼éƒ½å·²è½¬æ¢ä¸ºå¸¦æœ‰ `-If` åç¼€çš„ **ClickHouse** å‡½æ•°ï¼Œç”¨äºè®¡ç®—ç­‰æ•ˆçš„è¿‡æ»¤ã€‚æ¢å¥è¯è¯´ï¼Œè¿™ä¸ªè¡¨è¾¾å¼ï¼š  
  
```sql  
min(price) FILTER (WHERE town='ILMINSTER' AND district='SOUTH SOMERSET' AND postcode1='TA19')  
```  
  
å˜æˆäº†ï¼š  
  
```sql  
minIf(price,((((town = 'ILMINSTER') AND (district = 'SOUTH SOMERSET') AND (postcode1 = 'TA19'))) > 0))  
```  
  
### åŠè¿æ¥ä¸‹æ¨ (**SEMI JOIN Pushdown**)  
  
åœ¨æˆ‘ä»¬ç¡®å®šäº† **pg\_clickhouse** çš„åŸºç¡€åŠŸèƒ½åï¼Œæˆ‘ä»¬å¼€å§‹é’ˆå¯¹ **TPC-H**ï¼ˆè¿™ä¸ªå—äººå°Šæ•¬çš„â€œå†³ç­–æ”¯æŒå·¥ä½œè´Ÿè½½â€æ•°æ®åº“åŸºå‡†æµ‹è¯•ï¼‰è¿›è¡Œ**ä¸‹æ¨** (**Pushdown**) æµ‹è¯•ï¼Œ**TPC-H** æ•°æ®ä»¥ç¼©æ”¾å› å­ 1 åŠ è½½åˆ° **ClickHouse** ä¸­ã€‚æœ€åˆï¼Œåœ¨æ·»åŠ äº†å¯¹ **Decimal** ç±»å‹çš„æ”¯æŒåï¼Œ22 ä¸ªæŸ¥è¯¢ä¸­æœ‰ 10 ä¸ªè¿è¡Œå¾ˆå¿«ï¼›åœ¨è¿™äº›æŸ¥è¯¢ä¸­ï¼Œåªæœ‰ 3 ä¸ªä» **pg\_clickhouse å¤–éƒ¨è¡¨** (**foreign tables**) å®Œå…¨**ä¸‹æ¨**åˆ° **ClickHouse** æºã€‚å…¶ä¸­ä¹‹ä¸€æ˜¯æŸ¥è¯¢ 3 çš„è¿æ¥ï¼š  
  
```sql  
EXPLAIN (ANALYZE, COSTS)  
-- using default substitutions  
select  
    l_orderkey,  
    sum(l_extendedprice * (1 - l_discount)) as revenue,  
    o_orderdate,  
    o_shippriority  
from  
    customer,  
    orders,  
    lineitem  
where  
    c_mktsegment = 'BUILDING'  
    and c_custkey = o_custkey  
    and l_orderkey = o_orderkey  
    and o_orderdate < date '1995-03-15'  
    and l_shipdate > date '1995-03-15'  
group by  
    l_orderkey,  
    o_orderdate,  
    o_shippriority  
order by  
    revenue desc,  
    o_orderdate  
LIMIT 10;  
                                            QUERY PLAN                                               
---------------------------------------------------------------------------------------------------  
 Foreign Scan  (cost=0.00..-10.00 rows=1 width=44) (actual time=60.146..60.162 rows=10.00 loops=1)  
   Relations: Aggregate on (((customer) INNER JOIN (orders)) INNER JOIN (lineitem))  
   FDW Time: 0.106 ms  
 Planning:  
   Buffers: shared hit=230  
 Planning Time: 6.973 ms  
 Execution Time: 61.567 ms  
(7 rows)  
```  
  
ç„¶è€Œï¼Œè®¸å¤šå¤±è´¥çš„å…¶ä½™æŸ¥è¯¢ä½¿ç”¨äº†è¿æ¥ (**JOIN**) åˆ°å­æŸ¥è¯¢ (**subqueries**) æˆ– **WHERE** å­å¥ä¸­çš„ **EXISTS** å­æŸ¥è¯¢ (**EXISTS subqueries**)ã€‚æŸ¥è¯¢ 4 æ˜¯åä¸€ç§æƒ…å†µçš„å®Œç¾ç¤ºä¾‹ï¼ˆç¦ç”¨äº† **ANALYZE**ï¼Œå› ä¸ºå®ƒè€—æ—¶å¤ªä¹…ï¼‰ï¼š  
  
```sql  
EXPLAIN (COSTS, VERBOSE, BUFFERS)  
-- using default substitutions  
select  
    o_orderpriority,  
    count(*) as order_count  
from  
    orders  
where  
    o_orderdate >= date '1993-07-01'and o_orderdate < date(date '1993-07-01' + interval '3month')  
    and exists (select * from lineitem where l_orderkey = o_orderkey and l_commitdate < l_receiptdate)  
group by  
    o_orderpriority  
order by  
    o_orderpriority;  
                                                                                                                                                                                          QUERY PLAN                                                                                                                                                                                            
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
 Sort  (cost=-80.86..-80.36 rows=200 width=40)  
   Output: orders.o_orderpriority, (count(*))  
   Sort Key: orders.o_orderpriority  
   ->  HashAggregate  (cost=-90.50..-88.50 rows=200 width=40)  
         Output: orders.o_orderpriority, count(*)  
         Group Key: orders.o_orderpriority  
         ->  Nested Loop  (cost=3.50..-93.00 rows=500 width=32)  
               Output: orders.o_orderpriority  
               Join Filter: (orders.o_orderkey = lineitem.l_orderkey)  
               ->  HashAggregate  (cost=2.50..4.50 rows=200 width=4)  
                     Output: lineitem.l_orderkey  
                     Group Key: lineitem.l_orderkey  
                     ->  Foreign Scan on tpch.lineitem  (cost=0.00..0.00 rows=0 width=4)  
                           Output: lineitem.l_orderkey, lineitem.l_partkey, lineitem.l_suppkey, lineitem.l_linenumber, lineitem.l_quantity, lineitem.l_extendedprice, lineitem.l_discount, lineitem.l_tax, lineitem.l_returnflag, lineitem.l_linestatus, lineitem.l_shipdate, lineitem.l_commitdate, lineitem.l_receiptdate, lineitem.l_shipinstruct, lineitem.l_shipmode, lineitem.l_comment  
                           Remote SQL: SELECT l_orderkey FROM tpch.lineitem WHERE ((l_commitdate < l_receiptdate))  
               ->  Foreign Scan on tpch.orders  (cost=1.00..-0.50 rows=1 width=36)  
                     Output: orders.o_orderkey, orders.o_custkey, orders.o_orderstatus, orders.o_totalprice, orders.o_orderdate, orders.o_orderpriority, orders.o_clerk, orders.o_shippriority, orders.o_comment  
                     Remote SQL: SELECT o_orderkey, o_orderpriority FROM tpch.orders WHERE ((o_orderdate >= '1993-07-01')) AND ((o_orderdate < '1993-10-01')) ORDER BY o_orderpriority ASC NULLS LAST  
 Planning:  
   Buffers: shared hit=236  
(20 rows)  
```  
  
æŸ¥è¯¢è®¡åˆ’ä¸­æ·±å±‚çš„ä¸¤æ¬¡**å¤–éƒ¨æ‰«æ** (**foreign scans**) å¯¹äºå¦‚æ­¤ç®€å•çš„æŸ¥è¯¢æ¥è¯´ï¼Œæ°¸è¿œä¸ä¼šæ˜¯é«˜æ•ˆçš„ï¼  
  
æˆ‘ä»¬å·²ç»å¼€å§‹é€šè¿‡ä¸¤ç§æ–¹å¼è§£å†³è¿™äº›æƒ…å†µï¼š  
  
  * è®¾ç½®æˆæœ¬ (**costs**) ä»¥é¼“åŠ± **PostgreSQL** è§„åˆ’å™¨ (**planner**) **ä¸‹æ¨** (**Pushdown**) æŸ¥è¯¢ï¼Œä»¥é€‚åº”åˆ†æç”¨ä¾‹  
  * æ›´é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å¢åŠ äº†å¯¹**åŠè¿æ¥ä¸‹æ¨** (**SEMI JOIN Pushdown**) çš„æ”¯æŒ  
  
è¿™äº›æ›´æ”¹ä¸º 22 ä¸ªæŸ¥è¯¢ä¸­çš„ 21 ä¸ªå¸¦æ¥äº†é«˜æ•ˆæ‰§è¡Œï¼ˆä¸åˆ° 1 ç§’ï¼‰ï¼Œå¹¶ä¸º 12 ä¸ªæŸ¥è¯¢å®ç°äº†å®Œå…¨**ä¸‹æ¨** (**Pushdown**)ï¼ŒåŒ…æ‹¬æŸ¥è¯¢ 4ï¼š  
  
```sql  
EXPLAIN (ANALYZE, COSTS, VERBOSE, BUFFERS)  
-- using default substitutions  
select  
    o_orderpriority,  
    count(*) as order_count  
from  
    orders  
where  
    o_orderdate >= date '1993-07-01'and o_orderdate < date(date '1993-07-01' + interval '3month')  
    and exists (select * from lineitem where l_orderkey = o_orderkey and l_commitdate < l_receiptdate)  
group by  
    o_orderpriority  
order by  
    o_orderpriority;  
                                                                                                                                                             QUERY PLAN                                                                                                                                                                
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
 Foreign Scan  (cost=1.00..5.10 rows=1000 width=40) (actual time=51.835..51.847 rows=5.00 loops=1)  
   Output: orders.o_orderpriority, (count(*))  
   Relations: Aggregate on ((orders) LEFT SEMI JOIN (lineitem))  
   Remote SQL: SELECT r1.o_orderpriority, count(*) FROM  tpch.orders r1 LEFT SEMI JOIN tpch.lineitem r3 ON (((r3.l_commitdate < r3.l_receiptdate)) AND ((r1.o_orderkey = r3.l_orderkey))) WHERE ((r1.o_orderdate >= '1993-07-01')) AND ((r1.o_orderdate < '1993-10-01')) GROUP BY r1.o_orderpriority ORDER BY r1.o_orderpriority ASC  
   FDW Time: 0.056 ms  
 Planning:  
   Buffers: shared hit=242  
 Planning Time: 6.583 ms  
 Execution Time: 54.937 ms  
(9 rows)  
```  
  
ä¸‹è¡¨æ¯”è¾ƒäº†å¸¸è§„ **PostgreSQL** è¡¨ã€å¼•å…¥ **SEMI JOIN** æ€§èƒ½ä¹‹å‰çš„ **pg\_clickhouse** ä»¥åŠå…·æœ‰ **SEMI JOIN** æ€§èƒ½çš„ **pg\_clickhouse**ï¼ˆå³ä»Šå¤©å‘å¸ƒçš„ç‰ˆæœ¬ï¼‰ä¹‹é—´çš„æŸ¥è¯¢æ€§èƒ½ã€‚æµ‹è¯•é’ˆå¯¹åŠ è½½äº†ç¼©æ”¾å› å­ä¸º 1 çš„ **TPC-H** æ•°æ®çš„ **PostgreSQL** å’Œ **ClickHouse** è¡¨è¿è¡Œï¼›âœ… è¡¨ç¤ºå®Œå…¨**ä¸‹æ¨** (**Full Pushdown**)ï¼Œè€ŒçŸ­æ¨ªçº¿è¡¨ç¤ºæŸ¥è¯¢åœ¨ 1 åˆ†é’Ÿåè¢«å–æ¶ˆï¼š  
  
| æŸ¥è¯¢ (Query) | Postgres è¿è¡Œæ—¶ (Runtime) | åŸå§‹è¿è¡Œæ—¶ (Original Runtime) | **SEMI JOIN** è¿è¡Œæ—¶ (Runtime) |  
| :--- | :--- | :--- | :--- |  
| 1 | 4478ms | âœ… 82ms | âœ… 73ms |  
| 2 | 560ms | - | - |  
| 3 | 1454ms | âœ… 74ms | âœ… 74ms |  
| 4 | 650ms | - | âœ… 67ms |  
| 5 | 452ms | - | âœ… 104ms |  
| 6 | 740ms | âœ… 33ms | âœ… 42ms |  
| 7 | 633ms | - | âœ… 83ms |  
| 8 | 320ms | - | âœ… 114ms |  
| 9 | 3028ms | - | âœ…136ms |  
| 10 | 6ms | 10ms | âœ… 10ms |  
| 11 | 213ms | - | âœ… 78ms |  
| 12 | 1101ms | 99ms | âœ… 37ms |  
| 13 | 967ms | 1028ms | 1242ms |  
| 14 | 193ms | 168ms | âœ… 51ms |  
| 15 | 1095ms | 101ms | 522 ms |  
| 16 | 492ms | 1387ms | 1639ms |  
| 17 | 1802ms | - | 9ms |  
| 18 | 6185ms | - | 10ms |  
| 19 | 64ms | 75m | 65ms |  
| 20 | 473ms | - | 4595ms |  
| 21 | 1334ms | - | 1702ms |  
| 22 | 257ms | - | 268ms |  
  
è¯·æ³¨æ„ï¼Œå¯¹äºæ”¯æŒ **SEMI JOIN** çš„ **pg\_clickhouse å¤–éƒ¨è¡¨** (**foreign tables**) è€Œè¨€ï¼Œå‡ ä¹æ‰€æœ‰æŸ¥è¯¢çš„æ•´ä½“æ€§èƒ½éƒ½æœ‰æ‰€æå‡ï¼›åœ¨å°‘æ•°æƒ…å†µä¸‹ï¼ˆæŸ¥è¯¢ 13ã€15 å’Œ 16ï¼‰ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨ (**query optimizer**) é€‰æ‹©äº†è¾ƒæ…¢çš„è®¡åˆ’ï¼Œæˆ‘ä»¬æ˜¾ç„¶éœ€è¦å½»åº•æŸ¥æ˜æŸ¥è¯¢ 2 çš„æ€§èƒ½é—®é¢˜ã€‚ä½†å…¶ä»–æŸ¥è¯¢çš„æ€»ä½“æ€§èƒ½æå‡æ˜¯ä¸å¯å¦è®¤çš„ã€‚  
  
### æœªæ¥  
  
æˆ‘ä»¬å¯¹è¿™äº›æ”¹è¿›æ„Ÿåˆ°éå¸¸é«˜å…´ï¼Œå¹¶å¾ˆé«˜å…´èƒ½åœ¨é¦–ä¸ªç‰ˆæœ¬ä¸­å°†å®ƒä»¬å¸¦ç»™æ‚¨ã€‚ä½†æˆ‘ä»¬è¿˜è¿œè¿œæ²¡æœ‰å®Œæˆã€‚æˆ‘ä»¬çš„é¦–è¦é‡ç‚¹æ˜¯åœ¨æ·»åŠ  **DML** (æ•°æ®æ“ä½œè¯­è¨€) åŠŸèƒ½ä¹‹å‰ï¼Œå®Œæˆå¯¹åˆ†æå·¥ä½œè´Ÿè½½çš„**ä¸‹æ¨è¦†ç›–** (**Pushdown coverage**)ã€‚æˆ‘ä»¬çš„è·¯çº¿å›¾ (**road map**)ï¼š  
  
  * ä¼˜åŒ–å‰©ä½™ 10 ä¸ªæœª**ä¸‹æ¨** (**Pushdown**) çš„ **TPC-H** æŸ¥è¯¢è®¡åˆ’  
  * æµ‹è¯•å¹¶ä¿®å¤ **ClickBench** æŸ¥è¯¢çš„**ä¸‹æ¨** (**Pushdown**) é—®é¢˜  
  * æ”¯æŒæ‰€æœ‰ **PostgreSQL èšåˆå‡½æ•°** (**Aggregate Function**) çš„é€æ˜**ä¸‹æ¨** (**Pushdown**)  
  * æ”¯æŒæ‰€æœ‰ **PostgreSQL å‡½æ•°**çš„é€æ˜**ä¸‹æ¨** (**Pushdown**)  
  * å®ç°å…¨é¢çš„**å­æŸ¥è¯¢ä¸‹æ¨** (**Subquery Pushdown**)  
  * é€šè¿‡ **CREATE SERVER** å’Œ **CREATE USER** å…è®¸è®¾ç½®æœåŠ¡å™¨çº§åˆ«å’Œç”¨æˆ·çº§åˆ«çš„ **ClickHouse é…ç½®**  
  * æ”¯æŒæ‰€æœ‰ **ClickHouse æ•°æ®ç±»å‹** (**data types**)  
  * æ”¯æŒè½»é‡çº§çš„ **DELETE** å’Œ **UPDATE** æ“ä½œ  
  * é€šè¿‡ **COPY** æ”¯æŒæ‰¹é‡æ’å…¥ (**batch insertion**)  
  * æ·»åŠ ä¸€ä¸ªå‡½æ•°æ¥æ‰§è¡Œä»»æ„çš„ **ClickHouse æŸ¥è¯¢** (**query**) å¹¶å°†å…¶ç»“æœä½œä¸ºè¡¨ (**tables**) è¿”å›  
  * å½“æ‰€æœ‰ **UNION** æŸ¥è¯¢éƒ½é’ˆå¯¹è¿œç¨‹æ•°æ®åº“æ—¶ï¼Œæ·»åŠ å¯¹ **UNION** æŸ¥è¯¢**ä¸‹æ¨** (**Pushdown**) çš„æ”¯æŒ  
  
  
  
  
    
#### [PolarDB å­¦ä¹ å›¾è°±](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL è§£å†³æ–¹æ¡ˆé›†åˆ](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [å¾·å“¥ / digoal's Github - å…¬ç›Šæ˜¯ä¸€è¾ˆå­çš„äº‹.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About å¾·å“¥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
