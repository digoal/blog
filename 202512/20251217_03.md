## çœ‹ä¸ä¸ŠAIçš„éƒ½ä¼šè¢«AIæŠ›å¼ƒ: äººä¸AIå’Œè°å…±ç”Ÿ, æˆ‘1åˆ†é’Ÿæå®šäº†å‘é‡æ•™å­¦ä¾‹å­  
                                                                            
### ä½œè€…                                                                            
digoal                                                                            
                                                                            
### æ—¥æœŸ                                                                            
2025-12-17                                                                           
                                                                            
### æ ‡ç­¾                                                                            
PostgreSQL , AI , æ•™å­¦                               
                                                                            
----                                                                            
                                                                            
## èƒŒæ™¯   
æœ€è¿‘å‘äº†ä¸€äº›æ–‡ç« , æ€»æœ‰äººä¸‹é¢ç•™è¨€è¯„è®ºæœ‰AIå‘³, AIå‘³å’‹äº†? ç”¨AIå’‹äº†? ç”¨AIé­äººå«Œå¼ƒ?   
  
**çœŸçš„åˆ«çœ‹ä¸ä¸ŠAIäº†, æˆ‘çš„æ€åº¦: æ‰€æœ‰äººéƒ½èƒ½ç”¨AIææ•ˆ, ä½†æ˜¯èƒ½æŠŠAIå‘æŒ¥åˆ°æè‡´çš„äºº, æœ¬èº«è‚¯å®šä¹Ÿæ˜¯è¿™ä¸ªé¢†åŸŸçš„åŠä¸ªä¸“å®¶.**    
    
å› ä¸ºä¸‹é¢çš„è¿™ä¸ªæ•™å­¦éœ€è¦, éœ€ç”Ÿæˆä¸€äº›ç¬¦åˆæ­£æ€åˆ†å¸ƒçš„å‘é‡æ•°æ®(ä¸èƒ½çº¯éšæœº, å¦åˆ™å°±å¤±å»äº†ç°å®æ„ä¹‰, ä¾‹å¦‚ç¾¤ä½“çš„èšé›†æ€§ã€è¯­ä¹‰ç›¸ä¼¼æ’åºçš„æ„ä¹‰).     
- [ã€Šå¤§å­¦ç”Ÿæ•°æ®åº“å®è·µè¯¾å¼€è¯¾äº† : 1 å¤§çº²ã€‹](../202512/20251202_10.md)      
- [ã€Šå¤§å­¦ç”Ÿæ•°æ®åº“å®è·µè¯¾, docker é•œåƒã€‹](../202512/20251205_02.md)      
- [ã€Šå¤§å­¦ç”Ÿæ•°æ®åº“å®è·µè¯¾: è¯¾åå¤§ä½œä¸šã€‹](../202512/20251217_02.md)      
    
AI ä¸€ä¸‹å°±æå®šäº†, æˆ‘åªæä¾›äº†è¯æœ¯, ä»¥åŠåç»­çš„ç¨ä½œä¿®æ”¹, æå‡ºä¸€ä¸ªé€‚åˆçš„ç‰ˆæœ¬. å¹¶è¡Œçš„è¯å°±ä¸åŠ³çƒ¦å‡½æ•°äº†, pgbench å¼€å¯å‹æµ‹æ¨¡å¼å³å¯.    
  
(ä¸è¿‡é‡ç‚¹æ˜¯ä½ å¾—æ‡‚ä¸šåŠ¡å•Š, ä½ ä¸æ‡‚ä¸šåŠ¡æ€ä¹ˆä¹Ÿä¸å¯èƒ½ç”Ÿæˆå¤åˆä¸šåŠ¡çš„æ•°æ®, è‡³å°‘å¾—å’ŒAIé«˜ä½å¤šå‡ è½®å¯¹è¯, èµ°å¼¯è·¯å¯¹å§!)  
    
prompt :     
    
> æˆ‘è¦åœ¨PostgreSQLä¸­åˆ›å»ºä¸€ä¸ªå­˜å‚¨16ç»´å‘é‡çš„è¡¨, éœ€è¦ç”Ÿæˆæµ‹è¯•æ•°æ®, å†™ä¸€ä¸ªPostgreSQLå‡½æ•°, ç”Ÿæˆ1000ä¸ª(å¯å˜é‡è¾“å…¥)ç¦»æ•£éšæœºçš„å‘é‡, ç„¶åå†ä»¥è¿™1000ä¸ªå‘é‡ä¸ºä¸­å¿ƒ, ç”Ÿæˆ2000ä¸ª(å¯å˜é‡è¾“å…¥)ç¦»æ•£å‘é‡, ç¦»ä¸­å¿ƒç‚¹è·ç¦»è¶Šè¿‘å‡ºç°æ¦‚ç‡è¶Šé«˜, è¶Šè¿œæ¦‚ç‡è¶Šä½.     
    
---    
    
## AI æŠ¢ç­”    
åœ¨ PostgreSQL ä¸­å¤„ç†å‘é‡æ•°æ®ï¼Œé€šå¸¸æ¨èå®‰è£… **`pgvector`** æ’ä»¶ï¼ˆç›®å‰å·²ç»æ˜¯å‘é‡æ•°æ®åº“çš„äº‹å®æ ‡å‡†ï¼‰ã€‚ä¸ºäº†æ»¡è¶³ä½ â€œä¸­å¿ƒç‚¹èšåˆâ€å’Œâ€œæ¦‚ç‡åˆ†å¸ƒâ€çš„éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ç»“åˆé«˜æ–¯åˆ†å¸ƒï¼ˆæ­£æ€åˆ†å¸ƒï¼‰çš„é€»è¾‘æ¥ç¼–å†™å‡½æ•°ã€‚    
    
### 1\. ç¯å¢ƒå‡†å¤‡    
    
é¦–å…ˆï¼Œç¡®ä¿ä½ çš„æ•°æ®åº“å·²ç»å®‰è£…äº† `pgvector` æ’ä»¶ã€‚    
    
```sql    
CREATE EXTENSION IF NOT EXISTS vector;    
    
-- åˆ›å»ºå­˜å‚¨ 16 ç»´å‘é‡çš„è¡¨    
CREATE TABLE IF NOT EXISTS vector_test (    
    id SERIAL PRIMARY KEY,    
    embedding vector(16),    
    is_center BOOLEAN -- æ ‡è®°æ˜¯å¦ä¸ºä¸­å¿ƒç‚¹ï¼Œæ–¹ä¾¿åç»­æŸ¥è¯¢    
);    
```    
    
     
    
### 2\. æ ¸å¿ƒå‡½æ•°é€»è¾‘    
    
æˆ‘ä»¬éœ€è¦åˆ©ç”¨ PostgreSQL çš„å†…ç½®å‡½æ•° `random()`ã€‚ä¸ºäº†å®ç°â€œç¦»ä¸­å¿ƒç‚¹è¶Šè¿‘æ¦‚ç‡è¶Šé«˜â€ï¼Œæœ€ç§‘å­¦çš„æ–¹æ³•æ˜¯ä½¿ç”¨**Box-Muller å˜æ¢**æ¥ç”Ÿæˆç¬¦åˆ **æ­£æ€åˆ†å¸ƒï¼ˆNormal Distributionï¼‰** çš„éšæœºæ•°ã€‚    
    
#### ç¼–å†™å‡½æ•°ï¼š`generate_vector_data`    
    
```sql    
CREATE OR REPLACE FUNCTION generate_vector_data(    
    center_count INT,     -- ä¸­å¿ƒç‚¹æ•°é‡ (ä¾‹å¦‚ 1000)    
    points_per_center INT -- æ¯ä¸ªä¸­å¿ƒç‚¹å‘¨å›´ç”Ÿæˆçš„ç‚¹æ•° (ä¾‹å¦‚ 2, æ€»è®¡ 2000)    
) RETURNS TEXT AS $$    
DECLARE    
    center_id INT;    
    center_vec FLOAT8[];    
    new_vec FLOAT8[];    
    std_dev FLOAT8 := 0.1; -- æ ‡å‡†å·®ï¼Œå€¼è¶Šå°ç‚¹è¶Šå¯†é›†ï¼Œè¶Šå¤§ç¦»æ•£åº¦è¶Šé«˜    
    i INT;    
    j INT;    
    u1 FLOAT8;    
    u2 FLOAT8;    
    z0 FLOAT8;    
BEGIN    
    -- 1. ç”ŸæˆåŸå§‹çš„ç¦»æ•£éšæœºä¸­å¿ƒç‚¹    
    FOR i IN 1..center_count LOOP    
        center_vec := ARRAY(SELECT random() FROM generate_series(1, 16));    
        INSERT INTO vector_test (embedding, is_center)     
        VALUES (center_vec::vector, TRUE)    
        RETURNING id INTO center_id;    
    
        -- 2. ä»¥è¯¥ä¸­å¿ƒç‚¹ä¸ºåŸºå‡†ï¼Œç”Ÿæˆæœä»æ­£æ€åˆ†å¸ƒçš„å‘¨è¾¹ç‚¹    
        FOR j IN 1..points_per_center LOOP    
            new_vec := '{}';    
            -- å¯¹ 16 ä¸ªç»´åº¦åˆ†åˆ«è¿›è¡Œé«˜æ–¯æ‰°åŠ¨    
            FOR k IN 1..16 LOOP    
                -- Box-Muller å˜æ¢ç”Ÿæˆæ­£æ€åˆ†å¸ƒéšæœºæ•°    
                u1 := random();    
                u2 := random();    
                -- æ ¸å¿ƒå…¬å¼ï¼šz0 æ˜¯å‡å€¼ä¸º0ï¼Œæ ‡å‡†å·®ä¸º1çš„éšæœºæ•°    
                z0 := sqrt(-2.0 * ln(u1)) * cos(2.0 * pi() * u2);    
                    
                -- å°†æ‰°åŠ¨å åŠ åˆ°ä¸­å¿ƒç‚¹çš„å¯¹åº”ç»´åº¦ä¸Š    
                new_vec := array_append(new_vec, center_vec[k] + (z0 * std_dev));    
            END LOOP;    
                
            INSERT INTO vector_test (embedding, is_center)     
            VALUES (new_vec::vector, FALSE);    
        END LOOP;    
    END LOOP;    
    
    RETURN 'Successfully generated ' || (center_count + center_count * points_per_center) || ' vectors.';    
END;    
$$ LANGUAGE plpgsql;    
```    
    
     
    
### 3\. å¦‚ä½•ä½¿ç”¨    
    
æ‰§è¡Œè¯¥å‡½æ•°ç”Ÿæˆæ•°æ®ï¼š    
    
```sql    
-- ç”Ÿæˆ 1000 ä¸ªä¸­å¿ƒç‚¹ï¼Œæ¯ä¸ªä¸­å¿ƒç‚¹ç”Ÿæˆ 2 ä¸ªå‘¨è¾¹ç‚¹ï¼ˆå…± 1000 + 2000 = 3000 æ¡æ•°æ®ï¼‰    
SELECT generate_vector_data(1000, 2);    
```    
    
éªŒè¯æ•°æ®åˆ†å¸ƒï¼š    
    
```sql    
-- æŸ¥çœ‹æ•°æ®æ€»é‡    
SELECT is_center, count(*) FROM vector_test GROUP BY is_center;    
    
-- æŸ¥è¯¢è·ç¦»æŸä¸ªä¸­å¿ƒç‚¹æœ€è¿‘çš„ 5 ä¸ªç‚¹ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯åˆšæ‰ç”Ÿæˆçš„â€œè¿½éšç‚¹â€    
SELECT * FROM vector_test     
ORDER BY embedding <=> (SELECT embedding FROM vector_test WHERE is_center = true LIMIT 1)     
LIMIT 5;    
```    
    
     
    
### ğŸ’¡ å…³é”®ç‚¹è§£æ    
    
  * **æ¦‚ç‡åˆ†å¸ƒæ¨¡å‹**ï¼šä»£ç ä¸­ä½¿ç”¨äº†æ­£æ€åˆ†å¸ƒï¼ˆé«˜æ–¯åˆ†å¸ƒï¼‰ã€‚æ­£æ€åˆ†å¸ƒçš„ç‰¹æ€§æ˜¯æ•°å€¼å‡ºç°åœ¨å‡å€¼ï¼ˆè¿™é‡Œæ˜¯ä¸­å¿ƒç‚¹ç»´åº¦ï¼‰é™„è¿‘çš„æ¦‚ç‡æœ€å¤§ï¼Œè¶Šå¾€å¤–æ¦‚ç‡å‘ˆæŒ‡æ•°çº§ä¸‹é™ï¼Œå®Œç¾ç¬¦åˆä½ â€œè¿‘å¤„å¤šã€è¿œå¤„å°‘â€çš„éœ€æ±‚ã€‚    
  * **Box-Muller å˜æ¢**ï¼šè¿™æ˜¯åœ¨è®¡ç®—æœºä¸­é€šè¿‡ä¸¤ä¸ªå‡åŒ€åˆ†å¸ƒçš„éšæœºæ•°ç”Ÿæˆæ­£æ€åˆ†å¸ƒéšæœºæ•°çš„æ ‡å‡†ç®—æ³•ã€‚    
    $$z = \sqrt{-2\ln(u_1)} \cos(2\pi u_2)$$    
  * **æ§åˆ¶ç¦»æ•£åº¦**ï¼šå˜é‡ `std_dev`ï¼ˆæ ‡å‡†å·®ï¼‰æ§åˆ¶äº†ç‚¹çš„â€œç´§å‡‘ç¨‹åº¦â€ã€‚    
      * å¦‚æœ `std_dev` = 0.01ï¼Œç‚¹ä¼šéå¸¸è´´è¿‘ä¸­å¿ƒç‚¹ã€‚    
      * å¦‚æœ `std_dev` = 0.5ï¼Œç‚¹ä¼šæ˜¾å¾—éå¸¸æ•£ä¹±ã€‚    
    
## åŠ é¤, æ ‡å‡†å·®è¯¦è§£    
    
å¾ˆå¤šåˆå­¦è€…å¯¹æ ‡å‡†å·®çš„æ¦‚å¿µä¸ç†è§£ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª **â€œå°„å‡»/æ‰“é¶â€** çš„æ¯”å–»è®©ä½ ç¬é—´ç§’æ‡‚ï¼š    
    
### 1. æ ‡å‡†å·® ( $\sigma$ ) æ˜¯ä½ çš„â€œå‡†æ˜Ÿç²¾åº¦â€ï¼ˆå°ºå­ï¼‰    
æƒ³è±¡ä½ åœ¨æ‰“é¶ï¼Œé¶å¿ƒå°±æ˜¯**å¹³å‡å€¼ï¼ˆMeanï¼‰** ã€‚    
* **æ ‡å‡†å·®**ä¸æ˜¯ç™¾åˆ†æ¯”ï¼Œè€Œæ˜¯ä½ åç§»é¶å¿ƒçš„**å¹³å‡ç‰©ç†è·ç¦»**ï¼ˆæ¯”å¦‚ 1 å˜ç±³ã€5 å˜ç±³ï¼‰ã€‚    
* å®ƒæ˜¯ä¸€æŠŠ**ç‰¹åˆ¶çš„å°ºå­**ã€‚æ¯ä¸ªæ•°æ®é›†çš„å°ºå­é•¿çŸ­ä¸ä¸€æ ·ã€‚æœ‰çš„ç­çº§è€ƒè¯•åˆ†æ•°æ³¢åŠ¨å¤§ï¼Œå®ƒçš„â€œå°ºå­â€ä¸€æ ¼å°±æ˜¯ 20 åˆ†ï¼›æœ‰çš„æ³¢åŠ¨å°ï¼Œä¸€æ ¼å°±æ˜¯ 2 åˆ†ã€‚    
    
### 2. é‚£ 68%ã€95%ã€99.7% æ˜¯ä»€ä¹ˆï¼Ÿ    
è¿™äº›ç™¾åˆ†æ¯”æ˜¯ **â€œè¦†ç›–ç‡â€** ï¼Œä¹Ÿå°±æ˜¯ä½ â€œå­å¼¹è½åœ¨è¿™ä¸ªèŒƒå›´å†…â€çš„**æ¦‚ç‡**ã€‚    
    
* **1 ä¸ªæ ‡å‡†å·®ï¼ˆ $1\sigma$ ï¼‰ï¼š** ç›¸å½“äºä½ æ‹¿ç€é‚£æŠŠâ€œå°ºå­â€ï¼Œä»é¶å¿ƒå‘å·¦ã€å‘å³å„é‡å‡º **1 æ ¼**çš„è·ç¦»ã€‚åœ¨è¿™ä¸ªåœˆåœˆé‡Œï¼Œä½ ä¼šå‘ç°ä½  **68%** çš„å­å¼¹éƒ½è½åœ¨é‡Œé¢äº†ã€‚    
* **2 ä¸ªæ ‡å‡†å·®ï¼ˆ $2\sigma$ ï¼‰ï¼š** ä»é¶å¿ƒå‘å·¦ã€å‘å³å„é‡å‡º **2 æ ¼**ã€‚è¿™ä¸ªåœˆå˜å¤§äº†ï¼Œä½ èƒ½åœˆä½ **95%** çš„å­å¼¹ã€‚    
* **3 ä¸ªæ ‡å‡†å·®ï¼ˆ $3\sigma$ ï¼‰ï¼š** é‡å‡º **3 æ ¼**ã€‚è¿™å‡ ä¹è¦†ç›–äº†æ•´ä¸ªé¶å­ï¼Œ**99.7%** çš„å­å¼¹éƒ½åœ¨è¿™äº†ã€‚å‰©ä¸‹çš„ 0.3% å°±æ˜¯æ‰€è°“çš„â€œå¥‡è‘©â€æˆ–â€œæç«¯å¼‚å¸¸å€¼â€ã€‚    
    
### 3. ç”¨å‰é¢æåˆ°çš„ 16 ç»´å‘é‡ä¸¾ä¾‹    
å‡è®¾ä½ ç”Ÿæˆå‘é‡æ—¶ï¼ŒæŸä¸€ä¸ªç»´åº¦çš„å¹³å‡å€¼æ˜¯ `0.5` (ä¾‹å­ä¸­ä½¿ç”¨`random()`å‡½æ•°ç”Ÿæˆçš„æ•°æ®, å¹³å‡å€¼å°±æ˜¯0.5, å› ä¸º`random()`è¿”å›çš„æ˜¯0åˆ°1ä¹‹é—´éšæœºåˆ†å¸ƒçš„å€¼.)ï¼Œä½ è®¾ç½®çš„æ ‡å‡†å·® `std_dev` æ˜¯ `0.1`ã€‚    
    
* **è¿™æŠŠå°ºå­çš„ 1 æ ¼ = 0.1ã€‚**    
* **68% çš„æ¦‚ç‡ï¼š** ä½ ç”Ÿæˆçš„æ•°å€¼ä¼šè½åœ¨ $[0.4, 0.6]$ ä¹‹é—´ï¼ˆ $0.5 \pm 0.1$ ï¼‰ã€‚    
* **95% çš„æ¦‚ç‡ï¼š** ä½ ç”Ÿæˆçš„æ•°å€¼ä¼šè½åœ¨ $[0.3, 0.7]$ ä¹‹é—´ï¼ˆ $0.5 \pm 0.2$ ï¼‰ã€‚    
* **99.7% çš„æ¦‚ç‡ï¼š** ä½ ç”Ÿæˆçš„æ•°å€¼ä¼šè½åœ¨ $[0.2, 0.8]$ ä¹‹é—´ï¼ˆ $0.5 \pm 0.3$ ï¼‰ã€‚    
    
### ğŸ’¡ æ€»ç»“å¯¹æ¯”è¡¨    
    
| æ¦‚å¿µ | åˆ°åº•æ˜¯ä»€ä¹ˆ | å½¢è±¡ç†è§£ |    
| :--- | :--- | :--- |    
| **å¹³å‡å€¼ (Mean)** | æ•°æ®çš„ä¸­å¿ƒç‚¹ | é¶å¿ƒ |    
| **æ ‡å‡†å·® ( $\sigma$ )** | **å•ä½é•¿åº¦** | å°ºå­ä¸Šçš„â€œä¸€æ ¼â€æœ‰å¤šé•¿ |    
| **68% / 95%...** | **æ¦‚ç‡/é¢ç§¯** | è¿™ä¸ªåœˆé‡Œèƒ½è£…ä¸‹å¤šå°‘ä¸ªæ•°æ®ç‚¹ |    
    
**æ‰€ä»¥ï¼Œå½“ä½ çœ‹åˆ°â€œ3ä¸ªæ ‡å‡†å·®â€æ—¶ï¼ŒæŠŠå®ƒæƒ³æˆâ€œ3å€è·ç¦»â€ï¼Œè€Œä¸æ˜¯â€œ3%â€ã€‚**    
    
åœ¨å·¥ä¸šç•Œï¼ˆæ¯”å¦‚â€œå…­è¥¿æ ¼ç›â€ç®¡ç†ï¼‰ï¼Œè¿½æ±‚çš„å°±æ˜¯ $6\sigma$ çš„ç²¾åº¦ï¼Œæ„å‘³ç€ 100 ä¸‡ä¸ªäº§å“é‡Œåªæœ‰ 3.4 ä¸ªæ¬¡å“ï¼Œè¿™å°±æ˜¯æŠŠâ€œåœˆå­â€æ‹‰å¾—æå¤§ï¼Œè®©é”™è¯¯å‘ç”Ÿçš„æ¦‚ç‡å˜å¾—æå°ã€‚    
    
---    
    
## äººå·¥ä¿®æ”¹    
æˆ‘æ•…æ„ç•™äº†ä¸ªç»´åº¦/æ ‡å‡†å·®å¯è°ƒ, æ€»è¦ä¸œä¸œè¿‡è„‘å­, å¦åˆ™å…¨è®©AIå˜äº†, ä¸€ç‚¹æ„æ€éƒ½æ²¡æœ‰.    
    
1ã€ç»´åº¦å¯è°ƒæ•´, æ ‡å‡†å·®å¯è°ƒæ•´     
    
```sql    
CREATE OR REPLACE FUNCTION generate_vector_data(    
    center_count INT,     -- ä¸­å¿ƒç‚¹æ•°é‡ (ä¾‹å¦‚ 1000)    
    points_per_center INT, -- æ¯ä¸ªä¸­å¿ƒç‚¹å‘¨å›´ç”Ÿæˆçš„ç‚¹æ•° (ä¾‹å¦‚ 2, æ€»è®¡ 2000)    
    dims int,  -- ç»´åº¦    
    i_std_dev float8 default 0.1  -- æ ‡å‡†å·®ï¼Œå€¼è¶Šå°ç‚¹è¶Šå¯†é›†ï¼Œè¶Šå¤§ç¦»æ•£åº¦è¶Šé«˜    
) RETURNS TEXT AS $$    
DECLARE    
    center_id INT;    
    center_vec FLOAT8[];    
    new_vec FLOAT8[];    
    std_dev FLOAT8 := i_std_dev; -- æ ‡å‡†å·®ï¼Œå€¼è¶Šå°ç‚¹è¶Šå¯†é›†ï¼Œè¶Šå¤§ç¦»æ•£åº¦è¶Šé«˜    
    i INT;    
    j INT;    
    u1 FLOAT8;    
    u2 FLOAT8;    
    z0 FLOAT8;    
BEGIN    
    -- 1. ç”ŸæˆåŸå§‹çš„ç¦»æ•£éšæœºä¸­å¿ƒç‚¹    
    FOR i IN 1..center_count LOOP    
        center_vec := ARRAY(SELECT random() FROM generate_series(1, dims));    
        INSERT INTO vector_test (embedding, is_center)     
        VALUES (center_vec::vector, TRUE)    
        RETURNING id INTO center_id;    
    
        -- 2. ä»¥è¯¥ä¸­å¿ƒç‚¹ä¸ºåŸºå‡†ï¼Œç”Ÿæˆæœä»æ­£æ€åˆ†å¸ƒçš„å‘¨è¾¹ç‚¹    
        FOR j IN 1..points_per_center LOOP    
            new_vec := '{}';    
            -- å¯¹æ¯ä¸ªç»´åº¦åˆ†åˆ«è¿›è¡Œé«˜æ–¯æ‰°åŠ¨    
            FOR k IN 1..dims LOOP    
                -- Box-Muller å˜æ¢ç”Ÿæˆæ­£æ€åˆ†å¸ƒéšæœºæ•°    
                u1 := random();    
                u2 := random();    
                -- æ ¸å¿ƒå…¬å¼ï¼šz0 æ˜¯å‡å€¼ä¸º0ï¼Œæ ‡å‡†å·®ä¸º1çš„éšæœºæ•°    
                z0 := sqrt(-2.0 * ln(u1)) * cos(2.0 * pi() * u2);    
                    
                -- å°†æ‰°åŠ¨å åŠ åˆ°ä¸­å¿ƒç‚¹çš„å¯¹åº”ç»´åº¦ä¸Š    
                new_vec := array_append(new_vec, center_vec[k] + (z0 * std_dev));    
            END LOOP;    
                
            INSERT INTO vector_test (embedding, is_center)     
            VALUES (new_vec::vector, FALSE);    
        END LOOP;    
    END LOOP;    
    
    RETURN 'Successfully generated ' || (center_count + center_count * points_per_center) || ' vectors.';    
END;    
$$ LANGUAGE plpgsql;    
```    
    
åˆ›å»ºæ’ä»¶å’Œæµ‹è¯•è¡¨    
    
```sql    
CREATE EXTENSION IF NOT EXISTS vector;    
    
-- åˆ›å»ºå­˜å‚¨ 8 ç»´å‘é‡çš„è¡¨    
CREATE TABLE IF NOT EXISTS vector_test (    
    id SERIAL PRIMARY KEY,    
    embedding vector(8),    
    is_center BOOLEAN -- æ ‡è®°æ˜¯å¦ä¸ºä¸­å¿ƒç‚¹ï¼Œæ–¹ä¾¿åç»­æŸ¥è¯¢    
);    
```    
    
æ¥ä¸‹æ¥ pgbench ç™»åœº    
    
2ã€å¹¶è¡Œæ’å…¥    
    
pgbench å¹¶è¡Œå†™å…¥è„šæœ¬ 1.sql     
    
```sql    
SELECT generate_vector_data(:center_count, :points_per_center, :dims, :i_std_dev);    
```    
    
ä¾‹å¦‚, å¼€10ä¸ªå¹¶è¡Œ, æ¯ä¸ªè´Ÿè´£300ä¸ªä¸­å¿ƒç‚¹, å…±3000ä¸ªä¸­å¿ƒç‚¹. æ¯ä¸ªä¸­å¿ƒç‚¹å‘¨å›´100æ¡è®°å½•. ä¸€å…±30ä¸‡æ¡è®°å½•.     
```bash    
pgbench -M prepared -n -r -f 1.sql -D center_count=300 -D points_per_center=100 -D dims=8 -D i_std_dev=0.1 -c 10 -j 10 -t 1    
```    
    
è¿”å›ç»“æœç±»ä¼¼è¿™æ ·    
```    
pgbench (18.1 (Debian 18.1-1.pgdg12+2))    
transaction type: 1.sql    
scaling factor: 1    
query mode: prepared    
number of clients: 10    
number of threads: 10    
maximum number of tries: 1    
number of transactions per client: 1    
number of transactions actually processed: 10/10    
number of failed transactions: 0 (0.000%)    
latency average = 1194.165 ms    
initial connection time = 6.721 ms    
tps = 8.374052 (without initial connection time)    
statement latencies in milliseconds and failures:    
      1173.833           0 SELECT generate_vector_data(:center_count, :points_per_center, :dims, :i_std_dev);    
```    
    
æ•°æ®æ ·æœ¬å¦‚ä¸‹    
```sql    
postgres=# select * from vector_test limit 10;    
 id |                                         embedding                                          | is_center     
----+--------------------------------------------------------------------------------------------+-----------    
  1 | [0.49148703,0.6685635,0.1687298,0.45180625,0.9960631,0.4571475,0.0034939128,0.13861603]    | t    
  2 | [0.5323792,0.5659391,0.12151991,0.4286459,1.0758449,0.6219371,0.004077115,0.034979522]     | f    
  3 | [0.47398087,0.7543278,0.4328688,0.5329106,0.986699,0.43134648,-0.052911315,-0.08437831]    | f    
  4 | [0.64157313,0.600284,0.10245401,0.31865734,0.8698451,0.3226676,0.08320826,0.22981888]      | f    
  5 | [0.47341624,0.7114847,0.17963693,0.40590957,0.94509363,0.51783043,-0.018367931,0.2058961]  | f    
  6 | [0.4226046,0.74574995,0.030126082,0.44892085,0.9216737,0.6136254,0.047382228,0.07710782]   | f    
  7 | [0.44220188,0.7145569,0.26640612,0.5712415,0.9839118,0.4472589,0.09518536,0.104707085]     | f    
  8 | [0.43854782,0.73702663,0.13283436,0.55481553,0.96476346,0.3992915,-0.054782305,0.15327796] | f    
  9 | [0.59758496,0.687787,0.16371523,0.55891865,1.13443,0.5273249,0.040264796,0.10090528]       | f    
 10 | [0.6344181,0.44873625,0.16037185,0.49058086,1.0713346,0.23812866,-0.092897125,0.16163382]  | f    
(10 rows)    
```    
    
3ã€ç´¢å¼•åˆ›å»º    
    
ä½¿ç”¨å¹¶è¡Œåˆ›å»º    
```sql    
set maintenance_work_mem ='1GB';    
set max_parallel_workers=4;    
set max_parallel_workers_per_gather =4;    
set parallel_leader_participation =off;    
set parallel_setup_cost =0;    
set parallel_tuple_cost =0;    
set min_parallel_index_scan_size =0;    
set min_parallel_table_scan_size =0;    
alter table vector_test set (parallel_workers =4);    
create index on vector_test using hnsw (embedding vector_ip_ops) with (m=16, ef_construction=64);    
```    
    
æ³¨æ„: ä¸åŒopså¯¹åº”çš„order by opä¸åŒ.    
    
4ã€æŸ¥è¯¢æ€§èƒ½    
    
```sql    
set enable_seqscan=off;    
postgres=# explain SELECT * FROM vector_test     
ORDER BY embedding <#> (SELECT embedding FROM vector_test WHERE id = 1)     
LIMIT 10;    
                                                   QUERY PLAN                                                       
----------------------------------------------------------------------------------------------------------------    
 Limit  (cost=142.56..144.77 rows=10 width=50)    
   InitPlan 1    
     ->  Index Scan using vector_test_pkey on vector_test vector_test_1  (cost=0.42..8.44 rows=1 width=37)    
           Index Cond: (id = 1)    
   ->  Index Scan using vector_test_embedding_idx on vector_test  (cost=134.12..133984.20 rows=607010 width=50)    
         Order By: (embedding <#> (InitPlan 1).col1)    
(6 rows)    
```    
    
æ•ˆæœå¦‚ä¸‹    
```sql    
postgres=# SELECT * FROM vector_test     
ORDER BY embedding <#> (SELECT embedding FROM vector_test WHERE id = 4000)     
LIMIT 10;    
   id   |                                      embedding                                       | is_center     
--------+--------------------------------------------------------------------------------------+-----------    
 406227 | [0.82450694,1.2055361,1.0173812,0.18316184,0.9584693,0.9418835,0.55990416,1.1273926] | f    
 201201 | [1.2767193,0.80783665,1.140189,0.8567347,-0.045661494,1.161669,0.92515004,0.9140229] | f    
 201944 | [1.1149577,0.7975786,1.1849692,0.9560142,0.20817277,1.0397915,1.1407607,0.9614646]   | f    
 489547 | [0.9052291,1.0715504,1.093908,0.5560693,0.69307494,1.1439734,0.86572605,0.7646792]   | f    
 200394 | [1.1373323,0.8256339,1.1670817,0.8769953,0.062202193,1.1290536,1.1055098,0.7922026]  | f    
 495815 | [0.7111623,1.0081569,0.9748361,0.20044677,0.53446907,1.0939667,0.6770205,1.2081655]  | f    
 295982 | [1.1235836,0.93014675,1.0391827,0.6902082,0.61107963,0.8564477,0.3975433,1.0953082]  | f    
 406741 | [0.77345675,1.1682146,1.1521189,0.3500558,0.9883157,0.794485,0.49730656,1.0099597]   | f    
 221776 | [1.1425776,0.89666414,0.6612843,0.7402642,0.8535777,0.975557,0.9979798,1.0486325]    | f    
 489642 | [0.8964323,1.1836767,0.8508141,0.70250076,0.7395261,1.2460623,0.9538984,0.67182827]  | f    
(10 rows)    
    
Time: 2.982 ms    
```    
    
---    
    
## å†æ¬¡å‡çº§éœ€æ±‚    
````    
> æˆ‘è¦åœ¨PostgreSQLä¸­åˆ›å»ºä¸€ä¸ªå­˜å‚¨å‘é‡çš„è¡¨, å†™ä¸€ä¸ªPostgreSQLå‡½æ•°, ç”Ÿæˆæµ‹è¯•æ•°æ®, éœ€æ±‚å¦‚ä¸‹:    
æ¯ä¸ªç»´åº¦çš„å–å€¼åŒºé—´ä¸º[0,1), ç»è¿‡æ‰°åŠ¨å¾—åˆ°çš„å€¼ä¹Ÿå¿…é¡»è½åœ¨è¿™ä¸ªåŒºé—´, å¦‚æœä¸èƒ½è½åœ¨è¿™ä¸ªåŒºé—´, æˆªå–ä¸ºä¸Šç•Œæˆ–ä¸‹ç•Œ.    
16ç»´(å¯å˜é‡è¾“å…¥).    
ç”Ÿæˆ1000ä¸ª(å¯å˜é‡è¾“å…¥)å®Œå…¨ç¦»æ•£éšæœºçš„å‘é‡.    
ç„¶åå†ä»¥è¿™1000ä¸ªå‘é‡ä¸ºä¸­å¿ƒ, ç”Ÿæˆ2000ä¸ª(å¯å˜é‡è¾“å…¥)ç¦»æ•£å‘é‡.    
æ¯ä¸ªä¸­å¿ƒç‚¹å‘¨å›´æ•°æ®çš„èšé›†æ€§ç”¨æ ‡å‡†å·®(é€šè¿‡ä¸‹é¢çš„æ–¹æ³•è®¡ç®—å¾—å‡º, å‡å€¼+æ‰°åŠ¨, ä¸”å¿…é¡»ä¸ºæ­£å€¼)æ¥è¡¨ç¤º, ç¦»ä¸­å¿ƒç‚¹è·ç¦»è¶Šè¿‘å‡ºç°æ¦‚ç‡è¶Šé«˜, è¶Šè¿œæ¦‚ç‡è¶Šä½.     
æ¯ä¸ªä¸­å¿ƒç‚¹èšé›†èµ·æ¥çš„æ•°æ®çœ‹ä½œä¸€ç±», ä¸åŒç±»çš„èšé›†æ€§å¼ºå¼±ä¹Ÿå‘ˆç°æ­£æ€åˆ†å¸ƒ. ä»£è¡¨èšé›†å¼ºå¼±çš„æ ‡å‡†å·®çš„å‡å€¼å¯å˜é‡è¾“å…¥(ä¾‹å¦‚ 0.1), åˆ†å¸ƒå¼ºå¼±å¯å˜é‡è¾“å…¥(ä¾‹å¦‚0.01);    
    
ä¸‹é¢æ˜¯æ¨¡æ¿, åŸºäºå®ƒä¿®æ”¹    
    
```sql    
CREATE OR REPLACE FUNCTION generate_vector_data(    
    center_count INT,     -- ä¸­å¿ƒç‚¹æ•°é‡ (ä¾‹å¦‚ 1000)    
    points_per_center INT, -- æ¯ä¸ªä¸­å¿ƒç‚¹å‘¨å›´ç”Ÿæˆçš„ç‚¹æ•° (ä¾‹å¦‚ 2, æ€»è®¡ 2000)    
    dims int,  -- ç»´åº¦    
    i_std_dev float8 default 0.1  -- æ ‡å‡†å·®ï¼Œå€¼è¶Šå°ç‚¹è¶Šå¯†é›†ï¼Œè¶Šå¤§ç¦»æ•£åº¦è¶Šé«˜    
) RETURNS TEXT AS $$    
DECLARE    
    center_id INT;    
    center_vec FLOAT8[];    
    new_vec FLOAT8[];    
    std_dev FLOAT8 := i_std_dev; -- æ ‡å‡†å·®ï¼Œå€¼è¶Šå°ç‚¹è¶Šå¯†é›†ï¼Œè¶Šå¤§ç¦»æ•£åº¦è¶Šé«˜    
    i INT;    
    j INT;    
    u1 FLOAT8;    
    u2 FLOAT8;    
    z0 FLOAT8;    
BEGIN    
    -- 1. ç”ŸæˆåŸå§‹çš„ç¦»æ•£éšæœºä¸­å¿ƒç‚¹    
    FOR i IN 1..center_count LOOP    
        center_vec := ARRAY(SELECT random() FROM generate_series(1, dims));    
        INSERT INTO vector_test (embedding, is_center)     
        VALUES (center_vec::vector, TRUE)    
        RETURNING id INTO center_id;    
    
        -- 2. ä»¥è¯¥ä¸­å¿ƒç‚¹ä¸ºåŸºå‡†ï¼Œç”Ÿæˆæœä»æ­£æ€åˆ†å¸ƒçš„å‘¨è¾¹ç‚¹    
        FOR j IN 1..points_per_center LOOP    
            new_vec := '{}';    
            -- å¯¹æ¯ä¸ªç»´åº¦åˆ†åˆ«è¿›è¡Œé«˜æ–¯æ‰°åŠ¨    
            FOR k IN 1..dims LOOP    
                -- Box-Muller å˜æ¢ç”Ÿæˆæ­£æ€åˆ†å¸ƒéšæœºæ•°    
                u1 := random();    
                u2 := random();    
                -- æ ¸å¿ƒå…¬å¼ï¼šz0 æ˜¯å‡å€¼ä¸º0ï¼Œæ ‡å‡†å·®ä¸º1çš„éšæœºæ•°    
                z0 := sqrt(-2.0 * ln(u1)) * cos(2.0 * pi() * u2);    
                    
                -- å°†æ‰°åŠ¨å åŠ åˆ°ä¸­å¿ƒç‚¹çš„å¯¹åº”ç»´åº¦ä¸Š    
                new_vec := array_append(new_vec, center_vec[k] + (z0 * std_dev));    
            END LOOP;    
                
            INSERT INTO vector_test (embedding, is_center)     
            VALUES (new_vec::vector, FALSE);    
        END LOOP;    
    END LOOP;    
    
    RETURN 'Successfully generated ' || (center_count + center_count * points_per_center) || ' vectors.';    
END;    
$$ LANGUAGE plpgsql;    
```    
````    
    
AI åˆä¸€æŠŠè¿‡äº†:    
    
ä½ çš„éœ€æ±‚æ¶‰åŠä»¥ä¸‹å‡ ä¸ªå…³é”®ç‚¹ï¼š    
    
1. **å‘é‡ç»´åº¦å¯å˜**ï¼ˆé»˜è®¤16ï¼‰ã€‚    
2. **æ¯ä¸ªä¸­å¿ƒç‚¹å®Œå…¨ç¦»æ•£éšæœº**ï¼ˆå–å€¼ âˆˆ [0,1)ï¼‰ã€‚    
3. **å›´ç»•æ¯ä¸ªä¸­å¿ƒç‚¹ç”Ÿæˆèšé›†ç‚¹**ï¼š    
   - ä½¿ç”¨æ­£æ€åˆ†å¸ƒæ‰°åŠ¨ï¼ˆå‡å€¼=ä¸­å¿ƒç‚¹å€¼ï¼Œæ ‡å‡†å·®=æŸä¸ªç±»å†…æ ‡å‡†å·®ï¼‰ã€‚    
   - æ‰°åŠ¨åå€¼å¿…é¡» âˆˆ [0,1)ï¼Œå¦åˆ™æˆªæ–­åˆ° [0,1)ã€‚    
4. **æ¯ä¸ªä¸­å¿ƒç‚¹çš„ç±»å†…æ ‡å‡†å·®æœ¬èº«æœä»æ­£æ€åˆ†å¸ƒ**ï¼š    
   - å‡å€¼ = `std_dev_mean`ï¼ˆå¦‚ 0.1ï¼‰    
   - æ ‡å‡†å·® = `std_dev_sigma`ï¼ˆå¦‚ 0.01ï¼‰    
   - ä¸”æ ‡å‡†å·®å¿…é¡»ä¸ºæ­£ï¼ˆæˆªæ–­åˆ° > 0ï¼‰ã€‚    
5. **æ”¯æŒ PostgreSQL `vector` ç±»å‹**ï¼ˆéœ€å®‰è£… `pgvector` æ‰©å±•ï¼‰ã€‚    
    
    
### âœ… ä¿®æ”¹è¯´æ˜    
- ä¿®æ”¹å‡½æ•°ç­¾åå¢åŠ  `std_dev_mean` å’Œ `std_dev_sigma`ã€‚    
- åœ¨æ¯è½®ç”Ÿæˆä¸­å¿ƒç‚¹æ—¶ï¼Œ**ä¸ºè¯¥ä¸­å¿ƒç‚¹ç”Ÿæˆç‹¬ç«‹çš„ç±»å†…æ ‡å‡†å·®** `local_std_dev`ã€‚    
- å¯¹æ¯ä¸ªæ‰°åŠ¨åçš„ç»´åº¦å€¼åš **[0,1) æˆªæ–­**ã€‚    
- ä½¿ç”¨ `GREATEST(0, LEAST(1 - 1e-9, value))` ç¡®ä¿ä¸¥æ ¼åœ¨ [0,1)ã€‚    
- æå‰æ£€æŸ¥ `vector` ç±»å‹æ˜¯å¦å­˜åœ¨ï¼ˆå¦åˆ™ä¼šæŠ¥é”™ï¼‰ã€‚    
    
    
    
### âœ… ä¿®æ”¹åçš„å®Œæ•´å‡½æ•°    
    
```sql    
-- ç¡®ä¿å·²å®‰è£… pgvector æ‰©å±•ï¼ˆå¦‚æœªå®‰è£…ï¼Œè¯·å…ˆæ‰§è¡Œï¼šCREATE EXTENSION IF NOT EXISTS vector;ï¼‰    
-- è¡¨ç»“æ„ç¤ºä¾‹ï¼ˆè¯·å…ˆåˆ›å»ºï¼‰ï¼š    
-- CREATE TABLE vector_test (    
--     id SERIAL PRIMARY KEY,    
--     embedding VECTOR,    
--     is_center BOOLEAN,    
--     center_id INT    
-- );    
    
CREATE OR REPLACE FUNCTION generate_vector_data(    
    center_count INT,          -- ä¸­å¿ƒç‚¹æ•°é‡ (ä¾‹å¦‚ 1000)    
    points_per_center INT,     -- æ¯ä¸ªä¸­å¿ƒç‚¹å‘¨å›´ç”Ÿæˆçš„ç‚¹æ•° (ä¾‹å¦‚ 2 â†’ æ€»è®¡ 2000)    
    dims INT,                  -- å‘é‡ç»´åº¦ï¼ˆä¾‹å¦‚ 16ï¼‰    
    std_dev_mean FLOAT8 DEFAULT 0.1,    -- ç±»å†…æ ‡å‡†å·®çš„å‡å€¼    
    std_dev_sigma FLOAT8 DEFAULT 0.01   -- ç±»å†…æ ‡å‡†å·®çš„åˆ†å¸ƒæ ‡å‡†å·®ï¼ˆå³â€œèšé›†æ€§å¼ºå¼±â€çš„æ³¢åŠ¨ï¼‰    
) RETURNS TEXT AS $$    
DECLARE    
    center_id INT;    
    center_vec FLOAT8[];    
    new_vec FLOAT8[];    
    local_std_dev FLOAT8;      -- æ¯ä¸ªä¸­å¿ƒç‚¹è‡ªå·±çš„ç±»å†…æ ‡å‡†å·®    
    perturbed_val FLOAT8;    
    i INT;    
    j INT;    
    k INT;    
    u1 FLOAT8;    
    u2 FLOAT8;    
    z0 FLOAT8;    
    z_std FLOAT8;              -- ç”¨äºç”Ÿæˆ local_std_dev çš„æ­£æ€æ‰°åŠ¨    
BEGIN    
    -- 1. ç”Ÿæˆ center_count ä¸ªå®Œå…¨ç¦»æ•£éšæœºçš„ä¸­å¿ƒç‚¹    
    FOR i IN 1..center_count LOOP    
        -- ç”Ÿæˆ d ç»´ [0,1) éšæœºå‘é‡ä½œä¸ºä¸­å¿ƒ    
        center_vec := ARRAY(SELECT random() FROM generate_series(1, dims));    
    
        -- ä¸ºå½“å‰ä¸­å¿ƒç‚¹ç”Ÿæˆå…¶â€œç±»å†…æ ‡å‡†å·®â€ï¼šN(std_dev_mean, std_dev_sigma)ï¼Œä½†å¿…é¡» > 0    
        LOOP    
            u1 := random();    
            u2 := random();    
            -- é¿å…é™¤é›¶    
            IF u1 = 0 THEN u1 := 1e-10; END IF;    
            z_std := sqrt(-2.0 * ln(u1)) * cos(2.0 * pi() * u2);    
            local_std_dev := std_dev_mean + z_std * std_dev_sigma;    
            EXIT WHEN local_std_dev > 0;  -- ç¡®ä¿æ ‡å‡†å·®ä¸ºæ­£    
        END LOOP;    
    
        -- æ’å…¥ä¸­å¿ƒç‚¹    
        INSERT INTO vector_test (embedding, is_center)    
        VALUES (center_vec::vector, TRUE)    
        RETURNING id INTO center_id;    
    
        -- 2. å›´ç»•è¯¥ä¸­å¿ƒç‚¹ç”Ÿæˆ points_per_center ä¸ªèšé›†ç‚¹    
        FOR j IN 1..points_per_center LOOP    
            new_vec := '{}';    
            FOR k IN 1..dims LOOP    
                -- ç”Ÿæˆæ ‡å‡†æ­£æ€æ‰°åŠ¨    
                u1 := random();    
                u2 := random();    
                IF u1 = 0 THEN u1 := 1e-10; END IF;    
                z0 := sqrt(-2.0 * ln(u1)) * cos(2.0 * pi() * u2);    
    
                -- æ‰°åŠ¨ = ä¸­å¿ƒå€¼ + N(0, local_std_dev)    
                perturbed_val := center_vec[k] + z0 * local_std_dev;    
    
                -- æˆªæ–­åˆ° [0, 1)    
                -- ä½¿ç”¨ 1 - 1e-9 é¿å…ç­‰äº 1ï¼ˆå›  random() æœ¬èº« <1ï¼Œä½†æ‰°åŠ¨å¯èƒ½ >=1ï¼‰    
                perturbed_val := GREATEST(0.0, LEAST(1.0 - 1e-9, perturbed_val));    
    
                new_vec := array_append(new_vec, perturbed_val);    
            END LOOP;    
    
            -- æ’å…¥éä¸­å¿ƒç‚¹ï¼Œå¹¶å¯é€‰è®°å½• center_idï¼ˆä¾¿äºåç»­åˆ†æï¼‰    
            INSERT INTO vector_test (embedding, is_center, center_id)    
            VALUES (new_vec::vector, FALSE, center_id);    
        END LOOP;    
    END LOOP;    
    
    RETURN 'Successfully generated ' ||    
           (center_count + center_count * points_per_center)::TEXT ||    
           ' vectors (' || center_count || ' centers + ' ||    
           (center_count * points_per_center) || ' neighbors).';    
END;    
$$ LANGUAGE plpgsql;    
```    
    
    
### âœ… ä½¿ç”¨ç¤ºä¾‹    
    
```sql    
-- ç”Ÿæˆ 1000 ä¸ªä¸­å¿ƒç‚¹ï¼Œæ¯ä¸ªä¸­å¿ƒç”Ÿæˆ 2 ä¸ªé‚»å±…ï¼ˆå…± 3000 æ¡è®°å½•ï¼‰    
-- 16 ç»´ï¼Œç±»å†…æ ‡å‡†å·®å‡å€¼=0.1ï¼Œæ³¢åŠ¨=0.01    
SELECT generate_vector_data(    
    center_count => 1000,    
    points_per_center => 2,    
    dims => 16,    
    std_dev_mean => 0.1,    
    std_dev_sigma => 0.01    
);    
```    
    
    
    
### âœ… æ³¨æ„äº‹é¡¹    
    
1. **`pgvector` æ‰©å±•å¿…é¡»å®‰è£…**ï¼š    
   ```sql    
   CREATE EXTENSION IF NOT EXISTS vector;    
   ```    
    
2. **è¡¨ç»“æ„éœ€åŒ…å« `center_id` å­—æ®µ**ï¼ˆç”¨äºè¿½è¸ªæ¯ä¸ªç‚¹å±äºå“ªä¸ªä¸­å¿ƒï¼‰ï¼š    
   ```sql    
   CREATE TABLE vector_test (    
       id SERIAL PRIMARY KEY,    
       embedding VECTOR,    
       is_center BOOLEAN,    
       center_id INT    
   );    
   ```    
    
3. **æ€§èƒ½æç¤º**ï¼šç”Ÿæˆ 3000 æ¡è®°å½•å¾ˆå¿«ï¼Œä½†è‹¥æ•°é‡æå¤§ï¼ˆå¦‚ 100 ä¸‡ï¼‰ï¼Œå»ºè®®åˆ†æ‰¹æˆ–ä½¿ç”¨æ›´é«˜æ•ˆæ–¹æ³•ï¼ˆå¦‚ `generate_series` + `CROSS JOIN LATERAL`ï¼‰ï¼Œä½†å½“å‰å‡½æ•°ç»“æ„æ¸…æ™°ï¼Œé€‚åˆä¸­å°è§„æ¨¡æµ‹è¯•æ•°æ®ã€‚    
    
4. **æˆªæ–­å¤„ç†**ï¼šä½¿ç”¨ `1 - 1e-9` ç¡®ä¿æœ€ç»ˆå€¼ä¸¥æ ¼å°äº 1ï¼Œç¬¦åˆ `[0,1)` è¦æ±‚ã€‚    
    
---    
    
## é‡æ–°æ’å…¥å‹æµ‹    
    
å‡è®¾ä»¥ä¸Šå‡½æ•°å’Œvectoræ’ä»¶éƒ½å·²å®‰è£….    
    
1ã€å»ºè¡¨    
    
```sql    
  drop table if exists vector_test;    
    
-- åˆ›å»ºå­˜å‚¨ 8 ç»´å‘é‡çš„è¡¨    
   CREATE TABLE vector_test (    
       id SERIAL PRIMARY KEY,    
       embedding VECTOR(8),    
       is_center BOOLEAN,    
       center_id INT    
   );    
```    
    
æ¥ä¸‹æ¥ pgbench ç™»åœº    
    
2ã€å¹¶è¡Œæ’å…¥    
    
pgbench å¹¶è¡Œå†™å…¥è„šæœ¬ 1.sql     
    
```sql    
SELECT generate_vector_data(    
    :center_count,    
    :points_per_center,    
    :dims,    
    :std_dev_mean,    
    :std_dev_sigma    
);    
```    
    
ä¾‹å¦‚, å¼€10ä¸ªå¹¶è¡Œ, æ¯ä¸ªè´Ÿè´£300ä¸ªä¸­å¿ƒç‚¹, å…±3000ä¸ªä¸­å¿ƒç‚¹. æ¯ä¸ªä¸­å¿ƒç‚¹å‘¨å›´100æ¡è®°å½•. ä¸€å…±30ä¸‡æ¡è®°å½•.     
```bash    
pgbench -M prepared -n -r -f 1.sql -D center_count=300 -D points_per_center=100 -D dims=8 -D std_dev_mean=0.1 -D std_dev_sigma=0.01 -c 10 -j 10 -t 1    
```    
    
è¿”å›ç»“æœç±»ä¼¼è¿™æ ·, åˆæ˜¯1ç§’, å®Œæˆ30ä¸‡å†™å…¥.      
```    
pgbench (18.1 (Debian 18.1-1.pgdg12+2))    
transaction type: 1.sql    
scaling factor: 1    
query mode: prepared    
number of clients: 10    
number of threads: 10    
maximum number of tries: 1    
number of transactions per client: 1    
number of transactions actually processed: 10/10    
number of failed transactions: 0 (0.000%)    
latency average = 1275.373 ms    
initial connection time = 7.123 ms    
tps = 7.840843 (without initial connection time)    
statement latencies in milliseconds and failures:    
      1254.682           0 SELECT generate_vector_data(    
```    
    
æ•°æ®æ ·æœ¬å¦‚ä¸‹    
```sql    
postgres=# select * from vector_test limit 10;    
 id |                                         embedding                                          | is_center | center_id     
----+--------------------------------------------------------------------------------------------+-----------+-----------    
  1 | [0.17105481,0.111848384,0.9117258,0.5306894,0.11807599,0.14844997,0.46155128,0.30024847]   | t         |              
 11 | [0.03813838,0.16296498,0.8372399,0.54524916,0.028416384,0.12848008,0.32547304,0.1947173]   | f         |         1    
 12 | [0,0.044231616,1,0.58943826,0.22524321,0,0.41637287,0.48733392]                            | f         |         1    
 13 | [0.18737471,0,0.9368977,0.54700387,0,0.18523008,0.43912503,0.40527853]                     | f         |         1    
 14 | [0.076122984,0.07140395,0.9845732,0.42619815,0.05465484,0.45531052,0.34961346,0.31409928]  | f         |         1    
 15 | [0.11690144,0.0030454656,0.89362085,0.4849689,0.2529286,0.19872168,0.48759928,0.39344427]  | f         |         1    
 17 | [0.090135045,0.19393651,1,0.62053615,0.1905218,0.005123274,0.5673879,0.24511307]           | f         |         1    
 19 | [0.25191787,0.29603916,0.914537,0.5292521,0,0.10356969,0.4150836,0.2541691]                | f         |         1    
 20 | [0.22760004,0.22169718,1,0.3778331,0,0.21047452,0.29598284,0.29152873]                     | f         |         1    
 22 | [0.013735059,0.12628518,0.7749661,0.44492537,0.13536552,0.065305255,0.48517403,0.25436395] | f         |         1    
(10 rows)    
```    
    
3ã€ç´¢å¼•åˆ›å»º    
    
ä½¿ç”¨å¹¶è¡Œåˆ›å»º    
```sql    
set maintenance_work_mem ='1GB';    
set max_parallel_workers=4;    
set max_parallel_workers_per_gather =4;    
set parallel_leader_participation =off;    
set parallel_setup_cost =0;    
set parallel_tuple_cost =0;    
set min_parallel_index_scan_size =0;    
set min_parallel_table_scan_size =0;    
alter table vector_test set (parallel_workers =4);    
create index on vector_test using hnsw (embedding vector_l2_ops) with (m=16, ef_construction=64);    
```    
    
æ³¨æ„: ä¸åŒopså¯¹åº”çš„order by opä¸åŒ.    
    
4ã€æŸ¥è¯¢æ€§èƒ½    
    
```sql    
set enable_seqscan=off;    
explain SELECT * FROM vector_test     
ORDER BY embedding <-> (SELECT embedding FROM vector_test WHERE id = 11)     
LIMIT 10;    
    
                                                  QUERY PLAN                                                       
---------------------------------------------------------------------------------------------------------------    
 Limit  (cost=136.12..138.32 rows=10 width=54)    
   InitPlan 1    
     ->  Index Scan using vector_test_pkey on vector_test vector_test_1  (cost=0.42..8.44 rows=1 width=37)    
           Index Cond: (id = 11)    
   ->  Index Scan using vector_test_embedding_idx on vector_test  (cost=127.68..66880.00 rows=303000 width=54)    
         Order By: (embedding <-> (InitPlan 1).col1)    
(6 rows)    
```    
    
æ•ˆæœå¦‚ä¸‹, ç¬¦åˆé¢„æœŸ, æœ‰ä¸€äº›å¤–å›´çš„ç‚¹å¯èƒ½ç¦»å…¶ä»–ä¸­å¿ƒç‚¹æ›´è¿‘, ä¾‹å¦‚11æ˜æ˜¾ç¦»3057ä¸­å¿ƒç‚¹çš„å€¼æ›´è¿‘.     
```sql    
SELECT * FROM vector_test     
ORDER BY embedding <-> (SELECT embedding FROM vector_test WHERE id = 11)     
LIMIT 10;    
    
  id  |                                         embedding                                          | is_center | center_id     
------+--------------------------------------------------------------------------------------------+-----------+-----------    
   11 | [0.03813838,0.16296498,0.8372399,0.54524916,0.028416384,0.12848008,0.32547304,0.1947173]   | f         |         1    
 3196 | [0,0.09366788,0.836875,0.58805025,0,0.21278407,0.35584888,0.20035924]                      | f         |      3057    
 3307 | [0.04267441,0.15442768,0.78668106,0.651847,0,0.19336444,0.26290196,0.24046999]             | f         |      3057    
  216 | [0.11530078,0.17141855,0.97688466,0.53638417,0.05041965,0.078720815,0.3156914,0.19801213]  | f         |         1    
 3335 | [0.047988825,0.11678319,0.83546025,0.65561557,0.13624333,0.12582546,0.27382517,0.27172136] | f         |      3057    
 3321 | [0,0.14111617,0.85898143,0.71950036,0.04036658,0.17692095,0.32247683,0.1792223]            | f         |      3057    
 3107 | [0.057837497,0.03539711,0.82344323,0.6507534,0,0.052208096,0.2913429,0.18517697]           | f         |      3057    
 3475 | [0.09501218,0.2220129,0.81840885,0.61479205,0.15981476,0.18752795,0.38180515,0.18915245]   | f         |      3057    
 3327 | [0.13987818,0.21751888,0.702564,0.58499944,0,0.19195952,0.33919933,0.1812846]              | f         |      3057    
 3083 | [0.035972517,0.28071767,0.77004033,0.61820525,0.15739723,0.12367443,0.3413193,0.2037563]   | f         |      3057    
(10 rows)    
    
    
SELECT * FROM vector_test     
ORDER BY embedding <-> (SELECT embedding FROM vector_test WHERE id = 1)     
LIMIT 10;    
 id  |                                         embedding                                         | is_center | center_id     
-----+-------------------------------------------------------------------------------------------+-----------+-----------    
   1 | [0.17105481,0.111848384,0.9117258,0.5306894,0.11807599,0.14844997,0.46155128,0.30024847]  | t         |              
 193 | [0.16777094,0.1642298,0.901199,0.44624943,0.12807207,0.16980569,0.4750887,0.31381938]     | f         |         1    
 166 | [0.120463744,0.07280951,0.89771175,0.43667313,0.055246145,0.1371449,0.46776408,0.3631755] | f         |         1    
 152 | [0.2367722,0.14152765,1,0.5200618,0.1269453,0.085524425,0.40181518,0.2423237]             | f         |         1    
 158 | [0.14158644,0.22342859,0.955126,0.6240514,0.14849429,0.114813514,0.4535238,0.33608654]    | f         |         1    
 148 | [0.25239626,0.1525642,0.8130709,0.5330656,0.19565046,0.1114626,0.42059937,0.27454346]     | f         |         1    
 163 | [0.23277406,0.093285546,0.9140603,0.60804856,0.11022406,0.06361267,0.522467,0.38165015]   | f         |         1    
 199 | [0.24088658,0.25373772,0.88065875,0.52698815,0.06798484,0.13525315,0.4353099,0.28811255]  | f         |         1    
 188 | [0.18140465,0,1,0.5817445,0.13569641,0.15472418,0.5248301,0.352165]                       | f         |         1    
 165 | [0.13854088,0.083053984,1,0.5690327,0,0.07870037,0.4946139,0.31971732]                    | f         |         1    
(10 rows)    
```    
      
---  
  
# é™„å½•: PolarDB æ¯”èµ›ç”¨ä¾‹    
å¦‚æœæ‰“PolarDBæ¯”èµ›, æœ¬æ–‡ä¹Ÿéå¸¸é€‚ç”¨.   
  
å¯é‡‡ç”¨å¦‚ä¸‹ç»“æ„å’Œæ–¹æ³•ç”Ÿæˆæ•°æ®.      
    
ä½¿ç”¨äº†vectorå’Œvchord 2ç§æ’ä»¶, å¯å¯¹æ¯”ä¸¤ç§æ’ä»¶çš„æ•ˆæœ.    
    
## è¡¨ç»“æ„, ç”Ÿæˆå‡½æ•°, ç”Ÿæˆæ•°æ®   
200ç»´åº¦halfvecç±»å‹    
```sql    
create extension if not exists vector;    
create extension if not exists vchord;    
drop table if exists vector_test;    
set polar_force_unlogged_to_logged_table=off;    
CREATE unlogged TABLE vector_test (        
    id SERIAL PRIMARY KEY,        
    embedding halfvec(200),        
    is_center BOOLEAN,        
    center_id INT        
);        
```    
    
ç”Ÿæˆå‡½æ•°    
```      
CREATE OR REPLACE FUNCTION generate_vector_data(        
    center_count INT,          -- ä¸­å¿ƒç‚¹æ•°é‡ (ä¾‹å¦‚ 1000)        
    points_per_center INT,     -- æ¯ä¸ªä¸­å¿ƒç‚¹å‘¨å›´ç”Ÿæˆçš„ç‚¹æ•° (ä¾‹å¦‚ 2 â†’ æ€»è®¡ 2000)        
    dims INT,                  -- å‘é‡ç»´åº¦ï¼ˆä¾‹å¦‚ 16ï¼‰        
    std_dev_mean FLOAT8 DEFAULT 0.1,    -- ç±»å†…æ ‡å‡†å·®çš„å‡å€¼        
    std_dev_sigma FLOAT8 DEFAULT 0.01   -- ç±»å†…æ ‡å‡†å·®çš„åˆ†å¸ƒæ ‡å‡†å·®ï¼ˆå³â€œèšé›†æ€§å¼ºå¼±â€çš„æ³¢åŠ¨ï¼‰        
) RETURNS TEXT AS $$        
DECLARE        
    center_id INT;        
    center_vec FLOAT8[];        
    new_vec FLOAT8[];        
    local_std_dev FLOAT8;      -- æ¯ä¸ªä¸­å¿ƒç‚¹è‡ªå·±çš„ç±»å†…æ ‡å‡†å·®        
    perturbed_val FLOAT8;        
    i INT;        
    j INT;        
    k INT;        
    u1 FLOAT8;        
    u2 FLOAT8;        
    z0 FLOAT8;        
    z_std FLOAT8;              -- ç”¨äºç”Ÿæˆ local_std_dev çš„æ­£æ€æ‰°åŠ¨        
BEGIN        
    -- 1. ç”Ÿæˆ center_count ä¸ªå®Œå…¨ç¦»æ•£éšæœºçš„ä¸­å¿ƒç‚¹        
    FOR i IN 1..center_count LOOP        
        -- ç”Ÿæˆ d ç»´ [0,1) éšæœºå‘é‡ä½œä¸ºä¸­å¿ƒ        
        center_vec := ARRAY(SELECT random() FROM generate_series(1, dims));        
        
        -- ä¸ºå½“å‰ä¸­å¿ƒç‚¹ç”Ÿæˆå…¶â€œç±»å†…æ ‡å‡†å·®â€ï¼šN(std_dev_mean, std_dev_sigma)ï¼Œä½†å¿…é¡» > 0        
        LOOP        
            u1 := random();        
            u2 := random();        
            -- é¿å…é™¤é›¶        
            IF u1 = 0 THEN u1 := 1e-10; END IF;        
            z_std := sqrt(-2.0 * ln(u1)) * cos(2.0 * pi() * u2);        
            local_std_dev := std_dev_mean + z_std * std_dev_sigma;        
            EXIT WHEN local_std_dev > 0;  -- ç¡®ä¿æ ‡å‡†å·®ä¸ºæ­£        
        END LOOP;        
        
        -- æ’å…¥ä¸­å¿ƒç‚¹        
        INSERT INTO vector_test (embedding, is_center)        
        VALUES (center_vec::halfvec, TRUE)        
        RETURNING id INTO center_id;        
        
        -- 2. å›´ç»•è¯¥ä¸­å¿ƒç‚¹ç”Ÿæˆ points_per_center ä¸ªèšé›†ç‚¹        
        FOR j IN 1..points_per_center LOOP        
            new_vec := '{}';        
            FOR k IN 1..dims LOOP        
                -- ç”Ÿæˆæ ‡å‡†æ­£æ€æ‰°åŠ¨        
                u1 := random();        
                u2 := random();        
                IF u1 = 0 THEN u1 := 1e-10; END IF;        
                z0 := sqrt(-2.0 * ln(u1)) * cos(2.0 * pi() * u2);        
        
                -- æ‰°åŠ¨ = ä¸­å¿ƒå€¼ + N(0, local_std_dev)        
                perturbed_val := center_vec[k] + z0 * local_std_dev;        
        
                -- æˆªæ–­åˆ° [0, 1)        
                -- ä½¿ç”¨ 1 - 1e-9 é¿å…ç­‰äº 1ï¼ˆå›  random() æœ¬èº« <1ï¼Œä½†æ‰°åŠ¨å¯èƒ½ >=1ï¼‰        
                perturbed_val := GREATEST(0.0, LEAST(1.0 - 1e-9, perturbed_val));        
        
                new_vec := array_append(new_vec, perturbed_val);        
            END LOOP;        
        
            -- æ’å…¥éä¸­å¿ƒç‚¹ï¼Œå¹¶å¯é€‰è®°å½• center_idï¼ˆä¾¿äºåç»­åˆ†æï¼‰        
            INSERT INTO vector_test (embedding, is_center, center_id)        
            VALUES (new_vec::halfvec, FALSE, center_id);        
        END LOOP;        
    END LOOP;        
        
    RETURN 'Successfully generated ' ||        
           (center_count + center_count * points_per_center)::TEXT ||        
           ' vectors (' || center_count || ' centers + ' ||        
           (center_count * points_per_center) || ' neighbors).';        
END;        
$$ LANGUAGE plpgsql;      
```    
    
ä½¿ç”¨pgbench å®šåˆ¶è„šæœ¬ç”Ÿæˆæ•°æ®    
1\.sql    
```sql    
SELECT generate_vector_data(        
    :center_count,        
    :points_per_center,        
    :dims,        
    :std_dev_mean,        
    :std_dev_sigma        
);      
```    
    
10ä¸ªè¿›ç¨‹, æ¯ä¸ªè´Ÿè´£100ä¸ªä¸­å¿ƒç‚¹, æ¯ä¸ªä¸­å¿ƒç‚¹é™„è¿‘999æ¡. å…±100ä¸‡æ¡è®°å½•(æ¯”èµ›æ˜¯1000ä¸‡æ¡, åªè¦æ”¹æˆ`center_count=1000`):    
```bash    
pgbench -M prepared -n -r -f 1.sql -D center_count=100 -D points_per_center=999 -D dims=200 -D std_dev_mean=0.1 -D std_dev_sigma=0.01 -c 10 -j 10 -t 1    
```    
  
ç¡®è®¤ç©ºé—´å ç”¨æƒ…å†µ  
```sql  
postgres=# \dt+  
                                      List of relations  
 Schema |    Name     | Type  |  Owner   | Persistence | Access method |  Size  | Description   
--------+-------------+-------+----------+-------------+---------------+--------+-------------  
 public | vector_test | table | postgres | unlogged    | heap          | 436 MB |   
(1 row)  
```  
    
æ¥ä¸‹æ¥åˆ›å»ºvchordrqã€vector hnswç´¢å¼•, å¯¹æ¯”æ„å»ºè€—æ—¶å’ŒåŒç­‰recallä¸‹çš„æŸ¥è¯¢rt.    
  
## vector æ’ä»¶  
  
åˆ›å»ºhnswç´¢å¼•è€—æ—¶624ç§’  
```  
\timing  
set maintenance_work_mem='1GB'; -- ç¡®ä¿å¤§äºè¡¨, ç¡®ä¿å…¨å†…å­˜å›¾æ„å»º  
create index on vector_test using hnsw (embedding halfvec_l2_ops) with (m=16, ef_construction=64);  
  
  
NOTICE:  hnsw graph no longer fits into maintenance_work_mem after 981158 tuples  
DETAIL:  Building will take significantly more time.  
HINT:  Increase maintenance_work_mem to speed up builds.  
CREATE INDEX  
Time: 624490.780 ms (10:24.491)  
```  
  
ç´¢å¼•ç©ºé—´å ç”¨æƒ…å†µ  
```  
postgres=# \di+  
                                                    List of relations  
 Schema |           Name            | Type  |  Owner   |    Table    | Persistence | Access method |  Size  | Description   
--------+---------------------------+-------+----------+-------------+-------------+---------------+--------+-------------  
 public | vector_test_embedding_idx | index | postgres | vector_test | unlogged    | hnsw          | 710 MB |   
 public | vector_test_pkey          | index | postgres | vector_test | unlogged    | btree         | 22 MB  |   
(2 rows)  
```  
  
æŸ¥è¯¢æ€§èƒ½  
```  
set enable_seqscan=off;  
set enable_bitmapscan=off;  
set enable_indexscan=on;  
SET hnsw.ef_search = 50;  
explain analyze SELECT ctid from vector_test   
  order by embedding <-> (select embedding from vector_test where id=1234) limit 20;  
  
å¤šè·‘å‡ é, å–å®Œå…¨ç¼“å­˜åçš„ç»“æœ  
postgres=# explain analyze SELECT ctid from vector_test   
  order by embedding <-> (select embedding from vector_test where id=1234) limit 20;  
                                                                         QUERY PLAN                                                                           
------------------------------------------------------------------------------------------------------------------------------------------------------------  
 Limit  (cost=363.51..375.65 rows=20 width=14) (actual time=3.790..3.897 rows=20 loops=1)  
   InitPlan 1 (returns $0)  
     ->  Index Scan using vector_test_pkey on vector_test vector_test_1  (cost=0.42..8.44 rows=1 width=408) (actual time=0.108..0.112 rows=1 loops=1)  
           Index Cond: (id = 1234)  
   ->  Index Scan using vector_test_embedding_idx on vector_test  (cost=355.07..606876.00 rows=1000000 width=14) (actual time=3.786..3.888 rows=20 loops=1)  
         Order By: (embedding <-> $0)  
 Planning Time: 0.624 ms  
 Execution Time: 4.068 ms  
(8 rows)  
  
Time: 6.144 ms  
```  
  
```  
SELECT ctid,embedding <-> (select embedding from vector_test where id=1234) from vector_test  
  order by embedding <-> (select embedding from vector_test where id=1234) limit 20;  
  
   ctid   |      ?column?        
----------+--------------------  
 (66,14)  |                  0  
 (0,4)    | 1.5019497121070213  
 (328,6)  |   1.81446225725551  
 (364,2)  | 1.8404459686514545  
 (414,15) |  1.842976618059091  
 (341,2)  | 1.8530746916299405  
 (414,10) | 1.8559437354619455  
 (466,12) |  1.867700673853722  
 (382,13) |  1.870166142472818  
 (173,15) |  1.874870995216205  
 (307,8)  | 1.8803078227962111  
 (338,5)  | 1.8821173686604808  
 (173,13) | 1.8866303543644682  
 (240,1)  | 1.8932781046996845  
 (206,8)  | 1.8969184229498157  
 (354,9)  | 1.9089846147943372  
 (173,9)  |  1.909559659878426  
 (42,3)   |  1.911150277768943  
 (350,9)  |  1.917677163764015  
 (476,12) | 1.9190222804817116  
(20 rows)  
  
Time: 5.638 ms  
```  
  
recall è®¡ç®—  
```  
create temp table hnsw_indexscan (id tid) ON COMMIT PRESERVE ROWS;  
create temp table hnsw_seqscan (id tid) ON COMMIT PRESERVE ROWS;  
  
  
  
BEGIN;  
SET LOCAL enable_seqscan = off;  
set LOCAL enable_bitmapscan = off;  
set LOCAL enable_indexscan = on;  
SET hnsw.ef_search = 50;  
  
insert into hnsw_indexscan   
SELECT ctid from vector_test   
  order by embedding <-> (select embedding from vector_test where id=1234) limit 20;  
  
SET LOCAL enable_seqscan = on;    
set LOCAL enable_bitmapscan = off;  
set LOCAL enable_indexscan = off;  
  
insert into hnsw_seqscan   
SELECT ctid from vector_test   
  order by embedding <-> (select embedding from vector_test where id=1234) limit 20;  
COMMIT;  
  
  
with recall as (  
  select count(*)::numeric as cnt from hnsw_indexscan join hnsw_seqscan using (id)  
),   
seqscan as (  
 select count(*)::numeric as cnt from hnsw_seqscan  
)  
select recall.cnt/seqscan.cnt as recall from recall,seqscan;  
  
  
 recall   
--------  
      1.00000  
(1 row)  
```  
  
è¿”å›1, è¯´æ˜æœ‰100%å¬å›.  
  
  
## vchord æ’ä»¶  
  
vchordrq ä¸æ”¯æŒunlogged table? æ”¹ç”¨logged table.  
```  
set polar_force_unlogged_to_logged_table=off;    
CREATE TABLE vector_test_vchord (      
    id int PRIMARY KEY,    
    embedding halfvec(200),        
    is_center BOOLEAN,        
    center_id INT        
);     
insert into vector_test_vchord select * from vector_test;  
```  
  
åˆ›å»ºç´¢å¼•è€—æ—¶38ç§’  
```  
\timing  
set maintenance_work_mem='1GB'; -- å…¬å¹³èµ·è§å’Œvectorè®¾ç½®ä¸€æ ·, å®é™…ä¸Švchordrqä¸éœ€è¦è¿™ä¹ˆå¤šå†…å­˜.  
  
create index on vector_test_vchord using vchordrq (embedding halfvec_l2_ops) with (  
options = $$  
residual_quantization = true  
[build.internal]  
lists = [500]  
spherical_centroids = true  
build_threads = 8  
kmeans_algorithm.hierarchical = {}  
[build]  
pin = 2  
$$);  
  
  
INFO:  clustering: estimated memory usage is 101.09 MiB  
INFO:  clustering: using 8 threads  
INFO:  clustering: starting, clustering 128000 vectors of 200 dimension into 500 clusters, in 10 iterations  
INFO:  clustering: iteration 1  
INFO:  clustering: iteration 2  
INFO:  clustering: iteration 3  
INFO:  clustering: iteration 4  
INFO:  clustering: iteration 5  
INFO:  clustering: iteration 6  
INFO:  clustering: iteration 7  
INFO:  clustering: iteration 8  
INFO:  clustering: iteration 9  
INFO:  clustering: iteration 10  
INFO:  clustering: finished  
INFO:  maintain: number_of_formerly_allocated_pages = 0  
INFO:  maintain: number_of_formerly_allocated_pages = 0  
INFO:  maintain: number_of_freshly_allocated_pages = 50  
INFO:  maintain: number_of_freed_pages = 894  
INFO:  maintain: number_of_freshly_allocated_pages = 21  
INFO:  maintain: number_of_freed_pages = 925  
INFO:  maintain: number_of_formerly_allocated_pages = 0  
INFO:  maintain: number_of_freshly_allocated_pages = 15  
INFO:  maintain: number_of_freed_pages = 892  
CREATE INDEX  
Time: 37919.309 ms (00:37.919)  
```  
  
ç´¢å¼•å ç”¨ç©ºé—´æ¯”vectoræ›´å°  
```  
postgres=# \di+  
                                                           List of relations  
 Schema |               Name               | Type  |  Owner   |       Table        | Persistence | Access method |  Size  | Description   
--------+----------------------------------+-------+----------+--------------------+-------------+---------------+--------+-------------  
 public | vector_test_embedding_idx        | index | postgres | vector_test        | unlogged    | hnsw          | 710 MB |   
 public | vector_test_pkey                 | index | postgres | vector_test        | unlogged    | btree         | 22 MB  |   
 public | vector_test_vchord_embedding_idx | index | postgres | vector_test_vchord | permanent   | vchordrq      | 507 MB |   
 public | vector_test_vchord_pkey          | index | postgres | vector_test_vchord | permanent   | btree         | 24 MB  |   
(4 rows)  
```  
  
æŸ¥è¯¢æ€§èƒ½  
```  
set enable_seqscan=off;  
set enable_bitmapscan=off;  
set enable_indexscan=on;  
SET vchordrq.probes = '1';  
SET vchordrq.epsilon = 1.0;  
explain analyze SELECT ctid from vector_test_vchord   
  order by embedding <-> (select embedding from vector_test_vchord where id=1234) limit 20;  
  
å¤šè·‘å‡ é, å–å®Œå…¨ç¼“å­˜åçš„ç»“æœ  
postgres=# explain analyze SELECT ctid from vector_test_vchord   
  order by embedding <-> (select embedding from vector_test_vchord where id=1234) limit 20;  
                                                                                 QUERY PLAN                                                                                   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------  
 Limit  (cost=54.93..78.94 rows=1 width=14) (actual time=2.711..3.202 rows=20 loops=1)  
   InitPlan 1 (returns $0)  
     ->  Index Scan using vector_test_vchord_pkey on vector_test_vchord vector_test_vchord_1  (cost=0.38..54.43 rows=1 width=408) (actual time=0.315..0.319 rows=1 loops=1)  
           Index Cond: (id = 1234)  
   ->  Index Scan using vector_test_vchord_embedding_idx on vector_test_vchord  (cost=0.50..24.51 rows=1 width=14) (actual time=2.707..3.192 rows=20 loops=1)  
         Order By: (embedding <-> $0)  
 Planning Time: 0.512 ms  
 Execution Time: 3.442 ms  
(8 rows)  
  
Time: 4.983 ms  
```  
  
  
```  
postgres=# SELECT ctid,embedding <-> (select embedding from vector_test_vchord where id=1234) from vector_test_vchord  
  order by embedding <-> (select embedding from vector_test_vchord where id=1234) limit 20;  
    ctid    |      ?column?        
------------+--------------------  
 (49573,6)  |                  0  
 (49506,14) | 1.5019497121070213  
 (49834,16) |   1.81446225725551  
 (49870,12) | 1.8404459686514545  
 (49921,7)  |  1.842976618059091  
 (49847,12) | 1.8530746916299405  
 (49921,2)  | 1.8559437354619455  
 (49973,4)  |  1.867700673853722  
 (49889,5)  |  1.870166142472818  
 (49680,7)  |  1.874870995216205  
 (49813,18) | 1.8803078227962111  
 (49844,15) | 1.8821173686604808  
 (49680,5)  | 1.8866303543644682  
 (49746,11) | 1.8932781046996845  
 (49712,18) | 1.8969184229498157  
 (49861,1)  | 1.9089846147943372  
 (49680,1)  |  1.909559659878426  
 (49548,13) |  1.911150277768943  
 (49857,1)  |  1.917677163764015  
 (49983,4)  | 1.9190222804817116  
(20 rows)  
  
Time: 6.717 ms  
```  
  
recallæƒ…å†µ  
```  
create temp table vchordrq_indexscan (id tid) ON COMMIT PRESERVE ROWS;  
create temp table vchordrq_seqscan (id tid) ON COMMIT PRESERVE ROWS;  
  
  
BEGIN;  
SET LOCAL enable_seqscan = off;  
set LOCAL enable_bitmapscan = off;  
set LOCAL enable_indexscan = on;  
SET vchordrq.probes = '1';  
SET vchordrq.epsilon = 1.0;  
  
insert into vchordrq_indexscan   
SELECT ctid from vector_test_vchord  
  order by embedding <-> (select embedding from vector_test_vchord where id=1234) limit 20;  
  
SET LOCAL enable_seqscan = on;    
set LOCAL enable_bitmapscan = off;  
set LOCAL enable_indexscan = off;  
  
insert into vchordrq_seqscan   
SELECT ctid from vector_test_vchord  
  order by embedding <-> (select embedding from vector_test_vchord where id=1234) limit 20;  
COMMIT;  
  
  
with recall as (  
  select count(*)::numeric as cnt from vchordrq_indexscan join vchordrq_seqscan using (id)  
),   
seqscan as (  
 select count(*)::numeric as cnt from vchordrq_seqscan  
)  
select recall.cnt/seqscan.cnt as recall from recall,seqscan;  
  
  
 recall   
--------  
      1.0000  
(1 row)  
```  
  
è¿”å›1, è¯´æ˜1å¬å›.   
  
ç»“è®º: å’Œvectorchordå®˜æ–¹è¯´çš„ä¸€æ ·, åœ¨ä¿è¯å¬å›ç‡å’ŒæŸ¥è¯¢æ€§èƒ½çš„æƒ…å†µä¸‹, ç›¸æ¯”hnswæ„å»ºç´¢å¼•çš„é€Ÿåº¦å¤§å¹…åº¦æå‡, å¹¶ä¸”ç´¢å¼•ä¹Ÿæ›´å°.    
    
# é™„å½•
å¦‚æœè¦ç”Ÿæˆç»´åº¦å€¼å–å€¼èŒƒå›´`[-1,1]`çš„æ•°æ®, ä»¥åŠåŒ…å«å…¨æ–‡æ£€ç´¢ã€æ ‡é‡å­—æ®µã€æ ‡ç­¾æ•°ç»„çš„é™„åŠ å­—æ®µçš„æ•°æ®. è¯·å‚è€ƒ:  
- [ã€Šå¤§å­¦ç”Ÿå®è·µè¯¾: å®éªŒæ‰‹å†Œã€‹](../202512/20251230_01.md) çš„å‘é‡å®éªŒéƒ¨åˆ†.  
  
#### [PolarDB å­¦ä¹ å›¾è°±](https://www.aliyun.com/database/openpolardb/activity "8642f60e04ed0c814bf9cb9677976bd4")
  
  
#### [PostgreSQL è§£å†³æ–¹æ¡ˆé›†åˆ](../201706/20170601_02.md "40cff096e9ed7122c512b35d8561d9c8")
  
  
#### [å¾·å“¥ / digoal's Github - å…¬ç›Šæ˜¯ä¸€è¾ˆå­çš„äº‹.](https://github.com/digoal/blog/blob/master/README.md "22709685feb7cab07d30f30387f0a9ae")
  
  
#### [About å¾·å“¥](https://github.com/digoal/blog/blob/master/me/readme.md "a37735981e7704886ffd590565582dd0")
  
  
![digoal's wechat](../pic/digoal_weixin.jpg "f7ad92eeba24523fd47a6e1a0e691b59")
  
