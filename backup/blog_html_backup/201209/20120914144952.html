<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">performance tuning case :use cursor or trigger replace group by and order by REDUCE needed blockes scan</h2>
	<h5 id="">2012-09-14 14:49:52&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020128142829610/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">一个比较经典的SQL如下 :&nbsp;<div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >select a.skyid, a.giftpackageid, a.giftpackagename, a.intimestamp</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; from tbl_anc_player_win_log a</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;group by a.skyid, a.giftpackageid, a.giftpackagename, a.intimestamp</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;order by a.intimestamp desc LIMIT 10;</font></div><p></p></pre></div><div>显然走的是全表扫描.</div><div><br></div><div>有几种优化的手段如下, 数据量越大提升效果越明显, 测试使用了10W条记录 :&nbsp;</div><div>1. 使用子查询降低 group by 的数据量.</div><div>2. 使用游标和临时表.</div><div>3. 在<span style="line-height: 22px;"  >tbl_anc_player_win_log表上建立</span>触发器, 用另一张表来记录唯一的<span style="line-height: 22px;"  >a.skyid, a.giftpackageid, a.giftpackagename, a.intimestamp.</span></div><div><span style="line-height: 22px;"  ><br></span></div><div><span style="line-height: 22px;"  >下面分别来讲一下 :&nbsp;</span></div><div><span style="line-height: 22px;"  >测试表 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create table user_download_log (user_id int not null, listid int not null, apkid int not null, get_time timestamp(0) not null, otherinfo text);</font></div><div><font size="2"  >create index idx_user_download_log_time on user_download_log (get_time);</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >测试数据 :&nbsp;</span></div><div><pre class="prettyprint"  ><p><font size="2"  ><span style="line-height: 22px;"  >insert into user_download_log select</span><span style="line-height: 22px;"  >&nbsp;generate_series(0,100000),generate_series(0,100000),generate_series(0,100000),generate_series(clock_timestamp(),clock_timestamp()+interval '100000 min',interval '1 min'), 'this is test';</span></font></p></pre></div><div><span style="line-height: 22px;"  ><br></span></div><div>1. 使用子查询来<span style="line-height: 22px;"  >降低 group by 的数据量.</span></div><div><span style="line-height: 22px;"  >我们看原始的SQL, 是全表来group by的, 但是实际上只需要取10条. 按时间排序.</span></div><div><span style="line-height: 22px;"  >那么可以根据数据特点, 按照时间字段排序取出部分记录(具体取出多少条, 视大概多少条能取到10个唯一的</span><span style="line-height: 22px;"  >a.skyid, a.giftpackageid, a.giftpackagename,</span><span style="line-height: 22px;"  >a.intimestamp</span><span style="line-height: 22px;"  >&nbsp;而定</span><span style="line-height: 22px;"  >)&nbsp;</span></div><div>例如假设取1000条可以得到10个唯一的(<span style="line-height: 22px;"  >a.skyid, a.giftpackageid, a.giftpackagename,</span><span style="line-height: 22px;"  >a.intimestamp)</span></div><div><span style="line-height: 22px;"  >SQL如下 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from (select user_id,listid,apkid,get_time from user_download_log order by get_time desc limit 1000) as t group by user_id,listid,apkid,get_time order by get_time desc limit 10;</font></div><div><font size="2"  >&nbsp;user_id | listid | apkid &nbsp;| &nbsp; &nbsp; &nbsp;get_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------+--------+--------+---------------------</font></div><div><font size="2"  >&nbsp; 100000 | 100000 | 100000 | 2012-11-22 23:40:06</font></div><div><font size="2"  >&nbsp; &nbsp;99999 | &nbsp;99999 | &nbsp;99999 | 2012-11-22 23:39:06</font></div><div><font size="2"  >&nbsp; &nbsp;99998 | &nbsp;99998 | &nbsp;99998 | 2012-11-22 23:38:06</font></div><div><font size="2"  >&nbsp; &nbsp;99997 | &nbsp;99997 | &nbsp;99997 | 2012-11-22 23:37:06</font></div><div><font size="2"  >&nbsp; &nbsp;99996 | &nbsp;99996 | &nbsp;99996 | 2012-11-22 23:36:06</font></div><div><font size="2"  >&nbsp; &nbsp;99995 | &nbsp;99995 | &nbsp;99995 | 2012-11-22 23:35:06</font></div><div><font size="2"  >&nbsp; &nbsp;99994 | &nbsp;99994 | &nbsp;99994 | 2012-11-22 23:34:06</font></div><div><font size="2"  >&nbsp; &nbsp;99993 | &nbsp;99993 | &nbsp;99993 | 2012-11-22 23:33:06</font></div><div><font size="2"  >&nbsp; &nbsp;99992 | &nbsp;99992 | &nbsp;99992 | 2012-11-22 23:32:06</font></div><div><font size="2"  >&nbsp; &nbsp;99991 | &nbsp;99991 | &nbsp;99991 | 2012-11-22 23:31:06</font></div><div><font size="2"  >(10 rows)</font></div><div><font size="2"  >Time: 2.010 ms</font></div><p></p></pre></div><div>执行计划如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; explain select * from (select user_id,listid,apkid,get_time from user_download_log order by get_time desc limit 1000) as t group by user_id,listid,apkid,get_time order by get_time desc limit 10;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >------------------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp;Limit &nbsp;(cost=86.02..86.05 rows=10 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=86.02..88.52 rows=1000 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: user_download_log.get_time</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;HashAggregate &nbsp;(cost=54.41..64.41 rows=1000 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Limit &nbsp;(cost=0.00..34.41 rows=1000 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Index Scan Backward using idx_user_download_log_time on user_download_log &nbsp;(cost=0.00..3441.38 rows=100001&nbsp;</font></div><div><font size="2"  >width=20)</font></div><div><font size="2"  >(6 rows)</font></div><div><font size="2"  >Time: 0.765 ms</font></div><p></p></pre></div><div>原始SQL :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select user_id,listid,apkid,get_time from user_download_log group by user_id,listid,apkid,get_time order by get_time desc limit 10;</font></div><div><font size="2"  >&nbsp;user_id | listid | apkid &nbsp;| &nbsp; &nbsp; &nbsp;get_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------+--------+--------+---------------------</font></div><div><font size="2"  >&nbsp; 100000 | 100000 | 100000 | 2012-11-22 23:40:06</font></div><div><font size="2"  >&nbsp; &nbsp;99999 | &nbsp;99999 | &nbsp;99999 | 2012-11-22 23:39:06</font></div><div><font size="2"  >&nbsp; &nbsp;99998 | &nbsp;99998 | &nbsp;99998 | 2012-11-22 23:38:06</font></div><div><font size="2"  >&nbsp; &nbsp;99997 | &nbsp;99997 | &nbsp;99997 | 2012-11-22 23:37:06</font></div><div><font size="2"  >&nbsp; &nbsp;99996 | &nbsp;99996 | &nbsp;99996 | 2012-11-22 23:36:06</font></div><div><font size="2"  >&nbsp; &nbsp;99995 | &nbsp;99995 | &nbsp;99995 | 2012-11-22 23:35:06</font></div><div><font size="2"  >&nbsp; &nbsp;99994 | &nbsp;99994 | &nbsp;99994 | 2012-11-22 23:34:06</font></div><div><font size="2"  >&nbsp; &nbsp;99993 | &nbsp;99993 | &nbsp;99993 | 2012-11-22 23:33:06</font></div><div><font size="2"  >&nbsp; &nbsp;99992 | &nbsp;99992 | &nbsp;99992 | 2012-11-22 23:32:06</font></div><div><font size="2"  >&nbsp; &nbsp;99991 | &nbsp;99991 | &nbsp;99991 | 2012-11-22 23:31:06</font></div><div><font size="2"  >(10 rows)</font></div><div><span style="line-height: 22px;"  ><font size="2"  >Time: 97.731 ms</font></span></div><p></p></pre></div><div><span style="line-height: 22px;"  >原始SQL执行计划 :&nbsp;</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; explain select user_id,listid,apkid,get_time from user_download_log group by user_id,listid,apkid,get_time order by get_time desc limit 10;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >--------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Limit &nbsp;(cost=12189.92..12190.05 rows=10 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp;-&gt; &nbsp;Group &nbsp;(cost=12189.92..13439.93 rows=100001 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Sort &nbsp;(cost=12189.92..12439.92 rows=100001 width=20)</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Sort Key: get_time, user_id, listid, apkid</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;-&gt; &nbsp;Seq Scan on user_download_log &nbsp;(cost=0.00..1834.01 rows=100001 width=20)</font></div><div><font size="2"  >(5 rows)</font></div><div><font size="2"  >Time: 0.742 ms</font></div><p></p></pre></div></div><div>使用这种优化方法得到的查询速度是原始SQL的49倍.</div><div><br></div><div>2.&nbsp;<span style="line-height: 22px;"  >使用游标, 以及临时表来存储得到的值.</span></div><div><span style="line-height: 22px;"  >函数如下 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function get_user_download_log(i_limit int) returns setof record as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; v_result record;</font></div><div><font size="2"  >&nbsp; v_query refcursor;</font></div><div><font size="2"  >&nbsp; v_limit int := 0;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; CREATE TEMPORARY TABLE IF NOT EXISTS tmp_user_download_log (user_id int, listid int, apkid int, get_time timestamp(0));</font></div><div><font size="2"  >&nbsp; truncate table tmp_user_download_log;</font></div><div><font size="2"  >&nbsp; open v_query for select user_id,listid,apkid,get_time from user_download_log order by get_time desc;</font></div><div><font size="2"  >&nbsp; loop</font></div><div><font size="2"  >&nbsp; &nbsp; fetch v_query into v_result;</font></div><div><font size="2"  >&nbsp; &nbsp; perform 1 from tmp_user_download_log where user_id=v_result.user_id and listid=v_result.listid and apkid=v_result.apkid and get_time=v_result.get_time;</font></div><div><font size="2"  >&nbsp; &nbsp; if not found then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; if v_limit &gt;= i_limit then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; exit;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; if (v_result.user_id is not null and v_result.listid is not null and v_result.apkid is not null and v_result.get_time is not null) then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; insert into tmp_user_download_log(user_id, listid, apkid, get_time)&nbsp;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; values(v_result.user_id, v_result.listid, v_result.apkid, v_result.get_time);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_limit := v_limit + 1;</font></div><div><font size="2"  >&nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; end loop;</font></div><div><font size="2"  >&nbsp;&nbsp;close v_query;</font></div><div><font size="2"  >  return query select * from tmp_user_download_log;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div>使用这个函数取数的执行计划如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; explain analyze select * from get_user_download_log(10) as (c1 int, c2 int, c3 int, c4 timestamp(0));</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QUERY PLAN &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >--------------------------------------------------------------------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;Function Scan on get_user_download_log &nbsp;(cost=0.25..10.25 rows=1000 width=20) (actual time=0.948..0.951 rows=20 loops=1)</font></div><div><font size="2"  >&nbsp;Total runtime: 0.978 ms</font></div><div><font size="2"  >(2 rows)</font></div><p></p></pre></div><div>执行时间和执行结果如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from get_user_download_log(10) as (c1 int, c2 int, c3 int, c4 timestamp(0));</font></div><div><font size="2"  >&nbsp; &nbsp;c1 &nbsp; | &nbsp; c2 &nbsp; | &nbsp; c3 &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; c4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >--------+--------+--------+---------------------</font></div><div><font size="2"  >&nbsp;100000 | 100000 | 100000 | 2012-11-22 23:28:28</font></div><div><font size="2"  >&nbsp; 99999 | &nbsp;99999 | &nbsp;99999 | 2012-11-22 23:27:28</font></div><div><font size="2"  >&nbsp; 99998 | &nbsp;99998 | &nbsp;99998 | 2012-11-22 23:26:28</font></div><div><font size="2"  >&nbsp; 99997 | &nbsp;99997 | &nbsp;99997 | 2012-11-22 23:25:28</font></div><div><font size="2"  >&nbsp; 99996 | &nbsp;99996 | &nbsp;99996 | 2012-11-22 23:24:28</font></div><div><font size="2"  >&nbsp; 99995 | &nbsp;99995 | &nbsp;99995 | 2012-11-22 23:23:28</font></div><div><font size="2"  >&nbsp; 99994 | &nbsp;99994 | &nbsp;99994 | 2012-11-22 23:22:28</font></div><div><font size="2"  >&nbsp; 99993 | &nbsp;99993 | &nbsp;99993 | 2012-11-22 23:21:28</font></div><div><font size="2"  >&nbsp; 99992 | &nbsp;99992 | &nbsp;99992 | 2012-11-22 23:20:28</font></div><div><font size="2"  >&nbsp; 99991 | &nbsp;99991 | &nbsp;99991 | 2012-11-22 23:19:28</font></div><div><font size="2"  >(10 rows)</font></div><div><font size="2"  >Time: 1.818 ms</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >使用这种优化方法得到的查询速度是原始SQL的54倍.</span></div><div><br></div><div>3. 使用触发器, 以及新建一张表来存储唯一的<span style="line-height: 22px;"  >user_id,listid,apkid,get_time.</span></div><div><span style="line-height: 22px;"  >新建表如下 :&nbsp;</span></div><div><pre class="prettyprint"  ><p><font size="2"  >create table user_download_uk (user_id int, listid int, apkid int, get_time timestamp(0), primary key (user_id,listid,apkid,get_time));</font></p></pre></div><div>新建插入触发器函数 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function tg_user_download_log_insert() returns trigger as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; perform 1 from user_download_uk where user_id=NEW.user_id and listid=NEW.listid and apkid=NEW.apkid and&nbsp;<span style="line-height: 22px;"  >get_time=NEW.get_time;</span></font></div><div><font size="2"  >&nbsp; if found then</font></div><div><font size="2"  >&nbsp; &nbsp; return null;</font></div><div><font size="2"  >&nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; insert into user_download_uk(user_id,listid,apkid,get_time) values(NEW.user_id,NEW.listid,NEW.apkid,NEW.get_time);</font></div><div><font size="2"  >&nbsp; end if;</font></div><div><font size="2"  >&nbsp; return null;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >新建删除触发器函数 :&nbsp;</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function tg_user_download_log_delete() returns trigger as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; delete from user_download_uk where user_id=OLD.user_id and listid=OLD.listid and apkid=OLD.apkid&nbsp;<span style="line-height: 22px;"  >and&nbsp;</span><span style="line-height: 22px;"  >get_time=OLD.get_time;</span></font></div><div><font size="2"  >&nbsp; return null;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >新建更新触发器函数 :&nbsp;</span> </div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function tg_user_download_log_update() returns trigger as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; perform 1 from user_download_uk where user_id=OLD.user_id and listid=OLD.listid and apkid=OLD.apkid&nbsp;<span style="line-height: 22px;"  >and&nbsp;</span><span style="line-height: 22px;"  >get_time=OLD.get_time</span>;</font></div><div><font size="2"  >&nbsp; if found then</font></div><div><font size="2"  >&nbsp; &nbsp; update user_download_uk set &nbsp;user_id=NEW.user_id and listid=NEW.listid and apkid=NEW.apkid&nbsp;<span style="line-height: 22px;"  >and&nbsp;</span><span style="line-height: 22px;"  >get_time=NEW.get_time</span></font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;&nbsp;<span style="line-height: 22px;"  >where user_id=OLD.user_id and listid=OLD.listid and apkid=OLD.apkid&nbsp;</span><span style="line-height: 22px;"  >and&nbsp;</span><span style="line-height: 22px;"  >get_time=OLD.get_time</span>;</font></div><div><font size="2"  >&nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; insert into user_download_uk(user_id,listid,apkid,get_time) values(NEW.user_id,NEW.listid,NEW.apkid,NEW.get_time);</font></div><div><font size="2"  >&nbsp; end if;</font></div><div><font size="2"  >&nbsp; return null;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div>在<span style="line-height: 22px;"  >user_download_log表上创建三个触发器.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create trigger tg_user_download_log_update after update on user_download_log for each row execute procedure tg_user_download_log_update();</font></div><div><font size="2"  >CREATE TRIGGER</font></div><div><font size="2"  >Time: 1.531 ms</font></div><div><font size="2"  >digoal=&gt; create trigger tg_user_download_log_insert after insert on user_download_log for each row execute procedure tg_user_download_log_insert();</font></div><div><font size="2"  >CREATE TRIGGER</font></div><div><font size="2"  >Time: 1.527 ms</font></div><div><font size="2"  >digoal=&gt; create trigger tg_user_download_log_delete after delete on user_download_log for each row execute procedure tg_user_download_log_delete();</font></div><div><font size="2"  >CREATE TRIGGER</font></div><div><font size="2"  >Time: 1.484 ms</font></div><p></p></pre></div><div>清除数据, 重新插入 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; truncate user_download_log ;</font></div><div><font size="2"  >TRUNCATE TABLE</font></div><div><font size="2"  >Time: 6.216 ms</font></div><p></p></pre></div><div>在新增的表上对order by字段创建索引.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create index idx_user_download_uk on user_download_uk (get_time);</font></div><div><font size="2"  >CREATE INDEX</font></div><div><font size="2"  >Time: 64.599 ms</font></div><p></p></pre></div><div>插入数据 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into user_download_log select generate_series(0,100000),generate_series(0,100000),generate_series(0,100000),generate_series(clock_timestamp(),clock_timestamp()+interval '100000 min',interval '1 min'), 'this is test';</font></div><div><font size="2"  >INSERT 0 100001</font></div><div><font size="2"  >Time: 4911.241 ms</font></div><p></p></pre></div><div>显然插入速度有明显下降, 这是这种方法的弊端, 需要权衡这个表的DML操作和DQL操作的比例来选择是否要用这种方法进行优化.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from user_download_uk order by get_time desc limit 10;</font></div><div><font size="2"  >&nbsp;user_id | listid | apkid &nbsp;| &nbsp; &nbsp; &nbsp;get_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------+--------+--------+---------------------</font></div><div><font size="2"  >&nbsp; 100000 | 100000 | 100000 | 2012-11-23 01:20:11</font></div><div><font size="2"  >&nbsp; &nbsp;99999 | &nbsp;99999 | &nbsp;99999 | 2012-11-23 01:19:11</font></div><div><font size="2"  >&nbsp; &nbsp;99998 | &nbsp;99998 | &nbsp;99998 | 2012-11-23 01:18:11</font></div><div><font size="2"  >&nbsp; &nbsp;99997 | &nbsp;99997 | &nbsp;99997 | 2012-11-23 01:17:11</font></div><div><font size="2"  >&nbsp; &nbsp;99996 | &nbsp;99996 | &nbsp;99996 | 2012-11-23 01:16:11</font></div><div><font size="2"  >&nbsp; &nbsp;99995 | &nbsp;99995 | &nbsp;99995 | 2012-11-23 01:15:11</font></div><div><font size="2"  >&nbsp; &nbsp;99994 | &nbsp;99994 | &nbsp;99994 | 2012-11-23 01:14:11</font></div><div><font size="2"  >&nbsp; &nbsp;99993 | &nbsp;99993 | &nbsp;99993 | 2012-11-23 01:13:11</font></div><div><font size="2"  >&nbsp; &nbsp;99992 | &nbsp;99992 | &nbsp;99992 | 2012-11-23 01:12:11</font></div><div><font size="2"  >&nbsp; &nbsp;99991 | &nbsp;99991 | &nbsp;99991 | 2012-11-23 01:11:11</font></div><div><font size="2"  >(10 rows)</font></div><div><font size="2"  >Time: 0.360 ms</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >使用这种优化方法得到的查询速度是原始SQL的271倍.</span></div><div><br></div><div>【小结】</div><div><div style="line-height: 22px;"  >1. 使用子查询降低 group by 的数据量.&nbsp;</div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >使用这种优化方法得到的查询速度是原始SQL的49倍.</span> </div><div style="line-height: 22px;"  >弊端, 不好评估子查询中到底要限制多少行, 才能得到10条唯一的<span style="line-height: 22px;"  >a.skyid, a.giftpackageid, a.giftpackagename, a.intimestamp. 如果评估少了得不到10条最终结果, 如果评估多了又费性能.</span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><br></span></div><div style="line-height: 22px;"  >2. 使用游标和临时表.</div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >使用这种优化方法得到的查询速度是原始SQL的54倍.</span> </div><div style="line-height: 22px;"  >使用这种方法应该是比较折中的, 但是需要规划好临时表 .&nbsp;</div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><br></span></div><div style="line-height: 22px;"  >3. 在<span style="line-height: 22px;"  >tbl_anc_player_win_log表上建立</span>触发器, 用另一张表来记录唯一的<span style="line-height: 22px;"  >a.skyid, a.giftpackageid, a.giftpackagename, a.intimestamp.</span></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >使用这种优化方法得到的查询速度是原始SQL的271倍.</span> </div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >使用这种方法得到的提升最明显, 但是对DML的性能影响也是非常大的, 需要权衡利弊.</span></div></div><div><wbr></div></div><br><div>【补充1】</div><div>1. &nbsp;使用游标的例子, 还有优化的空间, 那就是把临时表去掉. 使用array来存储过往的记录. 如下 :&nbsp;</div><div><div>// 需要创建一个返回结果类型, 因为函数中不允许定义record[]类型的数组.&nbsp;<span style="line-height: 22px;"  >v_result_array record[];</span></div><div><span style="line-height: 22px;"  >// 定义返回结果类型, 还有一个好处是使得查询更加简单了.</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create type typ_user_download_log as (user_id int, listid int, apkid int, get_time timestamp(0));</font></div><div><font size="2"  >CREATE TYPE</font></div><p></p></pre></div><div>// 函数如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function get_user_download_log(i_limit int) returns setof typ_user_download_log as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; v_result typ_user_download_log;</font></div><div><font size="2"  >&nbsp; v_query refcursor;</font></div><div><font size="2"  >&nbsp; v_limit int := 0;</font></div><div><font size="2"  >&nbsp; v_result_array typ_user_download_log[];</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; open v_query for select user_id,listid,apkid,get_time from user_download_log order by get_time desc;</font></div><div><font size="2"  >&nbsp; loop</font></div><div><font size="2"  >&nbsp; &nbsp; fetch v_query into v_result;</font></div><div><font size="2"  >&nbsp; &nbsp; if ( v_result = ANY(v_result_array) ) then</font></div><div><font size="2"  >&nbsp; &nbsp; else</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; if v_limit &gt;= i_limit then</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; exit;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_result_array := array_append(v_result_array, v_result);</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; return next v_result;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; v_limit := v_limit + 1;</font></div><div><font size="2"  >&nbsp; &nbsp; end if;</font></div><div><font size="2"  >&nbsp; end loop;</font></div><div><font size="2"  >&nbsp; close v_query;</font></div><div><font size="2"  >&nbsp; return;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div></div><div>插入几条重复记录, 看看是否能正常过滤.</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select ctid,* from user_download_log order by get_time desc limit 10;</font></div><div><font size="2"  >&nbsp; &nbsp;ctid &nbsp; | user_id | listid | apkid &nbsp;| &nbsp; &nbsp; &nbsp;get_time &nbsp; &nbsp; &nbsp; | &nbsp;otherinfo &nbsp;&nbsp;</font></div><div><font size="2"  >----------+---------+--------+--------+---------------------+--------------</font></div><div><font size="2"  >&nbsp;(833,41) | &nbsp;100000 | 100000 | 100000 | 2012-11-23 01:20:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,40) | &nbsp; 99999 | &nbsp;99999 | &nbsp;99999 | 2012-11-23 01:19:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,39) | &nbsp; 99998 | &nbsp;99998 | &nbsp;99998 | 2012-11-23 01:18:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,38) | &nbsp; 99997 | &nbsp;99997 | &nbsp;99997 | 2012-11-23 01:17:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,37) | &nbsp; 99996 | &nbsp;99996 | &nbsp;99996 | 2012-11-23 01:16:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,36) | &nbsp; 99995 | &nbsp;99995 | &nbsp;99995 | 2012-11-23 01:15:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,35) | &nbsp; 99994 | &nbsp;99994 | &nbsp;99994 | 2012-11-23 01:14:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,34) | &nbsp; 99993 | &nbsp;99993 | &nbsp;99993 | 2012-11-23 01:13:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,33) | &nbsp; 99992 | &nbsp;99992 | &nbsp;99992 | 2012-11-23 01:12:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,32) | &nbsp; 99991 | &nbsp;99991 | &nbsp;99991 | 2012-11-23 01:11:11 | this is test</font></div><div><font size="2"  >(10 rows)</font></div><div><font size="2"  >Time: 0.712 ms</font></div><p></p></pre></div><div>// 插入前10条重复数据.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into user_download_log select * from user_download_log order by get_time desc limit 10;</font></div><div><font size="2"  >INSERT 0 10</font></div><div><font size="2"  >Time: 2.322 ms</font></div><div><font size="2"  >digoal=&gt; select ctid,* from user_download_log order by get_time desc limit 10;</font></div><div><font size="2"  >&nbsp; &nbsp;ctid &nbsp; | user_id | listid | apkid &nbsp;| &nbsp; &nbsp; &nbsp;get_time &nbsp; &nbsp; &nbsp; | &nbsp;otherinfo &nbsp;&nbsp;</font></div><div><font size="2"  >----------+---------+--------+--------+---------------------+--------------</font></div><div><font size="2"  >&nbsp;(833,41) | &nbsp;100000 | 100000 | 100000 | 2012-11-23 01:20:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,43) | &nbsp;100000 | 100000 | 100000 | 2012-11-23 01:20:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,40) | &nbsp; 99999 | &nbsp;99999 | &nbsp;99999 | 2012-11-23 01:19:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,44) | &nbsp; 99999 | &nbsp;99999 | &nbsp;99999 | 2012-11-23 01:19:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,39) | &nbsp; 99998 | &nbsp;99998 | &nbsp;99998 | 2012-11-23 01:18:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,45) | &nbsp; 99998 | &nbsp;99998 | &nbsp;99998 | 2012-11-23 01:18:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,38) | &nbsp; 99997 | &nbsp;99997 | &nbsp;99997 | 2012-11-23 01:17:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,46) | &nbsp; 99997 | &nbsp;99997 | &nbsp;99997 | 2012-11-23 01:17:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,37) | &nbsp; 99996 | &nbsp;99996 | &nbsp;99996 | 2012-11-23 01:16:11 | this is test</font></div><div><font size="2"  >&nbsp;(833,47) | &nbsp; 99996 | &nbsp;99996 | &nbsp;99996 | 2012-11-23 01:16:11 | this is test</font></div><div><font size="2"  >(10 rows)</font></div><div><font size="2"  >Time: 0.649 ms</font></div><p></p></pre></div></div><div>// 查询, 得到正确的结果</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select * from get_user_download_log(10);</font></div><div><font size="2"  >&nbsp;user_id | listid | apkid &nbsp;| &nbsp; &nbsp; &nbsp;get_time &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"  >---------+--------+--------+---------------------</font></div><div><font size="2"  >&nbsp; 100000 | 100000 | 100000 | 2012-11-23 01:20:11</font></div><div><font size="2"  >&nbsp; &nbsp;99999 | &nbsp;99999 | &nbsp;99999 | 2012-11-23 01:19:11</font></div><div><font size="2"  >&nbsp; &nbsp;99998 | &nbsp;99998 | &nbsp;99998 | 2012-11-23 01:18:11</font></div><div><font size="2"  >&nbsp; &nbsp;99997 | &nbsp;99997 | &nbsp;99997 | 2012-11-23 01:17:11</font></div><div><font size="2"  >&nbsp; &nbsp;99996 | &nbsp;99996 | &nbsp;99996 | 2012-11-23 01:16:11</font></div><div><font size="2"  >&nbsp; &nbsp;99995 | &nbsp;99995 | &nbsp;99995 | 2012-11-23 01:15:11</font></div><div><font size="2"  >&nbsp; &nbsp;99994 | &nbsp;99994 | &nbsp;99994 | 2012-11-23 01:14:11</font></div><div><font size="2"  >&nbsp; &nbsp;99993 | &nbsp;99993 | &nbsp;99993 | 2012-11-23 01:13:11</font></div><div><font size="2"  >&nbsp; &nbsp;99992 | &nbsp;99992 | &nbsp;99992 | 2012-11-23 01:12:11</font></div><div><font size="2"  >&nbsp; &nbsp;99991 | &nbsp;99991 | &nbsp;99991 | 2012-11-23 01:11:11</font></div><div><font size="2"  >(10 rows)</font></div><div><font size="2"  >Time: 0.809 ms</font></div><p></p></pre></div><div><span style="line-height: 22px;"  >使用这种优化方法得到的查询速度是原始SQL的121倍.&nbsp;</span></div><br><div>【补充2】</div><div>以下是延展出来的方法, 使用递归调用, 也可以达到同样的优化目的, 但是. 以下测试的group by 只用到了一个字段. 而上面的例子用到了多个字段group by .</div><div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >CREATE TABLE test (</font></div><div><font size="2"  >&nbsp; &nbsp; username TEXT,</font></div><div><font size="2"  >&nbsp; &nbsp; some_ts timestamptz,</font></div><div><font size="2"  >&nbsp; &nbsp; random_value INT4</font></div><div><font size="2"  >);</font></div><p></p></pre></div><div>&nbsp;测试数据 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >INSERT INTO test (username, some_ts, random_value)</font></div><div><font size="2"  >SELECT</font></div><div><font size="2"  >&nbsp; &nbsp; 'user #' || cast(floor(random() * 10) as int4),</font></div><div><font size="2"  >&nbsp; &nbsp; now() - '1 year'::INTERVAL * random(),</font></div><div><font size="2"  >&nbsp; &nbsp; cast(random() * 100000000 as INT4)</font></div><div><font size="2"  >FROM</font></div><div><font size="2"  >&nbsp; &nbsp; generate_series(1,2000000);</font></div><p></p></pre></div><div>&nbsp;优化将用到这个索引 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >CREATE INDEX i on test (username, some_ts);</font></p></pre></div><div>分析表 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >analyze test;</font></p></pre></div><div>测试数据分布 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >SELECT</font></div><div><font size="2"  >&nbsp; &nbsp; username,</font></div><div><font size="2"  >&nbsp; &nbsp; count(*)</font></div><div><font size="2"  >FROM test</font></div><div><font size="2"  >group by username</font></div><div><font size="2"  >order by username;</font></div><div><font size="2"  >&nbsp;username │ count</font></div><div><font size="2"  >──────────┼────────</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;│ 199871</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;│ 199939</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;│ 200388</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;│ 199849</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;│ 200329</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;│ 199504</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;│ 199903</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;│ 200799</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;│ 199487</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;│ 199931</font></div><div><font size="2"  >(10 rows)</font></div><p></p></pre></div><div>未优化的SQL :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >select username,some_ts,random_value from (select row_number() over (partition by username order by some_ts desc) as rownum , * from test) as t where t.rownum&lt;6;</font></p></pre></div><div>执行时间 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;username | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;some_ts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| random_value&nbsp;</font></div><div><font size="2"  >----------+-------------------------------+--------------</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 10:26:38.561924+08 | &nbsp; &nbsp; 44572919</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 10:26:28.625924+08 | &nbsp; &nbsp; &nbsp;5466578</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 10:21:18.277124+08 | &nbsp; &nbsp; 32176884</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 10:16:49.227524+08 | &nbsp; &nbsp; 81763617</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 10:15:49.611524+08 | &nbsp; &nbsp; &nbsp;9824604</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 10:25:37.045124+08 | &nbsp; &nbsp; 51284408</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 10:24:28.184324+08 | &nbsp; &nbsp; 42880507</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 10:24:10.040324+08 | &nbsp; &nbsp; 76807969</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 10:24:00.536324+08 | &nbsp; &nbsp; 31799228</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 10:23:40.577924+08 | &nbsp; &nbsp; 62644003</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 10:19:43.064324+08 | &nbsp; &nbsp; 96476095</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 10:19:08.849924+08 | &nbsp; &nbsp; 17594572</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 10:17:45.992324+08 | &nbsp; &nbsp; 41356858</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 10:16:01.361924+08 | &nbsp; &nbsp; &nbsp;9022134</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 10:15:53.585924+08 | &nbsp; &nbsp; 38457579</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 10:25:55.707524+08 | &nbsp; &nbsp; 51972834</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 10:24:01.918724+08 | &nbsp; &nbsp; 51456774</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 10:23:23.470724+08 | &nbsp; &nbsp; 76070209</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 10:22:59.451524+08 | &nbsp; &nbsp; 75154506</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 10:22:27.829124+08 | &nbsp; &nbsp; 13303013</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 10:26:07.198724+08 | &nbsp; &nbsp; 99513201</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 10:23:50.859524+08 | &nbsp; &nbsp; 55677602</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 10:18:31.265924+08 | &nbsp; &nbsp; 19827206</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 10:18:12.344324+08 | &nbsp; &nbsp; 66195606</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 10:17:29.230724+08 | &nbsp; &nbsp; 68841533</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 10:26:51.003524+08 | &nbsp; &nbsp; &nbsp;9603697</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 10:26:43.659524+08 | &nbsp; &nbsp; 68753345</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 10:25:34.712324+08 | &nbsp; &nbsp; 47807516</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 10:24:33.454724+08 | &nbsp; &nbsp; 64949093</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 10:18:59.605124+08 | &nbsp; &nbsp; 20250684</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 10:26:42.536324+08 | &nbsp; &nbsp; 75469114</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 10:21:20.782724+08 | &nbsp; &nbsp; &nbsp;4394586</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 10:21:13.352324+08 | &nbsp; &nbsp; 40429474</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 10:16:06.632324+08 | &nbsp; &nbsp; 71651030</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 10:14:39.454724+08 | &nbsp; &nbsp; 39326466</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 10:26:29.576324+08 | &nbsp; &nbsp; 33673002</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 10:21:39.877124+08 | &nbsp; &nbsp; 76655284</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 10:20:26.437124+08 | &nbsp; &nbsp; 47873719</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 10:20:01.813124+08 | &nbsp; &nbsp; 99362289</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 10:19:37.880324+08 | &nbsp; &nbsp; 31506556</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 10:25:06.545924+08 | &nbsp; &nbsp; 22525296</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 10:24:34.145924+08 | &nbsp; &nbsp; 24814269</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 10:24:07.016324+08 | &nbsp; &nbsp; 91073517</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 10:23:42.565124+08 | &nbsp; &nbsp; 11352497</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 10:21:52.318724+08 | &nbsp; &nbsp; 71172705</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 10:26:07.544324+08 | &nbsp; &nbsp; 35362281</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 10:26:01.928324+08 | &nbsp; &nbsp; 57774609</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 10:25:20.888324+08 | &nbsp; &nbsp; 13287142</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 10:25:11.643524+08 | &nbsp; &nbsp; 53517373</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 10:21:26.571524+08 | &nbsp; &nbsp; 74587255</font></div><div><font size="2"  >(50 rows)</font></div><div><font size="2"  >Time: 11329.845 ms</font></div><p></p></pre></div><div><br></div><div>使用递归调用优化, 主要目的是让每个递归查询其走索引扫描 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >WITH RECURSIVE skip AS (</font></div><div><font size="2"  >&nbsp; &nbsp; ( SELECT t.username FROM test as t ORDER BY t.username limit 1 )</font></div><div><font size="2"  >&nbsp; &nbsp; union all</font></div><div><font size="2"  >&nbsp; &nbsp; (</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; SELECT</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SELECT min( t2.username )</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FROM test t2</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE t2.username &gt; s.username</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; )</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; FROM skip s</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; WHERE s.username IS NOT NULL</font></div><div><font size="2"  >&nbsp; &nbsp; )</font></div><div><font size="2"  >),</font></div><div><font size="2"  >with_data as (</font></div><div><font size="2"  >&nbsp; &nbsp; SELECT array(</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; SELECT t</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; FROM test t</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; WHERE t.username = s.username</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; ORDER BY t.some_ts desc LIMIT 5</font></div><div><font size="2"  >&nbsp; &nbsp; ) as rows</font></div><div><font size="2"  >&nbsp; &nbsp; FROM skip s</font></div><div><font size="2"  >&nbsp; &nbsp; WHERE s.username IS NOT NULL</font></div><div><font size="2"  >)</font></div><div><font size="2"  >SELECT (unnest( rows )).* FROM with_data;</font></div><p></p></pre></div></div><div>执行时间 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp;username | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;some_ts &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| random_value&nbsp;</font></div><div><font size="2"  >----------+-------------------------------+--------------</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 10:26:38.561924+08 | &nbsp; &nbsp; 44572919</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 10:26:28.625924+08 | &nbsp; &nbsp; &nbsp;5466578</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 10:21:18.277124+08 | &nbsp; &nbsp; 32176884</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 10:16:49.227524+08 | &nbsp; &nbsp; 81763617</font></div><div><font size="2"  >&nbsp;user #0 &nbsp;| 2012-10-08 10:15:49.611524+08 | &nbsp; &nbsp; &nbsp;9824604</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 10:25:37.045124+08 | &nbsp; &nbsp; 51284408</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 10:24:28.184324+08 | &nbsp; &nbsp; 42880507</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 10:24:10.040324+08 | &nbsp; &nbsp; 76807969</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 10:24:00.536324+08 | &nbsp; &nbsp; 31799228</font></div><div><font size="2"  >&nbsp;user #1 &nbsp;| 2012-10-08 10:23:40.577924+08 | &nbsp; &nbsp; 62644003</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 10:19:43.064324+08 | &nbsp; &nbsp; 96476095</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 10:19:08.849924+08 | &nbsp; &nbsp; 17594572</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 10:17:45.992324+08 | &nbsp; &nbsp; 41356858</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 10:16:01.361924+08 | &nbsp; &nbsp; &nbsp;9022134</font></div><div><font size="2"  >&nbsp;user #2 &nbsp;| 2012-10-08 10:15:53.585924+08 | &nbsp; &nbsp; 38457579</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 10:25:55.707524+08 | &nbsp; &nbsp; 51972834</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 10:24:01.918724+08 | &nbsp; &nbsp; 51456774</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 10:23:23.470724+08 | &nbsp; &nbsp; 76070209</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 10:22:59.451524+08 | &nbsp; &nbsp; 75154506</font></div><div><font size="2"  >&nbsp;user #3 &nbsp;| 2012-10-08 10:22:27.829124+08 | &nbsp; &nbsp; 13303013</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 10:26:07.198724+08 | &nbsp; &nbsp; 99513201</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 10:23:50.859524+08 | &nbsp; &nbsp; 55677602</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 10:18:31.265924+08 | &nbsp; &nbsp; 19827206</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 10:18:12.344324+08 | &nbsp; &nbsp; 66195606</font></div><div><font size="2"  >&nbsp;user #4 &nbsp;| 2012-10-08 10:17:29.230724+08 | &nbsp; &nbsp; 68841533</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 10:26:51.003524+08 | &nbsp; &nbsp; &nbsp;9603697</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 10:26:43.659524+08 | &nbsp; &nbsp; 68753345</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 10:25:34.712324+08 | &nbsp; &nbsp; 47807516</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 10:24:33.454724+08 | &nbsp; &nbsp; 64949093</font></div><div><font size="2"  >&nbsp;user #5 &nbsp;| 2012-10-08 10:18:59.605124+08 | &nbsp; &nbsp; 20250684</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 10:26:42.536324+08 | &nbsp; &nbsp; 75469114</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 10:21:20.782724+08 | &nbsp; &nbsp; &nbsp;4394586</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 10:21:13.352324+08 | &nbsp; &nbsp; 40429474</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 10:16:06.632324+08 | &nbsp; &nbsp; 71651030</font></div><div><font size="2"  >&nbsp;user #6 &nbsp;| 2012-10-08 10:14:39.454724+08 | &nbsp; &nbsp; 39326466</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 10:26:29.576324+08 | &nbsp; &nbsp; 33673002</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 10:21:39.877124+08 | &nbsp; &nbsp; 76655284</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 10:20:26.437124+08 | &nbsp; &nbsp; 47873719</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 10:20:01.813124+08 | &nbsp; &nbsp; 99362289</font></div><div><font size="2"  >&nbsp;user #7 &nbsp;| 2012-10-08 10:19:37.880324+08 | &nbsp; &nbsp; 31506556</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 10:25:06.545924+08 | &nbsp; &nbsp; 22525296</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 10:24:34.145924+08 | &nbsp; &nbsp; 24814269</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 10:24:07.016324+08 | &nbsp; &nbsp; 91073517</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 10:23:42.565124+08 | &nbsp; &nbsp; 11352497</font></div><div><font size="2"  >&nbsp;user #8 &nbsp;| 2012-10-08 10:21:52.318724+08 | &nbsp; &nbsp; 71172705</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 10:26:07.544324+08 | &nbsp; &nbsp; 35362281</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 10:26:01.928324+08 | &nbsp; &nbsp; 57774609</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 10:25:20.888324+08 | &nbsp; &nbsp; 13287142</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 10:25:11.643524+08 | &nbsp; &nbsp; 53517373</font></div><div><font size="2"  >&nbsp;user #9 &nbsp;| 2012-10-08 10:21:26.571524+08 | &nbsp; &nbsp; 74587255</font></div><div><font size="2"  >(50 rows)</font></div><div><span style="font-size: small;"  >Time: 1.924 ms</span></div><p></p></pre></div><div><br></div><div>优化解说 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >lines 1-14 generate list of unique usernames C just usernames. This is done using recursive CTE:</font></div><div><font size="2"  >Line 2 gets first, smallest username</font></div><div><font size="2"  >Lines 5-12 are called recursively, and they fetch next username each time it gets called</font></div><div><font size="2"  >The only issue with it is that we will get 11 rows C final row will contain NULL. But this can be filtered out later on.</font></div><div><font size="2"  >Lines 15-23 get actual data for all rows</font></div><div><font size="2"  >Lines 16-21 get an array of rows (because we can’t generate more rows than we had from “skip” CTE). Each array contains 5 newest rows for given user. I don’t have to SELECT username separately, because it’s part of the row that is being compacted into array.</font></div><div><font size="2"  >Line 23 removed this additional NULL row that I mentioned above</font></div><div><font size="2"  >Line 25 generates final resultset. It gets (from with_data) 10 rows, each row contains array. Each array has 5 elements, and each of these elements contains a row from original test table. Now, we just need to:</font></div><div><font size="2"  >Unnest array C it generates 50 rows, each with single value, being row representation</font></div><div><font size="2"  >Unpack rows C by using (row_variable).* syntax</font></div><p></p></pre></div><div>使用递归优化摘自 :&nbsp;</div><div><a rel="nofollow" href="http://www.depesz.com/2012/10/05/getting-top-n-rows-per-group/"  >http://www.depesz.com/2012/10/05/getting-top-n-rows-per-group/</a></div></div>
	</div>
</div>
</body>
</html>