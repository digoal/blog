<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL Server Encoding sql_ascii attention</h2>
	<h5 id="">2013-03-15 13:29:05&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020132150381348/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>群里一位兄弟问到的一个问题 :&nbsp;</div><div><div>" 我有一个postgresql，比较大，编码是sqlascii码，我想转换成有utf8&nbsp;，有方案可行吗? "</div><div>如果使用场景中未用到non-ASCII编码的字符, 那很幸运, 导出导入就可以了.</div><div>但是如果场景中使用了non-ASCII编码的字符, 那就没那么幸运了, 因为SQL_ASCII字符集不会对non-ASCII字符做合法性检验, 同时不做任何的编码转换, 客户端上来是什么值就是什么值.</div><div>例如 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pgdev@db-172-16-3-150-&gt; initdb -D $PGDATA -E SQL_ASCII --locale=C -U postgres</font></div><div><font size="2"   >pg_ctl start</font></div><p></p></pre></div><div>-- 当前服务端编码</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; locale</font></div><div><font size="2"   >LANG=en_US.utf8</font></div><div><font size="2"   >LC_CTYPE="en_US.utf8"</font></div><div><font size="2"   >LC_NUMERIC="en_US.utf8"</font></div><div><font size="2"   >LC_TIME="en_US.utf8"</font></div><div><font size="2"   >LC_COLLATE="en_US.utf8"</font></div><div><font size="2"   >LC_MONETARY="en_US.utf8"</font></div><div><font size="2"   >LC_MESSAGES="en_US.utf8"</font></div><div><font size="2"   >LC_PAPER="en_US.utf8"</font></div><div><font size="2"   >LC_NAME="en_US.utf8"</font></div><div><font size="2"   >LC_ADDRESS="en_US.utf8"</font></div><div><font size="2"   >LC_TELEPHONE="en_US.utf8"</font></div><div><font size="2"   >LC_MEASUREMENT="en_US.utf8"</font></div><div><font size="2"   >LC_IDENTIFICATION="en_US.utf8"</font></div><div><font size="2"   >LC_ALL=</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >psql</font></div><div><div><font size="2"   >postgres=# create role digoal login encrypted password 'digoal';</font></div><div><font size="2"   >CREATE ROLE</font></div><div><font size="2"   >postgres=# create database digoal owner digoal;</font></div><div><font size="2"   >CREATE DATABASE</font></div><div><div><font size="2"   >digoal=# \l</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | Encoding &nbsp;| Collate | Ctype | &nbsp; Access privileges &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+----------+-----------+---------+-------+-----------------------</font></div><div><font size="2"   >&nbsp;digoal &nbsp; &nbsp;| digoal &nbsp; | SQL_ASCII | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div></div><div><font size="2"   >postgres=# \c digoal digoal</font></div></div><div><div><font size="2"   >digoal=&gt; create schema digoal;</font></div><div><font size="2"   >CREATE SCHEMA</font></div><div><font size="2"   >digoal=&gt; create table t(id int, info text);</font></div><div><font size="2"   >CREATE TABLE</font></div></div><div><div><font size="2"   >digoal=&gt; insert into t values (1, '中国');</font></div><div><font size="2"   >INSERT 0 1</font></div></div><p></p></pre></div><div>-- 插入中文没有问题, 当前插入的汉字是UTF8编码.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; \q</font></div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; export LANG=zh_CN.gbk</font></div></div><div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; locale</font></div><div><font size="2"   >LANG=zh_CN.gbk</font></div><div><font size="2"   >LC_CTYPE="zh_CN.gbk"</font></div><div><font size="2"   >LC_NUMERIC="zh_CN.gbk"</font></div><div><font size="2"   >LC_TIME="zh_CN.gbk"</font></div><div><font size="2"   >LC_COLLATE="zh_CN.gbk"</font></div><div><font size="2"   >LC_MONETARY="zh_CN.gbk"</font></div><div><font size="2"   >LC_MESSAGES="zh_CN.gbk"</font></div><div><font size="2"   >LC_PAPER="zh_CN.gbk"</font></div><div><font size="2"   >LC_NAME="zh_CN.gbk"</font></div><div><font size="2"   >LC_ADDRESS="zh_CN.gbk"</font></div><div><font size="2"   >LC_TELEPHONE="zh_CN.gbk"</font></div><div><font size="2"   >LC_MEASUREMENT="zh_CN.gbk"</font></div><div><font size="2"   >LC_IDENTIFICATION="zh_CN.gbk"</font></div><div><font size="2"   >LC_ALL=</font></div></div><p></p></pre></div><div>-- 同时修改一下secureCRT的字符集.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pgdev@db-172-16-3-150-&gt; psql digoal digoal</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=&gt; insert into t values (2, '美国');</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div><font size="2"   >digoal=&gt; insert into t values (3, '德国');</font></div><div><font size="2"   >INSERT 0 1</font></div></div><p></p></pre></div><div>-- 插入中文没有问题, 当前插入的汉字是GBK编码.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select *,info::bytea from t;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;| &nbsp; &nbsp; &nbsp;info &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----+--------+----------------</font></div><div><font size="2"   >&nbsp; 1 | 涓 | \xe4b8ade59bbd</font></div><div><font size="2"   >&nbsp; 2 | 美国 &nbsp; | \xc3c0b9fa</font></div><div><font size="2"   >&nbsp; 3 | 德国 &nbsp; | \xb5c2b9fa</font></div><p></p></pre></div><div>-- 由于'中国' 是以UTF8编码插入的, 美国德国是以GBK编码插入的,</div><div>-- 像这种保护混合编码的数值要导出并导入到另一个UTF8编码的数据库, GBK编码的必然会导致导入失败.</div><div>-- 后面使用BYTEA插入UTF8字符集的数据库看看就知道了.</div><div>-- 插入一些字节流, SQL_ASCII对non-ASCII也就是0-127以外的值都不做判断, 直接插入.</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into t values (4, E'\xe2\x82\xad');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>-- 0x00为0-127范围内的值, SQL_ASCII编码的无效字节. &nbsp;这个是被正常的检测出来了.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into t values (4, E'\xe2\x82\x00');</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "SQL_ASCII": 0x00</font></div><p></p></pre></div><div>-- 其他字节流随便插入.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; insert into t values (4, E'\xe2\x82\x01');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; insert into t values (4, E'\xe2\x82\xae');</font></div><div><font size="2"   >INSERT 0 1</font></div><p></p></pre></div><div>-- 由于服务端是SQL_ASCII的, 所以虽然以下编码在UTF8中是非法的, 但是插入到SQL_ASCII的数据库还是没有问题.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; set client_encoding='UTF8';</font></div><div><font size="2"   >SET</font></div><div><font size="2"   >digoal=&gt; insert into t values (4, E'\xe2\x82\xae');</font></div><div><font size="2"   >INSERT 0 1</font></div><div><font size="2"   >digoal=&gt; insert into t values (4, E'\xe2\x82\x0e');</font></div><div><font size="2"   >INSERT 0 1</font></div></div><div><div style="line-height: 22px;"   ><font size="2"   >digoal=&gt; insert into t values (4, E'\x8f');</font></div><div style="line-height: 22px;"   ><font size="2"   >INSERT 0 1</font></div></div><p></p></pre></div></div><div>-- 查询结果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from t;</font></div><div><font size="2"   >&nbsp;id | &nbsp;info &nbsp;</font></div><div><font size="2"   >----+--------</font></div><div><font size="2"   >&nbsp; 1 | 涓</font></div><div><font size="2"   >&nbsp; 2 | 美国</font></div><div><font size="2"   >&nbsp; 3 | 德国</font></div><div><font size="2"   >&nbsp; 4 | </font></div><div><font size="2"   >&nbsp; 4 | </font></div><div><font size="2"   >&nbsp; 4 | \x01</font></div><div><font size="2"   >&nbsp; 4 | </font></div><div><font size="2"   >&nbsp; 4 | </font></div><div><font size="2"   >&nbsp; 4 | \x0E</font></div><div><font size="2"   >&nbsp; 4 |&nbsp;</font></div><div><font size="2"   >&nbsp; 4 |&nbsp;</font></div><div><font size="2"   >(11 rows)</font></div><p></p></pre></div><div><br></div><div>-- 如果数据库是UTF8字符集的话 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >postgres=# \l</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; List of databases</font></div><div><font size="2"   >&nbsp; &nbsp; Name &nbsp; &nbsp; | &nbsp;Owner &nbsp; | Encoding | Collate | Ctype | &nbsp; Access privileges &nbsp;&nbsp;</font></div><div><font size="2"   >-------------+----------+----------+---------+-------+-----------------------</font></div><div><font size="2"   >&nbsp;digoal &nbsp; &nbsp; &nbsp;| digoal &nbsp; | UTF8 &nbsp; &nbsp; | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; |&nbsp;</font></div><p></p></pre></div><div>-- UTF8的非法字符将不允许插入.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres=# insert into t values (4, E'\x8f');</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0x8f</font></div></div><div><div><font size="2"   >postgres=# insert into t values (2, E'\xc3\xc0\xb9\xfa');</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0xc3 0xc0</font></div></div><div><div><font size="2"   >postgres=# insert into t values (2, E'\xb5\xc2\xb9\xfa');</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0xb5</font></div></div><p></p></pre></div><div>-- 即使将客户端编码改成SQL_ASCII, 插入到数据库时也是会报错的.</div><div><pre class="prettyprint"   ><p></p><div><div><div><font size="2"   >postgres=# set client_encoding='SQL_ASCII';</font></div><div><font size="2"   >SET</font></div></div></div><div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >postgres=# insert into t values (2, E'\xc3\xc0\xb9\xfa');</font></div><div style="line-height: 22px;"   ><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0xc3 0xc0</font></div></div><div style="line-height: 22px;"   ><div style="line-height: 22px;"   ><font size="2"   >postgres=# insert into t values (2, E'\xb5\xc2\xb9\xfa');</font></div><div style="line-height: 22px;"   ><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0xb5</font></div></div></div><div><div><font size="2"   >postgres=# insert into t values (2, E'\xc3\xc0\xb9\xfa');</font></div><div><font size="2"   >ERROR: &nbsp;22021: invalid byte sequence for encoding "UTF8": 0xc3 0xc0</font></div><div><font size="2"   >LOCATION: &nbsp;report_invalid_encoding, wchar.c:2015</font></div></div><p></p></pre></div></div><div><span style="line-height: 22px;"   >所以如果存在混合编码的数据插入到SQL_ASCII数据库后, 要把数据正常的导入到UTF8字符集的数据库中, 是一件非常困难的事情.</span></div><div>需将数据导出, 并做好相应的转码再导入到数据库中.&nbsp;</div><div><br></div><div>【小结】</div><div>1. 如果数据库中需要存储非ASCII字符, 那么不推荐数据库使用SQL_ASCII字符集.</div><div>2. 使用SQL_ASCII字符集必须了解的几种情况 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >The SQL_ASCII setting behaves considerably differently from the other settings. When the server character set is SQL_ASCII, the server interprets byte values 0-127 according to the ASCII standard, while byte values 128-255 are taken as uninterpreted characters. No encoding conversion will be done when the setting is SQL_ASCII. Thus, this setting is not so much a declaration that a specific encoding is in use, as a declaration of ignorance about the encoding. In most cases, if you are working with any non-ASCII data, it is unwise to use the SQL_ASCII setting because PostgreSQL will be unable to help you by converting or validating non-ASCII characters.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >PostgreSQL will allow superusers to create databases with SQL_ASCII encoding even when LC_CTYPE is not C or POSIX. As noted above, SQL_ASCII does not enforce that the data stored in the database has any particular encoding, and so this choice poses risks of locale-dependent misbehavior. Using this combination of settings is deprecated and may someday be forbidden altogether.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >If the client character set is defined as SQL_ASCII, encoding conversion is disabled, regardless of the server's character set. Just as for the server, use of SQL_ASCII is unwise unless you are working with all-ASCII data.</font></div><p></p></pre></div><div><br></div><div>【参考】</div><wbr>1.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/multibyte.html"   >http://www.postgresql.org/docs/9.2/static/multibyte.html</a><div>2.&nbsp;<a style="line-height: 22px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201211281407682/"   >http://blog.163.com/digoal@126/blog/static/163877040201211281407682/</a></div></div>
	</div>
</div>
</body>
</html>