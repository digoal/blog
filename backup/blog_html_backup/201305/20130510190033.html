<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL SQL_ASCII encoding introduce</h2>
	<h5 id="">2013-05-10 19:00:33&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201341063859551/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>一位网友想将PostgreSQL数据库从sql_ascii编码迁移到utf8编码.</div><div>这里涉及到编码的转换, 首先要了解一下sql_ascii的编码含义 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >The SQL_ASCII setting behaves considerably differently from the other settings. When the server character set is SQL_ASCII, the server interprets byte values 0-127 according to the ASCII standard, while byte values 128-255 are taken as uninterpreted characters. No encoding conversion will be done when the setting is SQL_ASCII. Thus, this setting is not so much a declaration that a specific encoding is in use, as a declaration of ignorance about the encoding. In most cases, if you are working with any non-ASCII data, it is unwise to use the SQL_ASCII setting because PostgreSQL will be unable to help you by converting or validating non-ASCII characters.</font></p></pre></div><div>注意这句话 :&nbsp;</div><div><span style="line-height: 22px;"   >PostgreSQL will be unable to help you by converting or validating non-ASCII characters.</span></div><div>说白了ASCII存储的就是单字节流. 并且没有能力判断多字节字符的有效性, 所以会一股脑存储进去.</div><div>换句话说你可能在SQL_ASCII中存储了utf8编码的字符, 也存储了gbk编码的字符, 还存储了其他编码的字符.</div><div>那么要将sql_ascii转换成UTF8就不是一件易事了, 会遇到多种字符的转换工作.&nbsp;</div><div>最好自己写个转换程序, 一行一行的转换.</div><div>例子 :&nbsp;</div><div>初始化一个SQL_ASCII数据库集群 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >initdb -E SQL_ASCII --locale=C -U postgres -W -D /pgdata1222</font></p></pre></div><div>启动数据库 :&nbsp;</div><div><pre class="prettyprint"   ><p><font size="2"   >pg_ctl start -D /pgdata1222</font></p></pre></div><div>查看当前服务器字符集环境</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >pg93@db-172-16-3-33-&gt; locale</font></div><div><font size="2"   >LANG=en_US.utf8</font></div><div><font size="2"   >LC_CTYPE="en_US.utf8"</font></div><div><font size="2"   >LC_NUMERIC="en_US.utf8"</font></div><div><font size="2"   >LC_TIME="en_US.utf8"</font></div><div><font size="2"   >LC_COLLATE="en_US.utf8"</font></div><div><font size="2"   >LC_MONETARY="en_US.utf8"</font></div><div><font size="2"   >LC_MESSAGES="en_US.utf8"</font></div><div><font size="2"   >LC_PAPER="en_US.utf8"</font></div><div><font size="2"   >LC_NAME="en_US.utf8"</font></div><div><font size="2"   >LC_ADDRESS="en_US.utf8"</font></div><div><font size="2"   >LC_TELEPHONE="en_US.utf8"</font></div><div><font size="2"   >LC_MEASUREMENT="en_US.utf8"</font></div><div><font size="2"   >LC_IDENTIFICATION="en_US.utf8"</font></div><div><font size="2"   >LC_ALL=</font></div><p></p></pre></div><div>连接数据库</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql -h 127.0.0.1 -p 1222</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   >digoal=# \l+</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;List of databases</font></div><div><font size="2"   >&nbsp; &nbsp;Name &nbsp; &nbsp;| &nbsp;Owner &nbsp; | Encoding &nbsp;| Collate | Ctype | &nbsp; Access privileges &nbsp; | &nbsp;Size &nbsp; | Tablespace | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Description &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+----------+-----------+---------+-------+-----------------------+---------+------------+--------------------------------</font></div><div><font size="2"   >------------</font></div><div><font size="2"   >&nbsp;postgres &nbsp;| postgres | SQL_ASCII | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | 6554 kB | pg_default | default administrative connecti</font></div><div><font size="2"   >on database</font></div><div><font size="2"   >&nbsp;template0 | postgres | SQL_ASCII | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+| 6425 kB | pg_default | unmodifiable empty database</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;template1 | postgres | SQL_ASCII | C &nbsp; &nbsp; &nbsp; | C &nbsp; &nbsp; | =c/postgres &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;+| 6425 kB | pg_default | default template for new databa</font></div><div><font size="2"   >ses</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; | postgres=CTc/postgres | &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(3 rows)</font></div></div><div><div><font size="2"   >digoal=# show client_encoding;</font></div><div><font size="2"   >&nbsp;client_encoding&nbsp;</font></div><div><font size="2"   >-----------------</font></div><div><font size="2"   >&nbsp;UTF8</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div><div>把客户端编码改成sql_ascii, 这样的话客户端也不检查多字节编码合法性, 服务端也是sql_ascii, 所以服务端也不检测.</div><div>就可以随意输入了.</div><div>看看终端的编码</div><div><div><img title="PostgreSQL SQL_ASCII encoding introduce - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL SQL_ASCII encoding introduce - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img1.ph.126.net/shGXStVOKgKXoMaU203r2g==/1986368910747135043.png"   ></div>插入数据</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t values ('刘德华');</font></div><div><span style="line-height: 22px;"   ><font size="2"   >INSERT 0 1</font></span></div><p></p></pre></div><div>终端改成gbk, 再插入</div><div><img title="PostgreSQL SQL_ASCII encoding introduce - 德哥@Digoal - PostgreSQL"   alt="PostgreSQL SQL_ASCII encoding introduce - 德哥@Digoal - PostgreSQL"   style="margin:0 10px 0 0;"   src="http://img0.ph.126.net/foiYrBDkmZr-E-2wl0WjAg==/3243717631713623691.png"   ></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# insert into t values ('刘德华');</font></div><div><span style="line-height: 22px;"   ><font size="2"   >INSERT 0 1</font></span></div><p></p></pre></div><div>现在有两条数据了, 并且两条数据的编码不一样.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select *,info::bytea from t;</font></div><div><font size="2"   >&nbsp; &nbsp;info &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; info &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+----------------------</font></div><div><font size="2"   >&nbsp;寰峰?| \xe58898e5beb7e58d8e</font></div><div><font size="2"   >&nbsp;刘德华 &nbsp; &nbsp;| \xc1f5b5c2bbaa</font></div><div><font size="2"   >(2 rows)</font></div><p></p></pre></div><div>如果要把这样子的数据转换成utf8字符集的话, 肯定是有问题的. 因为每种字符集都有自己的编码规则.</div><div>这里的2行字节流显然不一样的.</div><div><br></div><div>如果你真的在使用sql_ascii的服务端编码, 那么比较靠谱的用法是设置postgresql.conf参数.</div><div>client_encoding=utf8</div><div>这样的话就规避了上面的问题.</div><div><br></div><div>下面我们来看看将终端设置成gbk, client_encoding设置成utf8然后插入中文的效果 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# show client_encoding;</font></div><div><font size="2"   >&nbsp;client_encoding&nbsp;</font></div><div><font size="2"   >-----------------</font></div><div><font size="2"   >&nbsp;UTF8</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   >postgres=# insert into t values ('刘德华');</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0xc1 0xf5</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte sequence for encoding "UTF8": 0xc1 0xf5</font></div><p></p></pre></div><div>这时报错了, 因为客户端设置了utf8字符集, 而终端(这里指我的SecureCRT软件)是gbk, 终端根据gbk编码将中文字符转换成字节流<span style="line-height: 22px;"   >\xc1f5b5c2bbaa, 插入数据库.</span></div><div><span style="line-height: 22px;"   >此时因为client_encoding=utf8, 所以报错了.</span></div><div><br></div><div>和服务器的环境没有关系.</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >pg93@db-172-16-3-33-&gt; export LANG=en_US.gbk</font></div><div><font size="2"   >pg93@db-172-16-3-33-&gt; psql -h 127.0.0.1 -p 1222</font></div><div><font size="2"   >psql (9.3devel)</font></div><div><font size="2"   >Type "help" for help.</font></div></div><div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>=# set client_encoding='utf8';</font></div><div><font size="2"   >SET</font></div></div><div><font size="2"   >将终端编码改成gbk</font></div><div><div><font size="2"   >digoal=# insert into t values ('刘德华');</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>'# ';</font></div><div><font size="2"   ><span style="line-height: 22px;"   >digoal</span>(# );</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte value for encoding "SQL_ASCII": 0xe5</font></div><div><font size="2"   >ERROR: &nbsp;invalid byte value for encoding "SQL_ASCII": 0xe5</font></div></div><p></p></pre></div><div><br></div>[参考]<div><wbr><div>1.&nbsp;PostgreSQL WHY ERROR: invalid byte sequence for encoding "UTF8"</div><div><a style="line-height: 22px;" href="http://blog.163.com/digoal@126/blog/static/163877040201211281407682/"   >http://blog.163.com/digoal@126/blog/static/163877040201211281407682/</a></div></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL SQL_ASCII encoding introduce - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">francs - 2013-05-10 21:55:46</h5>
				<div>德哥V5，解释得非常清楚。</div>
			</div>
	</div>
</div>
</body>
</html>