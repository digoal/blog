<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL数据库开源连接池pgbouncer的使用</h2>
	<h5 id="">2010-05-11 22:19:13&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402010411101913839/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><p style="TEXT-INDENT: 2em;"   >首先，先介绍一个postgresql的资源网站:<a rel="nofollow" href="http://pgfoundry.org/"   >http://pgfoundry.org/</a>&nbsp;这里面有非常多和POSTGRESQL相关的资源。</p>  <p style="TEXT-INDENT: 2em;"   >pgbouncer是一个非常小型的连接池，最经典的用法是在plproxy环境中。</p>  <p style="TEXT-INDENT: 2em;"   >这里介绍一下在LINUX平台下的安装和使用，安装时需要libevent,gcc,make等常用工具。</p>  <p style="TEXT-INDENT: 2em;"   >下载：</p>  <p style="TEXT-INDENT: 2em;"   >源码 http://pgfoundry.org/frs/download.php/2608/pgbouncer-1.3.2.tgz</p>  <p style="TEXT-INDENT: 2em;"   >文档 http://developer.skype.com/SkypeGarage/DbProjects/PgBouncer</p>  <p style="TEXT-INDENT: 2em;"   >libevent源码 http://monkey.org/~provos/libevent/ 下一个稳定版</p>  <p style="TEXT-INDENT: 2em;"   >安装：</p>  <p style="TEXT-INDENT: 2em;"   >1. 安装LIBEVENT</p>  <p style="TEXT-INDENT: 2em;"   >解包</p>  <p style="TEXT-INDENT: 2em;"   >cd libevent-1.4.13-stable</p>  <p style="TEXT-INDENT: 2em;"   >less README &nbsp;查看一下帮助文档</p>  <p style="TEXT-INDENT: 2em;"   >./configure &amp;&amp; make</p>  <p style="TEXT-INDENT: 2em;"   >make install</p>  <p style="TEXT-INDENT: 2em;"   >2.安装PGBOUNCER</p>  <p style="TEXT-INDENT: 2em;"   >解包</p>  <p style="TEXT-INDENT: 2em;"   >cd pgbouncer-1.3.2</p>  <p style="TEXT-INDENT: 2em;"   >less README</p>  <p style="TEXT-INDENT: 2em;"   >./configure Cprefix=/opt/pgbouncer Cwith-libevent=/usr/local/</p>  <p style="TEXT-INDENT: 2em;"   >make</p>  <p style="TEXT-INDENT: 2em;"   >make install</p>  <p style="TEXT-INDENT: 2em;"   >3.修改环境变量</p>  <p style="TEXT-INDENT: 2em;"   >su C postgres</p>  <p style="TEXT-INDENT: 2em;"   >export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH</p>  <p style="TEXT-INDENT: 2em;"   >4.编写配置文件与用户密码文件</p>  <p style="TEXT-INDENT: 2em;"   >su C postgres</p>  <p style="TEXT-INDENT: 2em;"   >mkdir -p ~/pgconfig</p>  <p style="TEXT-INDENT: 2em;"   >cd ~/pgconfig</p>  <p style="TEXT-INDENT: 2em;"   >vi users.txt</p>  <p style="TEXT-INDENT: 2em;"   >“gamehall” “*************”</p>  <p style="TEXT-INDENT: 2em;"   >vi config.ini</p>  <p style="TEXT-INDENT: 2em;"   >[databases]</p>  <p style="TEXT-INDENT: 2em;"   >gamehall = host=192.168.*.* dbname=**** port=****</p>  <p style="TEXT-INDENT: 2em;"   >[pgbouncer]</p>  <p style="TEXT-INDENT: 2em;"   >pool_mode = transaction</p>  <p style="TEXT-INDENT: 2em;"   >listen_port = 9601</p>  <p style="TEXT-INDENT: 2em;"   >listen_addr = *</p>  <p style="TEXT-INDENT: 2em;"   >auth_type = md5</p>  <p style="TEXT-INDENT: 2em;"   >auth_file = /home/postgres/pgconfig/users.txt</p>  <p style="TEXT-INDENT: 2em;"   >logfile = /dev/null</p>  <p style="TEXT-INDENT: 2em;"   >pidfile = /home/postgres/pgconfig/pgbouncer.pid</p>  <p style="TEXT-INDENT: 2em;"   >max_client_conn = 1500</p>  <p style="TEXT-INDENT: 2em;"   >default_pool_size = 200</p>  <p style="TEXT-INDENT: 2em;"   >reserve_pool_timeout = 0</p>  <p style="TEXT-INDENT: 2em;"   >reserve_pool_size = 30</p>  <p style="TEXT-INDENT: 2em;"   >server_reset_query = DISCARD ALL;</p>  <p style="TEXT-INDENT: 2em;"   >admin_users = pgbouncer_admin</p>  <p style="TEXT-INDENT: 2em;"   >stats_users = pgbouncer_guest</p>  <p style="TEXT-INDENT: 2em;"   >ignore_startup_parameters = extra_float_digits</p>  <p style="TEXT-INDENT: 2em;"   >5.启动pgbouncer</p>  <p style="TEXT-INDENT: 2em;"   >su C postgres</p>  <p style="TEXT-INDENT: 2em;"   >/opt/pgbouncer/bin/pgbouncer -d /home/postgres/pgconfig/config.ini</p>  <p style="TEXT-INDENT: 2em;"   >6.测试</p>  <p style="TEXT-INDENT: 2em;"   >psql -h 127.0.0.1 -p 9601 -U gamehall -d **** -W</p>  <p style="TEXT-INDENT: 2em;"   >正常</p>  <p style="TEXT-INDENT: 2em;"   >PGBOUNCER配置介绍:</p>  <p style="TEXT-INDENT: 2em;"   >非常详细的介绍在DOC里面有，这里简单介绍一下连接池模式</p>  <p style="TEXT-INDENT: 2em;"   >Session pooling::</p>  <p style="TEXT-INDENT: 2em;"   >Most polite method. &nbsp;When client connects, a server connection</p>  <p style="TEXT-INDENT: 2em;"   >will be assigned to it for the whole duration it stays connected.</p>  <p style="TEXT-INDENT: 2em;"   >When client disconnects, the server connection will be put back</p>  <p style="TEXT-INDENT: 2em;"   >into pool.</p>  <p style="TEXT-INDENT: 2em;"   >Transaction pooling::</p>  <p style="TEXT-INDENT: 2em;"   >Server connection is assigned to client only during a transaction.</p>  <p style="TEXT-INDENT: 2em;"   >When !PgBouncer notices that transaction is over, the server</p>  <p style="TEXT-INDENT: 2em;"   >will be put back into pool. &nbsp;This is a hack as it breaks application</p>  <p style="TEXT-INDENT: 2em;"   >expectations of backend connection. &nbsp;You can use it only when</p>  <p style="TEXT-INDENT: 2em;"   >application cooperates with such usage by not using features</p>  <p style="TEXT-INDENT: 2em;"   >that can break. &nbsp;See the table below for breaking features.</p>  <p style="TEXT-INDENT: 2em;"   >Statement pooling::</p>  <p style="TEXT-INDENT: 2em;"   >Most aggressive method. &nbsp;This is transaction pooling with a twist -</p>  <p style="TEXT-INDENT: 2em;"   >multi-statement transactions are disallowed. &nbsp;This is meant to enforce</p>  <p style="TEXT-INDENT: 2em;"   >“autocommit” mode on client, mostly targeted for PL/Proxy.</p>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="PostgreSQL数据库开源连接池pgbouncer的使用 - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>