<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">记录一次EnterpriseDB的索引异常失效处理</h2>
	<h5 id="">2010-05-11 22:21:12&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402010411102112458/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><p style="TEXT-INDENT: 2em;"  >ENTERPRISEDB 数据库执行计划异常问题处理。</p> <p style="TEXT-INDENT: 2em;"  >环境：</p> <p style="TEXT-INDENT: 2em;"  >enterprisedb 8.3R2</p> <p style="TEXT-INDENT: 2em;"  >现象：</p> <p style="TEXT-INDENT: 2em;"  ></p><pre class="prettyprint"  ><p></p><p style="TEXT-INDENT: 2em;"  ><font size="2"  >explain analyze SELECT skyid, grade,experience, gold, gamenum, dualwinnum,dualgamenum, stockfunds FROM tbl_starwar_player t WHERE skyid=103502;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >QUERY PLAN</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >――――――――――――――――――――――――――――――――――――――――-</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Seq Scan on tbl_starwar_player t &nbsp;(cost=0.00..240410.84 rows=1 width=36) (actual time=235.438..5797.695 rows=1 loops=1)</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Filter: (skyid = 103502)</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Total runtime: 5797.725 ms</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >(3 rows)</font></p><p></p></pre> <p style="TEXT-INDENT: 2em;"  >处理过程：</p> <p style="TEXT-INDENT: 2em;"  >1. 使用HINT没有效果</p> <p style="TEXT-INDENT: 2em;"  ></p><p></p><p style="TEXT-INDENT: 2em;"  ></p><pre class="prettyprint"  ><p></p><p style="TEXT-INDENT: 2em;"  ><font size="2"  >explain analyze SELECT /*+ index(t tbl_starwar_player_pkey) */ skyid, grade,experience, gold, gamenum, dualwinnum,dualgamenum, stockfunds FROM tbl_starwar_player t WHERE skyid=103502;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >QUERY PLAN</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >――――――――――――――――――――――――――――――――――――――――-</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Seq Scan on tbl_starwar_player t &nbsp;(cost=0.00..240410.84 rows=1 width=36) (actual time=235.438..5797.695 rows=1 loops=1)</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Filter: (skyid = 103502)</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Total runtime: 5797.725 ms</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >(3 rows)</font></p><p></p></pre> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >2. reindex table tbl_starwar_player; analyze tbl_starwar_player;没有效果</font></p> <p style="TEXT-INDENT: 2em;"  ></p><p></p><p style="TEXT-INDENT: 2em;"  ></p><pre class="prettyprint"  ><p></p><p style="TEXT-INDENT: 2em;"  ></p><p style="TEXT-INDENT: 2em;"  ><font size="2"  >gamehall=&gt; reindex table tbl_starwar_player;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >ERROR: &nbsp;deadlock detected</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >DETAIL: &nbsp;Process 16747 waits for AccessExclusiveLock on relation 55713 of database 16571; blocked by process 16714.</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Process 16714 waits for RowExclusiveLock on relation 19084 of database 16571; blocked by process 16747.</font></p><p></p> <p style="TEXT-INDENT: 2em;"  >C 杀掉所有GAMEHALL进程,</p><p style="TEXT-INDENT: 2em;"  ></p><p></p><p style="TEXT-INDENT: 2em;"  ><font size="2"  >SELECT count(*) from (select pg_cancel_backend(procpid) from pg_stat_activity where usename=’gamehall’) t;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >explain analyze SELECT skyid, grade,experience, gold, gamenum, dualwinnum,dualgamenum, stockfunds FROM tbl_starwar_player t WHERE skyid=103502;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >QUERY PLAN</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >――――――――――――――――――――――――――――――――――――――――-</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Seq Scan on tbl_starwar_player t &nbsp;(cost=0.00..240410.84 rows=1 width=36) (actual time=235.438..5797.695 rows=1 loops=1)</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Filter: (skyid = 103502)</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Total runtime: 5797.725 ms</font></p> <p></p><p></p><p style="TEXT-INDENT: 2em;"  ><font size="2"  >(3 rows)</font></p><p></p></pre><p></p> <p style="TEXT-INDENT: 2em;"  >3. 重建表</p> <p style="TEXT-INDENT: 2em;"  >C 杀掉所有GAMEHALL进程,</p><p style="TEXT-INDENT: 2em;"  ></p><pre class="prettyprint"  ><p></p><p style="TEXT-INDENT: 2em;"  ><font size="2"  >SELECT count(*) from (select pg_cancel_backend(procpid) from pg_stat_activity where usename=’gamehall’) t;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >C 重建表</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >C 无效</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >set maintenance_work_mem=’6000 MB’;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >create table tmp_tbl_starwar_player (like tbl_starwar_player);</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >begin;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >lock table tbl_starwar_player in exclusive mode;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >lock table tbl_starwar_map_rank in exclusive mode;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >insert into tmp_tbl_starwar_player select * from tbl_starwar_player;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >alter table tbl_starwar_map_rank drop constraint tbl_starwar_map_rank_skyid_fkey;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >truncate table tbl_starwar_player;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >insert into tbl_starwar_player select * from tmp_tbl_starwar_player;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >alter table tbl_starwar_map_rank add foreign key (skyid) references tbl_starwar_player(skyid);</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >commit;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >analyze tbl_starwar_player;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >explain analyze SELECT skyid, grade,experience, gold, gamenum, dualwinnum,dualgamenum, stockfunds FROM tbl_starwar_player t WHERE skyid=103502;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >QUERY PLAN</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >――――――――――――――――――――――――――――――――――――――――-</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Seq Scan on tbl_starwar_player t &nbsp;(cost=0.00..240410.84 rows=1 width=36) (actual time=235.438..5797.695 rows=1 loops=1)</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Filter: (skyid = 103502)</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Total runtime: 5797.725 ms</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >(3 rows)</font></p><p></p></pre> <p style="TEXT-INDENT: 2em;"  >4. 重建约束</p> <p style="TEXT-INDENT: 2em;"  >C 杀掉所有GAMEHALL进程,</p><p style="TEXT-INDENT: 2em;"  ></p><pre class="prettyprint"  ><p></p><p style="TEXT-INDENT: 2em;"  ><font size="2"  >SELECT count(*) from (select pg_cancel_backend(procpid) from pg_stat_activity where usename=’gamehall’) t;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >C 重建约束</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >C 有效</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >begin;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >lock table tbl_starwar_player in exclusive mode;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >lock table tbl_starwar_map_rank in exclusive mode;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >alter table tbl_starwar_map_rank drop constraint tbl_starwar_map_rank_skyid_fkey;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >alter table tbl_starwar_player drop constraint tbl_starwar_player_pkey;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >drop index idx_tbl_starwar_player_experience;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >alter table tbl_starwar_player add primary key (skyid) ;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >create index idx_tbl_starwar_player_experience on tbl_starwar_player(experience) ;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >alter table tbl_starwar_map_rank add foreign key (skyid) references tbl_starwar_player(skyid);</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >commit;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >analyze tbl_starwar_player;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >explain analyze SELECT skyid, grade,experience, gold, gamenum, dualwinnum,dualgamenum, stockfunds FROM tbl_starwar_player t WHERE skyid=103502;</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >QUERY PLAN</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >―――――――――――――――――――――――――――――――――――――――――――――――C</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Index Scan using tbl_starwar_player_pkey on tbl_starwar_player t &nbsp;(cost=0.00..7.63 rows=1 width=36) (actual time=0.065..0.066 rows=1 loops=1)</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Index Cond: (skyid = 103502)</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >Total runtime: 0.089 ms</font></p> <p style="TEXT-INDENT: 2em;"  ><font size="2"  >(3 rows)</font></p><p></p></pre> <p style="TEXT-INDENT: 2em;"  ></p></div>
	</div>
</div>
</body>
</html>