<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">使用Plproxy设计PostgreSQL分布式数据库(一)</h2>
	<h5 id="">2010-05-11 23:30:04&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201041111304328/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><p style="TEXT-INDENT: 2em;"   >PostgreSQL的分布式数据库方案很多，如GridSQL,pgpool-ii,plproxy等。</p>
<p style="TEXT-INDENT: 2em;"   >其中plproxy是skype开发的一个数据库组件.</p>
<p style="TEXT-INDENT: 2em;"   >使用plproxy设计跨互联网部署还要考虑带宽的问题和应用是否要做本地缓存等问题，</p>
<p style="TEXT-INDENT: 2em;"   >plproxy源代码对代理库的个数做了限制必须是2的次方，如果要打破这个限制需要修改源代码.</p>
<p style="TEXT-INDENT: 2em;"   >以下是一个测试方案：</p>
<p style="TEXT-INDENT: 2em;"   >1. 安装postgres 8.3.3 , plproxy , libevent , pgbouncer ;</p>
<p style="TEXT-INDENT: 2em;"   >2. 配置数据库</p>
<p style="TEXT-INDENT: 2em;"   >配置pg_hba.conf , postgres.conf</p>
<p style="TEXT-INDENT: 2em;"   >创建表空间目录</p>
<p style="TEXT-INDENT: 2em;"   >创建role</p>
<p style="TEXT-INDENT: 2em;"   >创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >创建数据库</p>
<p style="TEXT-INDENT: 2em;"   >创建schema</p>
<p style="TEXT-INDENT: 2em;"   >安装过程语言plproxy , plpgsql</p>
<p style="TEXT-INDENT: 2em;"   >3. 配置启用pgbouncer</p>
<p style="TEXT-INDENT: 2em;"   >4. 配置plproxy连接函数</p>
<p style="TEXT-INDENT: 2em;"   >5. 分区库(建表,函数)</p>
<p style="TEXT-INDENT: 2em;"   >6. 代理库(建表,函数)</p>
<p style="TEXT-INDENT: 2em;"   >7. 哈希分区函数</p>
<p style="TEXT-INDENT: 2em;"   >8. 测试.</p>
<p style="TEXT-INDENT: 2em;"   >9. 参考文档.</p>
<p style="TEXT-INDENT: 2em;"   >模拟环境构想(使用地区1 , 地区2 , 地区3 , 地区4 , 地区5目的是便于理解跨互联网的概念) :</p>
<p style="TEXT-INDENT: 2em;"   >1. 数据中心 ( 地区1 , 地区2 , 地区3 , 地区4 , 地区5 )</p>
<p style="TEXT-INDENT: 2em;"   >2. 数据库布局 :</p>
<p style="TEXT-INDENT: 2em;"   >地区1 : 分区库 ( sgap_testrole_0 , sgap_testrole_1 ) ; 代理库 ( sgap_plproxy_0 )</p>
<p style="TEXT-INDENT: 2em;"   >地区2 : 分区库 ( bj_testrole_0 , bj_testrole_1 ) ; 代理库 ( bj_plproxy_0 )</p>
<p style="TEXT-INDENT: 2em;"   >地区3 : 分区库 ( sh_testrole_0 , sh_testrole_1 ) ; 代理库 ( sh_plproxy_0 )</p>
<p style="TEXT-INDENT: 2em;"   >地区4 : 分区库 ( gz_testrole_0 , gz_testrole_1 ) ; 代理库 ( gz_plproxy_0 )</p>
<p style="TEXT-INDENT: 2em;"   >地区5 : 分区库 ( hz_testrole_0 , hz_testrole_1 ) ; 代理库 ( hz_plproxy_0 )</p>
<p style="TEXT-INDENT: 2em;"   >设计规范 :</p>
<p style="TEXT-INDENT: 2em;"   >1. role_name规划</p>
<p style="TEXT-INDENT: 2em;"   >分区库 ( 考虑到程序设计的方便,业务库统一使用testrole角色名,密码配置完全相同 )</p>
<p style="TEXT-INDENT: 2em;"   >代理库 ( 所有分区库统一使用与业务库同名角色名,便于管理, 密码配置完全相同 )</p>
<p style="TEXT-INDENT: 2em;"   >权限 nosuperuser nocreatedb nocreaterole noinherit login</p>
<p style="TEXT-INDENT: 2em;"   >2. schema设计 :</p>
<p style="TEXT-INDENT: 2em;"   >分区库schema设计 ( 所有业务数据放到testrole schema下 )</p>
<p style="TEXT-INDENT: 2em;"   >代理库schema设计 ( 创建一个和业务库同名的schema , 创建一个plproxy schema)</p>
<p style="TEXT-INDENT: 2em;"   >3. 集群组划分 :</p>
<p style="TEXT-INDENT: 2em;"   >all ― 包含了所有的分区库</p>
<p style="TEXT-INDENT: 2em;"   >dbname=sgap_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=sgap_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=bj_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=bj_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=sh_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=sh_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=gz_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=gz_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >C dbname=hz_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >C dbname=hz_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >plproxy_all &nbsp;C 包含了所有的代理库</p>
<p style="TEXT-INDENT: 2em;"   >dbname=sgap_plproxy_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=bj_plproxy_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=sh_plproxy_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=gz_plproxy_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >C dbname=hz_plproxy_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >sgap_testrole_all ― 包含了当地的所有分区库</p>
<p style="TEXT-INDENT: 2em;"   >dbname=sgap_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >dbname=sgap_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601</p>
<p style="TEXT-INDENT: 2em;"   >bj_testrole_all</p>
<p style="TEXT-INDENT: 2em;"   >sh_testrole_all</p>
<p style="TEXT-INDENT: 2em;"   >gz_testrole_all</p>
<p style="TEXT-INDENT: 2em;"   >hz_testrole_all</p>
<p style="TEXT-INDENT: 2em;"   >sgap_testrole_0</p>
<p style="TEXT-INDENT: 2em;"   >sgap_testrole_1</p>
<p style="TEXT-INDENT: 2em;"   >bj_testrole_0</p>
<p style="TEXT-INDENT: 2em;"   >bj_testrole_1</p>
<p style="TEXT-INDENT: 2em;"   >sh_testrole_0</p>
<p style="TEXT-INDENT: 2em;"   >sh_testrole_1</p>
<p style="TEXT-INDENT: 2em;"   >gz_testrole_0</p>
<p style="TEXT-INDENT: 2em;"   >gz_testrole_1</p>
<p style="TEXT-INDENT: 2em;"   >hz_testrole_0</p>
<p style="TEXT-INDENT: 2em;"   >hz_testrole_1</p>
<p style="TEXT-INDENT: 2em;"   >4. 表名设计 :</p>
<p style="TEXT-INDENT: 2em;"   >记录分析列的表名:</p>
<p style="TEXT-INDENT: 2em;"   >C pk_tbl_test : partition_key tbl_test ;</p>
<p style="TEXT-INDENT: 2em;"   >5. 函数名 :</p>
<p style="TEXT-INDENT: 2em;"   >前缀设计 (Cprefix缩写) :</p>
<p style="TEXT-INDENT: 2em;"   >Clust_all &lt;==&gt; ca_</p>
<p style="TEXT-INDENT: 2em;"   >Cluster_plproxy_all &lt;==&gt; cpa_</p>
<p style="TEXT-INDENT: 2em;"   >Cluster_plproxy &lt;==&gt; cp_</p>
<p style="TEXT-INDENT: 2em;"   >Cluster_local_all &lt;==&gt; cla_</p>
<p style="TEXT-INDENT: 2em;"   >后缀设计 (Csuffix缩写) :</p>
<p style="TEXT-INDENT: 2em;"   >Select &lt;==&gt; sel</p>
<p style="TEXT-INDENT: 2em;"   >Insert &lt;==&gt; ins</p>
<p style="TEXT-INDENT: 2em;"   >Update &lt;==&gt; up</p>
<p style="TEXT-INDENT: 2em;"   >Delete &lt;==&gt; del</p>
<p style="TEXT-INDENT: 2em;"   >Insert + update + delete &lt;==&gt; iud</p>
<p style="TEXT-INDENT: 2em;"   >嵌入名(Cmidfix缩写) : 如表名嵌入</p>
<p style="TEXT-INDENT: 2em;"   >示例:</p>
<p style="TEXT-INDENT: 2em;"   >ca_tbl_test_sel : 解析 cluster ‘all’ , select , tbl_test ;</p>
<p style="TEXT-INDENT: 2em;"   >ca_iud : 解析 cluster ‘all’ , insert &amp; update &amp; delete ; ― 无表名一般指所有表通用此函数 ;</p>
<p style="TEXT-INDENT: 2em;"   >cpa_iud : 解析 cluster ‘plproxy_all’ , insert &amp; update &amp; delete ; ― 有表名一般指每个表都得建此函数 ;</p>
<p style="TEXT-INDENT: 2em;"   >5. 数据库命名规范 :</p>
<p style="TEXT-INDENT: 2em;"   >$LOCALIZATION_$NAME_$ID</p>
<p style="TEXT-INDENT: 2em;"   >细节 :</p>
<p style="TEXT-INDENT: 2em;"   >1. 安装postgres 8.3.3 , plproxy , libevent , pgbouncer ;</p>
<p style="TEXT-INDENT: 2em;"   >C 参考相关文档 .</p>
<p style="TEXT-INDENT: 2em;"   >C 值得注意的是libevent安装好后,继续安装pgbouncer需要配置LD_LIBRARY_PATH使之能找到对应的so文件.</p>
<p style="TEXT-INDENT: 2em;"   >2. 配置数据库</p>
<p style="TEXT-INDENT: 2em;"   >1. 配置pg_hba.conf , postgres.conf</p>
<p style="TEXT-INDENT: 2em;"   >host all all 0.0.0.0/0 md5</p>
<p style="TEXT-INDENT: 2em;"   >listen_addresses = ‘*’</p>
<p style="TEXT-INDENT: 2em;"   >2. 创建表空间目录</p>
<p style="TEXT-INDENT: 2em;"   >su C postgres</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_sgap_testrole_0_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_sgap_testrole_1_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_sh_testrole_0_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_sh_testrole_1_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_bj_testrole_0_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_bj_testrole_1_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_gz_testrole_0_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_gz_testrole_1_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_hz_testrole_0_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_hz_testrole_1_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_sgap_plproxy_0_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_bj_plproxy_0_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_sh_plproxy_0_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_gz_plproxy_0_def</p>
<p style="TEXT-INDENT: 2em;"   >mkdir $PGDATA/tbs_hz_plproxy_0_def</p>
<p style="TEXT-INDENT: 2em;"   >3. 创建role ( 分区库 , 代理库 )</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’ ;</p>
<p style="TEXT-INDENT: 2em;"   >4. 创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_sgap_testrole_0 owner testrole location ‘/database/pgdata/tbs_sgap_testrole_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_bj_testrole_0 owner testrole location ‘/database/pgdata/tbs_bj_testrole_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_sh_testrole_0 owner testrole location ‘/database/pgdata/tbs_sh_testrole_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_gz_testrole_0 owner testrole location ‘/database/pgdata/tbs_gz_testrole_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_hz_testrole_0 owner testrole location ‘/database/pgdata/tbs_hz_testrole_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_sgap_testrole_1 owner testrole location ‘/database/pgdata/tbs_sgap_testrole_1_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_bj_testrole_1 owner testrole location ‘/database/pgdata/tbs_bj_testrole_1_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_sh_testrole_1 owner testrole location ‘/database/pgdata/tbs_sh_testrole_1_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_gz_testrole_1 owner testrole location ‘/database/pgdata/tbs_gz_testrole_1_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_hz_testrole_1 owner testrole location ‘/database/pgdata/tbs_hz_testrole_1_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_sgap_plproxy_0 owner testrole location ‘/database/pgdata/tbs_sgap_plproxy_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_bj_plproxy_0 owner testrole location ‘/database/pgdata/tbs_bj_plproxy_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_sh_plproxy_0 owner testrole location ‘/database/pgdata/tbs_sh_plproxy_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_gz_plproxy_0 owner testrole location ‘/database/pgdata/tbs_gz_plproxy_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_hz_plproxy_0 owner testrole location ‘/database/pgdata/tbs_hz_plproxy_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >5. 创建数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database sgap_testrole_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_sgap_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >create database sgap_testrole_1 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_sgap_testrole_1;</p>
<p style="TEXT-INDENT: 2em;"   >create database sgap_plproxy_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_sgap_plproxy_0;</p>
<p style="TEXT-INDENT: 2em;"   >create database bj_testrole_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_bj_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >create database bj_testrole_1 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_bj_testrole_1;</p>
<p style="TEXT-INDENT: 2em;"   >create database bj_plproxy_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_bj_plproxy_0;</p>
<p style="TEXT-INDENT: 2em;"   >create database sh_testrole_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_sh_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >create database sh_testrole_1 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_sh_testrole_1;</p>
<p style="TEXT-INDENT: 2em;"   >create database sh_plproxy_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_sh_plproxy_0;</p>
<p style="TEXT-INDENT: 2em;"   >create database gz_testrole_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_gz_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >create database gz_testrole_1 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_gz_testrole_1;</p>
<p style="TEXT-INDENT: 2em;"   >create database gz_plproxy_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_gz_plproxy_0;</p>
<p style="TEXT-INDENT: 2em;"   >create database hz_testrole_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_hz_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >create database hz_testrole_1 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_hz_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >create database hz_plproxy_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_hz_plproxy_0;</p>
<p style="TEXT-INDENT: 2em;"   >6. 创建schema ( partition db ==&gt; testrole ; plproxy db ==&gt; testrole + plproxy )</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole ;</p>
<p style="TEXT-INDENT: 2em;"   >create schema plproxy authorization testrole ;</p>
<p style="TEXT-INDENT: 2em;"   >7. 安装过程语言( partition db ==&gt; plpgsql ; plproxy db ==&gt; plpgsql + plproxy )</p>
<p style="TEXT-INDENT: 2em;"   >C plproxy ; ( psql PLPROXY_DB_NAME postgres -f $PGHOME/share/contrib/plproxy.sql )</p>
<p style="TEXT-INDENT: 2em;"   >C psql sgap_plproxy_0 postgres -f /app/pgsql/share/contrib/plproxy.sql</p>
<p style="TEXT-INDENT: 2em;"   >C psql bj_plproxy_0 postgres -f /app/pgsql/share/contrib/plproxy.sql</p>
<p style="TEXT-INDENT: 2em;"   >C psql sh_plproxy_0 postgres -f /app/pgsql/share/contrib/plproxy.sql</p>
<p style="TEXT-INDENT: 2em;"   >C psql gz_plproxy_0 postgres -f /app/pgsql/share/contrib/plproxy.sql</p>
<p style="TEXT-INDENT: 2em;"   >C psql hz_plproxy_0 postgres -f /app/pgsql/share/contrib/plproxy.sql</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql ;</p>
<p style="TEXT-INDENT: 2em;"   >3. 配置启用pgbouncer</p>
<p style="TEXT-INDENT: 2em;"   >1. 创建日志目录 , 配置文件 , 用户密码文件目录</p>
<p style="TEXT-INDENT: 2em;"   >C 日志目录</p>
<p style="TEXT-INDENT: 2em;"   >su C root</p>
<p style="TEXT-INDENT: 2em;"   >mkdir -p /var/applog/pgbouncerlog</p>
<p style="TEXT-INDENT: 2em;"   >chown -R postgres:postgres /var/applog/pgbouncerlog</p>
<p style="TEXT-INDENT: 2em;"   >C 配置文件目录,注意权限管理</p>
<p style="TEXT-INDENT: 2em;"   >su C postgres</p>
<p style="TEXT-INDENT: 2em;"   >mkdir ~/config</p>
<p style="TEXT-INDENT: 2em;"   >chmod -R 700 ~/config</p>
<p style="TEXT-INDENT: 2em;"   >C 配置文件</p>
<p style="TEXT-INDENT: 2em;"   >vi ~/config/pgbouncer.ini</p>
<p style="TEXT-INDENT: 2em;"   >[databases]</p>
<p style="TEXT-INDENT: 2em;"   >sgap_testrole_0 = host=xxx.xxx.150.88 dbname=sgap_testrole_0 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >sgap_testrole_1 = host=xxx.xxx.150.88 dbname=sgap_testrole_1 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >bj_testrole_0 = host=xxx.xxx.150.88 dbname=bj_testrole_0 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >bj_testrole_1 = host=xxx.xxx.150.88 dbname=bj_testrole_1 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >sh_testrole_0 = host=xxx.xxx.150.88 dbname=sh_testrole_0 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >sh_testrole_1 = host=xxx.xxx.150.88 dbname=sh_testrole_1 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >gz_testrole_0 = host=xxx.xxx.150.88 dbname=gz_testrole_0 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >gz_testrole_1 = host=xxx.xxx.150.88 dbname=gz_testrole_1 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >hz_testrole_0 = host=xxx.xxx.150.88 dbname=hz_testrole_0 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >hz_testrole_1 = host=xxx.xxx.150.88 dbname=hz_testrole_1 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >sgap_plproxy_0 = host=xxx.xxx.150.88 dbname=sgap_plproxy_0 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >bj_plproxy_0 = host=xxx.xxx.150.88 dbname=bj_plproxy_0 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >sh_plproxy_0 = host=xxx.xxx.150.88 dbname=sh_plproxy_0 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >gz_plproxy_0 = host=xxx.xxx.150.88 dbname=gz_plproxy_0 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >hz_plproxy_0 = host=xxx.xxx.150.88 dbname=hz_plproxy_0 port=1921</p>
<p style="TEXT-INDENT: 2em;"   >[pgbouncer]</p>
<p style="TEXT-INDENT: 2em;"   >pool_mode = statement</p>
<p style="TEXT-INDENT: 2em;"   >listen_port = 9601</p>
<p style="TEXT-INDENT: 2em;"   >listen_addr = *</p>
<p style="TEXT-INDENT: 2em;"   >auth_type = md5</p>
<p style="TEXT-INDENT: 2em;"   >auth_file = /home/postgres/config/users.txt</p>
<p style="TEXT-INDENT: 2em;"   >logfile = /var/applog/pgbouncerlog/pgbouncer.log</p>
<p style="TEXT-INDENT: 2em;"   >pidfile = /var/applog/pgbouncerlog/pgbouncer.pid</p>
<p style="TEXT-INDENT: 2em;"   >admin_users = pgbouncer_admin</p>
<p style="TEXT-INDENT: 2em;"   >stats_users = pgbouncer_guest</p>
<p style="TEXT-INDENT: 2em;"   >C 密码文件</p>
<p style="TEXT-INDENT: 2em;"   >vi ~/config/users.txt</p>
<p style="TEXT-INDENT: 2em;"   >“testrole” “testrole”</p>
<p style="TEXT-INDENT: 2em;"   >“pgbouncer_admin” “admin”</p>
<p style="TEXT-INDENT: 2em;"   >“pgbouncer_guest” “guest”</p>
<p style="TEXT-INDENT: 2em;"   >#and all other database role&amp;password</p>
<p style="TEXT-INDENT: 2em;"   >4. 配置plproxy连接函数</p>
<p style="TEXT-INDENT: 2em;"   >C 获取集群组配置</p>
<p style="TEXT-INDENT: 2em;"   >CREATE OR REPLACE FUNCTION plproxy.get_cluster_partitions(cluster_name text)</p>
<p style="TEXT-INDENT: 2em;"   >RETURNS SETOF text AS $$</p>
<p style="TEXT-INDENT: 2em;"   >BEGIN</p>
<p style="TEXT-INDENT: 2em;"   >IF cluster_name = ‘all’ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sgap_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sgap_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 1</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=bj_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 2</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=bj_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 3</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sh_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 4</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sh_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 5</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=gz_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 6</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=gz_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 7</p>
<p style="TEXT-INDENT: 2em;"   >C RETURN NEXT ‘dbname=hz_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 8</p>
<p style="TEXT-INDENT: 2em;"   >C RETURN NEXT ‘dbname=hz_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 9</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ‘plproxy_all’ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sgap_plproxy_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; ― 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=bj_plproxy_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; ― 1</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sh_plproxy_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; ― 2</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=gz_plproxy_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; ― 3</p>
<p style="TEXT-INDENT: 2em;"   >C RETURN NEXT ‘dbname=hz_plproxy_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′;C 4</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ’sgap_testrole_0′ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sgap_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ’sgap_testrole_1′ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sgap_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ‘bj_testrole_0′ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=bj_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ‘bj_testrole_1′ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=bj_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ’sh_testrole_0′ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sh_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ’sh_testrole_1′ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sh_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ‘gz_testrole_0′ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=gz_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ‘gz_testrole_1′ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=gz_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ‘hz_testrole_0′ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=hz_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ‘hz_testrole_1′ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=hz_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ’sgap_testrole_all’ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sgap_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sgap_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 1</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ‘bj_testrole_all’ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=bj_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=bj_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 1</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ’sh_testrole_all’ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sh_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=sh_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 1</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ‘gz_testrole_all’ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=gz_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=gz_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 1</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >elsif cluster_name = ‘hz_testrole_all’ THEN</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=hz_testrole_0 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 0</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT ‘dbname=hz_testrole_1 host=xxx.xxx.150.88 user=testrole password=testrole port=9601′; &nbsp;C 1</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >END IF;</p>
<p style="TEXT-INDENT: 2em;"   >RAISE EXCEPTION ‘Unknown cluster’;</p>
<p style="TEXT-INDENT: 2em;"   >END;</p>
<p style="TEXT-INDENT: 2em;"   >$$ LANGUAGE plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C 获取集群组配置版本</p>
<p style="TEXT-INDENT: 2em;"   >CREATE OR REPLACE FUNCTION plproxy.get_cluster_version(i_cluster_name text)</p>
<p style="TEXT-INDENT: 2em;"   >RETURNS int4 AS $$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >i_ver int4;</p>
<p style="TEXT-INDENT: 2em;"   >BEGIN</p>
<p style="TEXT-INDENT: 2em;"   >select max(version) into i_ver from testrole.tbl_cluster_version where cluster_name=i_cluster_name;</p>
<p style="TEXT-INDENT: 2em;"   >if found then</p>
<p style="TEXT-INDENT: 2em;"   >RETURN i_ver;</p>
<p style="TEXT-INDENT: 2em;"   >end if;</p>
<p style="TEXT-INDENT: 2em;"   >RAISE EXCEPTION ‘Unknown cluster’;</p>
<p style="TEXT-INDENT: 2em;"   >END;</p>
<p style="TEXT-INDENT: 2em;"   >$$ LANGUAGE plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C 获取集群组配置参数</p>
<p style="TEXT-INDENT: 2em;"   >CREATE OR REPLACE FUNCTION plproxy.get_cluster_config(</p>
<p style="TEXT-INDENT: 2em;"   >in cluster_name text,out key text,out val text )</p>
<p style="TEXT-INDENT: 2em;"   >RETURNS SETOF record AS $$</p>
<p style="TEXT-INDENT: 2em;"   >BEGIN</p>
<p style="TEXT-INDENT: 2em;"   >C lets use same config for all clusters</p>
<p style="TEXT-INDENT: 2em;"   >key := ‘connection_lifetime’;</p>
<p style="TEXT-INDENT: 2em;"   >val := 30*60; &nbsp; ― 30m</p>
<p style="TEXT-INDENT: 2em;"   >RETURN NEXT;</p>
<p style="TEXT-INDENT: 2em;"   >C &nbsp; &nbsp; &nbsp;if cluster_name=’singap_db_testrole_2′ then</p>
<p style="TEXT-INDENT: 2em;"   >C &nbsp; &nbsp; &nbsp;C lets use same config for all clusters</p>
<p style="TEXT-INDENT: 2em;"   >C &nbsp; &nbsp; &nbsp;key := ‘connection_lifetime’;</p>
<p style="TEXT-INDENT: 2em;"   >C &nbsp; &nbsp; &nbsp;val := 30*60; ― 30m</p>
<p style="TEXT-INDENT: 2em;"   >C &nbsp; &nbsp; &nbsp;RETURN NEXT;</p>
<p style="TEXT-INDENT: 2em;"   >C &nbsp; &nbsp; &nbsp;end if;</p>
<p style="TEXT-INDENT: 2em;"   >RETURN;</p>
<p style="TEXT-INDENT: 2em;"   >END;</p>
<p style="TEXT-INDENT: 2em;"   >$$ LANGUAGE plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >5. 分区库(建表,函数)</p>
<p style="TEXT-INDENT: 2em;"   >C 创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C 创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C 创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C 创建cluster_all范围内使用insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C 创建cluster_all范围插入针对某个表,高效插入时可以使用这种方式,但是需要每个表建立相应的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C在cluster_local_all范围内使用 , 当使用plproxy级联时</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >6. 代理库(建表,函数)</p>
<p style="TEXT-INDENT: 2em;"   >C 创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C 创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C cluster 版本记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_cluster_version(cluster_name varchar(50),version int4);</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_cluster_version values (‘all’,1),(‘plproxy_all’,1),(’sgap_testrole_0′,1),(’sgap_testrole_1′,1),(‘bj_testrole_0′,1),(‘bj_testrole_1′,1),(’sh_testrole_0′,1),(’sh_testrole_1′,1),(‘gz_testrole_0′,1),(‘gz_testrole_1′,1),(‘hz_testrole_0′,1),(‘hz_testrole_1′,1),(’sgap_testrole_all’,1),(‘bj_testrole_all’,1),(’sh_testrole_all’,1),(‘gz_testrole_all’,1),(‘hz_testrole_all’,1) ;</p>
<p style="TEXT-INDENT: 2em;"   >C 分区关键值表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.pk_tbl_test(phonenum varchar(30));</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.pk_tbl_test_sgap() inherits (testrole.pk_tbl_test);</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.pk_tbl_test_bj() inherits (testrole.pk_tbl_test);</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.pk_tbl_test_sh() inherits (testrole.pk_tbl_test);</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.pk_tbl_test_gz() inherits (testrole.pk_tbl_test);</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.pk_tbl_test_hz() inherits (testrole.pk_tbl_test);</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.pk_tbl_test_def() inherits (testrole.pk_tbl_test);</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.pk_tbl_test_sgap values(‘0′),(‘1′),(‘2′),(‘3′),(‘4′),(‘5′),(‘6′),(‘7′),(‘8′),(‘9′);</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.pk_tbl_test_bj values(‘10′),(‘11′),(‘12′),(‘13′),(‘14′),(‘15′),(‘16′),(‘17′),(‘18′),(‘19′);</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.pk_tbl_test_sh values(‘20′),(‘21′),(‘22′),(‘23′),(‘24′),(‘25′),(‘26′),(‘27′),(‘28′),(‘29′);</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.pk_tbl_test_gz values(‘30′),(‘31′),(‘32′),(‘33′),(‘34′),(‘35′),(‘36′),(‘37′),(‘38′),(‘39′);</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.pk_tbl_test_hz values(‘40′),(‘41′),(‘42′),(‘43′),(‘44′),(‘45′),(‘46′),(‘47′),(‘48′),(‘49′);</p>
<p style="TEXT-INDENT: 2em;"   >C cluster_all范围内使用的查询函数 , 每个表需要一个查询函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >cluster ‘all’;</p>
<p style="TEXT-INDENT: 2em;"   >run on all;</p>
<p style="TEXT-INDENT: 2em;"   >select * from testrole.ca_tbl_test_sel(v_sql);</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plproxy;</p>
<p style="TEXT-INDENT: 2em;"   >C 每个代理库仅需要建一个,用于cluster_all范围内Insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >cluster ‘all’;</p>
<p style="TEXT-INDENT: 2em;"   >run on all;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plproxy;</p>
<p style="TEXT-INDENT: 2em;"   >C cluster_plproxy_all范围内使用的函数 , 级联</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cpa_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >cluster ‘plproxy_all’;</p>
<p style="TEXT-INDENT: 2em;"   >run on testrole.get_pk_tbl_test(i_phonenum);</p>
<p style="TEXT-INDENT: 2em;"   >select * from testrole.cla_tbl_test_ins(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plproxy;</p>
<p style="TEXT-INDENT: 2em;"   >C(各代理库配置不一样)对上面函数的接口,每个代理库配置对应自己的代理名</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >cluster ’sgap_testrole_all’; &nbsp; ― 对应自己所在的代理</p>
<p style="TEXT-INDENT: 2em;"   >run on abs(trunc(mod(hashtext(i_phonenum),2))::int4);</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plproxy;</p>
<p style="TEXT-INDENT: 2em;"   >C cluster_plproxy_all 范围内对数据进行分类的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.get_pk_tbl_test(i_phonenum varchar) returns int4 as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >perform 1 from testrole.pk_tbl_test_sgap where phonenum=i_phonenum;</p>
<p style="TEXT-INDENT: 2em;"   >if found then</p>
<p style="TEXT-INDENT: 2em;"   >return 0 ;</p>
<p style="TEXT-INDENT: 2em;"   >end if;</p>
<p style="TEXT-INDENT: 2em;"   >perform 1 from testrole.pk_tbl_test_bj where phonenum=i_phonenum;</p>
<p style="TEXT-INDENT: 2em;"   >if found then</p>
<p style="TEXT-INDENT: 2em;"   >return 1 ;</p>
<p style="TEXT-INDENT: 2em;"   >end if;</p>
<p style="TEXT-INDENT: 2em;"   >perform 1 from testrole.pk_tbl_test_sh where phonenum=i_phonenum;</p>
<p style="TEXT-INDENT: 2em;"   >if found then</p>
<p style="TEXT-INDENT: 2em;"   >return 2 ;</p>
<p style="TEXT-INDENT: 2em;"   >end if;</p>
<p style="TEXT-INDENT: 2em;"   >perform 1 from testrole.pk_tbl_test_gz where phonenum=i_phonenum;</p>
<p style="TEXT-INDENT: 2em;"   >if found then</p>
<p style="TEXT-INDENT: 2em;"   >return 3 ;</p>
<p style="TEXT-INDENT: 2em;"   >end if;</p>
<p style="TEXT-INDENT: 2em;"   >Cperform 1 from testrole.pk_tbl_test_hz where phonenum=i_phonenum;</p>
<p style="TEXT-INDENT: 2em;"   >Cif found then</p>
<p style="TEXT-INDENT: 2em;"   >Creturn 4 ;</p>
<p style="TEXT-INDENT: 2em;"   >Cend if;</p>
<p style="TEXT-INDENT: 2em;"   >perform 1 from testrole.pk_tbl_test_def where phonenum=i_phonenum;</p>
<p style="TEXT-INDENT: 2em;"   >if found then</p>
<p style="TEXT-INDENT: 2em;"   >return 0 ; ― 设计为默认往sgap插入.当然可以设计为每个代理库的该函数返回为该代理库的ID;即往本地插;</p>
<p style="TEXT-INDENT: 2em;"   >end if ;</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.pk_tbl_test_def values(i_phonenum);</p>
<p style="TEXT-INDENT: 2em;"   >return 0 ; &nbsp;C 设计为默认往sgap插入.当然可以设计为每个代理库的该函数返回为该代理库的ID;即往本地插;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >7. 哈希分区 :</p>
<p style="TEXT-INDENT: 2em;"   >abs(trunc(mod(hashtext(createtime::text),2))::int4)</p>
<p style="TEXT-INDENT: 2em;"   >8. 测试 .</p>
<p style="TEXT-INDENT: 2em;"   >/* 分区库详细操作 */</p>
<p style="TEXT-INDENT: 2em;"   >/* 地区1sgap_testrole_0 */</p>
<p style="TEXT-INDENT: 2em;"   >C创建role</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_sgap_testrole_0 owner testrole location ‘/database/pgdata/tbs_sgap_testrole_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建分区数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database sgap_testrole_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_sgap_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >C连接至已常见好的分区数据库及role</p>
<p style="TEXT-INDENT: 2em;"   >\c sgap_testrole_0 testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建本地schema</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建过程语言</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C在cluster_all范围内使用,每个表一个</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C在cluster_local_all范围内使用 , 当使用plproxy级联时</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >/* 地区1sgap_testrole_1 */</p>
<p style="TEXT-INDENT: 2em;"   >C创建role</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_sgap_testrole_1 owner testrole location ‘/database/pgdata/tbs_sgap_testrole_1_def’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建分区数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database sgap_testrole_1 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_sgap_testrole_1;</p>
<p style="TEXT-INDENT: 2em;"   >C连接至已常见好的分区数据库及role</p>
<p style="TEXT-INDENT: 2em;"   >\c sgap_testrole_1 testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建本地schema</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建过程语言</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建global_all,每个表一个</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建local_all</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >/* 地区2bj_testrole_0 */</p>
<p style="TEXT-INDENT: 2em;"   >C创建role</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_bj_testrole_0 owner testrole location ‘/database/pgdata/tbs_bj_testrole_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建分区数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database bj_testrole_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_bj_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >C连接至已常见好的分区数据库及role</p>
<p style="TEXT-INDENT: 2em;"   >\c bj_testrole_0 testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建本地schema</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建过程语言</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建global_all,每个表一个</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建local_all</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >/* 地区2bj_testrole_1 */</p>
<p style="TEXT-INDENT: 2em;"   >C创建role</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_bj_testrole_1 owner testrole location ‘/database/pgdata/tbs_bj_testrole_1_def’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建分区数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database bj_testrole_1 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_bj_testrole_1;</p>
<p style="TEXT-INDENT: 2em;"   >C连接至已常见好的分区数据库及role</p>
<p style="TEXT-INDENT: 2em;"   >\c bj_testrole_1 testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建本地schema</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建过程语言</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建global_all,每个表一个</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建local_all</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >/* 地区3sh_testrole_0 */</p>
<p style="TEXT-INDENT: 2em;"   >C创建role</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_sh_testrole_0 owner testrole location ‘/database/pgdata/tbs_sh_testrole_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建分区数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database sh_testrole_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_sh_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >C连接至已常见好的分区数据库及role</p>
<p style="TEXT-INDENT: 2em;"   >\c sh_testrole_0 testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建本地schema</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建过程语言</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建global_all,每个表一个</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建local_all</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >/* 地区3sh_testrole_1 */</p>
<p style="TEXT-INDENT: 2em;"   >C创建role</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_sh_testrole_1 owner testrole location ‘/database/pgdata/tbs_sh_testrole_1_def’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建分区数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database sh_testrole_1 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_sh_testrole_1;</p>
<p style="TEXT-INDENT: 2em;"   >C连接至已常见好的分区数据库及role</p>
<p style="TEXT-INDENT: 2em;"   >\c sh_testrole_1 testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建本地schema</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建过程语言</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建global_all,每个表一个</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建local_all</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >/* 地区4gz_testrole_0 */</p>
<p style="TEXT-INDENT: 2em;"   >C创建role</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_gz_testrole_0 owner testrole location ‘/database/pgdata/tbs_gz_testrole_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建分区数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database gz_testrole_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_gz_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >C连接至已常见好的分区数据库及role</p>
<p style="TEXT-INDENT: 2em;"   >\c gz_testrole_0 testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建本地schema</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建过程语言</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建global_all,每个表一个</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建local_all</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >/* 地区4gz_testrole_1 */</p>
<p style="TEXT-INDENT: 2em;"   >C创建role</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_gz_testrole_1 owner testrole location ‘/database/pgdata/tbs_gz_testrole_1_def’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建分区数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database gz_testrole_1 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_gz_testrole_1;</p>
<p style="TEXT-INDENT: 2em;"   >C连接至已常见好的分区数据库及role</p>
<p style="TEXT-INDENT: 2em;"   >\c gz_testrole_1 testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建本地schema</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建过程语言</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建global_all,每个表一个</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建local_all</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >/* 地区5hz_testrole_0 */</p>
<p style="TEXT-INDENT: 2em;"   >C创建role</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_hz_testrole_0 owner testrole location ‘/database/pgdata/tbs_hz_testrole_0_def’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建分区数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database hz_testrole_0 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_hz_testrole_0;</p>
<p style="TEXT-INDENT: 2em;"   >C连接至已常见好的分区数据库及role</p>
<p style="TEXT-INDENT: 2em;"   >\c hz_testrole_0 testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建本地schema</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建过程语言</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建global_all,每个表一个</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建local_all</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.cla_tbl_test_ins(i_phonenum varchar,i_price real,i_createtime timestamp with time zone) returns setof void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >insert into testrole.tbl_test values(i_phonenum,i_price,i_createtime);</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >/* 地区5hz_testrole_1 */</p>
<p style="TEXT-INDENT: 2em;"   >C创建role</p>
<p style="TEXT-INDENT: 2em;"   >create role testrole nosuperuser nocreatedb nocreaterole noinherit login encrypted password ‘testrole’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建表空间</p>
<p style="TEXT-INDENT: 2em;"   >create tablespace tbs_hz_testrole_1 owner testrole location ‘/database/pgdata/tbs_hz_testrole_1_def’;</p>
<p style="TEXT-INDENT: 2em;"   >C创建分区数据库</p>
<p style="TEXT-INDENT: 2em;"   >create database hz_testrole_1 with owner testrole template=template0 encoding=’UTF8′ tablespace=tbs_hz_testrole_1;</p>
<p style="TEXT-INDENT: 2em;"   >C连接至已常见好的分区数据库及role</p>
<p style="TEXT-INDENT: 2em;"   >\c hz_testrole_1 testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建本地schema</p>
<p style="TEXT-INDENT: 2em;"   >create schema testrole authorization testrole;</p>
<p style="TEXT-INDENT: 2em;"   >C创建过程语言</p>
<p style="TEXT-INDENT: 2em;"   >create language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试收费表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test(phonenum varchar(30),price real,createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建测试下载记录表</p>
<p style="TEXT-INDENT: 2em;"   >create table testrole.tbl_test_table2(imsi varchar(50),appid varchar(10),createtime timestamp with time zone default now());</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局查询tbl_test的函数,(每个表都得建)</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_tbl_test_sel(v_sql text) returns setof testrole.tbl_test as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >declare</p>
<p style="TEXT-INDENT: 2em;"   >v_rec testrole.tbl_test%rowtype;</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >for v_rec in execute v_sql loop</p>
<p style="TEXT-INDENT: 2em;"   >return next v_rec;</p>
<p style="TEXT-INDENT: 2em;"   >end loop;</p>
<p style="TEXT-INDENT: 2em;"   >return;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   >C创建全局insert,update,delete的函数</p>
<p style="TEXT-INDENT: 2em;"   >create or replace function testrole.ca_iud(v_sql text) returns void as $BODY$</p>
<p style="TEXT-INDENT: 2em;"   >begin</p>
<p style="TEXT-INDENT: 2em;"   >execute v_sql;</p>
<p style="TEXT-INDENT: 2em;"   >end;</p>
<p style="TEXT-INDENT: 2em;"   >$BODY$ language plpgsql;</p>
<p style="TEXT-INDENT: 2em;"   ></p></div>
	</div>
</div>
</body>
</html>