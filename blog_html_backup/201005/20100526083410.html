<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL and MySQL lock compare ext.</h2>
	<h5 id="">2010-05-26 8:34:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201042683410679/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><span style="font-family: Tahoma, Arial, Helvetica, sans-serif; line-height: normal; color: rgb(51, 68, 85);"  ><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >事情的起因是这样的，今天同事碰到MYSQL奇怪的慢查询问题，大概如下：</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >select * from table where id=?</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >id是主键，按常理，这条SQL应该很快才对，但是每天都有不定期的出现慢的情况。</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >这个表只有三种操作，insert delete ,select。</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >经过下面的实验发现了一个很严重的问题，MYSQL的锁似乎有点暴力，在对表进行DML操作的时候，SELECT需要等待。</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >测试如下（分别对MyISAM和innodb引擎的表进行了测试)：</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >create table tbl_test1 (id int primary key) engine=myisam;</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >insert into tbl_test1 (3千万记录）</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >create table tbl_test2 (id int primary key) engine=innodb;</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >insert into tbl_test2 (3千万记录）</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >看看执行计划：</p><p style="margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  ></p><pre class="prettyprint"  ><p></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >select * from tbl_test1 wher id=?</font></p><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >+―-+――――-+―――C+――-+―――――+―――――+―――+――-+――+――――-+</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >| id | select_type | table &nbsp; &nbsp; | type &nbsp;| possible_keys | key &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | key_len | ref &nbsp; | rows | Extra &nbsp; &nbsp; &nbsp; |</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >+―-+――――-+―――C+――-+―――――+―――――+―――+――-+――+――――-+</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >| &nbsp;1 | SIMPLE &nbsp; &nbsp; &nbsp;| tbl_test1 | const | tbl_test2_idx | tbl_test2_idx | 4 &nbsp; &nbsp; &nbsp; | const | &nbsp; &nbsp;1 | Using index |</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >+―-+――――-+―――C+――-+―――――+―――――+―――+――-+――+――――-+</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >1 row in set (0.00 sec)</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >+―-+――――-+―――C+――-+―――――+―――――+―――+――-+――+――――-+</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >| id | select_type | table &nbsp; &nbsp; | type &nbsp;| possible_keys | key &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | key_len | ref &nbsp; | rows | Extra &nbsp; &nbsp; &nbsp; |</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >+―-+――――-+―――C+――-+―――――+―――――+―――+――-+――+――――-+</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >| &nbsp;1 | SIMPLE &nbsp; &nbsp; &nbsp;| tbl_test2 | const | tbl_test2_idx | tbl_test2_idx | 4 &nbsp; &nbsp; &nbsp; | const | &nbsp; &nbsp;1 | Using index |</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >+―-+――――-+―――C+――-+―――――+―――――+―――+――-+――+――――-+</font></div><div id="_mcePaste"  style="margin: 0px; padding: 0px;"  ><font size="2"  >1 row in set (0.00 sec)</font></div><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >+―-+――――-+―――C+――-+―――――+―――――+―――+――-+――+――――-+| id | select_type | table &nbsp; &nbsp; | type &nbsp;| possible_keys | key &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | key_len | ref &nbsp; | rows | Extra &nbsp; &nbsp; &nbsp; |+―-+――――-+―――C+――-+―――――+―――――+―――+――-+――+――――-+| &nbsp;1 | SIMPLE &nbsp; &nbsp; &nbsp;| tbl_test2 | const | tbl_test2_idx | tbl_test2_idx | 4 &nbsp; &nbsp; &nbsp; | const | &nbsp; &nbsp;1 | Using index |+―-+――――-+―――C+――-+―――――+―――――+―――+――-+――+――――-+1 row in set (0.00 sec)</font></p><p></p></pre><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >好了，接下来开始执行一条删除的SQL</p><p style="margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  ></p><pre class="prettyprint"  ><p></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >session1:</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >delete from tbl_test1 where id &lt;?</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >session 2:</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >select * from tbl_test1 where id=?</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >session 3:</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >show processlist;</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >mysql&gt; show processlist;</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >+―-+――+―――C+――+―――+――+―――-+―――――――――――――C+</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >| Id | User | Host &nbsp; &nbsp; &nbsp;| db &nbsp; | Command | Time | State &nbsp; &nbsp;| Info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >+―-+――+―――C+――+―――+――+―――-+―――――――――――――C+</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >| &nbsp;3 | root | localhost | test | Query &nbsp; | &nbsp; 23 | Locked &nbsp; | select * from tbl_test2 where id=122767 |</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >| &nbsp;4 | root | localhost | test | Query &nbsp; | &nbsp; 24 | updating | delete from tbl_test2 where id&lt;6276758 &nbsp;|</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >| &nbsp;5 | root | localhost | test | Query &nbsp; | &nbsp; &nbsp;0 | NULL &nbsp; &nbsp; | show processlist &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >+―-+――+―――C+――+―――+――+―――-+―――――――――――――C+</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >3 rows in set (0.00 sec)</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >mysql&gt; show processlist;</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >+―-+――+―――C+――+―――+――+―――-+―――――――――――――C+</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >| Id | User | Host &nbsp; &nbsp; &nbsp;| db &nbsp; | Command | Time | State &nbsp; &nbsp;| Info &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >+―-+――+―――C+――+―――+――+―――-+―――――――――――――C+</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >| &nbsp;3 | root | localhost | test | Query &nbsp; | &nbsp; 23 | Locked &nbsp; | select * from tbl_test1 where id=10122767 |</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >| &nbsp;4 | root | localhost | test | Query &nbsp; | &nbsp; 24 | updating | delete from tbl_test1 where id&lt;6276758 &nbsp;|</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >| &nbsp;5 | root | localhost | test | Query &nbsp; | &nbsp; &nbsp;0 | NULL &nbsp; &nbsp; | show processlist &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >+―-+――+―――C+――+―――+――+―――-+―――――――――――――C+</font></p><p style="margin-bottom: 18px; line-height: 18px;"  ><font size="2"  >3 rows in set (0.00 sec)</font></p><p></p></pre><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >在SESSION1删除TBL_TEST2的某些记录时，SESSION2查询处于等待状态。</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >所以，DELETE如果慢的话，SELECT也跟着变慢了。这太不能接受了，而且myisam和innode都一样。</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >最不能理解的是删除的记录里面并没有包含我要查询的记录，为啥要等待呢？</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >接下来看看PostgreSQL:</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >同样的表，SESSION1在删除时，SESSION2的查询不会受到影响，SESSION2在SESSION1没有真正删除到被删除的行是，SESSION2是可以查询到该记录的。很明显在Postgresql做批量删除时，是行锁或块锁。所以并发度很好。</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >而MYSQL在删除时看样子不应该是行锁或块锁，所以并发性能不好。</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >在设计MYSQL的应用的时候，切记这种类型的SQL操作，防止并发下降.</p><p style="font-size: 13px; margin: 0px 0px 18px; padding: 0px; line-height: 18px;"  >（我对MYSQL还不太熟悉，哈哈，写的不对的话请多批评）</p></span></div>
	</div>
</div>
</body>
</html>