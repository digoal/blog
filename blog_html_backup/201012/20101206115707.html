<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">MongoDB Internals</h2>
	<h5 id="">2010-12-06 11:57:07&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201011684834293/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><br>最近在看一本书：《MongoDB: The Definitive Guide》,对此书有兴趣的朋友可以留下您的邮箱.<br>&nbsp; 下面是MongoDB Internals部分章节的翻译,想看原文,请留下邮箱,哈哈<br>&nbsp; 在很多场合下,数据库被当成黑盒来使用,MongoDB也不例外.但是作为DBA,或者是想要更加深入的了解它的人来说,了解MongoDB的一些内部知识是有帮助的.<br>1. BSON (Binary JSON)<br>Documents在MongoDB中属于抽象概念(无形概念),Document有形的表述取决于使用的驱动或语言.目前MongoDB服务端使用BSON存储Documents.<br>BSON是一个轻量级的二进制存储格式,可以存储任意MongoDB document as a string of bytes.Document以BSON的格式存储于磁盘.<br>When a driver is given a document to insert, use as a query, and so on, it will encode<br>that document to BSON before sending&nbsp; it to the server. Likewise, documents being<br>returned to the client from the server are sent as BSON strings. This BSON data is<br>decoded by the driver to its native document representation before being returned to<br>the client.<br>驱动的作用类似Server和Client通信的翻译.<br>BSON的三个特点:<br>效率：<br>不需要占用过多额外空间,与JSON比较,BSON效率非常高（如,存储binary data或large numerics数据类型时),最恶劣的情况下BSON比JSON效率略低.<br>性能 :<br>BSON使用C-style表述类型,在大多数编程语言中使用encode,decode操作都比较迅速.<br>Traversability : <br>In some cases, BSON does sacrifice space efficiency to make the format easier to<br>traverse. For example, string values are prefixed with a length rather than relying<br>on a terminator to signify the end of a string. This traversability is useful when the<br>MongoDB server needs to introspect documents.<br><br>2. Wire Protocol<br>当Driver连接到MongoDB Server时使用轻量级的TCP/IP wire protocol.<br>The Mongo Wire Protocol is a simple socket-based, request-response style  protocol. Clients communicate with the database server through a  regular TCP/IP socket.<br>详细文档参考:<br>http://www.mongodb.org/display/DOCS/Mongo+Wire+Protocol#MongoWireProtocol-TableOfContents<br><br>3. Data Files<br>在MongoDB中，每个库都有自己的数据文件,如下:<br>[mongo@db6 ~]$ cd mongodb/data1/<br>[mongo@db6 data1]$ ll<br>total 24<br>drwxr-xr-x 2 root&nbsp; root&nbsp; 4096 Dec&nbsp; 2 16:42 admin<br>drwxr-xr-x 2 root&nbsp; root&nbsp; 4096 Dec&nbsp; 3 16:47 digoal<br>-rwxrwxr-x 1 mongo mongo&nbsp;&nbsp;&nbsp; 5 Dec&nbsp; 3 16:11 mongod.lock<br>drwxr-xr-x 2 root&nbsp; root&nbsp; 4096 Dec&nbsp; 3 16:29 test<br>drwxr-xr-x 2 root&nbsp; root&nbsp; 4096 Dec&nbsp; 4 13:55 _tmp<br>drwxr-xr-x 2 root&nbsp; root&nbsp; 4096 Dec&nbsp; 2 16:47 wapprepaid<br>[mongo@db6 data1]$ cd test<br>[mongo@db6 test]$ ll -h <br>total 38G<br>-rw------- 1 root root&nbsp; 64M Dec&nbsp; 3 09:18 test.0<br>-rw------- 1 root root 128M Dec&nbsp; 3 09:18 test.1<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 10:03 test.10<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 10:12 test.11<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 10:14 test.12<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 10:23 test.13<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 10:25 test.14<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 10:37 test.15<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 10:41 test.16<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 12:29 test.17<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 12:46 test.18<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 12:57 test.19<br>-rw------- 1 root root 256M Dec&nbsp; 3 09:19 test.2<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 16:17 test.20<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 16:23 test.21<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 16:29 test.22<br>-rw------- 1 root root 512M Dec&nbsp; 3 09:20 test.3<br>-rw------- 1 root root 1.0G Dec&nbsp; 3 09:22 test.4<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 09:24 test.5<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 09:28 test.6<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 09:35 test.7<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 09:44 test.8<br>-rw------- 1 root root 2.0G Dec&nbsp; 3 09:55 test.9<br>-rw------- 1 root root&nbsp; 16M Dec&nbsp; 3 09:18 test.ns<br>该数据库的启动参数如下:<br>-r-------- 1 mongo mongo 168 Dec&nbsp; 3 09:02 mongodb.cfg<br>[mongo@db6 conf]$ cat mongodb.cfg <br>port=5281<br>fork=true<br>logpath=/var/log/mongo/mongodb.log<br>logappend=true<br>dbpath=/home/mongo/mongodb/data1<br>directoryperdb=true<br>auth=true<br>maxConns=1000<br>nohttpinterface=true<br><br># 查看库,<br>[mongo@db6 conf]$ /opt/mongodb-linux-x86_64-1.6.4/bin/mongo 127.0.0.1:5281/admin<br>MongoDB shell version: 1.6.4<br>connecting to: 127.0.0.1:5281/admin<br>&gt; db.auth("digoal","DIGOAL")<br>1<br>&gt; show dbs<br>admin<br>digoal<br>local<br>test<br>wapprepaid<br>可以看出每个库有自己的目录.<br>由于默认情况下是开启prealloc,所以文件是预先指派的,指派大小从最初的test.0 64MB开始成倍递增.<br>test.1 128MB<br>test.2 256MB<br>test.3 512MB<br>test.4 1024MB<br>test.5 2G<br>到2G后面数据文件单个大小就不再变化.这么搞的好处是小库不会浪费太多空间,大库的话又可以做到数据文件尽量保持在磁盘上的连续存储。<br>预指派的好处:保持数据文件在磁盘存储连续，避免当需要是才做文件指派时的性能下降。<br><br>4. Namespaces and extents<br>Namespace在MongoDB中代表一个完整的对象描述,如<br>&gt; use test<br>switched to db test<br>&gt; db.auth("digoal","DIGOAL")<br>1<br>&gt; show collections<br>blog.posts<br>system.indexes<br>system.users<br>tbl<br>tbl1<br>tbl2<br>tbl3<br>tbl4<br>tbl_test<br><br>test.blog.posts<br>test.blog<br>test.system<br>test.system.indexes 等等 这些都属于namespaces.<br>extents是在数据文件中的概念,namespaces以extents的形式存储在数据文件中.如图<br><div><img title="MongoDB Internals - 德哥@Digoal - The Heart,The World."  alt="MongoDB Internals - 德哥@Digoal - The Heart,The World."  style="margin: 0pt 10px 0pt 0pt;"  src="http://img615.ph.126.net/-ECzkS8Qw_aFwiEjE3boEQ==/1676183486314081123.jpg"  ></div>&nbsp;<br>从这个图上来看，foo.0,foo.1文件被指派了extents，foo.2是预指派产生的数据文件，目前还没有使用.<br>foo.$freelist是一个特殊的namespace,用作跟踪空余的EXTENTS，（如drop collection或index后，extent被释放）,当某个NAMESPACE需要新的extents时,首先查找FREELIST是否有合适大小的extents。<br><br>5. Memory-Mapped Storage Engine<br>目前MongoDB默认的存储引擎,Memory-Mapped Storage Engine.当数据库启动的时候,Memory map所有数据文件.之后的话 flushing data to disk and paging out and in 就交给操作系统来管理了.<br>Memory-Mapped 存储引擎有以下重要属性:<br>5.1 由于大多数内存管理的工作推到了OS端，MongoDB关于内存管理这一方面的代码比较精简.<br>5.2 MongoDB数据库的虚拟大小可能会超过数据库物理SIZE，That's OK,不用担心，这些操作已经交给OS处理了。<br>5.3 MongoDB不能控制数据写入磁盘的顺序，所以就不可能通过记录WriteAhead Log 来确保单台服务器情况下数据库的持久化。从MongoDB http://www.mongodb.org/display/DOCS/Durability+and+Repair 上面了解到，<br><p>The v1.8 release of MongoDB will have single server durability.  You can follow the Jira here : <a rel="nofollow" href="http://jira.mongodb.org/browse/SERVER-980"  >http://jira.mongodb.org/browse/SERVER-980</a>.  Specifically, in v1.8, journaling will be added to the storage engine.</p>  <p>We recommend using replication to keep copies of data for now C and  likely forever C as a single server could fail catastrophically  regardless.</p><p>V1.8版本在存储引擎中增加了JOURNAL的记录，可以提供单服务器数据库持久化。</p><p>不过MongoDB推荐使用多台服务器的数据多份拷贝来做数据库持久化.</p><p>5.4 在32位的操作系统中，由于寻址的关系,每个mongod，MongoDB 只能存储2GB的数据。所以建议使用64位操作系统.<br></p></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">savage1963 - 2011-01-20 10:54:37</h5>
				<div>HOHO savage1985@126.com</div>
			</div>
	</div>
</div>
</body>
</html>