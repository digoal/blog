<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Oracle Checkpoint</h2>
	<h5 id="">2012-06-13 23:29:31&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402012513112931774/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>转一篇Oracle checkpoint相关文章, PostgreSQL的checkpoint希望以后能改进其性能, Oracle的增量checkpoint不错.</div><div><br></div><div>【原文】</div><div><a rel="nofollow" href="http://blog.csdn.net/tianlesoftware/article/details/6700085"  >http://blog.csdn.net/tianlesoftware/article/details/6700085</a> </div><div>一. Oracle Checkpoint 说明</div><div>&nbsp;1.1 &nbsp;Checkpoint</div><div>（1）A synchronization event at aspecific point in time</div><div>（2）Causes some or all dirty blockimages to be written to the database thereby guaranteeing that blocks dirtiedprior to that point in time get written</div><div>（3）Brings administration up to date</div><div>（4）Several types of checkpoint exist</div><div>&nbsp;</div><div>RedoLog Checkpoint 和 SCN关系</div><div>http://blog.csdn.net/tianlesoftware/article/details/5251916</div><div>&nbsp;</div><div>Oracle 实例恢复时 前滚（roll forward） 后滚（rollback） 问题</div><div>http://blog.csdn.net/tianlesoftware/article/details/6286330</div><div>&nbsp;</div><div>1.2 &nbsp;the point of Oracle Checkpoints</div><div>&nbsp; &nbsp; &nbsp; &nbsp;The point of Oracle checkpoints is to synchronize all datafiles, some datafiles orsome objects to a point in time for consistency, performance and recoverabilitypurposes.</div><div>&nbsp;&nbsp;</div><div>1.3 Buffer Cache</div><div>&nbsp; &nbsp; &nbsp; &nbsp;checkpoint与Buffer Cache 的关系很大，有关Buffer cache，之前整理的相关文章如下：</div><div>Oracle Buffer Cache 原理</div><div>http://blog.csdn.net/tianlesoftware/article/details/6573438</div><div>&nbsp;</div><div>Oracle Buffer Cache 中的Recycle Pool 说明</div><div>http://blog.csdn.net/tianlesoftware/article/details/6584110</div><div>&nbsp;</div><div>Oracle Buffer Cache 中 KeepPool 说明</div><div>http://blog.csdn.net/tianlesoftware/article/details/6581159</div><div>&nbsp;</div><div>1.3.1 buffer cache 组成</div><div>The buffer cache component structures are:</div><div>（1）Buffers</div><div>&nbsp; &nbsp; &nbsp; &nbsp;Eachbuffer may hold an image of one data block at any one time</div><div>（2）Buffer headers</div><div>&nbsp; &nbsp; &nbsp; &nbsp;=&gt;Storemetadata about contents of the buffers</div><div>&nbsp; &nbsp; &nbsp; &nbsp;=&gt;Actas cache management structures</div><div>（3）Buffer pools</div><div>&nbsp; &nbsp; &nbsp; &nbsp;Collectionof buffers used for the same purpose and managed accordingly</div><div>（4）Working set</div><div>&nbsp; &nbsp; &nbsp; &nbsp;=&gt;Allor part of a buffer pool</div><div>&nbsp; &nbsp; &nbsp; &nbsp;=&gt;Assigned to a DBWn process</div><div>&nbsp;</div><div>1.3.2 Buffer Management</div><div>（1） Cached buffers managed by doublylinked lists:</div><div>（2） REPL</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; =&gt;Bufferscontaining block images being used</div><div>（3） REPL-AUX</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=&gt;Buffersready to be used for I/O or CR build</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 关于CR 参考：</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; CR (consistent read) blockscreate 说明</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; http://blog.csdn.net/tianlesoftware/article/details/6529401</div><div>（4） WRITE and CKPT-Q</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=&gt;DirtyBuffers requiring I/O</div><div>（5） WRITE-AUX</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;=&gt;DirtyBuffers with I/O in progress</div><div>（6） Touch count is used to decide theinitial insertion location in the REPL chain</div><div>（7） AUX lists avoid wasteful scanning</div><div>&nbsp;</div><div>1.3.3 Redo and the Buffer Cache</div><div>（1） Block modification dirties thebuffer containing the block image and generates redo</div><div>（2） A buffer becomes dirty at aparticular RBA which is a point in the redo stream</div><div>&nbsp; &nbsp; &nbsp; &nbsp;关于RBA,参考我的blog :&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp;Oracle RBA(Redo Byte Address) 说明</div><div>&nbsp; &nbsp; &nbsp; &nbsp;http://blog.csdn.net/tianlesoftware/article/details/6700080</div><div>（3） Redo written by LGWR makes thecorresponding part of the redo log file “active”</div><div>（4） Dirty block images written by DBWnmakes the corresponding part of the redo log file “inactive”</div><div>（5） Redo is always written priorto the corresponding block images</div><div>（6） Size of active redo in the logfile influences instance and crash recovery time</div><div>（7） Trade-off between performance andrecovery time</div><div>&nbsp;</div><div>1.3.4 Buffer Cache I/O</div><div>（1）Servers look for an availablebuffer on REPL-AUX then read a data block into selected buffer</div><div>&nbsp; &nbsp; &nbsp; &nbsp;CBuffer gets moved from REPL-AUX to REPL</div><div>&nbsp; &nbsp; &nbsp; &nbsp;CIf block is modified, buffer is added to CKPT-Q</div><div>&nbsp; &nbsp; &nbsp; &nbsp;CServers move dirty buffers to WRITE during free buffer search</div><div>（2） DBWn writes dirty buffer contentsto database</div><div>&nbsp; &nbsp; &nbsp; &nbsp;CBuffer gets moved from WRITE to WRITE-AUX</div><div>&nbsp; &nbsp; &nbsp; &nbsp;COnce block written:</div><div>&nbsp; &nbsp; &nbsp; &nbsp;CBuffer is moved back to REPL-AUX</div><div>&nbsp; &nbsp; &nbsp; &nbsp;CBuffer taken off CKPT-Q</div><div>（3） DBWn writes upon request</div><div>&nbsp; &nbsp; &nbsp; &nbsp;CMake free buffers</div><div>&nbsp; &nbsp; &nbsp; &nbsp;CCheckpoint</div><div>&nbsp;</div><div>1.4 触发checkpoint 的条件</div><div>&nbsp; &nbsp; &nbsp; &nbsp;与checkpoint 触发相关的视图：v$instance_recovery。 关于这个视图的具体说明可以参考官方文档：</div><div>&nbsp; &nbsp; &nbsp; &nbsp;http://download.oracle.com/docs/cd/E11882_01/server.112/e17110/dynviews_2004.htm#REFRN30106</div><div>&nbsp;</div><div>几个相关的字段如下：</div><div>（1）WRITES_MTTR：fast_start_mttr_target</div><div>（2）WRITES_LOGFILE_SIZE：90% of the smallest online redo logfile</div><div>（3）WRITES_LOG_CHECKPOINT_SETTINGS：log_checkpoint_timeout</div><div>（4）WRITES_OTHER_SETTINGS：fast_start_io_target</div><div>（5）WRITES_AUTOTUNE：10g self tuning checkpoints</div><div>（6） WRITES_FULL_THREAD_CKPT：Manual checkpoints</div><div>&nbsp;</div><div>CKPT发送CHECKPOINT信号的触发条件有如下几条：</div><div>&nbsp; &nbsp; &nbsp; &nbsp;1.log_checkpoint_timeout时间达到</div><div>&nbsp; &nbsp; &nbsp; &nbsp;2. 当前redo日志已经写够log_checkpoint_internavl*操作系统块大小</div><div>&nbsp; &nbsp; &nbsp; &nbsp;3. redo log switch</div><div>&nbsp; &nbsp; &nbsp; &nbsp;4. alter system checkpoint</div><div>&nbsp; &nbsp; &nbsp; &nbsp;5. alter tablespace XXX begin backup，end backup的r候</div><div>&nbsp; &nbsp; &nbsp; &nbsp;6. alter tablespace , datafileoffline, shutdown immediate, direct read的r候;</div><div>&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp;Oracle DBWR,LGWR,CKPT,ARCH 触发条件 总结</div><div>&nbsp; &nbsp; &nbsp; &nbsp;http://blog.csdn.net/tianlesoftware/article/details/6574584</div><div>&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp;在下面具体的checkpoint 分类时有更详细的说明。</div><div>&nbsp;</div><div>二. Checkpoint 分类</div><div>Checkpoint 可以分为以下几类：</div><div>（1） Full Checkpoint</div><div>（2） Thread Checkpoint</div><div>（3） File Checkpoint</div><div>（4） Object “Checkpoint”</div><div>（5） Parallel Query Checkpoint</div><div>（6） Incremental Checkpoint</div><div>（7） Log Switch Checkpoint</div><div>&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp;如果想看到具体的checkpoint 类型，可以设置log_checkpoints_to_alert 参数为true。 设置为true之后，checkpoint 发生时会写入alert log里。</div><div>如：</div><div>SYS@dave2(db2)&gt;alter system set log_checkpoints_to_alert=true scope=both;</div><div>System altered.</div><div>SYS@dave2(db2)&gt; alter system switchlogfile;</div><div>System altered.</div><div>&nbsp;</div><div>log里的信息如下：</div><div>Thu Aug 18 18:46:18 2011</div><div>ALTER SYSTEM SETlog_checkpoints_to_alert=TRUE SCOPE=BOTH;</div><div>Thu Aug 18 18:48:07 2011</div><div>Beginning logswitch checkpoint up to RBA [0xa.2.10], SCN: 2148380730</div><div>Thread 1 advanced to log sequence 10</div><div>&nbsp;Current log# 3 seq# 10 mem# 0: /u01/app/oracle/oradata/dave2/redo03.log</div><div>&nbsp;</div><div>&nbsp;</div><div>2.1 Full Checkpoint</div><div>? Writes block images to the database forall dirty buffers from all instances</div><div>? Statistics updated:</div><div>C DBWR checkpoints</div><div>C DBWR checkpoint buffers written</div><div>C DBWR thread checkpoint buffers written</div><div>? Caused by:</div><div>C Alter system checkpoint [global]</div><div>C Alter database close</div><div>C Shutdown</div><div>? Controlfile and datafile headers areupdated</div><div>C CHECKPOINT_CHANGE#</div><div>&nbsp;</div><div>2.2 Thread Checkpoint</div><div>? Writes block images to the database forall dirty buffers from one instance</div><div>? Statistics updated:</div><div>C DBWR checkpoints</div><div>C DBWR checkpoint buffers written</div><div>C DBWR thread checkpoint buffers written</div><div>? Caused by:</div><div>C Alter system checkpoint local</div><div>? Controlfile and datafile headers areupdated</div><div>C CHECKPOINT_CHANGE#</div><div>&nbsp;</div><div>2.3 File Checkpoint</div><div>? Writes block images to the database forall dirty buffers for all files of a tablespace from all instances</div><div>? Statistics updated:</div><div>C DBWR tablespace checkpoint bufferswritten</div><div>C DBWR checkpoint buffers written</div><div>C DBWR checkpoints</div><div>? Caused by:</div><div>C Alter tablespace XXX offline</div><div>C Alter tablespace XXX begin backup</div><div>C Alter tablespace XXX read only</div><div>? Controlfile and datafile headers areupdated</div><div>C CHECKPOINT_CHANGE#</div><div>&nbsp;</div><div>2.4 Parallel Query Checkpoint</div><div>? Writes block images to the database forall dirty buffers belonging to objects accessed by the query from all instances</div><div>? Statistics updated:</div><div>C DBWR checkpoint buffers written</div><div>C DBWR checkpoints</div><div>? Caused by:</div><div>C Parallel Query</div><div>C Parallel Query component of PDML or PDDL</div><div>C Mandatory for consistency</div><div>&nbsp;</div><div>2.5 Object “Checkpoint”</div><div>? Writes block images to the database forall dirty buffers belonging to an object from all instances</div><div>? Statistics updated:</div><div>C DBWR object drop buffers written</div><div>C DBWR checkpoints</div><div>? Caused by:</div><div>C Drop table XXX</div><div>C Drop table XXX purge</div><div>C Truncate table XXX</div><div>? Mandatory for media recovery purposes</div><div>&nbsp;</div><div>2.6 Incremental Checkpoint</div><div>? Writes the contents of “some” dirty buffers to the database from CKPT-Q</div><div>? Block images written in SCN order</div><div>? Checkpoint RBA updated in SGA</div><div>? Statistics updated:</div><div>C DBWR checkpoint buffers written</div><div>? Controlfile is updated every 3 seconds byCKPT</div><div>C Checkpoint progress record</div><div>&nbsp;</div><div>Definition of “Some”</div><div>? Every 3 seconds CKPT calculates thecheckpoint</div><div>target RBA based on:</div><div>C The most current RBA</div><div>C log_checkpoint_timeout</div><div>C log_checkpoint_interval</div><div>C fast_start_mttr_target</div><div>C fast_start_io_target</div><div>C 90% of the size of the smallest onlineredo log file</div><div>? All buffers dirtied prior to the timecorresponding to the target RBA are written to the database</div><div>&nbsp;</div><div>2.7 Log Switch Checkpoint</div><div>? Writes the contents of “some” dirtybuffers to the database</div><div>? Statistics updated:</div><div>C DBWR checkpoints</div><div>C DBWR checkpoint buffers written</div><div>C background checkpoints started</div><div>C background checkpoints completed</div><div>? Controlfile and datafile headers areupdated</div><div>C CHECKPOINT_CHANGE#</div><div>&nbsp;</div><div>2.8 Checkpoint Administration</div><div>? Useful checkpoint administration views:</div><div>C V$INSTANCE_RECOVERY</div><div>C V$SYSSTAT</div><div>C V$DATABASE</div><div>C V$INSTANCE_LOG_GROUP</div><div>C V$THREAD</div><div>C V$DATAFILE</div><div>C V$DATAFILE_HEADER</div></div>
	</div>
</div>
</body>
</html>