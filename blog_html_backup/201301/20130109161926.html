<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">PostgreSQL large row|column performance tuning case</h2>
	<h5 id="">2013-01-09 16:19:26&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020130931040444/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;">这篇BLOG主要针对如下场景进行优化 :&nbsp;<div>1. 表的行较大, 例如1KB以上.</div><div>2. 索引较多, 如4个以上.</div><div>3. 表的记录大部分都要被更新, 例如1个1000万的表每天有700W条记录要被更新.</div><div>4. 表包含大字段, 如text类型的字段, 单个字段可能占用1KB左右. 这种字段也有更新, 但是较少量.</div><div>5. 大多数字段需要被更新.</div><div><br></div><div>首先构建一下测试环境 :&nbsp;</div><div>测试表 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "digoal.test"</font></div><div><font size="2"  >&nbsp;Column | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"  >--------+-----------------------------+-----------+----------+--------------+-------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col1 &nbsp; | name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col2 &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col3 &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col4 &nbsp; | timestamp without time zone | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "test_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_col1" btree (col1)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_col2" btree (col2)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_col3" btree (col3)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_col4" btree (col4)</font></div><div><font size="2"  >Has OIDs: no</font></div><p></p></pre></div><div><br></div><div>测试数据 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; <span style="line-height: 19px;"  >insert into test select generate_series(1,10000),repeat(md5(clock_timestamp()::text), 10), repeat(md5(clock_timestamp()::text), 10), repeat(md5(clock_timestamp()::text), 3000), clock_timestamp();</span></font></div><div><font size="2"  >INSERT 0 10000</font></div><div><font size="2"  ><span style="line-height: 19px;"  >Time: 92796.813 ms</span></font></div><div><font size="2"  ><span style="line-height: 19px;"  >digoal=&gt; select id,col1,substr(col2,1,32),substr(col3,1,32),col4 from test limit 2;<br>-[ RECORD 1 ]-----------------------------------------------------------<br>id     | 1<br>col1   | 6d4d815f31340d18a6126cdc0527a0556d4d815f31340d18a6126cdc0527a05<br>substr | 52a7ab1474b77d03cfb496f6c461ab69<br>substr | 4c56be81579819e034764a562648929d<br>col4   | 2013-01-09 20:37:38.081669<br>-[ RECORD 2 ]-----------------------------------------------------------<br>id     | 2<br>col1   | 33db862bf58a9c7d080a879efbf9af8c33db862bf58a9c7d080a879efbf9af8<br>substr | 41663453b02f0dc57932feb1f2388949<br>substr | fbb5fe7f75f86fb2406f340073a0ca3c<br>col4   | 2013-01-09 20:37:38.084888<br>Time: 0.722 ms</span></font></div><p></p></pre></div><div>平均每条记录(包括头信息等)占用1638字节 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >digoal=&gt; select oid,reltoastrelid,relname from pg_class where relname='test';<br>  oid   | reltoastrelid | relname <br>--------+---------------+---------<br> 108687 |        108690 | test<br>(1 row)</span></font></div><div><font size="2"  >Time: 0.658 ms</font></div><div><font size="2"  >digoal=&gt; \c digoal postgres</font></div><div><font size="2"  >You are now connected to database "digoal" as user "postgres".</font></div><div><div><font size="2"  ><span style="line-height: 19px;"  >digoal=&gt; select pg_relation_size(108687::regclass)+pg_relation_size(108690::regclass);<br> ?column? <br>----------<br> 16384000<br>(1 row)</span></font></div><div><font size="2"  >Time: 0.750 ms</font></div></div><div><font size="2"  >digoal=# select </font><span style="font-size: small; line-height: 19px;"  >16384000</span><font size="2"  >/10000;</font></div><div><font size="2"  >&nbsp;?column?&nbsp;</font></div><div><font size="2"  >----------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp;1638</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 0.668 ms</font></div><p></p></pre></div><div><br></div><div>简单测试 :&nbsp;</div><div>1. INSERT</div><div><font size="3"  >如上10000条记录插入时间<span style="font-family: monospace; line-height: 19px; white-space: pre;"  >92796.813 ms</span></font></div><div><br></div><div>2. UPDATE</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >digoal=&gt; update test set col1=repeat(md5(clock_timestamp()::text), 10);<br>UPDATE 10000<br>Time: 78812.367 ms</span></font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >3. SELECT</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select count(*) from test ;</font></div><div><font size="2"  >&nbsp;count&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp;10000</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 2.420 ms</font></div><p></p></pre></div><div><br></div><div>4. DELETE</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; delete from test ;</font></div><div><font size="2"  >DELETE 10000</font></div><div><font size="2"  >Time: 93.877 ms</font></div><p></p></pre></div><div><br></div><div>UPDATE性能瓶颈主要来自索引的更新, 特别是col3上的索引, 详细见后面.</div><div><br></div><div>【优化举例】</div><div>【方案1】</div><div>1. 既然大部分的开销是在索引上, 那么减少索引的更新是一种优化办法.</div><div>&nbsp; &nbsp; 按列拆表, 创建视图. 通过创建视图触发器<span style="line-height: 22px;"  >(用于插入,更新,删除操作)</span>. 如下 :&nbsp;</div><div><span style="line-height: 22px;"  >&nbsp; &nbsp; 拆表后更新操作可以减少对索引的更新. 拆表的原则见后面.</span></div><div>把前面用到的test表拆成4个表, 这4个表通过id关联起来. 原表的col1,col2,col3,col4上的索引在分表中也要加上.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \d+ t1</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "digoal.t1"</font></div><div><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp;| Modifiers | Storage | Stats target | Description&nbsp;</font></div><div><font size="2"  >--------+--------+-----------+---------+--------------+-------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | bigint | not null &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col1 &nbsp; | name &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "t1_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_col1" btree (col1)</font></div><div><font size="2"  >Has OIDs: no</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; \d+ t2</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "digoal.t2"</font></div><div><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp;| Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"  >--------+--------+-----------+----------+--------------+-------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | bigint | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col2 &nbsp; | text &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "t2_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_col2" btree (col2)</font></div><div><font size="2"  >Has OIDs: no</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; \d+ t3</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "digoal.t3"</font></div><div><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp;| Modifiers | Storage &nbsp;| Stats target | Description&nbsp;</font></div><div><font size="2"  >--------+--------+-----------+----------+--------------+-------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | bigint | not null &nbsp;| plain &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col3 &nbsp; | text &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "t3_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_col3" btree (col3)</font></div><div><font size="2"  >Has OIDs: no</font></div><div><font size="2"  ><br></font></div><div><font size="2"  >digoal=&gt; \d+ t4</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Table "digoal.t4"</font></div><div><font size="2"  >&nbsp;Column | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers | Storage | Stats target | Description&nbsp;</font></div><div><font size="2"  >--------+-----------------------------+-----------+---------+--------------+-------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null &nbsp;| plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col4 &nbsp; | timestamp without time zone | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "t4_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_col4" btree (col4)</font></div><div><font size="2"  >Has OIDs: no</font></div><p></p></pre></div><div>拆成4个表, 每个表都包含ID字段, 也就是原test表的PK. 通过ID字段关联.&nbsp;</div><div>具体的拆表原则见末尾小结部分.</div><div>创建一下视图 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create or replace view v_t as select t1.id,t1.col1,t2.col2,t3.col3,t4.col4 from t1 inner join t2 using (id) inner join t3 using (id) inner join t4 using (id);</font></div><div><font size="2"  >CREATE VIEW</font></div><p></p></pre></div><div>结构如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; \d+ v_t</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;View "digoal.v_t"</font></div><div><font size="2"  >&nbsp;Column | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers | Storage &nbsp;| Description&nbsp;</font></div><div><font size="2"  >--------+-----------------------------+-----------+----------+-------------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col1 &nbsp; | name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col2 &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"  >&nbsp;col3 &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | extended |&nbsp;</font></div><div><font size="2"  >&nbsp;col4 &nbsp; | timestamp without time zone | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | plain &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >View definition:</font></div><div><font size="2"  >&nbsp;SELECT t1.id, t1.col1, t2.col2, t3.col3, t4.col4</font></div><div><font size="2"  >&nbsp; &nbsp;FROM t1</font></div><div><font size="2"  >&nbsp; &nbsp;JOIN t2 USING (id)</font></div><div><font size="2"  >&nbsp; &nbsp;JOIN t3 USING (id)</font></div><div><font size="2"  >&nbsp; &nbsp;JOIN t4 USING (id);</font></div><p></p></pre></div><div>接下来要创建触发器函数了, 为了程序操作方便, 插入, 更新, 删除, 查询都直接操作这个视图, 那样和操作test表就没有分别了.</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >CREATE OR REPLACE FUNCTION digoal.tg_v_t()<br> RETURNS trigger<br> LANGUAGE plpgsql<br>AS $function$                              <br>declare<br>begin<br>  IF (TG_OP = 'UPDATE') THEN<br>    UPDATE t1 set id=NEW.id,col1=NEW.col1 where id=NEW.id and col1&lt;&gt;NEW.col1;<br>    UPDATE t2 set id=NEW.id,col2=NEW.col2 where id=NEW.id and col2&lt;&gt;NEW.col2;<br>    UPDATE t3 set id=NEW.id,col3=NEW.col3 where id=NEW.id and col3&lt;&gt;NEW.col3;<br>    UPDATE t4 set id=NEW.id,col4=NEW.col4 where id=NEW.id and col4&lt;&gt;NEW.col4;<br>    return NEW;<br>  ELSIF (TG_OP = 'INSERT') THEN<br>    insert into t1 (id, col1) values (NEW.id,NEW.col1);<br>    insert into t2 (id, col2) values (NEW.id,NEW.col2);<br>    insert into t3 (id, col3) values (NEW.id,NEW.col3);<br>    insert into t4 (id, col4) values (NEW.id,NEW.col4);<br>    return NEW;<br>  ELSIF (TG_OP = 'DELETE') THEN<br>    delete from t1 where id=OLD.id;<br>    delete from t2 where id=OLD.id;<br>    delete from t3 where id=OLD.id;<br>    delete from t4 where id=OLD.id;<br>    return OLD;<br>  END IF;<br>  return null;<br>end;<br>$function$;</span></font></div><p></p></pre></div><div>创建触发器 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create trigger tg_v_t INSTEAD OF INSERT OR DELETE OR UPDATE ON v_t FOR EACH ROW EXECUTE PROCEDURE tg_v_t();</font></div><div><font size="2"  >CREATE TRIGGER</font></div><p></p></pre></div><div>触发器函数可以分开INSERT,UPDATE,DELETE建, 去除TG_OP的判断, 亦能提升一点性能.</div><div><br></div><div><div style="line-height: 22px;"  >数据校验测试 :&nbsp;</div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; insert into v_t values (10001,'abc','test','test1',now());</font></div><div style="line-height: 22px;"  ><font size="2"  >INSERT 0 1</font></div><div style="line-height: 22px;"  ><font size="2"  >Time: 30.599 ms</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; update v_t set col1='digoal',col2='digoal',col3='digoal',col4=now() where id &gt; 9995;</font></div><div style="line-height: 22px;"  ><font size="2"  >UPDATE 6</font></div><div style="line-height: 22px;"  ><font size="2"  >Time: 17.493 ms</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; delete from v_t where col1='digoal' and id in (9997,9999);</font></div><div style="line-height: 22px;"  ><font size="2"  >DELETE 2</font></div><div style="line-height: 22px;"  ><font size="2"  >Time: 3.197 ms</font></div><div style="line-height: 22px;"  ><font size="2"  >digoal=&gt; select * from v_t where id&gt;9995;</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; id &nbsp; | &nbsp;col1 &nbsp;| &nbsp;col2 &nbsp;| &nbsp;col3 &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;col4 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >-------+--------+--------+--------+----------------------------</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 9996 | digoal | digoal | digoal | 2013-01-09 15:53:04.247144</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; 9998 | digoal | digoal | digoal | 2013-01-09 15:53:04.247144</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;10000 | digoal | digoal | digoal | 2013-01-09 15:53:04.247144</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;10001 | digoal | digoal | digoal | 2013-01-09 15:53:04.247144</font></div><div style="line-height: 22px;"  ><font size="2"  >(4 rows)</font></div><div style="line-height: 22px;"  ><font size="2"  >Time: 2.265 ms</font></div><p></p></pre></div></div></div><div><br></div><div>拆表后的性能测试 :&nbsp;</div><div>1. INSERT</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >digoal=&gt; insert into v_t select generate_series(1,10000),repeat(md5(clock_timestamp()::text), 10), repeat(md5(clock_timestamp()::text), 10), repeat(md5(clock_timestamp()::text), 3000), clock_timestamp();<br>INSERT 0 10000<br>Time: 95542.662 ms</span></font></div><p></p></pre></div><div><br></div><div>2. UPDATE</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >digoal=&gt; update v_t set col1=repeat(md5(clock_timestamp()::text), 10);<br>UPDATE 10000<br>Time: 6956.229 ms</span></font></div><p></p></pre></div><div><br></div><div>3. SELECT</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; select count(*) from v_t;</font></div><div><font size="2"  >&nbsp;count&nbsp;</font></div><div><font size="2"  >-------</font></div><div><font size="2"  >&nbsp;10000</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >Time: 30.902 ms</font></div><p></p></pre></div><div><br></div><div>4. DELETE</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; delete from v_t;</font></div><div><font size="2"  >DELETE 10000</font></div><div><font size="2"  >Time: 1250.829 ms</font></div><p></p></pre></div><div><br></div><div>【pgbench测试】 :&nbsp;</div><div>10W测试数据, 如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; <span style="line-height: 19px;"  >insert into test select generate_series(1,100000),repeat(md5(clock_timestamp()::text), 10), repeat(md5(clock_timestamp()::text), 10), repeat(md5(clock_timestamp()::text), 3000), clock_timestamp();</span></font></div><div><font size="2"  >digoal=&gt; <span style="line-height: 19px;"  >insert into v_t select generate_series(1,100000),repeat(md5(clock_timestamp()::text), 10), repeat(md5(clock_timestamp()::text), 10), repeat(md5(clock_timestamp()::text), 3000), clock_timestamp();</span></font></div><p></p></pre></div><div><br></div><div>【场景1】 :&nbsp;</div><div>2个非大字段更新</div><div><span style="line-height: 22px;"  >拆表前测试</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; vi t.sql</font></div><div><font size="2"  >\setrandom id 1 100000</font></div><div><font size="2"  ><span style="line-height: 19px;"  >update test set col1=repeat(md5(clock_timestamp()::text), 10), col2=repeat(md5(clock_timestamp()::text), 10) where id=:id;</span></font></div><p></p></pre></div><div>测试结果 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 45262<br>tps = 754.215032 (including connections establishing)<br>tps = 754.324088 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.003502        \setrandom id 1 100000<br>        10.598039       update test set col1=repeat(md5(clock_timestamp()::text), 10), col2=repeat(md5(clock_timestamp()::text), 10) where id=:id;</span></font></div><p></p></pre></div><div><br></div><div><span style="line-height: 22px;"  >拆表后视图更新</span><span style="line-height: 22px;"  >测试</span></div><div><pre class="prettyprint"  ><p></p><div><span style="line-height: 22px;"  ><font size="2"  >ocz@db-172-16-3-150-&gt; vi t.sql</font></span></div><div><div style="line-height: 22px;"  ><font size="2"  >\setrandom id 1 100000</font></div><div style="line-height: 22px;"  ><span style="font-size: small; line-height: 19px;"  >update v_t set col1=repeat(md5(clock_timestamp()::text), 10), col2=repeat(md5(clock_timestamp()::text), 10) where id=:id;</span></div></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >测试结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 394536<br>tps = 6575.466080 (including connections establishing)<br>tps = 6576.538308 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.003344        \setrandom id 1 100000<br>        1.209849        update v_t set col1=repeat(md5(clock_timestamp()::text), 10), col2=repeat(md5(clock_timestamp()::text), 10) where id=:id;</span></font></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >拆表后事务中单表更新</span><span style="line-height: 22px;"  >测试</span></div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >ocz@db-172-16-3-150-&gt; vi t.sql</font></span></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  >\setrandom id 1 100000</font></div><div style="line-height: 22px;"  ><font size="2"  >begin</font></div><div style="line-height: 22px;"  ><font size="2"  >update t1 set col1=</font><span style="font-size: small; line-height: 19px;"  >repeat(md5(clock_timestamp()::text), 10)</span><span style="font-size: small; line-height: 22px;"  >&nbsp;</span><span style="font-size: small; line-height: 22px;"  >where id=:id;</span></div><div style="line-height: 22px;"  ><font size="2"  >update t2 set col2=</font><span style="font-size: small; line-height: 19px;"  >repeat(md5(clock_timestamp()::text), 10)</span><span style="font-size: small; line-height: 22px;"  > where id=:id;</span></div><div style="line-height: 22px;"  ><font size="2"  >end;</font></div></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >测试结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 734025<br>tps = 12227.678754 (including connections establishing)<br>tps = 12229.395011 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.002815        \setrandom id 1 100000<br>        0.071055        begin<br>        0.229502        update t1 set col1=repeat(md5(clock_timestamp()::text), 10) where id=:id;<br>        0.242445        update t2 set col2=repeat(md5(clock_timestamp()::text), 10) where id=:id;<br>        0.101776        end;</span></font></div><p></p></pre></div></div><div style="line-height: 22px;"  >从场景1测试来看拆分后通过视图更新减少列col3和col4的更新, 给性能带来了极大的提升.</div><div style="line-height: 22px;"  ><br></div><div style="line-height: 22px;"  >【场景2】 :&nbsp;</div><div>1个大字段,1个小字段综合更新</div><div>拆表前<span style="line-height: 22px;"  >测试</span></div><div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >ocz@db-172-16-3-150-&gt; vi t.sql</font></div><div style="line-height: 22px;"  ><font size="2"  >\setrandom id 1 100000</font></div><div style="line-height: 22px;"  ><font size="2"  >update test set col1=</font><span style="font-size: small; line-height: 19px;"  >repeat(md5(clock_timestamp()::text), 10)</span><span style="font-size: small; line-height: 22px;"  >, col3=</span><span style="font-size: small; line-height: 19px;"  >repeat(md5(clock_timestamp()::text), 3000)</span><span style="font-size: small; line-height: 22px;"  > where id=:id;</span></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >测试结果 :&nbsp;</span></div></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 35627<br>tps = 593.663136 (including connections establishing)<br>tps = 593.742321 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.003783        \setrandom id 1 100000<br>        13.465606       update test set col1=repeat(md5(clock_timestamp()::text), 10), col3=repeat(md5(clock_timestamp()::text), 3000) where id=:id;</span></font></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >拆表后</span><span style="line-height: 22px;"  >视图更新</span><span style="line-height: 22px;"  >测试</span></div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >ocz@db-172-16-3-150-&gt; vi t.sql</font></span></div><div><div style="line-height: 22px;"  ><font size="2"  >\setrandom id 1 100000</font></div><div style="line-height: 22px;"  ><font size="2"  style="line-height: 19px;"  >update v_t set col1=</font><span style="line-height: 19px; font-size: small;"  >repeat(md5(clock_timestamp()::text), 10)</span><span style="line-height: 22px; font-size: small;"  >, col3=</span><span style="line-height: 19px; font-size: small;"  >repeat(md5(clock_timestamp()::text), 3000)</span><span style="line-height: 22px; font-size: small;"  > where id=:id;</span></div></div><p></p></pre></div><div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >测试结果 :&nbsp;</span></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  ><span style="line-height: 19px;"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 34437<br>tps = 573.834822 (including connections establishing)<br>tps = 573.932045 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.004346        \setrandom id 1 100000<br>        13.929713       update v_t set col1=repeat(md5(clock_timestamp()::text), 10), col3=repeat(md5(clock_timestamp()::text), 3000) where id=:id;</span></font></div><p></p></pre></div></div></div><div>注意大列字段的更新性能没有得到提升. 但是由于大列更新不频繁, 所以总体来说是可以接受的.</div><div><br></div><div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >拆表后事务中单表更新</span><span style="line-height: 22px;"  >测试</span></div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><span style="line-height: 22px;"  ><font size="2"  >ocz@db-172-16-3-150-&gt; vi t.sql</font></span></div><div style="line-height: 22px;"  ><div style="line-height: 22px;"  ><font size="2"  >\setrandom id 1 100000</font></div><div style="line-height: 22px;"  ><font size="2"  >begin</font></div><div style="line-height: 22px;"  ><font size="2"  >update t1 set col1=</font><span style="font-size: small; line-height: 19px;"  >repeat(md5(clock_timestamp()::text), 10)</span><span style="font-size: small; line-height: 22px;"  >&nbsp;</span><span style="font-size: small; line-height: 22px;"  >where id=:id;</span></div><div style="line-height: 22px;"  ><font size="2"  >update t3 set col3=</font><span style="font-size: small; line-height: 19px;"  >repeat(md5(clock_timestamp()::text), 3000)</span><span style="font-size: small; line-height: 22px;"  > where id=:id;</span></div><div style="line-height: 22px;"  ><font size="2"  >end;</font></div></div><p></p></pre></div><div style="line-height: 22px;"  ><span style="line-height: 22px;"  >测试结果 :&nbsp;</span></div></div><div><pre class="prettyprint"  ><p style="line-height: 22px;"  ></p><div><font size="2"  ><span style="line-height: 19px;"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 35155<br>tps = 585.795505 (including connections establishing)<br>tps = 585.875121 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.003436        \setrandom id 1 100000<br>        0.089372        begin<br>        0.253391        update t1 set col1=repeat(md5(clock_timestamp()::text), 10) where id=:id;<br>        13.160805       update t3 set col3=repeat(md5(clock_timestamp()::text), 3000) where id=:id;<br>        0.139259        end;</span></font></div><p style="line-height: 22px;"  ></p></pre></div><div>场景2测试中发现,&nbsp;<span style="line-height: 22px;"  >视图中虽然缺少了col1和col2的更新, 但是性能却和拆表前差不多, 比较差.&nbsp;</span></div><div><span style="line-height: 22px;"  >因此</span>大字段的更新才是性能瓶颈的关键.&nbsp;</div><div><br></div><div>【场景3】 :&nbsp;</div><div>将大列col3上的索引删除后, 测试结果如下 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; psql&nbsp;</font></div><div><font size="2"  >postgres=# \c digoal digoal</font></div><div><font size="2"  >digoal=&gt; drop index idx_col3;</font></div><div><font size="2"  >DROP INDEX</font></div><div><font size="2"  >digoal=&gt; drop index idx_test_col3;</font></div><div><font size="2"  >DROP INDEX</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 269946<br>tps = 4498.935114 (including connections establishing)<br>tps = 4499.613875 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.003341        \setrandom id 1 100000<br>        1.771405        update test set col1=repeat(md5(clock_timestamp()::text), 10), col3=repeat(md5(clock_timestamp()::text), 3000) where id=:id;</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 196676<br>tps = 3277.755460 (including connections establishing)<br>tps = 3278.233032 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.003820        \setrandom id 1 100000<br>        2.432612        update v_t set col1=repeat(md5(clock_timestamp()::text), 10), col3=repeat(md5(clock_timestamp()::text), 3000) where id=:id;</font></div><p></p></pre></div></div><div><pre class="prettyprint"  ><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal<br>transaction type: Custom query<br>scaling factor: 1<br>query mode: prepared<br>number of clients: 8<br>number of threads: 4<br>duration: 60 s<br>number of transactions actually processed: 237624<br>tps = 3959.030176 (including connections establishing)<br>tps = 3959.582280 (excluding connections establishing)<br>statement latencies in milliseconds:<br>        0.003228        \setrandom id 1 100000<br>        0.058514        begin<br>        0.205088        update t1 set col1=repeat(md5(clock_timestamp()::text), 10) where id=:id;<br>        1.660293        update t3 set col3=repeat(md5(clock_timestamp()::text), 3000) where id=:id;<br>        0.086006        end;</font></div><p></p></pre></div><div>场景3和场景2的测试结果进行对比后可以看出大字段上的索引带来了极大的性能损耗.</div><div><br></div><div>【优化方案2】</div><div>1. 删除大字段上的索引.</div><div>删除后的性能如上面的场景3.</div><div>2. 或者不使用全索引, 例如只索引前面32个字符. substr(col3,1,32).</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; create index idx_test_3 on test (substr(col3,1,32));</font></div><div><font size="2"  >digoal=&gt; create index idx_col3 on t3 (substr(col3,1,32));</font></div><p></p></pre></div><div>测试结果如下 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 191874</font></div><div><font size="2"  >tps = 3197.762123 (including connections establishing)</font></div><div><font size="2"  >tps = 3198.203949 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.003331 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 100000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.494849 &nbsp; &nbsp; &nbsp; &nbsp;update test set col1=repeat(md5(clock_timestamp()::text), 10), col3=repeat(md5(clock_timestamp()::text), 3000) where id=:id;</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 150292</font></div><div><font size="2"  >tps = 2504.685327 (including connections establishing)</font></div><div><font size="2"  >tps = 2505.064421 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.003861 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 100000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 3.185736 &nbsp; &nbsp; &nbsp; &nbsp;update v_t set col1=repeat(md5(clock_timestamp()::text), 10), col3=repeat(md5(clock_timestamp()::text), 3000) where id=:id;</font></div><p></p></pre></div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 174549</font></div><div><font size="2"  >tps = 2908.974298 (including connections establishing)</font></div><div><font size="2"  >tps = 2909.398826 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.003254 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 100000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.060880 &nbsp; &nbsp; &nbsp; &nbsp;begin</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.199939 &nbsp; &nbsp; &nbsp; &nbsp;update t1 set col1=repeat(md5(clock_timestamp()::text), 10) where id=:id;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 2.391802 &nbsp; &nbsp; &nbsp; &nbsp;update t3 set col3=repeat(md5(clock_timestamp()::text), 3000) where id=:id;</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.086923 &nbsp; &nbsp; &nbsp; &nbsp;end;</font></div><p></p></pre></div><div>对于更新量较少的大字段, 这样优化还是可行的.</div><div><br></div><div>【优化方案3】</div><div>col3使用大对象存储.</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter table test drop column col3;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=&gt; alter table test add column col3 oid;</font></div><div><font size="2"  >ALTER TABLE</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >digoal=&gt; \d test</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "digoal.test"</font></div><div><font size="2"  >&nbsp;Column | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"  >--------+-----------------------------+-----------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"  >&nbsp;col1 &nbsp; | name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col2 &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col4 &nbsp; | timestamp without time zone |&nbsp;</font></div><div><font size="2"  >&nbsp;col3 &nbsp; | oid &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; |&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "test_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_col1" btree (col1)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_col2" btree (col2)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_col4" btree (col4)</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >digoal=&gt; truncate test ;</font></div><div><font size="2"  >TRUNCATE TABLE</font></div><p></p></pre></div><div>创建写大对象的函数, 打开文件FLAG参考src/include/libpq/libpq-fs.h :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function write_lo (i_bytea bytea) returns oid as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; oid_new_lo oid;</font></div><div><font size="2"  >&nbsp; fd_new_lo int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; select lo_creat(-1) into oid_new_lo;</font></div><div><font size="2"  >&nbsp; select lo_open(oid_new_lo, 131072) into fd_new_lo;</font></div><div><font size="2"  >&nbsp; perform lowrite(fd_new_lo, i_bytea);</font></div><div><font size="2"  >&nbsp; perform lo_close(fd_new_lo);</font></div><div><font size="2"  >&nbsp; return oid_new_lo;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div>创建读大对象的函数,&nbsp;<span style="line-height: 22px;"  >打开文件FLAG参考src/include/libpq/libpq-fs.h</span>&nbsp;:&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >create or replace function read_lo (i_lo_oid oid, i_size int4) returns bytea as $$</font></div><div><font size="2"  >declare</font></div><div><font size="2"  >&nbsp; result bytea;</font></div><div><font size="2"  >&nbsp; fd_lo int;</font></div><div><font size="2"  >begin</font></div><div><font size="2"  >&nbsp; select lo_open(i_lo_oid, 262144) into fd_lo;</font></div><div><font size="2"  >&nbsp; select loread(fd_lo, i_size) into result;</font></div><div><font size="2"  >&nbsp; perform lo_close(fd_lo);</font></div><div><font size="2"  >&nbsp; return result;</font></div><div><font size="2"  >end;</font></div><div><font size="2"  >$$ language plpgsql;</font></div><p></p></pre></div><div><br></div><div>插入数据 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; insert into test (id,col1,col2,col3,col4) select&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; generate_series(1,100000),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; repeat(md5(clock_timestamp()::text), 10),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; repeat(md5(clock_timestamp()::text), 10),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; write_lo(<span style="line-height: 19px;"  >decode(</span>repeat(md5(clock_timestamp()::text), 3000)<span style="line-height: 19px;"  >, 'base64'</span></font><span style="font-size: small;"  >)),&nbsp;</span></div><div><font size="2"  >digoal-&gt; &nbsp; clock_timestamp();</font></div><div><font size="2"  >INSERT 0 100000</font></div><div><font size="2"  >Time: 273653.042 ms</font></div><p></p></pre></div><div>text和bytea的转换可以使用decode和encode函数.</div><div>用法可参见 :&nbsp;</div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-binarystring.html"  >http://www.postgresql.org/docs/9.2/static/functions-binarystring.html</a></div><div><a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/functions-string.html"  >http://www.postgresql.org/docs/9.2/static/functions-string.html</a></div><div>src/backend/utils/adt/encode.c</div><div><br></div><div>pgbench测试, 更新非大字段, 也就是前面场景1的测试 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 1337021</font></div><div><font size="2"  >tps = 22283.174163 (including connections establishing)</font></div><div><font size="2"  >tps = 22286.160069 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002805 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 100000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.353505 &nbsp; &nbsp; &nbsp; &nbsp;update test set col1=repeat(md5(clock_timestamp()::text), 10), col2=repeat(md5(clock_timestamp()::text), 10) where id=:id;</font></div><p></p></pre></div><div>性能从754tps提升到<span style="line-height: 22px;"  >22286 tps</span></div><div><br></div><div>大对象存储在<span style="line-height: 22px;"  >pg_largeobject中, 因此大对象的条数限制是oid的上限(无符号32位整型), 2^32-1. 一个数据库中没有办法存储超出2^32-1条大对象.</span></div><div><span style="line-height: 22px;"  >1个大对象被分成多个data段存储, 如下.</span></div><div><div style="line-height: 22px;"  ><pre class="prettyprint"  ><p></p><div style="line-height: 22px;"  ><font size="2"  >digoal=# \d pg_largeobject</font></div><div style="line-height: 22px;"  ><font size="2"  >Table "pg_catalog.pg_largeobject"</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;Column | &nbsp;Type &nbsp; | Modifiers&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >--------+---------+-----------</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;loid &nbsp; | oid &nbsp; &nbsp; | not null</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;pageno | integer | not null</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp;data &nbsp; | bytea &nbsp; |&nbsp;</font></div><div style="line-height: 22px;"  ><font size="2"  >Indexes:</font></div><div style="line-height: 22px;"  ><font size="2"  >&nbsp; &nbsp; "pg_largeobject_loid_pn_index" UNIQUE, btree (loid, pageno)</font></div><p></p></pre></div></div><div>不需要的大对象的清除方法 :&nbsp;</div><div><pre class="prettyprint"  ><p><font size="2"  >select lo_unlink(col3) from test;</font></p></pre></div></div><div>切记, 删除数据前要清除大对象, 否则这些数据会一直存在pg_largeobject中, 类似内存泄露.</div><div><br></div><div>【小结】</div><div>1. 首先, 不管大字段要不要更新, 首先把大字段拆出去. 这样更新性能可以从754tps 上升到 6576tps(更新视图) 或 12229tps(直接更新拆分后的底层表).</div><div>&nbsp; &nbsp; 其次, 大字段上尽量不要使用索引, 无索引的情况下更新大字段的性能可以从593tps 上升到 4499tps.</div><div>&nbsp; &nbsp; 再次, 如果大字段上必须要索引, 可以根据实际情况减少索引的长度, 例如只索引前32个字符(函数索引 | 表达式索引). 这样<span style="line-height: 22px;"  >更新大字段的</span>性能<span style="line-height: 22px;"  >可以从593tps 上升到 3198tps.</span></div><div><span style="line-height: 22px;"  >&nbsp; &nbsp; 最后, 可以考虑将大字段类型text改为oid, 也就是存储在大对象中(text最大存储1GB, 大对象可以存储2GB). 但是需要注意一个数据库的大对象条数是有限制的, 也就是OID的上限. 如果要突破这个限制还是考虑拆表使用text或者bytea类型吧. 使用大对象的情况下更新非大字段的性能可以</span><span style="line-height: 22px;"  >从754tps 提升到</span><span style="line-height: 22px;"  >22286 tps .</span></div><div>2. 拆表后的优势: 降低索引更新概率, 提高处理速度. 拆表后查询性能会变差. 但是如果不查大字段, 性能会更好, 因为扫描的HEAP块更少了.</div><div>3. 拆表后需要更多的存储来存储PK. 拆得越细, 耗费越大. 例如本例int8占用8字节, 拆表后比原来多了3个int8, 1000W条记录将多耗费24*10000KB=240MB. 但是换来了极好的更新性能.</div><div>4. 拆表的原则</div><div>&nbsp; 4.1 根据索引拆, 如果包含col1,col2的联合索引, 那么拆成id,col1,col2</div><div>&nbsp; 4.2 根据大小拆, 如果col3这个字段一般都存储1KB大小的内容, 较大. 所以可以拆成id, col3</div><div>&nbsp; 4.3 以上都拆掉后根据经常更新的列拆, 如col4经常被更新, 那么拆成id, col4</div><div>&nbsp; 经过以上拆分后test就拆成3个表了. 然后用id把这几个表关联起来.</div><div><span style="line-height: 22px;"  >5. 拆表后如果需要truncate表, 要在底层表上执行truncate, 因为view上不能建truncate触发器. 同时需要注意这些truncate要放在一个事务中处理.</span></div><div>6. 为什么拆表后更新性能可以得到提升呢?</div><div>&nbsp; 6.1. 因为PostgreSQL 更新记录的操作实际上是新增1个tuple版本, 例如更新1KB的行, 会新产生1个1KB的行. 老的tuple在事务结束后由autovacuum进程去擦除. 或者手工执行vacuum.</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;所以行越大, 更新的开销越大. 拆表后更新的粒度变小, 性能自然可以提高.</div><div>&nbsp; 6.2 未拆表时, 一行更新的话, 所有的索引都会被更新, 除非HOT, 但是大行的表HOT的概率非常低.&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; 因此每次更新所有的索引都要被更新. 大大加大了IO和CPU的开销.</div><div>&nbsp; (HOT请参见 : src/backend/access/heap/README.HOT)</div><div>&nbsp; &nbsp; &nbsp; &nbsp; 拆表后, 更新索引的概率会大大降低了.&nbsp;</div><div>7. 本例真正的性能瓶颈是大字段的索引耗费的CPU, 去除索引后性能将突飞猛进.&nbsp;</div><div><wbr></div>8. 更新的另一个主要瓶颈还可能来自不规则的更新导致的索引页迁移等IO和CPU开销。<div>可参见 :&nbsp;</div><div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020129249646421/"  >http://blog.163.com/digoal@126/blog/static/16387704020129249646421/</a></div><div>9.&nbsp;<a target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/9.2/static/largeobjects.html"  >http://www.postgresql.org/docs/9.2/static/largeobjects.html</a></div><div>打开文件可选flag</div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >src/include/libpq/libpq-fs.h</font></div><div><font size="2"  >/*</font></div><div><font size="2"  >&nbsp;* &nbsp; &nbsp; &nbsp;Read/write mode flags for inversion (large object) calls</font></div><div><font size="2"  >&nbsp;*/</font></div><div><font size="2"  >#define INV_WRITE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 0x00020000</font></div><div><font size="2"  >#define INV_READ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0x00040000</font></div><p></p></pre></div>【其他】<div>如果tuple大到需要存储到TOAST表了, 那性能又会发生翻天覆地的变化, 原因和前面提到的large object类似. 在HEAP中存储的是一个指向TOAST存储的虚拟值.&nbsp;</div><div>TOAST具体可参考 src/include/access/tuptoaster.h .&nbsp;</div><div>下面是一个测试 :&nbsp;</div><div><div><pre class="prettyprint"  ><p></p><div><font size="2"  >digoal=&gt; alter table test drop column col3;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=&gt; truncate table test;</font></div><div><font size="2"  >alTRUNCATE TABLE</font></div><div><font size="2"  >digoal=&gt; alter table test add column col3 text;</font></div><div><font size="2"  >ALTER TABLE</font></div><div><font size="2"  >digoal=&gt; \d test</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Table "digoal.test"</font></div><div><font size="2"  >&nbsp;Column | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Type &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Modifiers&nbsp;</font></div><div><font size="2"  >--------+-----------------------------+-----------</font></div><div><font size="2"  >&nbsp;id &nbsp; &nbsp; | bigint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| not null</font></div><div><font size="2"  >&nbsp;col1 &nbsp; | name &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col2 &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >&nbsp;col4 &nbsp; | timestamp without time zone |&nbsp;</font></div><div><font size="2"  >&nbsp;col3 &nbsp; | text &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"  >Indexes:</font></div><div><font size="2"  >&nbsp; &nbsp; "test_pkey" PRIMARY KEY, btree (id)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_col1" btree (col1)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_col2" btree (col2)</font></div><div><font size="2"  >&nbsp; &nbsp; "idx_test_col4" btree (col4)</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >digoal=&gt; create index idx_test_col3 on test(substr(col3,1,8192));</font></div><div><font size="2"  >CREATE INDEX</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >digoal=&gt; insert into test (id,col1,col2,col3,col4) select&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; &nbsp;generate_series(1,10),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; &nbsp;repeat(md5(clock_timestamp()::text), 10),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; &nbsp;repeat(md5(clock_timestamp()::text), 10),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; &nbsp;repeat(md5(clock_timestamp()::text), 30000),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; &nbsp;clock_timestamp();</font></div><div><font size="2"  >INSERT 0 10</font></div><div><font size="2"  >digoal=&gt; select pg_column_size(col3) from test limit 1;</font></div><div><font size="2"  >&nbsp;pg_column_size&nbsp;</font></div><div><font size="2"  >----------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11031</font></div><div><font size="2"  >(1 row)</font></div><div><span style="font-size: small; line-height: 19px;"  >单条记录达到11KB. 已经超过HEAP PAGE的8KB, 必然是存储在 TOAST中的.</span></div><div><font size="2"  >digoal=&gt; select reltoastrelid from pg_class where relname='test';</font></div><div><font size="2"  >&nbsp;reltoastrelid&nbsp;</font></div><div><font size="2"  >---------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 108690</font></div><div><font size="2"  >(1 row)</font></div><div><font size="2"  >digoal=&gt; select pg_relation_size(108690::regclass);</font></div><div><font size="2"  >&nbsp;pg_relation_size&nbsp;</font></div><div><font size="2"  >------------------</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;139264</font></div><div><font size="2"  >(1 row)</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >digoal=&gt; truncate test ;</font></div><div><font size="2"  >TRUNCATE TABLE</font></div><div><font size="2"  >digoal=&gt; insert into test (id,col1,col2,col3,col4) select&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; &nbsp;generate_series(1,100000),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; &nbsp;repeat(md5(clock_timestamp()::text), 10),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; &nbsp;repeat(md5(clock_timestamp()::text), 10),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; &nbsp;repeat(md5(clock_timestamp()::text), 30000),&nbsp;</font></div><div><font size="2"  >digoal-&gt; &nbsp; &nbsp;clock_timestamp();</font></div><div><font size="2"  >INSERT 0 100000</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 126582</font></div><div><font size="2"  >tps = 2109.062220 (including connections establishing)</font></div><div><font size="2"  >tps = 2109.413805 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.003987 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 100000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 3.783014 &nbsp; &nbsp; &nbsp; &nbsp;update test set col1=repeat(md5(clock_timestamp()::text), 10), col2=repeat(md5(clock_timestamp()::text), 10) where id=:id;</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >digoal=&gt; drop index idx_test_col3;</font></div><div><font size="2"  >DROP INDEX</font></div><p></p></pre></div><div><pre class="prettyprint"  ><div><font size="2"  >ocz@db-172-16-3-150-&gt; pgbench -M prepared -f ./t.sql -n -r -c 8 -j 4 -T 60 -h 127.0.0.1 -U digoal digoal</font></div><div><font size="2"  >transaction type: Custom query</font></div><div><font size="2"  >scaling factor: 1</font></div><div><font size="2"  >query mode: prepared</font></div><div><font size="2"  >number of clients: 8</font></div><div><font size="2"  >number of threads: 4</font></div><div><font size="2"  >duration: 60 s</font></div><div><font size="2"  >number of transactions actually processed: 1436122</font></div><div><font size="2"  >tps = 23934.814969 (including connections establishing)</font></div><div><font size="2"  >tps = 23938.109376 (excluding connections establishing)</font></div><div><font size="2"  >statement latencies in milliseconds:</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.002752 &nbsp; &nbsp; &nbsp; &nbsp;\setrandom id 1 100000</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; 0.328780 &nbsp; &nbsp; &nbsp; &nbsp;update test set col1=repeat(md5(clock_timestamp()::text), 10), col2=repeat(md5(clock_timestamp()::text), 10) where id=:id;</font></div><p></p></pre></div></div>8KB的BLOCKSIZE默认阈值大概是2KB左右, 如何<span style="line-height: 22px;"  >修改字段存储到TOAST的阈值,&nbsp;</span>参考如下 :&nbsp;<div><a target="_blank" href="http://blog.163.com/digoal@126/blog/static/16387704020130108132117/"  >http://blog.163.com/digoal@126/blog/static/16387704020130108132117/</a></div><br><div>encode, decode, convert_from例子 :&nbsp;</div><div><pre class="prettyprint"  ><p></p><div><div><font size="2"  >postgres=# select convert_from(decode('你好', 'escape'), 'UTF8'::name);</font></div><div><font size="2"  >&nbsp;convert_from&nbsp;</font></div><div><font size="2"  >--------------</font></div><div><font size="2"  >&nbsp;你好</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  >postgres=# select decode(clock_timestamp()::text, 'escape');</font></div><div><font size="2"  >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; decode &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"  >--------------------------------------------------------------</font></div><div><font size="2"  >&nbsp;\x323031332d30312d31352030373a34353a30382e3430303737322b3038</font></div><div><font size="2"  >(1 row)</font></div></div><div><div><font size="2"  >postgres=# select encode(decode(array[1,2,3,4,5]::text, 'escape'), 'escape');</font></div><div><font size="2"  >&nbsp; &nbsp;encode &nbsp; &nbsp;</font></div><div><font size="2"  >-------------</font></div><div><font size="2"  >&nbsp;{1,2,3,4,5}</font></div><div><font size="2"  >(1 row)</font></div></div><p></p></pre></div></div>
	</div>
	<h3>评论</h3>
	<div class="" id="" style="padding:0 20px;">
			<div id="">
				<h5 id="">九九 - 2013-05-07 10:44:24</h5>
				<div><div>e`: &nbsp;Y料行 "col4" 是型e timestamp without time zone[]，但\算式是型e timestamp with time zone</div><div>LINE 1: ... 10), repeat(md5(clock_timestamp()::text), 3000), clock_time...</div><div><br></div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 九九 - 2013-05-07 10:44:24</h5>
				<div style="width:600px;">clock_timestamp返回的是timestamp with timezone, 且支持自动转换.<div><div>postgres=# select oid,typname from pg_type where typname ~ 'time';</div><div>&nbsp; oid &nbsp;| &nbsp; &nbsp; &nbsp; typname &nbsp; &nbsp; &nbsp;&nbsp;</div><div>-------+---------------------</div><div>&nbsp; &nbsp;702 | abstime</div><div>&nbsp; &nbsp;703 | reltime</div><div>&nbsp; 1023 | _abstime</div><div>&nbsp; 1024 | _reltime</div><div>&nbsp; 1083 | time</div><div>&nbsp; 1114 | timestamp</div><div>&nbsp; 1115 | _timestamp</div><div>&nbsp; 1183 | _time</div><div>&nbsp; 1184 | timestamptz</div><div>&nbsp; 1185 | _timestamptz</div><div>&nbsp; 1266 | timetz</div><div>&nbsp; 1270 | _timetz</div><div>&nbsp;11119 | pg_timezone_abbrevs</div><div>&nbsp;11122 | pg_timezone_names</div><div>&nbsp;12286 | time_stamp</div><div>(15 rows)</div><div><br></div><div>postgres=# select * from pg_cast where castsource=1114 and casttarget=1184;</div><div>&nbsp;castsource | casttarget | castfunc | castcontext | castmethod&nbsp;</div><div>------</div></div></div>
			</div>
			<div style="padding-left:40px;">
				<h5 id="">德哥@Digoal 回复 九九 - 2013-05-07 10:44:24</h5>
				<div style="width:600px;"><div><br></div><div><div>postgres=# select oid,proname from pg_proc where oid in (2028,2027);</div><div>&nbsp;oid &nbsp;| &nbsp; proname &nbsp;&nbsp;</div><div>------+-------------</div><div>&nbsp;2027 | timestamp</div><div>&nbsp;2028 | timestamptz</div><div>(2 rows)</div></div></div>
			</div>
	</div>
</div>
</body>
</html>