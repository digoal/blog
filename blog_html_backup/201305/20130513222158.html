<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">device-mapper: multipath: Failing path recovery</h2>
	<h5 id="">2013-05-13 22:21:58&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/1638770402013413101459113/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>由于扇区损坏导致多路径设备failed.</div><div>现象如下 :&nbsp;</div><div># dmesg :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >device-mapper: multipath: Failing path 8:128.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:1): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:1): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:1): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:1): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:1): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >qla2xxx 0000:07:00.1: scsi(1:0:0:1): Mid-layer underflow detected (40000 of 40000 bytes)...returning error status.</font></div><div><font size="2"   >sd 1:0:0:1: SCSI error: return code = 0x00070000</font></div><div><font size="2"   >end_request: I/O error, dev sda, sector 3870947799</font></div><div><font size="2"   >device-mapper: multipath: Failing path 8:0.</font></div><div><font size="2"   >sd 0:0:0:1: SCSI error: return code = 0x08000002</font></div><div><font size="2"   >sdi: Current: sense key: Medium Error</font></div><div><font size="2"   >&nbsp; &nbsp; Add. Sense: Unrecovered read error</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >Info fld=0x0</font></div><div><font size="2"   >end_request: I/O error, dev sdi, sector 3870947799</font></div><p></p></pre></div><div><br></div><div><div># multipath -ll</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >msa2vd01vol01 (3600c0ff000xxxxxxf810394c01000000) dm-0 HP,MSA2312fc</font></div><div><font size="2"   >[size=1.8T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=50][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:0:1 sdi 8:128 [failed][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=10][enabled]</font></div><div><font size="2"   >&nbsp;\_ 1:0:0:1 sda 8:0 &nbsp; [failed][ready]</font></div><p></p></pre></div></div><div><br></div><div><span style="line-height: 22px;"   >扇区损坏可能是前段时间存储故障, 以及存储的volume write back缓存机制导致的.</span></div><div>修复先要将多路径设备搞好 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><span style="font-family: HPSimplified, 'HPSimplified latin', Arial, sans-serif; line-height: 22px;"   ><font size="2"   >echo 1 &gt; /sys/block/sda/device/delete</font></span></div><div><span style="font-family: HPSimplified, 'HPSimplified latin', Arial, sans-serif; line-height: 22px;"   ><font size="2"   >echo 1 &gt; /sys/block/sdi/device/delete</font></span></div><div><span style="font-family: HPSimplified, 'HPSimplified latin', Arial, sans-serif; line-height: 22px;"   ><font size="2"   >echo "- - -" &gt; /sys/class/scsi_host/${HBA}/scan, 如下</font></span></div><div><span style="font-family: HPSimplified, 'HPSimplified latin', Arial, sans-serif; line-height: 22px;"   ><font size="2"   >echo "- - -" &gt; /sys/class/scsi_host/host0/scan</font></span></div><div><span style="font-family: HPSimplified, 'HPSimplified latin', Arial, sans-serif; line-height: 22px;"   ><font size="2"   >echo "- - -" &gt; /sys/class/scsi_host/host1/scan</font></span></div><p></p></pre></div><div><span style="line-height: 25px; font-family: HPSimplified, 'HPSimplified latin', Arial, sans-serif; font-size: 16px;"   ># multipath -v2</span></div><div><div style="font-family: HPSimplified, 'HPSimplified latin', Arial, sans-serif; line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div><font size="2"   >: checker msg is "readsector0 checker reports path is down"</font></div><div><font size="2"   >reload: msa2vd01vol01 (3600c0ff000xxxxxxf810394c01000000) &nbsp;HP,MSA2312fc</font></div><div><font size="2"   >[size=1.8T][features=0][hwhandler=0][n/a]</font></div><div><font size="2"   >\_ round-robin 0 [prio=50][undef]</font></div><div><font size="2"   >&nbsp;\_ 0:0:0:1 sda 8:0 &nbsp; [undef][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=10][undef]</font></div><div><font size="2"   >&nbsp;\_ 1:0:0:1 sde 8:64 &nbsp;[undef][ready]</font></div><p></p></pre></div><div><font face="HPSimplified, HPSimplified latin, Arial, sans-serif"   size="3"   ><span style="line-height: 25px;"   >#&nbsp;</span></font><span style="font-family: Arial, Helvetica, sans-serif; font-size: 14px; line-height: 22px;"   >dmesg :&nbsp;</span></div><div style="font-family: HPSimplified, 'HPSimplified latin', Arial, sans-serif; line-height: 22px;"   ><div style="line-height: 22px; font-family: Arial, Helvetica, sans-serif;"   ><div style="line-height: 22px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 22px;"   ><font size="2"   >&nbsp; Vendor: HP &nbsp; &nbsp; &nbsp; &nbsp;Model: MSA2312fc &nbsp; &nbsp; &nbsp; &nbsp; Rev: M112</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; Type: &nbsp; Direct-Access &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ANSI SCSI revision: 05</font></div><div style="line-height: 22px;"   ><font size="2"   >SCSI device sda: 3902343744 512-byte hdwr sectors (1998000 MB)</font></div><div style="line-height: 22px;"   ><font size="2"   >sda: Write Protect is off</font></div><div style="line-height: 22px;"   ><font size="2"   >sda: Mode Sense: 93 00 00 08</font></div><div style="line-height: 22px;"   ><font size="2"   >SCSI device sda: drive cache: write back</font></div><div style="line-height: 22px;"   ><font size="2"   >SCSI device sda: 3902343744 512-byte hdwr sectors (1998000 MB)</font></div><div style="line-height: 22px;"   ><font size="2"   >sda: Write Protect is off</font></div><div style="line-height: 22px;"   ><font size="2"   >sda: Mode Sense: 93 00 00 08</font></div><div style="line-height: 22px;"   ><font size="2"   >SCSI device sda: drive cache: write back</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;sda: sda1</font></div><div style="line-height: 22px;"   ><font size="2"   >sd 0:0:0:1: Attached scsi disk sda</font></div><div style="line-height: 22px;"   ><font size="2"   >sd 0:0:0:1: Attached scsi generic sg1 type 0</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; Vendor: HP &nbsp; &nbsp; &nbsp; &nbsp;Model: MSA2312fc &nbsp; &nbsp; &nbsp; &nbsp; Rev: M112</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp; Type: &nbsp; Direct-Access &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ANSI SCSI revision: 05</font></div><div style="line-height: 22px;"   ><font size="2"   >SCSI device sde: 3902343744 512-byte hdwr sectors (1998000 MB)</font></div><div style="line-height: 22px;"   ><font size="2"   >sde: Write Protect is off</font></div><div style="line-height: 22px;"   ><font size="2"   >sde: Mode Sense: 93 00 00 08</font></div><div style="line-height: 22px;"   ><font size="2"   >SCSI device sde: drive cache: write back</font></div><div style="line-height: 22px;"   ><font size="2"   >SCSI device sde: 3902343744 512-byte hdwr sectors (1998000 MB)</font></div><div style="line-height: 22px;"   ><font size="2"   >sde: Write Protect is off</font></div><div style="line-height: 22px;"   ><font size="2"   >sde: Mode Sense: 93 00 00 08</font></div><div style="line-height: 22px;"   ><font size="2"   >SCSI device sde: drive cache: write back</font></div><div style="line-height: 22px;"   ><font size="2"   >&nbsp;sde: sde1</font></div><div style="line-height: 22px;"   ><font size="2"   >sd 1:0:0:1: Attached scsi disk sde</font></div><div style="line-height: 22px;"   ><font size="2"   >sd 1:0:0:1: Attached scsi generic sg6 type 0</font></div><p></p></pre></div><div style="font-size: 14px; line-height: 22px;"   ><br></div></div></div><div style="font-family: HPSimplified, 'HPSimplified latin', Arial, sans-serif; line-height: 22px;"   ><div style="font-size: 16px;"   ># multipath -ll</div><div><pre class="prettyprint"   ><p></p><div><span style="line-height: 25px;"   ><font size="2"   >msa2vd01vol01 (3600c0ff000xxxxxxf810394c01000000) dm-0 HP,MSA2312fc</font></span></div><div><font size="2"   >[size=1.8T][features=1 queue_if_no_path][hwhandler=0][rw]</font></div><div><font size="2"   >\_ round-robin 0 [prio=50][enabled]</font></div><div><font size="2"   >&nbsp;\_ 0:0:0:1 sda 8:0 &nbsp; [active][ready]</font></div><div><font size="2"   >\_ round-robin 0 [prio=10][enabled]</font></div><div><font size="2"   >&nbsp;\_ 1:0:0:1 sde 8:64 &nbsp;[active][ready]</font></div><p></p></pre></div></div><div style="font-family: HPSimplified, 'HPSimplified latin', Arial, sans-serif; line-height: 22px; font-size: 16px;"   ><span style="line-height: 22px; font-family: Arial, Helvetica, sans-serif; font-size: 14px;"   >umount 挂载点.</span></div></div><div>然后使用fsck修复.</div><div><pre class="prettyprint"   ><p><font size="2"   >fsck -v -p /dev/mapper/msa2vd01vol01p1</font></p></pre></div><div><div style="line-height: 22px;"   >查看文件系统信息 :&nbsp;</div></div><div>dumpe2fs /dev/mapper/msa2vd01vol01p1 &gt;~/dumpe2fs.log</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Filesystem volume name: &nbsp; &lt;none&gt;</font></div><div><font size="2"   >Last mounted on: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&lt;not available&gt;</font></div><div><font size="2"   >Filesystem UUID: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;63d08b38-6214-4a28-8f3e-0b8fd9c1734e</font></div><div><font size="2"   >Filesystem magic number: &nbsp;0xEF53</font></div><div><font size="2"   >Filesystem revision #: &nbsp; &nbsp;1 (dynamic)</font></div><div><font size="2"   >Filesystem features: &nbsp; &nbsp; &nbsp;has_journal ext_attr resize_inode dir_index filetype needs_recovery sparse_super large_file</font></div><div><font size="2"   >Default mount options: &nbsp; &nbsp;(none)</font></div><div><font size="2"   >Filesystem state: &nbsp; &nbsp; &nbsp; &nbsp; clean</font></div><div><font size="2"   >Errors behavior: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Continue</font></div><div><font size="2"   >Filesystem OS type: &nbsp; &nbsp; &nbsp; Linux</font></div><div><font size="2"   >Inode count: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;243908608</font></div><div><font size="2"   >Block count: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;487791627</font></div><div><font size="2"   >Reserved block count: &nbsp; &nbsp; 24389581</font></div><div><font size="2"   >Free blocks: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;117876429</font></div><div><font size="2"   >Free inodes: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;243257871</font></div><div><font size="2"   >First block: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;0</font></div><div><font size="2"   >Block size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 4096</font></div><div><font size="2"   >Fragment size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;4096</font></div><div><font size="2"   >Reserved GDT blocks: &nbsp; &nbsp; &nbsp;907</font></div><div><font size="2"   >Blocks per group: &nbsp; &nbsp; &nbsp; &nbsp; 32768</font></div><div><font size="2"   >Fragments per group: &nbsp; &nbsp; &nbsp;32768</font></div><div><font size="2"   >Inodes per group: &nbsp; &nbsp; &nbsp; &nbsp; 16384</font></div><div><font size="2"   >Inode blocks per group: &nbsp; 512</font></div><div><font size="2"   >Filesystem created: &nbsp; &nbsp; &nbsp; Wed Jul 21 19:10:23 2010</font></div><div><font size="2"   >Last mount time: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Tue May 14 07:38:24 2013</font></div><div><font size="2"   >Last write time: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Tue May 14 07:38:24 2013</font></div><div><font size="2"   >Mount count: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;1</font></div><div><font size="2"   >Maximum mount count: &nbsp; &nbsp; &nbsp;36</font></div><div><font size="2"   >Last checked: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Mon May 13 22:19:35 2013</font></div><div><font size="2"   >Check interval: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 15552000 (6 months)</font></div><div><font size="2"   >Next check after: &nbsp; &nbsp; &nbsp; &nbsp; Sat Nov &nbsp;9 22:19:35 2013</font></div><div><font size="2"   >Reserved blocks uid: &nbsp; &nbsp; &nbsp;0 (user root)</font></div><div><font size="2"   >Reserved blocks gid: &nbsp; &nbsp; &nbsp;0 (group root)</font></div><div><font size="2"   >First inode: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;11</font></div><div><font size="2"   >Inode size: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 128</font></div><div><font size="2"   >Journal inode: &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;8</font></div><div><font size="2"   >Default directory hash: &nbsp; tea</font></div><p></p></pre></div><div><br></div><div>计算扇区对应的数据块id :&nbsp;</div><div>blocksize=4096, 扇区大小为512字节, 所以扇区号为3870947799对应的blockid=<span style="line-height: 22px;"   >3870947799/8=</span>483868474.875</div><div>找<span style="line-height: 22px;"   >dumpe2fs.log, 看看这个blockid是在哪个group中.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Group 14766: (Blocks 483852288-483885055)</font></div><div><font size="2"   >&nbsp; Block bitmap at 483852288 (+0), Inode bitmap at 483852289 (+1)</font></div><div><font size="2"   >&nbsp; Inode table at 483852290-483852801 (+2)</font></div><div><font size="2"   >&nbsp; 1027 free blocks, 16384 free inodes, 0 directories</font></div><div><font size="2"   >&nbsp; Free blocks: 483855860-483856886</font></div><div><font size="2"   >&nbsp; Free inodes: 241926145-241942528</font></div><p></p></pre></div><div>使用badblocks检查坏块.</div><div><pre class="prettyprint"   ><p><font size="2"   >badblocks -v -b 4096 -o ./badblocks.20130514 /dev/sda 483868480 483868460</font></p></pre></div><div>定位到坏块为<span style="line-height: 22px;"   >483868476</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># cat badblocks.20130514</font></div><div><font size="2"   >483868476</font></div><p></p></pre></div><div>接下来是修复 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># dd if=/dev/sda of=./badblock483868476.data bs=4096 skip=483868476 count=1</font></div><div><font size="2"   >dd: reading `/dev/sda': Input/output error</font></div><div><font size="2"   >0+0 records in</font></div><div><font size="2"   >0+0 records out</font></div><div><font size="2"   >0 bytes (0 B) copied, 0.003665 seconds, 0.0 kB/s</font></div><p></p></pre></div><div>如果读出数据来了, 那么可以将数据回写进行修复.</div><div><pre class="prettyprint"   ><p><font size="2"   >dd if=./badblock483868476.data of=/dev/sda seek=483868476 bs=4096 count=1</font></p></pre></div><div><br></div><div>多遍尝试后如果数据无法读取, 则可以采用覆写的方法修复. 直接放弃这个数据块.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >badblocks -f -v -w -b 4096 /dev/sda 483868477 483868476</font></div><div><font size="2"   >/dev/sda is apparently in use by the system; badblocks forced anyway.</font></div><div><font size="2"   >Checking for bad blocks in read-write mode</font></div><div><font size="2"   >From block 483868476 to 483868477</font></div><div><font size="2"   >Testing with pattern 0xaa: done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Reading and comparing: done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Testing with pattern 0x55: done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Reading and comparing: done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Testing with pattern 0xff: done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Reading and comparing: done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Testing with pattern 0x00: done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Reading and comparing: done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Pass completed, 0 bad blocks found.</font></div><p></p></pre></div><div>再次检测已无坏块 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># badblocks -v -b 4096 /dev/sda 483868480 483868460</font></div><div><font size="2"   >Checking blocks 483868460 to 483868480</font></div><div><font size="2"   >Checking for bad blocks (read-only test): done &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >Pass completed, 0 bad blocks found.</font></div><p></p></pre></div><div><br></div><div># 接下来是将数据库中的这部分数据重建.&nbsp;</div><div>如果是PostgreSQL 可以使用</div><div><pre class="prettyprint"   ><p><font size="2"   >ZERO_DAMAGED_PAGES = true</font></p></pre></div><div>将数据读出后重新写入.&nbsp;</div><div>如果是greenplum, 并且是压缩表的话, 可能会有解压错误, 所以建议重新抽取数据.</div><div><pre class="prettyprint"   ><p><font size="2"   >ERROR: &nbsp;ZLIB uncompress failed (detail: 'The compressed data was corrupted', output buffer length 32568, compressed length 12136, (block count 3651)) (gp_compress.c:355) &nbsp;(seg4 slice1 dw-host37-if2:51001 pid=5024)</font></p></pre></div><div><br></div>【参考】<wbr><div>1.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/5/pdf/Online_Storage_Reconfiguration_Guide/Red_Hat_Enterprise_Linux-5-Online_Storage_Reconfiguration_Guide-en-US.pdf?"   >https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/5/pdf/Online_Storage_Reconfiguration_Guide/Red_Hat_Enterprise_Linux-5-Online_Storage_Reconfiguration_Guide-en-US.pdf?</a></div><div>2.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://h10025.www1.hp.com/ewfrf/wc/document?cc=us&amp;lc=en&amp;dlc=en&amp;tmp_geoLoc=true&amp;docname=c03113986"   >http://h10025.www1.hp.com/ewfrf/wc/document?cc=us&amp;lc=en&amp;dlc=en&amp;tmp_geoLoc=true&amp;docname=c03113986</a></div><div>3.&nbsp;<a style="line-height: 22px;" rel="nofollow" href="http://www.ehow.com/how_6864409_fix-bad-sectors-ubuntu.html"   >http://www.ehow.com/how_6864409_fix-bad-sectors-ubuntu.html</a></div>4. dumpe2fs<div>5. tune2fs</div><div>6. fsck</div><div>7. e2fsck</div><div>8. badblocks</div><div>9. mkfs.ext3时可以忽略badblocks检测到的坏扇区.</div><div><br></div><div>[其他摘录]</div><div><div>现在的硬盘，在内部会有一保留区域，来替换出现坏块的扇区，这对于磁盘外的系统来说是透明的，</div><div>如果已经存在了坏道，硬盘会在写入的时候将它替换到别的位置， 注意， 只有在写入的时候，才进行重定位。</div><div>我完全不必要使用上层的文件系统的坏道表功能， 只要对坏块位置进行写入，就可以修复了。</div><div><br></div><div>使用badblocks 可以查出坏块，然后badblocks本是具有写测试功能，我只需要用badblocks就可以了，</div><div>因为不用向上层的文件系统提供坏道表， 所以我在扫描坏道时，不用设置块大小参数(-b),</div><div>首先扫描坏道</div><div>badblocks -b 4096 -o /root/sdb.bad /etc/sdb&nbsp;</div><div>经过慢长的时间，我得到了一个文件/root/sdb.bad :</div><div>16435904</div><div>sdb 有1个坏块</div><div>先用dd尽量备份坏块</div><div>dd if=/dev/sdb bs=4096 skip=16435904 of=/tmp/15435904.dat count=1</div><div>如果显示读取字节数是0就多试几次, 不行就可能丢失此块数据, 倒是不用担心,一般不会有太大问题.</div><div>用badblocks的写测试功能，对这些坏块进行重写(注意! -w写测试会覆盖数据)：</div><div>badblocks -w -f /dev/sdb5 16435904 16435904</div><div>如果前面的操作有成功的备份/tmp/15435904.dat, 就把它写回:</div><div>dd if=/tmp/15435904.dat of=/dev/sdb seek=15435904 bs=4096 count=1</div><div>其实我不需要等待badblocks扫描完成， 就可以进行修复。</div><div><br></div><div>badblocks是对块设备进行处理， 所以可以实现对挂载中的系统进行处理。</div><div><br></div><div>数据比硬盘值钱， 这只可以作为临时措施，出现坏道， 还是应该换硬盘，现在硬盘不贵。</div></div><div><br></div><div>///badblocks －v /dev/sda &nbsp;这个是检查硬盘有无坏道／坏扇区的命令//</div><div>&nbsp; &nbsp;硬盘是一个损耗设备，当使用一段时间后可能会出现坏道等物理故障。电脑硬盘出现坏道后，如果不及时更换或进行技术处理，坏道就会越来越多，并会造成频繁 死机和数据丢失。最好的处理方式是更换磁盘，但在临时的情况下，应及时屏蔽坏道部分的扇区，不要触动它们。badblocks就是一个检查坏道位置的工 具。</div><div>一、命令参数</div><div>badblocks使用格式为：</div><div>引用</div><div>badblocks &nbsp;[ &nbsp;-svwnf &nbsp;] &nbsp;[ &nbsp;-b block-size ] [ -c blocks_at_once ] [ -i</div><div>&nbsp; &nbsp; &nbsp; input_file ] [ -o output_file ] [ -p num_passes ] [ -t test_pattern &nbsp;]</div><div>&nbsp; &nbsp; &nbsp; device [ last-block ] [ start-block ]</div><div><br></div><div>参数含义是：</div><div>引用</div><div>-b blocksize&nbsp;</div><div>&nbsp;指定磁盘的区块大小，单位为字节，默认值为“block 4K ”(4K/block)</div><div>-c blocksize&nbsp;</div><div>&nbsp;每个区块检查的次数，默认是16次</div><div>-f</div><div>&nbsp;强制在一个已经挂载的设备上执行读写或非破坏性的写测试操作</div><div>&nbsp;（我们建议先umount设备，然后再进行坏道检测。仅当/etc/mtab出现误报设备挂载错误的时候可以使用该选项）</div><div>-i file</div><div>&nbsp;跳过已经显示在file文件中的坏道，而不进行检测（可以避免重复检测）</div><div>-o file&nbsp;</div><div>&nbsp;把检测结果输出到file文件</div><div>-p number</div><div>&nbsp;重复搜寻设备，直到在指定通过次数内都没有找到新的坏块位置，默认次数为0&nbsp;</div><div>-s</div><div>&nbsp;在检查时显示进度</div><div>-t pattern&nbsp;</div><div>&nbsp;通过按指定的模式读写来检测区块。你可以指定一个0到ULONG_MAX-1的十进制正值，或使用random（随机）。</div><div>&nbsp;如果你指定多个模式，badblocks将使用第一个模式检测所有的区块，然后再使用下一个模式检测所有的区块。</div><div>&nbsp;Read-only方式仅接受一个模式，它不能接受random模式的。</div><div>-v</div><div>&nbsp;执行时显示详细的信息</div><div>-w</div><div>&nbsp;对每个区块都先写入，然后再从它读取信息</div><div>[device]</div><div>&nbsp;指定要检查的磁盘装置。</div><div>[last-block]</div><div>&nbsp;指定磁盘装置的区块总数。</div><div>[start-block]</div><div>&nbsp;指定要从哪个区块开始检查</div><div><br></div><div>二、示例</div><div>badblocks以4096的一个block，每一个block检查16次，将结果输出到“hda-badblocks-list”文件里</div><div><br></div><div># badblocks -b 4096 -c 16 /dev/hda1 -o hda-badblocks-list</div><div><br></div><div>hda-badblocks-list”是个文本文件，内容如下：</div><div>引用</div><div># cat hda-badblocks-list&nbsp;</div><div>51249&nbsp;</div><div>51250&nbsp;</div><div>51251&nbsp;</div><div>51253&nbsp;</div><div>51254&nbsp;</div><div>……</div><div>61245&nbsp;</div><div>……</div><div><br></div><div>可以针对可疑的区块多做几次操作。下面，badblocks以4096字节为一个“block”,每一个“block”检查1次, 将结果输出到“hda-badblocks-list.1”文件中，由第51000 block开始，到63000 block结束</div><div><br></div><div># badblocks -b 4096 -c 1 /dev/hda1 -o hda-badblocks-list.1 63000 51000</div><div><br></div><div>这 次花费的时间比较短，硬盘在指定的情况下在很短的时间就产生“嘎嘎嘎嘎”的响声。由于检查条件的不同，其输出的结果也不完全是相同的。重复几次同样的操 作，因条件多少都有些不同，所以结果也有所不同。进行多次操作后，直到产生最后的hda-badblock-list.final文件。</div><div><br></div><div>三、其他</div><div>1、fsck使用badblocks的信息</div><div>badblocks只会在日志文件中标记出坏道的信息，但若希望在检测磁盘时也能跳过这些坏块不检测，可以使用fsck的-l参数：</div><div># fsck.ext3 -l /tmp/hda-badblock-list.final /dev/hda1</div><div><br></div><div>2、在创建文件系统前检测坏道</div><div>badblocks可以随e2fsck和mke2fs的-c删除一起运行（对ext3文件系统也一样），在创建文件系统前就先检测坏道信息：</div><div><br></div><div># mkfs.ext3 -c /dev/hda1</div><div><br></div><div>代码表示使用-c在创建文件系统前检查坏道的硬盘。</div><div>这 个操作已经很清楚地告知我们可以采用“mkfs.ext3 -c”选项用“read-only”方式检查硬盘。这个命令会在格式化硬盘时检查硬盘，并标出错误的硬盘“block”。用这个方法格式化硬盘，需要有相 当大的耐心，因为命令运行后，会一个个用读的方式检查硬盘。</div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="device-mapper: multipath: Failing path recovery - 德哥@Digoal - PostgreSQL"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>