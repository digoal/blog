<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">docker sshd image problem, session    required     pam_loginuid.so, cann't login</h2>
	<h5 id="">2014-12-16 20:44:15&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/163877040201411165323773/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>在使用sshd docker 镜像时, 发现一个比较诡异的问题, 有些启动的容器可以连接, 有些不能.</div><div>例如 :&nbsp;</div><div>启动2个容器(这两个容器都有问题) :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# docker run -d --name di digoal/sshd_ceph:giant</font></div><div><span style="line-height: 28px;"   ><font size="2"   >[root@localhost ~]# docker run -d --name da digoal/sshd</font></span></div><p></p></pre></div><div><span style="line-height: 28px;"   >这两个容器的CMD如下 :&nbsp;</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >[root@localhost ~]# docker inspect -f '{{.Config.Cmd}}' da</font></div><div style="line-height: 28px;"   ><font size="2"   >[/usr/sbin/sshd -D]</font></div><div style="line-height: 28px;"   ><font size="2"   >[root@localhost ~]# docker inspect -f '{{.Config.Cmd}}' di</font></div><div style="line-height: 28px;"   ><font size="2"   >[/usr/sbin/sshd -D]</font></div><p></p></pre></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >查看他们的IP</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# docker inspect -f '{{.NetworkSettings.IPAddress}}' di</font></div><div><font size="2"   >172.17.0.7</font></div><div><font size="2"   >[root@localhost ~]# docker inspect -f '{{.NetworkSettings.IPAddress}}' da</font></div><div><font size="2"   >172.17.0.8</font></div><p></p></pre></div><div><br></div><div>使用ssh客户端连接, 被拒绝.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# ssh 172.17.0.8</font></div><div><font size="2"   >root@172.17.0.8's password:&nbsp;</font></div><div><font size="2"   >Last login: Tue Dec 16 20:22:12 2014 from 172.17.42.1</font></div><div><font size="2"   >Connection to 172.17.0.8 closed.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >[root@localhost ~]# ssh 172.17.0.7</font></div><div><font size="2"   >root@172.17.0.7's password:&nbsp;</font></div><div><font size="2"   >Last login: Tue Dec 16 20:21:58 2014 from 172.17.42.1</font></div><div><font size="2"   >Connection to 172.17.0.7 closed.</font></div><p></p></pre></div><div><br></div><div>排错, 先删除这两个容器 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# docker stop di</font></div><div><font size="2"   >di</font></div><div><font size="2"   >[root@localhost ~]# docker stop da</font></div><div><font size="2"   >da</font></div><div><font size="2"   >[root@localhost ~]# docker rm da</font></div><div><font size="2"   >da</font></div><div><font size="2"   >[root@localhost ~]# docker rm di</font></div><div><font size="2"   >di</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >排错时, 使用交互模式打开容器, 使用/bin/bash覆盖/usr/sbin/sshd -D. 并将sshd日志输出到挂载在宿主机的/tmp目录.</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost ~]# docker run --rm -t -i --name=da --volume=/tmp:/data01 digoal/sshd_ceph:giant /bin/bash</font></div><div><font size="2"   >[root@f563c0940d2b /]# /usr/sbin/sshd -D -E /data01/sshd.log</font></div><p></p></pre></div><div>查看容器IP</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost tmp]# docker inspect -f '{{.NetworkSettings.IPAddress}}' da</font></div><div><font size="2"   >172.17.0.11</font></div><p></p></pre></div><div>使用SSH客户端连接这个容器, 同样被退出.</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost tmp]# ssh 172.17.0.11</font></div><div><font size="2"   >The authenticity of host '172.17.0.11 (172.17.0.11)' can't be established.</font></div><div><font size="2"   >ECDSA key fingerprint is db:5c:6b:2a:bc:9e:3e:31:24:1b:c0:8d:5f:96:f2:e0.</font></div><div><font size="2"   >Are you sure you want to continue connecting (yes/no)? yes</font></div><div><font size="2"   >Warning: Permanently added '172.17.0.11' (ECDSA) to the list of known hosts.</font></div><div><font size="2"   >root@172.17.0.11's password:&nbsp;</font></div><div><font size="2"   >Last login: Tue Dec &nbsp;9 15:20:36 2014 from 172.17.42.1</font></div><div><font size="2"   >Connection to 172.17.0.11 closed.</font></div><p></p></pre></div></div><div><br></div><div>查看容器的sshd日志如下,&nbsp;<span style="line-height: 28px;"   >原因找到了.</span><span style="line-height: 28px;"   >&nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@localhost tmp]# cat /tmp/sshd.log&nbsp;</font></div><div><font size="2"   >Server listening on 0.0.0.0 port 22.</font></div><div><font size="2"   >Server listening on :: port 22.</font></div><div><font size="2"   >Accepted password for root from 172.17.42.1 port 41153 ssh2</font></div><div><font size="2"   >PAM: pam_open_session(): Cannot make/remove an entry for the specified session</font></div><div><font size="2"   >Received disconnect from 172.17.42.1: 11: disconnected by user</font></div><p></p></pre></div><div><br></div><div><span style="line-height: 28px;"   >解决办法1, 修改</span><span style="line-height: 28px;"   >/etc/pam.d/sshd&nbsp;</span><span style="line-height: 28px;"   >&nbsp;:&nbsp;</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@f563c0940d2b /]# /usr/sbin/sshd -D -E /data01/sshd.log</font></div><div><font size="2"   >^C</font></div><div><font size="2"   >    注释如下</font></div><div><font size="2"   >[root@f563c0940d2b /]# vi /etc/pam.d/sshd&nbsp;</font></div></div><div><font size="2"   >#session &nbsp; &nbsp;required &nbsp; &nbsp; pam_loginuid.so</font></div><div><font size="2"   >    现在可以连接了</font></div><div><div><font size="2"   >[root@localhost tmp]# ssh 172.17.0.11</font></div><div><font size="2"   >root@172.17.0.11's password:&nbsp;</font></div><div><font size="2"   >Last login: Tue Dec 16 20:28:15 2014 from 172.17.42.1</font></div><div><font size="2"   >[root@f563c0940d2b ~]#&nbsp;</font></div></div><p></p></pre></div><div><br></div><div>解决办法2, 使用超级权限启动容器 :&nbsp;</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >[root@f563c0940d2b /]# exit</font></div><div><font size="2"   >exit</font></div><div><font size="2"   >[root@localhost ~]# docker run --rm -t -i --name=da --privileged=true --volume=/tmp:/data01 digoal/sshd_ceph:giant /bin/bash</font></div><div><font size="2"   >[root@44e686983f3a /]# /usr/sbin/sshd -D -E /data01/sshd.log</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@localhost tmp]# docker inspect -f '{{.NetworkSettings.IPAddress}}' da</font></div><div><font size="2"   >172.17.0.13</font></div></div><div><font size="2"   >    正常连接 :&nbsp;</font></div><div><div><font size="2"   >[root@localhost tmp]# ssh 172.17.0.13</font></div><div><font size="2"   >The authenticity of host '172.17.0.13 (172.17.0.13)' can't be established.</font></div><div><font size="2"   >ECDSA key fingerprint is db:5c:6b:2a:bc:9e:3e:31:24:1b:c0:8d:5f:96:f2:e0.</font></div><div><font size="2"   >Are you sure you want to continue connecting (yes/no)? yes</font></div><div><font size="2"   >Warning: Permanently added '172.17.0.13' (ECDSA) to the list of known hosts.</font></div><div><font size="2"   >root@172.17.0.13's password:&nbsp;</font></div><div><font size="2"   >Last login: Tue Dec &nbsp;9 15:20:36 2014 from 172.17.42.1</font></div><div><font size="2"   >[root@44e686983f3a ~]#&nbsp;</font></div></div><div><div><font size="2"   >[root@44e686983f3a ~]# cat /etc/pam.d/sshd |grep pam_loginuid</font></div><div><font size="2"   >session &nbsp; &nbsp;required &nbsp; &nbsp; pam_loginuid.so</font></div></div><p></p></pre></div><div><br></div><div>最后, 建议在创建sshd镜像时, 就将<span style="line-height: 28px;"   >session &nbsp; &nbsp;required &nbsp; &nbsp; pam_loginuid.so注释掉.&nbsp;</span></div><div><span style="line-height: 28px;"   >那么以后使用这个镜像启动容器, 就不会出现文章开头的问题了.</span></div><div><br></div>[参考]<wbr><div>1. man docker-run</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;--privileged=true|false Give extended privileges to this container. &nbsp;By default, &nbsp;Docker &nbsp;containers &nbsp;are &nbsp;“unprivileged”</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;(=false) &nbsp;and &nbsp;cannot, &nbsp;for &nbsp;example, run a Docker daemon inside the Docker container. &nbsp;This is because by default a con\</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;tainer is not allowed to access any devices. &nbsp;A “privileged” container is given access to all devices.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;When the operator executes docker run --privileged, Docker will enable access to all devices on the host as well &nbsp;as &nbsp;set</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;some configuration in AppArmor to allow the container nearly all the same access to the host as processes running outside</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp;of a container on the host.</font></div><p></p></pre></div>
<div>2. man sshd_config</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   ># Set this to 'yes' to enable PAM authentication, account processing,</font></div><div><font size="2"   ># and session processing. If this is enabled, PAM authentication will</font></div><div><font size="2"   ># be allowed through the ChallengeResponseAuthentication and</font></div><div><font size="2"   ># PasswordAuthentication. &nbsp;Depending on your PAM configuration,</font></div><div><font size="2"   ># PAM authentication via ChallengeResponseAuthentication may bypass</font></div><div><font size="2"   ># the setting of "PermitRootLogin without-password".</font></div><div><font size="2"   ># If you just want the PAM account and session checks to run without</font></div><div><font size="2"   ># PAM authentication, then enable this but set PasswordAuthentication</font></div><div><font size="2"   ># and ChallengeResponseAuthentication to 'no'.</font></div><div><font size="2"   ># WARNING: 'UsePAM no' is not supported in Red Hat Enterprise Linux and may cause several</font></div><div><font size="2"   ># problems.</font></div><div><font size="2"   >#UsePAM no</font></div><div><font size="2"   >UsePAM yes</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >&nbsp; &nbsp; &nbsp;UsePAM &nbsp;Enables the Pluggable Authentication Module interface. &nbsp;If set to “yes” this will enable PAM authentication using</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ChallengeResponseAuthentication and PasswordAuthentication in addition to PAM account and session module processing</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for all authentication types.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Because PAM challenge-response authentication usually serves an equivalent role to password authentication, you</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;should disable either PasswordAuthentication or ChallengeResponseAuthentication.</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;If UsePAM is enabled, you will not be able to run sshd(8) as a non-root user. &nbsp;The default is “no”.</font></div></div><p></p></pre></div><a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="docker sshd image problem, session    required     pam_loginuid.so, cannt login - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>