<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">use logrotate manage log file</h2>
	<h5 id="">2015-01-02 17:22:11&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020150245911589/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>logrotate一般用于管理日志文件, 例如 :&nbsp;</div><div><div>[root@db-192-168-173-42 tmp]# ll /var/log/messages*</div><div>-rw------- 1 root root 599922 Jan &nbsp;2 16:06 /var/log/messages</div><div>-rw------- 1 root root &nbsp; &nbsp;138 Dec 27 19:20 /var/log/messages.1</div><div>-rw------- 1 root root &nbsp; &nbsp; 58 Dec 14 04:02 /var/log/messages.2</div><div>-rw------- 1 root root &nbsp; &nbsp; 58 Dec &nbsp;7 04:02 /var/log/messages.3</div><div>-rw------- 1 root root &nbsp; &nbsp;138 Dec &nbsp;3 01:09 /var/log/messages.4</div></div><div>例如 :&nbsp;</div><div>对需要管理的日志文件&nbsp;<span style="line-height: 28px;"   >/tmp/sky_pg_clusterd.log </span><span style="line-height: 28px;"   >, 创建一个配置文件.</span></div><div>vi&nbsp;/etc/logrotate.d/sky_pg_cluster</div><div><div>/tmp/sky_pg_clusterd.log &nbsp;&nbsp;</div><div>{ &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;size 10M &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;create &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;start 10 &nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rotate 4 &nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;compress &nbsp;&nbsp;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;copytruncate &nbsp;&nbsp;</div><div>}</div></div><div><span style="line-height: 28px;"   >根据以上配置, 如果文件超过10M, 将压缩存放, 并截断.</span></div><div><div style="line-height: 28px;"   ># logrotate /etc/logrotate.d/sky_pg_cluster&nbsp;</div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ># ll</span></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >total 1756</span></div></div><div><div>-rw-rw-r-- 1 postgres postgres &nbsp;4755 Jan &nbsp;2 17:10 sky_pg_clusterd.log</div><div>-rw-rw-r-- 1 postgres postgres 1082000 Jan &nbsp;2 16:24 sky_pg_clusterd.log.10.gz</div></div><div>再次调用, 因为文件还小于10M, 所以不进行处理.</div><div><div style="line-height: 28px;"   ># logrotate /etc/logrotate.d/sky_pg_cluster&nbsp;</div><div style="line-height: 28px;"   >[root@db-192-168-173-42 tmp]# ll</div><div style="line-height: 28px;"   >total 1772</div><div style="line-height: 28px;"   >-rw-rw-r-- 1 postgres postgres &nbsp;708613 Jan &nbsp;2 17:10 sky_pg_clusterd.log</div><div style="line-height: 28px;"   >-rw-rw-r-- 1 postgres postgres 1082000 Jan &nbsp;2 16:24 sky_pg_clusterd.log.10.gz</div></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >一般可以搞成crontab自动处理.</div><div>*/5 * * * *&nbsp;/usr/sbin/logrotate&nbsp;<span style="line-height: 28px;"   >/etc/logrotate.d/sky_pg_cluster</span></div><div><br></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><br></span></div>[参考]<wbr><div>1. man logrotate</div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.linuxidc.com/Linux/2012-02/53940.htm"   >http://www.linuxidc.com/Linux/2012-02/53940.htm</a></div><div><div style="line-height: 28px;"   >Syslog-ng服务只提供对log进行接收以及再处理（继续分发或者存储），但并不对产生的log文件进行管理，这样导致的后果就是可能这个文件越来越大，在我们这个项目中，由于忘了对日志文件进行管理，结果导致这个日志文件20多G，澹很有可能导致系统崩溃。</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >日志文件管理这项工作其实是由logrotate模块来负责。</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >对于logrotate可以参考官网， 上面有详尽的介绍，最常用的三个方式为：&nbsp;</div><div style="line-height: 28px;"   >logrotate /etc/logrotate.conf：重新读取配置文件，并对符合条件的文件文件进行rotate。&nbsp;</div><div style="line-height: 28px;"   >logrotate -d /etc/logrotate.conf：调试模式，输出调试结果，但并不执行。&nbsp;</div><div style="line-height: 28px;"   >logrotate -f /etc/logrotate.conf：强制模式，对所有相关文件进行rotate。</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >至于logrotate对文件进行管理时的所要执行的规则，可以在/etc/logrotate.d文件夹下创建文件，logrotate会在执行的时候自动读取相应的规则，比如，我在/etc/logrotate.d/路径下新建了一个名为syslog的文件，www.linuxidc.com其中的内容为：</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >/log/test.log &nbsp;&nbsp;</div><div style="line-height: 28px;"   >{ &nbsp;&nbsp;</div><div style="line-height: 28px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;size 10M &nbsp;&nbsp;</div><div style="line-height: 28px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;create &nbsp;&nbsp;</div><div style="line-height: 28px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;start 10 &nbsp;</div><div style="line-height: 28px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;rotate 4 &nbsp;</div><div style="line-height: 28px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;compress &nbsp;&nbsp;</div><div style="line-height: 28px;"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;copytruncate &nbsp;&nbsp;</div><div style="line-height: 28px;"   >} &nbsp;</div><div style="line-height: 28px;"   >上面代码的意思为当文件/log/test.log的大小超过10M时就开始循环，允许logrotate创建文件，循环文件的开始为10，即文件为为test.log.10.gz，最多循环创建4个文件，即为test.log.13.gz，多于四个后开始在第一个上面循环，依次迭代。</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >这样在配置logrotate的规则的时候就相对非常灵活，当我需求改动，需要添加其他新的规则的时候，我就不必修改syslog文件中的规则，可以新创建一个文件，添加相应的规则即可。这种灵活的配置方式对编程来说是一大便利，对于编程来说就是更容易实现对规则的自动控制了。</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >另外的一个问题，logrotate规则配置好后怎么定时去执行呢？这个就可以交给Linux中的crontab来控制了，具体的crontab的配置可以参考官网，我这里给出我使用的demo:</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >执行：vi /etc/crontab</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >配置如下：</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >*/5 * * * * root /sbin/logrotate /etc/logrotate.conf &nbsp;</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >表示每隔5分钟执行检查一次。</div><div style="line-height: 28px;"   ><br style="line-height: 28px;"   ></div><div style="line-height: 28px;"   >这样整个配置就基本上完成了。</div></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="use logrotate manage log file - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>