<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=gbk">
<title>PostgreSQL research</title>
<style type="text/css">
.blogcnt{line-height:160%;font-size:14px;text-align:left;word-wrap:break-word;}
.blogcnt *{line-height:160%;}
.blogcnt p{margin:0 0 10px;}
.blogcnt ul,.nbw-blog ol{margin:5px 0 5px 40px;padding:0}
.blogcnt em{font-style:italic;}
.blogcnt blockquote{font-size:1em;margin:auto 0 auto 35px;}
.blogcnt img{border:0;max-width:100%;}
</style>
</head>
<body style="color:#444444;">
<h1 id="blog-Title"><a href="index.html">PostgreSQL research</a></h1>
<div id="" style="padding:0 20px;">
	<h2 id="">Customize Dictionary or Filter dictionary by Synonym & Thesaurus, customize zhparser's xdb</h2>
	<h5 id="">2015-05-03 15:19:10&nbsp;&nbsp;&nbsp;<a href="http://blog.163.com/digoal@126/blog/static/16387704020153309577689/" target="_blank">查看原文&gt;&gt;</a></h5>
	<div class="" id="" style="padding:0 20px;">
		<div class="blogcnt" style="width:800px;"><div>以前写过一些关于PostgreSQL 中文分词的用法文章，参考</div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201422410175698/"   >http://blog.163.com/digoal@126/blog/static/163877040201422410175698/</a></div><div>本文主要补充一些内容：</div><div>1. PostgreSQL文本检索的原理</div><div>2. 如何调试parser</div><div><span style="line-height: 28px;"   >3. 如何实现词组替换</span></div><div>4. 如何添加或修改解析过程用的中文词组</div><wbr><div><br></div><div><div style="line-height: 28px;"   >1. PostgreSQL文本检索的大致原理：</div><div style="line-height: 28px;"   >首先parser负责对文本进行拆分和归类（生成lexeme）；对于英语系的拆分比较简单，因为单词间有空格隔开，PostgreSQL默认的parser仅仅支持英文体系的解析。对中文来说需要自定义parser，例如zhparser是一个例子。</div><div style="line-height: 28px;"   >然后PG将解析好的lexeme根据字典进行匹配，用户可用配置多个字典，例如匿名字典，一般字典。</div><div style="line-height: 28px;"   >匿名字典可用于替换，例如将某些词义相同的词替换为某一个词。</div><div style="line-height: 28px;"   >一般字典用于匹配，匹配到的lexeme是有效词，没有匹配到的lexeme丢弃。</div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >PG默认支持的parser如下：</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from pg_ts_parser ;</font></div><div><font size="2"   >&nbsp;prsname | prsnamespace | &nbsp;prsstart &nbsp;| &nbsp; &nbsp;prstoken &nbsp; &nbsp;| &nbsp;prsend &nbsp;| &nbsp;prsheadline &nbsp;| &nbsp;prslextype &nbsp;</font></div><div><font size="2"   >---------+--------------+------------+----------------+----------+---------------+--------------</font></div><div><font size="2"   >&nbsp;default | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 | prsd_start | prsd_nexttoken | prsd_end | prsd_headline | prsd_lextype</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>解析后的lexeme分为几类：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from pg_catalog.ts_token_type('default');</font></div><div><font size="2"   >&nbsp;tokid | &nbsp; &nbsp; &nbsp;alias &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+-----------------+------------------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;1 | asciiword &nbsp; &nbsp; &nbsp; | Word, all ASCII</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;2 | word &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Word, all letters</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;3 | numword &nbsp; &nbsp; &nbsp; &nbsp; | Word, letters and digits</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;4 | email &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Email address</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;5 | url &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | URL</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;6 | host &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Host</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;7 | sfloat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Scientific notation</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;8 | version &nbsp; &nbsp; &nbsp; &nbsp; | Version number</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp;9 | hword_numpart &nbsp; | Hyphenated word part, letters and digits</font></div><div><font size="2"   >&nbsp; &nbsp; 10 | hword_part &nbsp; &nbsp; &nbsp;| Hyphenated word part, all letters</font></div><div><font size="2"   >&nbsp; &nbsp; 11 | hword_asciipart | Hyphenated word part, all ASCII</font></div><div><font size="2"   >&nbsp; &nbsp; 12 | blank &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Space symbols</font></div><div><font size="2"   >&nbsp; &nbsp; 13 | tag &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | XML tag</font></div><div><font size="2"   >&nbsp; &nbsp; 14 | protocol &nbsp; &nbsp; &nbsp; &nbsp;| Protocol head</font></div><div><font size="2"   >&nbsp; &nbsp; 15 | numhword &nbsp; &nbsp; &nbsp; &nbsp;| Hyphenated word, letters and digits</font></div><div><font size="2"   >&nbsp; &nbsp; 16 | asciihword &nbsp; &nbsp; &nbsp;| Hyphenated word, all ASCII</font></div><div><font size="2"   >&nbsp; &nbsp; 17 | hword &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Hyphenated word, all letters</font></div><div><font size="2"   >&nbsp; &nbsp; 18 | url_path &nbsp; &nbsp; &nbsp; &nbsp;| URL path</font></div><div><font size="2"   >&nbsp; &nbsp; 19 | file &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| File or path name</font></div><div><font size="2"   >&nbsp; &nbsp; 20 | float &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Decimal notation</font></div><div><font size="2"   >&nbsp; &nbsp; 21 | int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | Signed integer</font></div><div><font size="2"   >&nbsp; &nbsp; 22 | uint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| Unsigned integer</font></div><div><font size="2"   >&nbsp; &nbsp; 23 | entity &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| XML entity</font></div><div><font size="2"   >(23 rows)</font></div><p></p></pre></div></div><div>我们可以为每一种类型创建不同的字典来对付。</div><div>PG怎么管理lexeme类型和字典的映射关系呢？用ts config。</div><div>语法：</div><div>创建TS CONFIG</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >Command: &nbsp; &nbsp; CREATE TEXT SEARCH CONFIGURATION</font></div><div><font size="2"   >Description: define a new text search configuration</font></div><div><font size="2"   >Syntax:</font></div><div><font size="2"   >CREATE TEXT SEARCH CONFIGURATION name (</font></div><div><font size="2"   >&nbsp; &nbsp; PARSER = parser_name |</font></div><div><font size="2"   >&nbsp; &nbsp; COPY = source_config</font></div><div><font size="2"   >)</font></div><p></p></pre></div><div>配置lexeme类型和字典的关系。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >ALTER TEXT SEARCH CONFIGURATION name</font></div><div><font size="2"   >&nbsp; &nbsp; ADD MAPPING FOR token_type [, ... ] WITH dictionary_name [, ... ]</font></div><div><font size="2"   >ALTER TEXT SEARCH CONFIGURATION name</font></div><div><font size="2"   >&nbsp; &nbsp; ALTER MAPPING FOR token_type [, ... ] WITH dictionary_name [, ... ]</font></div><p></p></pre></div><div style="line-height: 28px;"   ><br></div><div style="line-height: 28px;"   >2. 如何调试parser，如何修改全文检索的配置</div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >ts_debug([ config regconfig, ] document text,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT alias text,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT description text,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT token text,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT dictionaries regdictionary[],</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT dictionary regdictionary,</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;OUT lexemes text[])</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;returns setof record</font></div><p></p></pre></div><div style="line-height: 28px;"   >ts_debug函数用于调试parser, 例如：</div><div style="line-height: 28px;"   >我准备使用english这个配置，这个配置中包含的lexeme类型和字典的对应关系如下：</div><div style="line-height: 28px;"   ><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >digoal=&gt; \dF+ english</font></div><div style="line-height: 28px;"   ><font size="2"   >Text search configuration "pg_catalog.english"</font></div><div style="line-height: 28px;"   ><font size="2"   >Parser: "pg_catalog.default"</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp; &nbsp; Token &nbsp; &nbsp; &nbsp;| Dictionaries&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-----------------+--------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;asciihword &nbsp; &nbsp; &nbsp;| english_stem</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;asciiword &nbsp; &nbsp; &nbsp; | english_stem</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;email &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;file &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;float &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;host &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;hword &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | english_stem</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;hword_asciipart | english_stem</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;hword_numpart &nbsp; | simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;hword_part &nbsp; &nbsp; &nbsp;| english_stem</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;int &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;numhword &nbsp; &nbsp; &nbsp; &nbsp;| simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;numword &nbsp; &nbsp; &nbsp; &nbsp; | simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;sfloat &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;uint &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;url &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;url_path &nbsp; &nbsp; &nbsp; &nbsp;| simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;version &nbsp; &nbsp; &nbsp; &nbsp; | simple</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;word &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| english_stem</font></div><p></p></pre></div><div style="line-height: 28px;"   >调试一下：</div></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   >digoal=&gt; select * from ts_debug('english','hello digoal, http://blog.163.com/digoal@126/');</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp; &nbsp;alias &nbsp; | &nbsp; description &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;token &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;dictionaries &nbsp;| &nbsp;dictionary &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lexemes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >-----------+-----------------+--------------------------+----------------+--------------+----------------------------</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;asciiword | Word, all ASCII | hello &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {english_stem} | english_stem | {hello}</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;blank &nbsp; &nbsp; | Space symbols &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;asciiword | Word, all ASCII | digoal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | {english_stem} | english_stem | {digoal}</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;blank &nbsp; &nbsp; | Space symbols &nbsp; | , &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;protocol &nbsp;| Protocol head &nbsp; | http:// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;url &nbsp; &nbsp; &nbsp; | URL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | blog.163.com/digoal@126/ | {simple} &nbsp; &nbsp; &nbsp; | simple &nbsp; &nbsp; &nbsp; | {blog.163.com/digoal@126/}</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;host &nbsp; &nbsp; &nbsp;| Host &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| blog.163.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | {simple} &nbsp; &nbsp; &nbsp; | simple &nbsp; &nbsp; &nbsp; | {blog.163.com}</font></div><div style="line-height: 28px;"   ><font size="2"   >&nbsp;url_path &nbsp;| URL path &nbsp; &nbsp; &nbsp; &nbsp;| /digoal@126/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | {simple} &nbsp; &nbsp; &nbsp; | simple &nbsp; &nbsp; &nbsp; | {/digoal@126/}</font></div><div style="line-height: 28px;"   ><font size="2"   >(8 rows)</font></div><p></p></pre></div><div style="line-height: 28px;"   >parser将这个文本解析为8个lexeme，dictionary 字段表示匹配到的字典是哪个，可以看到每个lexeme类型用什么字典来处理的呢？</div><div style="line-height: 28px;"   >例如：</div><div style="line-height: 28px;"   >asciiword类型 (hello,digoal)用到了english_stem字典，和TS CONFIG配置一致。</div><div style="line-height: 28px;"   >protocol类型在english这个TS CONFIG中没有指定对应的字典，所以没有匹配。</div><div>url_path类型使用simple字典进行匹配。</div><div>最后我们看看得到的tsvector是什么？</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from to_tsvector('english','hello digoal, http://blog.163.com/digoal@126/');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to_tsvector &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;'/digoal@126/':5&nbsp;</font></div><div><font size="2"   >'blog.163.com':4&nbsp;</font></div><div><font size="2"   >'blog.163.com/digoal@126/':3&nbsp;</font></div><div><font size="2"   >'digoal':2&nbsp;</font></div><div><font size="2"   >'hello':1</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div>显然，和调试结果一样，有5个lexeme有字典匹配，没有匹配到的就丢弃了。</div><div>现在我可以给english这个配置加一下protocol的字典，这样就可以输出对应的词组了。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; \c digoal postgres</font></div><div><font size="2"   >You are now connected to database "digoal" as user "postgres".</font></div><div><font size="2"   >digoal=# alter text search configuration english add mapping for protocol with simple;</font></div><div><font size="2"   >ALTER TEXT SEARCH CONFIGURATION</font></div><div><font size="2"   >digoal=# select * from to_tsvector('english','hello digoal, http://blog.163.com/digoal@126/');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to_tsvector &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-------------------------------------------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;'/digoal@126/':6&nbsp;</font></div><div><font size="2"   >  'blog.163.com':5&nbsp;</font></div><div><font size="2"   >  'blog.163.com/digoal@126/':4&nbsp;</font></div><div><font size="2"   >  'digoal':2&nbsp;</font></div><div><font size="2"   >  'hello':1&nbsp;</font></div><div><font size="2"   >  'http://':3</font></div><div><font size="2"   >(1 row)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from ts_debug('english','hello digoal, http://blog.163.com/digoal@126/');</font></div><div><font size="2"   >&nbsp; &nbsp;alias &nbsp; | &nbsp; description &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;token &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp;dictionaries &nbsp;| &nbsp;dictionary &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;lexemes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >-----------+-----------------+--------------------------+----------------+--------------+----------------------------</font></div><div><font size="2"   >&nbsp;asciiword | Word, all ASCII | hello &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {english_stem} | english_stem | {hello}</font></div><div><font size="2"   >&nbsp;blank &nbsp; &nbsp; | Space symbols &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;asciiword | Word, all ASCII | digoal &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | {english_stem} | english_stem | {digoal}</font></div><div><font size="2"   >&nbsp;blank &nbsp; &nbsp; | Space symbols &nbsp; | , &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;protocol &nbsp;| Protocol head &nbsp; | http:// &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| {simple} &nbsp; &nbsp; &nbsp; | simple &nbsp; &nbsp; &nbsp; | {http://}</font></div><div><font size="2"   >&nbsp;url &nbsp; &nbsp; &nbsp; | URL &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | blog.163.com/digoal@126/ | {simple} &nbsp; &nbsp; &nbsp; | simple &nbsp; &nbsp; &nbsp; | {blog.163.com/digoal@126/}</font></div><div><font size="2"   >&nbsp;host &nbsp; &nbsp; &nbsp;| Host &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;| blog.163.com &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | {simple} &nbsp; &nbsp; &nbsp; | simple &nbsp; &nbsp; &nbsp; | {blog.163.com}</font></div><div><font size="2"   >&nbsp;url_path &nbsp;| URL path &nbsp; &nbsp; &nbsp; &nbsp;| /digoal@126/ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | {simple} &nbsp; &nbsp; &nbsp; | simple &nbsp; &nbsp; &nbsp; | {/digoal@126/}</font></div><div><font size="2"   >(8 rows)</font></div><p></p></pre></div><div><br></div></div></div><wbr style="line-height: 28px;"   ><div style="line-height: 28px;"   >3. 如何实现词组替换</div></div><div style="line-height: 28px;"   >我们前面已经讲了，一个lexeme类型可以有多个字典来对付。</div><div style="line-height: 28px;"   >按照字典的先后顺序进行匹配，对于一般字典，匹配到了就直接返回匹配成功，如果没有匹配到，才会将这个lexeme交给下一个字典进行匹配。</div><div style="line-height: 28px;"   >但是还有两种字典，它们匹配到后不返回，而是替换为另一个词，然后将替换后的词交给下面的字典进行匹配。</div><div style="line-height: 28px;"   >这样有利于对多义词进行筛选合并，例如有10个词含义是一样的，那么我们可以替换为1个词来表示，减少最终分词的数量。</div><div style="line-height: 28px;"   >例如将刘德华，黎明，郭富城，张学友替换为四大天王。将德哥，周正中替换为digoal。</div><div style="line-height: 28px;"   >这两种字典是synonym dictionary,&nbsp;Thesaurus dictionary。它们的配置文件在PG_HOME/share/tsearch_data目录下面，后缀名分为syn和ths，例如：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-rw-r--r-- 1 root root &nbsp; 73 May &nbsp;1 18:01 synonym_sample.syn</font></div><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;473 May &nbsp;1 18:01 thesaurus_sample.ths</font></div><p></p></pre></div><div>下面我们来试用一下。</div><div>例如我还是用english这个配置，先调试一下看看，这几个中文词解析为word类型，试用了english_stem字典。</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=&gt; select * from ts_debug('english','郭富城 刘德华 张学友 黎明');</font></div><div><font size="2"   >&nbsp;alias | &nbsp; &nbsp;description &nbsp; &nbsp;| token &nbsp;| &nbsp;dictionaries &nbsp;| &nbsp;dictionary &nbsp;| lexemes &nbsp;</font></div><div><font size="2"   >-------+-------------------+--------+----------------+--------------+----------</font></div><div><font size="2"   >&nbsp;word &nbsp;| Word, all letters | 郭富城 | {english_stem} | english_stem | {郭富城}</font></div><div><font size="2"   >&nbsp;blank | Space symbols &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;word &nbsp;| Word, all letters | 刘德华 | {english_stem} | english_stem | {刘德华}</font></div><div><font size="2"   >&nbsp;blank | Space symbols &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;word &nbsp;| Word, all letters | 张学友 | {english_stem} | english_stem | {张学友}</font></div><div><font size="2"   >&nbsp;blank | Space symbols &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp;| {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;word &nbsp;| Word, all letters | 黎明 &nbsp; | {english_stem} | english_stem | {黎明}</font></div><div><font size="2"   >(7 rows)</font></div><p></p></pre></div><div>现在我创建一个syn文件，内容如下：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >postgres@db-192-168-173-33-&gt; cd /opt/pgsql/share/tsearch_data/</font></div><div><font size="2"   >postgres@db-192-168-173-33-&gt; vi digoal.syn</font></div></div><div><div><font size="2"   >刘德华 四大天王</font></div><div><font size="2"   >郭富城 四大天王</font></div><div><font size="2"   >张学友 四大天王</font></div><div><font size="2"   >黎明 四大天王</font></div><div><font size="2"   >德哥 digoal</font></div><div><font size="2"   >周正中 digoal</font></div></div><p></p></pre></div><div>然后要创建一个synonym字典，模板用synonym，匿名配置文件用digoal.syn：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# CREATE TEXT SEARCH DICTIONARY my_synonym (</font></div><div><font size="2"   >&nbsp; &nbsp; TEMPLATE = synonym,</font></div><div><font size="2"   >&nbsp; &nbsp; SYNONYMS = digoal</font></div><div><font size="2"   >);</font></div><p></p></pre></div><div>我们先不修改配置，看看分词结果：</div><div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from to_tsvector('english','刘德华 张学友 黎明 郭富城 德哥 周正中');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to_tsvector &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >---------------------------------------------------------------</font></div><div><font size="2"   >&nbsp;'刘德华':1 '周正中':6 '张学友':2 '德哥':5 '郭富城':4 '黎明':3</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >修改english的word类型的字典关系，将匿名字典放最前面。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# ALTER TEXT SEARCH CONFIGURATION english &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; ALTER MAPPING FOR word</font></div><div><font size="2"   >&nbsp; &nbsp; WITH my_synonym, english_stem;</font></div><div><font size="2"   >ALTER TEXT SEARCH CONFIGURATION</font></div><p></p></pre></div><div>现在分词结果变了，都替换成了我想要的结果：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from to_tsvector('english','刘德华 张学友 黎明 郭富城 德哥 周正中');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to_tsvector &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >---------------------------------</font></div><div><font size="2"   >&nbsp;'digoal':5,6 '四大天王':1,2,3,4</font></div><div><font size="2"   >(1 row)</font></div><p></p></pre></div></div><div>注意匿名字典一定要放前面，否则english_stem先匹配了，就不会有替换效果了。</div><div style="line-height: 28px;"   ><br></div><div>Thesaurus是synonym字典的扩展，支持的是多词和缩写的对应关系，并不是多对一的关系。</div><div>例如</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >$ vi digoal.ths</font></div><div><font size="2"   >刘德华 郭富城 黎明 张学友 : 四大天王</font></div><div><font size="2"   >德哥 周正中 : digoal</font></div></div><div><span style="line-height: 28px;"   ><font size="2"   >as soon as possible : ASAP</font></span></div><p></p></pre></div><div>这仅仅代表"<span style="line-height: 28px;"   >刘德华 郭富城 黎明 张学友"按照顺序出现时，匹配为四大天王。</span></div><div><span style="line-height: 28px;"   >这样不好理解，但是换个词可能更好理解，例如as soon as possible替换为首字母缩写ASAP。</span></div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# CREATE TEXT SEARCH DICTIONARY thesaurus_simple (</font></div><div><font size="2"   >&nbsp; &nbsp; TEMPLATE = thesaurus,</font></div><div><font size="2"   >&nbsp; &nbsp; DictFile = digoal,&nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; Dictionary = pg_catalog.english_stem);</font></div><div><font size="2"   >CREATE TEXT SEARCH DICTIONARY</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=# ALTER TEXT SEARCH CONFIGURATION english</font></div><div><font size="2"   >&nbsp; &nbsp; ALTER MAPPING FOR asciiword, word &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; &nbsp; WITH thesaurus_simple,english_stem;</font></div><div><font size="2"   >ALTER TEXT SEARCH CONFIGURATION</font></div></div><p></p></pre></div><div>测试：</div><div><pre class="prettyprint"   ><br></pre><pre class="prettyprint"   ><p></p><div><font size="2"   >digoal=# select * from ts_debug('english','as soon as possible');</font></div><div><font size="2"   >ERROR: &nbsp;thesaurus sample word "as" is a stop word (rule 3)</font></div><div><font size="2"   >HINT: &nbsp;Use "?" to represent a stop word within a sample phrase.</font></div><div><font size="2"   >CONTEXT: &nbsp;SQL function "ts_debug" statement 1</font></div><div><font size="2"   >digoal=# \q</font></div><div><font size="2"   >postgres@db-192-168-173-33-&gt; exit</font></div><div><font size="2"   >logout</font></div><div><font size="2"   >[root@db-192-168-173-33 tsearch_data]# vi digoal.ths&nbsp;</font></div><div><font size="2"   >刘德华 郭富城 黎明 张学友 : 四大天王</font></div><div><font size="2"   >德哥 周正中 : digoal</font></div><div><font size="2"   >? soon ? possible : ASAP</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select * from to_tsvector('english','as soon as possible');<br> to_tsvector <br>-------------<br> 'asap':1<br>(1 row)</font></div><div><font size="2"   >digoal=&gt; select * from ts_debug('english','as soon as possible');<br>   alias   |   description   |  token   |          dictionaries           |  dictionary  |  lexemes  <br>-----------+-----------------+----------+---------------------------------+--------------+-----------<br> asciiword | Word, all ASCII | as       | {thesaurus_simple,english_stem} | english_stem | {}<br> blank     | Space symbols   |          | {}                              |              | <br> asciiword | Word, all ASCII | soon     | {thesaurus_simple,english_stem} | english_stem | {soon}<br> blank     | Space symbols   |          | {}                              |              | <br> asciiword | Word, all ASCII | as       | {thesaurus_simple,english_stem} | english_stem | {}<br> blank     | Space symbols   |          | {}                              |              | <br> asciiword | Word, all ASCII | possible | {thesaurus_simple,english_stem} | english_stem | {possibl}<br>(7 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 21px;"   >一定要完全匹配才能替换</span></font></div><div><font size="2"   >digoal=# select * from to_tsvector('english','德哥 周正中');<br> to_tsvector <br>-------------<br> 'digoal':1<br>(1 row)<br><br>digoal=# select * from to_tsvector('english','郭富城 刘德华 张学友 黎明');<br>                to_tsvector                <br>-------------------------------------------<br> '刘德华':2 '张学友':3 '郭富城':1 '黎明':4<br>(1 row)<br><br>digoal=# select * from to_tsvector('english','刘德华 郭富城 黎明 张学友');<br> to_tsvector  <br>--------------<br> '四大天王':1<br>(1 row)</font></div><div><br></div><div><font size="2"   ><span style="line-height: 21px;"   >?替换的是stop word, 所以会这样, the,as都是stop word</span></font></div><div><font size="2"   >digoal=&gt; select * from to_tsvector('english','as soon the possible');<br> to_tsvector <br>-------------<br> 'asap':1<br>(1 row)</font></div><div><font size="2"   >但是1是uint</font></div><div><font size="2"   >digoal=&gt; select * from to_tsvector('english','as soon 1 possible');<br>        to_tsvector         <br>----------------------------<br> '1':3 'possibl':4 'soon':2<br>(1 row)</font></div><div><font size="2"   >digoal=&gt; select * from ts_debug('english','as soon 1 possible');</font></div><div><font size="2"   >...</font></div><div><font size="2"   > uint      | Unsigned integer | 1        | {simple}                        | simple       | {1}</font></div><p></p></pre></div><div><br></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   >4. 如何添加或修改解析过程用的中文词组</span></div><div><span style="line-height: 28px;"   >例如我们要扩充中文词组，这个和中文的parser有关，例如用到zhparser的话，它这里用的是xdb，所以加词组要修改的实际就是xdb。</span></div><div>中文分词的安装过程参考</div><div><a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201422410175698/"   >http://blog.163.com/digoal@126/blog/static/163877040201422410175698/</a></div><div>假设环境已经安装好了，加词组的例子：</div><div>$PG_HOME/share/tsearch_data目录中有中文词典如下：</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >-rw-r--r-- 1 root root &nbsp;14M May &nbsp;3 14:32 dict.utf8.xdb</font></div><div></div><p></p></pre></div><div><div>创建中文parser：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=# create extension zhparser;</font></div><div><font size="2"   >CREATE EXTENSION</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=# select * from pg_ts_parser ;</font></div><div><font size="2"   >&nbsp;prsname &nbsp;| prsnamespace | &nbsp;prsstart &nbsp; | &nbsp; &nbsp;prstoken &nbsp; &nbsp; | &nbsp;prsend &nbsp; | &nbsp;prsheadline &nbsp;| &nbsp;prslextype &nbsp;&nbsp;</font></div><div><font size="2"   >----------+--------------+-------------+-----------------+-----------+---------------+---------------</font></div><div><font size="2"   >&nbsp;default &nbsp;| &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 11 | prsd_start &nbsp;| prsd_nexttoken &nbsp;| prsd_end &nbsp;| prsd_headline | prsd_lextype</font></div><div><font size="2"   >&nbsp;zhparser | &nbsp; &nbsp; &nbsp; &nbsp;25956 | zhprs_start | zhprs_getlexeme | zhprs_end | prsd_headline | zhprs_lextype</font></div><div><font size="2"   >(2 rows)</font></div></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=&gt; CREATE TEXT SEARCH CONFIGURATION zhcfg (PARSER = zhparser);</font></div><div><font size="2"   >CREATE TEXT SEARCH CONFIGURATION</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 21px;"   >目前没有配置lexeme类型和字典的对应关系。</span></font></div><div><div><font size="2"   >digoal=&gt; \dF+ zhcfg</font></div><div><font size="2"   >Text search configuration "digoal.zhcfg"</font></div><div><font size="2"   >Parser: "public.zhparser"</font></div><div><font size="2"   >&nbsp;Token | Dictionaries&nbsp;</font></div><div><font size="2"   >-------+--------------</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >调试中文parser, 可以看到匹配的类型为e</font></div><div><div><font size="2"   >digoal=&gt; select * from ts_debug('zhcfg','as soon the possible');</font></div><div><font size="2"   >&nbsp;alias | description | &nbsp;token &nbsp; | dictionaries | dictionary | lexemes&nbsp;</font></div><div><font size="2"   >-------+-------------+----------+--------------+------------+---------</font></div><div><font size="2"   >&nbsp;e &nbsp; &nbsp; | exclamation | as &nbsp; &nbsp; &nbsp; | {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;e &nbsp; &nbsp; | exclamation | soon &nbsp; &nbsp; | {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;e &nbsp; &nbsp; | exclamation | the &nbsp; &nbsp; &nbsp;| {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >&nbsp;e &nbsp; &nbsp; | exclamation | possible | {} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;|&nbsp;</font></div><div><font size="2"   >(4 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >但是因为没有配置类型和字典的对应关系, 所以看不到输出.</font></div><div><font size="2"   >digoal=&gt; select * from to_tsvector('zhcfg','as soon the possible');</font></div><div><font size="2"   >&nbsp;to_tsvector&nbsp;</font></div><div><font size="2"   >-------------</font></div><div><font size="2"   >&nbsp;</font></div><div><font size="2"   >(1 row)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 21px;"   >zhparser支持哪些类型呢? 如下:</span></font></div><div><div><font size="2"   >digoal=&gt; select * from pg_catalog.ts_token_type('zhparser');</font></div><div><font size="2"   >&nbsp;tokid | alias | &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;description &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+-------+-------------------------------</font></div><div><font size="2"   >&nbsp; &nbsp; 97 | a &nbsp; &nbsp; | adjective</font></div><div><font size="2"   >&nbsp; &nbsp; 98 | b &nbsp; &nbsp; | differentiation (qu bie)</font></div><div><font size="2"   >&nbsp; &nbsp; 99 | c &nbsp; &nbsp; | conjunction</font></div><div><font size="2"   >&nbsp; &nbsp;100 | d &nbsp; &nbsp; | adverb</font></div><div><font size="2"   >&nbsp; &nbsp;101 | e &nbsp; &nbsp; | exclamation</font></div><div><font size="2"   >&nbsp; &nbsp;102 | f &nbsp; &nbsp; | position (fang wei)</font></div><div><font size="2"   >&nbsp; &nbsp;103 | g &nbsp; &nbsp; | root (ci gen)</font></div><div><font size="2"   >&nbsp; &nbsp;104 | h &nbsp; &nbsp; | head</font></div><div><font size="2"   >&nbsp; &nbsp;105 | i &nbsp; &nbsp; | idiom</font></div><div><font size="2"   >&nbsp; &nbsp;106 | j &nbsp; &nbsp; | abbreviation (jian lue)</font></div><div><font size="2"   >&nbsp; &nbsp;107 | k &nbsp; &nbsp; | head</font></div><div><font size="2"   >&nbsp; &nbsp;108 | l &nbsp; &nbsp; | tmp (lin shi)</font></div><div><font size="2"   >&nbsp; &nbsp;109 | m &nbsp; &nbsp; | numeral</font></div><div><font size="2"   >&nbsp; &nbsp;110 | n &nbsp; &nbsp; | noun</font></div><div><font size="2"   >&nbsp; &nbsp;111 | o &nbsp; &nbsp; | onomatopoeia</font></div><div><font size="2"   >&nbsp; &nbsp;112 | p &nbsp; &nbsp; | prepositional</font></div><div><font size="2"   >&nbsp; &nbsp;113 | q &nbsp; &nbsp; | quantity</font></div><div><font size="2"   >&nbsp; &nbsp;114 | r &nbsp; &nbsp; | pronoun</font></div><div><font size="2"   >&nbsp; &nbsp;115 | s &nbsp; &nbsp; | space</font></div><div><font size="2"   >&nbsp; &nbsp;116 | t &nbsp; &nbsp; | time</font></div><div><font size="2"   >&nbsp; &nbsp;117 | u &nbsp; &nbsp; | auxiliary</font></div><div><font size="2"   >&nbsp; &nbsp;118 | v &nbsp; &nbsp; | verb</font></div><div><font size="2"   >&nbsp; &nbsp;119 | w &nbsp; &nbsp; | punctuation (qi ta biao dian)</font></div><div><font size="2"   >&nbsp; &nbsp;120 | x &nbsp; &nbsp; | unknown</font></div><div><font size="2"   >&nbsp; &nbsp;121 | y &nbsp; &nbsp; | modal (yu qi)</font></div><div><font size="2"   >&nbsp; &nbsp;122 | z &nbsp; &nbsp; | status (zhuang tai)</font></div><div><font size="2"   >(26 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 21px;"   >创建对应关系, 所有类型使用英语和simple字典, 使用英语词典可以帮助我们去除一些无意义的词如as the this a等.</span></font></div><div><div><font size="2"   >digoal=&gt; &nbsp;ALTER TEXT SEARCH CONFIGURATION zhcfg ADD MAPPING FOR a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z WITH english_stem, simple;</font></div><div><font size="2"   >ALTER TEXT SEARCH CONFIGURATION</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >现在可以正常的匹配字典了.</font></div><div><div><font size="2"   >digoal=&gt; select * from ts_debug('zhcfg','as soon the possible 周正中 德哥 刘德华');</font></div><div><font size="2"   >&nbsp;alias | description | &nbsp;token &nbsp; | &nbsp; &nbsp; dictionaries &nbsp; &nbsp; &nbsp;| &nbsp;dictionary &nbsp;| &nbsp;lexemes &nbsp;</font></div><div><font size="2"   >-------+-------------+----------+-----------------------+--------------+-----------</font></div><div><font size="2"   >&nbsp;e &nbsp; &nbsp; | exclamation | as &nbsp; &nbsp; &nbsp; | {english_stem,simple} | english_stem | {}</font></div><div><font size="2"   >&nbsp;e &nbsp; &nbsp; | exclamation | soon &nbsp; &nbsp; | {english_stem,simple} | english_stem | {soon}</font></div><div><font size="2"   >&nbsp;e &nbsp; &nbsp; | exclamation | the &nbsp; &nbsp; &nbsp;| {english_stem,simple} | english_stem | {}</font></div><div><font size="2"   >&nbsp;e &nbsp; &nbsp; | exclamation | possible | {english_stem,simple} | english_stem | {possibl}</font></div><div><font size="2"   >&nbsp;q &nbsp; &nbsp; | quantity &nbsp; &nbsp;| 周 &nbsp; &nbsp; &nbsp; | {english_stem,simple} | english_stem | {周}</font></div><div><font size="2"   >&nbsp;v &nbsp; &nbsp; | verb &nbsp; &nbsp; &nbsp; &nbsp;| 正中 &nbsp; &nbsp; | {english_stem,simple} | english_stem | {正中}</font></div><div><font size="2"   >&nbsp;n &nbsp; &nbsp; | noun &nbsp; &nbsp; &nbsp; &nbsp;| 德哥 &nbsp; &nbsp; | {english_stem,simple} | english_stem | {德哥}</font></div><div><font size="2"   >&nbsp;n &nbsp; &nbsp; | noun &nbsp; &nbsp; &nbsp; &nbsp;| 刘德华 &nbsp; | {english_stem,simple} | english_stem | {刘德华}</font></div><div><font size="2"   >(8 rows)</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >digoal=&gt; select * from to_tsvector('zhcfg','as soon the possible 周正中 德哥 刘德华');</font></div><div><font size="2"   >&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;to_tsvector &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >----------------------------------------------------------</font></div><div><font size="2"   >&nbsp;'possibl':4 'soon':2 '刘德华':8 '周':5 '德哥':7 '正中':6</font></div><div><font size="2"   >(1 row)</font></div></div><p></p></pre></div></div><div>很明显，我的名字不在中文parser词典中，我现在要加进去。</div><div><span style="line-height: 28px;"   >修改它：dict.utf8.xdb</span></div><div><pre class="prettyprint"   ><div><font size="2"   ># wget&nbsp;http://www.xunsearch.com/scws/down/phptool_for_scws_xdb.zip</font></div><div><font size="2"   ># unzip phptool_for_scws_xdb.zip</font></div><div><div><font size="2"   >&nbsp; inflating: make_xdb_file.php &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; inflating: readme.txt &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >&nbsp; inflating: xdb.class.php &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</font></div><div><font size="2"   >&nbsp; inflating: dump_xdb_file.php &nbsp;</font></div></div><div><font size="2"   ># chmod 755 *.php</font></div><p></p></pre></div><div>步骤，将XDB导出文本，编辑文本，合成XDB。</div><div>1. 导出</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   ># yum install -y php php-mbstring</font></div><div><font size="2"   ># php ./dump_xdb_file.php /opt/pgsql/share/tsearch_data/dict.utf8.xdb ./xdb</font></div><div><font size="2"   ><br></font></div><div><font size="2"   ><span style="line-height: 21px;"   >目前有28万多词组</span></font></div><div><font size="2"   ># wc -l xdb<br>284647 xdb</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >[root@db-192-168-173-33 soft_bak]# less xdb</font></div><div><font size="2"   ># WORD &nbsp;TF &nbsp; &nbsp; &nbsp;IDF &nbsp; &nbsp; ATTR</font></div><div><font size="2"   >当机立断 &nbsp; &nbsp; &nbsp; &nbsp;14.01 &nbsp; 8.10 &nbsp; &nbsp;i</font></div><div><font size="2"   > &nbsp; &nbsp; &nbsp;1.01 &nbsp; &nbsp;0.00 &nbsp; &nbsp;@</font></div><div><font size="2"   >银朱 &nbsp; &nbsp;11.85 &nbsp; 12.31 &nbsp; n</font></div><div><font size="2"   >集科 &nbsp; &nbsp;13.63 &nbsp; 8.03 &nbsp; &nbsp;n</font></div><div><font size="2"   >负电 &nbsp; &nbsp;12.69 &nbsp; 10.49 &nbsp; n</font></div><div><font size="2"   >那霸 &nbsp; &nbsp;12.53 &nbsp; 10.85 &nbsp; nr</font></div><div><font size="2"   >无名肿毒 &nbsp; &nbsp; &nbsp; &nbsp;12.33 &nbsp; 12.16 &nbsp; l</font></div></div><div><font size="2"   >.....</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >导出后内容有4个字段，包括单词，tf(),idf,属性：</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >添加删除修改自定义词库只要编辑该文件即可，以下为相关规范：<br>文件为纯文本文件，编码必须是 UTF-8，可用任何编辑器修改<br>每行一条记录表示一个词，每行包含 1~4 个字段，字段之间用空格或制表符(\t)分隔<br>字段含义依次表示 “词语”，“词频(TF)”，“逆词频率(IDF)”，“词性(ATTR)”<br>后面三个字段如果省略依次使用 scws 的默认值<br>特殊词性 ! 可用于表示删除该词<br>自定义词典优先于内置词典加载和使用，以 # 开头的行为注释</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >TF和IDF，它们合起来称作TF-IDF（term frequencyC inverse document frequency），是一种用于资讯检索与资讯探勘的常用加权技术，用以评估一字词对于一个文件集或一个语料库中的其中一份文件的重要程度。</font></div><div><font size="2"   >TFIDF的主要思想是：如果某个词或短语在一篇文章中出现的频率TF高，并且在其他文章中很少出现，则认为此词或者短语具有很好的类别区分能力，适合用分类。</font></div><div><font size="2"   >说起来很不好理解，其实也不需要理解，SCWS也提供了新词生词的TF/IDF计算器，可以自动获得词语的权重值。<br>ATTR是词性，也就是标示词语是名字、动词、形容词等等词性的。</font></div><div><font size="2"   >详细的词性标示方法请看SCWS的说明：(</font><span style="line-height: 21px; font-size: small; font-family: 'Hiragino Sans GB W3', 'Hiragino Sans GB', Arial, Helvetica, simsun, 宋体;"   >词典词性标注详解)</span></div><div><font size="2"   >我要添加的词语是”芽菜“，是名词，用n标示。</font></div><div><font size="2"   >在 <span style="line-height: 21px;"   >http://www.xunsearch.com/scws/demo/get_tfidf.php 网址可以生成词的IF,IDF</span></font></div><div><font size="2"   >例如芽菜得到的IF、IDF值分别是13.82和7.48，那么在xdb结尾我追加了如下一行：<br>　　芽菜    13.82    7.48    n</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >其中属性和zhparser支持的类型对应。例如，见alias：</font></div><div><font size="2"   ><br></font></div><div><div><font size="2"   >digoal=&gt; select * from ts_debug('zhcfg','一口吸尽西江水当机立断无名肿毒');</font></div><div><font size="2"   >&nbsp;alias | &nbsp;description &nbsp;| &nbsp; &nbsp; token &nbsp; &nbsp; &nbsp;| &nbsp; &nbsp; dictionaries &nbsp; &nbsp; &nbsp;| &nbsp;dictionary &nbsp;| &nbsp; &nbsp; lexemes &nbsp; &nbsp; &nbsp;</font></div><div><font size="2"   >-------+---------------+----------------+-----------------------+--------------+------------------</font></div><div><font size="2"   >&nbsp;x &nbsp; &nbsp; | unknown &nbsp; &nbsp; &nbsp; |  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; | {english_stem,simple} | english_stem | {}</font></div><div><font size="2"   >&nbsp;l &nbsp; &nbsp; | tmp (lin shi) | 一口吸尽西江水 | {english_stem,simple} | english_stem | {一口吸尽西江水}</font></div><div><font size="2"   >&nbsp;i &nbsp; &nbsp; | idiom &nbsp; &nbsp; &nbsp; &nbsp; | 当机立断 &nbsp; &nbsp; &nbsp; | {english_stem,simple} | english_stem | {当机立断}</font></div><div><font size="2"   >&nbsp;l &nbsp; &nbsp; | tmp (lin shi) | 无名肿毒 &nbsp; &nbsp; &nbsp; | {english_stem,simple} | english_stem | {无名肿毒}</font></div><div><font size="2"   >(4 rows)</font></div></div><div><font size="2"   ><br></font></div><div><font size="2"   >xdb中的@属性对应zhparser里的x,详见代码</font></div><p></p></pre></div><div><span style="line-height: 28px;"   ><br></span></div><div><span style="line-height: 28px;"   >2. 编辑</span></div><div><span style="line-height: 28px;"   >我要把周正中添加到xdb里面，这是个人名，就用n作为ATTR，TF,IDF查一下</span></div><div><pre class="prettyprint"   ><p><font size="2"   >http://www.xunsearch.com/scws/demo/get_tfidf.php</font></p></pre></div><div>结果：</div><div>WORD=周正中 TF=12.07 IDF=12.38</div><div>加到xdb最后一行如下：</div><div>周正中 &nbsp;12.07 &nbsp; 12.38 &nbsp; n</div><div><br></div><div>3. 合成xdb文件</div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >注意事项</font></div><div><div><font size="2"   >1. 词典导出：dump_xdb_file.php 在命令行模式下运行</font></div><div><font size="2"   >php dump_xdb_file.php &lt;要导出的.xdb文件&gt; [存入的文本文件]</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >第二参数省略则直接输出到标准输出。</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >2. 词典生成：make_xdb_file.php 同样是在命令行模式下运行（需要安装 mbstring 扩展）</font></div><div><font size="2"   >默认是处理 gbk 编码的文本，如果你的文本是 utf8，则需要修改该程序的第一行，把</font></div><div><font size="2"   >define(‘IS_UTF8_TXT’, false); 改为 true</font></div><div><font size="2"   ><br></font></div><div><font size="2"   >php make_xdb_file.php &lt;要生成的.xdb&gt; [导入的文本文件]</font></div></div><p></p></pre></div><div>如果使用php写的合成工具有问题，建议直接用<span style="line-height: 28px;"   >scws提供的合成工具导入。</span></div><div><pre class="prettyprint"   ><p></p><div><font size="2"   >[root@db-192-168-173-33 soft_bak]# rm -f /opt/pgsql/share/tsearch_data/dict.utf8.xdb</font></div><div><font size="2"   >[root@db-192-168-173-33 soft_bak]# php /opt/soft_bak/make_xdb_file.php /opt/pgsql/share/tsearch_data/dict.utf8.xdb ./xdb</font></div><p></p></pre></div><div><span style="line-height: 28px;"   >使用scsw提供的合成工具导入，需要安装scws，不过这个在部署zhparser时已经安装了，下面的步骤可以省略。</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >wget&nbsp;</span>http://www.xunsearch.com/download/xunsearch-full-latest.tar.bz2</font></div><div style="line-height: 28px;"   ><font size="2"   >tar -jxvf&nbsp;<span style="line-height: 28px;"   >xunsearch-full-latest.tar.bz2</span></font></div><div style="line-height: 28px;"   ><font size="2"   ><span style="line-height: 28px;"   >cd&nbsp;</span>xunsearch-full-1.4.9</font></div><div style="line-height: 28px;"   ><font size="2"   >cd&nbsp;packages</font></div><div style="line-height: 28px;"   ><font size="2"   >tar -jxvf scws-1.2.3-dev.tar.bz2</font></div><div style="line-height: 28px;"   ><font size="2"   >cd scws-1.2.3-dev</font></div><p></p></pre></div><div style="line-height: 28px;"   >安装之,&nbsp;<span style="line-height: 28px;"   >使用：</span></div><div><div style="line-height: 28px;"   ><pre class="prettyprint"   ><p></p><div><div><div style="line-height: 28px;"   ><font size="2"   ># cd /opt/scws-1.2.2/bin/</font></div><div style="line-height: 28px;"   ><font size="2"   ># ll</font></div><div style="line-height: 28px;"   ><font size="2"   >total 52</font></div><div style="line-height: 28px;"   ><font size="2"   >-rwxr-xr-x 1 root root 29995 May &nbsp;3 14:29 scws</font></div><div style="line-height: 28px;"   ><font size="2"   >-rwxr-xr-x 1 root root 18833 May &nbsp;3 14:29 scws-gen-dict</font></div><div style="line-height: 28px;"   ><font size="2"   ><br></font></div><div><div><font size="2"   ># ./scws-gen-dict -h</font></div><div><font size="2"   >scws-gen-dict (scws-mkdict/1.2.2)</font></div><div><font size="2"   >Convert the plain text dictionary to xdb format.</font></div><div><font size="2"   >Copyright (C)2007 by hightman.</font></div><div><font size="2"   >Usage: scws-gen-dict [options] [input file] [output file]</font></div><div><font size="2"   >&nbsp; -i &nbsp; &nbsp; &nbsp; &nbsp;Specified the plain text dictionary(default: dict.txt).</font></div><div><font size="2"   >&nbsp; -o &nbsp; &nbsp; &nbsp; &nbsp;Specified the output file path(default: dict.xdb)</font></div><div><font size="2"   >&nbsp; -c &nbsp; &nbsp; &nbsp; &nbsp;Specified the input charset(default: gbk)</font></div><div><font size="2"   >&nbsp; -p &nbsp; &nbsp; &nbsp; &nbsp;Specified the PRIME num for xdb</font></div><div><font size="2"   >&nbsp; -v &nbsp; &nbsp; &nbsp; &nbsp;Show the version.</font></div><div><font size="2"   >&nbsp; -h &nbsp; &nbsp; &nbsp; &nbsp;Show this page.</font></div><div><font size="2"   >Report bugs to &lt;hightman2@yahoo.com.cn&gt;</font></div></div></div></div><div><font size="2"   ><br></font></div><div><font size="2"   ># rm -f /opt/pgsql/share/tsearch_data/dict.utf8.xdb</font></div><div><div><font size="2"   ># ./scws-gen-dict -i /opt/soft_bak/xdb -o /opt/pgsql/share/tsearch_data/dict.utf8.xdb -c UTF-8</font></div><div><font size="2"   >Reading the input file: /opt/soft_bak/xdb ...OK, total nodes=378213</font></div><div><font size="2"   >Optimizing... OK</font></div><div><font size="2"   >Dump the tree data to: /opt/pgsql/share/tsearch_data/dict.utf8.xdb ... OK, all been done!</font></div></div><div><font size="2"   ><br></font></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><div style="line-height: 28px;"   ><font size="2"   ># ll /opt/pgsql/share/tsearch_data/dict.utf8.xdb</font></div><div style="line-height: 28px;"   ><font size="2"   >-rw------- 1 root root 14315542 May &nbsp;3 18:34 /opt/pgsql/share/tsearch_data/dict.utf8.xdb</font></div></span></div><p></p></pre></div></div></div><div style="line-height: 28px;"   ><span style="line-height: 28px;"   ><div style="line-height: 28px;"   ><br></div></span></div><div>现在可以查询一下新增的词组是否正常分词了：</div><div><pre class="prettyprint"   ><p></p><div><div><font size="2"   >digoal=&gt; select * from ts_debug('zhcfg','一口吸尽西江水当机立断无名肿毒周正中德哥你好');</font></div><div><font size="2"   >...</font></div><div><font size="2"   >&nbsp;n &nbsp; &nbsp; | noun &nbsp; &nbsp; &nbsp; &nbsp;| 周正中 | {english_stem,simple} | english_stem | {周正中}</font></div><div><font size="2"   >&nbsp;n &nbsp; &nbsp; | noun &nbsp; &nbsp; &nbsp; &nbsp;| 德哥 &nbsp; | {english_stem,simple} | english_stem | {德哥}</font></div></div><div><font size="2"   >...</font></div><p></p></pre></div><div><br></div>[参考]<wbr><br><div>1.&nbsp;<a style="line-height: 28px;" target="_blank" href="http://blog.163.com/digoal@126/blog/static/163877040201422410175698/"   >http://blog.163.com/digoal@126/blog/static/163877040201422410175698/</a></div><div>2.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.postgresql.org/docs/devel/static/textsearch-dictionaries.html"   >http://www.postgresql.org/docs/devel/static/textsearch-dictionaries.html</a></div><div>3.&nbsp;<a style="line-height: 28px;" target="_blank" rel="nofollow" href="http://www.xunsearch.com/scws/download.php"   >http://www.xunsearch.com/scws/download.php</a></div><div><br></div>
<a rel="nofollow" href="http://info.flagcounter.com/h9V1"   ><img title="Customize Dictionary or Filter dictionary by Synonym  Thesaurus, customize zhparsers xdb - 德哥@Digoal - PostgreSQL research"   src="http://s03.flagcounter.com/count/h9V1/bg_FFFFFF/txt_000000/border_CCCCCC/columns_2/maxflags_12/viewers_0/labels_0/pageviews_0/flags_0/"   alt="Flag Counter"   border="0"   ></a></div>
	</div>
</div>
</body>
</html>